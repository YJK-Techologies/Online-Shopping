name: OS Auto Deploy (IIS + PM2)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      # -------------------------------------------------
      # 1️⃣ Checkout source code
      # -------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------------------------
      # 2️⃣ Setup Node.js
      # -------------------------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # -------------------------------------------------
      # 3️⃣ Sync BACKEND code to IIS (controller/routes/etc)
      # -------------------------------------------------
      - name: Sync backend code to IIS
        shell: powershell
        run: |
          robocopy server C:\inetpub\wwwroot\OS\server /MIR /XD node_modules
          if ($LASTEXITCODE -le 7) {
            exit 0
          } else {
            exit $LASTEXITCODE
          }

      # -------------------------------------------------
      # 4️⃣ Install backend dependencies
      # -------------------------------------------------
      - name: Install backend packages
        shell: powershell
        run: |
          npm install --legacy-peer-deps --prefix C:\inetpub\wwwroot\OS\server

      # -------------------------------------------------
      # 5️⃣ Restart backend using PM2
      # -------------------------------------------------
      - name: Restart backend
        shell: powershell
        run: |
          if (pm2 list | Select-String "os-backend") {
            pm2 restart os-backend
          } else {
            pm2 start C:\inetpub\wwwroot\OS\server\server.js --name os-backend
          }
          pm2 save

      # -------------------------------------------------
      # 6️⃣ Install frontend dependencies
      # -------------------------------------------------
      - name: Install frontend packages
        shell: powershell
        run: |
          npm install --legacy-peer-deps

      # -------------------------------------------------
      # 7️⃣ Build frontend (CI-safe)
      # -------------------------------------------------
      - name: Build frontend
        shell: powershell
        run: |
          $env:CI="false"
          $env:GENERATE_SOURCEMAP="false"
          npm run build

      # -------------------------------------------------
      # 8️⃣ Deploy frontend build to IIS
      # -------------------------------------------------
      - name: Deploy frontend to IIS
        shell: powershell
        run: |
          robocopy build C:\inetpub\wwwroot\OS\build /MIR
          if ($LASTEXITCODE -le 7) {
            exit 0
          } else {
            exit $LASTEXITCODE
          }
