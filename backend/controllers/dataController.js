// controllers/dataController.js
const sql = require("mssql");
const connection = require("../connection/connection");
const transporter = require("../mailer");
const { generateOTP } = require("../utils");
const dbConfig = require("../config/dbConfig");
const multer = require('multer')
const CryptoJS = require('crypto-js');
const upload = multer({ storage: multer.memoryStorage() });//add in top of the datacontroller page
const path = require("path");
const fs = require("fs");
const otpStorage = {};
const AdmZip = require("adm-zip");
const archiver = require("archiver");


const uploadImages = async (req, res) => {
  try {
    let fileUrl;

    // Case 1: File uploaded via multer
    if (req.file) {
      fileUrl = `${req.protocol}://${req.get("host")}/uploads/${req.file.filename}`;
    }
    // Case 2: Base64 image in request body
    else if (req.body && req.body.base64 && req.body.filename) {
      const { base64, filename } = req.body;

      // Remove metadata prefix if exists
      const base64Data = base64.replace(/^data:image\/\w+;base64,/, "");
      const buffer = Buffer.from(base64Data, "base64");

      // Save file to uploads folder
      const savePath = path.join(__dirname, "../uploads", filename);
      fs.writeFileSync(savePath, buffer);

      fileUrl = `${req.protocol}://${req.get("host")}/uploads/${filename}`;
    }
    else {
      return res.status(400).json({ error: "No file or base64 data provided" });
    }

    res.json({ url: fileUrl });
  } catch (error) {
    console.error("Upload error:", error);
    res.status(500).json({ error: "Internal server error" });
  }
};

const sendOTP = async (email, otp) => {
  const mailOptions = {
    from: "alert@yjktechnologies.com",
    to: email,
    subject: "Login OTP",
    text: `Your OTP is: ${otp}`,
  };

  try {
    await transporter.sendMail(mailOptions);
  } catch (err) {
    console.error("Error sending OTP:", err);
    throw new Error("Error sending OTP");
  }
};

// forget Password handler
const VerifyCustomer = async (req, res) => {
  const { customer_email_id } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "VC")
      .input("customer_email_id", sql.NVarChar, customer_email_id)
       .query(`EXEC sp_customer_details_info_test 'VC','','','','','','','','','','','','',
      '','','','',@customer_email_id,0,'','','',NULL,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    if (result.recordset.length > 0) {
      const customerData = result.recordset[0]; // ðŸ‘ˆ fetched data

      const otp = generateOTP();
      await sendOTP(customer_email_id, otp);

      otpStorage[customer_email_id] = otp;

      res.status(200).json({
        message: "OTP sent successfully",
        customer: customerData, // ðŸ‘ˆ send data to frontend
      });
    } else {
      res.status(401).json({ message: "Email not found" });
    }

  } catch (error) {
    console.error("Error during login:", error);
    res.status(500).json({
      message: error.message || "Internal Server Error",
    });
  }
};


// const Passwords = async (req, res) => {
//   const { email, new_password } = req.body;

//   try {
//     const pool = await connection.connectToDatabase();
//     const result = await pool
//       .request()
//       .input("Email", sql.NVarChar, email)
//       .query("SELECT * FROM tbl_user_info_hdr WHERE email_id = @Email");

//     if (result.recordset.length > 0) {
//       await pool
//         .request()
//         .input("Email", sql.NVarChar, email)
//         .input("NewPassword", sql.NVarChar, new_password)
//         .query("UPDATE tbl_user_info_hdr SET user_password = @NewPassword WHERE email_id = @Email");
//       res.status(200).json({ message: "Password updated successfully" });
//     } else {
//       res.status(401).json({ message: "Email not found" });
//     }
//   } catch (err) {
//     console.error("Error", err);
//     res.status(500).json({ message: err.message||'Internal Server Error'});
//   }
// };

const Passwords = async (req, res) => {
  const { user_code, email_id, user_password } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    await pool
      .request()
      .input("mode", sql.NVarChar, "UP")
      .input("user_code", sql.NVarChar, user_code)
      .input("email_id", sql.NVarChar, email_id)
      .input("user_password", sql.NVarChar, user_password)
      .query("EXEC SP_user_info_hdr @mode,'',@user_code,'','','',@user_password,'','','',@email_id,'','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL");
    res.status(200).json({ message: "Password updated successfully" });
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

/*const loginn = async (req, res) => {
  const { user_code, user_password } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("user_code", sql.NVarChar, user_code)
      .input("user_password", sql.NVarChar, user_password)
      .query(
        `EXEC [SP_user_info_hdr] 'LUC','@user_code','','','','','','','','','','','','','','','NULL','NULL','NULL','NULL','','','',''`
      );

    if (!result.recordset[0]) {
      return res.status(401).json({ nmessage: " usercode not found" });
    } 
    else {
      
      const user = result.recordset[0]; // Assuming the first record is the user data
      if (!user.user_password){
        return res.status(401).json({ message: "Invalid password" });
      } else {
        return res.status(200).json({ message: "Login successful" });
      }
    }
  } catch (error) {
    console.error("Error:", error.message);
    return res.status(500).json({ message: "Internal Server Error" });
  } finally {
    await sql.close();
  }
};

const loginn = async (req, res) => {
  const { user_code, user_password } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("user_code", sql.NVarChar, user_code)
      .input("user_password", sql.NVarChar, user_password)
      .query(
      "select  user_password from tbl_user_info_hdr where user_code = @user_code and user_password = @user_password "
      );

    if (result.recordset.length === 0) {
      return res.status(200).json({ imessage:result.recordset.length });
     const user = result.recordset.user_password; 
      if (user !== user_password) {
        return res.status(403).json({ message: "Invalid password" });
      } else {
        return res.status(200).json({ message: "Login successful" });
      }
      
    } else {
      return res.status(200).json({ emessage:result.recordset });
    }
  } catch (error) {
    console.error("Error:", error.message);
    return res.status(500).json({ message: "Internal Server Error" });
  } finally {
    await sql.close();
  }
};*/

// const login = async (req, res) => {
//   const { user_code, user_password } = req.body;
//   const secretKey = 'yjk26012024'; 

//   try {
//     // Decrypt user_code and user_password
//     const decryptedUserCode = CryptoJS.AES.decrypt(user_code, secretKey).toString(CryptoJS.enc.Utf8);
//     const decryptedPassword = CryptoJS.AES.decrypt(user_password, secretKey).toString(CryptoJS.enc.Utf8);

//     // Check if the user exists in the database based on decryptedUserCode
//     const pool = await connection.connectToDatabase();
//     const result = await pool
//       .request()
//       .input("mode", sql.NVarChar, "LUC")
//       .input("user_code", sql.NVarChar, decryptedUserCode)
//       .input("user_password", sql.NVarChar, decryptedPassword)
//       .query(`EXEC SP_user_info_hdr 'LUC','',@user_code,'','','',@user_password,'','','','','','','','','','','','','','','','','',''`);

//     if (!result.recordset[0]) {
//       // User not found
//       return res.status(401).json({ message: "Invalid usercode" });
//     } else {
//       const user = result.recordset[0]; // Assuming the first record is the user data
//       // Check if the provided user_password matches the one in the database
//       if (user.user_password !== decryptedPassword) {
//         // Passwords don't match
//         return res.status(401).json({ message: "Invalid password" });
//       } else {
//         // Both username and password are validated successfully
//         if (result.recordset.length > 0) {
//           res.status(200).json(result.recordset); // 200 OK if data is found
//         } else {
//           res.status(404).json("Data not found"); // 404 Not Found if no data is found
//         }
//       }
//     }
//   } catch (err) {
//     console.error("Error", err.message);
//     res.status(500).json({ message: err.message||'Internal Server Error'});
//   }       
// };

const login = async (req, res) => {
  const { user_code, user_password } = req.body;
  const secretKey = 'yjk26012024';

  try {
    const decryptedUserCode = CryptoJS.AES.decrypt(user_code, secretKey).toString(CryptoJS.enc.Utf8);
    const decryptedPassword = CryptoJS.AES.decrypt(user_password, secretKey).toString(CryptoJS.enc.Utf8);

    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "LUC")
      .input("user_code", sql.NVarChar, decryptedUserCode)
      .input("user_password", sql.NVarChar, decryptedPassword)
      .query(`EXEC SP_user_info_hdr_test1 'LUC','',@user_code,'','','',@user_password,'','','','','','','','','','','','','','','','','',''`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err.message);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

// Signup handler
const signUp = async (req, res) => {
  const { name, email } = req.body;

  try {
    // Check if the user already exists in the database
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("Email", sql.NVarChar, email)
      .query("SELECT * FROM yjk_users WHERE Ymail = @Email");

    if (result.recordset.length === 0) {
      // If user does not exist, generate and send OTP
      const otp = generateOTP();
      await sendOTP(email, otp);

      // Store OTP temporarily for verification
      otpStorage[email] = otp;

      // Proceed with adding user to the database
      await pool
        .request()
        .input("Name", sql.NVarChar, name)
        .input("Email", sql.NVarChar, email)
        .query("INSERT INTO yjk_users (Name, Ymail) VALUES (@Name, @Email)");

      res.status(200).json({ message: "OTP sent successfully" });
    } else {
      res.status(401).json({ message: "Existing User" });
    }
  } catch (err) {
    console.error("Error during signup:", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

// Verify OTP handler
const verifyOtp = (req, res) => {
  const { customer_email_id, enteredOtp } = req.body;

  try {
    const storedOtp = otpStorage[customer_email_id];
    if (storedOtp && storedOtp === enteredOtp) {
      // If OTP is valid, clear the OTP storage
      delete otpStorage[customer_email_id];
      res.status(200).json({ message: "OTP verified successfully" });
    } else {
      res.status(401).json({ message: "Invalid OTP" });
    }
  } catch (err) {
    console.error("Error verifying OTP:", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getvariant = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'Item_variant','','', '','','', NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );
    res.json(result.recordset);
  } catch (err) {
    console.error("Error during update:", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const gettaxitempur = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC [sp_tax_name_hdr] 'TP',@company_code,'tax_type','',0,'','','','','','','','',null,null,null,null,null,null,null,null"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const gettaxitemsales = async (req, res) => {
  const { company_code } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "TS")
      .input("company_code", sql.VarChar, company_code)
      .query(`EXEC [sp_tax_name_hdr] @mode,@company_code,'', '', 0, '', '','', '', '','', '','',
    null, null, null, null, null, null, null, null;`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
const getuom = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'BaseUOM','','', '','','', NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getCity = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'city','','', '','','', NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};



const getCountry = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'country','','', '','','', NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getState = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'state','',' ', ' ' ,'','', NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getStatus = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'status','','', '' , '','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getApprovedBy = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(
      `EXEC sp_EmployeeLoan 'DA', '', '', '', 
                                 0,'', 
                                '', 0, 0, 
                                '','', null, 
                                 null, null, null, 
                                 null, null, null,null`
    );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
const getShift = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'Shift','','', '' , '','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getTransaction = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'Transaction Type','','', '' ,'','', NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getGender = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'Gender','','', '' ,'','', NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getLoginorout = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'Log IN/OUT','','', '' ,'','', NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};



const getDeletepermission = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'deletepermission','','', '' ,'','', NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getregisterbrand = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'Register_brand','','', '' ,'','', NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getboolean = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'boolean','','', '' ,'','', NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const getourbrand = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'our_brand','','', '' , '','', NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};



const getInthdrcode = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(
      "EXEC sp_intermediary_details 'TS','','','','','','','','','','','','','','','','','','','','','','','','','','' "
    );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
const gethdrcode = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(
      "EXEC sp_attribute_Info 'TS','','', '','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
    );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const gettaxtype = async (req, res) => {
  const { company_code } = req.body;
  let pool;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_tax_name_hdr 'F',@company_code,'','',0,'','','','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getUsercode = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(
      "EXEC SP_user_info_hdr 'F','','user_code','','', '' ,'','','','','','','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
    );
    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const getUsertype = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'User Type', '','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
const getscreentype = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'Sc type', '','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"

      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};
const getVendorcodename = async (req, res) => {

  const { vendor_name } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("vendor_name", sql.NVarChar, vendor_name)
      .query(
        "EXEC sp_vendor_info_hdr 'AK','','',@vendor_name,'','','',null,null,null,null,null,null,null,null,null,null,null "
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getCompanyno = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(
      `EXEC sp_company_info 'F','', ' ', '', '', '', '', '',  '', '' , '', '', '','',  '','','','','',null,NULL, NULL,NULL,NULL,NULL,NULL,NULL,NULL,null,null,null`
    );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getLocationno = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(
      "EXEC sp_location_info 'F','', '', '', '', '', '', '','', '', '', '', '',  0,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
    );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const getvendorcode = async (req, res) => {
  const { company_code } = req.body;
  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();
    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "F")
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_vendor_info_hdr @mode,@company_code,'','','','','',null,null,null,null,null,null,null,null,null,null,NULL`);
    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getPaytype = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'paytype','','', '' ,'','', NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getPurchasetype = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'PurchaseType','','', '' ,'','', NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getSalestype = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'SalesType','','', '' ,'','', NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getordertype = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'ORDER TYPE','','', '' , '','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getsalesmancode = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(
      "EXEC sp_intermediary_details 'SM','','','','','','','','','','','','','','','','','','','','','','','','','','' ");

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const gettransportcode = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(
      "EXEC sp_intermediary_details 'TR','','','','','','','','','','','','','','','','','','','','','','','','','','' ");

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getbrokercode = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(
      "EXEC sp_intermediary_details 'BR','','','','','','','','','','','','','','','','','','','','','','','','','','' ");

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getroleid = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        `EXEC sp_role_info 'F',@company_code,'','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getAllData = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query("select * from tbl_company_info_hdr");

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const gettypeperdata = async (req, res) => {
  const { tax_type_header, company_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "TS")
      .input("company_code", sql.VarChar, company_code)
      .input("tax_type_header", sql.NVarChar, tax_type_header)
      .query(`EXEC sp_tax_name_details @mode,@company_code,@tax_type_header,'',0,'','','','','','',
        NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getsearchdata = async (req, res) => {
  const { company_no, company_name, city, state, pincode, country, status, company_gst_no } = req.body;
  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();
    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("company_no", sql.NVarChar, company_no)
      .input("company_name", sql.NVarChar, company_name)
      .input("city", sql.NVarChar, city)
      .input("state", sql.NVarChar, state)
      .input("pincode", sql.NVarChar, pincode)
      .input("country", sql.NVarChar, country)
      .input("company_gst_no", sql.NVarChar, company_gst_no)
      .input("status", sql.NVarChar, status)
      .query(` EXEC sp_company_info @mode,@company_no,@company_name,'','','','',@city,@state,@pincode,@country,@company_gst_no,@status,'','','','','','','','','','','','','','','','','','' `);
    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const addData = async (req, res) => {
  const {
    company_no, company_name, short_name, address1, address2, address3, city, state, pincode,
    country, email_id, status, foundedDate, websiteURL, contact_no, annualReportURL, location_no, company_gst_no, created_by, modified_by,
    tempstr1, tempstr2, tempstr3, tempstr4, datetime1, datetime2, datetime3, datetime4,
  } = req.body;

  let company_logo = req.files['company_logo'] ? req.files['company_logo'][0].buffer : null;
  let authorisedSignatur = req.files['authorisedSignatur'] ? req.files['authorisedSignatur'][0].buffer : null;

  try {
    pool = await sql.connect(dbConfig);

    // If the company code doesn't exist, proceed with inserting the data
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_no", sql.NVarChar, company_no)
      .input("company_name", sql.NVarChar, company_name)
      .input("short_name", sql.NVarChar, short_name)
      .input("address1", sql.NVarChar, address1)
      .input("address2", sql.NVarChar, address2)
      .input("address3", sql.NVarChar, address3)
      .input("city", sql.NVarChar, city)
      .input("state", sql.NVarChar, state)
      .input("pincode", sql.NVarChar, pincode)
      .input("country", sql.NVarChar, country)
      .input("email_id", sql.NVarChar, email_id)
      .input("status", sql.NVarChar, status)
      .input("foundedDate", sql.NVarChar, foundedDate)
      .input("websiteURL", sql.NVarChar, websiteURL)
      .input("company_logo", sql.VarBinary, company_logo)
      .input("contact_no", sql.NVarChar, contact_no)
      .input("annualReportURL", sql.NVarChar, annualReportURL)
      .input("location_no", sql.NVarChar, location_no)
      .input("company_gst_no", sql.NVarChar, company_gst_no)
      .input("authorisedSignatur", sql.VarBinary, authorisedSignatur)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(
        `EXEC sp_company_info @mode, @company_no, @company_name, @short_name, @address1, @address2, @address3, @city, @state, @pincode, @country, @email_id, 
        @status, @foundedDate, @websiteURL, @company_logo, @contact_no, @annualReportURL,@location_no,@company_gst_no,@authorisedSignatur,@created_by,@modified_by,  
         @tempstr1, @tempstr2, @tempstr3, @tempstr4, 
        @datetime1, @datetime2, @datetime3, @datetime4`
      );

    // Return success response
    if (result.rowsAffected && result.rowsAffected[0] > 0) {
      return res.status(200).json({ success: true, message: 'Data inserted successfully' });
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};



const saveEditedData = async (req, res) => {
  const editedData = req.body.editedData;
  if (!editedData || !editedData.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }
  try {
    const pool = await connection.connectToDatabase();
    for (const updatedRow of editedData) {
      const company_logo =
        updatedRow.company_logo && updatedRow.company_logo.type === "Buffer"
          ? Buffer.from(updatedRow.company_logo.data)
          : null;

      const authorisedSignatur =
        updatedRow.authorisedSignatur && updatedRow.authorisedSignatur.type === "Buffer"
          ? Buffer.from(updatedRow.authorisedSignatur.data)
          : null;

      console.log(company_logo);
      await pool
        .request()
        .input("mode", sql.NVarChar, "U")
        .input("company_no", updatedRow.company_no)
        .input("company_name", updatedRow.company_name)
        .input("short_name", updatedRow.short_name)
        .input("address1", updatedRow.address1)
        .input("address2", updatedRow.address2)
        .input("address3", updatedRow.address3)
        .input("city", updatedRow.city)
        .input("state", updatedRow.state)
        .input("pincode", updatedRow.pincode)
        .input("country", updatedRow.country)
        .input("email_id", updatedRow.email_id)
        .input("status", updatedRow.status)
        .input("foundedDate", updatedRow.foundedDate)
        .input("websiteURL", updatedRow.websiteURL)
        .input("company_logo", sql.VarBinary, company_logo)
        .input("contact_no", updatedRow.contact_no)
        .input("annualReportURL", updatedRow.annualReportURL)
        .input("location_no", updatedRow.location_no)
        .input("company_gst_no", updatedRow.company_gst_no)
        .input("authorisedSignatur", sql.VarBinary, authorisedSignatur)
        .input("created_by", updatedRow.created_by)
        .input("modified_by", sql.NVarChar, req.headers['modified-by'])
        .input("tempstr1", updatedRow.tempstr1)
        .input("tempstr2", updatedRow.tempstr2)
        .input("tempstr3", updatedRow.tempstr3)
        .input("tempstr4", updatedRow.tempstr4)
        .input("datetime1", updatedRow.datetime1)
        .input("datetime2", updatedRow.datetime2)
        .input("datetime3", updatedRow.datetime3)
        .input("datetime4", updatedRow.datetime4)
        .query(`EXEC sp_company_info @mode, @company_no, @company_name, @short_name, @address1, @address2, @address3, @city, @state, @pincode, @country, @email_id,
          @status, @foundedDate, @websiteURL,@company_logo,@contact_no,@annualReportURL,@location_no,@company_gst_no,@authorisedSignatur,@created_by,@modified_by,
           @tempstr1, @tempstr2, @tempstr3, @tempstr4,
          @datetime1, @datetime2, @datetime3, @datetime4`);
    }
    res.status(200).json("Edited data saved successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const deleteData = async (req, res) => {
  const company_nosToDelete = req.body.company_nos;

  if (!company_nosToDelete || !company_nosToDelete.length) {
    res.status(400).json("Invalid or empty company_nos array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase();

    for (const company_no of company_nosToDelete) {

      await pool.request().input("company_no", company_no)
        .input("modified_by", sql.NVarChar, req.headers['modified-by'])
        .query(`
          EXEC sp_company_info 'D', @company_no,'','','','','','','','',
          '','','','','','','','',
          '','','','',@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
        `);
    }

    res.status(200).json("Companies deleted successfully");
  } catch (err) {
    console.error("Error during update:", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const getAlluserData = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`EXEC SP_user_info_hdr 'A','','','','',' ','','','','','','','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const userAddData = async (req, res) => {
  const {
    company_code,
    user_code,
    user_name,
    first_name,
    last_name,
    user_password,
    user_status,
    log_in_out,
    user_type,
    email_id,
    dob,
    gender,
    role_id,
    created_by,
    modified_by,
    tempstr1,
    tempstr2,
    tempstr3,
    tempstr4,
    datetime1,
    datetime2,
    datetime3,
    datetime4,
  } = req.body;

  let user_img = null;

  if (req.file) {
    user_img = req.file.buffer; // Buffer containing the uploaded image
  }

  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("user_code", sql.NVarChar, user_code)
      .input("user_name", sql.NVarChar, user_name)
      .input("first_name", sql.NVarChar, first_name)
      .input("last_name", sql.NVarChar, last_name)
      .input("user_password", sql.NVarChar, user_password)
      .input("user_status", sql.NVarChar, user_status)
      .input("log_in_out", sql.NVarChar, log_in_out)
      .input("user_type", sql.NVarChar, user_type)
      .input("email_id", sql.NVarChar, email_id)
      .input("dob", sql.NVarChar, dob)
      .input("gender", sql.NVarChar, gender)
      .input("role_id", sql.NVarChar, role_id)
      .input("user_img", sql.VarBinary, user_img)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(
        `EXEC SP_user_info_hdr_test1 @mode,@company_code,@user_code,@user_name,
        @first_name,@last_name,@user_password,
        @user_status,@log_in_out,@user_type,
        @email_id,@dob,@gender,@role_id,@user_img,@created_by,@modified_by,
        @tempstr1, @tempstr2, @tempstr3, @tempstr4,    
        @datetime1, @datetime2, @datetime3, @datetime4`
      );
    // Return success response
    if (result.rowsAffected && result.rowsAffected[0] > 0) {
      return res.status(200).json({ success: true, message: 'Data inserted successfully' });
    }
  } catch (err) {
    if (err.class === 16 && err.number === 50000) {
      // Custom error from the stored procedure
      res.status(400).json({ message: 'User already exists', err: err.message });
    } else {
      // Handle unexpected errors
      res.status(500).json({ message: err.message || 'Internal Server Error' });
    }
  }

};


const UsersaveEditedData = async (req, res) => {
  const editedData = req.body.editedData;

  if (!editedData || !editedData.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase(dbConfig);

    for (const updatedRow of editedData) {
      await pool
        .request()
        .input("mode", sql.NVarChar, "U") // update mode
        .input("company_code", sql.NVarChar, req.headers['company_code'])
        .input("user_code", sql.NVarChar, updatedRow.user_code)
        .input("user_name", sql.NVarChar, updatedRow.user_name)
        .input("first_name", sql.NVarChar, updatedRow.first_name)
        .input("last_name", sql.NVarChar, updatedRow.last_name)
        .input("user_password", sql.NVarChar, updatedRow.user_password)
        .input("user_status", sql.NVarChar, updatedRow.user_status)
        .input("log_in_out", sql.NVarChar, updatedRow.log_in_out)
        .input("user_type", sql.NVarChar, updatedRow.user_type)
        .input("email_id", sql.NVarChar, updatedRow.email_id)
        .input("dob", sql.NVarChar, updatedRow.dob)
        .input("gender", sql.NVarChar, updatedRow.gender)
        .input("role_id", sql.NVarChar, updatedRow.role_id)
        .input("created_by", sql.NVarChar, updatedRow.created_by)
        .input("modified_by", sql.NVarChar, req.headers['modified-by'])
        .input("tempstr1", sql.NVarChar, updatedRow.tempstr1)
        .input("tempstr2", sql.NVarChar, updatedRow.tempstr2)
        .input("tempstr3", sql.NVarChar, updatedRow.tempstr3)
        .input("tempstr4", sql.NVarChar, updatedRow.tempstr4)
        .input("datetime1", sql.NVarChar, updatedRow.datetime1)
        .input("datetime2", sql.NVarChar, updatedRow.datetime2)
        .input("datetime3", sql.NVarChar, updatedRow.datetime3)
        .input("datetime4", sql.NVarChar, updatedRow.datetime4)
        .query(
          `EXEC SP_user_info_hdr 
            'U',@company_code, @user_code, @user_name, @first_name, @last_name, 
            @user_password, @user_status, @log_in_out, @user_type, 
            @email_id, @dob, @gender,@role_id,'', @created_by,  
            @modified_by, @tempstr1, @tempstr2, @tempstr3, 
            @tempstr4, @datetime1, @datetime2, @datetime3, @datetime4`
        );
    }

    res.status(200).json("Edited data saved successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};



const UserdeleteData = async (req, res) => {
  const user_codesToDelete = req.body.user_codes;

  if (!user_codesToDelete || !user_codesToDelete.length) {
    res.status(400).json("Invalid or empty user_codes array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase();

    for (const user_code of user_codesToDelete) {
      try {
        await pool.request()
          .input("user_code", user_code)
          .input("company_code", sql.NVarChar, req.headers['company_code'])
          .input("modified_by", sql.NVarChar, req.headers['modified-by'])
          .query(`
      EXEC SP_user_info_hdr 'D',@company_code,@user_code,'','','', 
            '', '', '', '','','', '','','','', 
            @modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
      } catch (err) {
        if (err.number === 50000) {
          // Foreign key constraint violation
          res.status(500).json("The user cannot be deleted due to a link with another record");
          return;
        } else {
          throw err; // Rethrow other SQL errors
        }
      }
    }

    res.status(200).json("user deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};



const getAllWareHouseData = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query("select * from tbl_warehouse_info");

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getwarehouseSearchdata = async (req, res) => {
  const { company_code, warehouse_code, warehouse_name, status, location_no } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("company_code", sql.NVarChar, company_code)
      .input("warehouse_code", sql.NVarChar, warehouse_code)
      .input("warehouse_name", sql.NVarChar, warehouse_name)
      .input("status", sql.NVarChar, status)
      .input("location_no", sql.NVarChar, location_no)
      .query(` EXEC sp_warehouse_info @mode,@company_code,@warehouse_code,@warehouse_name,@status,@location_no,'','','','',NULL,NULL,NULL,NULL,'',''`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const AddWareHouseData = async (req, res) => {
  const {
    company_code,
    warehouse_code,
    warehouse_name,
    status,
    location_no,
    created_by,
    modified_by,
    tempstr1,
    tempstr2,
    tempstr3,
    tempstr4,
    datetime1,
    datetime2,
    datetime3,
    datetime4,
  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("warehouse_code", sql.NVarChar, warehouse_code)
      .input("warehouse_name", sql.NVarChar, warehouse_name)
      .input("status", sql.NVarChar, status)
      .input("location_no", sql.NVarChar, location_no)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(
        `EXEC sp_warehouse_info @mode,@company_code,@warehouse_code,
        @warehouse_name,@status,@location_no,@created_by,
        @modified_by,
        @tempstr1, @tempstr2, @tempstr3, @tempstr4, 
        @datetime1, @datetime2, @datetime3, @datetime4`
      );

    // Return success response
    if (result.rowsAffected && result.rowsAffected[0] > 0) {
      return res.status(200).json({ success: true, message: 'Data inserted successfully' });
    }
  } catch (err) {
    if (err.class === 16 && err.number === 50000) {
      // Custom error from the stored procedure
      res.status(400).json({ message: 'Warehouse already exists' });
    } else {
      // Handle unexpected errors
      res.status(500).json({ message: err.message || 'Internal Server Error' });
    }
  }
};



// update for WareHouse Data
const WareHousesaveEditedData = async (req, res) => {
  const editedData = req.body.editedData;

  if (!editedData || !editedData.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase(dbConfig);

    for (const updatedRow of editedData) {
      await pool
        .request()
        .input("mode", sql.NVarChar, "U") // update mode
        .input("company_code", sql.NVarChar, req.headers['company_code'])
        .input("warehouse_code", sql.NVarChar, updatedRow.warehouse_code)
        .input("warehouse_name", sql.NVarChar, updatedRow.warehouse_name)
        .input("status", sql.NVarChar, updatedRow.status)
        .input("location_no", sql.NVarChar, updatedRow.location_no)
        .input("created_by", sql.NVarChar, updatedRow.created_by)
        .input("modified_by", sql.NVarChar, req.headers['modified-by'])
        .input("tempstr1", sql.NVarChar, updatedRow.tempstr1)
        .input("tempstr2", sql.NVarChar, updatedRow.tempstr2)
        .input("tempstr3", sql.NVarChar, updatedRow.tempstr3)
        .input("tempstr4", sql.NVarChar, updatedRow.tempstr4)
        .input("datetime1", sql.NVarChar, updatedRow.datetime1)
        .input("datetime2", sql.NVarChar, updatedRow.datetime2)
        .input("datetime3", sql.NVarChar, updatedRow.datetime3)
        .input("datetime4", sql.NVarChar, updatedRow.datetime4)
        .query(
          `EXEC sp_warehouse_info 
            'U',@company_code, @warehouse_code, @warehouse_name, @status, @location_no, 
             @created_by,  @modified_by, 
             @tempstr1, @tempstr2, @tempstr3, @tempstr4,
              @datetime1, @datetime2, @datetime3, @datetime4`
        );
    }

    res.status(200).json("Edited data saved successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const WareHousedeleteData = async (req, res) => {
  const warehouse_codesToDelete = req.body.warehouse_codes;

  if (!warehouse_codesToDelete || !warehouse_codesToDelete.length) {
    res.status(400).json("Invalid or empty warehouse_codes array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase();

    for (const warehouse_code of warehouse_codesToDelete) {
      try {
        await pool.request().
          input("warehouse_code", warehouse_code)
          .input("company_code", sql.NVarChar, req.headers['company_code'])
          .input("modified_by", sql.NVarChar, req.headers['modified-by'])
          .query(`
        EXEC sp_warehouse_info 'D',@company_code,@warehouse_code,'','','','',@modified_by,'','','','','','','',''
        `);
      } catch (err) {
        if (err.number === 50000) {
          // Foreign key constraint violation
          res.status(400).json("The warehouse cannot be deleted due to a link with another record");
          return;
        } else {
          throw err; // Rethrow other SQL errors
        }
      }
    }

    res.status(200).json("WareHouse deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};





const getAllRoleInfoData = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`EXEC sp_role_Info 'A','','','','','','','','','','','','','',''`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const AddRoleInfoData = async (req, res) => {
  const {
    company_code,
    role_id,
    role_name,
    description,
    created_by,
    modified_by,
    tempstr1,
    tempstr2,
    tempstr3,
    tempstr4,
    datetime1,
    datetime2,
    datetime3,
    datetime4,
  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("role_id", sql.NVarChar, role_id)
      .input("role_name", sql.NVarChar, role_name)
      .input("description", sql.NVarChar, description)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(`EXEC sp_role_info @mode,@company_code, @role_id,
        @role_name,@description,
        @created_by,@modified_by,
        @tempstr1, @tempstr2, @tempstr3, @tempstr4, 
        @datetime1, @datetime2, @datetime3, @datetime4`
      );

    // Return success response
    if (result.rowsAffected && result.rowsAffected[0] > 0) {
      return res.status(200).json({ success: true, message: 'Data inserted successfully' });
    }
  } catch (err) {
    if (err.class === 16 && err.number === 50000) {
      // Custom error from the stored procedure
      res.status(400).json({ message: 'Role already exists' });
    } else {
      // Handle unexpected errors
      res.status(500).json({ message: err.message || 'Internal Server Error' });
    }
  }
};


// update for WareHouse Data
const RolesaveEditedData = async (req, res) => {
  const editedData = req.body.editedData;

  if (!editedData || !editedData.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase(dbConfig);

    for (const updatedRow of editedData) {
      await pool
        .request()
        .input("mode", sql.NVarChar, "U") // update mode
        .input("company_code", sql.NVarChar, req.headers['company_code'])
        .input("role_id", sql.NVarChar, updatedRow.role_id)
        .input("role_name", sql.NVarChar, updatedRow.role_name)
        .input("description", sql.NVarChar, updatedRow.description)
        .input("created_by", sql.NVarChar, updatedRow.created_by)
        .input("modified_by", sql.NVarChar, req.headers['modified-by'])
        .input("tempstr1", sql.NVarChar, updatedRow.tempstr1)
        .input("tempstr2", sql.NVarChar, updatedRow.tempstr2)
        .input("tempstr3", sql.NVarChar, updatedRow.tempstr3)
        .input("tempstr4", sql.NVarChar, updatedRow.tempstr4)
        .input("datetime1", sql.NVarChar, updatedRow.datetime1)
        .input("datetime2", sql.NVarChar, updatedRow.datetime2)
        .input("datetime3", sql.NVarChar, updatedRow.datetime3)
        .input("datetime4", sql.NVarChar, updatedRow.datetime4)
        .query(
          `EXEC sp_Role_Info @mode,@company_code,@role_id,@role_name,@description,@created_by,@modified_by,@tempstr1,@tempstr2,
          @tempstr3,@tempstr4,@datetime1,@datetime2,@datetime3,@datetime4
          `
        );
    }

    res.status(200).json("Edited data saved successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};




//ATRRIBUTE HDR SCREEN DATACONTROLLER

//GET ATTRIBUTES HEADER DATA
const getAllattributehdrData = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query("select * from tbl_attribute_info_hdr");

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


//ADD DATAS IN ATTRIBUTE HEADER TABLE
const addattrihdrData = async (req, res) => {
  const {
    company_code,
    attributeheader_code,
    attributeheader_name,
    status,
    created_by,
    modified_by,
    tempstr1,
    tempstr2,
    tempstr3,
    tempstr4,
    datetime1,
    datetime2,
    datetime3,
    datetime4,
  } = req.body;

  try {
    const pool = await sql.connect(dbConfig);

    const result = await pool.request()
      .input("mode", sql.NVarChar, "I")
      .input("company_code", sql.NVarChar, company_code)
      .input("attributeheader_code", sql.NVarChar, attributeheader_code)
      .input("attributeheader_name", sql.NVarChar, attributeheader_name)
      .input("status", sql.NVarChar, status)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(`EXEC sp_attribute_hdr @mode,@company_code,@attributeheader_code,@attributeheader_name,@status,@created_by,@modified_by,@tempstr1,@tempstr2,@tempstr3,@tempstr4,@datetime1,@datetime2,@datetime3,@datetime4`);

    // Return success response
    if (result.rowsAffected && result.rowsAffected[0] > 0) {
      return res.status(200).json({ success: true, message: 'Data inserted successfully' });
    }
  } catch (err) {
    {
      // Handle unexpected errors
      res.status(500).json({ message: err.message || 'Internal Server Error' });
    }
  }
};
//UPDATE DATAS IN ATTRIBUTE HEADER TABLE
// const 
// updattrihdrData = async (req, res) => {
//   const editedData = req.body.editedData;

//    if (!editedData || !editedData.length) {
//     res.status(400).json("Invalid or empty editedData array.");
//     return;
//   }

//   try {
//     const pool = await connection.connectToDatabase(dbConfig);

//     for (const updatedRow of editedData) {
//       await pool
//         .request()
//       .input("mode",                      sql.NVarChar, "u") // Insert mode
//       .input("attributeheader_code",      sql.NVarChar, updatedRow.attributeheader_code)
//       .input("attributeheader_name",      sql.NVarChar, updatedRow.attributeheader_name)
//       .input("status",                    sql.NVarChar, updatedRow.status)
//       .input("tempstr1",                  sql.NVarChar, updatedRow.tempstr1)
//       .input("tempstr2",                  sql.NVarChar, updatedRow.tempstr2)
//       .input("tempstr3",                  sql.NVarChar, updatedRow.tempstr3)
//       .input("tempstr4",                  sql.NVarChar, updatedRow.tempstr4)
//       .input("datetime1",                 sql.NVarChar, updatedRow.datetime1)
//       .input("datetime2",                 sql.NVarChar, updatedRow.datetime2)
//       .input("datetime3",                 sql.NVarChar, updatedRow.datetime3)
//       .input("datetime4",                 sql.NVarChar, updatedRow.datetime4)
//       .query(
//         `EXEC sp_attribute_hdr @mode,@attributeheader_code,@attributeheader_name,@status,@tempstr1, @tempstr2, @tempstr3, @tempstr4, 
//         @datetime1, @datetime2, @datetime3, @datetime4`);
//     }
//       res.status(200).json("Edited data saved successfully");
//     } catch (error) {
//       console.error(error);
//       res.status(500).json({ message: err.message || 'Internal Server Error' });
//     } finally {
//       connection.closeDatabaseConnection();
//     }

// };



//ATRRIBUTE HDR SCREEN DATACONTROLLER

//GET ATTRIBUTES HEADER DATA
const getAllattributedetData = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`EXEC sp_attribute_info 'A','','', '','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
    `);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


//ADD DATAS IN ATTRIBUTE DETAILS TABLE
const addattridetData = async (req, res) => {
  const {
    company_code,
    attributeheader_code,
    attributedetails_code,
    attributedetails_name,
    descriptions,
    created_by,
    modified_by,
    tempstr1,
    tempstr2,
    tempstr3,
    tempstr4,
    datetime1,
    datetime2,
    datetime3,
    datetime4,
  } = req.body;

  try {
    // Input validation
    if (!attributeheader_code) {
      return res.status(400).json({ error: 'Attribute Header Code cannot be blank' });
    }

    // Establish connection to the database
    const pool = await sql.connect(dbConfig);

    // Execute the stored procedure
    const result = await pool.request()
      .input('mode', sql.NVarChar, 'I') // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input('attributeheader_code', sql.NVarChar, attributeheader_code)
      .input('attributedetails_code', sql.NVarChar, attributedetails_code)
      .input('attributedetails_name', sql.NVarChar, attributedetails_name)
      .input('descriptions', sql.NVarChar, descriptions)
      .input('created_by', sql.NVarChar, created_by)
      .input('modified_by', sql.NVarChar, modified_by)
      .input('tempstr1', sql.NVarChar, tempstr1)
      .input('tempstr2', sql.NVarChar, tempstr2)
      .input('tempstr3', sql.NVarChar, tempstr3)
      .input('tempstr4', sql.NVarChar, tempstr4)
      .input('datetime1', sql.NVarChar, datetime1)
      .input('datetime2', sql.NVarChar, datetime2)
      .input('datetime3', sql.NVarChar, datetime3)
      .input('datetime4', sql.NVarChar, datetime4)
      .query(
        `EXEC sp_attribute_Info @mode,@company_code,@attributeheader_code, @attributedetails_code,@attributedetails_name,@descriptions,@created_by,@modified_by,@tempstr1, @tempstr2, @tempstr3, @tempstr4, 
        @datetime1, @datetime2, @datetime3, @datetime4`
      );
    // Return success response
    if (result.rowsAffected && result.rowsAffected[0] > 0) {
      return res.status(200).json({ success: true, message: 'Data inserted successfully' });
    }
  } catch (err) {
    if (err.class === 16 && err.number === 50000) {
      // Custom error from the stored procedure
      res.status(400).json({ message: err.message });
    } else {
      // Handle unexpected errors
      res.status(500).json({ message: err.message || 'Internal Server Error' });
    }
  }
};


// //UPDATE DATAS IN ATTRIBUTE HEADER TABLE
// const updattridetData = async (req, res) => {
//   const editedData = req.body.editedData;
//   try {
//     const pool = await connection.connectToDatabase(dbConfig);

//     for (const updatedRow of editedData) {
//       await pool
//         .request()
//       .input("mode",                      sql.NVarChar, "u") // Insert mode
//       .input("attributeheader_code",      sql.NVarChar, updatedRow.attributeheader_code)
//       .input("attributedetails_code",     sql.NVarChar, updatedRow.attributedetails_code)
//       .input("attributedetails_name",     sql.NVarChar, updatedRow.attributedetails_name)
//       .input("descriptions",              sql.NVarChar, updatedRow.descriptions)
//       .input('enduserid',                 sql.NVarChar, updatedRow.enduserid)
//       .input("tempstr1",                  sql.NVarChar, updatedRow.tempstr1)
//       .input("tempstr2",                  sql.NVarChar, updatedRow.tempstr2)
//       .input("tempstr3",                  sql.NVarChar, updatedRow.tempstr3)
//       .input("tempstr4",                  sql.NVarChar, updatedRow.tempstr4)
//       .input("datetime1",                 sql.NVarChar, updatedRow.datetime1)
//       .input("datetime2",                 sql.NVarChar, updatedRow.datetime2)
//       .input("datetime3",                 sql.NVarChar, updatedRow.datetime3)
//       .input("datetime4",                 sql.NVarChar, updatedRow.datetime4)
//       .query(
//         `EXEC sp_attribute_Info @mode,@attributeheader_code,@attributedetails_code, @attributedetails_name,@descriptions,@enduserid,@tempstr1, @tempstr2, @tempstr3, @tempstr4, 
//         @datetime1, @datetime2, @datetime3, @datetime4`
//       );
//     }
//     res.status(200).json("Edited data saved successfully");
//   } catch (error) {
//     console.error(error);
//     res.status(500).json({ message: err.message || 'Internal Server Error' });
//   } finally {
//     connection.closeDatabaseConnection();
//   }
// };

//   

// const updattridetData = async (req, res) => {
//   const { attributeheader_codesToUpdate, attributedetails_codesToUpdate, updatedData } = req.body;

//   if (!attributeheader_codesToUpdate || !attributeheader_codesToUpdate.length || 
//       !attributedetails_codesToUpdate || !attributedetails_codesToUpdate.length ||
//       !updatedData || !updatedData.length) {
//     res.status(400).json("Invalid or empty input data.");
//     return;
//   }

//   try {
//     const pool = await connection.connectToDatabase();

//     for (let i = 0; i < attributeheader_codesToUpdate.length; i++) {
//       const updatedRow = updatedData[i]; // Assuming updatedData is an array of objects with updated values

//       await pool.request()
//         .input("mode", sql.NVarChar, "U")
//         .input("attributeheader_code", attributeheader_codesToUpdate[i])
//         .input("attributedetails_code", attributedetails_codesToUpdate[i])
//         .input("descriptions", sql.NVarChar, updatedRow.descriptions)
//         .input("attributedetails_name", sql.NVarChar, updatedRow.attributedetails_name)
//         .input("enduserid", sql.NVarChar, updatedRow.enduserid)
//         .input("tempstr1", sql.NVarChar, updatedRow.tempstr1)
//         .input("tempstr2", sql.NVarChar, updatedRow.tempstr2)
//         .input("tempstr3", sql.NVarChar, updatedRow.tempstr3)
//         .input("tempstr4", sql.NVarChar, updatedRow.tempstr4)
//         .input("datetime1", sql.NVarChar, updatedRow.datetime1)
//         .input("datetime2", sql.NVarChar, updatedRow.datetime2)
//         .input("datetime3", sql.NVarChar, updatedRow.datetime3)
//         .input("datetime4", sql.NVarChar, updatedRow.datetime4)
//         .query(
//           `UPDATE [tbl_attribute_details_info]
//           SET descriptions = @descriptions,
//               attributedetails_name = @attributedetails_name,
//               modified_by = @enduserid,
//               modified_date = SYSDATETIME()
//           WHERE attributeheader_code = @attributeheader_code
//           AND attributedetails_code = @attributedetails_code`
//         );
//     }

//     res.status(200).json("Updated data successfully");
//   } catch (error) {
//     console.error(error);
//     res.status(500).json({ message: err.message || 'Internal Server Error' });
//   } finally {
//     connection.closeDatabaseConnection();
//   }
// };


const deleteAttriDetailData = async (req, res) => {
  const { attributeheader_codesToDelete, attributedetails_codeToDelete } = req.body;

  if (!attributeheader_codesToDelete || !attributeheader_codesToDelete.length || !attributedetails_codeToDelete || !attributedetails_codeToDelete.length) {
    res.status(400).json("Invalid or empty Codes or codeDetails array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase();

    const deleteQuery = `EXEC sp_attribute_Info 'D',@company_code,@attributeheader_code, @attributedetails_code,'','','',@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
    `;
    for (let i = 0; i < attributeheader_codesToDelete.length; i++) {
      try {
        await pool.request()
          .input("attributeheader_code", attributeheader_codesToDelete[i])
          .input("attributedetails_code", attributedetails_codeToDelete[i])
          .input("modified_by", sql.NVarChar, req.headers['modified-by'])
          .input("company_code", sql.NVarChar, req.headers['company_code'])
          .query(deleteQuery);
      } catch (err) {
        if (err.number === 50000) {
          // Foreign key constraint violation
          res.status(400).json("The attribute cannot be deleted due to a link with another record");
          return;
        } else {
          throw err; // Rethrow other SQL errors
        }
      }
    }

    res.status(200).json("Attribute data deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const updattridetData = async (req, res) => {
  const { attributeheader_codesToUpdate, attributedetails_codesToUpdate, updatedData } = req.body;

  if (!attributeheader_codesToUpdate || !attributeheader_codesToUpdate.length ||
    !attributedetails_codesToUpdate || !attributedetails_codesToUpdate.length ||
    !updatedData || !updatedData.length) {
    res.status(400).json("Invalid or empty input data.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase();

    for (let i = 0; i < attributeheader_codesToUpdate.length; i++) {
      const updatedRow = updatedData[i]; // Assuming updatedData is an array of objects with updated values

      await pool.request()
        .input("mode", sql.NVarChar, "U")
        .input("company_code", sql.NVarChar, req.headers['company_code'])
        .input("attributeheader_code", attributeheader_codesToUpdate[i])
        .input("attributedetails_code", attributedetails_codesToUpdate[i])
        .input("attributedetails_name", sql.NVarChar, updatedRow.attributedetails_name)
        .input("descriptions", sql.NVarChar, updatedRow.descriptions)
        .input("created_by", sql.NVarChar, updatedRow.created_by)
        .input("modified_by", sql.NVarChar, req.headers['modified-by'])
        .input("tempstr1", sql.NVarChar, updatedRow.tempstr1)
        .input("tempstr2", sql.NVarChar, updatedRow.tempstr2)
        .input("tempstr3", sql.NVarChar, updatedRow.tempstr3)
        .input("tempstr4", sql.NVarChar, updatedRow.tempstr4)
        .input("datetime1", sql.NVarChar, updatedRow.datetime1)
        .input("datetime2", sql.NVarChar, updatedRow.datetime2)
        .input("datetime3", sql.NVarChar, updatedRow.datetime3)
        .input("datetime4", sql.NVarChar, updatedRow.datetime4)
        .query(
          `EXEC sp_attribute_Info @mode,@company_code, @attributeheader_code, @attributedetails_code, @attributedetails_name, @descriptions, @created_by,@modified_by, @tempstr1, @tempstr2, @tempstr3, @tempstr4, @datetime1, @datetime2, @datetime3, @datetime4`
        );
    }

    res.status(200).json("Updated data successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


//Intermediary HEADER HDR SCREEN DATACONTROLLER

//GET Intermediary HEADER DATA
const getAllIntermediaryheaderData = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`EXEC sp_intermediary_hdr 'A','','','','','','','','','','','','','',''`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


//ADD DATAS IN Intermediary  HEADER  TABLE
const addIntermediaryHdrData = async (req, res) => {
  const {
    company_code,
    Code,
    Details,
    status,
    deletePermission,
    created_by,
    modified_by,
    tempstr1,
    tempstr2,
    tempstr3,
    tempstr4,
    datetime1,
    datetime2,
    datetime3,
    datetime4,
  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("Code", sql.NVarChar, Code)
      .input("Details", sql.NVarChar, Details)
      .input("status", sql.NVarChar, status)
      .input("deletePermission", sql.NVarChar, deletePermission)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(
        `EXEC sp_intermediary_hdr @mode,@company_code, @Code,@Details,@status,@deletePermission,@created_by,
        @modified_by,@tempstr1,@tempstr2,@tempstr3,@tempstr4,@datetime1,@datetime2,@datetime3,@datetime4`);

    // Return success response
    if (result.rowsAffected && result.rowsAffected[0] > 0) {
      return res.status(200).json({ success: true, message: 'Data inserted successfully' });
    }
  } catch (err) {
    if (err.class === 16 && err.number === 50000) {
      // Custom error from the stored procedure
      res.status(400).json({ message: 'Intermediary already exists' });
    } else {
      // Handle unexpected errors
      res.status(500).json({ message: err.message || 'Internal Server Error' });
    }
  }
};

//DELETE DATAS IN Intermediary  HEADER  TABLE

const deleteIntermediaryHeaderData = async (req, res) => {
  const CodesToDelete = req.body.Codes;

  if (!CodesToDelete || !CodesToDelete.length) {
    res.status(400).json("Invalid or empty Codes array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase();

    const deleteQuery = `EXEC sp_intermediary_hdr 'D','',@Code,'','','','','','','','','','','',''`;
    for (const Code of CodesToDelete) {
      await pool.request().input("Code", Code).query(deleteQuery);
    }

    res.status(200).json("Intermediary data deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};





//Intermediary DETAILS  SCREEN DATACONTROLLER

//GET Intermediary DETAILS DATA
const getAllIntermediaryDetailData = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`EXEC sp_intermediary_details 'A','','','','','','','','','','','','','','','','','','','','','','','','','','' `);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};


//ADD DATAS IN Intermediary  DETAILS  TABLE
const addIntermediaryDetailData = async (req, res) => {
  const {
    company_code,
    Code,
    codeDetails,
    intermediary_addr_1,
    intermediary_addr_2,
    intermediary_addr_3,
    intermediary_addr_4,
    intermediary_area_code,
    intermediary_stat_code,
    intermediary_cnty_code,
    intermediary_imex_no,
    intermediary_office_no,
    intermediary_resi_no,
    intermediary_mobile_no,
    intermediary_fax_no,
    intermediary_email_id,
    created_by,
    modified_by,
    tempstr1,
    tempstr2,
    tempstr3,
    tempstr4,
    datetime1,
    datetime2,
    datetime3,
    datetime4,
  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("Code", sql.NVarChar, Code)
      .input("codeDetails", sql.NVarChar, codeDetails)
      .input("intermediary_addr_1", sql.NVarChar, intermediary_addr_1)
      .input("intermediary_addr_2", sql.NVarChar, intermediary_addr_2)
      .input("intermediary_addr_3", sql.NVarChar, intermediary_addr_3)
      .input("intermediary_addr_4", sql.NVarChar, intermediary_addr_4)
      .input("intermediary_area_code", sql.NVarChar, intermediary_area_code)
      .input("intermediary_stat_code", sql.NVarChar, intermediary_stat_code)
      .input("intermediary_cnty_code", sql.NVarChar, intermediary_cnty_code)
      .input("intermediary_imex_no", sql.NVarChar, intermediary_imex_no)
      .input("intermediary_office_no", sql.NVarChar, intermediary_office_no)
      .input("intermediary_resi_no", sql.NVarChar, intermediary_resi_no)
      .input("intermediary_mobile_no", sql.NVarChar, intermediary_mobile_no)
      .input("intermediary_fax_no", sql.NVarChar, intermediary_fax_no)
      .input("intermediary_email_id", sql.NVarChar, intermediary_email_id)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(
        `EXEC sp_intermediary_details @mode,@company_code,@Code,@codeDetails,@intermediary_addr_1,@intermediary_addr_2,@intermediary_addr_3,@intermediary_addr_4,@intermediary_area_code,@intermediary_stat_code,@intermediary_cnty_code,@intermediary_imex_no,@intermediary_office_no,@intermediary_resi_no,@intermediary_mobile_no,@intermediary_fax_no,@intermediary_email_id,@created_by,
        @modified_by,@tempstr1,@tempstr2,@tempstr3,@tempstr4,@datetime1,@datetime2,@datetime3,@datetime4`);

    if (result.rowsAffected && result.rowsAffected[0] > 0) {
      return res.status(200).json({ success: true, message: 'Data inserted successfully' });
    }
  } catch (err) {
    if (err.class === 16 && err.number === 50000) {
      // Custom error from the stored procedure
      res.status(400).json({ message: err.message });
    } else {
      // Handle unexpected errors
      res.status(500).json({ message: err.message || "Internal Server Error" });
    }
  }
};


//DELETE DATAS IN Intermediary  HEADER  TABLE



const deleteIntermediaryDetailData = async (req, res) => {
  const { CodesToDelete, codeDetailsToDelete } = req.body;

  if (!CodesToDelete || !CodesToDelete.length || !codeDetailsToDelete || !codeDetailsToDelete.length) {
    res.status(400).json("Invalid or empty Codes or codeDetails array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase();

    const deleteQuery = `EXEC sp_intermediary_details 'D',@company_code, @Code, @codeDetails, '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '','','','','','',''`;
    for (let i = 0; i < CodesToDelete.length; i++) {
      try {
        await pool.request()
          .input("Code", CodesToDelete[i])
          .input("codeDetails", codeDetailsToDelete[i])
          .input("company_code", sql.NVarChar, req.headers['company_code'])
          .input("modified_by", sql.NVarChar, req.headers['modified-by'])
          .query(deleteQuery);
      } catch (err) {
        if (err.number === 50000) {
          // Foreign key constraint violation
          res.status(400).json("The intermediary cannot be deleted due to a link with another record");
          return;
        } else {
          throw err; // Rethrow other SQL errors
        }
      }
    }

    res.status(200).json("Intermediary data deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};


// const updintermediarydetData = async (req, res) => {
//   const { CodesToUpdate, codeDetailsToUpdate, updatedData } = req.body;

//   if (!CodesToUpdate || !CodesToUpdate.length || 
//       !codeDetailsToUpdate || !codeDetailsToUpdate.length ||
//       !updatedData || !updatedData.length) {
//     res.status(400).json("Invalid or empty input data.");
//     return;
//   }

//   try {
//     const pool = await connection.connectToDatabase();

//     for (let i = 0; i < CodesToUpdate.length; i++) {
//       const updatedRow = updatedData[i]; // Assuming updatedData is an array of objects with updated values

//       await pool.request()
//         .input("mode", sql.NVarChar, "U")
//         .input("Code", CodesToUpdate[i])
//         .input("codeDetails", codeDetailsToUpdate[i])
//         .input("intermediary_addr_1", sql.NVarChar, updatedRow.intermediary_addr_1)
//         .input("intermediary_addr_2", sql.NVarChar, updatedRow.intermediary_addr_2)
//         .input("intermediary_addr_3", sql.NVarChar, updatedRow.intermediary_addr_3)
//         .input("intermediary_addr_4", sql.NVarChar, updatedRow.intermediary_addr_4)
//         .input("intermediary_area_code", sql.NVarChar, updatedRow.intermediary_area_code)
//         .input("intermediary_stat_code", sql.NVarChar, updatedRow.intermediary_stat_code)
//         .input("intermediary_cnty_code", sql.NVarChar, updatedRow.intermediary_cnty_code)
//         .input("intermediary_imex_no", sql.NVarChar, updatedRow.intermediary_imex_no)
//         .input("intermediary_office_no", sql.NVarChar, updatedRow.intermediary_office_no)
//         .input("intermediary_resi_no", sql.NVarChar, updatedRow.intermediary_resi_no)
//         .input("intermediary_mobile_no", sql.NVarChar, updatedRow.intermediary_mobile_no)
//         .input("intermediary_fax_no", sql.NVarChar, updatedRow.intermediary_fax_no)
//         .input("intermediary_email_id", sql.NVarChar, updatedRow.intermediary_email_id)
//         .input("created_by", sql.NVarChar, updatedRow.created_by)
//         .input("modified_by", sql.NVarChar, updatedRow.modified_by)
//         .input("tempstr1", sql.NVarChar, updatedRow.tempstr1)
//         .input("tempstr2", sql.NVarChar, updatedRow.tempstr2)
//         .input("tempstr3", sql.NVarChar, updatedRow.tempstr3)
//         .input("tempstr4", sql.NVarChar, updatedRow.tempstr4)
//         .input("datetime1", sql.NVarChar, updatedRow.datetime1)
//         .input("datetime2", sql.NVarChar, updatedRow.datetime2)
//         .input("datetime3", sql.NVarChar, updatedRow.datetime3)
//         .input("datetime4", sql.NVarChar, updatedRow.datetime4)
//         .query(
//           `EXEC sp_intermediary_details @mode, @Code, @codeDetails, @intermediary_addr_1, @intermediary_addr_2,@intermediary_addr_3,@intermediary_addr_4,@intermediary_area_code,@intermediary_stat_code,@intermediary_cnty_code,@intermediary_imex_no,@intermediary_office_no,@intermediary_resi_no,@intermediary_mobile_no,@intermediary_fax_no,@intermediary_email_id,@created_by,@modified_by, @tempstr1, @tempstr2, @tempstr3, @tempstr4, @datetime1, @datetime2, @datetime3, @datetime4`
//         );
//     }

//     res.status(200).json("Updated data successfully");
//   } catch (error) {
//     console.error(error);
//     res.status(500).json({ message: err.message || 'Internal Server Error' });
//   } finally {
//     connection.closeDatabaseConnection();
//   }
// };

const updintermediarydetData = async (req, res) => {
  const { CodesToUpdate, codeDetailsToUpdate, updatedData } = req.body;

  if (!CodesToUpdate || !CodesToUpdate.length ||
    !codeDetailsToUpdate || !codeDetailsToUpdate.length ||
    !updatedData || !updatedData.length) {
    return res.status(400).json("Invalid or empty input data.");
  }

  try {
    const pool = await connection.connectToDatabase();

    for (let i = 0; i < CodesToUpdate.length; i++) {
      const updatedRow = updatedData[i]; // Assuming updatedData is an array of objects with updated values

      await pool.request()
        .input("mode", sql.NVarChar, "U")
        .input("company_code", sql.NVarChar, req.headers['company_code'])
        .input("Code", CodesToUpdate[i])
        .input("codeDetails", codeDetailsToUpdate[i])
        .input("intermediary_addr_1", sql.NVarChar, updatedRow.intermediary_addr_1)
        .input("intermediary_addr_2", sql.NVarChar, updatedRow.intermediary_addr_2)
        .input("intermediary_addr_3", sql.NVarChar, updatedRow.intermediary_addr_3)
        .input("intermediary_addr_4", sql.NVarChar, updatedRow.intermediary_addr_4)
        .input("intermediary_area_code", sql.NVarChar, updatedRow.intermediary_area_code)
        .input("intermediary_stat_code", sql.NVarChar, updatedRow.intermediary_stat_code)
        .input("intermediary_cnty_code", sql.NVarChar, updatedRow.intermediary_cnty_code)
        .input("intermediary_imex_no", sql.NVarChar, updatedRow.intermediary_imex_no)
        .input("intermediary_office_no", sql.NVarChar, updatedRow.intermediary_office_no)
        .input("intermediary_resi_no", sql.NVarChar, updatedRow.intermediary_resi_no)
        .input("intermediary_mobile_no", sql.NVarChar, updatedRow.intermediary_mobile_no)
        .input("intermediary_fax_no", sql.NVarChar, updatedRow.intermediary_fax_no)
        .input("intermediary_email_id", sql.NVarChar, updatedRow.intermediary_email_id)
        .input("created_by", sql.NVarChar, updatedRow.created_by)
        .input("modified_by", sql.NVarChar, req.headers['modified-by'])
        .input("tempstr1", sql.NVarChar, updatedRow.tempstr1)
        .input("tempstr2", sql.NVarChar, updatedRow.tempstr2)
        .input("tempstr3", sql.NVarChar, updatedRow.tempstr3)
        .input("tempstr4", sql.NVarChar, updatedRow.tempstr4)
        .input("datetime1", sql.NVarChar, updatedRow.datetime1)
        .input("datetime2", sql.NVarChar, updatedRow.datetime2)
        .input("datetime3", sql.NVarChar, updatedRow.datetime3)
        .input("datetime4", sql.NVarChar, updatedRow.datetime4)
        .query(
          `EXEC sp_intermediary_details @mode, @company_code, @Code, @codeDetails, @intermediary_addr_1, @intermediary_addr_2, 
          @intermediary_addr_3, @intermediary_addr_4, @intermediary_area_code, @intermediary_stat_code, @intermediary_cnty_code, @intermediary_imex_no,
           @intermediary_office_no, @intermediary_resi_no, @intermediary_mobile_no, @intermediary_fax_no, @intermediary_email_id, @created_by, @modified_by,
            @tempstr1, @tempstr2, @tempstr3, @tempstr4, @datetime1, @datetime2, @datetime3, @datetime4`
        );
    }

    res.status(200).json("Updated data successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};


//UOM HEADER DATACONTROLLER

//GET UOM HDR DATA
const getAllUOMData = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`EXEC sp_uom_hdr 'A',0,'','',0,'','','','','','','','','','','','',''`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};


//ADD DATAS IN UOM  HDR  TABLE
const addUOMData = async (req, res) => {
  const {
    uom_id,
    uom_name,
    uom_desc,
    uom_values,
    deletepermission,
    company_code,
    created_by,
    created_date,
    modified_by,
    modified_date,
    tempstr1,
    tempstr2,
    tempstr3,
    tempstr4,
    datetime1,
    datetime2,
    datetime3,
    datetime4,
  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("uom_id", sql.Int, uom_id)
      .input("uom_name", sql.NVarChar, uom_name)
      .input("uom_desc", sql.NVarChar, uom_desc)
      .input("uom_values", sql.Decimal(14, 2), uom_values)
      .input("deletepermission", sql.NVarChar, deletepermission)
      .input("company_code", sql.NVarChar, company_code)
      .input("created_by", sql.NVarChar, created_by)
      .input("created_date", sql.NVarChar, created_date)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("modified_date", sql.NVarChar, modified_date)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(
        `EXEC sp_uom_hdr @mode,@uom_id,@uom_name,@uom_desc,@uom_values,@deletepermission,@company_code,@created_by,
        @created_date,@modified_by,@modified_date,@tempstr1,@tempstr2,@tempstr3,@tempstr4,@datetime1,@datetime2,@datetime3,@datetime4`);

    res.json({ success: true, message: "Data inserrrted successfully" });
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const updateUOMData = async (req, res) => {
  const {
    uom_id,
    uom_name,
    uom_desc,
    uom_values,
    deletepermission,
    company_code,
    modified_by,

  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "U") // Insert mode
      .input("uom_id", sql.Int, uom_id)
      .input("uom_name", sql.NVarChar, uom_name)
      .input("uom_desc", sql.NVarChar, uom_desc)
      .input("uom_values", sql.Decimal(14, 2), uom_values)
      .input("deletepermission", sql.NVarChar, deletepermission)
      .input("company_code", sql.NVarChar, company_code)
      .input("modified_by", sql.NVarChar, modified_by)

      .query(
        `EXEC sp_uom_hdr @mode,@uom_id,@uom_name,@uom_desc,@uom_values,@deletepermission,@company_code,'',
        '',@modified_by,'',@tempstr1,@tempstr2,@tempstr3,@tempstr4,@datetime1,@datetime2,@datetime3,@datetime4`);

    res.json({ success: true, message: "Data inserrrted successfully" });
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const deleteUOMData = async (req, res) => {
  const { uom_id, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    await pool
      .request()
      .input("uom_id", sql.NVarChar, uom_id)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_uom_hdr @mode,@uom_id,'','','','',@company_code,'',
        '','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    res.status(200).json("Employee salary data deleted successfully");
  } catch (err) {
    console.error("Error inserting data:", err);

    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};





const getAllTaxHdrData = async (req, res) => {
  const { company_code } = req.body;
  let pool;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        `EXEC sp_tax_name_hdr 'A',@company_code,'','',0,'','','','','','','','',null,null,null,null,null,null,null,null `
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error ", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//Dhana created on 22-apr-2024   use:taxinformation
const addTaxHdrData = async (req, res) => {
  const {
    company_code,
    tax_type,
    tax_name,
    tax_percentage,
    tax_shortname,
    tax_accountcode,
    transaction_type,
    status,
    tax_type_Sales,
    Keyfield,
    created_by,
    modified_by,
    tempstr1,
    tempstr2,
    tempstr3,
    tempstr4,
    datetime1,
    datetime2,
    datetime3,
    datetime4,
  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.VarChar, company_code)
      .input("tax_type", sql.NVarChar, tax_type)
      .input("tax_name", sql.NVarChar, tax_name)
      .input("tax_percentage", sql.Decimal(14, 2), tax_percentage)
      .input("tax_shortname", sql.NVarChar, tax_shortname)
      .input("tax_accountcode", sql.NVarChar, tax_accountcode)
      .input("transaction_type", sql.NVarChar, transaction_type)
      .input("status", sql.NVarChar, status)
      .input("tax_type_Sales", sql.NVarChar, tax_type_Sales)
      .input("Keyfield", sql.NVarChar, Keyfield)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(
        `EXEC [sp_tax_name_hdr] @mode,@company_code,@tax_type,@tax_name,@tax_percentage,@tax_shortname,@tax_accountcode,@transaction_type,@status,@tax_type_Sales,@Keyfield,@created_by,@modified_by,
        @tempstr1,@tempstr2,@tempstr3,@tempstr4,@datetime1,@datetime2,@datetime3,@datetime4`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json(err.message);
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//dhana-taxnamedetails//

const getAllTaxDetailsData = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`EXEC sp_tax_name_details 'A','','',0,'','','','','','', NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const addTaxDetailsData = async (req, res) => {
  const {
    company_code,
    tax_type_header,
    tax_name_details,
    tax_percentage,
    tax_shortname,
    tax_accountcode,
    transaction_type,
    status,
    created_by,
    modified_by,
    tempstr1,
    tempstr2,
    tempstr3,
    tempstr4,
    datetime1,
    datetime2,
    datetime3,
    datetime4,

  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.VarChar, company_code)
      .input("tax_type_header", sql.NVarChar, tax_type_header)
      .input("tax_name_details", sql.NVarChar, tax_name_details)
      .input("tax_percentage", sql.Decimal(14, 2), tax_percentage)
      .input("tax_shortname", sql.NVarChar, tax_shortname)
      .input("tax_accountcode", sql.NVarChar, tax_accountcode)
      .input("transaction_type", sql.NVarChar, transaction_type)
      .input("status", sql.NVarChar, status)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(
        `EXEC sp_tax_name_details @mode,@company_code,@tax_type_header, @tax_name_details, @tax_percentage,@tax_shortname,@tax_accountcode,@transaction_type,@status,@created_by,@modified_by,
        @tempstr1,@tempstr2,@tempstr3,@tempstr4,@datetime1,@datetime2,@datetime3,@datetime4`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json(err.message);
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const updtaxdetaildata = async (req, res) => {
  const editedData = req.body.editedData;

  if (!editedData || !editedData.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase(dbConfig);

    for (const updatedRow of editedData) {
      await pool
        .request()
        .input("mode", sql.NVarChar, "U")
        .input("company_code", sql.VarChar, req.headers['company_code'])
        .input("tax_type_header", updatedRow.tax_type_header)
        .input("tax_name_details", updatedRow.tax_name_details)
        .input("tax_percentage", updatedRow.tax_percentage)
        .input("tax_shortname", updatedRow.tax_shortname)
        .input("tax_accountcode", updatedRow.tax_accountcode)
        .input("transaction_type", updatedRow.transaction_type)
        .input("status", updatedRow.status)
        .input("created_by", updatedRow.created_by)
        .input("modified_by", sql.NVarChar, req.headers['modified-by'])
        .input("tempstr1", updatedRow.tempstr1)
        .input("tempstr2", updatedRow.tempstr2)
        .input("tempstr3", updatedRow.tempstr3)
        .input("tempstr4", updatedRow.tempstr4)
        .input("datetime1", updatedRow.datetime1)
        .input("datetime2", updatedRow.datetime2)
        .input("datetime3", updatedRow.datetime3)
        .input("datetime4", updatedRow.datetime4)
        .query(`EXEC sp_tax_name_details @mode,@company_code,@tax_type_header, @tax_name_details, @tax_percentage, @tax_shortname, @tax_accountcode, @transaction_type, @status, @created_by, @modified_by,
             @tempstr1, @tempstr2, @tempstr3, @tempstr4, 
            @datetime1, @datetime2, @datetime3, @datetime4`);
    }

    res.status(200).json("Edited data saved successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

// ITEM BRAND INFO
const getAllItemBrandData = async (req, res) => {
  const { company_code } = req.body;
  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "A")
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_item_brand_info  @mode, @company_code, '', '', '', 0, '', '', '', 0, 0, 0, 0, '', '', '', '', '', '', '', '', '', '', '', 0, 0, '', '', '', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};




//ADD DATAS Item  DETAILS  TABLE
const addItemBrandData = async (req, res) => {
  const {
    company_code,
    Item_code,
    Item_variant,
    Item_name,
    Item_wigh,
    Item_BaseUOM,
    Item_SecondaryUOM,
    Item_short_name,
    Item_Last_salesRate_ExTax,
    Item_Last_salesRate_IncludingTax,
    Item_std_purch_price,
    Item_std_sales_price,
    Item_stock_code,
    Item_purch_tax_type,
    Item_sales_tax_type,
    Item_Costing_Method,
    Item_stock_type,
    hsn,
    Item_Register_Brand,
    Item_Our_Brand,
    status,
    barcodeimg,
    Item_other_purch_taxtype,
    Item_other_sales_taxtype,
    MRP_price,
    discount_Percentage,
    created_by,
    modified_by,
    tempstr1,
    tempstr2,
    tempstr3,
    tempstr4,
    datetime1,
    datetime2,
    datetime3,
    datetime4,
  } = req.body;

  let item_images = null;

  if (req.file) {
    item_images = req.file.buffer; // Buffer containing the uploaded image
  }

  try {
    pool = await sql.connect(dbConfig);

    // const bufferImage = Buffer.from(item_images, 'base64')

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("Item_code", sql.NVarChar, Item_code)
      .input("Item_variant", sql.NVarChar, Item_variant)
      .input("Item_name", sql.NVarChar, Item_name)
      .input("Item_wigh", sql.Decimal(10, 2), Item_wigh)
      .input("Item_BaseUOM", sql.NVarChar, Item_BaseUOM)
      .input("Item_SecondaryUOM", sql.NVarChar, Item_SecondaryUOM)
      .input("Item_short_name", sql.NVarChar, Item_short_name)
      .input("Item_Last_salesRate_ExTax", sql.Decimal(12, 2), Item_Last_salesRate_ExTax)
      .input("Item_Last_salesRate_IncludingTax", sql.Decimal(12, 2), Item_Last_salesRate_IncludingTax)
      .input("Item_std_purch_price", sql.Decimal(12, 2), Item_std_purch_price)
      .input("Item_std_sales_price", sql.Decimal(12, 2), Item_std_sales_price)
      .input("Item_stock_code", sql.NVarChar, Item_stock_code)
      .input("Item_purch_tax_type", sql.NVarChar, Item_purch_tax_type)
      .input("Item_sales_tax_type", sql.NVarChar, Item_sales_tax_type)
      .input("Item_Costing_Method", sql.NVarChar, Item_Costing_Method)
      .input("Item_stock_type", sql.NVarChar, Item_stock_type)
      .input("hsn", sql.NVarChar, hsn)
      .input("Item_Register_Brand", sql.NVarChar, Item_Register_Brand)
      .input("Item_Our_Brand", sql.NVarChar, Item_Our_Brand)
      .input("status", sql.NVarChar, status)
      .input("item_images", sql.VarBinary, item_images)
      .input("barcodeimg", sql.NVarChar, barcodeimg)
      .input("Item_other_purch_taxtype", sql.NVarChar, Item_other_purch_taxtype)
      .input("Item_other_sales_taxtype", sql.NVarChar, Item_other_sales_taxtype)
      .input("MRP_price", sql.Decimal(10, 2), MRP_price)
      .input("discount_Percentage", sql.Decimal(5, 2), discount_Percentage)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(
        `EXEC sp_item_brand_info @mode,@company_code,@Item_code,@Item_variant,@Item_name,@Item_wigh,@Item_BaseUOM,@Item_SecondaryUOM,@Item_short_name,@Item_Last_salesRate_ExTax,
     @Item_Last_salesRate_IncludingTax,@Item_std_purch_price,@Item_std_sales_price,@Item_stock_code,@Item_purch_tax_type,@Item_sales_tax_type,@Item_Costing_Method,@Item_stock_type,
     @hsn,@Item_Register_Brand,@Item_Our_Brand,@status,@item_images, @barcodeimg,@Item_other_purch_taxtype,@Item_other_sales_taxtype,@MRP_price,@discount_Percentage,'',@created_by,@modified_by,@tempstr1,@tempstr2,@tempstr3,@tempstr4,@datetime1,@datetime2,@datetime3,@datetime4`);

    // Return success response
    if (result.rowsAffected && result.rowsAffected[0] > 0) {
      return res.status(200).json({ success: true, message: 'Data inserted successfully' });
    }
  } catch (err) {
    if (err.class === 16 && err.number === 50000) {
      // Custom error from the stored procedure
      res.status(400).json({ message: 'Item already exists', err: err.message });
    } else {
      // Handle unexpected errors
      res.status(500).json({ message: err.message || 'Internal Server Error' });
    }
  }

};





const deleteItemData = async (req, res) => {
  const Item_codesToDelete = req.body.Item_codes;

  if (!Item_codesToDelete || !Item_codesToDelete.length) {
    res.status(400).json("Invalid or empty Codes or codeDetails array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase();

    for (const Item_code of Item_codesToDelete) {
      await pool.request()
        .input("Item_code", Item_code)
        .input("company_code", sql.NVarChar, req.headers['company_code'])
        .input("modified_by", sql.NVarChar, req.headers['modified-by'])
        .query(`EXEC sp_item_brand_info  'D',@company_code,@Item_code,'','',0,'','','',0,0,0,0,'','','','','','','','','','','','','',0,0,'','',@modified_by,NULL,NULL,NULL,NULL
              ,NULL,NULL,NULL,NULL`);
    }


    res.status(200).json("Item deleted successfully");
  } catch (err) {
    console.error("Error ", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

//VENDOR HRD INFO //

const addVendorHdrData = async (req, res) => {
  const {
    company_code,
    vendor_code,
    vendor_name,
    status,
    vendor_logo,
    panno,
    vendor_gst_no,
    created_by,
    modified_by,
    tempstr1,
    tempstr2,
    tempstr3,
    tempstr4,
    datetime1,
    datetime2,
    datetime3,
    datetime4,
  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("vendor_code", sql.NVarChar, vendor_code)
      .input("vendor_name", sql.NVarChar, vendor_name)
      .input("status", sql.NVarChar, status)
      .input("vendor_logo", sql.NVarChar, vendor_logo)
      .input("panno", sql.NVarChar, panno)
      .input("vendor_gst_no", sql.NVarChar, vendor_gst_no)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(
        `EXEC sp_vendor_info_hdr @mode,@company_code,@vendor_code, @vendor_name, @status,'',@panno,@vendor_gst_no,@created_by,@modified_by,
        @tempstr1,@tempstr2,@tempstr3,@tempstr4,@datetime1,@datetime2,@datetime3,@datetime4`);
    if (result.rowsAffected && result.rowsAffected[0] > 0) {
      return res.status(200).json({ success: true, message: 'Data inserted successfully' });
    }
  } catch (err) {
    {
      // Handle unexpected errors
      res.status(500).json({ message: err.message || 'Internal Server Error' });
    }
  }
};


const getAllVendorHdrData = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`EXEC sp_vendor_info_hdr 'A','','','','','','','','','',null,null,null,null,null,null,null,null`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error ", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};


// VENDOR DET INFO//
const getAllVendorDetData = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`EXEC sp_vendor_details_info_hdr 'A','','','','','','','','','','','','' ,'','','',
      '','','','',0,'','','','','','','','','',NULL,NULL,NULL,null,null,null,null,null`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const addVendorDetData = async (req, res) => {
  const {
    vendor_code,
    company_code,
    vendor_name,
    status,
    panno,
    vendor_gst_no,
    vendor_addr_1,
    vendor_addr_2,
    vendor_addr_3,
    vendor_addr_4,
    vendor_area_code,
    vendor_state_code,
    vendor_country_code,
    vendor_imex_no,
    vendor_office_no,
    vendor_resi_no,
    vendor_mobile_no,
    vendor_fax_no,
    vendor_email_id,
    vendor_credit_limit,
    vendor_transport_code,
    vendor_salesman_code,
    vendor_broker_code,
    vendor_weekday_code,
    contact_person,
    office_type,
    created_by,
    modified_by,
    tempstr1,
    tempstr2,
    tempstr3,
    tempstr4,
    datetime1,
    datetime2,
    datetime3,
    datetime4,
  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("vendor_code", sql.VarChar, vendor_code)
      .input("company_code", sql.NVarChar, company_code)
      .input("vendor_name", sql.NVarChar, vendor_name)
      .input("status", sql.NVarChar, status)
      .input("panno", sql.NVarChar, panno)
      .input("vendor_gst_no", sql.NVarChar, vendor_gst_no)
      .input("vendor_addr_1", sql.VarChar, vendor_addr_1)
      .input("vendor_addr_2", sql.VarChar, vendor_addr_2)
      .input("vendor_addr_3", sql.VarChar, vendor_addr_3)
      .input("vendor_addr_4", sql.VarChar, vendor_addr_4)
      .input("vendor_area_code", sql.VarChar, vendor_area_code)
      .input("vendor_state_code", sql.VarChar, vendor_state_code)
      .input("vendor_country_code", sql.VarChar, vendor_country_code)
      .input("vendor_imex_no", sql.NVarChar, vendor_imex_no)
      .input("vendor_office_no", sql.NVarChar, vendor_office_no)
      .input("vendor_resi_no", sql.NVarChar, vendor_resi_no)
      .input("vendor_mobile_no", sql.NVarChar, vendor_mobile_no)
      .input("vendor_fax_no", sql.NVarChar, vendor_fax_no)
      .input("vendor_email_id", sql.NVarChar, vendor_email_id)
      .input("vendor_credit_limit", sql.Decimal(14, 3), vendor_credit_limit)
      .input("vendor_transport_code", sql.NVarChar, vendor_transport_code)
      .input("vendor_salesman_code", sql.NVarChar, vendor_salesman_code)
      .input("vendor_broker_code", sql.NVarChar, vendor_broker_code)
      .input("vendor_weekday_code", sql.NVarChar, vendor_weekday_code)
      .input("contact_person", sql.NVarChar, contact_person)
      .input("office_type", sql.NVarChar, office_type)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(
        `EXEC sp_vendor_details_info_hdr @mode, @vendor_code, @company_code, '', '', '', '', @vendor_addr_1, @vendor_addr_2,
        @vendor_addr_3, @vendor_addr_4, @vendor_area_code, @vendor_state_code, @vendor_country_code, @vendor_imex_no, @vendor_office_no, @vendor_resi_no, @vendor_mobile_no,
         @vendor_fax_no, @vendor_email_id, @vendor_credit_limit, @vendor_transport_code, @vendor_salesman_code, @vendor_broker_code, @vendor_weekday_code, @contact_person,@office_type,'',@created_by, @modified_by,
          @tempstr1, @tempstr2, @tempstr3, @tempstr4, @datetime1, @datetime2, @datetime3, @datetime4`
      );
    if (result.rowsAffected && result.rowsAffected[0] > 0) {
      return res.status(200).json({ success: true, message: 'Data inserted successfully' });
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};



const updvendordetData = async (req, res) => {
  const { vendor_codesToUpdate, company_codesToUpdate, updatedData } = req.body;

  if (!vendor_codesToUpdate || !vendor_codesToUpdate.length ||
    !company_codesToUpdate || !company_codesToUpdate.length ||
    !updatedData || !updatedData.length) {
    return res.status(400).json("Invalid or empty input data.");
  }

  try {
    const pool = await connection.connectToDatabase();

    for (let i = 0; i < vendor_codesToUpdate.length; i++) {
      const updatedRow = updatedData[i]; // Assuming updatedData is an array of objects with updated values

      await pool.request()
        .input("mode", sql.NVarChar, "U")
        .input("vendor_code", vendor_codesToUpdate[i])
        .input("company_code", company_codesToUpdate[i])
        .input("vendor_name", sql.NVarChar, updatedRow.vendor_name)
        .input("status", sql.NVarChar, updatedRow.status)
        .input("panno", sql.NVarChar, updatedRow.panno)
        .input("vendor_gst_no", sql.NVarChar, updatedRow.vendor_gst_no)
        .input("vendor_addr_1", sql.NVarChar, updatedRow.vendor_addr_1)
        .input("vendor_addr_2", sql.NVarChar, updatedRow.vendor_addr_2)
        .input("vendor_addr_3", sql.NVarChar, updatedRow.vendor_addr_3)
        .input("vendor_addr_4", sql.NVarChar, updatedRow.vendor_addr_4)
        .input("vendor_area_code", sql.NVarChar, updatedRow.vendor_area_code)
        .input("vendor_state_code", sql.NVarChar, updatedRow.vendor_state_code)
        .input("vendor_country_code", sql.NVarChar, updatedRow.vendor_country_code)
        .input("vendor_imex_no", sql.NVarChar, updatedRow.vendor_imex_no)
        .input("vendor_office_no", sql.NVarChar, updatedRow.vendor_office_no)
        .input("vendor_resi_no", sql.NVarChar, updatedRow.vendor_resi_no)
        .input("vendor_mobile_no", sql.NVarChar, updatedRow.vendor_mobile_no)
        .input("vendor_fax_no", sql.NVarChar, updatedRow.vendor_fax_no)
        .input("vendor_email_id", sql.NVarChar, updatedRow.vendor_email_id)
        .input("vendor_credit_limit", sql.Decimal(14, 3), updatedRow.vendor_credit_limit)
        .input("vendor_transport_code", sql.NVarChar, updatedRow.vendor_transport_code)
        .input("vendor_salesman_code", sql.NVarChar, updatedRow.vendor_salesman_code)
        .input("vendor_broker_code", sql.NVarChar, updatedRow.vendor_broker_code)
        .input("vendor_weekday_code", sql.NVarChar, updatedRow.vendor_weekday_code)
        .input("contact_person", sql.NVarChar, updatedRow.contact_person)
        .input("office_type", sql.NVarChar, updatedRow.office_type)
        .input("keyfield", sql.NVarChar, updatedRow.keyfield)
        .input("created_by", sql.NVarChar, updatedRow.created_by)
        .input("modified_by", sql.NVarChar, req.headers['modified-by'])
        .input("tempstr1", sql.NVarChar, updatedRow.tempstr1)
        .input("tempstr2", sql.NVarChar, updatedRow.tempstr2)
        .input("tempstr3", sql.NVarChar, updatedRow.tempstr3)
        .input("tempstr4", sql.NVarChar, updatedRow.tempstr4)
        .input("datetime1", sql.NVarChar, updatedRow.datetime1)
        .input("datetime2", sql.NVarChar, updatedRow.datetime2)
        .input("datetime3", sql.NVarChar, updatedRow.datetime3)
        .input("datetime4", sql.NVarChar, updatedRow.datetime4)
        .query(
          `EXEC sp_vendor_details_info_hdr @mode,@vendor_code,@company_code,@vendor_name,@status,@panno,@vendor_gst_no,@vendor_addr_1,@vendor_addr_2,@vendor_addr_3,
            @vendor_addr_4,@vendor_area_code,@vendor_state_code ,@vendor_country_code,@vendor_imex_no,@vendor_office_no,@vendor_resi_no,@vendor_mobile_no,@vendor_fax_no,@vendor_email_id,
            @vendor_credit_limit,@vendor_transport_code,@vendor_salesman_code,@vendor_broker_code,@vendor_weekday_code, @contact_person,@office_type,@keyfield,@created_by, @modified_by, @tempstr1, @tempstr2, @tempstr3, @tempstr4,
             @datetime1, @datetime2, @datetime3, @datetime4`
        );
    }

    res.status(200).json("Updated data successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};



const VendordeleteData = async (req, res) => {
  const { keyfieldsToDelete } = req.body;

  if (!keyfieldsToDelete || !keyfieldsToDelete.length) {
    res.status(400).json("Invalid or empty Codes or codeDetails array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase();

    const deleteQuery = `EXEC sp_vendor_details_info_hdr 'D','',@company_code,'','','','','','','','','','' ,'','','','','','','',0,
      '','','','','','',@keyfield,'',@modified_by,NULL,NULL,NULL,null,null,null,null,null
      `;
    for (let i = 0; i < keyfieldsToDelete.length; i++) {
      await pool.request()
        .input("keyfield", keyfieldsToDelete[i])
        .input("company_code", sql.NVarChar, req.headers['company-code'])
        .input("modified_by", sql.NVarChar, req.headers['modified-by'])
        .query(deleteQuery);

    }

    res.status(200).json("Vendor data deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


//Dhana create on : 02may2024 COMPANY MAPPING//
const getAllCompanyMappingData = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`EXEC sp_user_company_mapping 'I','','','','','',0,'','','',
      NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};
const addCompanyMappingData = async (req, res) => {
  const {
    company_code,
    user_code,
    company_no,
    location_no,
    status,
    order_no,
    created_by,
    modified_by,
    tempstr1,
    tempstr2,
    tempstr3,
    tempstr4,
    datetime1,
    datetime2,
    datetime3,
    datetime4,

  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("user_code", sql.VarChar, user_code)
      .input("company_no", sql.NVarChar, company_no)
      .input("location_no", sql.VarChar, location_no)
      .input("status", sql.VarChar, status)
      .input("order_no", sql.Int, order_no)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(
        `EXEC sp_user_company_mapping @mode,@company_code,@user_code,@company_no,@location_no,@status,@order_no,'',@created_by,@modified_by,
        @tempstr1,@tempstr2,@tempstr3,@tempstr4,@datetime1,@datetime2,@datetime3,@datetime4`);

    // Return success response
    if (result.rowsAffected && result.rowsAffected[0] > 0) {
      return res.status(200).json({ success: true, message: 'Data inserted successfully' });
    }
  } catch (err) {
    if (err.class === 16 && err.number === 50000) {
      // Custom error from the stored procedure
      res.status(400).json({ message: err.message });
    } else {
      // Handle unexpected errors
      res.status(500).json({ message: err.message || "Internal Server Error" });
    }
  }
};


const getitemcodepurdata = async (req, res) => {
  const { Item_code, company_code } = req.body;
  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();
    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "STPIC")
      .input("Item_code", sql.NVarChar, Item_code)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_item_brand_info @mode,@company_code,@Item_code,'','',0,'','','',0,0,0,0,'','','','','','','','','','','','','',0,0,'','','',NULL,NULL,NULL,NULL
               ,NULL,NULL,NULL,NULL `);
    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};


const getAllUserRoleMappingData = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`EXEC sp_user_rolemapping 'A','','','','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};
const addUserRoleMappingData = async (req, res) => {
  const {
    company_code,
    user_code,
    role_id,
    created_by,
    modified_by,
    tempstr1,
    tempstr2,
    tempstr3,
    tempstr4,
    datetime1,
    datetime2,
    datetime3,
    datetime4,

  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("user_code", sql.VarChar, user_code)
      .input("role_id", sql.NVarChar, role_id)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(
        `EXEC sp_user_rolemapping @mode,@company_code, @user_code,'',@role_id,'','',@created_by,@modified_by,
        @tempstr1,@tempstr2,@tempstr3,@tempstr4,@datetime1,@datetime2,@datetime3,@datetime4`);

    res.json({ success: true, message: "Data inserted successfully" });
  } catch (err) {
    if (err.class === 16 && err.number === 50000) {
      // Custom error from the stored procedure
      res.status(400).json({ message: 'User & Role already exists' });
    } else {
      // Handle unexpected errors
      res.status(500).json({ message: err.message || "Internal Server Error" });
    }
  }
};

const getlocationsearchdata = async (req, res) => {
  const { company_code, location_no, location_name, city, state, pincode, country, status } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("location_no", sql.NVarChar, location_no)
      .input("location_name", sql.NVarChar, location_name)
      .input("city", sql.NVarChar, city)
      .input("state", sql.NVarChar, state)
      .input("pincode", sql.NVarChar, pincode)
      .input("country", sql.NVarChar, country)
      .input("status", sql.NVarChar, status)
      .query(` EXEC sp_location_info @mode,@location_no,@location_name, '', '', '', '', @city,@state, @pincode, @country, '', 
        @status, '', NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const addlocationinfo = async (req, res) => {
  const { location_no, location_name, short_name, address1, address2, address3, city, state, pincode,
    country, email_id, status, contact_no, created_by, modified_by,
    tempstr1, tempstr2, tempstr3, tempstr4, datetime1, datetime2, datetime3, datetime4,
  } = req.body;

  let pool;
  try {
    pool = await sql.connect(dbConfig);



    // If the company code doesn't exist, proceed with inserting the data
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("location_no", sql.NVarChar, location_no)
      .input("location_name", sql.NVarChar, location_name)
      .input("short_name", sql.NVarChar, short_name)
      .input("address1", sql.NVarChar, address1)
      .input("address2", sql.NVarChar, address2)
      .input("address3", sql.NVarChar, address3)
      .input("city", sql.NVarChar, city)
      .input("state", sql.NVarChar, state)
      .input("pincode", sql.NVarChar, pincode)
      .input("country", sql.NVarChar, country)
      .input("email_id", sql.NVarChar, email_id)
      .input("status", sql.NVarChar, status)
      .input("contact_no", sql.NVarChar, contact_no)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(
        `EXEC sp_location_info @mode,@location_no, @location_name, @short_name, @address1, @address2, @address3, @city, @state, @pincode, @country, @email_id, 
      @status,  @contact_no, @created_by,@modified_by,
       @tempstr1, @tempstr2, @tempstr3, @tempstr4, 
      @datetime1, @datetime2, @datetime3, @datetime4`
      );

    // Return success response
    if (result.rowsAffected && result.rowsAffected[0] > 0) {
      return res.status(200).json({ success: true, message: 'Data inserted successfully' });
    }
  } catch (err) {
    if (err.class === 16 && err.number === 50000) {
      // Custom error from the stored procedure
      res.status(400).json({ message: 'Location already exists' });
    } else {
      // Handle unexpected errors
      res.status(500).json({ message: err.message || "Internal Server Error" });
    }
  }
};

const locationsaveEditedData = async (req, res) => {
  const editedData = req.body.editedData;

  if (!editedData || !editedData.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase();

    for (const updatedRow of editedData) {
      await pool
        .request()
        .input("mode", sql.NVarChar, "U")
        .input("location_no", updatedRow.location_no)
        .input("location_name", updatedRow.location_name)
        .input("short_name", updatedRow.short_name)
        .input("address1", updatedRow.address1)
        .input("address2", updatedRow.address2)
        .input("address3", updatedRow.address3)
        .input("city", updatedRow.city)
        .input("state", updatedRow.state)
        .input("pincode", updatedRow.pincode)
        .input("country", updatedRow.country)
        .input("email_id", updatedRow.email_id)
        .input("status", updatedRow.status)
        .input("contact_no", updatedRow.contact_no)
        .input("created_by", updatedRow.created_by)
        .input("modified_by", sql.NVarChar, req.headers['modified-by'])
        .input("tempstr1", updatedRow.tempstr1)
        .input("tempstr2", updatedRow.tempstr2)
        .input("tempstr3", updatedRow.tempstr3)
        .input("tempstr4", updatedRow.tempstr4)
        .input("datetime1", updatedRow.datetime1)
        .input("datetime2", updatedRow.datetime2)
        .input("datetime3", updatedRow.datetime3)
        .input("datetime4", updatedRow.datetime4)
        .query(`EXEC sp_location_info @mode,@location_no, @location_name, @short_name, @address1, @address2, 
          @address3, @city, @state, @pincode, @country, @email_id,  @status, @contact_no, @created_by, @modified_by , 
         @tempstr1, @tempstr2, @tempstr3, @tempstr4, 
        @datetime1, @datetime2, @datetime3, @datetime4`);
    }

    res.status(200).json("Edited data saved successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const locationdeleteData = async (req, res) => {
  const location_nosToDelete = req.body.location_nos;

  if (!location_nosToDelete || !location_nosToDelete.length) {
    res.status(400).json("Invalid or empty location no's array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase();

    for (const location_no of location_nosToDelete) {
      try {
        await pool.request().input("location_no", location_no)
          .input("modified_by", sql.NVarChar, req.headers['modified-by'])
          .query(`EXEC sp_location_info 'D',@location_no, '', '', '', '', '', 
          '', '', '', '', '','',  '', '',@modified_by,
       NULL, NULL, NULL, NULL,NULL, NULL, NULL, NULL`
          );
      } catch (err) {
        if (err.number === 50000) {
          // Foreign key constraint violation
          res.status(400).json("The location cannot be deleted due to a link with another record");
          return;
        } else {
          throw err; // Rethrow other SQL errors
        }
      }
    }

    res.status(200).json("Companies deleted successfully");
  } catch (err) {
    console.error("Error", err.message);
    return res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const getitemsearchdata = async (req, res) => {
  const { company_code, Item_code, Item_name, Item_variant, Item_short_name, Item_Our_Brand, status } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("company_code", sql.NVarChar, company_code)
      .input("Item_code", sql.NVarChar, Item_code)
      .input("Item_variant", sql.NVarChar, Item_variant)
      .input("Item_name", sql.NVarChar, Item_name)
      .input("Item_short_name", sql.NVarChar, Item_short_name)
      .input("Item_Our_Brand", sql.NVarChar, Item_Our_Brand)
      .input("status", sql.NVarChar, status)
      .query(`EXEC sp_item_brand_info @mode,@company_code,@Item_code,@Item_variant,@Item_name,0,'','',@Item_short_name,0,0,0,0,'','','','','','','',@Item_Our_Brand,@status,'','','','',0,0,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err.message);
    return res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const getitempursearchdata = async (req, res) => {
  const { company_code, Item_code, Item_name, Item_variant, Item_short_name, Item_Our_Brand, status } = req.body;
  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();
    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "STP")
      .input("company_code", sql.NVarChar, company_code)
      .input("Item_code", sql.NVarChar, Item_code)
      .input("Item_variant", sql.NVarChar, Item_variant)
      .input("Item_name", sql.NVarChar, Item_name)
      .input("Item_short_name", sql.NVarChar, Item_short_name)
      .input("Item_Our_Brand", sql.NVarChar, Item_Our_Brand)
      .input("status", sql.NVarChar, status)
      .query(`EXEC sp_item_brand_info @mode,@company_code,@Item_code,@Item_variant, @Item_name,0,'','',@Item_short_name,0,0,0,0,'','','','','','','',@Item_Our_Brand, @status,'','','','',0,0,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);
    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err.message);
    return res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const getpursearchdata = async (req, res) => {
  const { company_code, transaction_no, transaction_date, vendor_code, vendor_name, purchase_type, pay_type } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("company_code", sql.NVarChar, company_code)
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("transaction_date", sql.NVarChar, transaction_date)
      .input("vendor_code", sql.NVarChar, vendor_code)
      .input("vendor_name", sql.NVarChar, vendor_name)
      .input("purchase_type", sql.NVarChar, purchase_type)
      .input("pay_type", sql.NVarChar, pay_type)
      .query(`EXEC sp_purchase_hdr @mode,@company_code,'', @transaction_no,@transaction_date,@purchase_type,@vendor_code,@vendor_name,@pay_type,
          0,'',0,0,0,0,0,0,'',0,'', 0,'',0,'','','','','','','','','','', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err.message);
    return res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const getpurDeleteDetails = async (req, res) => {
  const { company_code, transaction_no, transaction_date, vendor_code, vendor_name, purchase_type, pay_type } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SCD")
      .input("company_code", sql.NVarChar, company_code)
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("transaction_date", sql.NVarChar, transaction_date)
      .input("vendor_code", sql.NVarChar, vendor_code)
      .input("vendor_name", sql.NVarChar, vendor_name)
      .input("purchase_type", sql.NVarChar, purchase_type)
      .input("pay_type", sql.NVarChar, pay_type)
      .query(`
      EXEC sp_purchase_hdr @mode,@company_code,'', @transaction_no,@transaction_date,@purchase_type,@vendor_code,@vendor_name,@pay_type,
          0,'',0,0,0,0,0,0,'',0,'', 0,'',0,'','','','','','','','','','', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};




const getpurchasereturnit = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "PD")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_getdata 'PD',@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};



const getpurchasereturntax = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "PT")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_getdata @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const addpurchasereturntaxdetails = async (req, res) => {
  const {
    company_code, transaction_date, transaction_no, return_date, return_reason, return_person, return_no,
    vendor_code, ItemSNo, TaxSNo, item_code, item_name, tax_type, tax_name_details, tax_amt, tax_per, tax_acode,
    pay_type, created_by, modified_by, tempstr1, tempstr2, tempstr3, tempstr4, datetime1, datetime2, datetime3, datetime4,

  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I")
      .input("company_code", sql.NVarChar, company_code)
      .input("transaction_date", sql.Date, transaction_date)
      .input("return_no", sql.NVarChar, return_no)
      .input("return_date", sql.Date, return_date)
      .input("return_reason", sql.NVarChar, return_reason)
      .input("return_person", sql.NVarChar, return_person)
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("vendor_code", sql.NVarChar, vendor_code)
      .input("pay_type", sql.NVarChar, pay_type)
      .input("ItemSNo", sql.BigInt, ItemSNo)
      .input("TaxSNo", sql.BigInt, TaxSNo)
      .input("item_code", sql.NVarChar, item_code)
      .input("item_name", sql.NVarChar, item_name)
      .input("tax_type", sql.NVarChar, tax_type)
      .input("tax_name_details", sql.NVarChar, tax_name_details)
      .input("tax_amt", sql.Decimal(14, 2), tax_amt)
      .input("tax_per", sql.Decimal(14, 2), tax_per)
      .input("tax_acode", sql.NVarChar, tax_acode)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(
        `EXEC sp_purchase_return_tax_details @mode,@company_code,@transaction_date,@return_no,@return_date,@return_reason,@return_person,@transaction_no,@vendor_code,
    @pay_type,@ItemSNo,@TaxSNo,@item_code,@item_name,@tax_type,@tax_name_details,@tax_amt,@tax_per,@tax_acode,'',@created_by,@modified_by
,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.json({ success: true, message: "Data inserted successfully" });
  } catch (err) {
    console.error("Error", err.message);
    return res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};




const getpurchasereturndetails = async (req, res) => {
  const { company_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "A")
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_purchase_return_details @mode,@company_code,'','','','','','','','','',0,0,0,0,0,0,0,'','','','','','','','','','','','',
0,'',0,0,'','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err.message);
    return res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};


const getpurchasereturntaxdetails = async (req, res) => {
  const { company_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "A")
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_purchase_return_tax_details @mode,@company_code,'','','','','','','','',0,0,'','','','',0,0,'','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};



const addpurchasereturndetails = async (req, res) => {
  const {
    company_code, transaction_date, transaction_no, return_date, return_no, warehouse_code,
    vendor_code, item_code, item_name, return_item_name, bill_qty, return_qty, bill_rate,
    item_amt, weight, return_weight, total_weight, return_details, pay_type, purchase_type, broker_code, tpot_code, sman_code,
    purchacc_code, stock_type, stock_code, entry_no, vendor_name, order_type, tax_amount, hsn, return_amt, ItemSNo, created_by, modified_by,
    tempstr1, tempstr2, tempstr3, tempstr4, datetime1, datetime2, datetime3, datetime4
  } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    const result = await pool.request()
      .input("mode", sql.NVarChar, "I")
      .input("company_code", sql.NVarChar, company_code)
      .input("transaction_date", sql.Date, transaction_date)
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("return_date", sql.Date, return_date)
      .input("return_no", sql.NVarChar, return_no)
      .input("warehouse_code", sql.NVarChar, warehouse_code)
      .input("vendor_code", sql.NVarChar, vendor_code)
      .input("item_code", sql.NVarChar, item_code)
      .input("item_name", sql.NVarChar, item_name)
      .input("return_item_name", sql.NVarChar, return_item_name)
      .input("bill_qty", sql.Decimal(10, 2), bill_qty)
      .input("return_qty", sql.Decimal(10, 2), return_qty)
      .input("bill_rate", sql.Decimal(10, 2), bill_rate)
      .input("item_amt", sql.Decimal(10, 2), item_amt)
      .input("weight", sql.Decimal(8, 3), weight)
      .input("return_weight", sql.Decimal(8, 3), return_weight)
      .input("total_weight", sql.Decimal(10, 2), total_weight)
      .input("return_details", sql.NVarChar, return_details)
      .input("pay_type", sql.NVarChar, pay_type)
      .input("purchase_type", sql.NVarChar, purchase_type)
      .input("broker_code", sql.NVarChar, broker_code)
      .input("tpot_code", sql.NVarChar, tpot_code)
      .input("sman_code", sql.NVarChar, sman_code)
      .input("purchacc_code", sql.NVarChar, purchacc_code)
      .input("stock_type", sql.NVarChar, stock_type)
      .input("stock_code", sql.NVarChar, stock_code)
      .input("entry_no", sql.NVarChar, entry_no)
      .input("vendor_name", sql.NVarChar, vendor_name)
      .input("order_type", sql.NVarChar, order_type)
      .input("tax_amount", sql.Decimal(14, 2), tax_amount)
      .input("hsn", sql.NVarChar, hsn)
      .input("return_amt", sql.Decimal(10, 2), return_amt)
      .input("ItemSNo", sql.BigInt, ItemSNo)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(`EXEC sp_purchase_return_details
            @mode, @company_code,@transaction_date, @transaction_no, @return_date, @return_no, @warehouse_code, @vendor_code, @item_code,
            @item_name, @return_item_name, @bill_qty, @return_qty, @bill_rate, @item_amt, @weight, @return_weight,
            @total_weight, @return_details, @pay_type, @purchase_type, @broker_code, @tpot_code, @sman_code, @purchacc_code, @stock_type, @stock_code,
            @entry_no, @vendor_name, @order_type, @tax_amount, @hsn, @return_amt, @ItemSNo,'','', @created_by, @modified_by, 
            @tempstr1, @tempstr2, @tempstr3, @tempstr4, @datetime1, @datetime2, @datetime3, @datetime4`);

    if (result.rowsAffected && result.rowsAffected.length > 0) {
      res.json({ success: true, message: "Data inserted successfully" });
    } else {
      res.json({ success: false, message: "Data not inserted" });
    }
  } catch (err) {
    // Log the error to console for debugging purposes
    console.error(err);
    // Send detailed error response to client
    res.status(500).json({ success: false, error: err.message });
  }
};



const getPurchaseData = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "P")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_getdata @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Check if data is found
    if (result.recordsets && result.recordsets.length > 0 && result.recordsets[0].length > 0) {
      const data = {
        table1: result.recordsets[0],
        table2: result.recordsets[1] || [], // Provide an empty array if no data
        table3: result.recordsets[2] || []  // Provide an empty array if no data
      };
      res.status(200).json(data); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};


const getsalessearchdata = async (req, res) => {
  const { company_code, bill_date, bill_no, dely_chlno, warehouse_code, sales_type, customer_code, customer_name, sale_amt, bill_amt, pay_type, order_type } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("company_code", sql.NVarChar, company_code)
      .input("bill_date", sql.NVarChar, bill_date)
      .input("bill_no", sql.NVarChar, bill_no)
      .input("dely_chlno", sql.NVarChar, dely_chlno)
      .input("warehouse_code", sql.NVarChar, warehouse_code)
      .input("sales_type", sql.NVarChar, sales_type)
      .input("customer_code", sql.NVarChar, customer_code)
      .input("customer_name", sql.NVarChar, customer_name)
      .input("sale_amt", sql.Decimal(14, 2), sale_amt)
      .input("bill_amt", sql.Decimal(14, 2), bill_amt)
      .input("pay_type", sql.NVarChar, pay_type)
      .input("order_type", sql.NVarChar, order_type)
      // .input("status", sql.NVarChar, status)
      .query(`EXEC sp_sales_hdr @mode,@company_code,@bill_date,@bill_no,@dely_chlno,@warehouse_code,@sales_type,@customer_code,
        @sale_amt,0,0,0,0,0,0,0,0,0,@bill_amt,0,0,@pay_type,'','','','','','',
        @customer_name,'','',@order_type,0,'','','','','','',0,0,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err.message);
    return res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};



const getUserrolesearchdata = async (req, res) => {
  const { company_code, user_code, user_name, role_id, role_name } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("company_code", sql.NVarChar, company_code)
      .input("user_code", sql.NVarChar, user_code)
      .input("user_name", sql.NVarChar, user_name)
      .input("role_id", sql.NVarChar, role_id)
      .input("role_name", sql.NVarChar, role_name)
      .query(`EXEC sp_user_rolemapping @mode,@company_code,@user_code,@user_name,@role_id,@role_name,'','','',
      null,null,null,null,null,null,null,null `);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err.message);
    return res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const getUsersearchdata = async (req, res) => {
  const { company_code, user_code, user_name, first_name, last_name, user_status, email_id, dob, gender, role_id, user_img } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("company_code", sql.NVarChar, company_code)
      .input("user_code", sql.NVarChar, user_code)
      .input("user_name", sql.NVarChar, user_name)
      .input("first_name", sql.NVarChar, first_name)
      .input("last_name", sql.NVarChar, last_name)
      .input("user_status", sql.NVarChar, user_status)
      .input("email_id", sql.NVarChar, email_id)
      .input("dob", sql.NVarChar, dob)
      .input("gender", sql.NVarChar, gender)
      .input("role_id", sql.NVarChar, role_id)
      .input("user_img", sql.NVarChar, user_img)
      .query(` EXEC SP_user_info_hdr @mode,@company_code,@user_code,@user_name,@first_name,@last_name,'',@user_status,'','',@email_id,@dob,@gender,@role_id,@user_img,'','','','','','','','','',''`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err.message);
    return res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const getRolesearchdata = async (req, res) => {
  const { company_code, role_id, role_name } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("company_code", sql.NVarChar, company_code)
      .input("role_id", sql.NVarChar, role_id)
      .input("role_name", sql.NVarChar, role_name)
      .query(`EXEC sp_Role_Info @mode,@company_code,@role_id,@role_name,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err.message);
    return res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const roledeleteData = async (req, res) => {
  const role_idsToDelete = req.body.role_ids;

  if (!role_idsToDelete || !role_idsToDelete.length) {
    res.status(400).json("Invalid or empty RoleID array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase();

    for (const role_id of role_idsToDelete) {
      try {
        await pool.request().input("role_id", role_id)
          .input("modified_by", sql.NVarChar, req.headers['modified-by'])
          .input("company_code", sql.NVarChar, req.headers['company_code'])
          .query(`
          EXEC sp_Role_Info 'D',@company_code,@role_id,'','','',@modified_by,
        NULL, NULL, NULL, NULL,NULL, NULL, NULL, NULL
          `);
      } catch (err) {
        if (err.number === 50000) {
          // Foreign key constraint violation
          res.status(400).json("The role cannot be deleted due to a link with another record");
          return;
        } else {
          throw err; // Rethrow other SQL errors
        }
      }
    }

    res.status(200).json("User deleted successfully");
  } catch (err) {
    console.error("Error", err.message);
    return res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};


const getvendorSearchdata = async (req, res) => {
  const { company_code, vendor_code, vendor_name, panno, vendor_gst_no, vendor_addr_1, vendor_area_code, vendor_state_code, vendor_country_code, vendor_mobile_no, status } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("company_code", sql.NVarChar, company_code)
      .input("vendor_code", sql.NVarChar, vendor_code)
      .input("vendor_name", sql.NVarChar, vendor_name)
      .input("status", sql.NVarChar, status)
      .input("panno", sql.NVarChar, panno)
      .input("vendor_gst_no", sql.NVarChar, vendor_gst_no)
      .input("vendor_addr_1", sql.NVarChar, vendor_addr_1)
      .input("vendor_area_code", sql.NVarChar, vendor_area_code)
      .input("vendor_state_code", sql.NVarChar, vendor_state_code)
      .input("vendor_country_code", sql.NVarChar, vendor_country_code)
      .input("vendor_mobile_no", sql.NVarChar, vendor_mobile_no)
      .query(`EXEC sp_vendor_details_info_hdr @mode,@vendor_code,@company_code,@vendor_name,@status,@panno,@vendor_gst_no,@vendor_addr_1,'','','',@vendor_area_code,@vendor_state_code,
        @vendor_country_code,'','','',@vendor_mobile_no,'' ,'',0,'','','','','','','','','',NULL,NULL,NULL,NULL,NULL,null,null,null`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const getAllpurhdrData = async (req, res) => {
  const { company_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "A")
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_purchase_hdr @mode,@company_code, '', '', '', '', '', '','', 0,'', 0, 0, 0, 0,'', 0,'', 0,'', 0,'', 0,'', '', '', '', '', 
                '', '','', '', '',NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err.message);
    return res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};




const addpurchaseheader = async (req, res) => {
  const { company_code, Entry_date, transaction_no, transaction_date, purchase_type, purchase_amount, purchase_amount_acc_code, total_amount, vendor_code, vendor_name, pay_type, add_fright, less_fright, tax_amount, tax_acc_code, rounded_off, rounded_off_acc_code, loading_charges, loading_charges_acc_code, cartage_paid, cartage_paid_acc_code, other_charges, other_charges_acc_code, lorry_no, broker_code, transport_code, status, deletePermission, created_by, modified_by,
    tempstr1, tempstr2, tempstr3, tempstr4, datetime1, datetime2, datetime3, datetime4,

  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("Entry_date", sql.Date, Entry_date)
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("transaction_date", sql.Date, transaction_date)
      .input("purchase_type", sql.NVarChar, purchase_type)
      .input("vendor_code", sql.NVarChar, vendor_code)
      .input("vendor_name", sql.NVarChar, vendor_name)
      .input("pay_type", sql.NVarChar, pay_type)
      .input("purchase_amount", sql.Decimal(14, 2), purchase_amount)
      .input("purchase_amount_acc_code", sql.NVarChar, purchase_amount_acc_code)
      .input("total_amount", sql.Decimal(10, 2), total_amount)
      .input("add_fright", sql.Decimal(14, 2), add_fright)
      .input("less_fright", sql.Decimal(14, 2), less_fright)
      .input("tax_amount", sql.Decimal(14, 2), tax_amount)
      .input("tax_acc_code", sql.NVarChar, tax_acc_code)
      .input("rounded_off", sql.Decimal(14, 2), rounded_off)
      .input("rounded_off_acc_code", sql.NVarChar, rounded_off_acc_code)
      .input("loading_charges", sql.Decimal(14, 2), loading_charges)
      .input("loading_charges_acc_code", sql.NVarChar, loading_charges_acc_code)
      .input("cartage_paid", sql.Decimal(14, 2), cartage_paid)
      .input("cartage_paid_acc_code", sql.NVarChar, cartage_paid_acc_code)
      .input("other_charges", sql.Decimal(14, 2), other_charges)
      .input("other_charges_acc_code", sql.NVarChar, other_charges_acc_code)
      .input("lorry_no", sql.NVarChar, lorry_no)
      .input("broker_code", sql.NVarChar, broker_code)
      .input("transport_code", sql.NVarChar, transport_code)
      .input("status", sql.NVarChar, status)
      .input("deletePermission", sql.NVarChar, deletePermission)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(`EXEC sp_purchase_hdr @mode,@company_code,@Entry_date, @transaction_no,@transaction_date,@purchase_type,@vendor_code,@vendor_name,@pay_type,
          @purchase_amount,@purchase_amount_acc_code,@total_amount,@add_fright,@less_fright,@tax_amount,@tax_acc_code,@rounded_off,@rounded_off_acc_code,@loading_charges,
          @loading_charges_acc_code, @cartage_paid, @cartage_paid_acc_code,@other_charges, @other_charges_acc_code,@lorry_no, @broker_code, @transport_code, @status,@deletePermission,
          '','',@created_by, @modified_by, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json(err.message);
    }
  } catch (err) {
    console.error("Error", err.message);
    return res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};


const getAllpurhdetData = async (req, res) => {
  const { company_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "A")
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_purchase_details 'A',@company_code,'','','','',0,'','',0,0,0,0,0,'','','','','','','',0,'','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err.message);
    return res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};



const addpurchasedetail = async (req, res) => {
  const {
    company_code, transaction_date, transaction_no, warehouse_code, vendor_code, ItemSNo, item_code, item_name, bill_qty, bill_rate,
    item_amt, weight, total_weight, pay_type, purchase_type, stock_type, stock_code, vendor_name, order_type, hsn, tax_amount, created_by, modified_by,
    tempstr1, tempstr2, tempstr3, tempstr4, datetime1, datetime2, datetime3, datetime4,

  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("transaction_date", sql.Date, transaction_date)
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("warehouse_code", sql.NVarChar, warehouse_code)
      .input("vendor_code", sql.NVarChar, vendor_code)
      .input("ItemSNo", sql.BigInt, ItemSNo)
      .input("item_code", sql.NVarChar, item_code)
      .input("item_name", sql.NVarChar, item_name)
      .input("bill_qty", sql.Decimal(10, 2), bill_qty)
      .input("bill_rate", sql.Decimal(10, 2), bill_rate)
      .input("item_amt", sql.Decimal(10, 2), item_amt)
      .input("weight", sql.Decimal(8, 3), weight)
      .input("total_weight", sql.Decimal(10, 2), total_weight)
      .input("pay_type", sql.NVarChar, pay_type)
      .input("purchase_type", sql.NVarChar, purchase_type)
      .input("stock_type", sql.NVarChar, stock_type)
      .input("stock_code", sql.NVarChar, stock_code)
      .input("vendor_name", sql.NVarChar, vendor_name)
      .input("order_type", sql.NVarChar, order_type)
      .input("hsn", sql.NVarChar, hsn)
      .input("tax_amount", sql.Decimal(14, 2), tax_amount)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(
        `EXEC sp_purchase_details @mode,@company_code,@transaction_date,@transaction_no,@warehouse_code,@vendor_code,@ItemSNo,@item_code,@item_name,@bill_qty,@bill_rate,
          @item_amt,@weight,@total_weight,@pay_type,@purchase_type,@stock_type,@stock_code,@vendor_name,
          @order_type,@hsn,@tax_amount,'','',@created_by,@modified_by,
          @tempstr1,@tempstr2,@tempstr3,@tempstr4,@datetime1,@datetime2,@datetime3,@datetime4`);
    res.json({ success: true, message: "Data inserted successfully" });
  } catch (err) {
    console.error("Error", err.message);
    return res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};



const getAllpurtaxData = async (req, res) => {
  const { company_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "A")
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_purchase_tax_details @mode,@company_code,'','','','',0,0,'','','','',0,0,'','',''
              ,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err.message);
    return res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const addpurtaxdetail = async (req, res) => {
  const {
    company_code, transaction_date, transaction_no, vendor_code, pay_type, ItemSNo, TaxSNo, item_code, item_name, tax_type, tax_name_details, tax_amt, tax_per, tax_acode,
    created_by, modified_by,
    tempstr1, tempstr2, tempstr3, tempstr4, datetime1, datetime2, datetime3, datetime4,

  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("transaction_date", sql.Date, transaction_date)
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("vendor_code", sql.NVarChar, vendor_code)
      .input("pay_type", sql.NVarChar, pay_type)
      .input("ItemSNo", sql.BigInt, ItemSNo)
      .input("TaxSNo", sql.BigInt, TaxSNo)
      .input("item_code", sql.NVarChar, item_code)
      .input("item_name", sql.NVarChar, item_name)
      .input("tax_type", sql.NVarChar, tax_type)
      .input("tax_name_details", sql.NVarChar, tax_name_details)
      .input("tax_amt", sql.Decimal(14, 2), tax_amt)
      .input("tax_per", sql.Decimal(14, 2), tax_per)
      .input("tax_acode", sql.NVarChar, tax_acode)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(
        `EXEC sp_purchase_tax_details @mode,@company_code,@transaction_date,@transaction_no,@vendor_code,@pay_type,@ItemSNo,@TaxSNo,@item_code,@item_name,@tax_type,@tax_name_details,
              @tax_amt,@tax_per,@tax_acode,'',@created_by,@modified_by,
              @tempstr1,@tempstr2,@tempstr3,@tempstr4,@datetime1,@datetime2,@datetime3,@datetime4`);
    res.json({ success: true, message: "Data inserted successfully" });
  } catch (err) {
    console.error("Error", err.message);
    return res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};




const getTotalAmountCalculation = async (req, res) => {
  const { Tax_amount, company_code, Putchase_amount } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "TOT")
      .input("Tax_amount", sql.NVarChar, Tax_amount)
      .input("Putchase_amount", sql.NVarChar, Putchase_amount)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC [sp_ItemAmountCalculation] 'TOT',@company_code,0,'',0,0,'','','',0,'', @Tax_amount, @Putchase_amount,
            NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err.message);
    return res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};


const getSalesItemAmountCalculation = async (req, res) => {
  const { company_code, Item_SNO, Item_code, Weight, bill_qty, item_amt, measurements, tax_type_header, tax_name_details, tax_percentage, UnitWeight, keyfield, discount } = req.body;
  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();
    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "IAC")
      .input("company_code", sql.NVarChar, company_code)
      .input("Item_SNO", sql.BigInt, Item_SNO)
      .input("Item_code", sql.NVarChar, Item_code)
      .input("Weight", sql.Decimal(10, 2), Weight)
      .input("measurements", sql.NVarChar, measurements)
      .input("bill_qty", sql.Decimal(10, 2), bill_qty)
      .input("item_amt", sql.Decimal(10, 2), item_amt)
      .input("tax_type_header", sql.NVarChar, tax_type_header)
      .input("tax_name_details", sql.NVarChar, tax_name_details)
      .input("tax_percentage", sql.NVarChar, tax_percentage)
      .input("UnitWeight", sql.Decimal(8, 3), UnitWeight)
      .input("keyfield", sql.NVarChar, keyfield)
      .input("discount", sql.Decimal(5, 2), discount)
      .query(`EXEC sp_sale_ItemAmountCalculation @mode,@company_code,@Item_SNO,@Item_code,@bill_qty,@item_amt,@Weight,@tax_type_header,@tax_name_details,@tax_percentage,@UnitWeight,@keyfield,NULL,NULL,@discount,0,@measurements,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const SalesTotalAmountCalculation = async (req, res) => {
  const { Tax_amount, sale_amt, company_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "TOT")
      .input("Tax_amount", sql.NVarChar, Tax_amount)
      .input("sale_amt", sql.NVarChar, sale_amt)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_sale_ItemAmountCalculation @mode,@company_code,0 ,'',0,0,0,'','','',0,'',@Tax_amount,@sale_amt,0,0,
                          '',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const SalesreturnTotalAmountCalculation = async (req, res) => {
  const { Tax_amount, sale_amt, company_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "TOT")
      .input("Tax_amount", sql.NVarChar, Tax_amount)
      .input("sale_amt", sql.NVarChar, sale_amt)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_sale_ReturnItemAmountCalculation 'TOT',@company_code,0,'',0,0,'','','',0,@Tax_amount,@sale_amt,
                          NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};



const getPartyCode = async (req, res) => {
  const { company_code, vendor_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "VCS")
      .input("company_code", sql.NVarChar, company_code)
      .input("vendor_code", sql.NVarChar, vendor_code)
      .query(`EXEC sp_vendor_details_info_hdr @mode,@vendor_code,@company_code,'','','','','','','','','','' ,'','','','','','','',0,'','','','','','','','','',NULL,null,null,null,null,null,null,null`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const getcompanymappingsearchdata = async (req, res) => {
  const { company_code, user_code, company_no, location_no, status, } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("company_code", sql.NVarChar, company_code)
      .input("user_code", sql.NVarChar, user_code)
      .input("company_no", sql.NVarChar, company_no)
      .input("location_no", sql.NVarChar, location_no)
      .input("status", sql.NVarChar, status)

      .query(`EXEC sp_user_company_mapping @mode,@company_code,@user_code,@company_no,@location_no,@status,0,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err.message);
    return res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getattributeSearchdata = async (req, res) => {
  const { company_code, attributeheader_code, attributedetails_code, attributedetails_name, descriptions } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("company_code", sql.NVarChar, company_code)
      .input("attributeheader_code", sql.NVarChar, attributeheader_code)
      .input("attributedetails_code", sql.NVarChar, attributedetails_code)
      .input("attributedetails_name", sql.NVarChar, attributedetails_name)
      .input("descriptions", sql.NVarChar, descriptions)
      .query(`EXEC sp_attribute_Info 'SC',@company_code,@attributeheader_code,@attributedetails_code,@attributedetails_name,@descriptions,'','','','','','','','','',''
                `);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getintermediarySearchdata = async (req, res) => {
  const { company_code, Code, codeDetails, intermediary_addr_1, intermediary_area_code, intermediary_stat_code, intermediary_cnty_code, intermediary_imex_no, intermediary_office_no,
    intermediary_fax_no, intermediary_email_id } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("company_code", sql.NVarChar, company_code)
      .input("Code", sql.NVarChar, Code)
      .input("codeDetails", sql.NVarChar, codeDetails)
      .input("intermediary_addr_1", sql.NVarChar, intermediary_addr_1)
      .input("intermediary_area_code", sql.NVarChar, intermediary_area_code)
      .input("intermediary_stat_code", sql.NVarChar, intermediary_stat_code)
      .input("intermediary_cnty_code", sql.NVarChar, intermediary_cnty_code)
      .input("intermediary_imex_no", sql.NVarChar, intermediary_imex_no)
      .input("intermediary_office_no", sql.NVarChar, intermediary_office_no)
      .input("intermediary_fax_no", sql.NVarChar, intermediary_fax_no)
      .input("intermediary_email_id", sql.NVarChar, intermediary_email_id)
      .query(`EXEC sp_intermediary_details @mode,@company_code,@Code,@codeDetails,@intermediary_addr_1,'','','',@intermediary_area_code,@intermediary_stat_code,@intermediary_cnty_code,@intermediary_imex_no,@intermediary_office_no,'','',@intermediary_fax_no,@intermediary_email_id,'','',NULL,NULL,
								NULL,NULL,NULL,NULL,NULL,NULL`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err.message);
    return res.status(500).json({ message: err.message || 'Internal Server Error' });

  }
};

const addpurchasereturnheader = async (req, res) => {
  const {
    company_code, Entry_date, return_no, Return_date, return_reason, return_person, transaction_no,
    transaction_date, purchase_type, vendor_code, vendor_name, pay_type, purchase_amount_returne,
    add_fright, less_fright,
    tax_amount, tax_Persantage, rounded_off,
    loading_charges, cartage_paid, other_charges, lorry_no, broker_code, transport_code
    , total_amount, created_by, modified_by,
    tempstr1, tempstr2, tempstr3, tempstr4, datetime1, datetime2, datetime3, datetime4

  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("Entry_date", sql.Date, Entry_date)
      .input("return_no", sql.NVarChar, return_no)
      .input("Return_date", sql.Date, Return_date)
      .input("return_reason", sql.NVarChar, return_reason)
      .input("return_person", sql.NVarChar, return_person)
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("transaction_date", sql.Date, transaction_date)
      .input("purchase_type", sql.NVarChar, purchase_type)
      .input("vendor_code", sql.NVarChar, vendor_code)
      .input("vendor_name", sql.NVarChar, vendor_name)
      .input("pay_type", sql.NVarChar, pay_type)
      .input("purchase_amount_returne", sql.Decimal(14, 2), purchase_amount_returne)
      .input("add_fright", sql.Decimal(14, 2), add_fright)
      .input("less_fright", sql.Decimal(14, 2), less_fright)
      .input("tax_amount", sql.Decimal(14, 2), tax_amount)
      .input("tax_Persantage", sql.Decimal(14, 2), tax_Persantage)
      .input("rounded_off", sql.Decimal(14, 2), rounded_off)
      .input("loading_charges", sql.Decimal(14, 2), loading_charges)
      .input("cartage_paid", sql.Decimal(14, 2), cartage_paid)
      .input("other_charges", sql.Decimal(14, 2), other_charges)
      .input("lorry_no", sql.NVarChar, lorry_no)
      .input("broker_code", sql.NVarChar, broker_code)
      .input("transport_code", sql.NVarChar, transport_code)
      .input("total_amount", sql.Decimal(10, 2), total_amount)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(`EXEC sp_purchase_return_hdr @mode,@company_code,@Entry_date,@return_no,@Return_date,@return_reason,@return_person,@transaction_no,@transaction_date,
                  @purchase_type,@vendor_code,@vendor_name,@pay_type,@purchase_amount_returne,@add_fright,@less_fright,@tax_amount,@tax_Persantage,@rounded_off,@loading_charges,
                  @cartage_paid,@other_charges,@lorry_no,@broker_code,@transport_code,@total_amount,'','',
                  @created_by,@modified_by,@tempstr1,@tempstr2,@tempstr3,@tempstr4,@datetime1,@datetime2,@datetime3,@datetime4`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    if (err.class === 16 && err.number === 50000) {
      // Custom error from the stored procedure
      res.status(400).json({ message: err.message });
    } else {
      // Handle unexpected errors
      res.status(500).json({ message: err.message || 'Internal Server Error' });
    }
  }
};




const getAllpurchaseheaderreturnData = async (req, res) => {
  const { company_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "A")
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_purchase_return_hdr @mode,@company_code,'','','','','','','','','',
    '','',0,0,0,0,0,0,0,0,0,'','','',0,'','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err.message);
    return res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};


//PURCHASE ANALYSIS BETWEEN DATE //DHANA//JUNE27 2024
const getpurchasereport = async (req, res) => {
  const { mode, Fromdate, Todate, vendor_code, company_code, Type } = req.body;
  let pool;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, mode) // Insert mode
      .input("Fromdate", sql.Date, Fromdate)
      .input("Todate", sql.Date, Todate)
      .input("vendor_code", sql.NVarChar, vendor_code)
      .input("company_code", sql.NVarChar, company_code)
      .input("Type", sql.NVarChar, Type)
      .query(`EXEC sp_PurchaseAnalysis_Rpt @mode,@Fromdate,@Todate,@vendor_code,@company_code,@Type`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    }
    else res.status(404).json({ message: "Data not found" })
  } catch (err) {
    console.error("Error", err.message);
    return res.status(500).json({ message: err.message || 'Internal Server Error' });

  }
};


//SALES ANALYSIS BETWEEN DATE //DHANA//JUNE27 2024
const getsalesreport = async (req, res) => {
  const { mode, StartDate, EndDate, customer_code, company_code, type, pay_type, sales_mode } = req.body;
  let pool;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, mode) // Insert mode
      .input("StartDate", sql.Date, StartDate)
      .input("EndDate", sql.Date, EndDate)
      .input("customer_code", sql.NVarChar, customer_code)
      .input("company_code", sql.NVarChar, company_code)
      .input("type", sql.NVarChar, type)
      .input("pay_type", sql.NVarChar, pay_type)
      .input("sales_mode", sql.NVarChar, sales_mode)
      .query(`EXEC sp_SalesAnalysis_Rpt @mode,@StartDate,@EndDate,@customer_code,@company_code,@type,@pay_type,@sales_mode`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//SALES ANALYSIS LAST MONTH //DHANA//JUNE27 2024           
const getsalemonthreport = async (req, res) => {
  const { Months } = req.body;
  let pool;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "M") // Insert mode
      .input("Months", sql.Int, Months)
      .query(
        `EXEC sp_SalesAnalysis_Rpt @mode,'','','',@Months,
    null,null,null,null,null,null,null,null`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//SALES ANALYSIS GETTING ALL DATA//DHANA//JUNE27 2024 
const getallsalesreport = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`
        EXEC [sp_SalesAnalysis_Rpt] 'A','','','','',
        null,null,null,null,null,null,null,null
        `);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//SALES ANALYSIS DAILY WISE//DHANA//JUNE27 2024 
const getallsalereportdailywise = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`
EXEC [sp_SalesAnalysis_Rpt] 'DS','','','','',
null,null,null,null,null,null,null,null
`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//SALES ANALYSIS MONTHLY WISE//DHANA//JUNE27 2024 
const getallsalereportmonthlywise = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`
EXEC [sp_SalesAnalysis_Rpt] 'MS','','','','',
null,null,null,null,null,null,null,null
`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//SALES ANALYSIS YEARLY WISE//DHANA//JUNE27 2024 
const getallsalereportyearlywise = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`
EXEC [sp_SalesAnalysis_Rpt] 'YS','','','','',
null,null,null,null,null,null,null,null
`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
const gettaxSearchdata = async (req, res) => {
  const { company_code, tax_type_header, tax_name_details, tax_percentage, tax_shortname, tax_accountcode, transaction_type, status } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("company_code", sql.VarChar, company_code)
      .input("tax_type_header", sql.NVarChar, tax_type_header)
      .input("tax_name_details", sql.NVarChar, tax_name_details)
      .input("tax_percentage", sql.Decimal(14, 2), tax_percentage)
      .input("tax_shortname", sql.NVarChar, tax_shortname)
      .input("tax_accountcode", sql.NVarChar, tax_accountcode)
      .input("transaction_type", sql.NVarChar, transaction_type)
      .input("status", sql.NVarChar, status)
      .query(`EXEC sp_tax_name_details @mode,@company_code,@tax_type_header, @tax_name_details, @tax_percentage , @tax_shortname, @tax_accountcode, @transaction_type, @status,
                         NULL, NULL, NULL, NULL,'','','','','',''`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getAllsaleshdrData = async (req, res) => {
  const { company_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "A")
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_sales_hdr 'A',@company_code,'','','','','','',0,0,0,0,0,0,0,0,0,0,0,0,0,'','','','','','','','','','','',0,'','','','',0,0,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};





//Code added by Harish
const addsaleshdr = async (req, res) => {
  const {
    company_code, bill_date, bill_no, warehouse_code, sales_type, customer_code, sale_amt, net_amt, roff_amt, othr_amt, bill_amt, tax_amount, total_item, pay_type,  sman_code,
    payment_mode, customer_name, order_type, 
    sales_mode, paid_amount, return_amount, sales_order_no, created_by
  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("bill_date", sql.Date, bill_date)
      .input("bill_no", sql.NVarChar, bill_no)
      .input("warehouse_code", sql.NVarChar, warehouse_code)
      .input("sales_type", sql.NVarChar, sales_type)
      .input("customer_code", sql.NVarChar, customer_code)
      .input("sale_amt", sql.Decimal(14, 2), sale_amt)
      .input("net_amt", sql.Decimal(14, 2), net_amt)
      .input("roff_amt", sql.Decimal(14, 2), roff_amt)
      .input("othr_amt", sql.Decimal(14, 2), othr_amt)
      .input("bill_amt", sql.Decimal(14, 2), bill_amt)
      .input("tax_amount", sql.Decimal(14, 2), tax_amount)
      .input("total_item", sql.Int, total_item)
      .input("pay_type", sql.NVarChar, pay_type)
      .input("sman_code", sql.NVarChar, sman_code)
      .input("payment_mode", sql.NVarChar, payment_mode)
      .input("customer_name", sql.NVarChar, customer_name)
      .input("order_type", sql.NVarChar, order_type)
      .input("sales_mode", sql.VarChar, sales_mode)
      .input("paid_amount", sql.Decimal(14, 2), paid_amount)
      .input("return_amount", sql.Decimal(14, 2), return_amount)
      .input("sales_order_no", sql.NVarChar, sales_order_no)
      .input("created_by", sql.NVarChar, created_by)
      .query(`EXEC sp_sales_hdr_test @mode,@company_code,@bill_date,@bill_no,@warehouse_code,@sales_type,@customer_code,@sale_amt,@net_amt,@roff_amt,@othr_amt,@bill_amt,@tax_amount,@total_item,@pay_type,@sman_code,@payment_mode,@customer_name,
        @order_type,'','',@sales_mode,@paid_amount,@return_amount,@sales_order_no,@created_by,'',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json({ message: "Data not found" });
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const addsalesdetdetail = async (req, res) => {
  const {
    company_code,
    bill_date,
    bill_no,
    warehouse_code,
    customer_code,
    item_code,
    ItemSNo,
    item_name,
    bill_qty,
    bill_rate,
    item_amt,
    weight,
    total_weight,
    pay_type,
    sales_type,
    sman_code,
    customer_name,
    order_type,
    hsn,
    tax_amt,
    discount,
    discount_amount,
    created_by,
  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("bill_date", sql.Date, bill_date)
      .input("bill_no", sql.NVarChar, bill_no)
      .input("warehouse_code", sql.NVarChar, warehouse_code)
      .input("customer_code", sql.NVarChar, customer_code)
      .input("item_code", sql.NVarChar, item_code)
      .input("ItemSNo", sql.BigInt, ItemSNo)
      .input("item_name", sql.NVarChar, item_name)
      .input("bill_qty", sql.Decimal(10, 2), bill_qty)
      .input("bill_rate", sql.Decimal(10, 2), bill_rate)
      .input("item_amt", sql.Decimal(10, 2), item_amt)
      .input("weight", sql.Decimal(8, 3), weight)
      .input("total_weight", sql.Decimal(10, 2), total_weight)
      .input("pay_type", sql.NVarChar, pay_type)
      .input("sales_type", sql.NVarChar, sales_type)
      .input("sman_code", sql.NVarChar, sman_code)
      .input("customer_name", sql.NVarChar, customer_name)
      .input("order_type", sql.NVarChar, order_type)
      .input("hsn", sql.NVarChar, hsn)
      .input("tax_amt", sql.Decimal(14, 2), tax_amt)
      .input("discount", sql.Decimal(5, 2), discount)
      .input("discount_amount", sql.Decimal(14, 2), discount_amount)
      .input("created_by", sql.NVarChar, created_by)
      .query(
        `EXEC sp_sales_details @mode, @company_code,@bill_date,@bill_no,@warehouse_code,@customer_code,@item_code,@ItemSNo,@item_name,@bill_qty,
        @bill_rate,@item_amt,@weight,@total_weight,@pay_type,@sales_type,@sman_code,@customer_name,@order_type,@hsn,@tax_amt,'','',@discount,@discount_amount,@created_by,'',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.json({ success: true, message: "Data inserted successfully" });
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


// INVENTORY HEADER AND DETAILS CRUD API CALLING CODE ENDS //

//Code added by dhana      
const gettranstype = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'TRANSATION','','', '','','' , NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};




const getAllsalestaxdetData = async (req, res) => {
  const { company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "A")
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_sales_tax_details @mode,@company_code,'','','','',0,0,'','','','',0,0,'','','',''
	,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};



const addinventorytaxdetail = async (req, res) => {
  const {
    company_code, bill_date, bill_no, customer_code, pay_type, ItemSNo, TaxSNo, item_code, item_name, tax_type, tax_name_details, tax_amt, tax_per, tax_acode,
    created_by, modified_by,
    tempstr1, tempstr2, tempstr3, tempstr4, datetime1, datetime2, datetime3, datetime4,

  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("bill_date", sql.Date, bill_date)
      .input("bill_no", sql.NVarChar, bill_no)
      .input("customer_code", sql.NVarChar, customer_code)
      .input("pay_type", sql.NVarChar, pay_type)
      .input("ItemSNo", sql.BigInt, ItemSNo)
      .input("TaxSNo", sql.BigInt, TaxSNo)
      .input("item_code", sql.NVarChar, item_code)
      .input("item_name", sql.NVarChar, item_name)
      .input("tax_type", sql.NVarChar, tax_type)
      .input("tax_name_details", sql.NVarChar, tax_name_details)
      .input("tax_amt", sql.Decimal(14, 2), tax_amt)
      .input("tax_per", sql.Decimal(14, 2), tax_per)
      .input("tax_acode", sql.NVarChar, tax_acode)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(
        `EXEC sp_sales_tax_details @mode,@company_code,@bill_date,@bill_no,@customer_code,@pay_type,@ItemSNo,@TaxSNo,@item_code,@item_name,@tax_type,@tax_name_details,
              @tax_amt,@tax_per,@tax_acode,'',
              @created_by,@modified_by,
              @tempstr1,@tempstr2,@tempstr3,@tempstr4,@datetime1,@datetime2,@datetime3,@datetime4`);
    res.json({ success: true, message: "Data inserted successfully" });
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getAllSalesRetHdrData = async (req, res) => {
  const { company_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "A")
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_sales_return_hdr @mode,@company_code,'','','','','','','','','','',0,0,0,0,0,0,0,0,0,0,0,0,0,
                          '','','','','','','','','','','',0,0,0,'','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const addSalesRetHdr = async (req, res) => {
  const {
    company_code, bill_date, bill_no, return_date, return_no, return_reason, return_person, dely_chlno, warehouse_code, sales_type, customer_code, sale_amt, less_frit, less_disc, less_amt,
    net_amt, excs_amt, cess_amt, dely_amt, roff_amt, othr_amt, bill_amt, total_item, total_qty, pay_type, broker_code, tpot_code, sman_code, vehl_no, mark_name, payment_mode,
    customer_name, entry_no, roff_acccode, order_type, deli_charge, tax_amount, ref_no, created_by, modified_by,
    tempstr1, tempstr2, tempstr3, tempstr4, datetime1, datetime2, datetime3, datetime4,

  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("bill_date", sql.Date, bill_date)
      .input("bill_no", sql.NVarChar, bill_no)
      .input("return_date", sql.Date, return_date)
      .input("return_no", sql.NVarChar, return_no)
      .input("return_reason", sql.NVarChar, return_reason)
      .input("return_person", sql.NVarChar, return_person)
      .input("dely_chlno", sql.NVarChar, dely_chlno)
      .input("warehouse_code", sql.NVarChar, warehouse_code)
      .input("sales_type", sql.NVarChar, sales_type)
      .input("customer_code", sql.NVarChar, customer_code)
      .input("sale_amt", sql.Decimal(14, 2), sale_amt)
      .input("less_frit", sql.Decimal(14, 2), less_frit)
      .input("less_disc", sql.Decimal(14, 2), less_disc)
      .input("less_amt", sql.Decimal(14, 2), less_amt)
      .input("net_amt", sql.Decimal(14, 2), net_amt)
      .input("excs_amt", sql.Decimal(14, 2), excs_amt)
      .input("cess_amt", sql.Decimal(14, 2), cess_amt)
      .input("dely_amt", sql.Decimal(14, 2), dely_amt)
      .input("roff_amt", sql.Decimal(14, 2), roff_amt)
      .input("othr_amt", sql.Decimal(14, 2), othr_amt)
      .input("bill_amt", sql.Decimal(14, 2), bill_amt)
      .input("total_item", sql.Int, total_item)
      .input("total_qty", sql.Int, total_qty)
      .input("pay_type", sql.NVarChar, pay_type)
      .input("broker_code", sql.NVarChar, broker_code)
      .input("tpot_code", sql.NVarChar, tpot_code)
      .input("sman_code", sql.NVarChar, sman_code)
      .input("vehl_no", sql.NVarChar, vehl_no)
      .input("mark_name", sql.NVarChar, mark_name)
      .input("payment_mode", sql.NVarChar, payment_mode)
      .input("customer_name", sql.NVarChar, customer_name)
      .input("entry_no", sql.NVarChar, entry_no)
      .input("roff_acccode", sql.NVarChar, roff_acccode)
      .input("order_type", sql.NVarChar, order_type)
      .input("deli_charge", sql.Decimal(18, 0), deli_charge)
      .input("tax_amount", sql.Decimal(14, 2), tax_amount)
      .input("ref_no", sql.Decimal(14, 2), ref_no)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(
        `EXEC sp_sales_return_hdr @mode,@company_code,@bill_date,@bill_no,@return_date,@return_no,@return_reason,@return_person,@dely_chlno,@warehouse_code,@sales_type,	
                  @customer_code,@sale_amt,@less_frit,@less_disc,@less_amt,@net_amt,@excs_amt,@cess_amt,@dely_amt,@roff_amt,@othr_amt,@bill_amt,@total_item,
                  @total_qty,@pay_type,@broker_code,@tpot_code,@sman_code,@vehl_no,@mark_name,@payment_mode,@customer_name,@entry_no,@roff_acccode,@order_type,@deli_charge,
                  @tax_amount,@ref_no,'','',@created_by,@modified_by,@tempstr1,@tempstr2,@tempstr3,@tempstr4,@datetime1,@datetime2,@datetime3,@datetime4`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    if (err.class === 16 && err.number === 50000) {
      // Custom error from the stored procedure
      res.status(400).json({ message: err.message });
    } else {
      // Handle unexpected errors
      res.status(500).json({ message: err.message || "Internal Server Error" });
    }
  }
};



//NUMBERSERIES       

const getAllNumberseries = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`EXEC sp_numberseries 'A','','','','',0,0,0,'','','','','',
                         null,null,null,null,null,null,null,null,''`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


//ADD DATAS IN Intermediary  DETAILS  TABLE
const addNumberseries = async (req, res) => {
  const {
    company_code,
    Screen_Type,
    Start_Year,
    End_Year,
    Start_No,
    Running_No,
    End_No,
    comtext,
    number_prefix,
    status,
    created_by,
    modified_by,
    tempstr1,
    tempstr2,
    tempstr3,
    tempstr4,
    datetime1,
    datetime2,
    datetime3,
    datetime4,
  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("Screen_Type", sql.NVarChar, Screen_Type)
      .input("Start_Year", sql.Date, Start_Year)
      .input("End_Year", sql.Date, End_Year)
      .input("Start_No", sql.Int, Start_No)
      .input("Running_No", sql.Int, Running_No)
      .input("End_No", sql.Int, End_No)
      .input("comtext", sql.NVarChar, comtext)
      .input("number_prefix", sql.NVarChar, number_prefix)
      .input("Status", sql.NVarChar, status)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(
        `EXEC sp_numberseries @mode,@company_code,@Screen_Type,@Start_Year,@End_Year,@Start_No,@Running_No,@End_No,@comtext,@number_prefix,@Status,
                     @created_by,@modified_by, @tempstr1,@tempstr2,@tempstr3,@tempstr4,@datetime1,@datetime2,@datetime3,@datetime4,''`);

    // Return success response
    if (result.rowsAffected && result.rowsAffected[0] > 0) {
      return res.status(200).json({ success: true, message: 'Data inserted successfully' });
    }
  } catch (err) {
    if (err.class === 16 && err.number === 50000) {
      // Custom error from the stored procedure
      res.status(400).json({ message: err.message });
    } else {
      // Handle unexpected errors
      res.status(500).json({ message: err.message || 'Internal Server Error' });
    }
  }
};

const getnumberseriessearchdata = async (req, res) => {
  const { company_code, Screen_Type } = req.body; // Extract Screen_Type from req.body

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("company_code", sql.NVarChar, company_code)
      .input("Screen_Type", sql.NVarChar, Screen_Type) // Correct parameter name
      .query(`EXEC sp_numberseries @mode,@company_code,@Screen_Type,'','',0,0,0,'','','','','',
                         null,null,null,null,null,null,null,null,''`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const saveEditedNumberseriesData = async (req, res) => {
  const editedData = req.body.editedData;

  if (!editedData || !editedData.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase();

    for (const updatedRow of editedData) {
      await pool
        .request()
        .input("mode", sql.NVarChar, "U")
        .input("company_code", updatedRow.company_code)
        .input("Screen_Type", updatedRow.Screen_Type)
        .input("Start_Year", updatedRow.Start_Year)
        .input("End_Year", updatedRow.End_Year)
        .input("Start_No", updatedRow.Start_No)
        .input("Running_No", updatedRow.Running_No)
        .input("End_No", updatedRow.End_No)
        .input("comtext", updatedRow.comtext)
        .input("number_prefix", updatedRow.number_prefix)
        .input("Status", updatedRow.Status)
        .input("created_by", updatedRow.created_by)
        .input("modified_by", sql.NVarChar, req.headers['modified-by'])
        .input("tempstr1", updatedRow.tempstr1)
        .input("tempstr2", updatedRow.tempstr2)
        .input("tempstr3", updatedRow.tempstr3)
        .input("tempstr4", updatedRow.tempstr4)
        .input("datetime1", updatedRow.datetime1)
        .input("datetime2", updatedRow.datetime2)
        .input("datetime3", updatedRow.datetime3)
        .input("datetime4", updatedRow.datetime4)
        .query(`EXEC sp_numberseries @mode, @company_code,@Screen_Type, @Start_Year, @End_Year, @Start_No, @Running_No, @End_No,@comtext,@number_prefix,@Status,
                                @created_by,@modified_by,@tempstr1, @tempstr2, @tempstr3, @tempstr4, 
                              @datetime1, @datetime2, @datetime3, @datetime4,''`);
    }

    res.status(200).json("Edited data saved successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const refNumberToHeaderPrintData = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "PH")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_print @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
}


const refNumberToDetailPrintData = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool.request()
      .input("mode", sql.NVarChar, "PD")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_print @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    // Process result sets
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const refNumberToSumTax = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "PP")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_tax_Print @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};



const refNumberTosalesHeaderPrintData = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SH")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_print @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
}


const refNumberTosalesDetailPrintData = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool.request()
      .input("mode", sql.NVarChar, "SD")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_print @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    // Process result sets
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const refNumberTosalesSumTax = async (req, res) => {
  const { transaction_no, company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SP")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_tax_Print @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const getAllDashboardData = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "plb")
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_dashboard @mode,@company_code,0,0,0,'',''`);
    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getItemPrice = async (req, res) => {
  const { Item_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "GV")
      .input("Item_code", sql.NVarChar, Item_code)


      .query(`EXEC sp_item_brand_info @mode,'',@Item_code,'','',0,'','','',0,0,0,
                           0,'','','','','','','','','','','','','',0,0,'','','',NULL,NULL,NULL,NULL,NULL
						   ,NULL,NULL,NULL`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getProduct = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "PN")
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_itemcalculate_stock_value  @mode,'',@company_code`);
    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getPurchaseReturnItemAmountCalculation = async (req, res) => {
  const { Item_SNO, Item_code, return_qty, purchaser_amt, tax_type_header, tax_name_details, tax_percentage, UnitWeight } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "IAC")
      .input("Item_SNO", sql.BigInt, Item_SNO)
      .input("Item_code", sql.NVarChar, Item_code)
      .input("return_qty", sql.Decimal(10, 2), return_qty)
      .input("purchaser_amt", sql.Decimal(10, 2), purchaser_amt)
      .input("tax_type_header", sql.NVarChar, tax_type_header)
      .input("tax_name_details", sql.NVarChar, tax_name_details)
      .input("tax_percentage", sql.NVarChar, tax_percentage)
      .input("UnitWeight", sql.Decimal(8, 3), UnitWeight)
      .query(`EXEC [sp_returnItemAmountCalculation] 'IAC',@company_code,@Item_SNO,@Item_code,@return_qty,@purchaser_amt,@tax_type_header,@tax_name_details,@tax_percentage,@UnitWeight,'','',
                          NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

// Code by Harish kumar
const getSalesReturnItemAmountCalculation = async (req, res) => {
  const { Item_SNO, Item_code, Tax_amount, bill_rate, return_qty, item_amt, tax_type_header, tax_name_details, tax_percentage, UnitWeight } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "IAC")
      .input("Item_SNO", sql.BigInt, Item_SNO)
      .input("Item_code", sql.NVarChar, Item_code)
      .input("return_qty", sql.Decimal(10, 2), return_qty)
      .input("item_amt", sql.Decimal(10, 2), item_amt)
      .input("tax_type_header", sql.NVarChar, tax_type_header)
      .input("tax_name_details", sql.NVarChar, tax_name_details)
      .input("tax_percentage", sql.NVarChar, tax_percentage)
      .input("UnitWeight", sql.Decimal(8, 3), UnitWeight)
      .input("Tax_amount", sql.NVarChar, Tax_amount)
      .input("bill_rate", sql.NVarChar, bill_rate)
      .query(`EXEC [sp_sale_ReturnItemAmountCalculation] 'IAC','',@Item_SNO,@Item_code,@return_qty,@item_amt,@tax_type_header,@tax_name_details,@tax_percentage,@UnitWeight,@Tax_amount,@bill_rate,
                          NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

/* CODE ADDED BY PAVUN */
const getDashboardItemData = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "TIC")
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_dashboard @mode,@company_code,0,0,0,'',''`);
    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getDashboardStockData = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "TSV")
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_calculate_stock_value @mode,@company_code`
      );
    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getDashboardSaleYear = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`exec sp_GenerateSalesChart 'yw'`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getDashboardSaleMonth = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`exec sp_GenerateSalesChart 'mw'`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const getitemstockvalue = async (req, res) => {
  const { item_code, company_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input('mode', sql.NVarChar, 'ISV')
      .input('item_code', sql.NVarChar, item_code)
      .input('company_code', sql.NVarChar, company_code)
      .query(`EXEC sp_itemcalculate_stock_value @mode,@item_code,@company_code`);

    // Send response
    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const getAllItemVarient = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input('mode', sql.NVarChar, 'IV')
      .input('company_code', sql.NVarChar, company_code)
      .query(`EXEC sp_item_brand_info @mode,@company_code,'','','',0,'','','',0,0,0,
                           0,'','','','','','','','','','','','','',0,0,'','','',NULL,NULL,NULL,NULL,NULL
						   ,NULL,NULL,NULL`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//ITEM VARIENT NAME FOR DASHBOARD//DHANA//29JUNE2024
const getitemvairentname = async (req, res) => {
  const { Item_variant, company_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input('mode', sql.NVarChar, 'FIV')
      .input('Item_variant', sql.NVarChar, Item_variant)
      .input('company_code', sql.NVarChar, company_code)
      .query('EXEC sp_ItemVariantCounts @mode,@Item_variant,@company_code');

    // Send response
    if (result.recordset && result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json('Data not found'); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getAllUOM = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "UOM")
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_dashboard_item_uom @mode,'',@company_code`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getAlluomdetail = async (req, res) => {
  const { UOM, company_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "BUOM")
      .input("UOM", sql.NVarChar, UOM)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_dashboard_item_uom @mode,@UOM,@company_code`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//code added by harish kumar on 07/03/2024//
const getusercompany = async (req, res) => {
  const { user_code } = req.body;
  let pool;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "UCL") // Insert mode
      .input("user_code", sql.NVarChar, user_code)
      .query(
        `EXEC sp_user_company_mapping @mode,'',@user_code,'','','',0,'','','',
                              NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
// code ended by harishkumar  07/03/2024

const numberseriesdeleteData = async (req, res) => {
  const Screen_TypesToDelete = req.body.Screen_TypesToDelete;

  if (!Screen_TypesToDelete || !Screen_TypesToDelete.length) {
    res.status(400).json("Invalid or empty company_nos array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase();

    for (const updatedRow of Screen_TypesToDelete) {
      try {
        await pool.request()
          .input("Screen_Type", updatedRow.Screen_Type)
          .input("Start_Year", updatedRow.Start_Year)
          .input("End_Year", updatedRow.End_Year)
          .input("modified_by", sql.NVarChar, req.headers['modified-by'])
          .input("company_code", sql.NVarChar, req.headers['company_code'])
          .query(`EXEC sp_numberseries 'D',@company_code,@Screen_Type,@Start_Year,@End_Year,0,0,0,'','','','',@modified_by, null,null,null,null,null,null,null,null,''`);
      } catch (err) {
        if (err.number === 50000) {
          // Foreign key constraint violation
          res.status(400).json("The number series cannot be deleted due to a link with another record");
          return;
        } else {
          throw err; // Rethrow other SQL errors
        }
      }
    }

    res.status(200).json("Number series deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};



const getonlywarehsearchdata = async (req, res) => {
  const { company_code, warehouse_code, warehouse_name, status, location_no } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SCS")
      .input("company_code", sql.NVarChar, company_code)
      .input("warehouse_code", sql.NVarChar, warehouse_code)
      .input("warehouse_name", sql.NVarChar, warehouse_name)
      .input("status", sql.NVarChar, status)
      .input("location_no", sql.NVarChar, location_no)
      .query(` EXEC sp_warehouse_info @mode,@company_code,@warehouse_code,@warehouse_name,@status,@location_no,'','','','',NULL,NULL,NULL,NULL,'',''`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const updcompanymapping = async (req, res) => {
  const editedData = req.body.editedData;

  if (!editedData || !editedData.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase(dbConfig);

    for (const updatedRow of editedData) {
      await pool
        .request()
        .input("mode", sql.NVarChar, "U")
        .input("company_code", sql.NVarChar, req.headers['company_code'])
        .input("user_code", updatedRow.user_code)
        .input("company_no", updatedRow.company_no)
        .input("location_no", updatedRow.location_no)
        .input("status", updatedRow.status)
        .input("order_no", updatedRow.order_no)
        .input("keyfiels", updatedRow.keyfiels)
        .input("created_by", updatedRow.created_by)
        .input("modified_by", sql.NVarChar, req.headers['modified-by'])
        .input("tempstr1", updatedRow.tempstr1)
        .input("tempstr2", updatedRow.tempstr2)
        .input("tempstr3", updatedRow.tempstr3)
        .input("tempstr4", updatedRow.tempstr4)
        .input("datetime1", updatedRow.datetime1)
        .input("datetime2", updatedRow.datetime2)
        .input("datetime3", updatedRow.datetime3)
        .input("datetime4", updatedRow.datetime4)
        .query(`EXEC sp_user_company_mapping @mode, @company_code, @user_code, @company_no, @location_no, 
                                @status, @order_no,@keyfiels,@created_by,@modified_by,
                               @tempstr1, @tempstr2, @tempstr3, @tempstr4, 
                              @datetime1, @datetime2, @datetime3, @datetime4`);
    }

    res.status(200).json("Edited data saved successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const commappingdeleteData = async (req, res) => {
  const keyfielsToDelete = req.body.keyfiels;


  try {
    const pool = await connection.connectToDatabase();


    for (const keyfiels of keyfielsToDelete) {
      try {
        await pool.request()
          .input("keyfiels", keyfiels)
          .input("modified_by", sql.NVarChar, req.headers['modified-by'])
          .query(`EXEC sp_user_company_mapping 'D','','','','001','',0,@keyfiels,'','',
                                NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
      } catch (err) {
        if (err.number === 50000) {
          // Foreign key constraint violation
          res.status(400).json("The user rights cannot be deleted due to a link with another record");
          return;
        } else {
          throw err; // Rethrow other SQL errors
        }
      }
    }

    res.status(200).json("User and company mapping data deleted successfully");
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


// // code added by kathiravan arumugam on 07/04/2024 code begins//
//                       const   purdeletehdrData = async (req, res) => {
//                         const company_nosToDelete = req.body.company_nos;

//                         if (!company_nosToDelete || !company_nosToDelete.length) {
//                           res.status(400).json("Invalid or empty company_nos array.");
//                           return;
//                         }

//                         try {
//                           const pool = await connection.connectToDatabase();

//                           for (const company_no of company_nosToDelete) {
//                             try {
//                               await pool.request().input("company_no", company_no).query(`
//                                 EXEC sp_company_info 'D', @company_no, '', '', '', '', '', '', '', '', '', '', '', '','','', '', '', '', '', '', '', '', '', '', '', '', '', ''
//                               `);
//                             } catch (error) {
//                               if (error.number === 547) {
//                                 // Foreign key constraint violation
//                                 res.status(400).json("The company cannot be deleted due to an active foreign key constraint violation");
//                                 return;
//                               } else {
//                                 throw error; // Rethrow other SQL errors
//                               }
//                             }
//                           }

//                           res.status(200).json("Companies deleted successfully");
//                         } catch (error) {
//                           console.error(error);
//                           res.status(500).json({ message: err.message || 'Internal Server Error' });
//                         } finally {
//                           connection.closeDatabaseConnection();
//                         }
//                       };

//                       // code added by kathiravan arumugam on 07/04/2024 code ends//

//code added by harish kumr on 07/04/2024 code begins//
const getSalesTaxDetail = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "ST")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_getdata @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getSalesDetail = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SD")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_getdata @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getSalesData = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "S")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_getdata @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    if (result.recordsets && result.recordsets.length > 0 && result.recordsets[0].length > 0) {
      const data = {
        table1: result.recordsets[0],
        table2: result.recordsets[1] || [],
        table3: result.recordsets[2] || [],
        table4: result.recordsets[3] || []
      };
      res.status(200).json(data);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//code added by harish kum,ar on 07/04/2024 code ends//

//code added by pavun on 07/04/2024 code begins //
const getWarehouseCodeData = async (req, res) => {
  const { warehouse_code, company_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "WD")
      .input("warehouse_code", sql.NVarChar, warehouse_code)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_warehouse_info @mode, @company_code,@warehouse_code, '', '', '', '', '', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL`);

    // Check if result.recordset is defined and has length greater than 0
    if (result.recordset && result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//code added by pavun on 07/04/2024 code ends //

//USER SCREEN MAPPING 06/07/2024  DHANA//   

const getAlluserscreenmap = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`EXEC sp_rolescreen_mapping 'A','','','','','','','',
                                      null,null,null,null,null,null,null,null `);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};



const adduserscreenmap = async (req, res) => {
  const {
    company_code,
    role_id,
    screen_type,
    permission_type,
    created_by,
    modified_by,
    tempstr1,
    tempstr2,
    tempstr3,
    tempstr4,
    datetime1,
    datetime2,
    datetime3,
    datetime4,
  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("role_id", sql.VarChar, role_id)
      .input("screen_type", sql.NVarChar, screen_type)
      .input("permission_type", sql.VarChar, permission_type)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(
        `EXEC sp_rolescreen_mapping @mode, @company_code,@role_id, @screen_type,@permission_type,'',@created_by,'',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.json({ success: true, message: "Data inserted successfully" });
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//USER SCREEN MAPPING UPDATE 06/07/2024 DHANA//
const saveEditeduserscreenmap = async (req, res) => {
  const editedData = req.body.editedData;

  if (!editedData || !editedData.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase();

    for (const updatedRow of editedData) {
      await pool
        .request()
        .input("mode", sql.NVarChar, "U")
        .input("company_code", updatedRow.company_code)
        .input("role_id", updatedRow.role_id)
        .input("screen_type", updatedRow.screen_type)
        .input("permission_type", updatedRow.permission_type)
        .input("keyfield", updatedRow.keyfield)
        .input("modified_by", sql.NVarChar, req.headers['modified-by'])
        .input("tempstr1", updatedRow.tempstr1)
        .input("tempstr2", updatedRow.tempstr2)
        .input("tempstr3", updatedRow.tempstr3)
        .input("tempstr4", updatedRow.tempstr4)
        .input("datetime1", updatedRow.datetime1)
        .input("datetime2", updatedRow.datetime2)
        .input("datetime3", updatedRow.datetime3)
        .input("datetime4", updatedRow.datetime4)
        .query(`EXEC sp_rolescreen_mapping @mode,@company_code, @role_id, @screen_type, @permission_type, @keyfield,'', @modified_by,  
               @tempstr1, @tempstr2, @tempstr3, @tempstr4, 
              @datetime1, @datetime2, @datetime3, @datetime4`);
    }

    res.status(200).json("Edited data saved successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//USER SCREEN MAPPING DELETE 06/07/2024 DHANA//
const userscreenmapdeleteData = async (req, res) => {
  const keyfieldsToDelete = req.body.keyfield;

  // if (!keyfieldsToDelete || !keyfieldsToDelete.length) {
  //   res.status(400).json("Invalid or empty company_nos array.");
  //   return;
  // }

  try {
    const pool = await connection.connectToDatabase();

    for (const keyfield of keyfieldsToDelete) {
      try {
        await pool.request().input("keyfield", keyfield)
          .input("modified_by", sql.NVarChar, req.headers['modified-by'])
          .query(`EXEC sp_rolescreen_mapping 'D','','','','',@keyfield,'',@modified_by,null,null,null,null,null,null,null,null`);
      } catch (error) {
        if (error.number === 50000) {
          // Foreign key constraint violation
          res.status(400).json("The user rights cannot be deleted due to a link with another record");
          return;
        } else {
          throw error; // Rethrow other SQL errors
        }
      }
    }

    res.status(200).json("User screen mapping deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getuserscreensearchdata = async (req, res) => {
  const { company_code, role_id, screen_type, permission_type } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("company_code", sql.VarChar, company_code)
      .input("role_id", sql.VarChar, role_id)
      .input("screen_type", sql.NVarChar, screen_type)
      .input("permission_type", sql.NVarChar, permission_type)
      .query(`EXEC sp_rolescreen_mapping @mode,@company_code,@role_id,@screen_type,@permission_type,'','','',
null,null,null,null,null,null,null,null`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//DROPDOWN FOR USER SCREEN MAPPING 06/07/2024 DHANA    

const getScreens = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'Screens','',' ', ' ','','' , NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getPermissions = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'Permissions','',' ', ' ' , '','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const getAllSalesRetDetailData = async (req, res) => {
  const { company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "A")
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_sales_return_details @mode,@company_code,'','','','','','','','','','','',0,0,0,0,0,0,0,'','','','','','','','','','','','',0,0,0,'','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const addSalesRetDetail = async (req, res) => {
  const {
    company_code, bill_date, bill_no, return_date, return_no, return_reason, return_person, dely_chlno, warehouse_code,
    customer_code, item_code, item_name, bill_qty, return_qty, bill_rate, item_amt, weight, return_weight, total_weight, pay_type, sales_type, broker_code,
    tpot_code, sman_code, salesacc_code, stock_type, stock_code, entry_no, customer_name, order_type, hsn, return_amt, tax_amt, ItemSNo, created_by, modified_by, tempstr1,
    tempstr2, tempstr3, tempstr4, datetime1, datetime2, datetime3, datetime4

  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("bill_date", sql.Date, bill_date)
      .input("bill_no", sql.NVarChar, bill_no)
      .input("return_date", sql.Date, return_date)
      .input("return_no", sql.NVarChar, return_no)
      .input("return_reason", sql.NVarChar, return_reason)
      .input("return_person", sql.NVarChar, return_person)
      .input("dely_chlno", sql.NVarChar, dely_chlno)
      .input("warehouse_code", sql.NVarChar, warehouse_code)
      .input("customer_code", sql.NVarChar, customer_code)
      .input("item_code", sql.NVarChar, item_code)
      .input("item_name", sql.NVarChar, item_name)
      .input("bill_qty", sql.Decimal(10, 2), bill_qty)
      .input("return_qty", sql.Decimal(10, 2), return_qty)
      .input("bill_rate", sql.Decimal(10, 2), bill_rate)
      .input("item_amt", sql.Decimal(10, 2), item_amt)
      .input("weight", sql.Decimal(8, 3), weight)
      .input("return_weight", sql.Decimal(8, 3), return_weight)
      .input("total_weight", sql.Decimal(10, 2), total_weight)
      .input("pay_type", sql.NVarChar, pay_type)
      .input("sales_type", sql.NVarChar, sales_type)
      .input("broker_code", sql.NVarChar, broker_code)
      .input("tpot_code", sql.NVarChar, tpot_code)
      .input("sman_code", sql.NVarChar, sman_code)
      .input("salesacc_code", sql.NVarChar, salesacc_code)
      .input("stock_type", sql.NVarChar, stock_type)
      .input("stock_code", sql.NVarChar, stock_code)
      .input("entry_no", sql.NVarChar, entry_no)
      .input("customer_name", sql.NVarChar, customer_name)
      .input("order_type", sql.NVarChar, order_type)
      .input("hsn", sql.NVarChar, hsn)
      .input("return_amt", sql.Decimal(10, 2), return_amt)
      .input("tax_amt", sql.Decimal(14, 2), tax_amt)
      .input("ItemSNo", sql.BigInt, ItemSNo)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(
        `EXEC sp_sales_return_details @mode,@company_code,@bill_date,@bill_no,@return_date,@return_no,@return_reason,@return_person,@dely_chlno,@warehouse_code,
          @customer_code,@item_code,@item_name,@bill_qty,@return_qty,@bill_rate,@item_amt,@weight,@return_weight,
          @total_weight,@pay_type,@sales_type, @broker_code,@tpot_code,@sman_code,@salesacc_code,@stock_type,@stock_code,
          @entry_no,@customer_name,@order_type,@hsn,@return_amt,@tax_amt, @ItemSNo,'','', @created_by,@modified_by,@tempstr1,@tempstr2,@tempstr3,@tempstr4,@datetime1,@datetime2,@datetime3,@datetime4`);
    res.json({ success: true, message: "Data inserted successfully" });
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};



const getAllSalesRetTaxDetailData = async (req, res) => {
  const { company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "A")
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_sales_return_tax_details @mode,@company_code,'','','','','','','','',0,0,'','','','',0,0,'','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};




const addSalesRetTaxDetail = async (req, res) => {
  const {
    company_code, bill_date, bill_no, return_no, return_date, return_reason, return_person,
    customer_code, item_code, item_name, ItemSNo, TaxSNo, tax_type, tax_name_details, tax_amt, tax_per, tax_acode, pay_type,
    created_by, modified_by, tempstr1, tempstr2, tempstr3, tempstr4, datetime1, datetime2, datetime3, datetime4

  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("bill_date", sql.Date, bill_date)
      .input("bill_no", sql.NVarChar, bill_no)
      .input("return_no", sql.NVarChar, return_no)
      .input("return_date", sql.Date, return_date)
      .input("return_reason", sql.NVarChar, return_reason)
      .input("return_person", sql.NVarChar, return_person)
      .input("customer_code", sql.NVarChar, customer_code)
      .input("pay_type", sql.NVarChar, pay_type)
      .input("ItemSNo", sql.BigInt, ItemSNo)
      .input("TaxSNo", sql.BigInt, TaxSNo)
      .input("item_code", sql.NVarChar, item_code)
      .input("item_name", sql.NVarChar, item_name)
      .input("tax_type", sql.NVarChar, tax_type)
      .input("tax_name_details", sql.NVarChar, tax_name_details)
      .input("tax_amt", sql.Decimal(10, 2), tax_amt)
      .input("tax_per", sql.Decimal(10, 2), tax_per)
      .input("tax_acode", sql.NVarChar, tax_acode)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(
        `EXEC sp_sales_return_tax_details @mode,@company_code,@bill_date, @bill_no, @return_no, @return_date, @return_reason, @return_person,
@customer_code, @pay_type, @ItemSNo, @TaxSNo, @item_code,  @item_name, @tax_type, @tax_name_details, @tax_amt,
@tax_per, @tax_acode,'', @created_by, @modified_by, @tempstr1, @tempstr2, @tempstr3, @tempstr4, @datetime1, @datetime2, @datetime3, @datetime4
`);
    res.json({ success: true, message: "Data inserted successfully" });
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};



//CUSTOMER 06/07/2024  DHANA//   



const getAllcustomerhdr = async (req, res) => {
  const { company_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "A")
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_customer_info_hdr 'A',@company_code,'','','','','','','','',null,
                          null,null,null,null,null,null,null`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};




const addcustomerhdr = async (req, res) => {
  const {
    company_code,
    customer_code,
    customer_name,
    status,
    customer_logo,
    panno,
    customer_gst_no,
    created_by,
    modified_by,
    tempstr1,
    tempstr2,
    tempstr3,
    tempstr4,
    datetime1,
    datetime2,
    datetime3,
    datetime4
  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("customer_code", sql.NVarChar, customer_code)
      .input("customer_name", sql.NVarChar, customer_name)
      .input("status", sql.NVarChar, status)
      .input("customer_logo", sql.NVarChar, customer_logo)
      .input("panno", sql.NVarChar, panno)
      .input("customer_gst_no", sql.NVarChar, customer_gst_no)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(
        `EXEC sp_customer_info_hdr @mode,@company_code,@customer_code, @customer_name, @status,'',@panno,@customer_gst_no,@created_by,@modified_by,
                @tempstr1,@tempstr2,@tempstr3,@tempstr4,@datetime1,@datetime2,@datetime3,@datetime4`);
    // Return success response
    if (result.rowsAffected && result.rowsAffected[0] > 0) {
      return res.status(200).json({ success: true, message: 'Data inserted successfully' });
    }
  } catch (err) {
    if (err.class === 16 && err.number === 50000) {
      // Custom error from the stored procedure
      res.status(400).json({ message: err.message });
    } else {
      // Handle unexpected errors
      res.status(500).json({ message: err.message || 'Internal Server Error' });
    }
  }
};


// CUSTOMER DET INFO//
const getAllCustomerDetData = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`EXEC sp_customer_details_info 'A','','','','','','','','','','','','',
       '','','','','','','',0,'','','','','','','','','','',NULL,NULL,NULL,null,null,null,null,null`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const addCustomerDetData = async (req, res) => {
  const {
    customer_code,
    company_code,
    customer_addr_1,
    customer_addr_2,
    customer_addr_3,
    customer_addr_4,
    customer_area,
    customer_state,
    customer_country,
    customer_office_no,
    customer_resi_no,
    customer_mobile_no,
    customer_email_id,
    customer_credit_limit,
    customer_salesman_code,
    contact_person,
    office_type,
    default_customer,
    created_by,
    customer_name
  } = req.body;

  let pool;
  try {
    pool = await sql.connect(dbConfig);

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("customer_code", sql.VarChar, customer_code)
      .input("company_code", sql.NVarChar, company_code)
      .input("customer_name", sql.NVarChar, customer_name)
      .input("customer_addr_1", sql.VarChar, customer_addr_1)
      .input("customer_addr_2", sql.VarChar, customer_addr_2)
      .input("customer_addr_3", sql.VarChar, customer_addr_3)
      .input("customer_addr_4", sql.VarChar, customer_addr_4)
      .input("customer_area", sql.VarChar, customer_area)
      .input("customer_state", sql.VarChar, customer_state)
      .input("customer_country", sql.VarChar, customer_country)
      .input("customer_office_no", sql.NVarChar, customer_office_no)
      .input("customer_resi_no", sql.NVarChar, customer_resi_no)
      .input("customer_mobile_no", sql.NVarChar, customer_mobile_no)
      .input("customer_email_id", sql.NVarChar, customer_email_id)
      .input("customer_credit_limit", sql.Decimal(14, 3), customer_credit_limit)
      .input("customer_salesman_code", sql.NVarChar, customer_salesman_code)
      .input("contact_person", sql.NVarChar, contact_person)
      .input("office_type", sql.NVarChar, office_type)
      .input("default_customer", sql.NVarChar, default_customer)
      .input("created_by", sql.NVarChar, created_by)
      .query(
        `EXEC sp_customer_details_info_Test @mode,@customer_code,@company_code,@customer_name, '', '', '', @customer_addr_1, @customer_addr_2, @customer_addr_3, @customer_addr_4,@customer_area,
        @customer_state, @customer_country, @customer_office_no, @customer_resi_no, @customer_mobile_no,@customer_email_id, 
         @customer_credit_limit,@customer_salesman_code,@contact_person,@office_type,@default_customer,'',@created_by,'',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`
      );


    // Return success response
    if (result.rowsAffected && result.rowsAffected[0] > 0) {
      return res.status(200).json({ success: true, message: 'Data inserted successfully' });
    }
  } catch (err) {
    {
      // Handle unexpected errors
      res.status(500).json({ message: err.message || 'Internal Server Error' });
    }
  }
};

// CUSTOMER UPDATE 07/07/2024 DHANA //
const updcustomerdetData = async (req, res) => {
  const { customer_codesToUpdate, company_codesToUpdate, updatedData } = req.body;

  if (!customer_codesToUpdate || !customer_codesToUpdate.length ||
    !company_codesToUpdate || !company_codesToUpdate.length ||
    !updatedData || !updatedData.length) {
    return res.status(400).json("Invalid or empty input data.");
  }

  try {
    const pool = await connection.connectToDatabase();

    for (let i = 0; i < customer_codesToUpdate.length; i++) {
      const updatedRow = updatedData[i]; // Assuming updatedData is an array of objects with updated values

      await pool.request()
        .input("mode", sql.NVarChar, "U")
        .input("customer_code", customer_codesToUpdate[i])
        .input("company_code", company_codesToUpdate[i])
        .input("customer_name", sql.NVarChar, updatedRow.vendor_name)
        .input("status", sql.NVarChar, updatedRow.status)
        .input("panno", sql.NVarChar, updatedRow.panno)
        .input("customer_gst_no", sql.NVarChar, updatedRow.customer_gst_no)
        .input("customer_addr_1", sql.NVarChar, updatedRow.customer_addr_1)
        .input("customer_addr_2", sql.NVarChar, updatedRow.customer_addr_2)
        .input("customer_addr_3", sql.NVarChar, updatedRow.customer_addr_3)
        .input("customer_addr_4", sql.NVarChar, updatedRow.customer_addr_4)
        .input("customer_area", sql.NVarChar, updatedRow.customer_area)
        .input("customer_state", sql.NVarChar, updatedRow.customer_state)
        .input("customer_country", sql.NVarChar, updatedRow.customer_country)
        .input("customer_imex_no", sql.NVarChar, updatedRow.customer_imex_no)
        .input("customer_office_no", sql.NVarChar, updatedRow.customer_office_no)
        .input("customer_resi_no", sql.NVarChar, updatedRow.customer_resi_no)
        .input("customer_mobile_no", sql.NVarChar, updatedRow.customer_mobile_no)
        .input("customer_fax_no", sql.NVarChar, updatedRow.customer_fax_no)
        .input("customer_email_id", sql.NVarChar, updatedRow.customer_email_id)
        .input("customer_credit_limit", sql.Decimal(14, 3), updatedRow.customer_credit_limit)
        .input("customer_transport_code", sql.NVarChar, updatedRow.customer_transport_code)
        .input("customer_salesman_code", sql.NVarChar, updatedRow.customer_salesman_code)
        .input("customer_broker_code", sql.NVarChar, updatedRow.customer_broker_code)
        .input("customer_weekday_code", sql.NVarChar, updatedRow.customer_weekday_code)
        .input("contact_person", sql.NVarChar, updatedRow.contact_person)
        .input("office_type", sql.NVarChar, updatedRow.office_type)
        .input("default_customer", sql.NVarChar, updatedRow.default_customer)
        .input("keyfield", sql.NVarChar, updatedRow.keyfield)
        .input("created_by", sql.NVarChar, updatedRow.created_by)
        .input("modified_by", sql.NVarChar, req.headers['modified-by'])
        .input("tempstr1", sql.NVarChar, updatedRow.tempstr1)
        .input("tempstr2", sql.NVarChar, updatedRow.tempstr2)
        .input("tempstr3", sql.NVarChar, updatedRow.tempstr3)
        .input("tempstr4", sql.NVarChar, updatedRow.tempstr4)
        .input("datetime1", sql.NVarChar, updatedRow.datetime1)
        .input("datetime2", sql.NVarChar, updatedRow.datetime2)
        .input("datetime3", sql.NVarChar, updatedRow.datetime3)
        .input("datetime4", sql.NVarChar, updatedRow.datetime4)
        .query(
          `EXEC sp_customer_details_info @mode,@customer_code,@company_code,@customer_name,@status,@panno,@customer_gst_no,
            @customer_addr_1,@customer_addr_2,@customer_addr_3,@customer_addr_4,@customer_area,@customer_state ,@customer_country,
            @customer_imex_no,@customer_office_no,@customer_resi_no,@customer_mobile_no,@customer_fax_no,@customer_email_id,@customer_credit_limit,@customer_transport_code,
            @customer_salesman_code,@customer_broker_code,@customer_weekday_code,@contact_person,@office_type,@default_customer, @keyfield,@created_by, @modified_by, @tempstr1, @tempstr2, @tempstr3, @tempstr4, @datetime1,
            @datetime2, @datetime3, @datetime4`
        );
    }

    res.status(200).json("Updated data successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

// CUSTOMER SEARCH CRITERIA 07/07/2024 DHANA //
const customerSearchdata = async (req, res) => {
  const { company_code, customer_code, customer_name, panno, customer_gst_no, customer_addr_1, customer_area, customer_state, customer_country, customer_mobile_no, status, default_customer } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("company_code", sql.NVarChar, company_code)
      .input("customer_code", sql.NVarChar, customer_code)
      .input("customer_name", sql.NVarChar, customer_name)
      .input("status", sql.NVarChar, status)
      .input("panno", sql.NVarChar, panno)
      .input("customer_gst_no", sql.NVarChar, customer_gst_no)
      .input("customer_addr_1", sql.NVarChar, customer_addr_1)
      .input("customer_area", sql.NVarChar, customer_area)
      .input("customer_state", sql.NVarChar, customer_state)
      .input("customer_country", sql.NVarChar, customer_country)
      .input("customer_mobile_no", sql.NVarChar, customer_mobile_no)
      .input("default_customer", sql.NVarChar, default_customer)
      .query(`EXEC sp_customer_details_info @mode,@customer_code,@company_code,@customer_name,@status,@panno,@customer_gst_no,@customer_addr_1,'','','',@customer_area,@customer_state,
      @customer_country,'','','',@customer_mobile_no,'' ,'',0,'','','','','','',@default_customer,'','','',NULL,NULL,NULL,NULL,NULL,null,null,null`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};



const getcustomercode = async (req, res) => {
  const { company_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "F")
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_customer_info_hdr @mode,@company_code,'','','','','','','','',null,
                        null,null,null,null,null,null,null`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
// CUSTOMER DELETE 07/07/2024 DHANA //

const customerdeleteData = async (req, res) => {
  const { keyfieldsToDelete } = req.body;

  if (!keyfieldsToDelete || !keyfieldsToDelete.length) {
    res.status(400).json("Invalid or empty Codes or codeDetails array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase();

    const deleteQuery = `EXEC sp_customer_details_info 'D','',@company_code,'','','','','','','','','','' ,'','','','','','','',0,'','','','','','','',@keyfield,'',@modified_by,NULL,NULL,NULL,null,null,null,null,null
    `;
    for (let i = 0; i < keyfieldsToDelete.length; i++) {

      await pool.request()
        .input("keyfield", keyfieldsToDelete[i])
        .input("company_code", sql.NVarChar, req.headers['company-code'])
        .input("modified_by", sql.NVarChar, req.headers['modified-by'])
        .query(deleteQuery);
    }


    res.status(200).json("Customer data deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


//OPENING BALANCE 09/07/2024  DHANA//   

const getAllopenbalance = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`EXEC sp_openning_balance 'A','','','','','','',0,0,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};



const addopenbalance = async (req, res) => {
  const { company_code,
    transaction_date,
    transaction_type,
    transaction_no,
    acct_code,
    journal_no,
    debit,
    credit,
    created_by,
    modified_by,
    tempstr1,
    tempstr2,
    tempstr3,
    tempstr4,
    datetime1,
    datetime2,
    datetime3,
    datetime4,
  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("transaction_date", sql.NVarChar, transaction_date)
      .input("transaction_type", sql.NVarChar, transaction_type)
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("acct_code", sql.NVarChar, acct_code)
      .input("journal_no", sql.NVarChar, journal_no)
      .input("debit", sql.Decimal(14, 2), debit)
      .input("credit", sql.Decimal(14, 2), credit)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(
        `EXEC sp_openning_balance @mode,@company_code,@transaction_date,@transaction_type,@transaction_no,@acct_code,@journal_no,@debit,@credit,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Return success response
    if (result.rowsAffected && result.rowsAffected[0] > 0) {
      return res.status(200).json({ success: true, message: 'Data inserted successfully' });
    }
  } catch (err) {
    if (err.class === 16 && err.number === 50000) {
      // Custom error from the stored procedure
      res.status(400).json({ message: 'Opening balance already exists' });
    } else {
      // Handle unexpected errors
      res.status(500).json({ message: err.message || 'Internal Server Error' });
    }
  }
};

const openbalsaveEditedData = async (req, res) => {
  const editedData = req.body.editedData;

  if (!editedData || !editedData.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase(dbConfig);

    for (const updatedRow of editedData) {
      await pool
        .request()
        .input("mode", sql.NVarChar, "U") // update mode
        .input("company_code", sql.NVarChar, req.headers['company_code'])
        .input("transaction_date", sql.NVarChar, updatedRow.transaction_date)
        .input("transaction_type", sql.NVarChar, updatedRow.transaction_type)
        .input("transaction_no", sql.NVarChar, updatedRow.transaction_no)
        .input("acct_code", sql.NVarChar, updatedRow.acct_code)
        .input("journal_no", sql.NVarChar, updatedRow.journal_no)
        .input("debit", sql.Decimal(14, 2), updatedRow.debit)
        .input("credit", sql.Decimal(14, 2), updatedRow.credit)
        .input("created_by", sql.NVarChar, updatedRow.created_by)
        .input("modified_by", sql.NVarChar, req.headers['modified-by'])
        .input("tempstr1", sql.NVarChar, updatedRow.tempstr1)
        .input("tempstr2", sql.NVarChar, updatedRow.tempstr2)
        .input("tempstr3", sql.NVarChar, updatedRow.tempstr3)
        .input("tempstr4", sql.NVarChar, updatedRow.tempstr4)
        .input("datetime1", sql.NVarChar, updatedRow.datetime1)
        .input("datetime2", sql.NVarChar, updatedRow.datetime2)
        .input("datetime3", sql.NVarChar, updatedRow.datetime3)
        .input("datetime4", sql.NVarChar, updatedRow.datetime4)
        .query(
          `EXEC sp_openning_balance @mode,@company_code,@transaction_date,@transaction_type,@transaction_no,@acct_code,@journal_no,@debit,@credit,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`
        );
    }

    res.status(200).json("Edited data saved successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const openingbalancedeleteData = async (req, res) => {
  const journal_nosToDelete = req.body.journal_nos;

  if (!journal_nosToDelete || !journal_nosToDelete.length) {
    res.status(400).json("Invalid or empty journal_nos array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase();

    for (const journal_no of journal_nosToDelete) {
      try {
        await pool.request().input("journal_no", journal_no)
          .input("company_code", sql.NVarChar, req.headers['company_code'])
          .input("modified_by", sql.NVarChar, req.headers['modified-by'])
          .query(`EXEC sp_openning_balance 'D',@company_code,'','','','',@journal_no,0,0,'',@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
        `);
      } catch (error) {
        if (error.number === 50000) {
          // Foreign key constraint violation
          res.status(400).json("The opening balance cannot be deleted due to a link with another record");
          return;
        } else {
          throw error; // Rethrow other SQL errors
        }
      }
    }

    res.status(200).json("opening balance sheet deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getopeningbalanceSearchdata = async (req, res) => {
  const { company_code, transaction_date, transaction_type, transaction_no, acct_code, journal_no } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("company_code", sql.NVarChar, company_code)
      .input("transaction_date", sql.NVarChar, transaction_date)
      .input("transaction_type", sql.NVarChar, transaction_type)
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("acct_code", sql.NVarChar, acct_code)
      .input("journal_no", sql.NVarChar, journal_no)
      .query(` EXEC sp_openning_balance @mode,@company_code,@transaction_date,@transaction_type,@transaction_no,@acct_code,@journal_no,0,0,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//OPENING BALANCE 09/07/2024  DHANA// 
//ADJUSTMENT 10/07/2024  DHANA//   

const addadjustment = async (req, res) => {
  const { company_code,
    transaction_date,
    transaction_type,
    transaction_no,
    item_code,
    qty,
    created_by,
    modified_by,
    tempstr1,
    tempstr2,
    tempstr3,
    tempstr4,
    datetime1,
    datetime2,
    datetime3,
    datetime4
  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.Date, company_code)
      .input("transaction_date", sql.Date, transaction_date)
      .input("transaction_type", sql.NVarChar, transaction_type)
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("item_code", sql.NVarChar, item_code)
      .input("qty", sql.Decimal(10, 2), qty)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(
        `EXEC sp_item_adjustment @mode,@company_code,@transaction_date,@transaction_type,@transaction_no,@item_code,@qty,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    // Return success response
    if (result.rowsAffected && result.rowsAffected[0] > 0) {
      return res.status(200).json({ success: true, message: 'Data inserted successfully' });
    }
  } catch (error) {
    if (error.class === 16 && error.number === 50000) {
      // Custom error from the stored procedure
      res.status(400).json({ message: 'Adjustment already exists' });
    } else {
      // Handle unexpected errors
      res.status(500).json({ message: 'Internal Server Error', error: error.message });
    }
  }
};

const getadjustmentSearchdata = async (req, res) => {
  const { company_code, transaction_date, transaction_type, transaction_no, item_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("company_code", sql.NVarChar, company_code)
      .input("transaction_date", sql.NVarChar, transaction_date)
      .input("transaction_type", sql.NVarChar, transaction_type)
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("item_code", sql.NVarChar, item_code)
      .query(` EXEC sp_item_adjustment @mode,@company_code,@transaction_date,@transaction_type,@transaction_no,@item_code,0,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
    `);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//ADJUSTMENT UPDATE 06/07/2024 DHANA//
const updadjustmentData = async (req, res) => {
  const { transaction_datesToUpdate, transaction_nosToUpdate, updatedData } = req.body;

  if (!transaction_datesToUpdate || !transaction_datesToUpdate.length ||
    !transaction_nosToUpdate || !transaction_nosToUpdate.length ||
    !updatedData || !updatedData.length) {
    res.status(400).json("Invalid or empty input data.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase();

    for (let i = 0; i < transaction_datesToUpdate.length; i++) {
      const updatedRow = updatedData[i]; // Assuming updatedData is an array of objects with updated values

      await pool.request()
        .input("mode", sql.NVarChar, "U")
        .input("company_code", sql.NVarChar, req.headers['company_code'])
        .input("transaction_date", transaction_datesToUpdate[i])
        .input("transaction_no", transaction_nosToUpdate[i])
        .input("transaction_type", sql.NVarChar, updatedRow.transaction_type)
        .input("item_code", sql.NVarChar, updatedRow.item_code)
        .input("qty", sql.Decimal(14, 2), updatedRow.qty)
        .input("created_by", sql.NVarChar, updatedRow.created_by)
        .input("modified_by", sql.NVarChar, req.headers['modified-by'])
        .input("tempstr1", sql.NVarChar, updatedRow.tempstr1)
        .input("tempstr2", sql.NVarChar, updatedRow.tempstr2)
        .input("tempstr3", sql.NVarChar, updatedRow.tempstr3)
        .input("tempstr4", sql.NVarChar, updatedRow.tempstr4)
        .input("datetime1", sql.NVarChar, updatedRow.datetime1)
        .input("datetime2", sql.NVarChar, updatedRow.datetime2)
        .input("datetime3", sql.NVarChar, updatedRow.datetime3)
        .input("datetime4", sql.NVarChar, updatedRow.datetime4)
        .query(
          `EXEC sp_item_adjustment @mode,@company_code, @transaction_date, @transaction_no, @transaction_type, @item_code, @qty,@created_by,@modified_by, @tempstr1, @tempstr2, @tempstr3, @tempstr4, @datetime1, @datetime2, @datetime3, @datetime4`
        );
    }

    res.status(200).json("Updated data successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//ADJUSTMENT DELETE 06/07/2024 DHANA//
const deleteadjustmentData = async (req, res) => {
  const { transaction_datesToDelete, transaction_noToDelete } = req.body;

  if (!transaction_datesToDelete || !transaction_datesToDelete.length || !transaction_noToDelete || !transaction_noToDelete.length) {
    res.status(400).json("Invalid or empty Codes or codeDetails array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase();

    const deleteQuery = `EXEC sp_item_adjustment 'D',@company_code,@transaction_date,'', @transaction_no,'',0,'',@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
      `;
    for (let i = 0; i < transaction_datesToDelete.length; i++) {
      try {
        await pool.request()
          .input("transaction_date", transaction_datesToDelete[i])
          .input("transaction_no", transaction_noToDelete[i])
          .input("modified_by", sql.NVarChar, req.headers['modified-by'])
          .input("company_code", sql.NVarChar, req.headers['company_code'])
          .query(deleteQuery);
      } catch (error) {
        if (error.number === 50000) {
          // Foreign key constraint violation
          res.status(400).json("The Adjustment cannot be deleted due to a link with another record");
          return;
        } else {
          throw error; // Rethrow other SQL errors
        }
      }

    }

    res.status(200).json("Adjustment deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
const getitemcode = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "FI")
      .input("company_code", sql.NVarChar, company_code)
      .query("EXEC sp_item_adjustment @mode,@company_code,'','','','',0,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL");
    res.json(result.recordset);
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//CODE ADDED BY PAVUN 11/07/2024 BEGIN //
const refNumberToPurchaseReturnHeaderPrintData = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "PRH")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_print @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
}


const refNumberToPurchaseReturnDetailPrintData = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool.request()
      .input("mode", sql.NVarChar, "PRD")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_print @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    // Process result sets
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const refNumberToPurachseReturnSumTax = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "PR")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_tax_Print @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const refNumberToSalesReturnHeaderPrintData = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SRH")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_print @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
}


const refNumberToSalesReturnDetailPrintData = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool.request()
      .input("mode", sql.NVarChar, "SRD")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_print @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    // Process result sets
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const refNumberToSalesReturnSumTax = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SR")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_tax_Print @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getItemCodeSalesData = async (req, res) => {
  const { company_code, filter, code, Item_code, type } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "STIIC")
      .input("company_code", sql.NVarChar, company_code)
      .input("Item_code", sql.NVarChar, Item_code)
      .input("type", sql.NVarChar, type)
      .input("filter", sql.NVarChar, filter)
      .input("code", sql.NVarChar, code)
      .query(`EXEC sp_item_brand_info_TEST @mode,@company_code,@Item_code,'','',0,'','','',0,0,0,
          0,'','','','','','','','','','','','','',0,0,@type,@filter,@code,'','',NULL,NULL,NULL,NULL,NULL
    ,NULL,NULL,NULL `);
    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getCustomerCode = async (req, res) => {
  const { company_code, customer_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "CCS")
      .input("company_code", sql.NVarChar, company_code)
      .input("customer_code", sql.NVarChar, customer_code)
      .query(`EXEC sp_customer_details_info @mode,@customer_code,@company_code,'','','','','','','','','','','','','','','','','',0,
          '','','','','','','','','','',NULL,NULL,NULL,null,null,null,null,null`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const getCustomerSearchdata = async (req, res) => {
  const { customer_code, company_code, customer_name, status, panno, customer_gst_no, customer_addr_1, customer_addr_2, customer_addr_3,
    customer_addr_4, customer_area, customer_state, customer_country, customer_mobile_no, customer_resi_no, customer_office_no, customer_fax_no } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("customer_code", sql.NVarChar, customer_code)
      .input("company_code", sql.NVarChar, company_code)
      .input("customer_name", sql.NVarChar, customer_name)
      .input("status", sql.NVarChar, status)
      .input("panno", sql.NVarChar, panno)
      .input("customer_gst_no", sql.NVarChar, customer_gst_no)
      .input("customer_addr_1", sql.NVarChar, customer_addr_1)
      .input("customer_addr_2", sql.NVarChar, customer_addr_2)
      .input("customer_addr_3", sql.NVarChar, customer_addr_3)
      .input("customer_addr_4", sql.NVarChar, customer_addr_4)
      .input("customer_area", sql.NVarChar, customer_area)
      .input("customer_state", sql.NVarChar, customer_state)
      .input("customer_country", sql.NVarChar, customer_country)
      .input("customer_mobile_no", sql.NVarChar, customer_mobile_no)
      .input("customer_resi_no", sql.NVarChar, customer_resi_no)
      .input("customer_office_no", sql.NVarChar, customer_office_no)
      .input("customer_fax_no", sql.NVarChar, customer_fax_no)
      .query(`EXEC sp_customer_details_info @mode,@customer_code,@company_code,@customer_name,@status,@panno,@customer_gst_no,@customer_addr_1,@customer_addr_2,@customer_addr_3,@customer_addr_4,
          @customer_area,@customer_state,@customer_country,'','','',@customer_mobile_no,@customer_fax_no,'',0,'','','','','','','','','','',NULL,NULL,NULL,null,null,null,null,null`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};



//STOCKTRANSFER 10/07/2024  DHANA//   

const addstocktransferdetail = async (req, res) => {
  const {
    company_code,
    transaction_date,
    transaction_no,
    ItemSNo,
    item_code,
    Item_name,
    transfer_Qty,
    weight,
    total_weight,
    from_Warehouse,
    to_Warehouse,
    created_by,
    modified_by,
    tempstr1,
    tempstr2,
    tempstr3,
    tempstr4,
    datetime1,
    datetime2,
    datetime3,
    datetime4
  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("transaction_date", sql.Date, transaction_date)
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("ItemSNo", sql.BigInt, ItemSNo)
      .input("item_code", sql.NVarChar, item_code)
      .input("Item_name", sql.NVarChar, Item_name)
      .input("transfer_Qty", sql.Decimal(10, 2), transfer_Qty)
      .input("weight", sql.Decimal(8, 3), weight)
      .input("total_weight", sql.Decimal(10, 2), total_weight)
      .input("from_Warehouse", sql.NVarChar, from_Warehouse)
      .input("to_Warehouse", sql.NVarChar, to_Warehouse)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(
        `EXEC sp_stock_transfer_detail @mode,@company_code,@transaction_date,@transaction_no,@ItemSNo,@item_code,@Item_name,
    @transfer_Qty,@weight,@total_weight,@from_Warehouse,@to_Warehouse,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    // Return success response
    if (result.rowsAffected && result.rowsAffected[0] > 0) {
      return res.status(200).json({ success: true, message: 'Data inserted successfully' });
    }
  } catch (err) {
    // Check if the error is a primary key violation
    if (err.code === 'EREQUEST' && err.number === 2627) {
      return res.status(400).json({ success: false, message: 'This transation no stock already transfer or assigned' });
    } else {
      console.error('Error adding company  data:', err);
      return res.status(500).json({ success: false, message: 'Internal Server Error' });
    }
  }
};

const getstocktransferSearch = async (req, res) => {
  const { transaction_date, transaction_no, item_code, Item_name, from_Warehouse, to_Warehouse } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("transaction_date", sql.NVarChar, transaction_date)
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("item_code", sql.NVarChar, item_code)
      .input("Item_name", sql.NVarChar, Item_name)
      .input("from_Warehouse", sql.NVarChar, from_Warehouse)
      .input("to_Warehouse", sql.NVarChar, to_Warehouse)
      .query(` EXEC sp_stock_transfer_detail @mode,'',@transaction_date,@transaction_no,0,@item_code,@Item_name,0,0,0,@from_Warehouse,@to_Warehouse,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
    `);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//STOCKTRANSFER UPDATE 06/07/2024 DHANA//
const updstocktransfer = async (req, res) => {
  const { transaction_datesToUpdate, transaction_nosToUpdate, updatedData } = req.body;

  if (!transaction_datesToUpdate || !transaction_datesToUpdate.length ||
    !transaction_nosToUpdate || !transaction_nosToUpdate.length ||
    !updatedData || !updatedData.length) {
    res.status(400).json("Invalid or empty input data.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase();

    for (let i = 0; i < transaction_datesToUpdate.length; i++) {
      const updatedRow = updatedData[i]; // Assuming updatedData is an array of objects with updated values

      await pool.request()
        .input("mode", sql.NVarChar, "U")
        .input("company_code", sql.NVarChar, updatedRow.company_code)
        .input("transaction_date", transaction_datesToUpdate[i])
        .input("transaction_no", transaction_nosToUpdate[i])
        .input("ItemSNo", sql.BigInt, updatedRow.ItemSNo)
        .input("item_code", sql.NVarChar, updatedRow.item_code)
        .input("Item_name", sql.NVarChar, updatedRow.Item_name)
        .input("transfer_Qty", sql.Decimal(10, 2), updatedRow.transfer_Qty)
        .input("weight", sql.Decimal(8, 3), updatedRow.weight)
        .input("total_weight", sql.Decimal(10, 2), updatedRow.total_weight)
        .input("from_Warehouse", sql.NVarChar, updatedRow.from_Warehouse)
        .input("to_Warehouse", sql.NVarChar, updatedRow.to_Warehouse)
        .input("created_by", sql.NVarChar, updatedRow.created_by)
        .input("modified_by", sql.NVarChar, req.headers['modified-by'])
        .input("tempstr1", sql.NVarChar, updatedRow.tempstr1)
        .input("tempstr2", sql.NVarChar, updatedRow.tempstr2)
        .input("tempstr3", sql.NVarChar, updatedRow.tempstr3)
        .input("tempstr4", sql.NVarChar, updatedRow.tempstr4)
        .input("datetime1", sql.NVarChar, updatedRow.datetime1)
        .input("datetime2", sql.NVarChar, updatedRow.datetime2)
        .input("datetime3", sql.NVarChar, updatedRow.datetime3)
        .input("datetime4", sql.NVarChar, updatedRow.datetime4)
        .query(
          `EXEC sp_stock_transfer_detail @mode, @company_code,@transaction_date, @transaction_no, @ItemSNo, @item_code, @Item_name,@transfer_Qty,@weight,@total_weight,
            @from_Warehouse,@to_Warehouse, @created_by,@modified_by, @tempstr1, @tempstr2, @tempstr3, @tempstr4, @datetime1, @datetime2, @datetime3, @datetime4`
        );
    }

    res.status(200).json("Updated data successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//STOCKTRANSFER 10/07/2024  DHANA//   

const addstocktransferhdr = async (req, res) => {
  const {
    company_code,
    transaction_date,
    transaction_no,
    created_by,
    modified_by,
    tempstr1,
    tempstr2,
    tempstr3,
    tempstr4,
    datetime1,
    datetime2,
    datetime3,
    datetime4
  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("transaction_date", sql.Date, transaction_date)
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(
        `EXEC sp_stock_transfer_hdr @mode,@company_code,@transaction_date,@transaction_no,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    // Return success response
    if (result.recordset.length > 0) {
      return res.status(200).json(result.recordset);
    }
  } catch (err) {
    // Check if the error is a primary key violation
    if (err.code === 'EREQUEST' && err.number === 2627) {
      return res.status(400).json({ success: false, message: 'This transation no stock already transfer or assigned' });
    } else {
      console.error('Error adding company  data:', err);
      return res.status(500).json({ success: false, message: 'Internal Server Error' });
    }
  }
};



//JOURNAL 11/07/2024 DHANA//
const addjournal = async (req, res) => {
  const {
    company_code,
    transaction_date,
    transaction_type,
    transaction_no,
    journal_no,
    original_accountcode,
    contra_accountCode,
    journal_amount,
    narration1,
    narration2,
    narration3,
    narration4,
    created_by,
    modified_by,
    tempstr1,
    tempstr2,
    tempstr3,
    tempstr4,
    datetime1,
    datetime2,
    datetime3,
    datetime4,
  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("transaction_date", sql.Date, transaction_date)
      .input("transaction_type", sql.NVarChar, transaction_type)
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("journal_no", sql.NVarChar, journal_no)
      .input("original_accountcode", sql.NVarChar, original_accountcode)
      .input("contra_accountCode", sql.NVarChar, contra_accountCode)
      .input("journal_amount", sql.Decimal(14, 3), journal_amount)
      .input("narration1", sql.NVarChar, narration1)
      .input("narration2", sql.NVarChar, narration2)
      .input("narration3", sql.NVarChar, narration3)
      .input("narration4", sql.NVarChar, narration4)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(
        `EXEC sp_journal @mode,@company_code,@transaction_date,@transaction_type,@transaction_no,@journal_no,@original_accountcode,@contra_accountCode,@journal_amount,
    @narration1,@narration2,@narration3,@narration4,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.json({ success: true, message: "Data inserted successfully" });
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getjournalSearch = async (req, res) => {
  const { transaction_date, transaction_type, transaction_no, journal_no, original_accountcode, contra_accountCode } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("transaction_date", sql.NVarChar, transaction_date)
      .input("transaction_type", sql.NVarChar, transaction_type)
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("journal_no", sql.NVarChar, journal_no)
      .input("original_accountcode", sql.NVarChar, original_accountcode)
      .input("contra_accountCode", sql.NVarChar, contra_accountCode)
      .query(` EXEC sp_journal @mode,'',@transaction_date,@transaction_type,@transaction_no,@journal_no,@original_accountcode,@contra_accountCode,
          0,'','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
    `);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//CODE ADDED BY KATHIRAVAN ARUMUGAM FOR DELETE PURCHASE 
const purdeletehdrData = async (req, res) => {
  // const purch_autonosToDelete = req.body.purch_autonos;
  const { company_code, transaction_no, modified_by } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    try {
      await pool.request()
        .input("company_code", company_code)
        .input("transaction_no", transaction_no)
        .input("modified_by", modified_by)
        .query(`EXEC sp_purchase_hdr 'D',@company_code, '', @transaction_no, '', '', '','','',0,'',0,0,0,0,'',0,'',0,'',0,'',0,'','', '', '', '','','','', '', @modified_by, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL`);
    } catch (error) {
      if (error.number === 547) {
        // Foreign key constraint violation
        res.status(400).json("first delete the purchase details and tax details data");
        return;
      } else {
        throw error; // Rethrow other SQL errors
      }
    }

    res.status(200).json("purchase deleted successfully");
  } catch (err) {
    console.error("Error inserting data:", err);

    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};


//Code added By Pavun 15-07-2024
const saledeletehdrData = async (req, res) => {
  const { company_code, bill_no } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    try {
      await pool.request()
        .input("company_code", company_code)
        .input("bill_no", bill_no)
        .input("modified_by", sql.NVarChar, req.headers['modified-by'])
        .query(`EXEC sp_sales_hdr 'D',@company_code,'',@bill_no,'','','','',0,0,0,0,0,0,0,0,0,0,0,0,0,'','','','','','','','','','','',0,
'','','','','','',0,0,'',@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
        `);
    } catch (error) {
      if (error.number === 547) {
        // Foreign key constraint violation
        res.status(400).json("First Delete the Sales Details and Tax Details Data");
        return;
      } else {
        throw error; // Rethrow other SQL errors
      }
    }

    res.status(200).json("Sales deleted successfully");
  } catch (err) {
    console.error("Error inserting data:", err);

    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};

const saleDeleteDetailData = async (req, res) => {
  const { bill_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    try {

      await pool.request()
        .input("mode", sql.NVarChar, "D")
        .input("bill_no", bill_no)
        .input("company_code", company_code)
        .input("modified_by", sql.NVarChar, req.headers['modified-by'])
        .query(` EXEC sp_sales_details @mode,@company_code,'',@bill_no,'','','','',0,'',0,0,0,0,0,'','','','','','','','','','','','',0,'','',0,0,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    } catch (error) {
      if (error.number === 547) {
        // Foreign key constraint violation
        res.status(400).json("First Delete the Sales Details and Tax Details Data");
        return;
      } else {
        throw error; // Rethrow other SQL errors
      }
    }
    res.status(200).json("Sales Deleted Successfully");
  } catch (err) {
    console.error("Error inserting data:", err);

    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};

const saleDeleteTaxData = async (req, res) => {
  const { company_code, bill_no } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    try {
      await pool.request()
        .input("company_code", company_code)
        .input("bill_no", bill_no)
        .query(`EXEC sp_sales_tax_details'D',@company_code,'',@bill_no,'','',0,0,'','','','',0,0,'','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
          `);
    } catch (error) {
      if (error.number === 547) {
        // Foreign key constraint violation
        res.status(400).json("First Delete the Sales Details and Tax Details Data");
        return;
      } else {
        throw error; // Rethrow other SQL errors
      }
    }
    res.status(200).json("Sales deleted successfully");
  } catch (err) {
    console.error("Error inserting data:", err);

    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};
const getUserPermission = async (req, res) => {
  const { role_id } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "UP")
      .input("role_id", sql.NVarChar, role_id)
      .query(`EXEC sp_rolescreen_mapping @mode,'',@role_id,'','','','','',null,null,null,null,null,null,null,null
  `);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//JOURNAL UPDATE 12/07/2024 DHANA//
const saveEditjournal = async (req, res) => {
  const { transaction_datesToUpdate, journal_nosToUpdate, updatedData } = req.body;

  if (!transaction_datesToUpdate || !transaction_datesToUpdate.length ||
    !journal_nosToUpdate || !journal_nosToUpdate.length ||
    !updatedData || !updatedData.length) {
    res.status(400).json("Invalid or empty input data.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase();

    for (let i = 0; i < transaction_datesToUpdate.length; i++) {
      const updatedRow = updatedData[i]; // Assuming updatedData is an array of objects with updated values

      await pool.request()
        .input("mode", sql.NVarChar, "U")
        .input("company_code", updatedRow.company_code)
        .input("transaction_date", transaction_datesToUpdate[i])
        .input("transaction_type", updatedRow.transaction_type)
        .input("transaction_no", updatedRow.transaction_no)
        .input("journal_no", journal_nosToUpdate[i])
        .input("original_accountcode", updatedRow.original_accountcode)
        .input("contra_accountCode", updatedRow.contra_accountCode)
        .input("journal_amount", updatedRow.journal_amount)
        .input("narration1", updatedRow.narration1)
        .input("narration2", updatedRow.narration2)
        .input("narration3", updatedRow.narration3)
        .input("narration4", updatedRow.narration4)
        .input("created_by", updatedRow.created_by)
        .input("modified_by", sql.NVarChar, req.headers['modified-by'])
        .input("tempstr1", updatedRow.tempstr1)
        .input("tempstr2", updatedRow.tempstr2)
        .input("tempstr3", updatedRow.tempstr3)
        .input("tempstr4", updatedRow.tempstr4)
        .input("datetime1", updatedRow.datetime1)
        .input("datetime2", updatedRow.datetime2)
        .input("datetime3", updatedRow.datetime3)
        .input("datetime4", updatedRow.datetime4)
        .query(`EXEC sp_journal @mode,@company_code,@transaction_date,@transaction_type, @transaction_no,@journal_no, 
          @original_accountcode, @contra_accountCode,@journal_amount, @narration1, @narration2, @narration4,@narration4,
           @created_by, @modified_by,@tempstr1, @tempstr2, @tempstr3, @tempstr4, 
        @datetime1, @datetime2, @datetime3, @datetime4`);

    }

    res.status(200).json("Updated data successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//JOURNAL DELETE 12/07/2024 DHANA//
const deletejournal = async (req, res) => {
  const { transaction_datesToDelete, journal_noToDelete } = req.body;

  if (!transaction_datesToDelete || !transaction_datesToDelete.length || !journal_noToDelete || !journal_noToDelete.length) {
    res.status(400).json("Invalid or empty Codes or codeDetails array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase();

    const deleteQuery = `EXEC sp_journal 'D','',@transaction_date,'','', @journal_no,'','',0,'','','','','',@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
`;
    for (let i = 0; i < transaction_datesToDelete.length; i++) {
      await pool.request()
        .input("transaction_date", transaction_datesToDelete[i])
        .input("journal_no", journal_noToDelete[i])
        .input("modified_by", sql.NVarChar, req.headers['modified-by'])
        .query(deleteQuery);
    }

    res.status(200).json("Intermediary data deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//DROP DOWN FOR JOURNAL SCREEN//
const getwarehousecode = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(
      "EXEC [sp_journal] 'F','','','','','','','',0,'','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
    );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const getPurchaseAnalysisChart = async (req, res) => {
  const { mode, StartDate, EndDate, company_code, Type } = req.body;
  let pool;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, mode) // Insert mode
      .input("StartDate", sql.NVarChar, StartDate)
      .input("EndDate", sql.NVarChar, EndDate)
      .input("company_code", sql.NVarChar, company_code)
      .input("type", sql.NVarChar, Type)
      .query(`EXEC sp_purchase_chart @mode,@StartDate,@EndDate,@company_code,@type`);
    if (result.recordset && Array.isArray(result.recordset) && result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    }
    else {
      // Send a 404 Not Found status if no data is found
      res.status(404).json('No data found');
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


// sakthi coded sales analysis chart

// const getSalesAnalysisL3MS = async (req, res) => {
//   try {
//     await connection.connectToDatabase();
//     const result = await sql.query(`EXEC sp_sales_chart '1','',''`);

//     res.json(result.recordset);
//   } catch (err) {
//     console.error(err);
//     res.status(500).json({ message: err.message || 'Internal Server Error' });
//   }
// };


// const getSalesAnalysisLYS = async (req, res) => {
//   try {
//     await connection.connectToDatabase();
//     const result = await sql.query(`EXEC sp_sales_chart '4','',''`);

//     res.json(result.recordset);
//   } catch (err) {
//     console.error(err);
//     res.status(500).json({ message: err.message || 'Internal Server Error' });
//   }
// };

// const getSalesAnalysisCFYS = async (req, res) => {
//   try {
//     await connection.connectToDatabase();
//     const result = await sql.query(`EXEC sp_sales_chart '5','',''`);

//     res.json(result.recordset);
//   } catch (err) {
//     console.error(err);
//     res.status(500).json({ message: err.message || 'Internal Server Error' });
//   }
// };

// const getSalesAnalysisLMS = async (req, res) => {
//   try {
//     await connection.connectToDatabase();
//     const result = await sql.query(`EXEC sp_sales_chart '6','',''`);

//     res.json(result.recordset);
//   } catch (err) {
//     console.error(err);
//     res.status(500).json({ message: err.message || 'Internal Server Error' });
//   }
// };

// const getSalesAnalysisCMS = async (req, res) => {
//   try {
//     await connection.connectToDatabase();
//     const result = await sql.query(`EXEC sp_sales_chart '7','',''`);

//     res.json(result.recordset);
//   } catch (err) {
//     console.error(err);
//     res.status(500).json({ message: err.message || 'Internal Server Error' });
//   }
// };

// const getSalesAnalysisLWS = async (req, res) => {
//   try {
//     await connection.connectToDatabase();
//     const result = await sql.query(`EXEC sp_sales_chart '9','',''`);

//     res.json(result.recordset);
//   } catch (err) {
//     console.error(err);
//     res.status(500).json({ message: err.message || 'Internal Server Error' });
//   }
// };

// const getSalesAnalysisTDS = async (req, res) => {
//   try {
//     await connection.connectToDatabase();
//     const result = await sql.query(`EXEC sp_sales_chart '10','',''`);

//     res.json(result.recordset);
//   } catch (err) {
//     console.error(err);
//     res.status(500).json({ message: err.message || 'Internal Server Error' });
//   }
// };

const getSalesAnalysisChart = async (req, res) => {
  const { mode, StartDate, EndDate, company_code, type } = req.body;
  let pool;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, mode) // Insert mode
      .input("StartDate", sql.NVarChar, StartDate)
      .input("EndDate", sql.NVarChar, EndDate)
      .input("company_code", sql.NVarChar, company_code)
      .input("type", sql.NVarChar, type)
      .query(`EXEC sp_sales_chart @mode,@StartDate,@EndDate,@company_code,@type`);
    if (result.recordset && Array.isArray(result.recordset) && result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    }
    else {
      // Send a 404 Not Found status if no data is found
      res.status(404).json('No data found');
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

///test from kathir on 18-07-2024
const facereg = async (req, res) => {
  try {
    const pool = await connection.connectToDatabase();
    const user_code = req.params.user_code;

    const result = await pool.request()
      .input('user_code', sql.VarChar, user_code)
      .query('SELECT user_image FROM tbl_face_recognition WHERE user_code = @user_code');

    if (result.recordset.length > 0 && result.recordset[0].user_image) {
      const imageData = result.recordset[0].user_image;

      // Convert binary image data to Base64
      const base64Image = Buffer.from(imageData).toString('base64');
      const imageSrc = `data:image/jpeg;base64,${base64Image}`; // Adjust content type based on your image type

      res.json({ imageSrc });
    } else {
      res.status(404).json({ message: 'Image not found' });
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const purDeleteDetailData = async (req, res) => {
  const { company_code, transaction_no } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    try {
      await pool.request()
        .input("transaction_no", transaction_no)
        .input("company_code", company_code)
        .query(`
     EXEC sp_purchase_details 'D',@company_code,'',@transaction_no,'','',0,'','',0,0,0,0,0,'','','','','','','',0,'','','','',
NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
        `);
    } catch (error) {
      if (error.number === 547) {
        // Foreign key constraint violation
        res.status(400).json("first delete the purchase details and tax details data");
        return;
      } else {
        throw error; // Rethrow other SQL errors
      }
    }
    res.status(200).json("purchase deleted successfully");
  } catch (err) {
    console.error("Error inserting data:", err);

    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};

const purDeleteTaxData = async (req, res) => {
  const { company_code, transaction_no } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    try {
      await pool.request()
        .input("company_code", company_code)
        .input("transaction_no", transaction_no)
        .query(`
      EXEC sp_purchase_tax_details 'D',@company_code,'',@transaction_no,'','',0,0,'','','','',0,0,'','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    } catch (error) {
      if (error.number === 547) {
        // Foreign key constraint violation
        res.status(400).json("first delete the purchase details and tax details data");
        return;
      } else {
        throw error; // Rethrow other SQL errors
      }
    }
    res.status(200).json("purchase deleted successfully");
  } catch (err) {
    console.error("Error inserting data:", err);

    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};


//Code added by harish on 18-07-2024 
const getPurchaseDeleteDetails = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "PDD")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_getdata @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Check if data is found
    if (result.recordsets && result.recordsets.length > 0 && result.recordsets[0].length > 0) {
      const data = {
        table1: result.recordsets[0],
        table2: result.recordsets[1] || [], // Provide an empty array if no data
        table3: result.recordsets[2] || []  // Provide an empty array if no data
      };
      res.status(200).json(data); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};





///test from kathir on 18-07-2024




const purdeletedunit = async (req, res) => {
  const { transaction_no } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "DPD")
      .input("transaction_no", sql.NVarChar, transaction_no)

      // .input("status", sql.NVarChar, status)
      .query(`EXEC sp_getdata @mode,@transaction_no,'',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};



const purdeletedtax = async (req, res) => {
  const { transaction_no } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "DPT")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .query(`EXEC sp_getdata @mode,@transaction_no,'',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

//Code Ended by harish on 18-07-2024



//Code added By harish 23-07-2024
const getRefSalesDelete = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SDD")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_getdata @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    if (result.recordsets && result.recordsets.length > 0 && result.recordsets[0].length > 0) {
      const data = {
        table1: result.recordsets[0],
        table2: result.recordsets[1] || [],
        table3: result.recordsets[2] || [],
        table4: result.recordsets[3] || []
      };
      res.status(200).json(data);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const getsalesdelsearchdata = async (req, res) => {
  const { company_code, bill_date, bill_no, sales_type, customer_code, customer_name, pay_type, order_type } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SCD")
      .input("company_code", sql.NVarChar, company_code)
      .input("bill_date", sql.NVarChar, bill_date)
      .input("bill_no", sql.NVarChar, bill_no)
      .input("sales_type", sql.NVarChar, sales_type)
      .input("customer_code", sql.NVarChar, customer_code)
      .input("customer_name", sql.NVarChar, customer_name)
      .input("pay_type", sql.NVarChar, pay_type)
      .input("order_type", sql.NVarChar, order_type)
      .query(`EXEC sp_sales_hdr @mode,@company_code,@bill_date,@bill_no,'','',@sales_type,@customer_code,
              0,0,0,0,0,0,0,0,0,0,0,0,0,@pay_type,'','','','','','',
              @customer_name,'','',@order_type,0,'','','','','','',0,0,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Send response
    if (result.recordset && Array.isArray(result.recordset) && result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error(err);
    res.status(500).json(err.message || "Internal Server Error");
  }
};

const saledelsearchitem = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "DSD")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_getdata @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};



const salesdelsearchtax = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "DST")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_getdata  @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};


//code added by pavun 29-07-2024

const getDashboardPurchase = async (req, res) => {
  const { mode, StartDate, EndDate, company_code } = req.body;
  let pool;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, mode) // Insert mode
      .input("StartDate", sql.NVarChar, StartDate)
      .input("EndDate", sql.NVarChar, EndDate)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_dashboard_purchase_chart @mode,@StartDate,@EndDate,@company_code`);
    if (result.recordset && Array.isArray(result.recordset) && result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    }
    else {
      res.status(404).json('No data found');
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


//code added by pavun 30-07-2024
const getDashboardSales = async (req, res) => {
  const { mode, StartDate, EndDate, company_code } = req.body;
  let pool;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, mode) // Insert mode
      .input("StartDate", sql.NVarChar, StartDate)
      .input("EndDate", sql.NVarChar, EndDate)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_dashboard_sales_chart @mode,@StartDate,@EndDate,@company_code`);
    if (result.recordset && Array.isArray(result.recordset) && result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    }
    else {
      // Send a 404 Not Found status if no data is found
      res.status(404).json('No data found');
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const getDashboardItemSales = async (req, res) => {
  const { mode, StartDate, EndDate, company_code } = req.body;
  let pool;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, mode) // Insert mode
      .input("StartDate", sql.NVarChar, StartDate)
      .input("EndDate", sql.NVarChar, EndDate)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_dashboard_itemsales_chart @mode,@StartDate,@EndDate,@company_code`);
    if (result.recordset && Array.isArray(result.recordset) && result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    }
    else {
      res.status(404).json('No data found');
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


//code added by harish 31/07/2024//
const getStockKey = async (req, res) => {
  const { transaction_no } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "ST")
      .input("transaction_no", sql.Int, transaction_no)
      .query(`EXEC [sp_stock_transfer_hdr] @mode,'','',@transaction_no,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
`);

    // Check if data is found
    if (result.recordsets && result.recordsets.length > 0 && result.recordsets[0].length > 0) {
      const data = {
        table1: result.recordsets[0],
        table2: result.recordsets[1] || [], // Provide an empty array if no data
      };
      res.status(200).json(data); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const StockTransferDetail = async (req, res) => {
  const { transaction_no } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "STP")
      .input("transaction_no", sql.Int, transaction_no)

      // .input("status", sql.NVarChar, status)
      .query(`EXEC [sp_stock_transfer_detail] @mode,'','',@transaction_no,0,'','',0,0,0,'','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
 `);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

// Code Started  by Harish kumar
const StockTransferItemAmountCalculation = async (req, res) => {
  const { transfer_Qty, weight } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "TWC")
      .input("transfer_Qty", sql.Decimal(10, 2), transfer_Qty)
      .input("weight", sql.Decimal(8, 3), weight)

      .query(`EXEC [sp_stock_transfer_detail] @mode,'','','',0,'','',@transfer_Qty,@weight,0,'','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//code ended by Harish Kumar

//STOCKTRANSFER DELETE 06/07/2024 DHANA//
const deletestocktransferhdr = async (req, res) => {
  const { transaction_no } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    await pool.request()
      .input("transaction_no", transaction_no)
      .input("modified_by", sql.NVarChar, req.headers['modified-by'])
      .query(`EXEC [sp_stock_transfer_hdr]  'D','','',@transaction_no,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);


    res.status(200).json("Stock Transfer data deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//STOCKTRANSFER DELETE 06/07/2024 Harish//
const deletestocktransfer = async (req, res) => {
  const { transaction_no, transaction_date } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    {
      await pool.request()
        .input("transaction_date", transaction_date)
        .input("transaction_no", transaction_no)
        .input("modified_by", sql.NVarChar, req.headers['modified-by'])
        .query(`EXEC sp_stock_transfer_detail 'D','',@transaction_date, @transaction_no,0,'','',0,0,0,'','','',@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    }

    res.status(200).json("Stock Transfer data deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const refNumberToStockDetailPrintData = async (req, res) => {
  const { transaction_no } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool.request()
      .input("mode", sql.NVarChar, "STDP")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .query(`EXEC sp_stock_transfer_detail 'STDP','','', @transaction_no,0,'','',0,0,0,'','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    // Process result sets
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//code Added by Harish (02/08/2024)

const addBaseaccountData = async (req, res) => {
  const {
    base_accgroup_name, base_accgroup_code, status, deletePermission, created_by, modified_by,
    tempstr1, tempstr2, tempstr3, tempstr4, datetime1, datetime2, datetime3, datetime4,
  } = req.body;

  let pool;
  try {
    pool = await sql.connect(dbConfig);



    // If the company code doesn't exist, proceed with inserting the data
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("base_accgroup_code", sql.NVarChar, base_accgroup_code)
      .input("base_accgroup_name", sql.NVarChar, base_accgroup_name)
      .input("status", sql.NVarChar, status)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(
        `EXEC sp_Base_Account_group @mode,@base_accgroup_code,@base_accgroup_name,@status,@created_by,@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`

      );

    // Return success response
    if (result.rowsAffected && result.rowsAffected[0] > 0) {
      return res.status(200).json({ success: true, message: 'Data inserted successfully' });
    }
  } catch (error) {
    if (error.class === 16 && error.number === 50000) {
      // Custom error from the stored procedure
      res.status(400).json({ message: 'Base Account code already exists' });
    } else {
      // Handle unexpected errors
      res.status(500).json({ message: 'Internal Server Error', error: error.message });
    }
  }
};
//code Ended by Harish (02/08/2024)

//code Added by Harish (02/08/2024)
const getAllBaseAccountData = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`EXEC sp_Base_Account_group 'A','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    res.json(result.recordset);
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getsearchdataBase = async (req, res) => {
  const { base_accgroup_code, base_accgroup_name, status } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("base_accgroup_code", sql.NVarChar, base_accgroup_code)
      .input("base_accgroup_name", sql.NVarChar, base_accgroup_name)
      .input("status", sql.NVarChar, status)

      .query(` EXEC [sp_Base_Account_group] @mode,@base_accgroup_code,@base_accgroup_name,@status,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//code Ended by Harish (02/08/2024)

//code Added by Harish (02/08/2024)
const updateBase = async (req, res) => {
  const editedData = req.body.editedData;

  if (!editedData || !editedData.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase();

    for (const updatedRow of editedData) {
      await pool
        .request()
        .input("mode", sql.NVarChar, "U")
        .input("base_accgroup_code", updatedRow.base_accgroup_code)
        .input("base_accgroup_name", updatedRow.base_accgroup_name)
        .input("status", updatedRow.status)
        .input("created_by", updatedRow.created_by)
        .input("modified_by", sql.NVarChar, req.headers['modified-by'])
        .input("tempstr1", updatedRow.tempstr1)
        .input("tempstr2", updatedRow.tempstr2)
        .input("tempstr3", updatedRow.tempstr3)
        .input("tempstr4", updatedRow.tempstr4)
        .input("datetime1", updatedRow.datetime1)
        .input("datetime2", updatedRow.datetime2)
        .input("datetime3", updatedRow.datetime3)
        .input("datetime4", updatedRow.datetime4)
        .query(`EXEC sp_Base_Account_group @mode, @base_accgroup_code, @base_accgroup_name, @status,  @created_by , @modified_by,
           @tempstr1, @tempstr2, @tempstr3, @tempstr4, 
          @datetime1, @datetime2, @datetime3, @datetime4`);
    }

    res.status(200).json("Edited data saved successfully");
  } catch (error) {
    if (error.class === 16 && error.number === 50000) {
      // Custom error from the stored procedure
      res.status(400).json({ message: error.message });
    } else {
      // Handle unexpected errors
      res.status(500).json({ message: 'Internal Server Error', error: error.message });
    }
  }
};
//code ended by Harish (02/08/2024)

//  //DeleteBaseData DELETE 02/08/2024 Harish//
//  const deleteBaseData = async (req, res) => {
//   const { base_accgroup_code ,base_accgroup_name,status	} = req.body;

//   try {
//     const pool = await connection.connectToDatabase();
// {
//       await pool.request()
//                 .input("base_accgroup_code", base_accgroup_code	)
//                 .input("base_accgroup_code", base_accgroup_name	)
//                 .input("status",                    status)
//                 .input("created_by", created_by	)
//                 .input("modified_by", modified_by	)
//                 .input("tempstr1", tempstr1		)
//                 .input("tempstr2", tempstr2	)
//                 .input("tempstr3", tempstr3	)
//                 .input("tempstr4", tempstr4	)
//                 .input("datetime1", datetime1)
//                 .input("datetime2", datetime2)
//                 .input("datetime3", datetime3)
//                 .input("datetime4", datetime4)

//                 .query( `EXEC [sp_Base_Account_group] @mode,@base_accgroup_code,@base_accgroup_name,@status,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
//     }

//     res.status(200).json("Stock Transfer data deleted successfully");
//   } catch (error) {
//     console.error(error);
//     res.status(500).json({ message: err.message || 'Internal Server Error' });
//   } finally {
//     connection.closeDatabaseConnection();
//   }
// };

const deleteBaseData = async (req, res) => {
  const company_nosToDelete = req.body.company_nos;

  if (!company_nosToDelete || !company_nosToDelete.length) {
    res.status(400).json("Invalid or empty company_nos array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase();

    for (const base_accgroup_code of company_nosToDelete) {
      try {
        await pool.request().input("base_accgroup_code", base_accgroup_code)
          .input("modified_by", sql.NVarChar, req.headers['modified-by'])
          .query(`
            EXEC [sp_Base_Account_group] 'D',@base_accgroup_code,'','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL

          `);
      } catch (error) {
        if (error.number === 50000) {
          // Foreign key constraint violation
          res.status(400).json("The base account group cannot be deleted due to a link with another record");
          return;
        } else {
          throw error; // Rethrow other SQL errors
        }
      }
    }

    res.status(200).json("Companies deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//ADD DATAS IN USER ACCOUNT GROUP
const addUserAccGrp = async (req, res) => {
  const {
    user_accgroup_code,
    user_accgroup_name,
    standard_accgroup_code,
    base_accgroup_code,
    status,
    created_by,
    modified_by,
    tempstr1,
    tempstr2,
    tempstr3,
    tempstr4,
    datetime1,
    datetime2,
    datetime3,
    datetime4,
  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("user_accgroup_code", sql.NVarChar, user_accgroup_code)
      .input("user_accgroup_name", sql.NVarChar, user_accgroup_name)
      .input("standard_accgroup_code", sql.NVarChar, standard_accgroup_code)
      .input("base_accgroup_code", sql.NVarChar, base_accgroup_code)
      .input("status", sql.NVarChar, status)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(
        `EXEC sp_user_account_group @mode,@user_accgroup_code,@user_accgroup_name,@standard_accgroup_code,@base_accgroup_code,@status,@created_by,
        @modified_by,@tempstr1,@tempstr2,@tempstr3,@tempstr4,@datetime1,@datetime2,@datetime3,@datetime4`);


    // Return success response
    if (result.rowsAffected && result.rowsAffected[0] > 0) {
      return res.status(200).json({ success: true, message: 'Data inserted successfully' });
    }
  } catch (error) {
    if (error.class === 16 && error.number === 50000) {
      // Custom error from the stored procedure
      res.status(400).json({ message: 'User Account already exists' });
    } else {
      // Handle unexpected errors
      res.status(500).json({ message: 'Internal Server Error', error: error.message });
    }
  }
};

const getsearchUserAccGrp = async (req, res) => {
  const { user_accgroup_code, user_accgroup_name, standard_accgroup_code, base_accgroup_code, status, } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("user_accgroup_code", sql.NVarChar, user_accgroup_code)
      .input("user_accgroup_name", sql.NVarChar, user_accgroup_name)
      .input("standard_accgroup_code", sql.NVarChar, standard_accgroup_code)
      .input("base_accgroup_code", sql.NVarChar, base_accgroup_code)
      .input("status", sql.NVarChar, status)
      .query(`EXEC sp_user_account_group @mode,@user_accgroup_code,@user_accgroup_name,@standard_accgroup_code,
                 @base_accgroup_code,@status,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const updUserAccGrp = async (req, res) => {
  const editedData = req.body.editedData;

  if (!editedData || !editedData.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase(dbConfig);

    for (const updatedRow of editedData) {
      await pool
        .request()
        .input("mode", sql.NVarChar, "U")
        .input("user_accgroup_code", sql.NVarChar, updatedRow.user_accgroup_code)
        .input("user_accgroup_name", sql.NVarChar, updatedRow.user_accgroup_name)
        .input("standard_accgroup_code", sql.NVarChar, updatedRow.standard_accgroup_code)
        .input("base_accgroup_code", sql.NVarChar, updatedRow.base_accgroup_code)
        .input("status", sql.NVarChar, updatedRow.status)
        .input("created_by", sql.NVarChar, updatedRow.created_by)
        .input("modified_by", sql.NVarChar, req.headers['modified-by'])
        .input("tempstr1", sql.NVarChar, updatedRow.tempstr1)
        .input("tempstr2", sql.NVarChar, updatedRow.tempstr2)
        .input("tempstr3", sql.NVarChar, updatedRow.tempstr3)
        .input("tempstr4", sql.NVarChar, updatedRow.tempstr4)
        .input("datetime1", sql.NVarChar, updatedRow.datetime1)
        .input("datetime2", sql.NVarChar, updatedRow.datetime2)
        .input("datetime3", sql.NVarChar, updatedRow.datetime3)
        .input("datetime4", sql.NVarChar, updatedRow.datetime4)
        .query(
          `EXEC sp_user_account_group @mode,@user_accgroup_code, @user_accgroup_name, @standard_accgroup_code, @base_accgroup_code, @status,
            @created_by,@modified_by, @tempstr1, @tempstr2, @tempstr3, @tempstr4, @datetime1, @datetime2, @datetime3, @datetime4`
        );
    }
    res.status(200).json("Edited data saved successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const deleteUserAccGrp = async (req, res) => {
  const { user_accgroup_codesToDelete, user_accgroup_nameToDelete } = req.body;

  if (!user_accgroup_codesToDelete || !user_accgroup_nameToDelete.length || !user_accgroup_codesToDelete || !user_accgroup_nameToDelete.length) {
    res.status(400).json("Invalid or empty Codes or codeDetails array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase();

    const deleteQuery = `EXEC sp_user_account_group 'D',@user_accgroup_code, @user_accgroup_name,'','','',
      '',@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
      `;
    for (let i = 0; i < user_accgroup_codesToDelete.length; i++) {
      try {
        await pool.request()
          .input("user_accgroup_code", user_accgroup_codesToDelete[i])
          .input("user_accgroup_name", user_accgroup_nameToDelete[i])
          .input("modified_by", sql.NVarChar, req.headers['modified-by'])
          .query(deleteQuery);
      } catch (error) {
        if (error.number === 50000) {
          // Foreign key constraint violation
          res.status(400).json("The user account group cannot be deleted due to a link with another record");
          return;
        } else {
          throw error; // Rethrow other SQL errors
        }
      }
    }

    res.status(200).json("User Account Group data deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
const getStdAccGrp = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(
      "EXEC [sp_standard_account_group] 'F','standard_accgroup_code','','','','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
    );

    res.json(result.recordset);
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
const getBaseAccGrp = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(
      "EXEC sp_Base_Account_group 'F','base_accgroup_code','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
    );

    res.json(result.recordset);
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//code added by kathiravan arumugam on 01-08-2024\\
const addstandardaccountData = async (req, res) => {
  const {
    standard_accgroup_code, standard_accgroup_name, base_accgroup_code, user_accgroup_from, user_accgroup_to, status, deletePermission, created_by, modified_by,
    tempstr1, tempstr2, tempstr3, tempstr4, datetime1, datetime2, datetime3, datetime4,
  } = req.body;

  let pool;
  try {
    pool = await sql.connect(dbConfig);



    // If the company code doesn't exist, proceed with inserting the data
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("standard_accgroup_code", sql.NVarChar, standard_accgroup_code)
      .input("standard_accgroup_name", sql.NVarChar, standard_accgroup_name)
      .input("base_accgroup_code", sql.NVarChar, base_accgroup_code)
      .input("user_accgroup_from", sql.NVarChar, user_accgroup_from)
      .input("user_accgroup_to", sql.NVarChar, user_accgroup_to)
      .input("status", sql.NVarChar, status)
      .input("deletePermission", sql.NVarChar, deletePermission)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(
        `EXEC sp_standard_account_group @mode, @standard_accgroup_code, @standard_accgroup_name, @base_accgroup_code, @user_accgroup_from, @user_accgroup_to, @status, @deletePermission, @created_by,@modified_by,  
       @tempstr1, @tempstr2, @tempstr3, @tempstr4, 
      @datetime1, @datetime2, @datetime3, @datetime4 `
      );

    // Return success response
    if (result.rowsAffected && result.rowsAffected[0] > 0) {
      return res.status(200).json({ success: true, message: 'Data inserted successfully' });
    }
  } catch (error) {
    if (error.class === 16 && error.number === 50000) {
      // Custom error from the stored procedure
      res.status(400).json({ message: 'Standard Account code already exists' });
    } else {
      // Handle unexpected errors
      res.status(500).json({ message: 'Internal Server Error', error: error.message });
    }
  }
};

const getAllStandardAccountData = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`EXEC sp_standard_account_group 'A','','','','','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};



const getbasaccode = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(
      `EXEC sp_standard_account_group 'BAF','','','','','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`
    );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//Code added by pavun 05-08-2024
const getCurrentStock = async (req, res) => {
  const { company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "CS")
      .input("company_code", sql.NVarChar, company_code)
      .query(
        `EXEC sp_dashboard_stock @mode,@company_code,''`
      );

    if (result.recordset && Array.isArray(result.recordset) && result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    }
    else {
      // Send a 404 Not Found status if no data is found
      res.status(404).json('No data found');
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};



const getNegativeStock = async (req, res) => {
  const { company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "NS")
      .input("company_code", sql.NVarChar, company_code)
      .query(
        `EXEC sp_dashboard_stock @mode,@company_code,'' `
      );

    if (result.recordset && Array.isArray(result.recordset) && result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    }
    else {
      // Send a 404 Not Found status if no data is found
      res.status(404).json('No data found');
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};



const getstandardsearchdata = async (req, res) => {
  const { standard_accgroup_code, standard_accgroup_name, base_accgroup_code, status } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("standard_accgroup_code", sql.NVarChar, standard_accgroup_code)
      .input("standard_accgroup_name", sql.NVarChar, standard_accgroup_name)
      .input("base_accgroup_code", sql.NVarChar, base_accgroup_code)
      .input("status", sql.NVarChar, status)
      .query(` EXEC [sp_standard_account_group] 'SC',@standard_accgroup_code,@standard_accgroup_name,@base_accgroup_code	,'','',@status,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const deleteStdAccGrp = async (req, res) => {
  const { standard_accgroup_codeToDelete, standard_accgroup_nameToDelete } = req.body;



  try {
    const pool = await connection.connectToDatabase();

    const deleteQuery = `EXEC [sp_standard_account_group] 'D', @standard_accgroup_code,@standard_accgroup_name,'','','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL `;
    for (let i = 0; i < standard_accgroup_codeToDelete.length; i++) {
      await pool.request()
        .input("standard_accgroup_code", standard_accgroup_codeToDelete[i])
        .input("standard_accgroup_name", standard_accgroup_nameToDelete[i])
        .input("modified_by", sql.NVarChar, req.headers['modified-by'])
        .query(deleteQuery);
    }

    res.status(200).json("Standard Account Group data deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//USER ACCOUNT GROUP UPDATE 05/08/2024 Harish//
const updStdAccGrp = async (req, res) => {
  const { standard_accgroup_codeToUpdate, updatedData } = req.body;

  // if (!standard_accgroup_codeToUpdate || !standard_accgroup_codeToUpdate.length || 
  //     !standard_accgroup_nameToUpdate || !standard_accgroup_nameToUpdate.length ||
  //     !updatedData || !updatedData.length) {
  //   res.status(400).json("Invalid or empty input data.");
  //   return;
  // }

  try {
    const pool = await connection.connectToDatabase();

    for (let i = 0; i < standard_accgroup_codeToUpdate; i++) {
      const updatedRow = updatedData[i]; // Assuming updatedData is an array of objects with updated values

      await pool.request()
        .input("mode", sql.NVarChar, "U")
        .input("standard_accgroup_code", standard_accgroup_codeToUpdate[i])
        .input("standard_accgroup_name", standard_accgroup_nameToUpdate[i])
        .input("base_accgroup_code", sql.NVarChar, updatedRow.base_accgroup_code)
        .input("user_accgroup_from", sql.NVarChar, updatedRow.user_accgroup_from)
        .input("user_accgroup_to", sql.NVarChar, updatedRow.user_accgroup_to)
        .input("status", sql.NVarChar, updatedRow.status)
        .input("deletePermission", sql.NVarChar, updatedRow.deletePermission)
        .input("created_by", sql.NVarChar, updatedRow.created_by)
        .input("modified_by", sql.NVarChar, req.headers['modified-by'])
        .input("tempstr1", sql.NVarChar, updatedRow.tempstr1)
        .input("tempstr2", sql.NVarChar, updatedRow.tempstr2)
        .input("tempstr3", sql.NVarChar, updatedRow.tempstr3)
        .input("tempstr4", sql.NVarChar, updatedRow.tempstr4)
        .input("datetime1", sql.NVarChar, updatedRow.datetime1)
        .input("datetime2", sql.NVarChar, updatedRow.datetime2)
        .input("datetime3", sql.NVarChar, updatedRow.datetime3)
        .input("datetime4", sql.NVarChar, updatedRow.datetime4)
        .query(
          `EXEC [sp_standard_account_group] @mode,@standard_accgroup_code,@standard_accgroup_name, @base_accgroup_code	,@user_accgroup_from,@user_accgroup_to,@status,@deletePermission,@created_by,@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    }

    res.status(200).json("Updated data successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


//warehouseDashboard  08/08/2024 DHANA//
const warehouseDashboard = async (req, res) => {
  const { warehouse_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("warehouse_code", sql.NVarChar, warehouse_code)
      .query(`EXEC sp_warehouse_dashboard @warehouse_code`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
const getwarehousedrop = async (req, res) => {
  try {
    await connection.connectToDatabase();

    // Create a new SQL request
    const request = new sql.Request();

    // Add input parameter
    request.input("company_code", sql.NVarChar, req.body.company_code); // Assuming 'company_code' is sent in the request body

    // Execute the stored procedure
    const result = await request.query(
      "EXEC [sp_warehouse_info] 'FW', @company_code, '', '', '', '', '', '', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL"
    );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};





const deleteTaxData = async (req, res) => {
  const { tax_type_headersToDelete, tax_name_detailsToDelete } = req.body;

  if (!tax_type_headersToDelete || !tax_type_headersToDelete.length || !tax_name_detailsToDelete || !tax_name_detailsToDelete.length) {
    res.status(400).json("Invalid or empty Codes or codeDetails array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase();

    const deleteQuery = `EXEC [sp_tax_name_details] 'D',@company_code,@tax_type_header,@tax_name_details,0,'','','','','','',
                          NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`;
    for (let i = 0; i < tax_type_headersToDelete.length; i++) {
      try {
        await pool.request()
          .input("company_code", sql.VarChar, req.headers['company_code'])
          .input("tax_type_header", tax_type_headersToDelete[i])
          .input("tax_name_details", tax_name_detailsToDelete[i])
          .input("modified_by", sql.NVarChar, req.headers['modified-by'])
          .query(deleteQuery);
      } catch (err) {
        if (err.number === 50000) {
          // Foreign key constraint violation
          res.status(400).json("The tax cannot be deleted due to a link with another record");
          return;
        } else {
          throw err; // Rethrow other SQL errors
        }
      }
    }

    res.status(200).json("Tax data deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const updTaxdetData = async (req, res) => {
  const { tax_type_headersToUpdate, tax_name_detailssToUpdate, updatedData } = req.body;

  if (!tax_type_headersToUpdate || !tax_type_headersToUpdate.length ||
    !tax_name_detailssToUpdate || !tax_name_detailssToUpdate.length ||
    !updatedData || !updatedData.length) {
    res.status(400).json("Invalid or empty input data.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase();

    for (let i = 0; i < tax_type_headersToUpdate.length; i++) {
      const updatedRow = updatedData[i]; // Assuming updatedData is an array of objects with updated values

      await pool.request()
        .input("mode", sql.NVarChar, "U")
        .input("company_code", sql.VarChar, req.headers['company_code'])
        .input("tax_type_header", tax_type_headersToUpdate[i])
        .input("tax_name_details", tax_name_detailssToUpdate[i])
        .input("tax_accountcode", sql.NVarChar, updatedRow.tax_accountcode)
        .input("tax_percentage", sql.Decimal(14, 2), updatedRow.tax_percentage)
        .input("tax_shortname", sql.NVarChar, updatedRow.tax_shortname)
        .input("transaction_type", sql.NVarChar, updatedRow.transaction_type)
        .input("status", sql.NVarChar, updatedRow.status)
        .input("created_by", sql.NVarChar, updatedRow.created_by)
        .input("modified_by", sql.NVarChar, req.headers['modified-by'])
        .input("tempstr1", sql.NVarChar, updatedRow.tempstr1)
        .input("tempstr2", sql.NVarChar, updatedRow.tempstr2)
        .input("tempstr3", sql.NVarChar, updatedRow.tempstr3)
        .input("tempstr4", sql.NVarChar, updatedRow.tempstr4)
        .input("datetime1", sql.NVarChar, updatedRow.datetime1)
        .input("datetime2", sql.NVarChar, updatedRow.datetime2)
        .input("datetime3", sql.NVarChar, updatedRow.datetime3)
        .input("datetime4", sql.NVarChar, updatedRow.datetime4)
        .query(
          `EXEC sp_tax_name_details @mode,@company_code,@tax_type_header, @tax_name_details, @tax_percentage, @tax_shortname, @tax_accountcode,
            @transaction_type, @status,@created_by,@modified_by, @tempstr1, @tempstr2, @tempstr3, @tempstr4, @datetime1, @datetime2,
            @datetime3, @datetime4`
        );
    }

    res.status(200).json("Updated data successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};



const getpurchasereturnView = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "PR")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_getdata @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
 `);

    if (result.recordsets && result.recordsets.length > 0 && result.recordsets[0].length > 0) {
      const data = {
        table1: result.recordsets[0],
        table2: result.recordsets[1] || [], // Provide an empty array if no data
        table3: result.recordsets[2] || []  // Provide an empty array if no data
      };
      res.status(200).json(data); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};



//Uomchart  08/08/2024 AK//
const UomChart = async (req, res) => {
  const { UOM } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("UOM", sql.NVarChar, UOM)
      .query(`EXEC sp_dashboard_item_uom_chart @uom`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const Transdetail = async (req, res) => {
  const { mode, item_code, company_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, mode)
      .input("item_code", sql.NVarChar, item_code)
      .input("company_code", sql.NVarChar, company_code)
      .query(` EXEC sp_dashboard_TransactionDetails @mode,@item_code,'','','',@company_code`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const partytransdetail = async (req, res) => {
  const { mode, item_code, party_code, company_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, mode)
      .input("item_code", sql.NVarChar, item_code)
      .input("party_code", sql.NVarChar, party_code)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_dashboard_TransactionDetails @mode,@item_code,@party_code,'','',@company_code`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const alltransdetail = async (req, res) => {
  const { mode, item_code, party_code, start_date, end_date, company_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, mode)
      .input("item_code", sql.NVarChar, item_code)
      .input("party_code", sql.NVarChar, party_code)
      .input("start_date", sql.NVarChar, start_date)
      .input("end_date", sql.NVarChar, end_date)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_dashboard_TransactionDetails @mode,@item_code,@party_code,@start_date,@end_date,@company_code`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const datetransdetail = async (req, res) => {
  const { mode, item_code, start_date, end_date, company_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, mode)
      .input("item_code", sql.NVarChar, item_code)
      .input("start_date", sql.NVarChar, start_date)
      .input("end_date", sql.NVarChar, end_date)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_dashboard_TransactionDetails @mode,@item_code,'',@start_date,@end_date,@company_code`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};



//code added by harish on 09-08-2024
const getSalesreturnView = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SR")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)

      // .input("status", sql.NVarChar, status)
      .query(`EXEC sp_getdata 'SR',@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    if (result.recordsets && result.recordsets.length > 0 && result.recordsets[0].length > 0) {
      const data = {
        table1: result.recordsets[0],
        table2: result.recordsets[1] || [], // Provide an empty array if no data
        table3: result.recordsets[2] || []  // Provide an empty array if no data
      };
      res.status(200).json(data); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getpurreturnsearchViewdata = async (req, res) => {
  const { company_code, return_no, transaction_date, transaction_no, vendor_name, vendor_code, purchase_type, pay_type, } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("company_code", sql.NVarChar, company_code)
      .input("return_no", sql.NVarChar, return_no)
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("transaction_date", sql.NVarChar, transaction_date)
      .input("purchase_type", sql.NVarChar, purchase_type)
      .input("vendor_code", sql.NVarChar, vendor_code)
      .input("vendor_name", sql.NVarChar, vendor_name)
      .input("pay_type", sql.NVarChar, pay_type)

      // .input("status", sql.NVarChar, status)
      .query(`EXEC sp_purchase_return_hdr @mode,@company_code,'',@return_no,'','','',@transaction_no,@transaction_date,@purchase_type,@vendor_code,@vendor_name,@pay_type,0,0,0,0,0,0,0,0,0,'','','',0,'','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
 `);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


//code added by pavun 10/08/2024
const varientChart = async (req, res) => {
  const { Item_variant } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("Item_variant", sql.NVarChar, Item_variant)
      .query(` EXEC [sp_dashboard_item_varaiant_chart] @Item_variant`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//ACCOUNT NAME//10 AUG 2024//ADD
const addAccountName = async (req, res) => {
  const {
    company_code,
    account_code,
    account_name,
    acc_addr_1,
    acc_addr_2,
    acc_addr_3,
    acc_addr_4,
    acc_area_code,
    acc_state_code,
    acc_country_code,
    acc_imex_no,
    acc_office_no,
    acc_resi_no,
    acc_mobile_no,
    acc_fax_no,
    acc_email_id,
    acc_credit_limit,
    acc_transport_code,
    acc_salesman_code,
    acc_broker_code,
    acc_weekday_code,
    base_accgroup_code,
    standard_accgroup_code,
    user_accgroup_code,
    account_subcode,
    status,
    created_by,
    modified_by,
    tempstr1,
    tempstr2,
    tempstr3,
    tempstr4,
    datetime1,
    datetime2,
    datetime3,
    datetime4

  } = req.body;

  let pool;
  try {
    pool = await sql.connect(dbConfig);

    // If the company code doesn't exist, proceed with inserting the data
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("account_code", sql.NVarChar, account_code)
      .input("account_name", sql.NVarChar, account_name)
      .input("acc_addr_1", sql.NVarChar, acc_addr_1)
      .input("acc_addr_2", sql.NVarChar, acc_addr_2)
      .input("acc_addr_3", sql.NVarChar, acc_addr_3)
      .input("acc_addr_4", sql.NVarChar, acc_addr_4)
      .input("acc_area_code", sql.NVarChar, acc_area_code)
      .input("acc_state_code", sql.NVarChar, acc_state_code)
      .input("acc_country_code", sql.NVarChar, acc_country_code)
      .input("acc_imex_no", sql.NVarChar, acc_imex_no)
      .input("acc_office_no", sql.NVarChar, acc_office_no)
      .input("acc_resi_no", sql.NVarChar, acc_resi_no)
      .input("acc_mobile_no", sql.NVarChar, acc_mobile_no)
      .input("acc_fax_no", sql.NVarChar, acc_fax_no)
      .input("acc_email_id", sql.NVarChar, acc_email_id)
      .input("acc_credit_limit", sql.Decimal(14, 3), acc_credit_limit)
      .input("acc_transport_code", sql.NVarChar, acc_transport_code)
      .input("acc_salesman_code", sql.NVarChar, acc_salesman_code)
      .input("acc_broker_code", sql.NVarChar, acc_broker_code)
      .input("acc_weekday_code", sql.NVarChar, acc_weekday_code)
      .input("base_accgroup_code", sql.NVarChar, base_accgroup_code)
      .input("standard_accgroup_code", sql.NVarChar, standard_accgroup_code)
      .input("user_accgroup_code", sql.NVarChar, user_accgroup_code)
      .input("account_subcode", sql.NVarChar, account_subcode)
      .input("status", sql.NVarChar, status)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(`EXEC sp_account_name @mode, @company_code,@account_code, @account_name, @acc_addr_1, @acc_addr_2, @acc_addr_3, @acc_addr_4, @acc_area_code, @acc_state_code, 
      @acc_country_code, @acc_imex_no, @acc_office_no, @acc_resi_no, @acc_mobile_no, @acc_fax_no,@acc_email_id, @acc_credit_limit, @acc_transport_code, 
      @acc_salesman_code, @acc_broker_code, @acc_weekday_code,@base_accgroup_code,@standard_accgroup_code,@user_accgroup_code,@account_subcode,@status,'','','','','','','','','',@created_by,
      @modified_by,@tempstr1, @tempstr2, @tempstr3, @tempstr4,@datetime1, @datetime2, @datetime3, @datetime4,''`);

    // Return success response
    res.json({ success: true, message: "Data inserted successfully" });
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getAccNameSearch = async (req, res) => {
  const { company_code, account_code, account_name, acc_addr_1, acc_area_code, acc_state_code, acc_country_code, acc_mobile_no, base_accgroup_code,
    standard_accgroup_code, user_accgroup_code, account_subcode, status } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("company_code", sql.NVarChar, company_code)
      .input("account_code", sql.NVarChar, account_code)
      .input("account_name", sql.NVarChar, account_name)
      .input("acc_addr_1", sql.NVarChar, acc_addr_1)
      .input("acc_area_code", sql.NVarChar, acc_area_code)
      .input("acc_state_code", sql.NVarChar, acc_state_code)
      .input("acc_country_code", sql.NVarChar, acc_country_code)
      .input("acc_mobile_no", sql.NVarChar, acc_mobile_no)
      .input("base_accgroup_code", sql.NVarChar, base_accgroup_code)
      .input("standard_accgroup_code", sql.NVarChar, standard_accgroup_code)
      .input("user_accgroup_code", sql.NVarChar, user_accgroup_code)
      .input("account_subcode", sql.NVarChar, account_subcode)
      .input("status", sql.NVarChar, status)
      .query(`EXEC sp_account_name @mode,@company_code,@account_code,@account_name,@acc_addr_1,'','','',@acc_area_code,@acc_state_code,
      @acc_country_code,'','','',@acc_mobile_no,'' ,'',0,'','','','',@base_accgroup_code,@standard_accgroup_code,@user_accgroup_code,
      @account_subcode,@status,'','','','','','','','','','','',NULL,NULL,NULL,NULL,NULL,null,null,null,''`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
const updateAccName = async (req, res) => {
  const editedData = req.body.editedData;

  if (!editedData || !editedData.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase(dbConfig);

    for (const updatedRow of editedData) {
      await pool
        .request()
        .input("mode", sql.NVarChar, "U") // update mode
        .input("company_code", sql.NVarChar, req.headers['company_code'])
        .input("account_code", sql.NVarChar, updatedRow.account_code)
        .input("account_name", sql.NVarChar, updatedRow.account_name)
        .input("acc_addr_1", sql.NVarChar, updatedRow.acc_addr_1)
        .input("acc_addr_2", sql.NVarChar, updatedRow.acc_addr_2)
        .input("acc_addr_3", sql.NVarChar, updatedRow.acc_addr_3)
        .input("acc_addr_4", sql.NVarChar, updatedRow.acc_addr_4)
        .input("acc_area_code", sql.NVarChar, updatedRow.acc_area_code)
        .input("acc_state_code", sql.NVarChar, updatedRow.acc_state_code)
        .input("acc_country_code", sql.NVarChar, updatedRow.acc_country_code)
        .input("acc_imex_no", sql.NVarChar, updatedRow.acc_imex_no)
        .input("acc_office_no", sql.NVarChar, updatedRow.acc_office_no)
        .input("acc_resi_no", sql.NVarChar, updatedRow.acc_resi_no)
        .input("acc_mobile_no", sql.NVarChar, updatedRow.acc_mobile_no)
        .input("acc_fax_no", sql.NVarChar, updatedRow.acc_fax_no)
        .input("acc_email_id", sql.NVarChar, updatedRow.acc_email_id)
        .input("acc_credit_limit", sql.Decimal(14, 3), updatedRow.acc_credit_limit)
        .input("acc_transport_code", sql.NVarChar, updatedRow.acc_transport_code)
        .input("acc_salesman_code", sql.NVarChar, updatedRow.acc_salesman_code)
        .input("acc_broker_code", sql.NVarChar, updatedRow.acc_broker_code)
        .input("acc_weekday_code", sql.NVarChar, updatedRow.acc_weekday_code)
        .input("base_accgroup_code", sql.NVarChar, updatedRow.base_accgroup_code)
        .input("standard_accgroup_code", sql.NVarChar, updatedRow.standard_accgroup_code)
        .input("user_accgroup_code", sql.NVarChar, updatedRow.user_accgroup_code)
        .input("account_subcode", sql.NVarChar, updatedRow.account_subcode)
        .input("status", sql.NVarChar, updatedRow.status)
        .input("panno", sql.NVarChar, updatedRow.panno)
        .input("gst_no", sql.NVarChar, updatedRow.gst_no)
        .input("created_by", sql.NVarChar, updatedRow.created_by)
        .input("modified_by", sql.NVarChar, req.headers['modified-by'])
        .input("tempstr1", sql.NVarChar, updatedRow.tempstr1)
        .input("tempstr2", sql.NVarChar, updatedRow.tempstr2)
        .input("tempstr3", sql.NVarChar, updatedRow.tempstr3)
        .input("tempstr4", sql.NVarChar, updatedRow.tempstr4)
        .input("datetime1", sql.NVarChar, updatedRow.datetime1)
        .input("datetime2", sql.NVarChar, updatedRow.datetime2)
        .input("datetime3", sql.NVarChar, updatedRow.datetime3)
        .input("datetime4", sql.NVarChar, updatedRow.datetime4)
        .query(`EXEC sp_account_name @mode,@company_code,@account_code,@account_name,@acc_addr_1,@acc_addr_2,@acc_addr_3,@acc_addr_4,
          @acc_area_code,@acc_state_code,@acc_country_code,@acc_imex_no,@acc_office_no,@acc_resi_no,@acc_mobile_no,@acc_fax_no,
          @acc_email_id,@acc_credit_limit,@acc_transport_code,@acc_salesman_code,@acc_broker_code,@acc_weekday_code,@base_accgroup_code,
          @standard_accgroup_code,@user_accgroup_code,@account_subcode,@status,'','','','',@panno,@gst_no,'','','',
          @created_by,@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,''`);
    }

    res.status(200).json("Edited data saved successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const AccNameDelete = async (req, res) => {
  const account_codesToDelete = req.body.account_codes;

  if (!account_codesToDelete || !account_codesToDelete.length) {
    res.status(400).json("Invalid or empty account_codes array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase();

    for (const account_code of account_codesToDelete) {
      try {
        await pool.request()
          .input("company_code", sql.NVarChar, req.headers['company_code'])
          .input("account_code", account_code)
          .input("modified_by", sql.NVarChar, req.headers['modified-by'])
          .query(`
         EXEC sp_account_name 'D',@company_code,@account_code,'','','','','','','','',
'','' ,'','','','',0,'','','','','','','','','','','','','','','','','','','',@modified_by,NULL,NULL,NULL,null,null,null,null,null,''`);
      } catch (error) {
        if (error.number === 50000) {
          // Foreign key constraint violation
          res.status(400).json(error.message);
          return;
        } else {
          throw error; // Rethrow other SQL errors
        }
      }
    }

    res.status(200).json("Account data deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const getAllAccNameData = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`EXEC sp_account_name 'A','','','','','','','','','','','','','','','','',0,'','','','','','','','','','','','','','','','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};



const getsalesreturnsearchViewdata = async (req, res) => {
  const { company_code, bill_date, bill_no, return_no, sales_type, customer_code, customer_name, pay_type } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SSR")
      .input("company_code", sql.NVarChar, company_code)
      .input("bill_date", sql.NVarChar, bill_date)
      .input("bill_no", sql.NVarChar, bill_no)
      .input("return_no", sql.NVarChar, return_no)
      .input("sales_type", sql.NVarChar, sales_type)
      .input("customer_code", sql.NVarChar, customer_code)
      .input("customer_name", sql.NVarChar, customer_name)
      .input("pay_type", sql.NVarChar, pay_type)

      // .input("status", sql.NVarChar, status)
      .query(`EXEC sp_sales_return_hdr @mode,@company_code,@bill_date,@bill_no,'',@return_no,'','','','',@sales_type,@customer_code,0,0,0,0,0,0,0,0,0,0,0,0,0,
                          @pay_type,'','','','','','',@customer_name,'','','',0,0,0,'','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const SalesReturnTaxView = async (req, res) => {
  const { transaction_no } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SRT")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .query(`EXEC sp_getdata 'SRT',@transaction_no,'',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const SalesReturnDetailView = async (req, res) => {
  const { transaction_no } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SRD")
      .input("transaction_no", sql.NVarChar, transaction_no)

      // .input("status", sql.NVarChar, status)
      .query(`EXEC sp_getdata 'SRD',@transaction_no,'',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getitemsalsearchdata = async (req, res) => {
  const { company_code, Item_code, Item_name, type, Item_variant, Item_short_name, Item_Our_Brand, status } = req.body;
  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();
    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "STI")
      .input("company_code", sql.NVarChar, company_code)
      .input("Item_code", sql.NVarChar, Item_code)
      .input("Item_variant", sql.NVarChar, Item_variant)
      .input("Item_name", sql.NVarChar, Item_name)
      .input("Item_short_name", sql.NVarChar, Item_short_name)
      .input("Item_Our_Brand", sql.NVarChar, Item_Our_Brand)
      .input("status", sql.NVarChar, status)
      .input("type", sql.NVarChar, type)
      .query(`EXEC sp_item_brand_info @mode,@company_code,@Item_code,@Item_variant, @Item_name,0,'','',@Item_short_name,0,0,0,0,'','','','','','','',@Item_Our_Brand, @status,'','','','',0,0,@type,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);
    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const gettransdetailchart = async (req, res) => {
  const { mode, Item_code, start_date, End_Date, company_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, mode)
      .input("Item_code", sql.NVarChar, Item_code)
      .input("start_date", sql.NVarChar, start_date)
      .input("End_Date", sql.NVarChar, End_Date)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_dashboard_TransactionDetails_chart @mode,@Item_code,@start_date,@End_Date,@company_code`);

    // Send response
    if (result.recordset && Array.isArray(result.recordset) && result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};



const getpurchasereturntaxView = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "PRT")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_getdata @mode ,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const getpurchasereturnitView = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "PRD")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_getdata @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getDateRange = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`EXEC sp_DateRangeList 'FD',0,''`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getUsercodename = async (req, res) => {
  const { company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, 'FSA')
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_account_name @mode,@company_code,'','','','','','','','','','','','','','','',0,'','','','','','','','','','','','','','','','','','','','',NULL,NULL,NULL,null,null,null,null,null,''`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
const getUsercodenameBank = async (req, res) => {
  const { company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, 'FSAB')
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_account_name @mode,@company_code,'','','','','','','','','','','','','','','',0,'','','','','','','','','','','','','','','','','','','','',NULL,NULL,NULL,null,null,null,null,null,''`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const getAccountCode = async (req, res) => {
  const { company_code, user_accgroup_code, account_name } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, 'CU')
      .input("company_code", sql.NVarChar, company_code)
      .input("user_accgroup_code", sql.NVarChar, user_accgroup_code)
      .input("account_name", sql.NVarChar, account_name)
      .query(`EXEC sp_account_name @mode,@company_code,'',@account_name,'','','','','','','','','','','','','',0,'','','','','','',@user_accgroup_code,'','','','','','','','','','','','','',NULL,NULL,NULL,null,null,null,null,null,''`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//code added by AK (20/08/2024) code begins for insert option for bank acccount
const addbankAccount = async (req, res) => {
  const { company_code,
    account_code,
    account_name,
    acc_addr_1,
    acc_addr_2,
    acc_addr_3,
    acc_addr_4,
    acc_area_code,
    acc_state_code,
    acc_country_code,
    base_accgroup_code,
    standard_accgroup_code,
    user_accgroup_code,
    account_number,
    IFSC_code,
    account_type,
    branch,
    default_bank,
    created_by,
    modified_by,
    tempstr1,
    tempstr2,
    tempstr3,
    tempstr4,
    datetime1,
    datetime2,
    datetime3,
    datetime4
  } = req.body;

  let bank_paymentQRCode = null;

  if (req.file) {
    bank_paymentQRCode = req.file.buffer;
  }


  try {
    const pool = await connection.connectToDatabase(dbConfig);
    await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("account_code", sql.NVarChar, account_code)
      .input("account_name", sql.NVarChar, account_name)
      .input("acc_addr_1", sql.NVarChar, acc_addr_1)
      .input("acc_addr_2", sql.NVarChar, acc_addr_2)
      .input("acc_addr_3", sql.NVarChar, acc_addr_3)
      .input("acc_addr_4", sql.NVarChar, acc_addr_4)
      .input("acc_area_code", sql.NVarChar, acc_area_code)
      .input("acc_state_code", sql.NVarChar, acc_state_code)
      .input("acc_country_code", sql.NVarChar, acc_country_code)
      .input("base_accgroup_code", sql.NVarChar, base_accgroup_code)
      .input("standard_accgroup_code", sql.NVarChar, standard_accgroup_code)
      .input("user_accgroup_code", sql.NVarChar, user_accgroup_code)
      .input("account_number", sql.NVarChar, account_number)
      .input("IFSC_code", sql.NVarChar, IFSC_code)
      .input("account_type", sql.NVarChar, account_type)
      .input("branch", sql.NVarChar, branch)
      .input("bank_paymentQRCode", sql.VarBinary, bank_paymentQRCode)
      .input("default_bank", sql.VarChar, default_bank)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(`EXEC sp_account_name @mode, @company_code,@account_code, @account_name, @acc_addr_1, @acc_addr_2, @acc_addr_3, @acc_addr_4, @acc_area_code, @acc_state_code, 
      @acc_country_code, '','','','','','',0,'','','','',@base_accgroup_code,@standard_accgroup_code,@user_accgroup_code,'','',@account_number,@IFSC_code,@account_type,@branch,'','','',@bank_paymentQRCode,@default_bank,@created_by,
      @modified_by,@tempstr1, @tempstr2, @tempstr3, @tempstr4,@datetime1, @datetime2, @datetime3, @datetime4,''`
      );

    res.json({ success: true, message: "Data inserted successfully" });

  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getacctype = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'account type','','', '','','', NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const updatebankAcc = async (req, res) => {
  const editedData = req.body.editedData;

  if (!editedData || !editedData.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase(dbConfig);

    for (const updatedRow of editedData) {
      await pool
        .request()
        .input("mode", sql.NVarChar, "U") // update mode
        .input("company_code", sql.NVarChar, req.headers['company_code'])
        .input("account_code", sql.NVarChar, updatedRow.account_code)
        .input("account_name", sql.NVarChar, updatedRow.account_name)
        .input("acc_addr_1", sql.NVarChar, updatedRow.acc_addr_1)
        .input("acc_addr_2", sql.NVarChar, updatedRow.acc_addr_2)
        .input("acc_addr_3", sql.NVarChar, updatedRow.acc_addr_3)
        .input("acc_addr_4", sql.NVarChar, updatedRow.acc_addr_4)
        .input("acc_area_code", sql.NVarChar, updatedRow.acc_area_code)
        .input("acc_state_code", sql.NVarChar, updatedRow.acc_state_code)
        .input("acc_country_code", sql.NVarChar, updatedRow.acc_country_code)
        .input("base_accgroup_code", sql.NVarChar, updatedRow.base_accgroup_code)
        .input("standard_accgroup_code", sql.NVarChar, updatedRow.standard_accgroup_code)
        .input("user_accgroup_code", sql.NVarChar, updatedRow.user_accgroup_code)
        .input("account_number", sql.NVarChar, updatedRow.account_number)
        .input("IFSC_code", sql.NVarChar, updatedRow.IFSC_code)
        .input("account_type", sql.NVarChar, updatedRow.account_type)
        .input("branch", sql.NVarChar, updatedRow.branch)
        .input("default_bank", sql.VarChar, updatedRow.default_bank)
        .input("created_by", sql.NVarChar, updatedRow.created_by)
        .input("modified_by", sql.NVarChar, req.headers['modified-by'])
        .input("tempstr1", sql.NVarChar, updatedRow.tempstr1)
        .input("tempstr2", sql.NVarChar, updatedRow.tempstr2)
        .input("tempstr3", sql.NVarChar, updatedRow.tempstr3)
        .input("tempstr4", sql.NVarChar, updatedRow.tempstr4)
        .input("datetime1", sql.NVarChar, updatedRow.datetime1)
        .input("datetime2", sql.NVarChar, updatedRow.datetime2)
        .input("datetime3", sql.NVarChar, updatedRow.datetime3)
        .input("datetime4", sql.NVarChar, updatedRow.datetime4)
        .query(`EXEC sp_account_name @mode,@company_code,@account_code,@account_name,@acc_addr_1,@acc_addr_2,@acc_addr_3,@acc_addr_4,
          @acc_area_code,@acc_state_code,@acc_country_code,'','','','','',
          '',0,'','','','',@base_accgroup_code,@standard_accgroup_code,@user_accgroup_code,'','',@account_number,@IFSC_code,@account_type,@branch,'','','',
          '',@default_bank,@created_by,@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,''`);
    }

    res.status(200).json("Edited data saved successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getbankaccSearch = async (req, res) => {
  const { company_code, account_code, account_name, acc_addr_1, acc_area_code, acc_state_code, acc_country_code, account_type, branch } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SCB")
      .input("company_code", sql.NVarChar, company_code)
      .input("account_code", sql.NVarChar, account_code)
      .input("account_name", sql.NVarChar, account_name)
      .input("acc_addr_1", sql.NVarChar, acc_addr_1)
      .input("acc_area_code", sql.NVarChar, acc_area_code)
      .input("acc_state_code", sql.NVarChar, acc_state_code)
      .input("acc_country_code", sql.NVarChar, acc_country_code)
      .input("account_type", sql.NVarChar, account_type)
      .input("branch", sql.NVarChar, branch)
      .query(`EXEC sp_account_name @mode,@company_code,@account_code,@account_name,@acc_addr_1,'','','',@acc_area_code,@acc_state_code,
      @acc_country_code,'','','','','' ,'',0,'','','','','','','',
      '','','','',@account_type,@branch,'','','','','','','',NULL,NULL,NULL,NULL,NULL,null,null,null,''`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//code ends


const addDeliveryChallanheader = async (req, res) => {
  const {
    company_code, transaction_no, transaction_date, transport_charges, pay_type, sales_type, customer_name, bill_to_customer_code, customer_addr_1,
    customer_addr_2, customer_addr_3, customer_addr_4, customer_state, customer_country, customer_mobile_no, contact_person, ShipTo_customer_name,
    Ship_to_customer_code, ShipTo_customer_addr_1, ShipTo_customer_addr_2, ShipTo_customer_addr_3, ShipTo_customer_addr_4, ShipTo_customer_state,
    ShipTo_customer_country, ShipTo_customer_mobile_no, ShipTocontact_person, purchase_amount, add_fright, less_fright, rounded_off, loading_charges,
    cartage_paid, other_charges, lorry_no, broker_code, transport_code, status, total_amount, rounded_off_acc_code, loading_charges_acc_code,
    cartage_paid_acc_code, other_charges_acc_code, purchase_amount_acc_code, customer_gst_no, ShipTocustomer_gst_no, delivery_note, dispatched_through,
    destination, note_not_for_sale, created_by, modified_by, tempstr1, tempstr2, tempstr3, tempstr4, datetime1,
    datetime2, datetime3, datetime4 } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("transaction_date", sql.Date, transaction_date)
      .input("transport_charges", sql.Decimal, transport_charges)
      .input("pay_type", sql.NVarChar, pay_type)
      .input("sales_type", sql.NVarChar, sales_type)
      .input("customer_name", sql.NVarChar, customer_name)
      .input("bill_to_customer_code", sql.NVarChar, bill_to_customer_code)
      .input("customer_addr_1", sql.NVarChar, customer_addr_1)
      .input("customer_addr_2", sql.NVarChar, customer_addr_2)
      .input("customer_addr_3", sql.NVarChar, customer_addr_3)
      .input("customer_addr_4", sql.NVarChar, customer_addr_4)
      .input("customer_state", sql.NVarChar, customer_state)
      .input("customer_country", sql.NVarChar, customer_country)
      .input("customer_mobile_no", sql.NVarChar, customer_mobile_no)
      .input("contact_person", sql.NVarChar, contact_person)
      .input("ShipTo_customer_name", sql.NVarChar, ShipTo_customer_name)
      .input("Ship_to_customer_code", sql.NVarChar, Ship_to_customer_code)
      .input("ShipTo_customer_addr_1", sql.NVarChar, ShipTo_customer_addr_1)
      .input("ShipTo_customer_addr_2", sql.NVarChar, ShipTo_customer_addr_2)
      .input("ShipTo_customer_addr_3", sql.NVarChar, ShipTo_customer_addr_3)
      .input("ShipTo_customer_addr_4", sql.NVarChar, ShipTo_customer_addr_4)
      .input("ShipTo_customer_state", sql.NVarChar, ShipTo_customer_state)
      .input("ShipTo_customer_country", sql.NVarChar, ShipTo_customer_country)
      .input("ShipTo_customer_mobile_no", sql.NVarChar, ShipTo_customer_mobile_no)
      .input("ShipTocontact_person", sql.NVarChar, ShipTocontact_person)
      .input("purchase_amount", sql.Decimal(14, 2), purchase_amount)
      .input("add_fright", sql.Decimal(14, 2), add_fright)
      .input("less_fright", sql.Decimal(14, 2), less_fright)
      .input("rounded_off", sql.Decimal(14, 2), rounded_off)
      .input("loading_charges", sql.Decimal(14, 2), loading_charges)
      .input("cartage_paid", sql.Decimal(14, 2), cartage_paid)
      .input("other_charges", sql.Decimal(14, 2), other_charges)
      .input("lorry_no", sql.NVarChar, lorry_no)
      .input("broker_code", sql.NVarChar, broker_code)
      .input("transport_code", sql.NVarChar, transport_code)
      .input("status", sql.NVarChar, status)
      .input("total_amount", sql.Decimal(10, 2), total_amount)
      .input("rounded_off_acc_code", sql.NVarChar, rounded_off_acc_code)
      .input("loading_charges_acc_code", sql.NVarChar, loading_charges_acc_code)
      .input("cartage_paid_acc_code", sql.NVarChar, cartage_paid_acc_code)
      .input("other_charges_acc_code", sql.NVarChar, other_charges_acc_code)
      .input("purchase_amount_acc_code", sql.NVarChar, purchase_amount_acc_code)
      .input("customer_gst_no", sql.NVarChar, customer_gst_no)
      .input("ShipTocustomer_gst_no", sql.NVarChar, ShipTocustomer_gst_no)
      .input("delivery_note", sql.NVarChar, delivery_note)
      .input("dispatched_through", sql.NVarChar, dispatched_through)
      .input("destination", sql.NVarChar, destination)
      .input("note_not_for_sale", sql.NVarChar, note_not_for_sale)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(`EXEC sp_delivery_challan_hdr @mode,@company_code,@transaction_no,@transaction_date,@transport_charges,@pay_type,@sales_type,@customer_name,@bill_to_customer_code,@customer_addr_1,
                   @customer_addr_2,@customer_addr_3,@customer_addr_4,@customer_state,@customer_country,@customer_mobile_no,@contact_person,@ShipTo_customer_name,
                  @Ship_to_customer_code,@ShipTo_customer_addr_1,@ShipTo_customer_addr_2,@ShipTo_customer_addr_3,@ShipTo_customer_addr_4,@ShipTo_customer_state,
                  @ShipTo_customer_country,@ShipTo_customer_mobile_no,@ShipTocontact_person,@purchase_amount,@add_fright,@less_fright,@rounded_off,@loading_charges,
                  @cartage_paid,@other_charges,@lorry_no,@broker_code,@transport_code,@status,@total_amount,@rounded_off_acc_code,@loading_charges_acc_code,
                  @cartage_paid_acc_code,@other_charges_acc_code,@purchase_amount_acc_code,@customer_gst_no,@ShipTocustomer_gst_no,@delivery_note, @dispatched_through,@destination,@note_not_for_sale,@created_by,@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`)
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const getAllDChdrData = async (req, res) => {
  const { company_code } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "A") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_delivery_challan_hdr @mode,@company_code,'','',0,'','','','','',
                   '','','','','','','','','','','','','','','','','',0,0,0,0,0,0,0,'','','','',0,'','','','','','','','','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const DCdeletehdrData = async (req, res) => {
  // const purch_autonosToDelete = req.body.purch_autonos;
  const { company_code, transaction_no, modified_by } = req.body;
  const pool = await connection.connectToDatabase();
  try {
    await pool
      .request()
      .input("mode", sql.NVarChar, "D")
      .input("company_code", sql.NVarChar, company_code)
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("modified_by", sql.NVarChar, modified_by)
      .query(`EXEC sp_delivery_challan_hdr @mode,@company_code,@transaction_no,'',0,'','','','','',
             '','','','','','','','','','','','','','','','','',0,0,0,0,0,0,0,'','','','',0,'','','','','','','','','','','','',@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.status(200).json("Delivery challan deleted successfully");
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};


const getAllDCdetData = async (req, res) => {
  const { company_code } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "A") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_delivery_challan_details_list   @mode,@company_code,'','',0,'','','','','','',
      0,0,0,'','',0,'','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const addDeliveryChallandetail = async (req, res) => {
  const {
    company_code, transaction_date, transaction_no, SNo, code, name, Description, warehouse_code, customer_code, customer_name,
    bill_qty, bill_rate, unit_price, pay_type, sales_type, transport_charges, type, hsn_code, created_by, modified_by,
    tempstr1, tempstr2, tempstr3, tempstr4, datetime1, datetime2, datetime3, datetime4
  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("transaction_date", sql.Date, transaction_date)
      .input("SNo", sql.Int, SNo)
      .input("code", sql.NVarChar, code)
      .input("name", sql.NVarChar, name)
      .input("Description", sql.NVarChar, Description)
      .input("warehouse_code", sql.NVarChar, warehouse_code)
      .input("customer_code", sql.NVarChar, customer_code)
      .input("customer_name", sql.NVarChar, customer_name)
      .input("bill_qty", sql.Decimal(10, 2), bill_qty)
      .input("bill_rate", sql.Decimal(10, 2), bill_rate)
      .input("unit_price", sql.Decimal(10, 2), unit_price)
      .input("type", sql.NVarChar, type)
      .input("pay_type", sql.NVarChar, pay_type)
      .input("sales_type", sql.NVarChar, sales_type)
      .input("hsn_code", sql.NVarChar, hsn_code)
      .input("transport_charges", sql.Decimal(14, 2), transport_charges)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(`EXEC sp_delivery_challan_details_list   @mode,@company_code,@transaction_date,@transaction_no,@SNo,@code,@name,@Description,@warehouse_code,@customer_code,@customer_name,
      @bill_qty,@bill_rate,@unit_price,@pay_type,@sales_type,@transport_charges,@type,@hsn_code,@created_by,@modified_by,
      @tempstr1,@tempstr2,@tempstr3,@tempstr4,@datetime1,@datetime2,@datetime3,@datetime4`);
    res.json({ success: true, message: "Delivery Challan inserted successfully" });
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const DCdeletedetData = async (req, res) => {
  // const purch_autonosToDelete = req.body.purch_autonos;
  const { company_code, transaction_no } = req.body;

  const pool = await connection.connectToDatabase();
  try {
    await pool
      .request()
      .input("mode", sql.NVarChar, "D")
      .input("company_code", sql.NVarChar, company_code)
      .input("transaction_no", sql.NVarChar, transaction_no)
      .query(`EXEC sp_delivery_challan_details_list   @mode,@company_code,'',@transaction_no,0,'','','','','','',
          0,0,0,'','',0,'','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.status(200).json("Challan deleted successfully");
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};


const getofftype = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'OfficeType','','', '','','', NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};






// quoatuin header and deatils node for crud opertion coded added by AK on 08/22/2024 code begins
const addQuotationheader = async (req, res) => {
  const { company_code, Entry_date, transaction_no, customer_code, customer_name, customer_addr_1, customer_addr_2, customer_addr_3, customer_addr_4, customer_state, customer_country, customer_mobile_no, contact_person, purchase_amount, tax_amount, add_fright, less_fright, rounded_off, loading_charges, cartage_paid, other_charges, total_amount, customer_gst_no, kind_attention, quotation_validity, created_by, modified_by,
    tempstr1, tempstr2, tempstr3, tempstr4, datetime1, datetime2, datetime3, datetime4 } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("customer_name", sql.NVarChar, customer_name)
      .input("customer_addr_1", sql.NVarChar, customer_addr_1)
      .input("customer_addr_2", sql.NVarChar, customer_addr_2)
      .input("customer_addr_3", sql.NVarChar, customer_addr_3)
      .input("customer_addr_4", sql.NVarChar, customer_addr_4)
      .input("customer_state", sql.NVarChar, customer_state)
      .input("customer_country", sql.NVarChar, customer_country)
      .input("customer_mobile_no", sql.NVarChar, customer_mobile_no)
      .input("contact_person", sql.NVarChar, contact_person)
      .input("Entry_date", sql.NVarChar, Entry_date)
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("customer_code", sql.NVarChar, customer_code)
      .input("purchase_amount", sql.Decimal(14, 2), purchase_amount)
      .input("tax_amount", sql.Decimal(14, 2), tax_amount)
      .input("add_fright", sql.Decimal(14, 2), add_fright)
      .input("less_fright", sql.Decimal(14, 2), less_fright)
      .input("rounded_off", sql.Decimal(14, 2), rounded_off)
      .input("loading_charges", sql.Decimal(14, 2), loading_charges)
      .input("cartage_paid", sql.Decimal(14, 2), cartage_paid)
      .input("other_charges", sql.Decimal(14, 2), other_charges)
      .input("total_amount", sql.Decimal(10, 2), total_amount)
      .input("customer_gst_no", sql.NVarChar, customer_gst_no)
      .input("kind_attention", sql.NVarChar, kind_attention)
      .input("quotation_validity", sql.NVarChar, quotation_validity)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(`EXEC sp_quotation_hdr @mode ,@company_code, @customer_name,@customer_addr_1,@customer_addr_2,@customer_addr_3,@customer_addr_4, @customer_state,@customer_country,@customer_mobile_no,@contact_person, @Entry_date, @transaction_no,
        @customer_code, @purchase_amount,@tax_amount, @add_fright, @less_fright, @rounded_off, @loading_charges, @cartage_paid, @other_charges, @total_amount, @customer_gst_no,@kind_attention,@quotation_validity, @created_by, @modified_by, NULL, NULL, NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const updQuotationheader = async (req, res) => {
  const { company_code, Entry_date, transaction_no, customer_code, customer_name, customer_addr_1, customer_addr_2, customer_addr_3, customer_addr_4, customer_state, customer_country, customer_mobile_no, contact_person, purchase_amount, tax_amount, add_fright, less_fright, rounded_off, loading_charges, cartage_paid, other_charges, total_amount, customer_gst_no, kind_attention, quotation_validity, modified_by } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "U") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("customer_name", sql.NVarChar, customer_name)
      .input("customer_addr_1", sql.NVarChar, customer_addr_1)
      .input("customer_addr_2", sql.NVarChar, customer_addr_2)
      .input("customer_addr_3", sql.NVarChar, customer_addr_3)
      .input("customer_addr_4", sql.NVarChar, customer_addr_4)
      .input("customer_state", sql.NVarChar, customer_state)
      .input("customer_country", sql.NVarChar, customer_country)
      .input("customer_mobile_no", sql.NVarChar, customer_mobile_no)
      .input("contact_person", sql.NVarChar, contact_person)
      .input("Entry_date", sql.NVarChar, Entry_date)
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("customer_code", sql.NVarChar, customer_code)
      .input("purchase_amount", sql.Decimal(14, 2), purchase_amount)
      .input("tax_amount", sql.Decimal(14, 2), tax_amount)
      .input("add_fright", sql.Decimal(14, 2), add_fright)
      .input("less_fright", sql.Decimal(14, 2), less_fright)
      .input("rounded_off", sql.Decimal(14, 2), rounded_off)
      .input("loading_charges", sql.Decimal(14, 2), loading_charges)
      .input("cartage_paid", sql.Decimal(14, 2), cartage_paid)
      .input("other_charges", sql.Decimal(14, 2), other_charges)
      .input("total_amount", sql.Decimal(10, 2), total_amount)
      .input("customer_gst_no", sql.NVarChar, customer_gst_no)
      .input("kind_attention", sql.NVarChar, kind_attention)
      .input("quotation_validity", sql.NVarChar, quotation_validity)
      .input("modified_by", sql.NVarChar, modified_by)
      .query(`EXEC sp_quotation_hdr @mode ,@company_code, @customer_name,@customer_addr_1,@customer_addr_2,@customer_addr_3,@customer_addr_4, @customer_state,@customer_country,@customer_mobile_no,@contact_person, @Entry_date, @transaction_no,
        @customer_code, @purchase_amount,@tax_amount, @add_fright, @less_fright, @rounded_off, @loading_charges, @cartage_paid, @other_charges, @total_amount, @customer_gst_no,@kind_attention,@quotation_validity, '', @modified_by, NULL, NULL, NULL,NULL,NULL,NULL,NULL,NULL`);
    res.json(result.recordset);

  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getAllquotehdrData = async (req, res) => {
  const { company_code } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "A") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_quotation_hdr 'A',@company_code,'','','','','','','','','','','','',0,0,0,0,0,0,0,0,0,'','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const quotedeletehdrData = async (req, res) => {
  // const purch_autonosToDelete = req.body.purch_autonos;
  const { company_code, transaction_no, modified_by } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    try {
      await pool
        .request()
        .input("mode", sql.NVarChar, "D")
        .input("company_code", sql.NVarChar, company_code)
        .input("transaction_no", sql.NVarChar, transaction_no)
        .input("modified_by", sql.NVarChar, modified_by)
        .query(`EXEC sp_quotation_hdr @mode,@company_code,'','','','','','','','','','',@transaction_no,'',0,0,0,0,0,0,0,0,0,'','','','',@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    } catch (err) {
      if (err.number === 547) {
        // Foreign key constraint violation
        res.status(400).json("first delete the quote details  ");
        return;
      } else {
        throw err; // Rethrow other SQL errors
      }
    }
    res.status(200).json("Quotation  deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getAllquotedetData = async (req, res) => {
  const { company_code } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "A") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_quotation_details 'A',@company_code,'','','','',0,'','','',0,0,0,0,0,0,'','','','','',
NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const addquotationdetail = async (req, res) => {
  const { company_code, Entry_date, transaction_no, warehouse_code, customer_code, ItemSNo, item_code, item_name, bill_qty, bill_rate,
    item_amt, tax_amount, weight, total_weight, cutomer_name, hsn, Description, created_by, modified_by,
    tempstr1, tempstr2, tempstr3, tempstr4, datetime1, datetime2, datetime3, datetime4,

  } = req.body;

  let item_images = null;

  if (req.file) {
    item_images = req.file.buffer; // Buffer containing the uploaded image
  }

  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("Entry_date", sql.NVarChar, Entry_date)
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("warehouse_code", sql.NVarChar, warehouse_code)
      .input("customer_code", sql.NVarChar, customer_code)
      .input("ItemSNo", sql.BigInt, ItemSNo)
      .input("item_code", sql.NVarChar, item_code)
      .input("item_name", sql.NVarChar, item_name)
      .input("item_images", sql.VarBinary, item_images)
      .input("bill_qty", sql.Decimal(10, 2), bill_qty)
      .input("bill_rate", sql.Decimal(10, 2), bill_rate)
      .input("item_amt", sql.Decimal(10, 2), item_amt)
      .input("tax_amount", sql.Decimal(10, 2), tax_amount)
      .input("weight", sql.Decimal(8, 3), weight)
      .input("total_weight", sql.Decimal(10, 2), total_weight)
      .input("cutomer_name", sql.NVarChar, cutomer_name)
      .input("hsn", sql.NVarChar, hsn)
      .input("Description", sql.NVarChar, Description)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(
        `EXEC sp_quotation_details @mode,@company_code,@Entry_date,@transaction_no,@warehouse_code,@customer_code,@ItemSNo,@item_code,@item_name,@item_images,@bill_qty,@bill_rate,
        @item_amt,@tax_amount,@weight,@total_weight,@cutomer_name,
        @hsn,@Description,@created_by,@modified_by,
        @tempstr1,@tempstr2,@tempstr3,@tempstr4,@datetime1,@datetime2,@datetime3,@datetime4`);
    res.json({ success: true, message: "Data inserted successfully" });
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const quotedeletedetData = async (req, res) => {
  // const purch_autonosToDelete = req.body.purch_autonos;
  const { company_code, transaction_no } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    try {
      await pool
        .request()
        .input("mode", sql.NVarChar, "D")
        .input("company_code", sql.NVarChar, company_code)
        .input("transaction_no", sql.NVarChar, transaction_no)
        .query(`EXEC sp_quotation_details 'D',@company_code,'',@transaction_no,'','',0,'','','',0,0,0,0,0,0,'','','','','',
                NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    } catch (err) {
      if (err.number === 547) {
        // Foreign key constraint violation
        res.status(400).json("check the data properly  ");
        return;
      } else {
        throw err; // Rethrow other SQL errors
      }
    }

    res.status(200).json("Quotation deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//code ends

const refNumberToQuotationHeaderPrintData = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool.request()
      .input("mode", sql.NVarChar, "QH")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_print @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    // Process result sets
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const refNumberToQuotationDetailPrintData = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool.request()
      .input("mode", sql.NVarChar, "QD")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_print @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    // Process result sets
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getAllquotetaxData = async (req, res) => {
  const { company_code } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "A") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_quotation_tax_details 'A',@company_code,'','','',0,0,'','','','',0,0,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const addquotetaxdetail = async (req, res) => {
  const {
    company_code, Entry_date, transaction_no, customer_code, ItemSNo, TaxSNo, item_code, item_name, tax_type, tax_name_details, tax_amt, tax_per, tax_acode,
    created_by, modified_by,
    tempstr1, tempstr2, tempstr3, tempstr4, datetime1, datetime2, datetime3, datetime4,

  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("Entry_date", sql.Date, Entry_date)
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("customer_code", sql.NVarChar, customer_code)
      .input("ItemSNo", sql.BigInt, ItemSNo)
      .input("TaxSNo", sql.BigInt, TaxSNo)
      .input("item_code", sql.NVarChar, item_code)
      .input("item_name", sql.NVarChar, item_name)
      .input("tax_type", sql.NVarChar, tax_type)
      .input("tax_name_details", sql.NVarChar, tax_name_details)
      .input("tax_amt", sql.Decimal(14, 2), tax_amt)
      .input("tax_per", sql.Decimal(14, 2), tax_per)
      .input("tax_acode", sql.NVarChar, tax_acode)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(
        `EXEC sp_quotation_tax_details @mode,@company_code,@Entry_date,@transaction_no,@customer_code,@ItemSNo,@TaxSNo,@item_code,@item_name,@tax_type,@tax_name_details,
    @tax_amt,@tax_per,@tax_acode,@created_by,@modified_by,@tempstr1,@tempstr2,@tempstr3,@tempstr4,@datetime1,@datetime2,@datetime3,@datetime4`);
    res.json({ success: true, message: "Data inserted successfully" });
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const quoteDeleteTaxData = async (req, res) => {
  const { company_code, transaction_no } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    try {
      await pool
        .request()
        .input("mode", sql.NVarChar, "D")
        .input("company_code", sql.NVarChar, company_code)
        .input("transaction_no", sql.NVarChar, transaction_no)
        .query(`EXEC sp_quotation_tax_details 'D',@company_code,'',@transaction_no,'',0,0,'','','','',0,0,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    } catch (err) {
      if (err.number === 547) {
        // Foreign key constraint violation
        res.status(400).json("first delete the quotation details and tax details data");
        return;
      } else {
        throw err; // Rethrow other SQL errors
      }
    }
    res.status(200).json("quotation tax deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const refNumberToQuoteSumTax = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "QP")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_tax_Print @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const deliverychallanhdrprint = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "DCH")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_print @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
}

const deliverychallandetprint = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool.request()
      .input("mode", sql.NVarChar, "DCD")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_print @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    // Process result sets
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};



const addProductHeader = async (req, res) => {
  const { company_code, Product_Code, HSN_code, Product_name, description, status, Product_price, tax_type, Other_sales_taxtype, created_by, modified_by, tempstr1, tempstr2, tempstr3, tempstr4, datetime1, datetime2, datetime3, datetime4 } = req.body;
  let Product_img = null;

  if (req.file) {
    Product_img = req.file.buffer; // Buffer containing the uploaded image
  }

  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I")
      .input("company_code", sql.NVarChar, company_code)
      .input("Product_Code", sql.NVarChar, Product_Code)
      .input("Product_name", sql.NVarChar, Product_name)
      .input("HSN_code", sql.NVarChar, HSN_code)
      .input("description", sql.NVarChar, description)
      .input("status", sql.NVarChar, status)
      .input("Product_price", sql.Decimal(12, 2), Product_price)
      .input("tax_type", sql.NVarChar, tax_type)
      .input("Product_img", sql.VarBinary, Product_img)
      .input("Other_sales_taxtype", sql.VarChar, Other_sales_taxtype)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(
        `EXEC sp_Product_Header @mode,@company_code,@Product_Code,@Product_name,@HSN_code,@description,@status,@Product_price,@tax_type,@Product_img,@Other_sales_taxtype,@created_by,@modified_by,@tempstr1,@tempstr2,@tempstr3,@tempstr4,@datetime1,@datetime2,@datetime3,@datetime4`);
    // Return success response
    if (result.rowsAffected && result.rowsAffected[0] > 0) {
      return res.status(200).json(result.recordset);
    }
  } catch (err) {
    {
      // Handle unexpected errors
      res.status(500).json({ message: err.message || 'Internal Server Error' });
    }
  }
};


const getAllproducthdrData = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`EXEC sp_Product_Header 'A','','','','','','',0,'','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const productdeletehdrData = async (req, res) => {
  const { company_code, Product_Code } = req.body;


  const pool = await connection.connectToDatabase();
  try {
    await pool
      .request()
      .input("mode", sql.NVarChar, "D")
      .input("company_code", sql.NVarChar, company_code)
      .input("Product_Code", sql.NVarChar, Product_Code)
      .query(`EXEC sp_Product_Header @mode,@company_code,@Product_Code,'','','','',0,'','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    res.status(200).json("product deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};







//code added by AK on 27 aug 2024 // code begins
const addPurchaseOrderheader = async (req, res) => {
  const { company_code, Entry_date, transaction_no, vendor_code,
    purchase_amount, add_fright, less_fright, tax_amount, rounded_off, loading_charges, cartage_paid, other_charges, total_amount, tax_acc_code, rounded_off_acc_code, loading_charges_acc_code, cartage_paid_acc_code, other_charges_acc_code, purchase_amount_acc_code, delivery_date, credit, remarks, created_by, modified_by,
    tempstr1, tempstr2, tempstr3, tempstr4, datetime1, datetime2, datetime3, datetime4,
  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I")
      .input("company_code", sql.NVarChar, company_code)
      .input("Entry_date", sql.Date, Entry_date)
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("vendor_code", sql.NVarChar, vendor_code)
      .input("purchase_amount", sql.Decimal(14, 2), purchase_amount)
      .input("add_fright", sql.Decimal(14, 2), add_fright)
      .input("less_fright", sql.Decimal(14, 2), less_fright)
      .input("tax_amount", sql.Decimal(14, 2), tax_amount)
      .input("rounded_off", sql.Decimal(14, 2), rounded_off)
      .input("loading_charges", sql.Decimal(14, 2), loading_charges)
      .input("cartage_paid", sql.Decimal(14, 2), cartage_paid)
      .input("other_charges", sql.Decimal(14, 2), other_charges)
      .input("total_amount", sql.Decimal(10, 2), total_amount)
      .input("tax_acc_code", sql.NVarChar, tax_acc_code)
      .input("rounded_off_acc_code", sql.NVarChar, rounded_off_acc_code)
      .input("loading_charges_acc_code", sql.NVarChar, loading_charges_acc_code)
      .input("cartage_paid_acc_code", sql.NVarChar, cartage_paid_acc_code)
      .input("other_charges_acc_code", sql.NVarChar, other_charges_acc_code)
      .input("purchase_amount_acc_code", sql.NVarChar, purchase_amount_acc_code)
      .input("delivery_date", sql.Date, delivery_date)
      .input("credit", sql.NVarChar, credit)
      .input("remarks", sql.NVarChar, remarks)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(`EXEC sp_purchase_order_hdr @mode,@company_code, @Entry_date,@transaction_no,@vendor_code, @purchase_amount,@add_fright,@less_fright,@tax_amount,@rounded_off,@loading_charges,@cartage_paid,@other_charges,@total_amount,@tax_acc_code,@rounded_off_acc_code,
        @loading_charges_acc_code,  @cartage_paid_acc_code, @other_charges_acc_code,@purchase_amount_acc_code,@delivery_date,@credit,@remarks,
        @created_by, @modified_by, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
const getAllPOhdrData = async (req, res) => {
  const { company_code } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "A")
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_purchase_order_hdr @mode,@company_code,'','','',0,0,0,0,0,0,0,0,00,'','','','','','','','','','','', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const POdeletehdrData = async (req, res) => {
  // const purch_autonosToDelete = req.body.purch_autonos;
  const { company_code, transaction_no, modified_by } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    try {
      await pool
        .request()
        .input("mode", sql.NVarChar, "D")
        .input("company_code", sql.NVarChar, company_code)
        .input("transaction_no", sql.NVarChar, transaction_no)
        .input("modified_by", sql.NVarChar, modified_by)
        .query(`EXEC sp_purchase_order_hdr @mode,@company_code,'',@transaction_no,'',0,0,0,0,0,0,0,0,0,'','','','','','','','','','',@modified_by, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL`);
    } catch (error) {
      if (error.number === 547) {
        res.status(400).json("first delete the Purchase Order details  ");
        return;
      } else {
        throw error; // Rethrow other SQL errors
      }
    }
    res.status(200).json("Purchase order  deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const getItemCodeQuotation = async (req, res) => {
  const { Item_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "STPI")
      .input("Item_code", sql.NVarChar, Item_code)
      .query(`EXEC sp_item_brand_info @mode,'',@Item_code,'','',0,'','','',0,0,0,
          0,'','','','','','','','','','','','',0,0,'','','',NULL,NULL,NULL,NULL,NULL
    ,NULL,NULL,NULL `);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
const addPurchaseOrderdetail = async (req, res) => {
  const { company_code, Entry_date, transaction_no, vendor_code, vendor_name, vendor_addr_1, vendor_addr_2, vendor_addr_3, vendor_addr_4, ShipTo_customer_name, ShipTo_customer_addr_1, ShipTo_customer_addr_2, ShipTo_customer_addr_3, ShipTo_customer_addr_4,
    ItemSNo, item_code, item_name, bill_qty, bill_rate, item_amt, weight, total_weight, tax_amount, hsn, contact_person, contact_number, ship_to_contact_number, ship_to_contact_person, state, country, ship_to_state, ship_to_country,
    ShipTo_customer_code, vendor_gst_no, ShipTo_vendor_gst_no, created_by, modified_by, tempstr1, tempstr2, tempstr3, tempstr4, datetime1, datetime2, datetime3, datetime4
  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("Entry_date", sql.Date, Entry_date)
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("vendor_code", sql.NVarChar, vendor_code)
      .input("vendor_name", sql.NVarChar, vendor_name)
      .input("vendor_addr_1", sql.NVarChar, vendor_addr_1)
      .input("vendor_addr_2", sql.NVarChar, vendor_addr_2)
      .input("vendor_addr_3", sql.NVarChar, vendor_addr_3)
      .input("vendor_addr_4", sql.NVarChar, vendor_addr_4)
      .input("ShipTo_customer_name", sql.NVarChar, ShipTo_customer_name)
      .input("ShipTo_customer_addr_1", sql.NVarChar, ShipTo_customer_addr_1)
      .input("ShipTo_customer_addr_2", sql.NVarChar, ShipTo_customer_addr_2)
      .input("ShipTo_customer_addr_3", sql.NVarChar, ShipTo_customer_addr_3)
      .input("ShipTo_customer_addr_4", sql.NVarChar, ShipTo_customer_addr_4)
      .input("ItemSNo", sql.BigInt, ItemSNo)
      .input("item_code", sql.NVarChar, item_code)
      .input("item_name", sql.NVarChar, item_name)
      .input("bill_qty", sql.Decimal(14, 2), bill_qty)
      .input("bill_rate", sql.Decimal(14, 2), bill_rate)
      .input("item_amt", sql.Decimal(14, 2), item_amt)
      .input("weight", sql.Decimal(14, 2), weight)
      .input("total_weight", sql.Decimal(14, 2), total_weight)
      .input("tax_amount", sql.Decimal(14, 2), tax_amount)
      .input("hsn", sql.NVarChar, hsn)
      .input("contact_person", sql.NVarChar, contact_person)
      .input("contact_number", sql.NVarChar, contact_number)
      .input("ship_to_contact_number", sql.NVarChar, ship_to_contact_number)
      .input("ship_to_contact_person", sql.NVarChar, ship_to_contact_person)
      .input("state", sql.NVarChar, state)
      .input("country", sql.NVarChar, country)
      .input("ship_to_state", sql.NVarChar, ship_to_state)
      .input("ship_to_country", sql.NVarChar, ship_to_country)
      .input("ShipTo_customer_code", sql.NVarChar, ShipTo_customer_code)
      .input("vendor_gst_no", sql.NVarChar, vendor_gst_no)
      .input("ShipTo_vendor_gst_no", sql.NVarChar, ShipTo_vendor_gst_no)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(`EXEC sp_purchase_order_details @mode,@company_code,@Entry_date,@transaction_no,@vendor_code, @vendor_name,@vendor_addr_1,@vendor_addr_2,@vendor_addr_3,@vendor_addr_4,@ShipTo_customer_name,@ShipTo_customer_addr_1,@ShipTo_customer_addr_2,@ShipTo_customer_addr_3,@ShipTo_customer_addr_4,@ItemSNo,
            @item_code,@item_name, @bill_qty,@bill_rate,@item_amt,@weight,@total_weight,@tax_amount,@hsn,@contact_person,@contact_number,@ship_to_contact_number,@ship_to_contact_person,@state,@country,@ship_to_state,@ship_to_country,@ShipTo_customer_code,
            @vendor_gst_no,@ShipTo_vendor_gst_no,@created_by, @modified_by, NULL, NULL, NULL, NULL, NULL, NULL, NULL,NULL`);
    {
      res.status(200).json("data inserted successfully");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getAllPOdetData = async (req, res) => {
  const { company_code } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "A") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_purchase_order_details 'A',@company_code,'','','','','','','','','','','', '','',0,'','',0,0,0,0,0,0,'','','','','','','','','','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const POdeletedetData = async (req, res) => {
  // const purch_autonosToDelete = req.body.purch_autonos;
  const { company_code, transaction_no } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    try {
      await pool
        .request()
        .input("mode", sql.NVarChar, "D")
        .input("company_code", sql.NVarChar, company_code)
        .input("transaction_no", sql.NVarChar, transaction_no)
        .query(`EXEC sp_purchase_order_details 'D',@company_code,'',@transaction_no,'','','','','','','','','', '','',0,'','',0,0,0,0,0,0,'','','','','','','','','','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    } catch (err) {
      if (err.number === 547) {
        res.status(400).json("first delete the Purchase order details  ");
        return;
      } else {
        throw err; // Rethrow other SQL errors
      }
    }

    res.status(200).json(" Purchase order deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const getAllPOtaxData = async (req, res) => {
  const { company_code } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "A") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_purchase_order_tax_details 'A',@company_code,'','','',0,0,'','','','',0,0,'','',''
,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const addPOtaxdetail = async (req, res) => {
  const {
    company_code, Entry_date, transaction_no, vendor_code, ItemSNo, TaxSNo, item_code, item_name, tax_type, tax_name_details, tax_amt, tax_per, tax_acode,
    created_by, modified_by,
    tempstr1, tempstr2, tempstr3, tempstr4, datetime1, datetime2, datetime3, datetime4,

  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("Entry_date", sql.Date, Entry_date)
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("vendor_code", sql.NVarChar, vendor_code)
      .input("ItemSNo", sql.BigInt, ItemSNo)
      .input("TaxSNo", sql.BigInt, TaxSNo)
      .input("item_code", sql.NVarChar, item_code)
      .input("item_name", sql.NVarChar, item_name)
      .input("tax_type", sql.NVarChar, tax_type)
      .input("tax_name_details", sql.NVarChar, tax_name_details)
      .input("tax_amt", sql.Decimal(14, 2), tax_amt)
      .input("tax_per", sql.Decimal(14, 2), tax_per)
      .input("tax_acode", sql.NVarChar, tax_acode)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(
        `EXEC sp_purchase_order_tax_details @mode,@company_code,@Entry_date,@transaction_no,@vendor_code,@ItemSNo,@TaxSNo,@item_code,@item_name,@tax_type,@tax_name_details,
        @tax_amt,@tax_per,@tax_acode,@created_by,@modified_by,@tempstr1,@tempstr2,@tempstr3,@tempstr4,@datetime1,@datetime2,@datetime3,@datetime4`);
    res.json({ success: true, message: "Data inserted successfully" });
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const PODeleteTaxData = async (req, res) => {
  const { company_code, transaction_no } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    await pool
      .request()
      .input("mode", sql.NVarChar, "D")
      .input("company_code", sql.NVarChar, company_code)
      .input("transaction_no", sql.NVarChar, transaction_no)
      .query(`EXEC sp_purchase_order_tax_details 'D',@company_code,'',@transaction_no,'',0,0,'','','','',0,0,'','',''
                 ,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);

    res.status(200).json("Purchase order tax deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const purchaseOrderhdrprint = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool.request()
      .input("mode", sql.NVarChar, "POH")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_print @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    // Process result sets
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const purchaseOrderdetprint = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool.request()
      .input("mode", sql.NVarChar, "POD")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_print @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    // Process result sets
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const refNumberToPOSumTax = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "POP")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_tax_Print @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const getProducthdrcode = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "PF")
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_Product_Header @mode,@company_code,'','','','','',0,'','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const addProductdet = async (req, res) => {
  const { company_code, Product_Code, Product_name, item_name, item_code, quantity, tot_amt, description, status, Item_SNo,
    datastatus, created_by, modified_by, tempstr1, tempstr2, tempstr3, tempstr4, datetime1, datetime2, datetime3, datetime4 } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("Product_Code", sql.NVarChar, Product_Code)
      .input("Product_name", sql.NVarChar, Product_name)
      .input("item_name", sql.NVarChar, item_name)
      .input("item_code", sql.NVarChar, item_code)
      .input("quantity", sql.Decimal(10, 2), quantity)
      .input("tot_amt", sql.Decimal(12, 2), tot_amt)
      .input("description", sql.NVarChar, description)
      .input("status", sql.NVarChar, status)
      .input("Item_SNo", sql.BigInt, Item_SNo)
      .input("datastatus", sql.VarChar, datastatus)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(`EXEC sp_Product_details @mode,@company_code,@Product_Code,@Product_name,@item_name,@item_code,@quantity,0,0,@description,@status,@Item_SNo,@datastatus,@created_by,@modified_by,@tempstr1,@tempstr2,@tempstr3,@tempstr4,@datetime1,@datetime2,@datetime3,@datetime4`);
    res.json({ success: true, message: "Data inserted successfully" });
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const productDeleteDetails = async (req, res) => {
  const { company_code, Product_Code } = req.body;

  const pool = await connection.connectToDatabase();
  try {
    await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .input("Product_Code", sql.NVarChar, Product_Code)
      .query(`EXEC sp_Product_details 'D',@company_code,@Product_Code,'','','',0,0,0,'','','','','','','','','','','','','',''`);

    res.status(200).json("Product  deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
// const delproductdetdata = async (req, res) => {
//   const { productcode_todelete, } = req.body;

//   // if (!productcode_todelete || !productcode_todelete.length ) {
//   //   res.status(400).json("Invalid or empty Codes or codeDetails array.");
//   //   return;
//   // }

//   try {
//     const pool = await connection.connectToDatabase();

//     const deleteQuery = `EXEC sp_Product_details 'D',@Product_Code,'','','',0,0,0,'','',0,'',@modified_by,'','','','','','','',''`;
//     for (const Product_Code of productcode_todelete) {
//       try {
//       await pool.request()
//                 .input("company_code", sql.NVarChar,  company_code)
//                 .input("Product_Code", sql.NVarChar,  Product_Code)
//                 .input("modified_by",  sql.NVarChar, req.headers['modified-by']) 
//                 .query(deleteQuery);
//               } catch (error) {
//                 if (error.number === 50000) {
//                   res.status(400).json("The attribute cannot be deleted due to a link with another record");
//                   return;
//                 } else {
//                   throw error; 
//                 }
//               }
//     }

//     res.status(200).json("Product data deleted successfully");
//   } catch (error) {
//     console.error(error);
//     res.status(500).json({ message: err.message || 'Internal Server Error' });
//   } finally {
//     connection.closeDatabaseConnection();
//   }
// };



const ProudctUpdate = async (req, res) => {
  const { company_code, Product_Code, Product_name, item_name, item_code, quantity, tot_amt, description, status, Item_SNo, modified_by } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "U") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("Product_Code", sql.NVarChar, Product_Code)
      .input("Product_name", sql.NVarChar, Product_name)
      .input("item_name", sql.NVarChar, item_name)
      .input("item_code", sql.NVarChar, item_code)
      .input("quantity", sql.Decimal(10, 2), quantity)
      .input("tot_amt", sql.Decimal(12, 2), tot_amt)
      .input("description", sql.NVarChar, description)
      .input("status", sql.NVarChar, status)
      .input("Item_SNo", sql.BigInt, Item_SNo)
      .input("modified_by", sql.NVarChar, modified_by)
      .query(`EXEC sp_Product_details @mode,@company_code,@Product_Code,@Product_name,@item_name,@item_code,@quantity,0,@tot_amt,@description,@status,@Item_SNo,'','',@modified_by,'','','','','','','',''`);
    res.json({ success: true, message: "Data inserted successfully" });
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};



// const ProudctUpdate = async (req, res) => {
//   const {Product_Code, updatedData} = req.body;

//   // if (!Product_Code || !Product_Code.length ||
//   //   !updatedData || !updatedData.length) {
//   //   res.status(400).json("Invalid or empty Product_Code array.");
//   //   return;
//   // }

//   try {
//     const pool = await connection.connectToDatabase();

//     for (let i = 0; i < Product_Code.length; i++) {
//       const updatedRow = updatedData[i]; // Assuming updatedData is an array of objects with updated values
//       await pool
//         .request()
//         .input("mode",               sql.NVarChar, "U") // update mode
//         .input("Product_Code",       Product_Code[i])  
//         .input("Product_name",       sql.NVarChar, updatedRow.Product_name)
//         .input("description",        sql.NVarChar, updatedRow.description)
//         .input("status",             sql.NVarChar, updatedRow.status)
//         .input("created_by",         sql.NVarChar, updatedRow.created_by)
//         .input("modified_by",        sql.NVarChar, req.headers['modified-by'])  
//         .input("tempstr1",           sql.NVarChar, updatedRow.tempstr1)
//         .input("tempstr2",           sql.NVarChar, updatedRow.tempstr2)
//         .input("tempstr3",           sql.NVarChar, updatedRow.tempstr3)
//         .input("tempstr4",           sql.NVarChar, updatedRow.tempstr4)
//         .input("datetime1",          sql.NVarChar, updatedRow.datetime1)
//         .input("datetime2",          sql.NVarChar, updatedRow.datetime2)
//         .input("datetime3",          sql.NVarChar, updatedRow.datetime3)
//         .input("datetime4",          sql.NVarChar, updatedRow.datetime4)
//         .query(
//           `EXEC sp_Product_details @mode,@Product_Code,@Product_name,@item_name,@item_code,@quantity,@tax,@tot_amt,@description,@status,@Item_SNo,@created_by,@modified_by,
//           @tempstr1,@tempstr2,@tempstr3,@tempstr4,@datetime1,@datetime2,@datetime3,@datetime4  `
//         );
//     }

//     res.status(200).json("Product data updated successfully");
//   } catch (error) {
//     console.error(error);
//     res.status(500).json({ message: err.message || 'Internal Server Error' });
//   } finally {
//     connection.closeDatabaseConnection();
//   }
// };



const getItemCodeDcData = async (req, res) => {
  const { Item_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "STIDC")
      .input("Item_code", sql.NVarChar, Item_code)
      .query(`EXEC sp_item_brand_info @mode,'',@Item_code,'','',0,'','','',0,0,0,
                  0,'','','','','','','','','','','','',0,0,'','','',NULL,NULL,NULL,NULL,NULL
            ,NULL,NULL,NULL `);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getDcSearchData = async (req, res) => {
  const { company_code, transaction_no, transaction_date, customer_name, ShipTo_customer_name } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("company_code", sql.NVarChar, company_code)
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("transaction_date", sql.NVarChar, transaction_date)
      .input("customer_name", sql.NVarChar, customer_name)
      .input("ShipTo_customer_name", sql.NVarChar, ShipTo_customer_name)
      .query(`EXEC sp_delivery_challan_hdr @mode,@company_code,@transaction_no,@transaction_date,0,'','',@customer_name,'','',
                           '','','','','','','',@ShipTo_customer_name,'','','','','','','','','',0,0,0,0,0,0,0,'','','','',0,'','','','','','','','','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const getDcDetailView = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "DCD")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)

      // .input("status", sql.NVarChar, status)
      .query(`EXEC sp_getdata @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const getQuotationSearchData = async (req, res) => {
  const { company_code, transaction_no, Entry_date, customer_name, contact_person } = req.body;
  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();
    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("company_code", sql.NVarChar, company_code)
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("Entry_date", sql.NVarChar, Entry_date)
      .input("customer_name", sql.NVarChar, customer_name)
      .input("contact_person", sql.NVarChar, contact_person)
      .query(`EXEC sp_quotation_hdr @mode,@company_code,@customer_name,'','','','','','','',@contact_person,@Entry_date,@transaction_no,'',0,0,0,0,0,0,0,0,0,'','','','','', NULL, NULL, NULL,NULL,NULL,NULL,NULL,NULL`);
    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getQuotationDetailView = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "QVD")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)

      .query(`EXEC sp_getdata @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getQuotationTaxDetailView = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "QVT")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)

      .query(`EXEC sp_getdata @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getPOSearchData = async (req, res) => {
  const { transaction_no, company_code, Entry_date, vendor_name, ShipTo_customer_name } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .input("Entry_date", sql.NVarChar, Entry_date)
      .input("vendor_name", sql.NVarChar, vendor_name)
      .input("ShipTo_customer_name", sql.NVarChar, ShipTo_customer_name)
      .query(`EXEC sp_purchase_order_details @mode,@company_code,@Entry_date,@transaction_no,'',@vendor_name,'','','','',@ShipTo_customer_name,'',
'', '','',0,'','',0,0,0,0,0,0,'','','','','','','','','','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const getPODetailView = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "POD")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_getdata @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const getPOTaxDetailView = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "POT")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_getdata @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

//code ends


const getproductsearch = async (req, res) => {
  const { company_code, Product_Code, Product_name, item_code, item_name, tax_name_details, tax_percentage, tax_type } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("company_code", sql.NVarChar, company_code)
      .input("Product_Code", sql.NVarChar, Product_Code)
      .input("Product_name", sql.NVarChar, Product_name)
      .input("item_code", sql.NVarChar, item_code)
      .input("item_name", sql.NVarChar, item_name)
      .input("tax_name_details", sql.NVarChar, tax_name_details)
      .input("tax_percentage ", sql.NVarChar, tax_percentage)
      .input("tax_type", sql.NVarChar, tax_type)
      .query(`EXEC sp_Product_details @mode, @company_code, @Product_Code,@Product_name,@item_name ,@item_code,0,0,0,'','',0,'','','','','','','','','','',''`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};



const getQuotation = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "QS")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_getdata @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Check if data is found
    if (result.recordsets && result.recordsets.length > 0 && result.recordsets[0].length > 0) {
      const data = {
        Header: result.recordsets[0],
        Detail: result.recordsets[1] || [], // Provide an empty array if no data
        TaxDetail: result.recordsets[2] || [], // Provide an empty array if no data
        Terms: result.recordsets[3] || []  // Provide an empty array if no data

      };
      res.status(200).json(data); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const getDeliveryChallan = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "DCS")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_getdata @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    if (result.recordsets && result.recordsets.length > 0 && result.recordsets[0].length > 0) {
      const data = {
        Header: result.recordsets[0],
        Detail: result.recordsets[1] || [],
        Terms: result.recordsets[2] || [],
      };
      res.status(200).json(data);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const getPurchaseOrder = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "POS")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_getdata @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    if (result.recordsets && result.recordsets.length > 0 && result.recordsets[0].length > 0) {
      const data = {
        Header: result.recordsets[0],
        Detail: result.recordsets[1] || [],
        TaxDetail: result.recordsets[2] || [],
        Terms: result.recordsets[3] || []

      };
      res.status(200).json(data);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};






const getQuotationPeriod = async (req, res) => {
  const { mode, company_code, StartDate, EndDate, customer_name, customer_addr_1, customer_mobile_no, transaction_no } = req.body;
  let pool;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, mode)
      .input("company_code", sql.NVarChar, company_code)
      .input("StartDate", sql.NVarChar, StartDate)
      .input("EndDate", sql.NVarChar, EndDate)
      .input("customer_name", sql.NVarChar, customer_name)
      .input("customer_addr_1", sql.NVarChar, customer_addr_1)
      .input("customer_mobile_no", sql.NVarChar, customer_mobile_no)
      .input("transaction_no", sql.NVarChar, transaction_no)
      .query(`EXEC sp_quotation_period @mode,@company_code,@StartDate,@EndDate,@customer_name,@customer_addr_1,@customer_mobile_no,@transaction_no`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json('No data found');
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getPOperiod = async (req, res) => {
  const { mode, company_code, StartDate, EndDate, ShipTo_customer_addr_1, ShipTo_customer_name, vendor_name, transaction_no } = req.body;
  let pool;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, mode) // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("StartDate", sql.NVarChar, StartDate)
      .input("EndDate", sql.NVarChar, EndDate)
      .input("ShipTo_customer_addr_1", sql.NVarChar, ShipTo_customer_addr_1)
      .input("vendor_name", sql.NVarChar, vendor_name)
      .input("ShipTo_customer_name", sql.NVarChar, ShipTo_customer_name)
      .input("transaction_no", sql.NVarChar, transaction_no)
      .query(`EXEC sp_purchase_order_period @mode,@company_code,@StartDate,@EndDate,@ShipTo_customer_addr_1,@vendor_name,@ShipTo_customer_name,@transaction_no`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      // Send a 404 Not Found status if no data is found
      res.status(404).json('No data found');
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getDCperiod = async (req, res) => {
  const { mode, company_code, StartDate, EndDate, transaction_no, customer_name, ShipTo_customer_name, ShipTo_customer_addr_1 } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, mode) // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("StartDate", sql.NVarChar, StartDate)
      .input("EndDate", sql.NVarChar, EndDate)
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("customer_name", sql.NVarChar, customer_name)
      .input("ShipTo_customer_name", sql.NVarChar, ShipTo_customer_name)
      .input("ShipTo_customer_addr_1", sql.NVarChar, ShipTo_customer_addr_1)
      .query(`EXEC sp_Delivery_challan_period @mode,@company_code,@StartDate,@EndDate,@transaction_no,@customer_name,@ShipTo_customer_name,@ShipTo_customer_addr_1`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      // Send a 404 Not Found status if no data is found
      res.status(404).json('No data found');
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

// const getDCperiod= async (req, res) => {
//   const {mode,StartDate,EndDate,transaction_no,customer_name,ShipTo_customer_name,ShipTo_customer_addr_1} = req.body;
//   let pool;
//   try {
//     const pool = await connection.connectToDatabase();
//     const result = await pool
//       .request()
//       .input("mode",                            sql.NVarChar, mode) // Insert mode
//       .input("StartDate",                        sql.NVarChar, StartDate) 
//       .input("EndDate",                          sql.NVarChar, EndDate)
//       .input("transaction_no",                    sql.NVarChar, transaction_no)
//       .input("customer_name",                     sql.NVarChar, customer_name )
//       .input("ShipTo_customer_name",              sql.NVarChar, ShipTo_customer_name )
//       .input("ShipTo_customer_addr_1",              sql.NVarChar, ShipTo_customer_addr_1 )
//       .query( `EXEC sp_Delivery_challan_period @mode,@StartDate,@EndDate,@transaction_no,@customer_name,@ShipTo_customer_name,@ShipTo_customer_addr_1`);
//     if (result.recordset.length > 0) {
//       res.status(200).json(result.recordset); // 200 OK if data is found
//     } else {
//       // Send a 404 Not Found status if no data is found
//       res.status(404).json('No data found');
//     }
//    } catch (err) {
//     console.error(err);
//     res.status(500).json({ message: err.message || 'Internal Server Error' });
//   }
// };

const purreturndeletehdrData = async (req, res) => {
  const { company_code, return_no } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    try {
      await pool.request()
        .input("company_code", company_code)
        .input("return_no", return_no)
        .input("modified_by", sql.NVarChar, req.headers['modified-by'])
        .query(`
              EXEC sp_purchase_return_hdr 'D',@company_code,'',@return_no,'','','','','','','',
'','',0,0,0,0,0,0,0,0,0,0,'','',0,'','','','',
'',NULL,NULL,NULL,NULL,NULL,NULL,NULL `);
    } catch (error) {
      if (error.number === 547) {
        // Foreign key constraint violation
        res.status(400).json("First Delete the purchase Details and Tax Details Data");
        return;
      } else {
        throw error; // Rethrow other SQL errors
      }
    }

    res.status(200).json("Purchase return deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const purreturndeletedetData = async (req, res) => {
  const { company_code, return_no } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    try {
      await pool.request()
        .input("return_no", return_no)
        .input("company_code", company_code)
        .input("modified_by", sql.NVarChar, req.headers['modified-by'])
        .query(`
             EXEC sp_purchase_return_details 'D',@company_code,'','','',@return_no,'','','','','',0,0,0,0,0,0,0,'','','','','','','','','','','','',0,'',0,'','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);
    } catch (error) {
      if (error.number === 547) {
        // Foreign key constraint violation
        res.status(400).json("First Delete the purchase Details and Tax Details Data");
        return;
      } else {
        throw error; // Rethrow other SQL errors
      }
    }

    res.status(200).json("Purchase return deleted successfully");
  } catch (err) {
    console.error(err);
    res.status(500).json(err.message || "Internal Server Error");
  }
};


const purreturndeletetaxdetData = async (req, res) => {
  const { company_code, return_no } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    try {
      await pool.request()
        .input("company_code", company_code)
        .input("return_no", return_no)
        .input("modified_by", sql.NVarChar, req.headers['modified-by'])
        .query(`
             EXEC sp_purchase_return_tax_details 'D',@company_code,'',@return_no,'','','','','','',0,0,'','','','',0,0,'','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);
    } catch (error) {
      if (error.number === 547) {
        // Foreign key constraint violation
        res.status(400).Json("First Delete the purchase Details and Tax Details Data");
        return;
      } else {
        throw error; // Rethrow other SQL errors
      }
    }

    res.status(200).json("Purchase return deleted successfully");
  } catch (err) {
    console.error(err);
    res.status(500).json(err.message || "Internal Server Error");
  }
};


const salereturndeletehdrData = async (req, res) => {
  const { company_code, return_no } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    try {
      await pool.request()
        .input("company_code", company_code)
        .input("return_no", return_no)
        .input("modified_by", sql.NVarChar, req.headers['modified-by'])
        .query(`EXEC sp_sales_return_hdr 'D',@company_code,'','','',@return_no,'','','','','','',0,0,0,0,0,0,0,0,0,0,0,0,0,
                      '','','','','','','','','','','',0,0,0,'','','',@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);
    } catch (error) {
      if (error.number === 547) {
        // Foreign key constraint violation
        res.status(400).json("First Delete the Sales Details and Tax Details Data");
        return;
      } else {
        throw error; // Rethrow other SQL errors
      }
    }

    res.status(200).json("Sales return deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const salereturndeletedetData = async (req, res) => {
  const { company_code, return_no } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    try {
      await pool.request()
        .input("company_code", company_code)
        .input("return_no", return_no)
        .input("modified_by", sql.NVarChar, req.headers['modified-by'])
        .query(`EXEC sp_sales_return_details 'D',@company_code,'','','',@return_no,'','','','','','','',0,0,0,0,0,0,0,'','','','','','','','','','','','',0,0,0,'','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    } catch (error) {
      if (error.number === 547) {
        // Foreign key constraint violation
        res.status(400).json("First Delete the Sales Details and Tax Details Data");
        return;
      } else {
        throw error; // Rethrow other SQL errors
      }
    }

    res.status(200).json("Sales return deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const salereturndeletetaxdetData = async (req, res) => {
  const { company_code, return_no } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    try {
      await pool.request()
        .input("company_code", company_code)
        .input("return_no", return_no)
        .input("modified_by", sql.NVarChar, req.headers['modified-by'])
        .query(`
              EXEC sp_sales_return_tax_details 'D',@company_code,'','',@return_no,'','','','','',0,0,'','','','',0,0,'','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    } catch (error) {
      if (error.number === 547) {
        // Foreign key constraint violation
        res.status(400).json("First Delete the Sales Details and Tax Details Data");
        return;
      } else {
        throw error; // Rethrow other SQL errors
      }
    }

    res.status(200).json("Sales return deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const ProductCodeDetail = async (req, res) => {
  const { company_code, Product_Code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "PC")
      .input("company_code", sql.NVarChar, company_code)
      .input("Product_Code", sql.NVarChar, Product_Code)
      .query(`EXEC sp_Product_details @mode,@company_code,@Product_Code,'','','',0,0,0,'','',0,'','','','','','','','','','',''`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const getAllsalesdetData = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(` EXEC sp_sales_details 'A','','','','','','',0,'',0,0,0,0,0,'','','','','','','','','','','','',0,'','',0,0,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    res.json(result.recordset);
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};



const addtestreport = async (req, res) => {
  const {
    user_code,
    user_name,
    date,
    Customer_name,
    QR_code
  } = req.body;

  let file = null;

  if (req.file) {
    file = req.file.buffer; // Buffer containing the uploaded image
  }
  try {
    pool = await sql.connect(dbConfig);

    // const bufferImage = Buffer.from(item_images, 'base64')

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("user_code", sql.NVarChar, user_code)
      .input("user_name", sql.NVarChar, user_name)
      .input("date", sql.Date, date)
      .input("file", sql.VarBinary, file)
      .input("Customer_name", sql.NVarChar, Customer_name)
      .input("QR_code", sql.NVarChar, QR_code)
      .query(
        `EXEC sp_testreport_uploads @mode,@user_code,@user_name,@file,@date,@Customer_name,@QR_code,'','','','','','','','','','',''`);

    // Return success response
    if (result.rowsAffected && result.rowsAffected[0] > 0) {
      return res.status(200).json({ success: true, message: 'Data inserted successfully' });
    }
  } catch (error) {
    if (error.class === 16 && error.number === 50000) {
      // Custom error from the stored procedure
      res.status(400).json({ message: 'Item already exists', error: error.message });
    } else {
      // Handle unexpected errors
      res.status(500).json({ message: 'Internal Server Error', error: error.message });
    }
  }

};




const gettestreports = async (req, res) => {
  const { QR_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "S")
      .input("QR_code", sql.NVarChar, QR_code)
      .query(`EXEC sp_testreport_uploads	@mode,'','','','','',@QR_code,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const getAlltestreports = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`EXEC sp_testreport_uploads	'A','','','','','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    res.json(result.recordset);
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const Updtestreport = async (req, res) => {

  const {
    QR_code,
    suggestions
  } = req.body;


  try {
    pool = await sql.connect(dbConfig);

    // const bufferImage = Buffer.from(item_images, 'base64')

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "U") // Insert mode
      .input("QR_code", sql.NVarChar, QR_code)
      .input("suggestions", sql.NVarChar, suggestions)
      .query(
        `EXEC sp_testreport_uploads @mode,'','','','','',@QR_code,@suggestions,'','','','','','','','','',''`);

    // Return success response
    if (result.rowsAffected && result.rowsAffected[0] > 0) {
      return res.status(200).json({ success: true, message: 'Data inserted successfully' });
    }
  } catch (error) {
    if (error.class === 16 && error.number === 50000) {
      // Custom error from the stored procedure
      res.status(400).json({ message: 'Item already exists', error: error.message });
    } else {
      // Handle unexpected errors
      res.status(500).json({ message: 'Internal Server Error', error: error.message });
    }
  }

};



const RollMappingDelete = async (req, res) => {
  const keyfieldToDelete = req.body.keyfield;

  try {
    const pool = await connection.connectToDatabase();
    for (const keyfield of keyfieldToDelete) {

      try {
        await pool.request()
          .input("keyfield", keyfield)
          .input("modified_by", sql.NVarChar, req.headers['modified-by'])
          .query(` EXEC sp_user_rolemapping 'D','','','','','',@keyfield,'', @modified_by,null,null,null,null,null,null,null,null
            `);
      } catch (error) {
        if (error.number === 547) {
          // Foreign key constraint violation
          res.status(400).json("First Delete the RoleMapping header");
          return;
        } else {
          throw error; // Rethrow other SQL errors
        }
      }
    }
    res.status(200).json("RoleMapping Deleted Successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const purchaseEditHeader = async (req, res) => {
  const { company_code, transaction_no, Entry_date, pay_type, purchase_type, purchase_amount, total_amount, rounded_off, tax_amount, modified_by } = req.body;
  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "U")
      .input("company_code", sql.NVarChar, company_code)
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("Entry_date", sql.NVarChar, Entry_date)
      .input("pay_type", sql.NVarChar, pay_type)
      .input("purchase_type", sql.NVarChar, purchase_type)
      .input("purchase_amount", sql.Decimal(14, 2), purchase_amount)
      .input("total_amount", sql.Decimal(10, 2), total_amount)
      .input("rounded_off", sql.Decimal(14, 2), rounded_off)
      .input("tax_amount", sql.Decimal(14, 2), tax_amount)
      .input("modified_by", sql.NVarChar, modified_by)
      .query(`EXEC sp_purchase_hdr @mode,@company_code,@Entry_date,@transaction_no,'',@purchase_type,'','',@pay_type, @purchase_amount,'',@total_amount,0,0,@tax_amount,'',@rounded_off,'',0,
          '', 0, '',0, '','', '', '', '','','', @modified_by, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL`);
    res.json({ success: true, message: "Data inserted successfully" });
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
const updateRoleMapping = async (req, res) => {
  const editedData = req.body.editedData;

  if (!editedData || !editedData.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }
  try {
    const pool = await connection.connectToDatabase(dbConfig);

    for (const updatedRow of editedData) {
      await pool
        .request()
        .input("mode", sql.NVarChar, "U")
        .input("company_code", sql.NVarChar, req.headers['company_code'])
        .input("user_code", updatedRow.user_code)
        .input("role_id", updatedRow.role_id)
        .input("keyfield", updatedRow.keyfield)
        .input("created_by", updatedRow.created_by)
        .input("modified_by", sql.NVarChar, req.headers['modified-by'])
        .input("tempstr1", updatedRow.tempstr1)
        .input("tempstr2", updatedRow.tempstr2)
        .input("tempstr3", updatedRow.tempstr3)
        .input("tempstr4", updatedRow.tempstr4)
        .input("datetime1", updatedRow.datetime1)
        .input("datetime2", updatedRow.datetime2)
        .input("datetime3", updatedRow.datetime3)
        .input("datetime4", updatedRow.datetime4)
        .query(`EXEC sp_user_rolemapping @mode,@company_code,@user_code,'',@role_id,'',@keyfield,@created_by,@modified_by,@tempstr1,@tempstr2,@tempstr3,@tempstr4,@datetime1,@datetime2,@datetime3,@datetime4`);
    }

    res.status(200).json("Edited data saved successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const getUserRole = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        `EXEC sp_role_info 'UR',@company_code,'','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`
      );

    res.json(result.recordset);
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const getAllInventoryReceiptsDetails = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`EXEC sp_InventoryReceipts_Details 'A','','','','','','',0,'','','',0,'','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    res.json(result.recordset);
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const addInventoryReceiptsDetails = async (req, res) => {
  const {
    company_code, ReceiptID, DateReceived, Warehouse, Supplier, PurchaseOrderID, ItemSNo, ItemCode, ItemName, Serial_No, QuantityReceived, Condition, ReceivedBy, ApprovalStatus, Notes,
    created_by, modified_by, tempstr1, tempstr2, tempstr3, tempstr4, datetime1, datetime2, datetime3, datetime4 } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("ReceiptID", sql.NVarChar, ReceiptID)
      .input("DateReceived", sql.Date, DateReceived)
      .input("Warehouse", sql.VarChar, Warehouse)
      .input("Supplier", sql.VarChar, Supplier)
      .input("PurchaseOrderID", sql.NVarChar, PurchaseOrderID)
      .input("ItemSNo", sql.BigInt, ItemSNo)
      .input("ItemCode", sql.VarChar, ItemCode)
      .input("ItemName", sql.VarChar, ItemName)
      .input("Serial_No", sql.VarChar, Serial_No)
      .input("QuantityReceived", sql.Int, QuantityReceived)
      .input("Condition", sql.VarChar, Condition)
      .input("ReceivedBy", sql.VarChar, ReceivedBy)
      .input("ApprovalStatus", sql.VarChar, ApprovalStatus)
      .input("Notes", sql.Text, Notes)
      .input("created_by", sql.VarChar, created_by)
      .input("modified_by", sql.VarChar, modified_by)
      .input("tempstr1", sql.VarChar, tempstr1)
      .input("tempstr2", sql.VarChar, tempstr2)
      .input("tempstr3", sql.VarChar, tempstr3)
      .input("tempstr4", sql.VarChar, tempstr4)
      .input("datetime1", sql.VarChar, datetime1)
      .input("datetime2", sql.VarChar, datetime2)
      .input("datetime3", sql.VarChar, datetime3)
      .input("datetime4", sql.VarChar, datetime4)
      .query(`EXEC sp_InventoryReceipts_Details @mode,@company_code,@ReceiptID,@DateReceived,@Warehouse,@Supplier,@PurchaseOrderID,@ItemSNo,@ItemCode,@ItemName,@Serial_No,@QuantityReceived,
        @Condition,@ReceivedBy,@ApprovalStatus,@Notes,@created_by,@modified_by,@tempstr1,@tempstr2,@tempstr3,@tempstr4,@datetime1,@datetime2,@datetime3,@datetime4`);
    res.json({ success: true, message: "Data inserted successfully" });
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const deleteInventoryReceiptsDetails = async (req, res) => {
  const { ReceiptID, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    await pool.request()
      .input("ReceiptID", ReceiptID)
      .input("company_code", company_code)
      .query(`EXEC sp_InventoryReceipts_Details 'D',@company_code,@ReceiptID,'','','','',0,'','','',0,'','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.status(200).json("Inventory Receipt Detail deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const addInventoryReceiptsheader = async (req, res) => {
  const { company_code, ReceiptID, DateReceived, Receipt_Type, created_by, modified_by,
    tempstr1, tempstr2, tempstr3, tempstr4, datetime1, datetime2, datetime3, datetime4,

  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("ReceiptID", sql.NVarChar, ReceiptID)
      .input("DateReceived", sql.NVarChar, DateReceived)
      .input("Receipt_Type", sql.NVarChar, Receipt_Type)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(`EXEC sp_InventoryReceipts_hdr @mode,@company_code,@ReceiptID,@DateReceived,@Receipt_Type,
          @created_by, @modified_by, NULL, NULL, NULL, NULL, NULL, NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const inventoryReceiptsDelete = async (req, res) => {
  const { ReceiptID, company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    await pool.request()
      .input("ReceiptID", ReceiptID)
      .input("company_code", company_code)
      .query(`EXEC sp_InventoryReceipts_hdr 'D',@company_code,@ReceiptID,'','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`)
    res.status(200).json("InventoryReceipts deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const inventoryReceiptsAll = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`EXEC sp_InventoryReceipts_hdr  'A','', '', '', '', '','', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL`);

    res.json(result.recordset);
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const addInventoryReturnheader = async (req, res) => {
  const { company_code, ReturnID, DateReturned, Return_Type, created_by, modified_by,
    tempstr1, tempstr2, tempstr3, tempstr4, datetime1, datetime2, datetime3, datetime4,

  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("ReturnID", sql.NVarChar, ReturnID)
      .input("DateReturned", sql.NVarChar, DateReturned)
      .input("Return_Type", sql.NVarChar, Return_Type)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(`EXEC sp_InventoryReturns_hdr @mode,@company_code,@ReturnID,@DateReturned,@Return_Type,
              @created_by, @modified_by, NULL, NULL, NULL, NULL, NULL, NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    }
  } catch (err) {
    console.error(err);
    res.status(500).json(err.message || "Internal Server Error");
  }
};


const inventoryReturnHeaderDelete = async (req, res) => {
  const { ReturnID, company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    await pool
      .request()
      .input("mode", sql.NVarChar, "D")
      .input("company_code", sql.NVarChar, company_code)
      .input("ReturnID", sql.NVarChar, ReturnID)
      .query(`EXEC sp_InventoryReturns_hdr 'D',@company_code,@ReturnID,'','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`)
    res.status(200).json("InventoryReturn deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const inventoryReturnHeaderAll = async (req, res) => {
  const { company_code } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "A") // Insert mode
      .input("company_code", sql.NVarChar, company_code)

      .query(`EXEC sp_InventoryReturns_hdr  @mode,@company_code, '', '', '', '','', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL`);

    res.json(result.recordset);
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const addInventoryReturndetails = async (req, res) => {
  const {
    company_code, ReturnID, DateReturned, Warehouse, Supplier, ItemSNo, ItemCode, ItemName, Serial_no, QuantityReturned, ReasonForReturn,
    Condition, ProcessedBy, ApprovalStatus, ActionTaken, Notes, created_by, modified_by,
    tempstr1, tempstr2, tempstr3, tempstr4, datetime1, datetime2, datetime3, datetime4,

  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("ReturnID", sql.NVarChar, ReturnID)
      .input("DateReturned", sql.NVarChar, DateReturned)
      .input("Warehouse", sql.NVarChar, Warehouse)
      .input("Supplier", sql.NVarChar, Supplier)
      .input("ItemSNo", sql.BigInt, ItemSNo)
      .input("ItemCode", sql.NVarChar, ItemCode)
      .input("ItemName", sql.NVarChar, ItemName)
      .input("Serial_no", sql.NVarChar, Serial_no)
      .input("QuantityReturned", sql.Int, QuantityReturned)
      .input("ReasonForReturn", sql.VarChar, ReasonForReturn)
      .input("Condition", sql.VarChar, Condition)
      .input("ProcessedBy", sql.VarChar, ProcessedBy)
      .input("ApprovalStatus", sql.VarChar, ApprovalStatus)
      .input("ActionTaken", sql.NVarChar, ActionTaken)
      .input("Notes", sql.NVarChar, Notes)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(
        `EXEC sp_InventoryReturns_details @mode,@company_code,@ReturnID,@DateReturned,@Warehouse,@Supplier,@ItemSNo,@ItemCode,@ItemName,@Serial_no,@QuantityReturned,@ReasonForReturn,
          @Condition,@ProcessedBy,@ApprovalStatus,@ActionTaken,@Notes,@created_by,@modified_by,
          @tempstr1,@tempstr2,@tempstr3,@tempstr4,@datetime1,@datetime2,@datetime3,@datetime4`);
    res.json({ success: true, message: "Data inserted successfully" });
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const InventoryReturnDeleteDetailData = async (req, res) => {
  const { company_code, ReturnID } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    await pool
      .request()
      .input("mode", sql.NVarChar, "D")
      .input("company_code", sql.NVarChar, company_code)
      .input("ReturnID", sql.NVarChar, ReturnID)
      .query(`EXEC sp_InventoryReturns_details 'D',@company_code,@ReturnID,'','','',0,'','','',0,'',
          '','','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.status(200).json(" InventoryReturn deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getAllInventoryReturndetailData = async (req, res) => {
  const { company_code } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "A") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_InventoryReturns_details @mode,@company_code,'','','','',0,'','','',0,'',
          '','','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    res.json(result.recordset);
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const UpdateUserImage = async (req, res) => {
  const { user_code } = req.body;

  let user_img = null;

  if (req.file) {
    user_img = req.file.buffer; // Buffer containing the uploaded image
  }
  try {
    // Check if the user exists in the database
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("user_code", sql.NVarChar, user_code)
      .input("user_img", sql.VarBinary, user_img)
      .query(`EXEC SP_user_info_hdr 'UI','',@user_code,'','','','','','','','','','','',@user_img,'','',
                    NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Return success response
    if (result.rowsAffected && result.rowsAffected[0] > 0) {
      return res.status(200).json({ success: true, message: 'Data inserted successfully' });
    }
  } catch (error) {
    if (error.class === 16 && error.number === 50000) {
      // Custom error from the stored procedure
      res.status(400).json({ message: 'User already exists', error: error.message });
    } else {
      // Handle unexpected errors
      res.status(500).json({ message: 'Internal Server Error', error: error.message });
    }
  }
};


const AddEmployeeInfo = async (req, res) => {
  const {
    employee_no, employee_name, fathername, doj, dob, mob_no, emg_mob_no, employee_type, dept_id,
    desgination, qualification, address, city, company_code, created_by, modified_by,
    tempstr1, tempstr2, tempstr3, tempstr4, datetime1, datetime2, datetime3, datetime4,

  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("employee_no", sql.NVarChar, employee_no)
      .input("employee_name", sql.NVarChar, employee_name)
      .input("fathername", sql.NVarChar, fathername)
      .input("doj", sql.Date, doj)
      .input("dob", sql.Date, dob)
      .input("mob_no", sql.NVarChar, mob_no)
      .input("emg_mob_no", sql.NVarChar, emg_mob_no)
      .input("employee_type", sql.VarChar, employee_type)
      .input("dept_id", sql.VarChar, dept_id)
      .input("desgination", sql.VarChar, desgination)
      .input("qualification", sql.VarChar, qualification)
      .input("address", sql.VarChar, address)
      .input("city", sql.NVarChar, city)
      .input("company_code", sql.NVarChar, company_code)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(
        `EXEC sp_employee_info @mode,@employee_no,@employee_name,@fathername,@doj,@dob,@mob_no,@emg_mob_no,@employee_type,@dept_id,@desgination,@qualification,@address,
    @city,@company_code,'',@created_by,@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.json({ success: true, message: "Data inserted successfully" });
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const EmployeeInfodelete = async (req, res) => {
  const { employee_no } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    try {
      await pool.request().input("employee_no", employee_no).query(`
         EXEC sp_employee_info 'D',@employee_no,'','','','','','','','','','','','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
            `)
    } catch (error) {
      if (error.number === 547) {
        // Foreign key constraint violation
        res.status(400).json("first delete the EmployeeInfo details  data");
        return;
      } else {
        throw error; // Rethrow other SQL errors
      }
    }

    res.status(200).json("EmployeeInfo deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const EmployeinfoAll = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(` EXEC sp_employee_info 'A','','','','','','','','','','','','',
          '','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`)
    res.json(result.recordset);
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const AddDepartment = async (req, res) => {
  const {
    dept_id, dept_name, company_code, created_by, modified_by,
    tempstr1, tempstr2, tempstr3, tempstr4, datetime1, datetime2, datetime3, datetime4,

  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I")
      .input("dept_id", sql.NVarChar, dept_id)
      .input("dept_name", sql.NVarChar, dept_name)
      .input("company_code", sql.NVarChar, company_code)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(`EXEC sp_department @mode,@dept_id,@dept_name,@company_code,'',@created_by,@modified_by,
                         NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.json({ success: true, message: "Data inserted successfully" });
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};



const ViewEmployee = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`  EXEC sp_department 'A','','','','','',
                         NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`)
    res.json(result.recordset);
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//   const //DepartmentUpdate = async (req, res) => {
//     const editedData = req.body.editedData;

//     if (!editedData || !editedData.length) {
//       res.status(400).json("Invalid or empty editedData array.");
//       return;
//     }

//     try {
//       const pool = await connection.connectToDatabase(dbConfig);

//       for (const updatedRow of editedData) {
//         await pool
//           .request()
//           .input("mode",          sql.NVarChar, "U") // update mode
//           .input("dept_id",      sql.NVarChar, updatedRow.dept_id) 
//           .input("dept_name",     sql.NVarChar, updatedRow.dept_name)
//           .input("location",     sql.NVarChar, updatedRow.location)
//           .input("modified_by",   sql.NVarChar, req.headers['modified-by'])   
//           .query(
//             `EXEC sp_department @mode,@dept_id,@dept_name,@location,'',@modified_by,
//                    NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`
//           );
//       }

//       res.status(200).json("Department data updated successfully");
//     } catch (error) {
//       console.error(error);
//       res.status(500).json({ message: err.message || 'Internal Server Error' });
//     } finally {
//       connection.closeDatabaseConnection();
//     }
//  };

const getInventoryTransaction = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'InventoryTransacti','','', '','','', NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const addInventoryIssuancehdr = async (req, res) => {
  const { company_code, IssuanceID, DateIssued, Issued_Type, created_by, modified_by,
    tempstr1, tempstr2, tempstr3, tempstr4, datetime1, datetime2, datetime3, datetime4,

  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("IssuanceID", sql.NVarChar, IssuanceID)
      .input("DateIssued", sql.NVarChar, DateIssued)
      .input("Issued_Type", sql.NVarChar, Issued_Type)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(`EXEC sp_InventoryIssuance_hdr @mode,@company_code,@IssuanceID,@DateIssued,@Issued_Type,
                @created_by, @modified_by, NULL, NULL, NULL, NULL, NULL, NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};


const inventoryIssuanceDelete = async (req, res) => {
  const { company_code, IssuanceID } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    await pool
      .request()
      .input("mode", sql.NVarChar, "D")
      .input("company_code", sql.NVarChar, company_code)
      .input("IssuanceID", sql.NVarChar, IssuanceID)
      .query(`EXEC sp_InventoryIssuance_hdr @mode,@company_code,@IssuanceID,'','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`)
    res.status(200).json("InventoryIssuance deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const inventoryIssuanceAll = async (req, res) => {
  const { company_code } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "A") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_InventoryIssuance_hdr  'A',@company_code, '', '', '', '','', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL`);

    res.json(result.recordset);
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const addInventoryIssuancedetails = async (req, res) => {
  const {
    company_code, IssuanceID, DateIssued, Warehouse, Department, ItemSNo, ItemCode, ItemName, Serial_No, QuantityIssued, ReasonForIssuance,
    IssuedBy, ApprovalStatus, ActionTaken, Notes, created_by, modified_by,
    tempstr1, tempstr2, tempstr3, tempstr4, datetime1, datetime2, datetime3, datetime4,

  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("IssuanceID", sql.NVarChar, IssuanceID)
      .input("DateIssued", sql.NVarChar, DateIssued)
      .input("Warehouse", sql.NVarChar, Warehouse)
      .input("Department", sql.NVarChar, Department)
      .input("ItemSNo", sql.BigInt, ItemSNo)
      .input("ItemCode", sql.NVarChar, ItemCode)
      .input("ItemName", sql.NVarChar, ItemName)
      .input("Serial_No", sql.NVarChar, Serial_No)
      .input("QuantityIssued", sql.Int, QuantityIssued)
      .input("ReasonForIssuance", sql.VarChar, ReasonForIssuance)
      .input("IssuedBy", sql.VarChar, IssuedBy)
      .input("ApprovalStatus", sql.VarChar, ApprovalStatus)
      .input("ActionTaken", sql.NVarChar, ActionTaken)
      .input("Notes", sql.NVarChar, Notes)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(
        `EXEC sp_InventoryIssuances_details @mode,@company_code,@IssuanceID,@DateIssued,@Warehouse,@Department,@ItemSNo,@ItemCode,@ItemName,@Serial_No,@QuantityIssued,@ReasonForIssuance,
            @IssuedBy,@ApprovalStatus,@ActionTaken,@Notes,@created_by,@modified_by,
            @tempstr1,@tempstr2,@tempstr3,@tempstr4,@datetime1,@datetime2,@datetime3,@datetime4`);
    res.json({ success: true, message: "Data inserted successfully" });
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const InventoryIssuanceDeleteDetailData = async (req, res) => {
  const { company_code, IssuanceID } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    await pool
      .request()
      .input("mode", sql.NVarChar, "D")
      .input("company_code", sql.NVarChar, company_code)
      .input("IssuanceID", sql.NVarChar, IssuanceID)
      .query(`EXEC sp_InventoryIssuances_details @mode,@company_code,@IssuanceID,'','','','',0,'','',0,'',
            '','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.status(200).json(" InventoryIssuance deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getAllInventoryIssuancedetailData = async (req, res) => {
  const { company_code } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "A") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_InventoryIssuances_details 'A',@company_code,'','','','',0,'','','',0,'',
            '','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getInventoryReturn = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "IR")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_getdata @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);

    // Send response
    if (result.recordsets && result.recordsets.length > 0 && result.recordsets[0].length > 0) {
      const data = {
        Header: result.recordsets[0],
        Detail: result.recordsets[1] || []
      };
      res.status(200).json(data); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getInventoryReturnDetails = async (req, res) => {
  const { transaction_no } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "IRD")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .query(`EXEC sp_getdata @mode,@transaction_no,'',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getInventoryReceipt = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "IRT")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_getdata @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);

    // Check if data is found
    if (result.recordsets && result.recordsets.length > 0 && result.recordsets[0].length > 0) {
      const data = {
        Header: result.recordsets[0],
        Detail: result.recordsets[1] || []
      };
      res.status(200).json(data); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getInventoryReceiptDetail = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "IRTD")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_getdata @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getInventoryIssued = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "II")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_getdata @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);

    // Check if data is found
    if (result.recordsets && result.recordsets.length > 0 && result.recordsets[0].length > 0) {
      const data = {
        Header: result.recordsets[0],
        Detail: result.recordsets[1] || []
      };
      res.status(200).json(data); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getInventoryIssuedDetail = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "IID")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_getdata @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const InventoryReturnHeaderPrint = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool.request()
      .input("mode", sql.NVarChar, "IRH")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_print @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    // Process result sets
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const InventoryReturnDetailPrint = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool.request()
      .input("mode", sql.NVarChar, "IRD")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_print @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    // Process result sets
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const InventoryReceiptHeaderPrint = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool.request()
      .input("mode", sql.NVarChar, "IRTH")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_print @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    // Process result sets
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const InventoryReceiptDetailPrint = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool.request()
      .input("mode", sql.NVarChar, "IRTD")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_print @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    // Process result sets
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const InventoryIssuedHeaderPrint = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool.request()
      .input("mode", sql.NVarChar, "IIH")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_print @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    // Process result sets
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const InventoryIssuedDetailPrint = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool.request()
      .input("mode", sql.NVarChar, "IID")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_print @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    // Process result sets
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const addAssetsAllocationheader = async (req, res) => {
  const { allocation_no, allocation_date, company_code, created_by, modified_by,
    tempstr1, tempstr2, tempstr3, tempstr4, datetime1, datetime2, datetime3, datetime4,

  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I")
      .input("allocation_no", sql.NVarChar, allocation_no)
      .input("allocation_date", sql.Date, allocation_date)
      .input("company_code", sql.NVarChar, company_code)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(`EXEC sp_Assets_Allocation_hdr @mode,@allocation_no,@allocation_date,'',@company_code,@created_by,@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const AssetsAllocationdelete = async (req, res) => {
  const { company_code, allocation_no } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    await pool
      .request()
      .input("mode", sql.NVarChar, "D")
      .input("company_code", sql.NVarChar, company_code)
      .input("allocation_no", sql.NVarChar, allocation_no)
      .query(`EXEC sp_Assets_Allocation_hdr @mode,@allocation_no,'','',@company_code,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`)

    res.status(200).json("Assets Allocation deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

// const GetAllAssetsAllocationHdr = async (req, res) => {
//   try {
//     await connection.connectToDatabase();
//     const result = await sql.query(`EXEC sp_Assets_Allocation_hdr 'A','','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

//     res.json(result.recordset);
//   } catch (err) {
//     console.error(err);
//     res.status(500).json({ message: err.message || 'Internal Server Error' });
//   }
// };

const GetAllAssetsAllocationHdr = async (req, res) => {
  const { company_code } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "A")
      .input("company_code", sql.VarChar, company_code)
      .query(`EXEC sp_Assets_Allocation_hdr @mode,'','','',@company_code,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const addAssetsAllocationDeatils = async (req, res) => {
  const { allocation_no, allocation_date, item_SNO, item_code, item_name, Serial_no, Quantity, Emp_no, company_code, created_by, modified_by,
    tempstr1, tempstr2, tempstr3, tempstr4, datetime1, datetime2, datetime3, datetime4,

  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("allocation_no", sql.NVarChar, allocation_no)
      .input("allocation_date", sql.Date, allocation_date)
      .input("item_SNO", sql.VarChar, item_SNO)
      .input("item_code", sql.VarChar, item_code)
      .input("item_name", sql.VarChar, item_name)
      .input("Serial_no", sql.VarChar, Serial_no)
      .input("Quantity", sql.Int, Quantity)
      .input("Emp_no", sql.NVarChar, Emp_no)
      .input("company_code", sql.NVarChar, company_code)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(`EXEC sp_Assets_Allocation_Details @mode, @allocation_no, @allocation_date, @item_SNO,@item_code, @item_name,@Serial_no,@quantity,@Emp_no,@company_code,@created_by,@modified_by, 
                        NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL`);

    res.json({ success: true, message: "Data inserted successfully" });
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const deleteAssetsAllocationDetails = async (req, res) => {
  const { company_code, allocation_no } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    await pool
      .request()
      .input("allocation_no", sql.NVarChar, "D")
      .input("allocation_no", sql.NVarChar, company_code)
      .input("allocation_no", sql.NVarChar, allocation_no)
      .query(`EXEC sp_Assets_Allocation_Details @mode,@allocation_no,'','','','','',0,'',@company_code,'','', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL`)

    res.status(200).json("Assets Allocation deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

// const GetAllAssetsAllocationDetails = async (req, res) => {
//   try {
//     await connection.connectToDatabase();
//     const result = await sql.query
//       (`EXEC sp_Assets_Allocation_Details 'a', '', '', '', '', '','',0,'','','','', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL`);

//     res.json(result.recordset);
//   } catch (err) {
//     console.error(err);
//     res.status(500).json({ message: err.message || 'Internal Server Error' });
//   }
// };

const GetAllAssetsAllocationDetails = async (req, res) => {
  const { company_code } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "A")
      .input("company_code", sql.VarChar, company_code)
      .query(`EXEC sp_Assets_Allocation_Details @mode,'','','','','','',0,'',@company_code,'','', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const InventoryReturnSearchData = async (req, res) => {
  const { company_code, ReturnID, Return_Type, DateReturned } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("company_code", sql.NVarChar, company_code)
      .input("ReturnID", sql.NVarChar, ReturnID)
      .input("DateReturned", sql.NVarChar, DateReturned)
      .input("Return_Type", sql.NVarChar, Return_Type)
      .query(`EXEC sp_InventoryReturns_hdr @mode,@company_code,@ReturnID,@DateReturned,@Return_Type,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const InventoryReceiptSearchData = async (req, res) => {
  const { ReceiptID, DateReceived, Receipt_Type } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("ReceiptID", sql.NVarChar, ReceiptID)
      .input("DateReceived", sql.NVarChar, DateReceived)
      .input("Receipt_Type", sql.NVarChar, Receipt_Type)
      .query(`EXEC sp_InventoryReceipts_hdr @mode,'',@ReceiptID,@DateReceived,@Receipt_Type,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const InventoryIssuedSearchData = async (req, res) => {
  const { company_code, IssuanceID, DateIssued, Issued_Type } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("IssuanceID", sql.NVarChar, IssuanceID)
      .input("company_code", sql.NVarChar, company_code)
      .input("DateIssued", sql.NVarChar, DateIssued)
      .input("Issued_Type", sql.NVarChar, Issued_Type)
      .query(`EXEC sp_InventoryIssuance_hdr @mode,@company_code,@IssuanceID,@DateIssued,@Issued_Type,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//original
const AssetsAllocationdeletehdr = async (req, res) => {
  const { company_code, allocation_no } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    await pool
      .request()
      .input("mode", sql.NVarChar, "D")
      .input("company_code", sql.NVarChar, company_code)
      .input("allocation_no", sql.NVarChar, allocation_no)
      .query(`EXEC sp_Assets_Allocation_hdr @mode,@allocation_no,'','',@company_code,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    res.status(200).json("Assets Data deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const AssetsAllocationdeleteDetails = async (req, res) => {
  const { company_code, allocation_no } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    await pool
      .request()
      .input("mode", sql.NVarChar, "D")
      .input("company_code", sql.NVarChar, company_code)
      .input("allocation_no", sql.NVarChar, allocation_no)
      .query(`EXEC sp_Assets_Allocation_Details @mode,@allocation_no,'','','','','','','',@company_code,'','', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL`);
    res.status(200).json("Assets deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getallAssetsAllocation = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "AAH")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_getdata @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    if (result.recordsets && result.recordsets.length > 0 && result.recordsets[0].length > 0) {
      const data = {
        Header: result.recordsets[0],
        Details: result.recordsets[1] || []
      };
      res.status(200).json(data);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const getEmptype = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'EmployeeType','','', '' ,'','', NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getDept = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        `EXEC sp_department 'F','','',@company_code,'','','',
                         NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`
      );
    res.json(result.recordset);
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getDesgination = async (req, res) => {

  const { dept_id, company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("dept_id", sql.NVarChar, dept_id)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_desgination 'F',@dept_id,'', '', '', @company_code,'', '', '',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    res.json(result.recordset);
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getallEmployee = async (req, res) => {
  const { employee_no, employee_name, desgination, employee_type, company_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("employee_no", sql.NVarChar, employee_no)
      .input("employee_name", sql.NVarChar, employee_name)
      .input("desgination", sql.NVarChar, desgination)
      .input("employee_type", sql.NVarChar, employee_type)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_employee_info @mode,@employee_no,@employee_name,'','','','','',@employee_type,'',@desgination,'','','',@company_code,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
                  `);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const EmployeeDelete = async (req, res) => {
  const keyfieldsToDelete = req.body.keyfield;

  if (!keyfieldsToDelete || !keyfieldsToDelete.length) {
    res.status(400).json("Invalid or emptykeyfields array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase();

    for (const keyfield of keyfieldsToDelete) {
      try {
        await pool.request().input("keyfield", sql.NVarChar, keyfield) // Set NVarChar to 50 or appropriate length
          .query(`
                        EXEC sp_employee_info 'D','','','','','','','','','','','','','','',@keyfield,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
      } catch (error) {
        if (error.number === 547) {
          // Foreign key constraint violation
          res.status(400).json(error.message);
          return;
        } else {
          throw error; // Rethrow other SQL errors
        }
      }
    }

    res.status(200).json("Employee deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const EmployeeEditData = async (req, res) => {
  const editedData = req.body.editedData;

  if (!editedData || !editedData.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase();

    for (const updatedRow of editedData) {
      await pool
        .request()
        .input("mode", sql.NVarChar, "U")
        .input("employee_name", updatedRow.employee_name)
        .input("fathername", updatedRow.fathername)
        .input("doj", updatedRow.doj)
        .input("dob", updatedRow.dob)
        .input("mob_no", updatedRow.mob_no)
        .input("emg_mob_no", updatedRow.emg_mob_no)
        .input("employee_type", updatedRow.employee_type)
        .input("dept_id", updatedRow.dept_id)
        .input("desgination", updatedRow.desgination)
        .input("qualification", updatedRow.qualification)
        .input("address", updatedRow.address)
        .input("city", updatedRow.city)
        .input("keyfield", updatedRow.keyfield)
        .input("modified_by", sql.NVarChar, req.headers['modified-by'])
        .query(`EXEC sp_employee_info @mode,'',@employee_name,@fathername,@doj,@dob,@mob_no,@emg_mob_no,@employee_type,@dept_id,@desgination,@qualification,@address,@city,'',@keyfield,'', 
                     @modified_by,'','','','','','','',''`);
    }

    res.status(200).json("Edited data saved successfully");
  } catch (error) {
    if (error.class === 16 && error.number === 50000) {
      // Custom error from the stored procedure
      res.status(400).json({ message: error.message });
    } else {
      // Handle unexpected errors
      res.status(500).json({ message: 'Internal Server Error', error: error.message });
    }
  }
};


const updateitemData = async (req, res) => {
  const editedData = req.body.editedData;



  if (!editedData || !editedData.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase();

    for (const updatedRow of editedData) {
      const item_images =
        updatedRow.item_images && updatedRow.item_images.type === "Buffer"
          ? Buffer.from(updatedRow.item_images.data)
          : null;


      console.log(item_images);
      await pool
        .request()
        .input("mode", sql.NVarChar, "U")
        .input("company_code", sql.NVarChar, req.headers['company_code'])
        .input("Item_code", updatedRow.Item_code)
        .input("Item_variant", updatedRow.Item_variant)
        .input("Item_name", sql.VarChar, updatedRow.Item_name)
        .input("Item_wigh", sql.Decimal(10, 2), updatedRow.Item_wigh)
        .input("Item_BaseUOM", sql.NVarChar, updatedRow.Item_BaseUOM)
        .input("Item_SecondaryUOM", sql.NVarChar, updatedRow.Item_SecondaryUOM)
        .input("Item_short_name", sql.NVarChar, updatedRow.Item_short_name)
        .input("Item_Last_salesRate_ExTax", sql.Decimal(12, 2), updatedRow.Item_Last_salesRate_ExTax)
        .input("Item_Last_salesRate_IncludingTax", sql.Decimal(12, 2), updatedRow.Item_Last_salesRate_IncludingTax)
        .input("Item_std_purch_price", sql.Decimal(12, 2), updatedRow.Item_std_purch_price)
        .input("Item_std_sales_price", sql.Decimal(12, 2), updatedRow.Item_std_sales_price)
        .input("Item_stock_code", sql.VarChar, updatedRow.Item_stock_code)
        .input("Item_purch_tax_type", sql.VarChar, updatedRow.Item_purch_tax_type)
        .input("Item_sales_tax_type", sql.VarChar, updatedRow.Item_sales_tax_type)
        .input("Item_Costing_Method", sql.VarChar, updatedRow.Item_Costing_Method)
        .input("Item_stock_type", sql.VarChar, updatedRow.Item_stock_type)
        .input("hsn", sql.VarChar, updatedRow.hsn)
        .input("Item_Register_Brand", sql.VarChar, updatedRow.Item_Register_Brand)
        .input("Item_Our_Brand", sql.VarChar, updatedRow.Item_Our_Brand)
        .input("status", sql.VarChar, updatedRow.status)
        .input("item_images", sql.VarBinary.item_images)
        .input("Item_other_purch_taxtype", sql.VarChar, updatedRow.Item_other_purch_taxtype)
        .input("Item_other_sales_taxtype", sql.VarChar, updatedRow.Item_other_sales_taxtype)
        .input("MRP_Price", sql.Decimal(10, 2), updatedRow.MRP_Price)
        .input("discount_Percentage", sql.Decimal(5, 2), updatedRow.discount_Percentage)
        .input("created_by", sql.NVarChar, updatedRow.created_by)
        .input("modified_by", sql.NVarChar, req.headers['Modified-By'])
        .input("tempstr1", sql.NVarChar, updatedRow.tempstr1)
        .input("tempstr2", sql.NVarChar, updatedRow.tempstr2)
        .input("tempstr3", sql.NVarChar, updatedRow.tempstr3)
        .input("tempstr4", sql.NVarChar, updatedRow.tempstr4)
        .input("datetime1", sql.NVarChar, updatedRow.datetime1)
        .input("datetime2", sql.NVarChar, updatedRow.datetime2)
        .input("datetime3", sql.NVarChar, updatedRow.datetime3)
        .input("datetime4", sql.NVarChar, updatedRow.datetime4)
        .query(`EXEC sp_item_brand_info @mode, @company_code, @Item_code, @Item_variant, @Item_name, @Item_wigh,
                                @Item_BaseUOM, @Item_SecondaryUOM, @Item_short_name, @Item_Last_salesRate_ExTax, @Item_Last_salesRate_IncludingTax,
                                @Item_std_purch_price, @Item_std_sales_price, @Item_stock_code, @Item_purch_tax_type, @Item_sales_tax_type,
                                @Item_Costing_Method, @Item_stock_type, @hsn, @Item_Register_Brand, @Item_Our_Brand, @status,'','', @Item_other_purch_taxtype,@Item_other_sales_taxtype,@MRP_price,@discount_Percentage,
                                '',@created_by, @modified_by, @tempstr1, @tempstr2, @tempstr3, @tempstr4, @datetime1, @datetime2, @datetime3, @datetime4`);
    }

    res.status(200).json("Edited data saved successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};


// const updateitemData = async (req, res) => {
//   const { Item_code, Item_variant } = req.body; 
//   const updatedData = req.body.updatedData; // Getting the body data

//   let item_images = null;

//   // If an image file is uploaded, capture the binary data
//   if (req.file) {
//     item_images = req.file.buffer;
//   }

//   // Logging the input data for debugging purposes
//   console.log("Item_code:", Item_code);
//   console.log("Item_variant:", Item_variant);
//   console.log("updatedData:", updatedData);
//   console.log("req.file:", req.file);

//   // Check if the required data is available
//   if (!Item_code || !Item_variant || !updatedData) {
//     res.status(400).json("Invalid or empty input data.");
//     return;
//   }

//   try {
//     const pool = await connection.connectToDatabase();

//     const updatedRow = updatedData; // Assuming 'updatedData' is a JSON object for one item

//     // Run the update query using both `Item_code` and `Item_variant` for the WHERE condition
//     await pool.request()
//       .input("mode", sql.NVarChar, "U")
//       .input("company_code", sql.NVarChar, req.headers['company_code'])  // From headers
//       .input("Item_code", sql.VarChar, Item_code)  // First WHERE condition
//       .input("Item_variant", sql.VarChar, Item_variant)  // Second WHERE condition
//       .input("Item_name", sql.VarChar, updatedRow.Item_name)
//       .input("Item_wigh", sql.Decimal(10, 2), updatedRow.Item_wigh)
//       .input("Item_BaseUOM", sql.NVarChar, updatedRow.Item_BaseUOM)
//       .input("Item_SecondaryUOM", sql.NVarChar, updatedRow.Item_SecondaryUOM)
//       .input("Item_short_name", sql.NVarChar, updatedRow.Item_short_name)
//       .input("Item_Last_salesRate_ExTax", sql.Decimal(12, 2), updatedRow.Item_Last_salesRate_ExTax)
//       .input("Item_Last_salesRate_IncludingTax", sql.Decimal(12, 2), updatedRow.Item_Last_salesRate_IncludingTax)
//       .input("Item_std_purch_price", sql.Decimal(12, 2), updatedRow.Item_std_purch_price)
//       .input("Item_std_sales_price", sql.Decimal(12, 2), updatedRow.Item_std_sales_price)
//       .input("Item_stock_code", sql.VarChar, updatedRow.Item_stock_code)
//       .input("Item_purch_tax_type", sql.VarChar, updatedRow.Item_purch_tax_type)
//       .input("Item_sales_tax_type", sql.VarChar, updatedRow.Item_sales_tax_type)
//       .input("Item_Costing_Method", sql.VarChar, updatedRow.Item_Costing_Method)
//       .input("Item_stock_type", sql.VarChar, updatedRow.Item_stock_type)
//       .input("hsn", sql.VarChar, updatedRow.hsn)
//       .input("Item_Register_Brand", sql.VarChar, updatedRow.Item_Register_Brand)
//       .input("Item_Our_Brand", sql.VarChar, updatedRow.Item_Our_Brand)
//       .input("status", sql.VarChar, updatedRow.status)
//       .input("item_images", sql.VarBinary, item_images || null)  // Update item_images if uploaded, otherwise null
//       .input("created_by", sql.NVarChar, updatedRow.created_by)
//       .input("modified_by", sql.NVarChar, req.headers['modified-by'])
//       .input("tempstr1", sql.NVarChar, updatedRow.tempstr1)
//       .input("tempstr2", sql.NVarChar, updatedRow.tempstr2)
//       .input("tempstr3", sql.NVarChar, updatedRow.tempstr3)
//       .input("tempstr4", sql.NVarChar, updatedRow.tempstr4)
//       .input("datetime1", sql.NVarChar, updatedRow.datetime1)
//       .input("datetime2", sql.NVarChar, updatedRow.datetime2)
//       .input("datetime3", sql.NVarChar, updatedRow.datetime3)
//       .input("datetime4", sql.NVarChar, updatedRow.datetime4)
//       .query(
//         `EXEC sp_item_brand_info @mode, @company_code, @Item_code, @Item_variant, @Item_name, @Item_wigh,
//         @Item_BaseUOM, @Item_SecondaryUOM, @Item_short_name, @Item_Last_salesRate_ExTax, @Item_Last_salesRate_IncludingTax,
//         @Item_std_purch_price, @Item_std_sales_price, @Item_stock_code, @Item_purch_tax_type, @Item_sales_tax_type,
//         @Item_Costing_Method, @Item_stock_type, @hsn, @Item_Register_Brand, @Item_Our_Brand, @status, @item_images,
//         @created_by, @modified_by, @tempstr1, @tempstr2, @tempstr3, @tempstr4, @datetime1, @datetime2, @datetime3, @datetime4`
//       );

//     res.status(200).json("Updated data successfully");
//   } catch (error) {
//     console.error("Error updating data:", error);
//     res.status(500).json({ message: err.message || 'Internal Server Error' });
//   } finally {
//     connection.closeDatabaseConnection();
//   }
// };

// const updateitemData = async (req, res) => {
//   const { Item_code, Item_variant, Item_name } = req.body;

//   if (!Item_code || !Item_variant ) {
//     return res.status(400).json("Invalid or empty input data.");
//   }

//   let item_images = null;
//   if (req.file) {
//     item_images = req.file.buffer;
//   }

//   console.log("Item_code:", Item_code);
//   console.log("Item_variant:", Item_variant);
//   console.log("Item_name:", Item_name);
//   console.log("req.file:", req.file);

//   try {
//     const pool = await connection.connectToDatabase();

//     await pool.request()
//       .input("mode", sql.NVarChar, "U")
//       .input("Item_code", sql.VarChar, Item_code)
//       .input("Item_variant", sql.VarChar, Item_variant)
//       .input("Item_name", sql.VarChar, Item_name)
//       .input("item_images", sql.VarBinary, item_images || null)
//       .query(
//         `EXEC sp_item_brand_info @mode, '', @Item_code, @Item_variant, @Item_name, 0,
//         '', '', '', 0, 0,
//         0,0, '', '', '',
//         '', '', '', '', '', '', @item_images,
//         '', '', '', '', '', '', '', '', '', ''`
//       );

//     res.status(200).json("Updated data successfully");
//   } catch (error) {
//     console.error("Error updating data:", error);
//     res.status(500).json({ message: err.message || 'Internal Server Error' });
//   } finally {
//     connection.closeDatabaseConnection();
//   }
// };

const getallEmployeePopUp = async (req, res) => {
  const { employee_no, employee_name, desgination, employee_type, company_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("employee_no", sql.NVarChar, employee_no)
      .input("employee_name", sql.NVarChar, employee_name)
      .input("desgination", sql.NVarChar, desgination)
      .input("employee_type", sql.NVarChar, employee_type)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_employee_info @mode,@employee_no,@employee_name,'','','','','',@employee_type,'','','','','',@company_code,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const getallAssetsAllocationsaved = async (req, res) => {
  const { company_code, allocation_no, allocation_date, item_SNO, item_code, item_name, Emp_no, Serial_no, Quantity } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("allocation_no", sql.NVarChar, allocation_no)
      .input("allocation_date", sql.NVarChar, allocation_date)
      .input("item_SNO", sql.NVarChar, item_SNO)
      .input("item_code", sql.NVarChar, item_code)
      .input("item_name", sql.NVarChar, item_name)
      .input("Emp_no", sql.NVarChar, Emp_no)
      .input("Serial_no", sql.NVarChar, Serial_no)
      .input("Quantity", sql.NVarChar, Quantity)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_Assets_Allocation_Details @mode, @allocation_no, @allocation_date,@item_SNO,@item_code, @item_name,@Serial_no,@Quantity,@Emp_no,@company_code,'','', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL`)
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


//CODE ADDED BY PAVUN 21-09-2024


// const   productDeleteDetails = async (req, res) => {
//   const{Product_Code}= req.body;

//   try {
//     const pool = await connection.connectToDatabase();
//       try {
//         await pool.request().input("Product_Code", Product_Code).query(`
//       EXEC sp_Product_details 'D',@Product_Code,'','','',0,0,0,'','',0,'','','','','','','','','',''
//         `);
//       } catch (error) {
//         if (error.number === 547) {
//           res.status(400).json("first delete the product details data");
//           return;
//         } else {
//           throw error;
//         }
//       }

//     res.status(200).json("purchase deleted successfully");
//   } catch (error) {
//     console.error(error);
//     res.status(500).json({ message: err.message || 'Internal Server Error' });
//   } finally {
//     connection.closeDatabaseConnection();
//   }
// };

const getProductData = async (req, res) => {
  const { transaction_no, company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "PRO")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_getdata @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);
    if (result.recordsets && result.recordsets.length > 0 && result.recordsets[0].length > 0) {
      const data = {
        Header: result.recordsets[0],
        Detail: result.recordsets[1] || []
      };
      res.status(200).json(data);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getProductDetail = async (req, res) => {
  const { transaction_no, company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "PROD")
      .input("company_code", sql.NVarChar, company_code)
      .input("transaction_no", sql.NVarChar, transaction_no)
      .query(`EXEC sp_getdata @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const ProductSearchData = async (req, res) => {
  const { company_code, Product_Code, Product_name, status } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "PSF")
      .input("company_code", sql.NVarChar, company_code)
      .input("Product_Code", sql.NVarChar, Product_Code)
      .input("Product_name", sql.NVarChar, Product_name)
      .input("status", sql.NVarChar, status)
      .query(`EXEC sp_Product_details @mode,@company_code,@Product_Code,@Product_name,'','',0,0,0,'',@status,0,'','','','','','','','','','',''`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//CODE ENDED PAVUN  


//CODE ADDED BY HARISH

const getallassetsdetails = async (req, res) => {
  const { company_code, transaction_no } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "AAD")
      .input("company_code", sql.NVarChar, company_code)
      .input("transaction_no", sql.NVarChar, transaction_no)
      // .input("status", sql.NVarChar, status)
      .query(`EXEC sp_getdata 'AAD',@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getCondition = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'Condition','','', '','','', NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//code added by pavun 25/09/2024
const PurchaseAuthHdr = async (req, res) => {
  const { company_code, transaction_no, authroization_status } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "AU")
      .input("company_code", sql.NVarChar, company_code)
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("authroization_status", sql.NVarChar, authroization_status)
      .query(`EXEC sp_purchase_hdr @mode,@company_code, '', @transaction_no, '', '', '','','', 0,'', 0, 0, 0, 0,'', 0,'', 0,'', 0,'', 0,'', '', '', '', '', 
'',@authroization_status,'', '', '', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error inserting data:", err);

    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};


const PurchaseAuthDetail = async (req, res) => {
  const { company_code, transaction_no, authroization_status } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "AU")
      .input("company_code", sql.NVarChar, company_code)
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("authroization_status", sql.NVarChar, authroization_status)
      .query(`EXEC sp_purchase_details @mode,@company_code,'',@transaction_no,'','',0,'','',0,0,0,0,0,'','','','','','','',0,@authroization_status,'','','',
NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (!recordset || !Array.isArray(recordset) || recordset.length === 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error inserting data:", err);

    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};



const PurchaseAuthTaxDetail = async (req, res) => {
  const { company_code, transaction_no, authroization_status } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "AU")
      .input("company_code", sql.NVarChar, company_code)
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("authroization_status", sql.NVarChar, authroization_status)
      .query(`EXEC sp_purchase_tax_details @mode,@company_code,'',@transaction_no,'','',0,0,'','','','',0,0,'',@authroization_status,'',''
,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error inserting data:", err);

    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};


const SalesAuthHdr = async (req, res) => {
  const { company_code, bill_no, authroization_status } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "AU")
      .input("company_code", sql.NVarChar, company_code)
      .input("bill_no", sql.NVarChar, bill_no)
      .input("authroization_status", sql.NVarChar, authroization_status)
      .query(`EXEC sp_sales_hdr @mode,@company_code,'',@bill_no,'','','','',0,0,0,0,0,0,0,0,0,0,0,0,0,'','','','','','','','','','','',0,
'','','',@authroization_status,'','',0,0,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const SalesAuthDetail = async (req, res) => {
  const { bill_no, authroization_status, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "AU")
      .input("bill_no", sql.NVarChar, bill_no)
      .input("company_code", sql.NVarChar, company_code)
      .input("authroization_status", sql.NVarChar, authroization_status)
      .query(`EXEC sp_sales_details @mode,@company_code,'',@bill_no,'','','','',0,'',0,0,0,0,0,'','','','','','','','','','','','',0,@authroization_status,'',0,0,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const SalesAuthTaxDetail = async (req, res) => {
  const { company_code, bill_no, authroization_status } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "AU")
      .input("company_code", sql.NVarChar, company_code)
      .input("bill_no", sql.NVarChar, bill_no)
      .input("authroization_status", sql.NVarChar, authroization_status)
      .query(`EXEC sp_sales_tax_details @mode,@company_code,'',@bill_no,'','',0,0,'','','','',0,0,'',@authroization_status,'',''
	,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json(err.message || "Internal Server Error");
  }
};
const AddDesgination = async (req, res) => {
  const {
    dept_id, desgination_id, desgination, status, company_code, created_by, modified_by,
    tempstr1, tempstr2, tempstr3, tempstr4, datetime1, datetime2, datetime3, datetime4,

  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("dept_id", sql.NVarChar, dept_id)
      .input("desgination_id", sql.NVarChar, desgination_id)
      .input("desgination", sql.NVarChar, desgination)
      .input("status", sql.NVarChar, status)
      .input("company_code", sql.NVarChar, company_code)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(
        `EXEC sp_desgination @mode,@dept_id,@desgination_id,@desgination,@status,@company_code,'',@created_by,@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
  `);
    res.json({ success: true, message: "Data inserted successfully" });
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const GetAllDesgination = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`EXEC sp_desgination 'A','','', '','', '', '', '', '',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    res.json(result.recordset);
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const desginationDelete = async (req, res) => {
  const keyfieldsToDelete = req.body.keyfield;

  if (!keyfieldsToDelete || !keyfieldsToDelete.length) {
    res.status(400).json("Invalid or emptykeyfields array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase();

    for (const keyfield of keyfieldsToDelete) {
      try {
        await pool.request().input("keyfield", sql.NVarChar, keyfield)
          .query(`EXEC sp_desgination 'D','','', '', '', '', @keyfield,'', '',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
      } catch (error) {
        if (error.number === 547) {
          // Foreign key constraint violation
          res.status(400).json(error.message);
          return;
        } else {
          throw error; // Rethrow other SQL errors
        }
      }
    }

    res.status(200).json("desgination deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};



const DesgintionEditData = async (req, res) => {
  const editedData = req.body.editedData;

  if (!editedData || !editedData.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase();

    for (const updatedRow of editedData) {
      await pool
        .request()
        .input("mode", sql.NVarChar, "U")
        .input("dept_id", updatedRow.dept_id)
        .input("desgination_id", updatedRow.desgination_id)
        .input("desgination", updatedRow.desgination)
        .input("status", updatedRow.status)
        .input("company_code", updatedRow.company_code)
        .input("keyfield", updatedRow.keyfield)
        .input("created_by", updatedRow.created_by)
        .input("modified_by", sql.NVarChar, req.headers['modified-by'])
        .input("tempstr1", updatedRow.tempstr1)
        .input("tempstr2", updatedRow.tempstr2)
        .input("tempstr3", updatedRow.tempstr3)
        .input("tempstr4", updatedRow.tempstr4)
        .input("datetime1", updatedRow.datetime1)
        .input("datetime2", updatedRow.datetime2)
        .input("datetime3", updatedRow.datetime3)
        .input("da3tetime4", updatedRow.datetime4)
        .query(`EXEC sp_desgination @mode,@dept_id,@desgination_id,@desgination,@status,@company_code,@keyfield,@created_by,@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    }

    res.status(200).json("Edited data saved successfully");
  } catch (error) {
    if (error.class === 16 && error.number === 50000) {
      // Custom error from the stored procedure
      res.status(400).json({ message: error.message });
    } else {
      // Handle unexpected errors
      res.status(500).json({ message: 'Internal Server Error', error: error.message });
    }
  }
};

const desgsearch = async (req, res) => {
  const { dept_id, desgination_id, status, company_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("dept_id", sql.NVarChar, dept_id)
      .input("desgination_id", sql.NVarChar, desgination_id)
      .input("status", sql.NVarChar, status)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_desgination @mode,@dept_id,@desgination_id, '', @status, @company_code,'', '', '',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const DeptSearch = async (req, res) => {
  const { dept_id, dept_name, company_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("dept_id", sql.NVarChar, dept_id)
      .input("dept_name", sql.NVarChar, dept_name)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_department @mode,@dept_id,@dept_name,@company_code,'', '', '',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//code added by pavun 26-07-2024
const DepartmetEditData = async (req, res) => {
  const editedData = req.body.editedData;

  if (!editedData || !editedData.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase();

    for (const updatedRow of editedData) {
      await pool
        .request()
        .input("mode", sql.NVarChar, "U")
        .input("dept_name", updatedRow.dept_name)
        .input("key_field", updatedRow.key_field)
        .input("modified_by", sql.NVarChar, req.headers['modified-by'])
        .query(`EXEC sp_department @mode,'',@dept_name,'',@key_field,'',@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    }

    res.status(200).json("Edited data saved successfully");
  } catch (error) {
    if (error.class === 16 && error.number === 50000) {
      // Custom error from the stored procedure
      res.status(400).json({ message: error.message });
    } else {
      // Handle unexpected errors
      res.status(500).json({ message: 'Internal Server Error', error: error.message });
    }
  }
};

const departmentDelete = async (req, res) => {
  const keyfieldsToDelete = req.body.key_field;

  if (!keyfieldsToDelete || !keyfieldsToDelete.length) {
    res.status(400).json("Invalid or emptykeyfields array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase();

    for (const key_field of keyfieldsToDelete) {
      try {
        await pool.request().input("key_field", sql.NVarChar, key_field)
          .query(`EXEC sp_department 'D','','','',@key_field,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
      } catch (error) {
        if (error.number === 547) {
          // Foreign key constraint violation
          res.status(400).json(error.message);
          return;
        } else {
          throw error; // Rethrow other SQL errors
        }
      }
    }

    res.status(200).json("desgination deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const PurchReturnAuthHdr = async (req, res) => {
  const { company_code, return_no, authroization_status } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "AU")
      .input("company_code", sql.NVarChar, company_code)
      .input("return_no", sql.NVarChar, return_no)
      .input("authroization_status", sql.NVarChar, authroization_status)
      .query(`EXEC sp_purchase_return_hdr @mode,@company_code,'',@return_no,'','','','','','',
'','','',0,0,0,0,0,0,0,0,0,'','','',0,@authroization_status,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).journal_amountson("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json(err.message || "Internal Server Error");
  }
};

const PurchReturnAuthDetail = async (req, res) => {
  const { company_code, return_no, authroization_status } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "AU")
      .input("company_code", sql.NVarChar, company_code)
      .input("return_no", sql.NVarChar, return_no)
      .input("authroization_status", sql.NVarChar, authroization_status)
      .query(`EXEC sp_purchase_return_details @mode,@company_code,'','','',@return_no,'','','','','',0,0,0,0,0,0,0,'','','','','','','','','','','','',0,'',0,0,@authroization_status,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json(err.message || "Internal Server Error");
  }
};

const PurchReturnAuthTaxDetail = async (req, res) => {
  const { company_code, return_no, authroization_status } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "AU")
      .input("company_code", sql.NVarChar, company_code)
      .input("return_no", sql.NVarChar, return_no)
      .input("authroization_status", sql.NVarChar, authroization_status)
      .query(`EXEC sp_purchase_return_tax_details @mode,@company_code,'',@return_no,'','','','','','',0,0,'','','','',0,0,'',@authroization_status,'',''
,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json(err.message || "Internal Server Error");
  }
};


const SalesReturnAuthHdr = async (req, res) => {
  const { company_code, return_no, authroization_status } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "AU")
      .input("company_code", sql.NVarChar, company_code)
      .input("return_no", sql.NVarChar, return_no)
      .input("authroization_status", sql.NVarChar, authroization_status)
      .query(`EXEC sp_sales_return_hdr @mode,@company_code,'','','',@return_no,'','','','','','',0,0,0,0,0,0,0,0,0,0,0,0,0,
                          '','','','','','','','','','','',0,0,0,@authroization_status,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const SalesReturnAuthDetail = async (req, res) => {
  const { return_no, company_code, authroization_status } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "AU")
      .input("company_code", sql.NVarChar, company_code)
      .input("return_no", sql.NVarChar, return_no)
      .input("authroization_status", sql.NVarChar, authroization_status)
      .query(`EXEC sp_sales_return_details @mode,@company_code,'','','',@return_no,'','','','','','','',0,0,0,0,0,0,0,'','','','','','','','','',
'','','',0,0,0,@authroization_status,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const SalesReturnAuthTaxDetail = async (req, res) => {
  const { company_code, return_no, authroization_status } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "AU")
      .input("company_code", sql.NVarChar, company_code)
      .input("return_no", sql.NVarChar, return_no)
      .input("authroization_status", sql.NVarChar, authroization_status)
      .query(`EXEC sp_sales_return_tax_details @mode,@company_code,'','',@return_no,'','','','','',0,0,'','','','',0,0,'',@authroization_status,'',''
,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json(err.message || "Internal Server Error");
  }
};


const UpdateItemImage = async (req, res) => {
  const { item_code } = req.body;

  let item_images = null;

  if (req.file) {
    item_images = req.file.buffer;
  }
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("item_code", sql.NVarChar, item_code)
      .input("item_images", sql.VarBinary, item_images)
      .query(`EXEC sp_item_brand_info  'IIU','',@item_code,'','',0,'','','',0,0,0,
                           0,'','','','','','','','','',@item_images,'','','',0,0,'','','',NULL,NULL,NULL,NULL,NULL
						   ,NULL,NULL,NULL`);

    // Return success response
    if (result.rowsAffected && result.rowsAffected[0] > 0) {
      return res.status(200).json({ success: true, message: 'Data inserted successfully' });
    }
  } catch (error) {
    if (error.class === 16 && error.number === 50000) {
      // Custom error from the stored procedure
      res.status(400).json({ message: 'Item already exists', error: error.message });
    } else {
      // Handle unexpected errors
      res.status(500).json({ message: 'Internal Server Error', error: error.message });
    }
  }
};


//code added by pavun 05-06-2024
const LocationUpdate = async (req, res) => {
  const { location_no, location_name, short_name, address1, address2, address3,
    city, state, pincode, country, email_id, status, contact_no, created_by, modified_by
  } = req.body;

  let pool;
  try {
    pool = await connection.connectToDatabase();

    await pool
      .request()
      .input("mode", sql.NVarChar, "U")
      .input("location_no", sql.NVarChar, location_no)
      .input("location_name", sql.NVarChar, location_name)
      .input("short_name", sql.NVarChar, short_name)
      .input("address1", sql.NVarChar, address1)
      .input("address2", sql.NVarChar, address2)
      .input("address3", sql.NVarChar, address3)
      .input("city", sql.NVarChar, city)
      .input("state", sql.NVarChar, state)
      .input("pincode", sql.NVarChar, pincode)
      .input("country", sql.NVarChar, country)
      .input("email_id", sql.NVarChar, email_id)
      .input("status", sql.NVarChar, status)
      .input("contact_no", sql.NVarChar, contact_no)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .query(`EXEC sp_location_info @mode,@location_no, @location_name, @short_name, @address1, @address2, 
          @address3, @city, @state, @pincode, @country, @email_id,  @status, @contact_no, @created_by, @modified_by , 
         '', '', '', '','', '', '',''`);
    res.status(200).json("Edited data saved successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const CompanyUpdate = async (req, res) => {
  const { company_no, company_name, short_name, address1, address2, address3, city, state,
    pincode, country, email_id, status, foundedDate, websiteURL, contact_no,
    annualReportURL, location_no, company_gst_no, modified_by } = req.body;

  let company_logo = req.files['company_logo'] ? req.files['company_logo'][0].buffer : null;
  let authorisedSignatur = req.files['authorisedSignatur'] ? req.files['authorisedSignatur'][0].buffer : null;
  try {
    const pool = await connection.connectToDatabase();
    await pool
      .request()
      .input("mode", sql.NVarChar, "U")
      .input("company_no", sql.NVarChar, company_no)
      .input("company_name", sql.NVarChar, company_name)
      .input("short_name", sql.NVarChar, short_name)
      .input("address1", sql.NVarChar, address1)
      .input("address2", sql.NVarChar, address2)
      .input("address3", sql.NVarChar, address3)
      .input("city", sql.NVarChar, city)
      .input("state", sql.NVarChar, state)
      .input("pincode", sql.NVarChar, pincode)
      .input("country", sql.NVarChar, country)
      .input("email_id", sql.NVarChar, email_id)
      .input("status", sql.NVarChar, status)
      .input("foundedDate", sql.NVarChar, foundedDate)
      .input("websiteURL", sql.NVarChar, websiteURL)
      .input("company_logo", sql.VarBinary, company_logo)
      .input("contact_no", sql.NVarChar, contact_no)
      .input("annualReportURL", sql.NVarChar, annualReportURL)
      .input("location_no", sql.NVarChar, location_no)
      .input("company_gst_no", sql.NVarChar, company_gst_no)
      .input("authorisedSignatur", sql.VarBinary, authorisedSignatur)
      .input("modified_by", sql.NVarChar, modified_by)
      .query(`EXEC sp_company_info @mode, @company_no, @company_name, @short_name, @address1, @address2, @address3, @city, @state, @pincode, @country, @email_id, 
        @status, @foundedDate, @websiteURL, @company_logo, @contact_no, @annualReportURL,@location_no,@company_gst_no,@authorisedSignatur,'' ,@modified_by,
         '', '', '', '','', '', '', ''`);
    res.status(200).json("Edited data saved successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const UpdateCompanyImage = async (req, res) => {
  const { company_no } = req.body;

  let company_logo = null;

  if (req.file) {
    company_logo = req.file.buffer;
  }

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_no", sql.NVarChar, company_no)
      .input("company_logo", sql.VarBinary, company_logo)
      .query(`EXEC sp_company_info 'CIU',@company_no,'','','','','','','','','','','','','',@company_logo,'','','','','','','', NULL,NULL,NULL,NULL,NULL,NULL,NULL,null`);

    // Return success response
    if (result.rowsAffected && result.rowsAffected[0] > 0) {
      return res.status(200).json({ success: true, message: 'Data inserted successfully' });
    }
  } catch (error) {
    if (error.class === 16 && error.number === 50000) {
      // Custom error from the stored procedure
      res.status(400).json({ message: 'company already exists', error: error.message });
    } else {
      // Handle unexpected errors
      res.status(500).json({ message: 'Internal Server Error', error: error.message });
    }
  }
};

//code added by pavun 07-10-2024
const RoleUpdate = async (req, res) => {
  const { company_code, role_id, role_name, description, created_by, modified_by } = req.body;
  let pool;
  try {
    pool = await connection.connectToDatabase();
    await pool
      .request()
      .input("mode", sql.NVarChar, "U") // update mode
      .input("company_code", sql.NVarChar, company_code)
      .input("role_id", sql.NVarChar, role_id)
      .input("role_name", sql.NVarChar, role_name)
      .input("description", sql.NVarChar, description)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .query(
        `EXEC sp_Role_Info @mode,@company_code,@role_id,@role_name,@description,@created_by,@modified_by,'','',
          '','','','','',''`);

    res.status(200).json("Edited data saved successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const UserUpdate = async (req, res) => {
  const { company_code, user_code, user_name, first_name, last_name, user_password, user_status,
    log_in_out, user_type, email_id, dob, gender, role_id, created_by, modified_by
  } = req.body;

  let user_images = null;

  if (req.file) {
    user_images = req.file.buffer;
  }

  try {
    pool = await connection.connectToDatabase();
    await pool
      .request()
      .input("mode", sql.NVarChar, "U") // update mode
      .input("company_code", sql.NVarChar, company_code)
      .input("user_code", sql.NVarChar, user_code)
      .input("user_name", sql.NVarChar, user_name)
      .input("first_name", sql.NVarChar, first_name)
      .input("last_name", sql.NVarChar, last_name)
      .input("user_password", sql.NVarChar, user_password)
      .input("user_status", sql.NVarChar, user_status)
      .input("log_in_out", sql.NVarChar, log_in_out)
      .input("user_type", sql.NVarChar, user_type)
      .input("email_id", sql.NVarChar, email_id)
      .input("dob", sql.NVarChar, dob)
      .input("gender", sql.NVarChar, gender)
      .input("role_id", sql.NVarChar, role_id)
      .input("user_images", sql.VarBinary, user_images)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .query(
        `EXEC SP_user_info_hdr @mode,@company_code, @user_code, @user_name, @first_name, @last_name, @user_password, @user_status, @log_in_out, @user_type, 
            @email_id, @dob, @gender,@role_id,@user_images, @created_by, @modified_by, '', '', '', '', '', '', '', ''`);
    res.status(200).json("Edited data saved successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const CompanyMappingUpdate = async (req, res) => {
  const { company_code, user_code, company_no, location_no, status, order_no, keyfiels, modified_by } = req.body;
  let pool;
  try {
    pool = await connection.connectToDatabase();
    await pool
      .request()
      .input("mode", sql.NVarChar, "U")
      .input("company_code", sql.NVarChar, company_code)
      .input("user_code", sql.VarChar, user_code)
      .input("company_no", sql.NVarChar, company_no)
      .input("location_no", sql.VarChar, location_no)
      .input("status", sql.VarChar, status)
      .input("order_no", sql.Int, order_no)
      .input("keyfiels", sql.NVarChar, keyfiels)
      .input("modified_by", sql.NVarChar, modified_by)
      .query(`EXEC sp_user_company_mapping @mode, @company_code, @user_code, @company_no, @location_no, 
          @status, @order_no,@keyfiels,'',@modified_by,'', '', '', '', '', '', '', ''`);
    res.status(200).json("Edited data saved successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const RoleMappingUpdate = async (req, res) => {
  const { company_code, user_code, role_id, keyfield, modified_by } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    await pool
      .request()
      .input("mode", sql.NVarChar, "U")
      .input("company_code", sql.NVarChar, company_code)
      .input("user_code", sql.VarChar, user_code)
      .input("role_id", sql.VarChar, role_id)
      .input("keyfield", sql.VarChar, keyfield)
      .input("modified_by", sql.VarChar, modified_by)
      .query(`EXEC sp_user_rolemapping @mode,@company_code,@user_code,'',@role_id,'',@keyfield,'',@modified_by,'','','','','','','',''`);

    res.status(200).json("Edited data saved successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const AttributeUpdate = async (req, res) => {
  const { company_code, attributeheader_code, attributedetails_code, attributedetails_name, descriptions, created_by, modified_by } = req.body;

  let pool;
  try {
    pool = await connection.connectToDatabase();

    await pool.request()
      .input("mode", sql.NVarChar, "U")
      .input("company_code", sql.NVarChar, company_code)
      .input("attributeheader_code", sql.NVarChar, attributeheader_code)
      .input("attributedetails_code", sql.NVarChar, attributedetails_code)
      .input("attributedetails_name", sql.NVarChar, attributedetails_name)
      .input("descriptions", sql.NVarChar, descriptions)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .query(
        `EXEC sp_attribute_Info @mode,@company_code, @attributeheader_code, @attributedetails_code, @attributedetails_name, @descriptions, @created_by,@modified_by, '', '', '', '', '', '', '', ''`
      );
    res.status(200).json("Updated data successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const NumberSeriesUpdate = async (req, res) => {
  const { company_code, Screen_Type, Start_Year, End_Year, Start_No, Running_No, End_No, text, number_prefix, Status, created_by, modified_by } = req.body;

  let pool;
  try {
    pool = await connection.connectToDatabase();

    await pool
      .request()
      .input("mode", sql.NVarChar, "U")
      .input("company_code", sql.NVarChar, company_code)
      .input("Screen_Type", sql.NVarChar, Screen_Type)
      .input("Start_Year", sql.NVarChar, Start_Year)
      .input("End_Year", sql.NVarChar, End_Year)
      .input("Start_No", sql.Int, Start_No)
      .input("Running_No", sql.Int, Running_No)
      .input("End_No", sql.Int, End_No)
      .input("text", sql.NVarChar, text)
      .input("number_prefix", sql.NVarChar, number_prefix)
      .input("Status", sql.NVarChar, Status)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .query(`EXEC sp_numberseries @mode, @company_code,@Screen_Type, @Start_Year, @End_Year, @Start_No, @Running_No,@End_No,@text,@number_prefix,
             @Status,@created_by,@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,''`);

    res.status(200).json("Edited data saved successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const ItemUpdate = async (req, res) => {
  const { company_code, Item_code, Item_variant, Item_name, Item_wigh, Item_BaseUOM, Item_SecondaryUOM, Item_short_name, Item_Last_salesRate_ExTax,
    Item_Last_salesRate_IncludingTax, Item_std_purch_price, Item_std_sales_price, Item_stock_code, Item_purch_tax_type,
    Item_sales_tax_type, Item_Costing_Method, Item_stock_type, hsn, Item_Register_Brand, Item_Our_Brand,
    status, Item_other_purch_taxtype, Item_other_sales_taxtype, MRP_price, discount_Percentage, created_by, modified_by
  } = req.body;

  let item_images = null;

  if (req.file) {
    item_images = req.file.buffer; // Buffer containing the uploaded image
  }

  try {
    pool = await connection.connectToDatabase();

    await pool
      .request()
      .input("mode", sql.NVarChar, "U")
      .input("company_code", sql.NVarChar, company_code)
      .input("Item_code", sql.NVarChar, Item_code)
      .input("Item_variant", sql.NVarChar, Item_variant)
      .input("Item_name", sql.VarChar, Item_name)
      .input("Item_wigh", sql.Decimal(10, 2), Item_wigh)
      .input("Item_BaseUOM", sql.NVarChar, Item_BaseUOM)
      .input("Item_SecondaryUOM", sql.NVarChar, Item_SecondaryUOM)
      .input("Item_short_name", sql.NVarChar, Item_short_name)
      .input("Item_Last_salesRate_ExTax", sql.Decimal(12, 2), Item_Last_salesRate_ExTax)
      .input("Item_Last_salesRate_IncludingTax", sql.Decimal(12, 2), Item_Last_salesRate_IncludingTax)
      .input("Item_std_purch_price", sql.Decimal(12, 2), Item_std_purch_price)
      .input("Item_std_sales_price", sql.Decimal(12, 2), Item_std_sales_price)
      .input("Item_stock_code", sql.VarChar, Item_stock_code)
      .input("Item_purch_tax_type", sql.VarChar, Item_purch_tax_type)
      .input("Item_sales_tax_type", sql.VarChar, Item_sales_tax_type)
      .input("Item_Costing_Method", sql.VarChar, Item_Costing_Method)
      .input("Item_stock_type", sql.VarChar, Item_stock_type)
      .input("hsn", sql.VarChar, hsn)
      .input("Item_Register_Brand", sql.VarChar, Item_Register_Brand)
      .input("Item_Our_Brand", sql.VarChar, Item_Our_Brand)
      .input("status", sql.VarChar, status)
      .input("item_images", sql.VarBinary, item_images)
      .input("Item_other_purch_taxtype", sql.VarChar, Item_other_purch_taxtype)
      .input("Item_other_sales_taxtype", sql.VarChar, Item_other_sales_taxtype)
      .input("MRP_price", sql.Decimal(10, 2), MRP_price)
      .input("discount_Percentage", sql.Decimal(5, 2), discount_Percentage)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .query(`EXEC sp_item_brand_info @mode, @company_code, @Item_code, @Item_variant, @Item_name, @Item_wigh,
                        @Item_BaseUOM, @Item_SecondaryUOM, @Item_short_name, @Item_Last_salesRate_ExTax, @Item_Last_salesRate_IncludingTax,
                        @Item_std_purch_price, @Item_std_sales_price, @Item_stock_code, @Item_purch_tax_type, @Item_sales_tax_type,
                        @Item_Costing_Method, @Item_stock_type, @hsn, @Item_Register_Brand, @Item_Our_Brand, @status,@item_images,'',@Item_other_purch_taxtype,@Item_other_sales_taxtype,@MRP_price,@discount_Percentage,
                        '',@created_by, @modified_by, NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);


    res.status(200).json("Edited data saved successfully");
  } catch (error) {
    if (error.class === 16 && error.number === 50000) {
      // Custom error from the stored procedure
      res.status(400).json({ message: error.message });
    } else {
      // Handle unexpected errors
      res.status(500).json({ message: 'Internal Server Error', error: error.message });
    }
  }
};

const TaxUpdate = async (req, res) => {
  const { company_code, tax_type_header, tax_name_details, tax_accountcode, tax_percentage, tax_shortname, transaction_type, status, created_by, modified_by } = req.body;

  let pool;
  try {
    pool = await connection.connectToDatabase();

    await pool.request()
      .input("mode", sql.NVarChar, "U")
      .input("company_code", sql.VarChar, company_code)
      .input("tax_type_header", sql.NVarChar, tax_type_header)
      .input("tax_name_details", sql.NVarChar, tax_name_details)
      .input("tax_accountcode", sql.NVarChar, tax_accountcode)
      .input("tax_percentage", sql.Decimal(14, 2), tax_percentage)
      .input("tax_shortname", sql.NVarChar, tax_shortname)
      .input("transaction_type", sql.NVarChar, transaction_type)
      .input("status", sql.NVarChar, status)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .query(
        `EXEC sp_tax_name_details @mode,@company_code,@tax_type_header, @tax_name_details, @tax_percentage, @tax_shortname, @tax_accountcode,
               @transaction_type, @status,@created_by,@modified_by, '', '', '', '', '', '','', ''`);

    res.status(200).json("Updated data successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const WarehouseUpdate = async (req, res) => {
  const { company_code, warehouse_code, warehouse_name, status, location_no, created_by, modified_by } = req.body;

  let pool;

  try {
    pool = await connection.connectToDatabase();
    await pool
      .request()
      .input("mode", sql.NVarChar, "U") // update mode
      .input("company_code", sql.NVarChar, company_code)
      .input("warehouse_code", sql.NVarChar, warehouse_code)
      .input("warehouse_name", sql.NVarChar, warehouse_name)
      .input("status", sql.NVarChar, status)
      .input("location_no", sql.NVarChar, location_no)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .query(
        `EXEC sp_warehouse_info @mode ,@company_code, @warehouse_code, @warehouse_name, @status, @location_no, 
                 @created_by,@modified_by, '', '', '', '','', '', '', ''` );
    res.status(200).json("Edited data saved successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const VendorUpdate = async (req, res) => {
  const { vendor_code, company_code, vendor_name, vendor_gst_no, vendor_addr_1, vendor_addr_2, vendor_addr_3, vendor_addr_4,
    vendor_area_code, vendor_state_code, vendor_country_code, vendor_imex_no, vendor_office_no, vendor_resi_no, vendor_mobile_no,
    vendor_fax_no, vendor_email_id, vendor_credit_limit, vendor_transport_code, vendor_salesman_code, vendor_broker_code,
    vendor_weekday_code, contact_person, office_type, keyfield, modified_by } = req.body;

  let pool;
  try {
    pool = await connection.connectToDatabase();

    await pool.request()
      .input("mode", sql.NVarChar, "U")
      .input("vendor_code", sql.NVarChar, vendor_code)
      .input("company_code", sql.NVarChar, company_code)
      .input("vendor_name", sql.NVarChar, vendor_name)
      .input("vendor_gst_no", sql.NVarChar, vendor_gst_no)
      .input("vendor_addr_1", sql.NVarChar, vendor_addr_1)
      .input("vendor_addr_2", sql.NVarChar, vendor_addr_2)
      .input("vendor_addr_3", sql.NVarChar, vendor_addr_3)
      .input("vendor_addr_4", sql.NVarChar, vendor_addr_4)
      .input("vendor_area_code", sql.NVarChar, vendor_area_code)
      .input("vendor_state_code", sql.NVarChar, vendor_state_code)
      .input("vendor_country_code", sql.NVarChar, vendor_country_code)
      .input("vendor_imex_no", sql.NVarChar, vendor_imex_no)
      .input("vendor_office_no", sql.NVarChar, vendor_office_no)
      .input("vendor_resi_no", sql.NVarChar, vendor_resi_no)
      .input("vendor_mobile_no", sql.NVarChar, vendor_mobile_no)
      .input("vendor_fax_no", sql.NVarChar, vendor_fax_no)
      .input("vendor_email_id", sql.NVarChar, vendor_email_id)
      .input("vendor_credit_limit", sql.Decimal(14, 3), vendor_credit_limit)
      .input("vendor_transport_code", sql.NVarChar, vendor_transport_code)
      .input("vendor_salesman_code", sql.NVarChar, vendor_salesman_code)
      .input("vendor_broker_code", sql.NVarChar, vendor_broker_code)
      .input("vendor_weekday_code", sql.NVarChar, vendor_weekday_code)
      .input("contact_person", sql.NVarChar, contact_person)
      .input("office_type", sql.NVarChar, office_type)
      .input("keyfield", sql.NVarChar, keyfield)
      .input("modified_by", sql.NVarChar, modified_by)
      .query(`EXEC sp_vendor_details_info_hdr @mode,@vendor_code,@company_code,@vendor_name,'','',@vendor_gst_no,@vendor_addr_1,@vendor_addr_2,@vendor_addr_3,
              @vendor_addr_4,@vendor_area_code,@vendor_state_code ,@vendor_country_code,@vendor_imex_no,@vendor_office_no,@vendor_resi_no,@vendor_mobile_no,@vendor_fax_no,@vendor_email_id,
              @vendor_credit_limit,@vendor_transport_code,@vendor_salesman_code,@vendor_broker_code,@vendor_weekday_code, @contact_person,@office_type,@keyfield,'', @modified_by, '', '', '', '',
               '', '', '', ''`);

    res.status(200).json("Updated data successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//ced ended by pavun

// Code Added By Harish

const addadjustmenthdr = async (req, res) => {
  const { company_code, transaction_no, transaction_date, transaction_type, Data_deleted, created_by, modified_by,
    tempstr1, tempstr2, tempstr3, tempstr4, datetime1, datetime2, datetime3, datetime4,

  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .input("transaction_date", sql.Date, transaction_date)
      .input("transaction_type", sql.NVarChar, transaction_type)
      .input("Data_deleted", sql.NVarChar, Data_deleted)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(`EXEC [sp_adjustment_hdr] @mode,@transaction_no,@company_code,@transaction_date,@transaction_type,
        @Data_deleted,@created_by,@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`)

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    }
  } catch (err) {
    console.error("Error inserting data:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};


const Adjustmnetdelhdr = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    // Use input parameter binding without single quotes
    await pool.request()
      .input("transaction_no", transaction_no)
      .input("company_code", company_code)
      .query(`EXEC [sp_adjustment_hdr] 'D', @transaction_no, @company_code, '', '', '', '', '', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL`);

    res.status(200).json("Adjustment Header deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const adjustmentupdatehdr = async (req, res) => {
  const { transaction_no, company_code, transaction_date, transaction_type, Data_deleted, modified_by, created_by } = req.body;
  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "U")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .input("transaction_date", sql.NVarChar, transaction_date)
      .input("transaction_type", sql.NVarChar, transaction_type)
      .input("Data_deleted", sql.NVarChar, Data_deleted)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)

      .query(`EXEC [sp_adjustment_hdr] @mode,@transaction_no,@company_code,@transaction_date,@transaction_type,@Data_deleted,@created_by,	@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
`);
    res.json({ success: true, message: "Data inserted successfully" });
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const getalladjustmnethdr = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`EXEC [sp_adjustment_hdr] 'A','','','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
`);

    res.json(result.recordset);
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const addadjustmnetdetails = async (req, res) => {
  const {
    transaction_no, company_code, transaction_date, transaction_type, item_code, qty, Item_SNo, created_by, modified_by,
    tempstr1, tempstr2, tempstr3, tempstr4, datetime1, datetime2, datetime3, datetime4
  } = req.body;

  let pool;
  try {
    pool = await sql.connect(dbConfig);


    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .input("transaction_date", sql.Date, transaction_date)
      .input("transaction_type", sql.NVarChar, transaction_type)
      .input("item_code", sql.NVarChar, item_code)
      .input("qty", sql.Decimal(10, 2), qty)
      .input("Item_SNo", sql.BigInt, Item_SNo)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.DateTime, datetime1)
      .input("datetime2", sql.DateTime, datetime2)
      .input("datetime3", sql.DateTime, datetime3)
      .input("datetime4", sql.DateTime, datetime4)
      .query(`EXEC [sp_adjustment_details] @mode, @transaction_no, @company_code, @transaction_date, @transaction_type, @item_code, @qty,@Item_SNo, '', @created_by, '', 
        @tempstr1, @tempstr2, @tempstr3, @tempstr4, @datetime1, @datetime2, @datetime3, @datetime4`);

    // Respond with a success message
    res.json({ success: true, message: "Data inserted successfully" });
  } catch (err) {
    console.error("Error inserting data:", err);

    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};


const adjustmnetdeletedetails = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    await pool.request()
      .input("transaction_no", transaction_no)
      .input("company_code", company_code)
      .query(`EXEC [sp_adjustment_details] 'D',@transaction_no,@company_code,'','','',0,0,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    res.status(200).json("purchase deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getalladjustmnetdetails = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`EXEC [sp_adjustment_details] 'A','','','','','',0,0,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL

`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const addOpeningbalHdr = async (req, res) => {
  const { transaction_no, company_code, transaction_date, created_by, modified_by,
    tempstr1, tempstr2, tempstr3, tempstr4, datetime1, datetime2, datetime3, datetime4,

  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .input("transaction_date", sql.Date, transaction_date)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(`EXEC [sp_openning_balance_hdr] @mode,@transaction_no,@company_code,@transaction_date ,
        @created_by,@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
`)

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data Added Successfully");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const OpeningBalDelhdr = async (req, res) => {
  const { transaction_no } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    await pool.request().input("transaction_no", transaction_no).query

      (`EXEC [sp_openning_balance_hdr] 'd',@transaction_no,'','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
            `);
    res.status(200).json("Opening Balance Header deleted successfully");
  }
  catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const OpeningBalanceupHdr = async (req, res) => {
  const { transaction_no, company_code, transaction_date, modified_by } = req.body;
  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "U")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .input("transaction_date", sql.NVarChar, transaction_date)
      .input("modified_by", sql.NVarChar, modified_by)

      .query(`EXEC sp_openning_balance_hdr @mode,@transaction_no,@company_code,@transaction_date,'',@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.json({ success: true, message: "Data inserted successfully" });
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const GetallopeningBalHdr = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`	EXEC [sp_openning_balance_hdr] 'A','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL

`);

    res.json(result.recordset);
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const AddOpeningBalanceDetails = async (req, res) => {
  const {
    transaction_no, company_code, transaction_date, item_type, acc_type, acct_code, journal_no, Item_SNo, debit, credit, created_by, modified_by,
    tempstr1, tempstr2, tempstr3, tempstr4, datetime1, datetime2, datetime3, datetime4,

  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .input("transaction_date", sql.Date, transaction_date)
      .input("item_type", sql.NVarChar, item_type)
      .input("acc_type", sql.NVarChar, acc_type)
      .input("acct_code", sql.NVarChar, acct_code)
      .input("journal_no", sql.NVarChar, journal_no)
      .input("Item_SNo", sql.BigInt, Item_SNo)
      .input("debit", sql.Decimal(10, 2), debit)
      .input("credit", sql.Decimal(10, 2), credit)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(
        `EXEC [sp_openning_balance_details] @mode,@transaction_no,@company_code,@transaction_date,@item_type,@acc_type,
        @acct_code,@journal_no,@Item_SNo,@debit,@credit,@created_by,'',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL

`);
    res.json({ success: true, message: "Data inserted successfully" });
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const OpeningBaldeletedet = async (req, res) => {
  const { transaction_no } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    await pool.request().input("transaction_no", transaction_no).query(`
    EXEC [sp_openning_balance_details] 'd',@transaction_no,'','','','','','',0,0,0,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
        `);

    res.status(200).json("Opening deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getallopeningBalDet = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`EXEC [sp_openning_balance_details] 'A','','','','','','','',0,0,0,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const AddJournalHdr = async (req, res) => {
  const { journal_no, company_code, transaction_date, created_by, modified_by,
    tempstr1, tempstr2, tempstr3, tempstr4, datetime1, datetime2, datetime3, datetime4,

  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("journal_no", sql.NVarChar, journal_no)
      .input("company_code", sql.NVarChar, company_code)
      .input("transaction_date", sql.Date, transaction_date)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(`EXEC [sp_journal_hdr] @mode,@journal_no,@company_code	,@transaction_date,@created_by,'',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
`)

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data added successfully");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const JournaDeleteHdr = async (req, res) => {

  const { journal_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    await pool.request()
      .input("journal_no", journal_no)
      .input("company_code", company_code)
      .query(`EXEC [sp_journal_hdr] 'D',@journal_no,@company_code,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.status(200).json("Journal Header deleted successfully");
  }
  catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const JournalUpdateHdr = async (req, res) => {
  const { journal_no, company_code, transaction_date, modified_by } = req.body;
  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "U")
      .input("journal_no", sql.NVarChar, journal_no)
      .input("company_code", sql.NVarChar, company_code)
      .input("transaction_date", sql.NVarChar, transaction_date)
      .input("modified_by", sql.NVarChar, modified_by)

      .query(`EXEC [sp_journal_hdr] @mode,@journal_no,@company_code,@transaction_date,'',@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
`);
    res.json({ success: true, message: "Data inserted successfully" });
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const GetAllJournalHdr = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`EXEC [sp_journal_hdr] 'A','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL

`);

    res.json(result.recordset);
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const AddJournalDetails = async (req, res) => {
  const {
    journal_no, company_code, transaction_date, transaction_type, original_accountcode, contra_accountCode, journal_amount, Item_SNo, narration1, narration2, narration3, narration4, created_by, modified_by,
    tempstr1, tempstr2, tempstr3, tempstr4, datetime1, datetime2, datetime3, datetime4,

  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("journal_no", sql.NVarChar, journal_no)
      .input("company_code", sql.NVarChar, company_code)
      .input("transaction_date", sql.Date, transaction_date)
      .input("transaction_type", sql.NVarChar, transaction_type)
      .input("original_accountcode", sql.NVarChar, original_accountcode)
      .input("contra_accountCode", sql.NVarChar, contra_accountCode)
      .input("journal_amount", sql.Decimal(14, 3), journal_amount)
      .input("Item_SNo", sql.BigInt, Item_SNo)
      .input("narration1", sql.NVarChar, narration1)
      .input("narration2", sql.NVarChar, narration2)
      .input("narration3", sql.NVarChar, narration3)
      .input("narration4", sql.NVarChar, narration4)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(
        `EXEC [sp_journal_details] @mode,@journal_no,@company_code,@transaction_date,@transaction_type,@original_accountcode,
        @contra_accountCode,@journal_amount,@Item_SNo,@narration1,@narration2,@narration3,@narration4,'',@created_by,'',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL


`);
    res.json({ success: true, message: "Data inserted successfully" });
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};



const JournalDeletedet = async (req, res) => {
  const { journal_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    await pool.request()
      .input("journal_no", journal_no)
      .input("company_code", company_code)
      .query(`EXEC [sp_journal_details] 'D',@journal_no,@company_code,'','','','',0,0,'','','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    res.status(200).json("Journal Data deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const GetAllJournalDet = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`EXEC [sp_journal_details] 'A','','','','','','',0,0,'','','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL

`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//Code Ended By Harish
//Code added by Harish 08/10/2024
const AdjustmnethdrPrint = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool.request()
      .input("mode", sql.NVarChar, "AH")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_print @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    // Process result sets
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const AdjustmnetdetPrint = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool.request()
      .input("mode", sql.NVarChar, "AD")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_print @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    // Process result sets
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getadjustmentdata = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {

    const pool = await connection.connectToDatabase();


    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "AHD")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_getdata @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);


    if (result.recordsets && result.recordsets.length > 0 && result.recordsets[0].length > 0) {
      const data = {
        Header: result.recordsets[0],
        Detail: result.recordsets[1] || []
      };
      res.status(200).json(data);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//code ended by Harish  08/10/2024

//code added by pavun 08-10-2024
const CustomerUpdate = async (req, res) => {
  const { customer_code, company_code, customer_name, customer_gst_no, customer_addr_1, customer_addr_2, customer_addr_3,
    customer_addr_4, customer_area, customer_state, customer_country, customer_imex_no, customer_office_no, customer_resi_no,
    customer_mobile_no, customer_fax_no, customer_email_id, customer_credit_limit, customer_transport_code, customer_salesman_code,
    customer_broker_code, customer_weekday_code, contact_person, office_type, default_customer, keyfield, modified_by
  } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    await pool.request()
      .input("mode", sql.NVarChar, "U")
      .input("customer_code", sql.NVarChar, customer_code)
      .input("company_code", sql.NVarChar, company_code)
      .input("customer_name", sql.NVarChar, customer_name)
      .input("customer_gst_no", sql.NVarChar, customer_gst_no)
      .input("customer_addr_1", sql.NVarChar, customer_addr_1)
      .input("customer_addr_2", sql.NVarChar, customer_addr_2)
      .input("customer_addr_3", sql.NVarChar, customer_addr_3)
      .input("customer_addr_4", sql.NVarChar, customer_addr_4)
      .input("customer_area", sql.NVarChar, customer_area)
      .input("customer_state", sql.NVarChar, customer_state)
      .input("customer_country", sql.NVarChar, customer_country)
      .input("customer_imex_no", sql.NVarChar, customer_imex_no)
      .input("customer_office_no", sql.NVarChar, customer_office_no)
      .input("customer_resi_no", sql.NVarChar, customer_resi_no)
      .input("customer_mobile_no", sql.NVarChar, customer_mobile_no)
      .input("customer_fax_no", sql.NVarChar, customer_fax_no)
      .input("customer_email_id", sql.NVarChar, customer_email_id)
      .input("customer_credit_limit", sql.Decimal(14, 3), customer_credit_limit)
      .input("customer_transport_code", sql.NVarChar, customer_transport_code)
      .input("customer_salesman_code", sql.NVarChar, customer_salesman_code)
      .input("customer_broker_code", sql.NVarChar, customer_broker_code)
      .input("customer_weekday_code", sql.NVarChar, customer_weekday_code)
      .input("contact_person", sql.NVarChar, contact_person)
      .input("office_type", sql.NVarChar, office_type)
      .input("default_customer", sql.NVarChar, default_customer)
      .input("keyfield", sql.NVarChar, keyfield)
      .input("modified_by", sql.NVarChar, modified_by)
      .query(`EXEC sp_customer_details_info @mode,@customer_code,@company_code,@customer_name,'','',@customer_gst_no,
          @customer_addr_1,@customer_addr_2,@customer_addr_3,@customer_addr_4,@customer_area,@customer_state ,@customer_country,
          @customer_imex_no,@customer_office_no,@customer_resi_no,@customer_mobile_no,@customer_fax_no,@customer_email_id,@customer_credit_limit,@customer_transport_code,
          @customer_salesman_code,@customer_broker_code,@customer_weekday_code,@contact_person,@office_type,@default_customer,@keyfield,'', @modified_by, '', '', '', '', '',
          '', '', ''`);

    res.status(200).json("Updated data successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
const IntermediaryUpdate = async (req, res) => {
  const { company_code, Code, codeDetails, intermediary_addr_1, intermediary_addr_2, intermediary_addr_3, intermediary_addr_4, intermediary_area_code, intermediary_stat_code,
    intermediary_cnty_code, intermediary_imex_no, intermediary_office_no, intermediary_resi_no, intermediary_mobile_no, intermediary_fax_no, intermediary_email_id,
    created_by, modified_by
  } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    await pool.request()
      .input("mode", sql.NVarChar, "U")
      .input("company_code", sql.NVarChar, company_code)
      .input("Code", sql.NVarChar, Code)
      .input("codeDetails", sql.NVarChar, codeDetails)
      .input("intermediary_addr_1", sql.NVarChar, intermediary_addr_1)
      .input("intermediary_addr_2", sql.NVarChar, intermediary_addr_2)
      .input("intermediary_addr_3", sql.NVarChar, intermediary_addr_3)
      .input("intermediary_addr_4", sql.NVarChar, intermediary_addr_4)
      .input("intermediary_area_code", sql.NVarChar, intermediary_area_code)
      .input("intermediary_stat_code", sql.NVarChar, intermediary_stat_code)
      .input("intermediary_cnty_code", sql.NVarChar, intermediary_cnty_code)
      .input("intermediary_imex_no", sql.NVarChar, intermediary_imex_no)
      .input("intermediary_office_no", sql.NVarChar, intermediary_office_no)
      .input("intermediary_resi_no", sql.NVarChar, intermediary_resi_no)
      .input("intermediary_mobile_no", sql.NVarChar, intermediary_mobile_no)
      .input("intermediary_fax_no", sql.NVarChar, intermediary_fax_no)
      .input("intermediary_email_id", sql.NVarChar, intermediary_email_id)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .query(
        `EXEC sp_intermediary_details @mode, @company_code, @Code, @codeDetails, @intermediary_addr_1, @intermediary_addr_2, 
          @intermediary_addr_3, @intermediary_addr_4, @intermediary_area_code, @intermediary_stat_code, @intermediary_cnty_code, @intermediary_imex_no,
           @intermediary_office_no, @intermediary_resi_no, @intermediary_mobile_no, @intermediary_fax_no, @intermediary_email_id, @created_by, @modified_by,
            '', '', '', '', '', '', '', ''`);

    res.status(200).json("Updated data successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const BankAccountUpdate = async (req, res) => {
  const { company_code, account_code, account_name, acc_addr_1, acc_addr_2, acc_addr_3, acc_addr_4, acc_area_code, acc_state_code, acc_country_code,
    base_accgroup_code, standard_accgroup_code, user_accgroup_code, account_number, IFSC_code, account_type, branch, modified_by, default_bank
  } = req.body;

  let bank_paymentQRCode = null;

  if (req.file) {
    bank_paymentQRCode = req.file.buffer;
  }

  try {
    const pool = await connection.connectToDatabase(dbConfig);

    await pool
      .request()
      .input("mode", sql.NVarChar, "U") // update mode
      .input("company_code", sql.NVarChar, company_code)
      .input("account_code", sql.NVarChar, account_code)
      .input("account_name", sql.NVarChar, account_name)
      .input("acc_addr_1", sql.NVarChar, acc_addr_1)
      .input("acc_addr_2", sql.NVarChar, acc_addr_2)
      .input("acc_addr_3", sql.NVarChar, acc_addr_3)
      .input("acc_addr_4", sql.NVarChar, acc_addr_4)
      .input("acc_area_code", sql.NVarChar, acc_area_code)
      .input("acc_state_code", sql.NVarChar, acc_state_code)
      .input("acc_country_code", sql.NVarChar, acc_country_code)
      .input("base_accgroup_code", sql.NVarChar, base_accgroup_code)
      .input("standard_accgroup_code", sql.NVarChar, standard_accgroup_code)
      .input("user_accgroup_code", sql.NVarChar, user_accgroup_code)
      .input("account_number", sql.NVarChar, account_number)
      .input("IFSC_code", sql.NVarChar, IFSC_code)
      .input("account_type", sql.NVarChar, account_type)
      .input("branch", sql.NVarChar, branch)
      .input("bank_paymentQRCode", sql.VarBinary, bank_paymentQRCode)
      .input("default_bank", sql.VarChar, default_bank)
      .input("modified_by", sql.NVarChar, modified_by)
      .query(`EXEC sp_account_name @mode,@company_code,@account_code,@account_name,@acc_addr_1,@acc_addr_2,@acc_addr_3,@acc_addr_4,
          @acc_area_code,@acc_state_code,@acc_country_code,'','','','','',
          '',0,'','','','',@base_accgroup_code,@standard_accgroup_code,@user_accgroup_code,'','',@account_number,@IFSC_code,@account_type,@branch,'','','',
          @bank_paymentQRCode,@default_bank,'',@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,''`);

    res.status(200).json("Edited data saved successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const DepartmentUpdate = async (req, res) => {
  const { dept_name, key_field, modified_by } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    await pool
      .request()
      .input("mode", sql.NVarChar, "U")
      .input("dept_name", sql.NVarChar, dept_name)
      .input("key_field", sql.NVarChar, key_field)
      .input("modified_by", sql.NVarChar, modified_by)
      .query(`EXEC sp_department @mode,'',@dept_name,'',@key_field,'',@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    res.status(200).json("Edited data saved successfully");
  } catch (error) {
    if (error.class === 16 && error.number === 50000) {
      // Custom error from the stored procedure
      res.status(400).json({ message: error.message });
    } else {
      // Handle unexpected errors
      res.status(500).json({ message: 'Internal Server Error', error: error.message });
    }
  }
};

const DesgintionUpdate = async (req, res) => {
  const { dept_id, desgination_id, desgination, status, company_code, keyfield, created_by, modified_by } = req.body;


  try {
    const pool = await connection.connectToDatabase();

    await pool
      .request()
      .input("mode", sql.NVarChar, "U")
      .input("dept_id", sql.NVarChar, dept_id)
      .input("desgination_id", sql.NVarChar, desgination_id)
      .input("desgination", sql.NVarChar, desgination)
      .input("status", sql.NVarChar, status)
      .input("company_code", sql.NVarChar, company_code)
      .input("keyfield", sql.NVarChar, keyfield)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .query(`EXEC sp_desgination @mode,@dept_id,@desgination_id,@desgination,@status,@company_code,@keyfield,@created_by,@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    res.status(200).json("Edited data saved successfully");
  } catch (error) {
    if (error.class === 16 && error.number === 50000) {
      // Custom error from the stored procedure
      res.status(400).json({ message: error.message });
    } else {
      // Handle unexpected errors
      res.status(500).json({ message: 'Internal Server Error', error: error.message });
    }
  }
};

const EmployeeUpdate = async (req, res) => {
  const { employee_name, fathername, doj, dob, mob_no, emg_mob_no, employee_type, dept_id, desgination, qualification,
    address, city, keyfield, modified_by
  } = req.body;


  try {
    const pool = await connection.connectToDatabase();

    await pool
      .request()
      .input("mode", sql.NVarChar, "U")
      .input("employee_name", sql.NVarChar, employee_name)
      .input("fathername", sql.NVarChar, fathername)
      .input("doj", sql.NVarChar, doj)
      .input("dob", sql.NVarChar, dob)
      .input("mob_no", sql.NVarChar, mob_no)
      .input("emg_mob_no", sql.NVarChar, emg_mob_no)
      .input("employee_type", sql.NVarChar, employee_type)
      .input("dept_id", sql.NVarChar, dept_id)
      .input("desgination", sql.NVarChar, desgination)
      .input("qualification", sql.NVarChar, qualification)
      .input("address", sql.NVarChar, address)
      .input("city", sql.NVarChar, city)
      .input("keyfield", sql.NVarChar, keyfield)
      .input("modified_by", sql.NVarChar, modified_by)
      .query(`EXEC sp_employee_info @mode,'',@employee_name,@fathername,@doj,@dob,@mob_no,@emg_mob_no,@employee_type,@dept_id,@desgination,@qualification,@address,@city,'',@keyfield,'', 
         @modified_by,'','','','','','','',''`);

    res.status(200).json("Edited data saved successfully");
  } catch (error) {
    if (error.class === 16 && error.number === 50000) {
      // Custom error from the stored procedure
      res.status(400).json({ message: error.message });
    } else {
      // Handle unexpected errors
      res.status(500).json({ message: 'Internal Server Error', error: error.message });
    }
  }
};

const BaseAccountUpdate = async (req, res) => {
  const { base_accgroup_code, base_accgroup_name, status, modified_by } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    await pool
      .request()
      .input("mode", sql.NVarChar, "U")
      .input("base_accgroup_code", sql.NVarChar, base_accgroup_code)
      .input("base_accgroup_name", sql.NVarChar, base_accgroup_name)
      .input("status", sql.NVarChar, status)
      .input("modified_by", sql.NVarChar, modified_by)
      .query(`EXEC sp_Base_Account_group @mode, @base_accgroup_code, @base_accgroup_name, @status,  '' , @modified_by,
         '', '', '', '', '', '', '', ''`);

    res.status(200).json("Edited data saved successfully");
  } catch (error) {
    if (error.class === 16 && error.number === 50000) {
      // Custom error from the stored procedure
      res.status(400).json({ message: error.message });
    } else {
      // Handle unexpected errors
      res.status(500).json({ message: 'Internal Server Error', error: error.message });
    }
  }
};

const COAUpdate = async (req, res) => { //charts of accounts 
  const { company_code, account_code, account_name, acc_addr_1, acc_addr_2, acc_addr_3, acc_addr_4, acc_area_code, acc_state_code, acc_country_code, acc_imex_no,
    acc_office_no, acc_resi_no, acc_mobile_no, acc_fax_no, acc_email_id, acc_credit_limit, acc_transport_code, acc_salesman_code, acc_broker_code,
    acc_weekday_code, base_accgroup_code, standard_accgroup_code, user_accgroup_code, account_subcode, status, panno,
    gst_no, created_by, modified_by
  } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    await pool
      .request()
      .input("mode", sql.NVarChar, "U") // update mode
      .input("company_code", sql.NVarChar, company_code)
      .input("account_code", sql.NVarChar, account_code)
      .input("account_name", sql.NVarChar, account_name)
      .input("acc_addr_1", sql.NVarChar, acc_addr_1)
      .input("acc_addr_2", sql.NVarChar, acc_addr_2)
      .input("acc_addr_3", sql.NVarChar, acc_addr_3)
      .input("acc_addr_4", sql.NVarChar, acc_addr_4)
      .input("acc_area_code", sql.NVarChar, acc_area_code)
      .input("acc_state_code", sql.NVarChar, acc_state_code)
      .input("acc_country_code", sql.NVarChar, acc_country_code)
      .input("acc_imex_no", sql.NVarChar, acc_imex_no)
      .input("acc_office_no", sql.NVarChar, acc_office_no)
      .input("acc_resi_no", sql.NVarChar, acc_resi_no)
      .input("acc_mobile_no", sql.NVarChar, acc_mobile_no)
      .input("acc_fax_no", sql.NVarChar, acc_fax_no)
      .input("acc_email_id", sql.NVarChar, acc_email_id)
      .input("acc_credit_limit", sql.Decimal(14, 3), acc_credit_limit)
      .input("acc_transport_code", sql.NVarChar, acc_transport_code)
      .input("acc_salesman_code", sql.NVarChar, acc_salesman_code)
      .input("acc_broker_code", sql.NVarChar, acc_broker_code)
      .input("acc_weekday_code", sql.NVarChar, acc_weekday_code)
      .input("base_accgroup_code", sql.NVarChar, base_accgroup_code)
      .input("standard_accgroup_code", sql.NVarChar, standard_accgroup_code)
      .input("user_accgroup_code", sql.NVarChar, user_accgroup_code)
      .input("account_subcode", sql.NVarChar, account_subcode)
      .input("status", sql.NVarChar, status)
      .input("panno", sql.NVarChar, panno)
      .input("gst_no", sql.NVarChar, gst_no)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .query(`EXEC sp_account_name @mode,@company_code,@account_code,@account_name,@acc_addr_1,@acc_addr_2,@acc_addr_3,@acc_addr_4,
          @acc_area_code,@acc_state_code,@acc_country_code,@acc_imex_no,@acc_office_no,@acc_resi_no,@acc_mobile_no,@acc_fax_no,
          @acc_email_id,@acc_credit_limit,@acc_transport_code,@acc_salesman_code,@acc_broker_code,@acc_weekday_code,@base_accgroup_code,
          @standard_accgroup_code,@user_accgroup_code,@account_subcode,@status,'','','','',@panno,@gst_no,'','','',
          @created_by,@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,''`);

    res.status(200).json("Edited data saved successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const StandardAccUpdate = async (req, res) => {
  const { standard_accgroup_code, standard_accgroup_name, base_accgroup_code, user_accgroup_from, user_accgroup_to, status, deletePermission, created_by, modified_by } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    await pool.request()
      .input("mode", sql.NVarChar, "U")
      .input("standard_accgroup_code", sql.NVarChar, standard_accgroup_code)
      .input("standard_accgroup_name", sql.NVarChar, standard_accgroup_name)
      .input("base_accgroup_code", sql.NVarChar, base_accgroup_code)
      .input("user_accgroup_from", sql.NVarChar, user_accgroup_from)
      .input("user_accgroup_to", sql.NVarChar, user_accgroup_to)
      .input("status", sql.NVarChar, status)
      .input("deletePermission", sql.NVarChar, deletePermission)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .query(`EXEC sp_standard_account_group @mode,@standard_accgroup_code,@standard_accgroup_name, @base_accgroup_code	,@user_accgroup_from,@user_accgroup_to,@status,@deletePermission,@created_by,@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    res.status(200).json("Updated data successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const UserAccGrpUpdate = async (req, res) => {
  const { user_accgroup_code, user_accgroup_name, standard_accgroup_code, base_accgroup_code, status, created_by, modified_by } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    await pool
      .request()
      .input("mode", sql.NVarChar, "U")
      .input("user_accgroup_code", sql.NVarChar, user_accgroup_code)
      .input("user_accgroup_name", sql.NVarChar, user_accgroup_name)
      .input("standard_accgroup_code", sql.NVarChar, standard_accgroup_code)
      .input("base_accgroup_code", sql.NVarChar, base_accgroup_code)
      .input("status", sql.NVarChar, status)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .query(`EXEC sp_user_account_group @mode,@user_accgroup_code, @user_accgroup_name, @standard_accgroup_code, @base_accgroup_code, @status,
          @created_by,@modified_by, '', '', '', '', '', '', '', ''`);
    res.status(200).json("Edited data saved successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//code added by pavun 09-10-2024
const getOpeningBalance = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "OB")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_getdata @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);

    // Check if data is found
    if (result.recordsets && result.recordsets.length > 0 && result.recordsets[0].length > 0) {
      const data = {
        Header: result.recordsets[0],
        Detail: result.recordsets[1] || []
      };
      res.status(200).json(data); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getOpeningBalanceDetails = async (req, res) => {
  const { transaction_no } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "OBD")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .query(`EXEC sp_getdata @mode,@transaction_no,'',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);

    // Check if data is found
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const OpeningBalanceSearchData = async (req, res) => {
  const { acc_type, transaction_no, acct_code, journal_no, company_code, transaction_date } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("acc_type", sql.NVarChar, acc_type)
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("acct_code", sql.NVarChar, acct_code)
      .input("journal_no", sql.NVarChar, journal_no)
      .input("company_code", sql.NVarChar, company_code)
      .input("transaction_date", sql.NVarChar, transaction_date)
      .query(`EXEC sp_openning_balance_details @mode,@transaction_no,@company_code,'',@transaction_date,@acc_type,@acct_code,'',0,0,0,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const ObHeaderPrint = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool.request()
      .input("mode", sql.NVarChar, "OBH")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_print @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    // Process result sets
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const ObDetailPrint = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool.request()
      .input("mode", sql.NVarChar, "OBD")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_print @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    // Process result sets
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

// code added by Harish 09/10/2024
const AdjustmentSearch = async (req, res) => {
  const { transaction_no, transaction_date, transaction_type } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("transaction_date", sql.NVarChar, transaction_date)
      .input("transaction_type", sql.NVarChar, transaction_type)
      .query(`EXEC sp_adjustment_hdr @mode,@transaction_no,'',  @transaction_date,@transaction_type,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const JournalHdrPrint = async (req, res) => {
  const { journal_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool.request()
      .input("mode", sql.NVarChar, "JH")
      .input("journal_no", sql.NVarChar, journal_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_print @mode,@journal_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    // Process result sets
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const JournalDetPrint = async (req, res) => {
  const { journal_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool.request()
      .input("mode", sql.NVarChar, "JD")
      .input("journal_no", sql.NVarChar, journal_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_print @mode,@journal_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    // Process result sets
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const Journalsearch = async (req, res) => {
  const { journal_no, transaction_date } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("journal_no", sql.NVarChar, journal_no)
      .input("transaction_date", sql.NVarChar, transaction_date)
      .query(`EXEC [sp_journal_hdr] 'sc',@journal_no,'','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//Code ended by Harish 09/10/2024

//code added by Harish 10-10-2024
const getAdjustmentDetails = async (req, res) => {
  const { transaction_no } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "AD")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .query(`EXEC sp_getdata @mode,@transaction_no,'',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);

    // Check if data is found
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//code ended by Harish
//Code Added by Harish 10-10-2024
const getJournaldata = async (req, res) => {
  const { journal_no, company_code } = req.body;

  try {

    const pool = await connection.connectToDatabase();


    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "JD")
      .input("journal_no", sql.NVarChar, journal_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_getdata @mode,@journal_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);


    if (result.recordsets && result.recordsets.length > 0 && result.recordsets[0].length > 0) {
      const data = {
        Header: result.recordsets[0],
        Detail: result.recordsets[1] || []
      };
      res.status(200).json(data);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getJournalDetails = async (req, res) => {
  const { journal_no } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "Jdd")
      .input("journal_no", sql.NVarChar, journal_no)
      .query(`EXEC sp_getdata @mode,@journal_no,'',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);

    // Check if data is found
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//Code Ended by Harish 10-10-2024
//Code added By Harish 18-10-2024
const getEvent = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'Transactions Event','','', '','','', NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//Code Ended By Harish 18-10-2024

//code added by Kathir 19-10-2024

const purauthstatus = async (req, res) => {
  const { company_code, transaction_no } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "TS")
      .input("company_code", sql.NVarChar, company_code)
      .input("transaction_no", sql.NVarChar, transaction_no)
      .query(`EXEC sp_purchase_hdr @mode, @company_code, '', @transaction_no, '', '', '', '','', 0, '', 0, 0, 0, 0, '', 0, '', 0, '', 0, '', 0, '', '', '', '', '', '', '','','', '', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL`);

    // Check if any records were returned
    if (result.recordset.length === 0) {
      return res.status(404).json("Transaction not found.");
    }

    // If the transaction exists, return a success response
    return res.status(200).json(result.recordset);

  } catch (err) {
    console.error(err);
    // Send the specific SQL error message if available
    if (err.originalError && err.originalError.message) {
      return res.status(400).json(err.originalError.message);
    } else {
      return res.status(500).json({
        message: err.message || "Internal Server Error"
      });
    }
  }
};

const salauthstatus = async (req, res) => {
  const { company_code, bill_no } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "TS")
      .input("company_code", sql.NVarChar, company_code)
      .input("bill_no", sql.NVarChar, bill_no)
      .query(`EXEC sp_sales_hdr @mode,@company_code,'',@bill_no,'','','','',0,0,0,0,0,0,0,0,0,0,0,0,0,'','','','','','','','','','','',0,'','','','','','',0,0,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Check if any records were returned
    if (result.recordset.length === 0) {
      return res.status(404).json("Transaction not found.");
    }

    // If the transaction exists, return a success response
    return res.status(200).json(result.recordset);

  } catch (err) {
    console.error(err);
    // Send the specific SQL error message if available
    if (err.originalError && err.originalError.message) {
      return res.status(400).json(err.originalError.message);
    } else {
      return res.status(500).json(err.message || "Internal Server Error");
    }
  }
};

const salretauthstatus = async (req, res) => {
  const { company_code, return_no } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "TS")
      .input("company_code", sql.NVarChar, company_code)
      .input("return_no", sql.NVarChar, return_no)
      .query(`EXEC sp_sales_return_hdr @mode,@company_code,'','','',@return_no,'','','','','','',0,0,0,0,0,0,0,0,0,0,0,0,0,
'','','','','','','','','','','',0,0,0,'','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Check if any records were returned
    if (result.recordset.length === 0) {
      return res.status(404).json("Transaction not found.");
    }

    // If the transaction exists, return a success response
    return res.status(200).json(result.recordset);

  } catch (err) {
    console.error(err);
    // Send the specific SQL error message if available
    if (err.originalError && err.originalError.message) {
      return res.status(400).json(err.originalError.message);
    } else {
      return res.status(500).json({ message: err.message || 'Internal Server Error' });
    }
  }
};

const purretauthstatus = async (req, res) => {
  const { company_code, return_no } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "TS")
      .input("company_code", sql.NVarChar, company_code)
      .input("return_no", sql.NVarChar, return_no)
      .query(`EXEC sp_purchase_return_hdr_test @mode,@company_code,'',@return_no,'','','','','','',
      '','','',0,0,0,0,0,0,0,0,0,'','','',0,'','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Check if any records were returned
    if (result.recordset.length === 0) {
      return res.status(404).json("Transaction not found.");
    }

    // If the transaction exists, return a success response
    return res.status(200).json(result.recordset);

  } catch (err) {
    console.error(err);
    // Send the specific SQL error message if available
    if (err.originalError && err.originalError.message) {
      return res.status(400).json(err.originalError.message);
    } else {
      return res.status(500).json(err.message || "Internal Server Error");
    }
  }
};

//code added by kathir 21-10-2024
// const updpurchasedetail= async (req, res) => {
//   const {
//     transaction_date,transaction_no,warehouse_code,vendor_code,ItemSNo,item_code,item_name,bill_qty,bill_rate,
//     item_amt,weight,total_weight,pay_type,purchase_type,stock_type,stock_code,vendor_name,order_type,hsn,tax_amount,created_by,modified_by,
//     tempstr1,tempstr2,tempstr3,tempstr4,datetime1,datetime2,datetime3,datetime4,

//   } = req.body;
//   let pool;
//   try {
//     pool = await sql.connect(dbConfig);
//     const result = await pool
//       .request()
//       .input("mode",                            sql.NVarChar, "UT") // Insert mode
//       .input("transaction_date",                sql.Date, transaction_date)
//       .input("transaction_no",                  sql.NVarChar, transaction_no)
//       .input("warehouse_code",                  sql.NVarChar, warehouse_code)
//       .input("vendor_code",                     sql.NVarChar,vendor_code)
//       .input("ItemSNo",                         sql.BigInt,ItemSNo)
//       .input("item_code",                       sql.NVarChar,item_code)
//       .input("item_name",                       sql.NVarChar,item_name)
//       .input("bill_qty",                        sql.Decimal(10,2),bill_qty)
//       .input("bill_rate",                       sql.Decimal(10,2),bill_rate)
//       .input("item_amt",                        sql.Decimal(10,2),item_amt)
//       .input("weight",                          sql.Decimal(8,3),weight)
//       .input("total_weight",                    sql.Decimal(10,2),total_weight)
//       .input("pay_type",                        sql.NVarChar,pay_type)
//       .input("purchase_type",                   sql.NVarChar,purchase_type)
//       .input("stock_type",                      sql.NVarChar,stock_type)
//       .input("stock_code",                      sql.NVarChar,stock_code)
//       .input("vendor_name",                     sql.NVarChar,vendor_name)
//       .input("order_type",                      sql.NVarChar,order_type)
//       .input("hsn",                             sql.NVarChar,hsn)
//       .input("tax_amount",                      sql.Decimal(14,2),tax_amount)
//       .input("created_by",                      sql.NVarChar, created_by)
//       .input("modified_by",                     sql.NVarChar, modified_by)
//       .input("tempstr1",                        sql.NVarChar, tempstr1)
//       .input("tempstr2",                        sql.NVarChar, tempstr2)
//       .input("tempstr3",                        sql.NVarChar, tempstr3)
//       .input("tempstr4",                        sql.NVarChar, tempstr4)
//       .input("datetime1",                       sql.NVarChar, datetime1)
//       .input("datetime2",                       sql.NVarChar, datetime2)
//       .input("datetime3",                       sql.NVarChar, datetime3)
//       .input("datetime4",                       sql.NVarChar, datetime4)
//       .query(
//     `EXEC sp_purchase_details_test @mode,@transaction_date,@transaction_no,@warehouse_code,@vendor_code,@ItemSNo,@item_code,@item_name,@bill_qty,@bill_rate,
//     @item_amt,@weight,@total_weight,@pay_type,@purchase_type,@stock_type,@stock_code,@vendor_name,
//     @order_type,@hsn,@tax_amount,'','',@created_by,@modified_by,
//     @tempstr1,@tempstr2,@tempstr3,@tempstr4,@datetime1,@datetime2,@datetime3,@datetime4`);
//         res.json({ success: true, message: "Data updated successfully" });
//       } catch (err) {
//         console.error(err);
//         res.status(500).json({ message: err.message || 'Internal Server Error' });
//       }
//     };


//code ended by kathir

const getPurItemAmountCalculation = async (req, res) => {
  const { Item_SNO, Item_code, bill_qty, purchaser_amt, tax_type_header, tax_name_details, tax_percentage, UnitWeight, keyfield } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "IAC")
      .input("Item_SNO", sql.BigInt, Item_SNO)
      .input("Item_code", sql.NVarChar, Item_code)
      .input("bill_qty", sql.Decimal(10, 2), bill_qty)
      .input("purchaser_amt", sql.Decimal(10, 2), purchaser_amt)
      .input("tax_type_header", sql.NVarChar, tax_type_header)
      .input("tax_name_details", sql.NVarChar, tax_name_details)
      .input("tax_percentage", sql.NVarChar, tax_percentage)
      .input("UnitWeight", sql.Decimal(8, 3), UnitWeight)
      .input("keyfield", sql.NVarChar, keyfield)
      .query(`EXEC sp_ItemAmountCalculation @mode,'' , @Item_SNO ,@Item_code, @bill_qty, @purchaser_amt	,@tax_type_header, @tax_name_details, @tax_percentage, @UnitWeight, @keyfield,
                                NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//Code Added by Harish on 22-10-2024
const gettaxinvoiceitemamt = async (req, res) => {
  const { company_code, type, Item_SNO, Item_code, bill_qty, Item_amt, tax_type_header, tax_name_details, tax_percentage, keyfield, invoice_type } = req.body;
  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();
    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "IAC")
      .input("company_code", sql.NVarChar, company_code)
      .input("type", sql.NVarChar, type)
      .input("Item_SNO", sql.BigInt, Item_SNO)
      .input("Item_code", sql.NVarChar, Item_code)
      .input("bill_qty", sql.Decimal(10, 2), bill_qty)
      .input("Item_amt", sql.Decimal(10, 2), Item_amt)
      .input("tax_type_header", sql.NVarChar, tax_type_header)
      .input("tax_name_details", sql.NVarChar, tax_name_details)
      .input("tax_percentage", sql.NVarChar, tax_percentage)
      .input("keyfield", sql.NVarChar, keyfield)
      .input("invoice_type", sql.NVarChar, invoice_type)
      .query(`EXEC sp_tax_invoice_ItemAmountCalculation @mode, @company_code,@type,@Item_SNO, @Item_code, @bill_qty, @Item_amt, @tax_type_header, @tax_name_details, @tax_percentage, '', '', 0, 0,@keyfield,@invoice_type,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const gettaxinvoicetotamt = async (req, res) => {
  const { Tax_amount, Putchase_amount, company_code } = req.body;
  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();
    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "TOT")
      .input("Tax_amount", sql.NVarChar, Tax_amount)
      .input("Putchase_amount", sql.NVarChar, Putchase_amount)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_tax_invoice_ItemAmountCalculation @mode,@company_code,'',0, '', 0, 0, '', '', '', @Tax_amount, @Putchase_amount, 0, 0,'','', NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};







//Code Ended by Harish on 22-10-2024

//Code Added by Harish on 25-10-2024
const addtaxInvoicehdr = async (req, res) => {
  const {
    company_code, bill_date, bill_no, dely_chlno, warehouse_code, sales_type, customer_code, sale_amt, less_frit, less_disc, less_amt, net_amt, excs_amt,
    cess_amt, dely_amt, roff_amt, othr_amt, bill_amt, tax_amount, total_item, total_qty, pay_type, broker_code, tpot_code, sman_code, vehl_no, mark_name, payment_mode,
    customer_name, entry_no, roff_acccode, order_type, deli_charge, billTo_customer_name, billTo_customer_addr_1, billTo_customer_addr_2, billTo_customer_addr_3,
    billTo_customer_addr_4, billTo_customer_state, billTo_customer_country, billTo_customer_mobile_no, billTo_contact_person, shipTo_customer_name, shipTo_customer_addr_1, shipTo_customer_addr_2, shipTo_customer_addr_3,
    shipTo_customer_addr_4, shipTo_customer_state, shipTo_customer_country, shipTo_customer_mobile_no, shipTo_contact_person, tax_acc_code, sale_amt_acc_code, othr_amt_acc_code, advance_amount, shipTo_customer_code,
    bal_amt, invoice_type, pending, billTo_customer_gst_no, ShipTo_customer_gst_no, delivery_note, dispatched_through, destination, po_no, po_date, document_type, Performa_bill_no, Eway_bill_no, supplier_ref, created_by
  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("bill_date", sql.NVarChar, bill_date)
      .input("bill_no", sql.NVarChar, bill_no)
      .input("dely_chlno", sql.NVarChar, dely_chlno)
      .input("warehouse_code", sql.NVarChar, warehouse_code)
      .input("sales_type", sql.NVarChar, sales_type)
      .input("customer_code", sql.NVarChar, customer_code)
      .input("sale_amt", sql.Decimal(14, 2), sale_amt)
      .input("less_frit", sql.Decimal(14, 2), less_frit)
      .input("less_disc", sql.Decimal(14, 2), less_disc)
      .input("less_amt", sql.Decimal(14, 2), less_amt)
      .input("net_amt", sql.Decimal(14, 2), net_amt)
      .input("excs_amt", sql.Decimal(14, 2), excs_amt)
      .input("cess_amt", sql.Decimal(14, 2), cess_amt)
      .input("dely_amt", sql.Decimal(14, 2), dely_amt)
      .input("roff_amt", sql.Decimal(14, 2), roff_amt)
      .input("othr_amt", sql.Decimal(14, 2), othr_amt)
      .input("bill_amt", sql.Decimal(14, 2), bill_amt)
      .input("tax_amount", sql.Decimal(14, 2), tax_amount)
      .input("total_item", sql.Int, total_item)
      .input("total_qty", sql.Int, total_qty)
      .input("pay_type", sql.NVarChar, pay_type)
      .input("broker_code", sql.NVarChar, broker_code)
      .input("tpot_code", sql.NVarChar, tpot_code)
      .input("sman_code", sql.NVarChar, sman_code)
      .input("vehl_no", sql.NVarChar, vehl_no)
      .input("mark_name", sql.NVarChar, mark_name)
      .input("payment_mode", sql.NVarChar, payment_mode)
      .input("customer_name", sql.NVarChar, customer_name)
      .input("entry_no", sql.NVarChar, entry_no)
      .input("roff_acccode", sql.NVarChar, roff_acccode)
      .input("order_type", sql.NVarChar, order_type)
      .input("deli_charge", sql.Decimal(18, 0), deli_charge)
      .input("billTo_customer_name", sql.NVarChar, billTo_customer_name)
      .input("billTo_customer_addr_1", sql.NVarChar, billTo_customer_addr_1)
      .input("billTo_customer_addr_2", sql.NVarChar, billTo_customer_addr_2)
      .input("billTo_customer_addr_3", sql.NVarChar, billTo_customer_addr_3)
      .input("billTo_customer_addr_4", sql.NVarChar, billTo_customer_addr_4)
      .input("billTo_customer_state", sql.NVarChar, billTo_customer_state)
      .input("billTo_customer_country", sql.NVarChar, billTo_customer_country)
      .input("billTo_customer_mobile_no", sql.NVarChar, billTo_customer_mobile_no)
      .input("billTo_contact_person", sql.NVarChar, billTo_contact_person)
      .input("shipTo_customer_name", sql.NVarChar, shipTo_customer_name)
      .input("shipTo_customer_addr_1", sql.NVarChar, shipTo_customer_addr_1)
      .input("shipTo_customer_addr_2", sql.NVarChar, shipTo_customer_addr_2)
      .input("shipTo_customer_addr_3", sql.NVarChar, shipTo_customer_addr_3)
      .input("shipTo_customer_addr_4", sql.NVarChar, shipTo_customer_addr_4)
      .input("shipTo_customer_state", sql.NVarChar, shipTo_customer_state)
      .input("shipTo_customer_country", sql.NVarChar, shipTo_customer_country)
      .input("shipTo_customer_mobile_no", sql.NVarChar, shipTo_customer_mobile_no)
      .input("shipTo_contact_person", sql.NVarChar, shipTo_contact_person)
      .input("tax_acc_code", sql.NVarChar, tax_acc_code)
      .input("sale_amt_acc_code", sql.NVarChar, sale_amt_acc_code)
      .input("othr_amt_acc_code", sql.NVarChar, othr_amt_acc_code)
      .input("advance_amount", sql.Decimal(14, 2), advance_amount)
      .input("shipTo_customer_code", sql.NVarChar, shipTo_customer_code)
      .input("bal_amt", sql.Decimal(14, 2), bal_amt)
      .input("invoice_type", sql.NVarChar, invoice_type)
      .input("pending", sql.NVarChar, pending)
      .input("billTo_customer_gst_no", sql.NVarChar, billTo_customer_gst_no)
      .input("ShipTo_customer_gst_no", sql.NVarChar, ShipTo_customer_gst_no)
      .input("delivery_note", sql.NVarChar, delivery_note)
      .input("dispatched_through", sql.NVarChar, dispatched_through)
      .input("destination", sql.NVarChar, destination)
      .input("po_no", sql.NVarChar, po_no)
      .input("po_date", sql.Date, po_date)
      .input("document_type", sql.NVarChar, document_type)
      .input("Performa_bill_no", sql.NVarChar, Performa_bill_no)
      .input("Eway_bill_no", sql.NVarChar, Eway_bill_no)
      .input("supplier_ref", sql.NVarChar, supplier_ref)
      .input("created_by", sql.NVarChar, created_by)
      .query(`EXEC sp_taxInvoice_Header @mode, @company_code, @bill_date, @bill_no, @dely_chlno, @warehouse_code, @sales_type,
@customer_code, @sale_amt, @less_frit, @less_disc, @less_amt, @net_amt, @excs_amt, @cess_amt, @dely_amt, @roff_amt, @othr_amt,
@bill_amt, @tax_amount, @total_item, @total_qty, @pay_type, @broker_code, @tpot_code, @sman_code, @vehl_no, @mark_name,
@payment_mode, @customer_name, @entry_no, @roff_acccode, @order_type, @deli_charge, @billTo_customer_name ,
@billTo_customer_addr_1, @billTo_customer_addr_2, @billTo_customer_addr_3, @billTo_customer_addr_4, @billTo_customer_state,
@billTo_customer_country, @billTo_customer_mobile_no, @billTo_contact_person, @shipTo_customer_name,  @shipTo_customer_addr_1,
@shipTo_customer_addr_2, @shipTo_customer_addr_3, @shipTo_customer_addr_4, @shipTo_customer_state, @shipTo_customer_country,
@shipTo_customer_mobile_no, @shipTo_contact_person,@tax_acc_code, @sale_amt_acc_code, @othr_amt_acc_code, @advance_amount, @shipTo_customer_code,
@bal_amt,@invoice_type,@pending,@billTo_customer_gst_no,@ShipTo_customer_gst_no,@delivery_note,@dispatched_through,@destination,@po_no,@po_date,@document_type,@Performa_bill_no,@Eway_bill_no,@supplier_ref,@created_by,'',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const TaxInvoicehdrDelteData = async (req, res) => {
  const { company_code, bill_no, invoice_type, modified_by } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    try {
      await pool.request()
        .input("company_code", company_code)
        .input("bill_no", bill_no)
        .input("invoice_type", invoice_type)
        .input("modified_by", modified_by)
        .query(` EXEC sp_taxInvoice_Header 'D',@company_code,'',@bill_no,'','','','',0,0,0,0,0,0,0,0,0,0,0,0,0,0,'','','','','','','','','','','',0,'','','','','','','','','','','','','','','','','','','','','',0,'',0,@invoice_type,'','','','','','','','','','','','','',@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    } catch (err) {
      if (err.number === 547) {
        res.status(400).json("First Delete the Invoice Details and Tax Details Data");
        return;
      } else {
        throw err;
      }
    }
    res.status(200).json("Invoice hdr Deleted Successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getAlltaxinvoicehdrData = async (req, res) => {
  const { company_code, invoice_type } = req.body;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "A")
      .input("company_code", sql.NVarChar, company_code)
      .input("invoice_type", sql.NVarChar, invoice_type)
      .query(`EXEC sp_taxInvoice_Header @mode,@company_code,'','','','','','',0,0,0,0,0,0,0,0,0,0,0,0,0,0,'','','','','','','','','','','',0,'','','','','','','','','','','','','','','','','','','','','',0,'',0,@invoice_type,'','','','','','','','','','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};



// const addTaxInvoicedetail= async (req, res) => {
//   const {
//     Product_code,
//     Description,
//     Product_SNo,
//     bill_date,		
//     bill_no,	
//     dely_chlno,		
//     warehouse_code,	
//     customer_code,
//     item_code,	
//     ItemSNo	,	
//     item_name,		
//     bill_qty,		
//     bill_rate,		
//     item_amt,		
//     weight,			
//     total_weight,	
//     pay_type,		
//     sales_type,		
//     broker_code,
//     tpot_code,		
//     sman_code,		
//     salesacc_code,	
//     stock_type,		
//     stock_code,		
//     entry_no,		
//     customer_name,
//     order_type,		
//     hsn,
//     sub_product,
//     tax_amt,			
//     total_tax_amt,			
//     custqty,			
//     total_qty,
//     Total_amt,			
//     created_by,		
//     modified_by,	
//     tempstr1,		
//     tempstr2,		
//     tempstr3,		
//     tempstr4,		
//     datetime1,		
//     datetime2,		
//     datetime3,		
//     datetime4,
//   } = req.body;
//   let pool;
//   try {
//     pool = await sql.connect(dbConfig);
//     const result = await pool
//       .request()
//       .input("mode",                            sql.NVarChar, "I") // Insert mode
//       .input("Product_code",                    sql.NVarChar, Product_code)
//       .input("Description",                    sql.NVarChar, Description)
//       .input("Product_SNo",                      sql.BigInt, Product_SNo)
//       .input("bill_date",                       sql.Date, bill_date)
//       .input("bill_no",                         sql.NVarChar, bill_no)
//       .input("dely_chlno",                      sql.NVarChar,dely_chlno)
//       .input("warehouse_code",                  sql.NVarChar,warehouse_code)
//       .input("customer_code",                   sql.NVarChar,customer_code)
//       .input("item_code",                       sql.NVarChar,item_code)
//       .input("ItemSNo",                        sql.BigInt,ItemSNo	)
//       .input("item_name",                       sql.NVarChar,item_name)
//       .input("bill_qty",                        sql.Decimal(10,2),bill_qty)
//       .input("bill_rate",                       sql.Decimal(10,2),bill_rate)
//       .input("item_amt",                        sql.Decimal(10,2),item_amt)
//       .input("weight",                          sql.Decimal(8,3),weight)
//       .input("total_weight",                    sql.Decimal(10,2),total_weight)
//       .input("pay_type",                        sql.NVarChar,pay_type)
//       .input("sales_type",                      sql.NVarChar,sales_type)
//       .input("broker_code",                     sql.NVarChar,broker_code)
//       .input("tpot_code",                       sql.NVarChar,tpot_code)
//       .input("sman_code",                       sql.NVarChar,sman_code)
//       .input("salesacc_code",                   sql.NVarChar,salesacc_code)
//       .input("stock_type",                      sql.NVarChar,stock_type)
//       .input("stock_code",                      sql.NVarChar,stock_code)
//       .input("entry_no",                        sql.NVarChar,entry_no)
//       .input("customer_name",                   sql.NVarChar,customer_name)
//       .input("order_type",                      sql.NVarChar,order_type)
//       .input("hsn",                             sql.NVarChar,hsn)
//       .input("tax_amt",                         sql.Decimal(14,2),tax_amt)
//       .input("total_tax_amt",                   sql.Decimal(14,2),total_tax_amt)
//       .input("sub_product",                     sql.NVarChar,sub_product)
//       .input("custqty",                         sql.Decimal(14,2),custqty)
//       .input("total_qty",                      sql.Decimal(14,2),total_qty)
//       .input("Total_amt",                      sql.Decimal(14,2),Total_amt)
//       .input("created_by",                      sql.NVarChar, created_by)
//       .input("modified_by",                     sql.NVarChar, modified_by)
//       .input("tempstr1",                        sql.NVarChar, tempstr1)
//       .input("tempstr2",                        sql.NVarChar, tempstr2)
//       .input("tempstr3",                        sql.NVarChar, tempstr3)
//       .input("tempstr4",                        sql.NVarChar, tempstr4)
//       .input("datetime1",                       sql.NVarChar, datetime1)
//       .input("datetime2",                       sql.NVarChar, datetime2)
//       .input("datetime3",                       sql.NVarChar, datetime3)
//       .input("datetime4",                       sql.NVarChar, datetime4)
//       .query(
//     `EXEC sp_tax_invoice_details @mode,@Product_code,@Description,@Product_SNo, @bill_date,@bill_no,@dely_chlno,@warehouse_code,@customer_code,@item_code,@ItemSNo,@item_name,@bill_qty,@bill_rate,@item_amt,@weight,@total_weight,@pay_type,@sales_type,@broker_code,@tpot_code,@sman_code,@salesacc_code,@stock_type,@stock_code,@entry_no,@customer_name,@order_type,@hsn,@tax_amt,@total_tax_amt,@sub_product,@custqty,@total_qty,@Total_amt,@created_by,@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
//         res.json({ success: true, message: "Data inserted successfully" });
//       } catch (err) {
//         console.error(err);
//         res.status(500).json({ message: err.message || 'Internal Server Error' });
//       }
//     };


const TaxInvoiceDeldetData = async (req, res) => {
  const { company_code, bill_no, invoice_type } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    try {
      await pool.request()
        .input("company_code", company_code)
        .input("bill_no", bill_no)
        .input("invoice_type", invoice_type)
        .input("modified_by", sql.NVarChar, req.headers['modified-by'])
        .query(`EXEC sp_tax_invoice_details_list 'D',@company_code,'',@bill_no,0,'','','','','','','',0,0,0,0,0,0,'','',@invoice_type,'',@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    } catch (error) {
      if (error.number === 547) {
        // Foreign key constraint violation
        res.status(400).json("First Delete the Sales Details and Tax Details Data");
        return;
      } else {
        throw error; // Rethrow other SQL errors
      }
    }
    res.status(200).json("Invoice Deleted Successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};



const getAllTaxInvoiceDetData = async (req, res) => {
  const { company_code, invoice_type } = req.body;

  try {
    await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "A")
      .input("company_code", sql.NVarChar, company_code)
      .input("invoice_type", sql.NVarChar, invoice_type)
      .query(`EXEC sp_tax_invoice_details_list @mode,@company_code,'','',0,'','','','','','','',0,0,0,0,0,0,'','',@invoice_type,'',@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
// api for tax invoice tax details
const addTaxInvoiceTaxdetail = async (req, res) => {
  const {
    company_code, bill_date, bill_no, customer_code, pay_type, ItemSNo, TaxSNo, item_code, item_name, tax_type, tax_name_details, tax_amt, tax_per, tax_acode, Product_SNo, invoice_type,
    created_by, modified_by,
    tempstr1, tempstr2, tempstr3, tempstr4, datetime1, datetime2, datetime3, datetime4,
  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("bill_date", sql.Date, bill_date)
      .input("bill_no", sql.NVarChar, bill_no)
      .input("customer_code", sql.NVarChar, customer_code)
      .input("pay_type", sql.NVarChar, pay_type)
      .input("ItemSNo", sql.BigInt, ItemSNo)
      .input("TaxSNo", sql.BigInt, TaxSNo)
      .input("item_code", sql.NVarChar, item_code)
      .input("item_name", sql.NVarChar, item_name)
      .input("tax_type", sql.NVarChar, tax_type)
      .input("tax_name_details", sql.NVarChar, tax_name_details)
      .input("tax_amt", sql.Decimal(14, 2), tax_amt)
      .input("tax_per", sql.Decimal(14, 2), tax_per)
      .input("tax_acode", sql.NVarChar, tax_acode)
      .input("Product_SNo", sql.NVarChar, Product_SNo)
      .input("invoice_type", sql.NVarChar, invoice_type)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(
        `EXEC sp_taxInvoice_tax_details @mode,@company_code,@bill_date,@bill_no,@customer_code,@pay_type,@ItemSNo,@TaxSNo,@item_code,@item_name,@tax_type,@tax_name_details,
              @tax_amt,@tax_per,@tax_acode,@Product_SNo,@invoice_type,
              @created_by,@modified_by,
              @tempstr1,@tempstr2,@tempstr3,@tempstr4,@datetime1,@datetime2,@datetime3,@datetime4`);
    res.json({ success: true, message: "Data inserted successfully" });
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};



const TaxInvoicetaxDelteData = async (req, res) => {
  const { company_code, bill_no, invoice_type } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    try {
      await pool.request()
        .input("company_code", company_code)
        .input("bill_no", bill_no)
        .input("invoice_type", invoice_type)
        .input("modified_by", sql.NVarChar, req.headers['modified-by'])
        .query(`EXEC sp_taxInvoice_tax_details 'D',@company_code,'',@bill_no,'','',0,0,'','','','',0,0,'',0,@invoice_type,'',@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    } catch (error) {
      if (error.number === 547) {
        // Foreign key constraint violation
        res.status(400).json("First Delete the Invoice Details and Tax Details Data");
        return;
      } else {
        throw error; // Rethrow other SQL errors
      }
    }
    res.status(200).json("Invoice tax Deleted Successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getAllTaxInvoiceTaxData = async (req, res) => {
  const { company_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "A")
      .input("company_code", sql.NVarChar, company_code)
      .input("invoice_type", sql.NVarChar, invoice_type)
      .query(` EXEC sp_taxInvoice_tax_details @mode,@company_code,,'','','','',0,0,'','','','',0,0,'','','',''
            ,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};



//Code Ended by Harish on 25-10-2024

//Code Added by Harish on 26-10-2024

const gettaxsearchdata = async (req, res) => {
  const { company_code, bill_no, bill_date, sales_type, billTo_customer_name, shipTo_customer_name, pay_type, invoice_type } = req.body;
  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();
    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("bill_no", sql.NVarChar, bill_no)
      .input("bill_date", sql.NVarChar, bill_date)
      .input("sales_type", sql.NVarChar, sales_type)
      .input("pay_type", sql.NVarChar, pay_type)
      .input("billTo_customer_name", sql.NVarChar, billTo_customer_name)
      .input("shipTo_customer_name", sql.NVarChar, shipTo_customer_name)
      .input("company_code", sql.NVarChar, company_code)
      .input("invoice_type", sql.NVarChar, invoice_type)
      .query(`
        EXEC sp_taxInvoice_Header 'sc',@company_code,@bill_date,@bill_no,'','',@sales_type,'',0,0,0,0,0,0,0,0,0,0,0,0,0,0,@pay_type,'','','','','','','','','','',0,@billTo_customer_name,'','','','','','','','',@shipTo_customer_name,'','','','','','','','','','','',0,'',0,@invoice_type,'','','','','','','','','','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);
    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getTaxInvoiceTax = async (req, res) => {
  const { transaction_no, invoice_type, company_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "TIT")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("tempstr1", sql.NVarChar, invoice_type)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_getdata @mode,@transaction_no,@company_code,@tempstr1,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const gettaxinvoiceDetail = async (req, res) => {
  const { transaction_no, invoice_type, company_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "TTD")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("tempstr1", sql.NVarChar, invoice_type)
      .input("company_code", sql.NVarChar, company_code)

      .query(`EXEC sp_getdata @mode,@transaction_no,@company_code,@tempstr1,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


//Code Ended by Harish on 26-10-2024


//Code Ended by Balaji on 06-11-2024
const addLoan = async (req, res) => {
  const {
    loanID,
    loanName,
    created_by,
    modified_by,
    tempstr1,
    tempstr2,
    tempstr3,
    tempstr4,
    datetime1,
    datetime2,
    datetime3,
    datetime4

  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("loanID", sql.VarChar, loanID)
      .input("loanName", sql.VarChar, loanName)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)

      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(`EXEC sp_Loan 'I' ,@loanID,@loanName,'','',null,null,null,null,null,null,null,null`);
    res.json({ message: "Data inserted successfully" });
  }
  catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
const getLoan = async (req, res) => {
  const { loanID, loanName, created_by, modified_by } = req.params;

  try {
    let pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "S")
      .input("loanID", sql.VarChar, loanID)
      .input("loanName", sql.VarChar, loanName)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .query(`EXEC sp_Loan 'S' ,@loanID,@loanName,'','',null,null,null,null,null,null,null,null`);

    res.json(result.recordset);
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const updateLoan = async (req, res) => {
  const {
    loanID,
    loanName,
    modified_by,
    tempstr1,
    tempstr2,
    tempstr3,
    tempstr4,
    datetime1,
    datetime2,
    datetime3,
    datetime4


  } = req.body;

  try {
    let pool = await sql.connect(dbConfig);
    await pool
      .request()
      .input("mode", sql.NVarChar, "U")
      .input("loanID", sql.VarChar, loanID)
      .input("loanName", sql.VarChar, loanName)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(`EXEC sp_Loan 'U' ,@loanID,@loanName,'','',null,null,null,null,null,null,null,null`);
    res.json({ message: "Data updated successfully" });
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const deleteLoan = async (req, res) => {
  const { loanID } = req.body;

  try {
    let pool = await sql.connect(dbConfig);
    await pool
      .request()
      .input("mode", sql.NVarChar, "D")
      .input("loanID", sql.VarChar, loanID)
      .query(`EXEC sp_Loan @mode,@loanID,'','','',null,null,null,null,null,null,null,null`);

    res.json({ message: "Data deleted successfully" });
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};



const addEmployeeLoan = async (req, res) => {
  const {
    EmployeeId,
    loanID,
    ApprovedBy,
    LoanEligibleAmount,
    EffectiveDate, // Fixed typo
    EndDate,
    HowManyMonth,
    EMIAmount,
    company_code,
    created_by,
    modified_by,
    tempstr1,
    tempstr2,
    tempstr3,
    tempstr4,
    datetime1,
    datetime2,
    datetime3,
    datetime4
  } = req.body;

  let pool;
  try {
    pool = await sql.connect(dbConfig);
    await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("EmployeeId", sql.VarChar, EmployeeId)
      .input("loanID", sql.VarChar, loanID)
      .input("ApprovedBy", sql.VarChar, ApprovedBy)
      .input("LoanEligibleAmount", sql.Decimal, LoanEligibleAmount) // Assuming decimal for monetary values
      .input("EffectiveDate", sql.DateTime, EffectiveDate)
      .input("EndDate", sql.DateTime, EndDate)
      .input("HowManyMonth", sql.Int, HowManyMonth) // Assuming integer for months
      .input("EMIAmount", sql.Decimal, EMIAmount) // Assuming decimal for monetary values
      .input("company_code", sql.NVarChar, company_code)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.DateTime, datetime1)
      .input("datetime2", sql.DateTime, datetime2)
      .input("datetime3", sql.DateTime, datetime3)
      .input("datetime4", sql.DateTime, datetime4)
      .query(`
            EXEC sp_EmployeeLoan @mode, @EmployeeId, @loanID, @ApprovedBy, 
                                 @LoanEligibleAmount, @EffectiveDate, 
                                 @EndDate, @HowManyMonth, @EMIAmount, 
                               @company_code,@created_by,'', null, 
                                 null, null, null, 
                                 null, null, null,null
          `);

    res.status(200).json("data inserted successfully");
  } catch (err) {
    console.error("Error inserting data:", err);

    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};
const getsearchEmpLoan = async (req, res) => {

  try {
    let pool = await sql.connect(dbConfig);
    const result = await pool

      .request()
      .input("mode", sql.NVarChar, "A")
      .query(`EXEC sp_EmployeeLoan @mode, '', '', '', 
                                 0, '', 
                                 '', 0, 0, 
                                '','','', null, 
                                 null, null, null, 
                                 null, null, null,null`);

    res.json(result.recordset);
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
const getEmployeeLoan = async (req, res) => {
  const { EmployeeId,
    loanID,
    ApprovedBy,
    LoanEligibleAmount,
    EffetiveDate, // Fixed typo
    EndDate,
    HowManyMonth,
    EMIAmount,
    company_code,
    created_by,
    modified_by } = req.body;

  try {
    let pool = await sql.connect(dbConfig);
    const result = await pool

      .request()
      .input("mode", sql.NVarChar, "A")
      .input("EmployeeId", sql.NVarChar, EmployeeId)
      .input("loanID", sql.VarChar, loanID)
      .input("ApprovedBy", sql.VarChar, ApprovedBy)
      .input("LoanEligibleAmount", sql.Decimal, LoanEligibleAmount) // Assuming decimal for monetary values
      .input("EffetiveDate", sql.DateTime, EffetiveDate)
      .input("EndDate", sql.DateTime, EndDate)
      .input("HowManyMonth", sql.Int, HowManyMonth) // Assuming integer for months
      .input("EMIAmount", sql.Decimal, EMIAmount) // Assuming decimal for monetary values
      .input("company_code", sql.NVarChar, company_code)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .query(`EXEC sp_EmployeeLoan @mode, @EmployeeId, @loanID, @ApprovedBy, 
                                 @LoanEligibleAmount, @EffetiveDate, 
                                 @EndDate, @HowManyMonth,@EMIAmount, 
                                @company_code'','',null, 
                                 null, null, null, 
                                 null, null, null,null`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error inserting data:", err);

    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};

const deleteEmployeeLoan = async (req, res) => {
  const editedData = req.body.editedData;

  if (!editedData || !editedData.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }
  try {
    const pool = await connection.connectToDatabase();
    for (const updatedRow of editedData) {
      await pool
        .request()
        .input("mode", sql.NVarChar, "D") // Delete mode

        .input("loanID", sql.VarChar, updatedRow.loanID)
        .input("EmployeeId", sql.VarChar, updatedRow.EmployeeId)
        .input("company_code", sql.NVarChar, req.headers['company_code'])

        .query(`
            EXEC sp_EmployeeLoan @mode, @EmployeeId, @loanID, '', 
                                 0, '', 
                                 '', 0, 0, 
                                @company_code,'','', null, 
                                 null, null, null, 
                                 null, null, null,null
          `);

    }
    res.status(200).json("Data Deleted Successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const updateEmployeeLoan = async (req, res) => {
  const editedData = req.body.editedData;

  if (!editedData || !editedData.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase();
    for (const updatedRow of editedData) {
      await pool
        .request()
        .input("mode", sql.NVarChar, "U") // Update mode
        .input("EmployeeId", sql.VarChar, updatedRow.EmployeeId)
        .input("loanID", sql.VarChar, updatedRow.loanID)
        .input("ApprovedBy", sql.VarChar, updatedRow.ApprovedBy)
        .input("LoanEligibleAmount", sql.Decimal, updatedRow.LoanEligibleAmount)
        .input("EffectiveDate", sql.Date, updatedRow.EffectiveDate)
        .input("EndDate", sql.Date, updatedRow.EndDate)
        .input("HowManyMonth", sql.Int, updatedRow.HowManyMonth)
        .input("EMIAmount", sql.Decimal, updatedRow.EMIAmount)
        .input("company_code", sql.NVarChar, updatedRow.company_code)
        .input("modified_by", sql.NVarChar, updatedRow.modified_by)
        .input("tempstr1", sql.NVarChar, updatedRow.tempstr1)
        .input("tempstr2", sql.NVarChar, updatedRow.tempstr2)
        .input("tempstr3", sql.NVarChar, updatedRow.tempstr3)
        .input("tempstr4", sql.NVarChar, updatedRow.tempstr4)
        .input("datetime1", sql.DateTime, updatedRow.datetime1)
        .input("datetime2", sql.DateTime, updatedRow.datetime2)
        .input("datetime3", sql.DateTime, updatedRow.datetime3)
        .input("datetime4", sql.DateTime, updatedRow.datetime4)
        .query(`EXEC sp_EmployeeLoan @mode, 
            @EmployeeId, @loanID, @ApprovedBy,@LoanEligibleAmount,
             @EffectiveDate,@EndDate, @HowManyMonth, @EMIAmount,
             @company_code,'',@modified_by, null, null, null, null,
             null, null, null, null`);

    } res.json({ message: "Data updated successfully" });
  } catch (err) {
    console.error("Error inserting data:", err);
    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};


const addGrade = async (req, res) => {
  const { GradeID, GradeName, Basic, HRA, Conveyance, Medical, Special_Allowance, Company_Pf_Contribution, Bonus_Arrears, Other_Allowance, LeaveDeduction, otherDeductions,
    ctc_currency, minimum_take_salary, company_code, salary_range_from, salary_range_to, created_by
  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("GradeID", sql.NVarChar, GradeID)
      .input("GradeName", sql.NVarChar, GradeName)
      .input("Basic", sql.Decimal(14, 3), Basic)
      .input("HRA", sql.Decimal(14, 3), HRA)
      .input("Conveyance", sql.Decimal(14, 3), Conveyance)
      .input("Medical", sql.Decimal(14, 3), Medical)
      .input("Special_Allowance", sql.Decimal(14, 3), Special_Allowance)
      .input("Company_Pf_Contribution", sql.Decimal(14, 3), Company_Pf_Contribution)
      .input("Bonus_Arrears", sql.Decimal(14, 3), Bonus_Arrears)
      .input("Other_Allowance", sql.Decimal(14, 3), Other_Allowance)
      .input("LeaveDeduction", sql.Decimal(14, 3), LeaveDeduction)
      .input("otherDeductions", sql.Decimal(14, 3), otherDeductions)
      .input("ctc_currency", sql.NVarChar, ctc_currency)
      .input("minimum_take_salary", sql.Decimal(14, 3), minimum_take_salary)
      .input("salary_range_from", sql.Decimal(10, 2), salary_range_from)
      .input("salary_range_to", sql.Decimal(10, 2), salary_range_to)
      .input("company_code", sql.NVarChar, company_code)
      .input("created_by", sql.NVarChar, created_by)
      .query(`EXEC sp_Grade @mode,@GradeID,@GradeName,@Basic,@HRA,@Conveyance,@Medical,@Special_Allowance,@Company_Pf_Contribution,@Bonus_Arrears,@Other_Allowance,@LeaveDeduction,@otherDeductions,@ctc_currency,@minimum_take_salary,@salary_range_from,@salary_range_to,@company_code,@created_by,'',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.status(200).json("Grade data inserted successfully");
  } catch (err) {
    console.error("Error inserting data:", err);

    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};

const allGradeData = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`EXEC sp_Grade 'A','','',0,0,0,0,0,0,0,0,0,0,'',0,0,0,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const deleteGrade = async (req, res) => {

  const GradeIDToDelete = req.body.GradeIDToDelete;

  if (!GradeIDToDelete || !GradeIDToDelete.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }
  try {
    const pool = await connection.connectToDatabase();
    for (const updatedRow of GradeIDToDelete) {
      await pool
        .request()
        .input("mode", sql.NVarChar, "D")
        .input("GradeID", sql.NVarChar, updatedRow.GradeID)
        .input("company_code", sql.NVarChar, req.headers['company_code'])
        .query(`EXEC sp_Grade 'D',@GradeID,'',0,0,0,0,0,0,0,0,0,0,'',0,0,0,@company_code,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    }
    res.status(200).json("Data Deleted Successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const updateGrade = async (req, res) => {
  const editedData = req.body.editedData;

  if (!editedData || !editedData.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase();
    for (const updatedRow of editedData) {
      await pool
        .request()
        .input("mode", sql.NVarChar, "U") // Insert mode
        .input("GradeID", sql.NVarChar, updatedRow.GradeID)
        .input("GradeName", sql.NVarChar, updatedRow.GradeName)
        .input("Basic", sql.Decimal(14, 3), updatedRow.Basic)
        .input("HRA", sql.Decimal(14, 3), updatedRow.HRA)
        .input("Conveyance", sql.Decimal(14, 3), updatedRow.Conveyance)
        .input("Medical", sql.Decimal(14, 3), updatedRow.Medical)
        .input("Special_Allowance", sql.Decimal(14, 3), updatedRow.Special_Allowance)
        .input("Company_Pf_Contribution", sql.Decimal(14, 3), updatedRow.Company_Pf_Contribution)
        .input("Bonus_Arrears", sql.Decimal(14, 3), updatedRow.Bonus_Arrears)
        .input("Other_Allowance", sql.Decimal(14, 3), updatedRow.Other_Allowance)
        .input("LeaveDeduction", sql.Decimal(14, 3), updatedRow.LeaveDeduction)
        .input("otherDeductions", sql.Decimal(14, 3), updatedRow.otherDeductions)
        .input("ctc_currency", sql.NVarChar, updatedRow.ctc_currency)
        .input("minimum_take_salary", sql.Decimal(14, 3), updatedRow.minimum_take_salary)
        .input("salary_range_from", sql.Decimal(10, 2), updatedRow.salary_range_from)
        .input("salary_range_to", sql.Decimal(10, 2), updatedRow.salary_range_to)
        .input("company_code", sql.NVarChar, req.headers['company_code'])
        .input("modified_by", sql.NVarChar, updatedRow.modified_by)
        .query(`EXEC sp_Grade @mode,@GradeID,@GradeName,@Basic,@HRA,@Conveyance,@Medical,@Special_Allowance,@Company_Pf_Contribution,@Bonus_Arrears,@Other_Allowance,@LeaveDeduction,
        @otherDeductions,@ctc_currency,@minimum_take_salary,@salary_range_from,@salary_range_to,@company_code,'',@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    } res.status(200).json("Grade data updated successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const addEmployeeCompany = async (req, res) => {
  const { EmployeeId, department_ID, designation_ID, DOJ, DOL, manager, shift, status, company_code, created_by, modified_by,
    tempstr1, tempstr2, tempstr3, tempstr4, datetime1, datetime2, datetime3, datetime4,
  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("EmployeeId", sql.VarChar, EmployeeId)
      .input("department_ID", sql.VarChar, department_ID)
      .input("designation_ID", sql.VarChar, designation_ID)
      .input("DOJ", sql.Date, DOJ)
      .input("DOL", sql.Date, DOL)
      .input("manager", sql.VarChar, manager)
      .input("shift", sql.VarChar, shift)
      .input("status", sql.VarChar, status)
      .input("company_code", sql.VarChar, company_code)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(`EXEC sp_employee_company @mode,@EmployeeId,@department_ID,@designation_ID,@DOJ,@DOL,@manager,@shift,@status,'','',@company_code,@created_by,@modified_by,@tempstr1,@tempstr2,@tempstr3,@tempstr4,@datetime1,@datetime2,@datetime3,@datetime4`);
    res.status(200).json("Employee company data inserted successfully");
  } catch (err) {
    console.error("Error inserting data:", err);

    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};

const allEmployeeCompanyData = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`EXEC sp_employee_company 'A','','','','','','','','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const deleteEmployeeCompany = async (req, res) => {
  const { EmployeeId, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    await pool
      .request()
      .input("EmployeeId", sql.VarChar, EmployeeId)
      .input("company_code", sql.VarChar, company_code)

      .query(`EXEC sp_employee_company 'D',@EmployeeId,'','','','','','','','','',@company_code,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    res.status(200).json("Employee data deleted successfully.");
  } catch (err) {
    console.error("Error deleting data:", err);

    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};

const updateEmployeeCompany = async (req, res) => {
  const { EmployeeId, department_ID, designation_ID, DOJ, DOL, manager, shift, status, company_code, modified_by } = req.body;
  try {
    const pool = await connection.connectToDatabase(dbConfig);
    for (const updatedRow of EmployeeId) {
      await pool
        .request()
        .input("mode", sql.NVarChar, "U") // Insert mode
        .input("EmployeeId", sql.VarChar, EmployeeId)
        .input("department_ID", sql.VarChar, department_ID)
        .input("designation_ID", sql.VarChar, designation_ID)
        .input("DOJ", sql.Date, DOJ)
        .input("DOL", sql.Date, DOL)
        .input("manager", sql.VarChar, manager)
        .input("shift", sql.VarChar, shift)
        .input("status", sql.VarChar, status)
        .input("company_code", sql.VarChar, company_code)
        .input("modified_by", sql.VarChar, modified_by)
        .query(`EXEC sp_employee_company @mode,@EmployeeId,@department_ID,@designation_ID,@DOJ,@DOL,@manager,@shift,@status,'','',@company_code,'',@modified_by,'','','','','','','',''`);
    }
    res.status(200).json("Employee company data updated successfully");
  } catch (err) {
    console.error("Error inserting data:", err);

    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};

const addEmployeeFamily = async (req, res) => {

  const employeeData = req.body.employeeData;
  if (!employeeData || !employeeData.length) {
    res.status(400).json("Invalid or empty employeeData array.");
    return;

  }
  try {
    const pool = await connection.connectToDatabase(dbConfig);
    for (const insertRow of employeeData) {
      await pool
        .request()
        .input("mode", sql.NVarChar, "I")
        .input("EmployeeId", insertRow.EmployeeId)
        .input("Relation", insertRow.Relation)
        .input("Name", insertRow.Name)
        .input("DOB", insertRow.DOB)
        .input("AGE", insertRow.AGE)
        .input("aadhar_no", insertRow.aadhar_no)
        .input("company_code", insertRow.company_code)
        .input("created_by", insertRow.created_by)
        .input("modified_by", insertRow.modified_by)
        .input("tempstr1", insertRow.tempstr1)
        .input("tempstr2", insertRow.tempstr2)
        .input("tempstr3", insertRow.tempstr3)
        .input("tempstr4", insertRow.tempstr4)
        .input("datetime1", insertRow.datetime1)
        .input("datetime2", insertRow.datetime2)
        .input("datetime3", insertRow.datetime3)
        .input("datetime4", insertRow.datetime4)
        .query(`EXEC sp_employee_family @mode,@EmployeeId,@Relation,@Name,'',@DOB,@AGE,@aadhar_no,'',@company_code,@created_by,@modified_by,@tempstr1,@tempstr2,@tempstr3,@tempstr4,@datetime1,@datetime2,@datetime3,@datetime4`);
    }
    res.status(200).json("Employee family data inserted successfully");
  } catch (err) {
    console.error("Error inserting data:", err); res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};
const allEmployeeFamilyData = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`EXEC sp_employee_family 'A','','','','','','',0,'','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const deleteEmployeeFamily = async (req, res) => {
  const keyfieldsToDelete = req.body.keyfieldsToDelete;

  if (!keyfieldsToDelete || !keyfieldsToDelete.length) {
    res.status(400).json("Invalid or empty keyfields array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase();
    for (const record of keyfieldsToDelete) {
      const { keyfield, company_code } = record;
      await pool
        .request()
        .input("keyfield", sql.NVarChar, keyfield)
        .input("company_code", sql.NVarChar, company_code)
        .query(`EXEC sp_employee_family 'D','','','','','',0,'',@keyfield,@company_code,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
`);
    }

    res.status(200).json("Employee family data deleted successfully");
  } catch (err) {
    console.error("Error inserting data:", err);

    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};

const updateEmployeeFamily = async (req, res) => {
  const editedData = req.body.editedData;

  if (!editedData || !editedData.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }


  try {
    const pool = await connection.connectToDatabase(dbConfig);
    for (const updatedRow of editedData) {
      await pool
        .request()
        .input("mode", sql.NVarChar, "U") // Insert mode
        .input("EmployeeId", updatedRow.EmployeeId)
        .input("Relation", updatedRow.Relation)
        .input("Name", updatedRow.Name)
        .input("DOB", updatedRow.DOB)
        .input("AGE", updatedRow.AGE)
        .input("aadhar_no", updatedRow.aadhar_no)
        .input("keyfield", updatedRow.keyfield)
        .input("company_code", updatedRow.company_code)
        .input("modified_by", updatedRow.modified_by)
        .query(`EXEC sp_employee_family @mode,@EmployeeId,@Relation,@Name,'',@DOB,@AGE,@aadhar_no,@keyfield,@company_code,'',@modified_by,'','','','','','','',''`);
    }
    res.status(200).json("Employee family data updated successfully");
  } catch (err) {
    console.error("Error inserting data:", err);

    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};

const addSalaryDetails = async (req, res) => {
  const { EmployeeId, salaryType, Payscale, PFNo, salary_month, company_code, created_by, modified_by,
    tempstr1, tempstr2, tempstr3, tempstr4, datetime1, datetime2, datetime3, datetime4,
  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("EmployeeId", sql.VarChar, EmployeeId)
      .input("salaryType", sql.VarChar, salaryType)
      .input("Payscale", sql.VarChar, Payscale)
      .input("PFNo", sql.NVarChar, PFNo)
      .input("salary_month", sql.Decimal(14, 3), salary_month)
      .input("company_code", sql.NVarChar, company_code)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(`EXEC sp_salary_details @mode,@EmployeeId,'',@salaryType,@Payscale,
        @PFNo,@salary_month,'',@company_code,@created_by,@modified_by,@tempstr1,
        @tempstr2,@tempstr3,@tempstr4,@datetime1,@datetime2,@datetime3,@datetime4`);
    res.status(200).json("Salary details data inserted successfully");
  } catch (err) {
    console.error("Error inserting data:", err);

    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};

const allSalaryDetailsData = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`EXEC sp_salary_details 'A','','','','','',0,'','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const deleteSalaryDetails = async (req, res) => {
  const { EmployeeId, PFNo, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    await pool
      .request()
      .input("EmployeeId", sql.NVarChar, EmployeeId)
      .input("PFNo", sql.NVarChar, PFNo)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_salary_details 'D',@EmployeeId,'','',@PFNo,0,'','',@company_code,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    res.status(200).json("Employee salary data deleted successfully");
  } catch (err) {
    console.error("Error inserting data:", err);

    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};

const updateSalaryDetails = async (req, res) => {
  const { EmployeeId, salaryType, Payscale, PFNo, salary_month, company_code, modified_by } = req.body;

  try {
    const pool = await connection.connectToDatabase(dbConfig);
    await pool
      .request()
      .input("mode", sql.NVarChar, "U") // Insert mode
      .input("EmployeeId", sql.VarChar, EmployeeId)
      .input("salaryType", sql.VarChar, salaryType)
      .input("Payscale", sql.VarChar, Payscale)
      .input("PFNo", sql.NVarChar, PFNo)
      .input("salary_month", sql.Decimal(14, 3), salary_month)
      .input("company_code", sql.NVarChar, company_code)
      .input("modified_by", sql.NVarChar, modified_by)

      .query(`EXEC sp_salary_details @mode,@EmployeeId,'',@salaryType,@Payscale,@PFNo,@salary_month,'',@company_code,'',@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    res.status(200).json("Employee data updated successfully");
  } catch (err) {
    console.error("Error inserting data:", err);

    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};

const addEmployeeLeave = async (req, res) => {
  const { EmployeeId, LeaveType, FromDate, ToDate, Duration, ReportingManager, AlternativeReponsablePerson, LeaveStatus, Select_slots, Reason, company_code, created_by, modified_by,
    tempstr1, tempstr2, tempstr3, tempstr4, datetime1, datetime2, datetime3, datetime4,
  } = req.body;

  let Documents = null;

  if (req.file) {
    Documents = req.file.buffer;
  }

  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("EmployeeId", sql.VarChar, EmployeeId)
      .input("LeaveType", sql.VarChar, LeaveType)
      .input("FromDate", sql.Date, FromDate)
      .input("ToDate", sql.Date, ToDate)
      .input("Duration", sql.VarChar, Duration)
      .input("ReportingManager", sql.VarChar, ReportingManager)
      .input("AlternativeReponsablePerson", sql.VarChar, AlternativeReponsablePerson)
      .input("LeaveStatus", sql.VarChar, LeaveStatus)
      .input("Documents", sql.VarBinary, Documents)
      .input("Select_slots", sql.VarChar, Select_slots)
      .input("Reason", sql.VarChar, Reason)
      .input("company_code", sql.VarChar, company_code)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(`EXEC sp_employee_Leave @mode,@EmployeeId,@LeaveType,@FromDate,@ToDate,@Duration,@ReportingManager,@AlternativeReponsablePerson,
        @LeaveStatus,@Documents,@Select_slots,@Reason,@company_code,@created_by,@modified_by,@tempstr1,@tempstr2,@tempstr3,@tempstr4,@datetime1,@datetime2,@datetime3,@datetime4`);
    res.status(200).json("Employee leave data inserted successfully");
  } catch (err) {
    console.error("Error inserting data:", err);

    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};

const allEmployeeLeaveData = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`EXEC sp_employee_Leave 'A','','','','','','','','','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const deleteEmployeeLeave = async (req, res) => {
  const keyfieldsToDelete = req.body.keyfieldsToDelete;

  if (!keyfieldsToDelete || !keyfieldsToDelete.length) {
    res.status(400).json("Invalid or empty keyfields array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase();
    for (const record of keyfieldsToDelete) {
      const { EmployeeId, company_code } = record;
      await pool
        .request()
        .input("EmployeeId", sql.NVarChar, EmployeeId)
        .input("company_code", sql.NVarChar, company_code)
        .query(`EXEC sp_employee_Leave 'D',@EmployeeId,'','','','','','','','','',@company_code,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    }

    res.status(200).json("Employee leave data deleted successfully");
  } catch (err) {
    console.error("Error inserting data:", err);

    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};

const updateEmployeeLeave = async (req, res) => {
  const editedData = req.body.editedData;

  if (!editedData || !editedData.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }


  try {
    const pool = await connection.connectToDatabase(dbConfig);
    for (const updatedRow of editedData) {
      await pool
        .request()
        .input("mode", sql.NVarChar, "U")
        .input("EmployeeId", updatedRow.EmployeeId)
        .input("LeaveType", updatedRow.LeaveType)
        .input("FromDate", updatedRow.FromDate)
        .input("ToDate", updatedRow.ToDate)
        .input("Duration", updatedRow.Duration)
        .input("ReportingManager", updatedRow.ReportingManager)
        .input("AlternativeReponsablePerson", updatedRow.AlternativeReponsablePerson)
        .input("LeaveStatus", updatedRow.LeaveStatus)
        .input("Reason", updatedRow.Reason)
        .input("company_code", updatedRow.company_code)
        .input("modified_by", updatedRow.modified_by)
        .query(`EXEC sp_employee_Leave @mode,@EmployeeId,@LeaveType,@FromDate,ToDate,@Duration,@ReportingManager,@AlternativeReponsablePerson,@LeaveStatus,@Reason,@Documents,@company_code,'',@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    }
    res.status(200).json("Employee leave data updated successfully");
  } catch (err) {
    console.error("Error inserting data:", err);

    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};

const addEmployeedoc = async (req, res) => {
  const {
    EmployeeId,
    dropboxURL,
    GoogleDriveURL,
    company_code,
    Created_by,
    Modified_by,
    tempstr1,
    tempstr2,
    tempstr3,
    tempstr4,
    datetime1,
    datetime2,
    datetime3,
    datetime4,
  } = req.body;
  let ResumeFile = req.files['ResumeFile'] ? req.files['ResumeFile'][0].buffer : null;
  let OfferLetter = req.files['OfferLetter'] ? req.files['OfferLetter'][0].buffer : null;
  let JoiningLetter = req.files['JoiningLetter'] ? req.files['JoiningLetter'][0].buffer : null;
  let ContractAndAgreement = req.files['ContractAndAgreement'] ? req.files['ContractAndAgreement'][0].buffer : null;
  let aadhar_and_pan = req.files['aadhar_and_pan'] ? req.files['aadhar_and_pan'][0].buffer : null;
  try {
    const pool = await sql.connect(dbConfig);
    const result = await pool.request()
      .input("mode", sql.NVarChar, "I")
      .input("EmployeeId", sql.NVarChar, EmployeeId)
      .input("ResumeFile", sql.VarBinary, ResumeFile)
      .input("OfferLetter", sql.VarBinary, OfferLetter)
      .input("JoiningLetter", sql.VarBinary, JoiningLetter)
      .input("ContractAndAgreement", sql.VarBinary, ContractAndAgreement)
      .input("dropboxURL", sql.NVarChar, dropboxURL)
      .input("GoogleDriveURL", sql.NVarChar, GoogleDriveURL)
      .input("aadhar_and_pan", sql.VarBinary, aadhar_and_pan)
      .input("company_code", sql.NVarChar, company_code)
      .input("Created_by", sql.NVarChar, Created_by)
      .input("Modified_by", sql.NVarChar, Modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(`EXEC sp_employee_documents @mode,@EmployeeId,@ResumeFile,@OfferLetter,@JoiningLetter,@ContractAndAgreement,@dropboxURL,@GoogleDriveURL,@aadhar_and_pan,@company_code,@Created_by, @Modified_by, @tempstr1, @tempstr2, @tempstr3, @tempstr4, @datetime1, @datetime2, @datetime3, @datetime4`);
    if (result.rowsAffected && result.rowsAffected[0] > 0) {
      return res.status(200).json({ success: true, message: 'Employee documents inserted successfully' });
    }
  } catch (err) {
    console.error("Error inserting data:", err);

    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};


const Add_employee_bankdetails = async (req, res) => {
  const { Account_NO, EmployeeId, AccountHolderName, bankName, branchName, IFSC_Code, company_code, created_by } = req.body;

  let Bankbook_img = null;

  if (req.file) {
    Bankbook_img = req.file.buffer;
  }

  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.VarChar, "I") // Insert mode
      .input("Account_NO", sql.VarChar, Account_NO)
      .input("EmployeeId", sql.VarChar, EmployeeId)
      .input("AccountHolderName", sql.VarChar, AccountHolderName)
      .input("bankName", sql.VarChar, bankName)
      .input("branchName", sql.VarChar, branchName)
      .input("IFSC_Code", sql.VarChar, IFSC_Code)
      .input("Bankbook_img", sql.VarBinary, Bankbook_img)
      .input("company_code", sql.VarChar, company_code)
      .input("created_by", sql.VarChar, created_by)
      .query(
        `EXEC sp_employee_bankdetails @mode,@Account_NO,@EmployeeId,'','',@AccountHolderName,@bankName,@branchName,@IFSC_Code,@Bankbook_img,@company_code,@created_by,'',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.json({ success: true, message: "Data inserted successfully" });
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getallEmployeebankdet = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`EXEC sp_employee_bankdetails 'A','','','','','',0,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`); res.json(result.recordset);
    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const Employeebankdetdelete = async (req, res) => {
  const { Account_NO, company_code } = req.body; try {
    const pool = await connection.connectToDatabase();
    await pool.request()
      .input("Account_NO", sql.NVarChar, Account_NO) // Specify the type (e.g., sql.NVarChar)
      .input("company_code", sql.NVarChar, company_code) // Specify the type (e.g., sql.NVarChar)
      .query(`EXEC sp_employee_bankdetails 'D',@Account_NO, '', '','', '', '', '', 0,'',@company_code,'','', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL`); res.status(200).json("Bank details Deleted Successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const updateEmployeebankdet = async (req, res) => {
  const { Account_NO, EmployeeId, AccountHolderName, bankName, branchName, IFSC_Code, company_code, modified_by } = req.body;

  let Bankbook_img = null;

  if (req.file) {
    Bankbook_img = req.file.buffer;
  }

  try {
    const pool = await connection.connectToDatabase();
    await pool
      .request()
      .input("mode", sql.NVarChar, "U")
      .input("Account_NO", sql.VarChar, Account_NO)
      .input("EmployeeId", sql.VarChar, EmployeeId)
      .input("AccountHolderName", sql.VarChar, AccountHolderName)
      .input("bankName", sql.VarChar, bankName)
      .input("branchName", sql.VarChar, branchName)
      .input("IFSC_Code", sql.VarChar, IFSC_Code)
      .input("Bankbook_img", sql.VarBinary, Bankbook_img)
      .input("company_code", sql.VarChar, company_code)
      .input("modified_by", sql.VarChar, modified_by)
      .query(`EXEC sp_employee_bankdetails @mode,@Account_NO,@EmployeeId,'','',@AccountHolderName,@bankName,@branchName,@IFSC_Code,@Bankbook_img,@company_code,'',@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    res.status(200).json("Employee bank details edited successfully");
  } catch (error) {
    if (error.class === 16 && error.number === 50000) {
      // Custom error from the stored procedure
      res.status(400).json({ message: error.message });
    } else {
      // Handle unexpected errors
      res.status(500).json({ message: 'Internal Server Error', error: error.message });
    }
  }
};

const delemployeedoc = async (req, res) => {
  const { EmployeeId, company_code } = req.body;
  if (!EmployeeId) {
    return res.status(400).json({ message: "Employee ID is required." });
  }
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool.request()
      .input("employeeID", sql.NVarChar, EmployeeId)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_employee_documents 'D',@EmployeeId,'','','','','','','',@company_code, '', '', '', '','', '', '', '','',''`);
    if (result.rowsAffected[0] > 0) {
      return res.status(200).json({ message: "Employee document deleted successfully." });
    } else {
      return res.status(404).json({ message: "Employee not found." });
    }
  } catch (err) {
    console.error("Error inserting data:", err);

    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};

const getAllemployeedoc = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(
      `EXEC sp_employee_documents 'A','','','','','','','','','','', '', '', '', '','', '', '', '',''`
      /* "exec spexpensetype"*/
    );
    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const UpdateEmployeeImage = async (req, res) => {
  const { EmployeeId, Modified_by } = req.body; // Assuming EmployeeId is sent in the body
  let Photos = null;
  if (req.file) {
    Photos = req.file.buffer; // Buffer containing the uploaded image
  }
  try {
    // Check if the employee exists in the database
    const pool = await connection.connectToDatabase();
    // Proceed to update the image if the employee exists
    const result = await pool
      .request()
      .input("EmployeeId", sql.NVarChar, EmployeeId) // Add the EmployeeId for any further queries if needed
      .input("Photos", sql.VarBinary, Photos)
      .input("Modified_by", sql.NVarChar, Modified_by) // Assuming req.user.username is available
      .query(`EXEC [sp_employee_personal]  'UI',@EmployeeId,'','','','','','','','','','','','','','','','','','',@Photos,'','','','','','',@Modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    // Return success response
    if (result.rowsAffected && result.rowsAffected[0] > 0) {
      return res.status(200).json({ success: true, message: 'Image updated successfully' });
    } else {
      return res.status(400).json({ success: false, message: 'No changes made to the employee image.' });
    }
  } catch (err) {
    console.error("Error inserting data:", err);

    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};

// const addEmployeePersonalData = async (req, res) => {
//   const {
//     EmployeeId,
//     First_Name,
//     Middle_Name,
//     Last_Name,
//     Father_Name,
//     Mother_Name,
//     DOB,
//     Gender,
//     Email,
//     Phone1,
//     Phone2,
//     Address1,
//     Address2,
//     Address3,
//     PermanantAddress,
//     Reference_Name,
//     Reference_Phone,
//     Pan_No,
//     Aadhar_no,
//     Marital_Status,
//     Siblings,
//     Kids,
//     Grade_id,
//     Created_by,
//     Modified_by,
//     tempstr1,
//     tempstr2,
//     tempstr3,
//     tempstr4,
//     datetime1,
//     datetime2,
//     datetime3,
//     datetime4,
//   } = req.body;
//   let Photos = null;
//   if (req.file) {
//     Photos = req.file.buffer; // Buffer containing the uploaded audio
//   }
//   try {
//     const pool = await sql.connect(dbConfig);
//     const result = await pool.request()
//       .input("mode", sql.NVarChar, "I")
//       .input("EmployeeId", sql.NVarChar, EmployeeId)
//       .input("First_Name", sql.NVarChar, First_Name)
//       .input("Middle_Name", sql.NVarChar, Middle_Name)
//       .input("Last_Name", sql.NVarChar, Last_Name)
//       .input("Father_Name", sql.NVarChar, Father_Name)
//       .input("Mother_Name", sql.NVarChar, Mother_Name)
//       .input("DOB", sql.Date, DOB)
//       .input("Gender", sql.NVarChar, Gender)
//       .input("Email", sql.NVarChar, Email)
//       .input("Phone1", sql.NVarChar, Phone1)
//       .input("Phone2", sql.NVarChar, Phone2)
//       .input("Address1", sql.NVarChar, Address1)
//       .input("Address2", sql.NVarChar, Address2)
//       .input("Address3", sql.NVarChar, Address3)
//       .input("PermanantAddress", sql.NVarChar, PermanantAddress)
//       .input("Reference_Name", sql.NVarChar, Reference_Name)
//       .input("Reference_Phone", sql.NVarChar, Reference_Phone)
//       .input("Pan_No", sql.NVarChar, Pan_No)
//       .input("Aadhar_no", sql.NVarChar, Aadhar_no)
//       .input("Photos", sql.VarBinary, Photos) // Assuming Photos is in a format that can be converted to VARBINARY(MAX)
//       .input("Marital_Status", sql.NVarChar, Marital_Status)
//       .input("Siblings", sql.NVarChar, Siblings)
//       .input("Kids", sql.NVarChar, Kids)
//       .input("Grade_id", sql.NVarChar, Grade_id)
//       .input("Created_by", sql.NVarChar, Created_by)
//       .input("Modified_by", sql.NVarChar, Modified_by)
//       .input("tempstr1", sql.NVarChar, tempstr1)
//       .input("tempstr2", sql.NVarChar, tempstr2)
//       .input("tempstr3", sql.NVarChar, tempstr3)
//       .input("tempstr4", sql.NVarChar, tempstr4)
//       .input("datetime1", sql.NVarChar, datetime1)
//       .input("datetime2", sql.NVarChar, datetime2)
//       .input("datetime3", sql.NVarChar, datetime3)
//       .input("datetime4", sql.NVarChar, datetime4)
//       .query(`EXEC sp_employee_personal @mode, @EmployeeId, @First_Name, @Middle_Name, @Last_Name, @Father_Name, @Mother_Name, @DOB, @Gender, @Email, @Phone1, @Phone2, @Address1, @Address2, @Address3, @PermanantAddress, @Reference_Name, @Reference_Phone, @Pan_No, @Aadhar_no, @Photos, @Marital_Status, @Siblings, @Kids, @Grade_id, @Created_by, @Modified_by, @tempstr1, @tempstr2, @tempstr3, @tempstr4, @datetime1, @datetime2, @datetime3, @datetime4`);
//     // Return success response
//     if (result.rowsAffected && result.rowsAffected[0] > 0) {
//       return res.status(200).json({ success: true, message: 'Employee personal data inserted successfully' });
//     }
//   } catch (err) {
//     console.error("Error inserting data:", err);

//     res.status(500).json({
//       message: err.message || "Internal Server Error"
//     });
//   }
// };


const Employeedataupdate = async (req, res) => {
  const { EmployeeId, First_Name, Middle_Name, Last_Name, Father_Name, Mother_Name, DOB, Gender, Email, Phone1, Phone2, Address1, Address2, Address3, PermanantAddress,
    Reference_name, Reference_Phone, Pan_No, Aadhar_no, Marital_Status, Siblings, Kids, Grade_id, company_code, Modified_by
  } = req.body;

  let Photos = null;

  if (req.file) {
    Photos = req.file.buffer;
  }



  try {
    const pool = await connection.connectToDatabase(dbConfig);
    await pool
      .request()
      .input("mode", sql.NVarChar, "U") // Insert mode
      .input("EmployeeId", sql.NVarChar, EmployeeId)
      .input("First_Name", sql.NVarChar, First_Name)
      .input("Middle_Name", sql.NVarChar, Middle_Name)
      .input("Last_Name", sql.NVarChar, Last_Name)
      .input("Father_Name", sql.NVarChar, Father_Name)
      .input("Mother_Name", sql.NVarChar, Mother_Name)
      .input("DOB", sql.Date, DOB)
      .input("Gender", sql.NVarChar, Gender)
      .input("Email", sql.NVarChar, Email)
      .input("Phone1", sql.NVarChar, Phone1)
      .input("Phone2", sql.NVarChar, Phone2)
      .input("Address1", sql.NVarChar, Address1)
      .input("Address2", sql.NVarChar, Address2)
      .input("Address3", sql.NVarChar, Address3)
      .input("PermanantAddress", sql.NVarChar, PermanantAddress)
      .input("Reference_name", sql.NVarChar, Reference_name)
      .input("Reference_Phone", sql.NVarChar, Reference_Phone)
      .input("Pan_No", sql.NVarChar, Pan_No)
      .input("Aadhar_no", sql.NVarChar, Aadhar_no)
      .input("Photos", sql.VarBinary, Photos)
      .input("Marital_Status", sql.NVarChar, Marital_Status)
      .input("Siblings", sql.NVarChar, Siblings)
      .input("Kids", sql.NVarChar, Kids)
      .input("Grade_id", sql.NVarChar, Grade_id)
      .input("company_code", sql.NVarChar, company_code)

      .input("Modified_by", sql.NVarChar, Modified_by)
      .query(`EXEC sp_employee_personal
            @mode, @EmployeeId, @First_Name, @Middle_Name, @Last_Name,
            @Father_Name, @Mother_Name, @DOB, @Gender,
            @Email, @Phone1, @Phone2, @Address1,
            @Address2, @Address3, @PermanantAddress,
            @Reference_Name, @Reference_Phone, @Pan_No,
            @Aadhar_no, @Photos, @Marital_Status,
             @Siblings, @Kids, @Grade_id,@company_code,'','', @Modified_by,
             null, null, null, null,
             null, null, null, null`);
    res.status(200).json("Employee personal data updated successfully");
  } catch (err) {
    console.error("Error inserting data:", err);
    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};

const deleteemployeeper = async (req, res) => {
  const { EmployeeId, company_code } = req.body;
  if (!EmployeeId) {
    return res.status(400).json({ message: "Employee ID is required." });
  }
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool.request()
      .input("employeeID", sql.NVarChar, EmployeeId)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC [sp_employee_personal]  'D',@EmployeeId,'','','','','','','','','','','','','','','','','','','','','','','',@company_code,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.rowsAffected[0] > 0) {
      return res.status(200).json({ message: "Employee Personal  deleted successfully." });
    } else {
      return res.status(404).json({ message: "Employee not found." });
    }
  } catch (err) {
    console.error("Error inserting data:", err);

    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};

const getAllemployeedata = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(
      `EXEC [sp_employee_personal]  'A','','','','','','','','','','','','','','','','','','','','','','','','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`
      /* "exec spexpensetype"*/
    );
    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getEmployeeDocument = async (req, res) => {
  const { Id, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "ED")
      .input("Id", sql.NVarChar, Id)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_employee_getdata @mode,@Id,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//Code added by Harish 12-11-2024

const addEmployeePersonalData = async (req, res) => {
  const {
    EmployeeId,
    First_Name,
    Middle_Name,
    Last_Name,
    Father_Name,
    Mother_Name,
    DOB,
    Gender,
    Email,
    Phone1,
    Phone2,
    Address1,
    Address2,
    Address3,
    PermanantAddress,
    Reference_Name,
    Reference_Phone,
    Pan_No,
    Aadhar_no,
    Marital_Status,
    Siblings,
    Kids,
    Grade_id,
    company_code,
    Created_by,
    Modified_by,
    tempstr1,
    tempstr2,
    tempstr3,
    tempstr4,
    datetime1,
    datetime2,
    datetime3,
    datetime4,
  } = req.body;

  let Photos = null;
  if (req.file) {
    Photos = req.file.buffer; // Buffer containing the uploaded IMG
  }

  try {
    const pool = await sql.connect(dbConfig);
    const result = await pool.request()
      .input("mode", sql.NVarChar, "I")
      .input("EmployeeId", sql.NVarChar, EmployeeId)
      .input("First_Name", sql.NVarChar, First_Name)
      .input("Middle_Name", sql.NVarChar, Middle_Name)
      .input("Last_Name", sql.NVarChar, Last_Name)
      .input("Father_Name", sql.NVarChar, Father_Name)
      .input("Mother_Name", sql.NVarChar, Mother_Name)
      .input("DOB", sql.Date, DOB)
      .input("Gender", sql.NVarChar, Gender)
      .input("Email", sql.NVarChar, Email)
      .input("Phone1", sql.NVarChar, Phone1)
      .input("Phone2", sql.NVarChar, Phone2)
      .input("Address1", sql.NVarChar, Address1)
      .input("Address2", sql.NVarChar, Address2)
      .input("Address3", sql.NVarChar, Address3)
      .input("PermanantAddress", sql.NVarChar, PermanantAddress)
      .input("Reference_Name", sql.NVarChar, Reference_Name)
      .input("Reference_Phone", sql.NVarChar, Reference_Phone)
      .input("Pan_No", sql.NVarChar, Pan_No)
      .input("Aadhar_no", sql.NVarChar, Aadhar_no)
      .input("Photos", sql.VarBinary, Photos) // Assuming Photos is in a format that can be converted to VARBINARY(MAX)
      .input("Marital_Status", sql.NVarChar, Marital_Status)
      .input("Siblings", sql.NVarChar, Siblings)
      .input("Kids", sql.NVarChar, Kids)
      .input("Grade_id", sql.NVarChar, Grade_id)
      .input("company_code", sql.NVarChar, company_code)
      .input("Created_by", sql.NVarChar, Created_by)
      .input("Modified_by", sql.NVarChar, Modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(`EXEC sp_employee_personal @mode, @EmployeeId, @First_Name, @Middle_Name, @Last_Name, @Father_Name, @Mother_Name, @DOB, @Gender, @Email, @Phone1, @Phone2, @Address1, @Address2, @Address3, @PermanantAddress, @Reference_Name, @Reference_Phone, @Pan_No, @Aadhar_no, @Photos, @Marital_Status, @Siblings, @Kids, @Grade_id,@company_code, '',@Created_by, @Modified_by, @tempstr1, @tempstr2, @tempstr3, @tempstr4, @datetime1, @datetime2, @datetime3, @datetime4`);
    // Return success response
    if (result.rowsAffected && result.rowsAffected[0] > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json(err.message);
    }
  } catch (error) {

    return res.status(500).json({ message: error.message || "Internal Server Error" });

  }
};



const getID = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        `EXEC sp_Grade 'F','','',0,0,0,0,0,0,0,0,0,0,'',0,0,0,@company_code,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};



const getsiblings = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'Siblings','','', '' ,'','', NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const getkids = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'Kids','','', '' ,'','', NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const getMartial = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'Marital Status','','', '' ,'','', NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const addLeaveType = async (req, res) => {
  const {
    company_code, LeaveId, Description, code, Type, Accrual, TotalDaystoBeCredit, carryForward, Exceed_Leave, LeaveReason,
    created_by, modified_by,
    tempstr1, tempstr2, tempstr3, tempstr4, datetime1, datetime2, datetime3, datetime4,

  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.VarChar, "I") // Insert mode
      .input("company_code", sql.VarChar, company_code)
      .input("LeaveId", sql.VarChar, LeaveId)
      .input("Description", sql.VarChar, Description)
      .input("code", sql.VarChar, code)
      .input("Type", sql.VarChar, Type)
      .input("Accrual", sql.VarChar, Accrual)
      .input("TotalDaystoBeCredit", sql.Int, TotalDaystoBeCredit)
      .input("carryForward", sql.Int, carryForward)
      .input("Exceed_Leave", sql.VarChar, Exceed_Leave)
      .input("LeaveReason", sql.VarChar, LeaveReason)
      .input("created_by", sql.VarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.VarChar, tempstr1)
      .input("tempstr2", sql.VarChar, tempstr2)
      .input("tempstr3", sql.VarChar, tempstr3)
      .input("tempstr4", sql.VarChar, tempstr4)
      .input("datetime1", sql.VarChar, datetime1)
      .input("datetime2", sql.VarChar, datetime2)
      .input("datetime3", sql.VarChar, datetime3)
      .input("datetime4", sql.VarChar, datetime4)
      .query(
        `EXEC sp_LeaveTypes @mode,@company_code,@LeaveId,@Description,@code,@Type,@Accrual,@TotalDaystoBeCredit,@carryForward,@Exceed_Leave,@LeaveReason,@created_by,@modified_by,@tempstr1,@tempstr2,@tempstr3,@tempstr4,@datetime1,@datetime2,@datetime3,@datetime4`);
    res.json({ success: true, message: "Data inserted successfully" });
  } catch (err) {
    console.error("Error inserting data:", err);

    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};



const getemployeemanager = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(
      "EXEC sp_employee_company 'f','','','','','','','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
    );

    res.json(result.recordset);
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//Code Ended by Harish 12-11-2024

//Code Added by Harish 13-11-2024


const addDailyattendance = async (req, res) => {
  const { EmployeeId, date, checkIn, checkOut, Status, company_code, created_by,
    tempstr1, tempstr2, tempstr3, tempstr4, datetime1, datetime2, datetime3, datetime4,
  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("EmployeeId", sql.VarChar, EmployeeId)
      .input("date", sql.Date, date)
      .input("checkIn", sql.DateTime, checkIn)
      .input("checkOut", sql.DateTime, checkOut)
      .input("Status", sql.VarChar, Status)
      .input("company_code", sql.NVarChar, company_code)
      .input("created_by", sql.NVarChar, created_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(`EXEC sp_daily_attendance 'i',@EmployeeId,@date,
        '','','','','','',@company_code,'','',null,null,
        null,null,null,null,null,null
`);
    res.status(200).json("Check IN data inserted successfully");
  } catch (err) {
    console.error("Error inserting data:", err);
    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};





const getEmployeeFamily = async (req, res) => {
  const { Id, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "EF")
      .input("Id", sql.NVarChar, Id)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_employee_getdata @mode,@Id,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getSalaryType = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'Salary Type','','', '' ,'','', NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getPayscale = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'Payscale','','', '' ,'','', NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


//Code Added by Harish 14-11-2024

const getEmployeePersonaldet = async (req, res) => {
  const { Id, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "EP")
      .input("Id", sql.NVarChar, Id)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_employee_getdata @mode,@Id,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordsets && result.recordsets.length > 0 && result.recordsets[0].length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};




//Code Ended by Harish 14-11-2024

const getLoanID = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'LoanID','','', '' ,'','', NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const getEmployeeSalary = async (req, res) => {
  const { Id, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "ES")
      .input("Id", sql.NVarChar, Id)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_employee_getdata @mode,@Id,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const getEmployeeBankDeatils = async (req, res) => {
  const { Id, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "EBD")
      .input("Id", sql.NVarChar, Id)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_employee_getdata @mode,@Id,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getGrade = async (req, res) => {
  const { Id, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "GD")
      .input("Id", sql.NVarChar, Id)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_employee_getdata @mode,@Id,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


//Code added By Harish  18_11_2024
const getItem = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'product','','', '','','', NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const getEmployeeTotalLeaveBalance = async (req, res) => {
  const { company_code, EmployeeId } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "TLB")
      .input("EmployeeId", sql.NVarChar, EmployeeId)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_ess_Employee_dashboard @mode,@EmployeeId,@company_code`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const getEmployeeLeavesearch = async (req, res) => {
  const { FromDate, ToDate, LeaveType, LeaveStatus, company_code, EmployeeId } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("FromDate", sql.NVarChar, FromDate)
      .input("ToDate", sql.NVarChar, ToDate)
      .input("LeaveType", sql.NVarChar, LeaveType)
      .input("LeaveStatus", sql.NVarChar, LeaveStatus)
      .input("EmployeeId", sql.NVarChar, EmployeeId)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_employee_Leave @mode,@EmployeeId,@LeaveType,@FromDate,@ToDate,'','','',@LeaveStatus,'','','',@company_code,'','',null,null,null,null,null,null,null,null`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};





const getTaxInvoiceNo = async (req, res) => {
  const { transaction_no, company_code, tempstr1 } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "TI")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .query(`EXEC sp_getdata @mode,@transaction_no,@company_code,@tempstr1,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    if (result.recordsets && result.recordsets.length > 0 && result.recordsets[0].length > 0) {
      const data = {
        Header: result.recordsets[0],
        Detail: result.recordsets[1] || [],
        TaxDetail: result.recordsets[2] || [],
        Terms: result.recordsets[3] || []
      };
      res.status(200).json(data);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

//Code Ended By Harish  18_11_2024
//Code begin  by Mathu 19_11_2024
const addEmployeeAcademicDetails = async (req, res) => {

  const employeeData = req.body.employeeData;

  if (!employeeData || !employeeData.length) {
    res.status(400).json("Invalid or empty employeeId array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase(dbConfig);
    for (const insertRow of employeeData) {

      let document = insertRow.document || null;
      if (document) {
        const buffer = Buffer.from(document, 'base64');
        document = buffer;
      }

      await pool
        .request()
        .input("mode", sql.NVarChar, "I")
        .input("EmployeeId", insertRow.EmployeeId)
        .input("academicName", insertRow.academicName)
        .input("major", insertRow.major)
        .input("institution", insertRow.institution)
        .input("academicYear", insertRow.academicYear)
        .input("document", document)
        .input("keyfield", insertRow.keyfield)
        .input("company_code", insertRow.company_code)
        .input("created_by", insertRow.created_by)
        .input("modified_by", insertRow.modified_by)
        .input("tempstr1", insertRow.tempstr1)
        .input("tempstr2", insertRow.tempstr2)
        .input("tempstr3", insertRow.tempstr3)
        .input("tempstr4", insertRow.tempstr4)
        .input("datetime1", insertRow.datetime1)
        .input("datetime2", insertRow.datetime2)
        .input("datetime3", insertRow.datetime3)
        .input("datetime4", insertRow.datetime4)
        .query(`EXEC sp_employee_academic_datails @mode,@EmployeeId,@academicName,@major,@institution,@academicYear,@Document,@keyfield,@company_code,'',@created_by,@modified_by,@tempstr1,@tempstr2,@tempstr3,@tempstr4,@datetime1,@datetime2,@datetime3,@datetime4`);
    }
    res.status(200).json("Employee academic details data inserted successfully");
  } catch (err) {
    console.error("Error inserting data:", err); res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};

const allEmployeeAcademicDetails = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`EXEC sp_employee_academic_datails 'A','','','','','',0,'','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    res.json(result.recordset);
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const updateEmployeeAcademicDetails = async (req, res) => {
  const editedData = req.body.editedData;

  if (!editedData || !editedData.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase(dbConfig);
    for (const updatedRow of editedData) {

      let document = updatedRow.document || null;
      if (document) {
        const buffer = Buffer.from(document, 'base64');
        document = buffer;
      }

      await pool
        .request()
        .input("mode", sql.NVarChar, "U")
        .input("EmployeeId", updatedRow.EmployeeId)
        .input("academicName", updatedRow.academicName)
        .input("major", updatedRow.major)
        .input("institution", updatedRow.institution)
        .input("academicYear", updatedRow.academicYear)
        .input("document", document)
        .input("keyfield", updatedRow.keyfield)
        .input("company_code", updatedRow.company_code)
        .input("modified_by", updatedRow.modified_by)
        .query(`EXEC sp_employee_academic_datails @mode,@EmployeeId,@academicName,@major,@institution,@academicYear,@document,@keyfield,@company_code,'','',@modified_by,'','','','','','','',''`);
    }
    res.status(200).json("Employee academic details updated successfully");
  } catch (err) {
    console.error("Error updated data:", err);

    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};

const deleteEmployeeAcademicDetails = async (req, res) => {
  const keyfieldsToDelete = req.body.keyfieldsToDelete;

  if (!keyfieldsToDelete || !keyfieldsToDelete.length) {
    res.status(400).json("Invalid or empty keyfields array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase();
    for (const record of keyfieldsToDelete) {
      const { keyfield, company_code } = record;
      await pool
        .request()
        .input("keyfield", sql.NVarChar, keyfield)
        .input("company_code", sql.NVarChar, company_code)
        .query(`EXEC sp_employee_academic_datails 'D','','','','','','',@keyfield,@company_code,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    }

    res.status(200).json("Employee academic details deleted successfully");
  } catch (err) {
    console.error("Error inserting data:", err);

    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};

const addEmployeeIdentityDocument = async (req, res) => {

  const employeeData = req.body.employeeData;
  if (!employeeData || !employeeData.length) {
    res.status(400).json("Invalid or empty employeeData array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase(dbConfig);
    for (const insertRow of employeeData) {

      let document = insertRow.document || null;
      if (document) {
        const buffer = Buffer.from(document, 'base64');
        document = buffer;
      }

      await pool
        .request()
        .input("mode", sql.NVarChar, "I")
        .input("EmployeeId", insertRow.EmployeeId)
        .input("documentType", insertRow.documentType)
        .input("documentNo", insertRow.documentNo)
        .input("issueDate", insertRow.issueDate)
        .input("expiryDate", insertRow.expiryDate)
        .input("document", document)
        .input("company_code", insertRow.company_code)
        .input("created_by", insertRow.created_by)
        .input("modified_by", insertRow.modified_by)
        .input("tempstr1", insertRow.tempstr1)
        .input("tempstr2", insertRow.tempstr2)
        .input("tempstr3", insertRow.tempstr3)
        .input("tempstr4", insertRow.tempstr4)
        .input("datetime1", insertRow.datetime1)
        .input("datetime2", insertRow.datetime2)
        .input("datetime3", insertRow.datetime3)
        .input("datetime4", insertRow.datetime4)
        .query(`EXEC sp_employee_identity_document @mode,@EmployeeId,@documentType,@documentNo,@issueDate,@expiryDate,@document,@company_code,'',@created_by,@modified_by,@tempstr1,@tempstr2,@tempstr3,@tempstr4,@datetime1,@datetime2,@datetime3,@datetime4`);
    }
    res.status(200).json("Employee document data inserted successfully");
  } catch (err) {
    console.error("Error inserting data:", err); res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};

const allEmployeeIdentityDocument = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`EXEC sp_employee_identity_document 'A','','','','','',0,'','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
  `);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const updateEmployeeIdentityDocument = async (req, res) => {
  const editedData = req.body.editedData;

  if (!editedData || !editedData.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase(dbConfig);
    for (const updatedRow of editedData) {

      let document = updatedRow.document || null;
      if (document) {
        const buffer = Buffer.from(document, 'base64');
        document = buffer;
      }

      await pool
        .request()
        .input("mode", sql.NVarChar, "U") // Insert mode
        .input("EmployeeId", updatedRow.EmployeeId)
        .input("documentType", updatedRow.documentType)
        .input("documentNo", updatedRow.documentNo)
        .input("issueDate", updatedRow.issueDate)
        .input("expiryDate", updatedRow.expiryDate)
        .input("document", document)
        .input("company_code", updatedRow.company_code)
        .input("created_by", updatedRow.created_by)
        .input("modified_by", updatedRow.modified_by)
        .query(`EXEC sp_employee_identity_document @mode,@EmployeeId,@documentType,@documentNo,@issueDate,@expiryDate,@document,@company_code,'',@created_by,@modified_by,'','','','','','','',''`);
    }
    res.status(200).json("Employee family data updated successfully");
  } catch (err) {
    console.error("Error inserting data:", err);

    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};

const updateempDoc = async (req, res) => {
  const editedData = req.body.editedData;
  if (!editedData || !editedData.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }
  try {
    const pool = await connection.connectToDatabase(dbConfig);
    for (const updatedRow of editedData) {

      let document_files = updatedRow.document_files || null;
      if (document_files) {
        const buffer = Buffer.from(document_files, 'base64');
        document_files = buffer;
      }
      await pool
        .request()
        .input("mode", sql.NVarChar, "U")
        .input("EmployeeId", updatedRow.EmployeeId)
        .input("document_name", updatedRow.document_name)
        .input("document_files", updatedRow.document_files)
        .input("keyfield", updatedRow.keyfield)
        .input("modified_by", updatedRow.modified_by)
        .input("company_code", updatedRow.company_code)
        .query(`EXEC sp_ess_employee_documents @mode,@EmployeeId,@document_name,@document_files,@keyfield,@company_code,'','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    }
    res.status(200).json("Employee family data updated successfully");
  } catch (err) {
    console.error("Error inserting data:", err);
    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};


const deleteEmployeeIdentityDocument = async (req, res) => {
  const documentNoToDelete = req.body.documentNoToDelete;

  if (!documentNoToDelete || !documentNoToDelete.length) {
    res.status(400).json("Invalid or empty keyfields array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase();
    for (const record of documentNoToDelete) {
      const { documentNo, company_code } = record;
      await pool
        .request()
        .input("documentNo", sql.NVarChar, documentNo)
        .input("company_code", sql.NVarChar, company_code)
        .query(`EXEC sp_employee_identity_document 'D','','',@documentNo,'','',0,@company_code,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    }

    res.status(200).json("Employee document data deleted successfully");
  } catch (err) {
    console.error("Error inserting data:", err);

    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};

// code ended by mathu 19_11_2024


// code added by Harish 21_11_2024
const getTaxInvoicePeriod = async (req, res) => {
  const { mode, company_code, Type, StartDate, EndDate, bill_no, billTo_customer_name, shipTo_customer_name, ShipTo_customer_addr_1 } = req.body;
  let pool;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, mode) // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("Type", sql.NVarChar, Type)
      .input("StartDate", sql.NVarChar, StartDate)
      .input("EndDate", sql.NVarChar, EndDate)
      .input("bill_no", sql.NVarChar, bill_no)
      .input("billTo_customer_name", sql.NVarChar, billTo_customer_name)
      .input("shipTo_customer_name", sql.NVarChar, shipTo_customer_name)
      .input("ShipTo_customer_addr_1", sql.NVarChar, ShipTo_customer_addr_1)
      .query(`EXEC sp_tax_invoice_period @mode,@company_code,@Type,@StartDate,@EndDate,@bill_no,@billTo_customer_name,@shipTo_customer_name,@ShipTo_customer_addr_1`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json('No data found');
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

// code ended by Harish 21_11_2024

const getDocumentType = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'document type','','', '','','', NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getAcademicDetails = async (req, res) => {
  const { Id, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "EAD")
      .input("Id", sql.NVarChar, Id)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_employee_getdata @mode,@Id,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

// Code Added by Harish 28/11/24
const getallProduct = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "PRO")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_getdata @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Check if data is found
    if (result.recordsets && result.recordsets.length > 0 && result.recordsets[0].length > 0) {
      const data = {
        Header: result.recordsets[0],
        Details: result.recordsets[1] || [] // Provide an empty array if no data

      };
      res.status(200).json(data); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

// Code Ended by Harish 28/11/24

//Code Added by Pavun 30/11/2024
const getCustomerDetails = async (req, res) => {
  const { company_code, customer_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "TC")
      .input("company_code", sql.NVarChar, company_code)
      .input("customer_code", sql.NVarChar, customer_code)
      .query(`EXEC sp_customer_details_info @mode,@customer_code,@company_code,'','','','','','','','','','','','','','','','','',0,'','','','','','','','','','',NULL,NULL,NULL,null,null,null,null,null`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const addTaxInvoicedetail_list = async (req, res) => {
  const { company_code,
    bill_date,
    bill_no,
    SNo,
    code,
    name,
    Description,
    dely_chlno,
    warehouse_code,
    customer_code,
    customer_name,
    bill_qty,
    bill_rate,
    unit_price,
    pay_type,
    sales_type,
    tax_amt,
    type,
    hsn_code,
    invoice_type,
    created_by
  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("bill_date", sql.Date, bill_date)
      .input("bill_no", sql.NVarChar, bill_no)
      .input("SNo", sql.Int, SNo)
      .input("code", sql.NVarChar, code)
      .input("name", sql.NVarChar, name)
      .input("Description", sql.NVarChar, Description)
      .input("dely_chlno", sql.NVarChar, dely_chlno)
      .input("warehouse_code", sql.NVarChar, warehouse_code)
      .input("customer_code", sql.NVarChar, customer_code)
      .input("customer_name", sql.NVarChar, customer_name)
      .input("bill_qty", sql.Decimal(10, 2), bill_qty)
      .input("bill_rate", sql.Decimal(10, 2), bill_rate)
      .input("unit_price", sql.Decimal(10, 2), unit_price)
      .input("pay_type", sql.NVarChar, pay_type)
      .input("sales_type", sql.NVarChar, sales_type)
      .input("tax_amt", sql.Decimal(14, 2), tax_amt)
      .input("type", sql.NVarChar, type)
      .input("hsn_code", sql.NVarChar, hsn_code)
      .input("invoice_type", sql.NVarChar, invoice_type)
      .input("created_by", sql.NVarChar, created_by)
      .query(
        `EXEC sp_tax_invoice_details_list @mode,@company_code,@bill_date,@bill_no,@SNo,@code,@name,@Description,@dely_chlno,@warehouse_code,@customer_code,@customer_name,@bill_qty,@bill_rate,@unit_price,@pay_type,@sales_type,@tax_amt,@type,@hsn_code,@invoice_type,@created_by,'',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.json({ success: true, message: "Data inserted successfully" });
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//code ended  by pavun 30/11/2024


//Code Added by Harish 02/12/2024

const ProductPrintHDR = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool.request()
      .input("mode", sql.NVarChar, "ProH")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_print @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    // Process result sets
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const ProductPrintDet = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool.request()
      .input("mode", sql.NVarChar, "ProD")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_print @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    // Process result sets
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//Code Ended by Harish 02/12/2024

//Code Added by Harish 03/12/2024


const getrelation = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'Relationship','','', '','','', NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//Code Ended by Harish 03/12/2024


//code added by pavun 02-12-2024
const taxInvoiceBalanceAmountCalculation = async (req, res) => {
  const { TotalAmount, AdvanceAmount } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "BAC")
      .input("TotalAmount", sql.Decimal(14, 2), TotalAmount)
      .input("AdvanceAmount", sql.Decimal(14, 2), AdvanceAmount)
      .query(`EXEC sp_tax_invoice_ItemAmountCalculation @mode,'','',0,'',0,0,'','','',0,0,@TotalAmount,@AdvanceAmount,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//Code Added by Harish 05/12/2024

const TaxInvocieHdrPrint = async (req, res) => {
  const { transaction_no, company_code, invoice_type } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "TIH")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .input("tempstr1", sql.NVarChar, invoice_type)
      .query(`EXEC sp_print @mode,@transaction_no,@company_code,@tempstr1,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
}


const TaxInvocieDetPrint = async (req, res) => {
  const { transaction_no, company_code, invoice_type } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "TID")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .input("tempstr1", sql.NVarChar, invoice_type)

      .query(`EXEC sp_print @mode,@transaction_no,@company_code,@tempstr1,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
}




const taxinvoicetaxprint = async (req, res) => {
  const { transaction_no, company_code, invoice_type } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "TIT")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .input("tempstr1", sql.NVarChar, invoice_type)
      .query(`EXEC sp_tax_Print @mode,@transaction_no,@company_code,@tempstr1,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getannoncementtype = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'AnnouncementType','','', '' , '','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );
    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
const getAnnouncementDetail = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'AnnouncementDetail','','', '' , '','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );
    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const UpdateProducthdr = async (req, res) => {
  const { company_code, Product_Code, HSN_code, Product_name, description, status, Product_price, tax_type, Other_sales_taxtype, modified_by, tempstr1, tempstr2, tempstr3, tempstr4, datetime1, datetime2, datetime3, datetime4 } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "U")
      .input("company_code", sql.NVarChar, company_code)
      .input("Product_Code", sql.NVarChar, Product_Code)
      .input("Product_name", sql.NVarChar, Product_name)
      .input("HSN_code", sql.NVarChar, HSN_code)
      .input("description", sql.NVarChar, description)
      .input("status", sql.NVarChar, status)
      .input("Product_price", sql.Decimal(12, 2), Product_price)
      .input("tax_type", sql.NVarChar, tax_type)
      .input("Other_sales_taxtype", sql.NVarChar, Other_sales_taxtype)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(
        `EXEC sp_Product_Header @mode,@company_code,@Product_Code,@Product_name,@HSN_code,@description,@status,@Product_price,@tax_type,@Other_sales_taxtype,'',@modified_by,@tempstr1,@tempstr2,@tempstr3,@tempstr4,@datetime1,@datetime2,@datetime3,@datetime4`);
    res.json({ success: true, message: "Data inserted successfully" });
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


// const UpdateProducthdr= async (req, res) => {
//   const {product_code,company_code,Product_name,description,status,Product_price,tax_type} = req.body;
//   let pool;
//   try {
//     pool = await sql.connect(dbConfig);
//     const result = await pool
//       .request()
//       .input("mode",                            sql.NVarChar, "u") 
//       .input("company_code",                    sql.NVarChar, company_code)
//       .input("product_code",                    sql.NVarChar, product_code)
//       .input("Product_name",                    sql.NVarChar, Product_name)
//       .input("description",                     sql.NVarChar, description)
//       .input("status",                          sql.NVarChar, status)
//       .input("Product_price",                   sql.Decimal(12,2), Product_price)
//       .input("tax_type",                        sql.NVarChar, tax_type)

//       .query(
//     `EXEC sp_Product_Header @mode,@company_code,@product_code,@Product_name,'',@description,@status,@Product_price,@tax_type,'','','','','','','','','',''`);
//         res.json({ success: true, message: "Data Updated successfully" });
//       } catch (err) {
//         console.error(err);
//         res.status(500).json({ message: err.message || 'Internal Server Error' });
//       }
//     };

const UpdateProductdetails = async (req, res) => {
  const { company_code, Product_Code, Product_name, item_name, item_code, quantity, tot_amt, description, status, Item_SNo,
    created_by, modified_by, tempstr1, tempstr2, tempstr3, tempstr4, datetime1, datetime2, datetime3, datetime4 } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("Product_Code", sql.NVarChar, Product_Code)
      .input("Product_name", sql.NVarChar, Product_name)
      .input("item_name", sql.NVarChar, item_name)
      .input("item_code", sql.NVarChar, item_code)
      .input("quantity", sql.Decimal(10, 2), quantity)
      .input("tot_amt", sql.Decimal(12, 2), tot_amt)
      .input("description", sql.NVarChar, description)
      .input("status", sql.NVarChar, status)
      .input("Item_SNo", sql.BigInt, Item_SNo)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(`EXEC sp_Product_details @mode,@company_code,@Product_Code,@Product_name,@item_name,@item_code,@quantity,0,0,@description,@status,@Item_SNo,'',@modified_by,@tempstr1,@tempstr2,@tempstr3,@tempstr4,@datetime1,@datetime2,@datetime3,@datetime4`);
    res.json({ success: true, message: "Data inserted successfully" });
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

// const UpdateProductdetails= async (req, res) => {
//   const {item_name,item_code,quantity,product_code,company_code} = req.body;
//   let pool;
//   try {
//     pool = await sql.connect(dbConfig);
//     const result = await pool
//       .request()
//       .input("mode",                            sql.NVarChar, "u") 
//       .input("company_code",                    sql.NVarChar, company_code)
//       .input("product_code",                    sql.NVarChar, product_code)
//       .input("item_name",                       sql.NVarChar, item_name)
//       .input("item_code",                       sql.NVarChar, item_code)
//       .input("quantity",                        sql.Decimal(10,2), quantity)
//       .query(
//     `EXEC sp_product_details @mode,@company_code,@product_code,'',@item_name,@item_code,@quantity,0,0,0,'','','','','','','','','','','',''`);
//         res.json({ success: true, message: "Data Updated successfully" });
//       } catch (err) {
//         console.error(err);
//         res.status(500).json({message:err.message ||"Internal Server Error"});
//       }
//     };

const getAnnouncement_Msg = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'Announcement_Msg','','', '' , '','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );
    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getCurrentStockDetails = async (req, res) => {
  const { company_code, item_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "CSD")
      .input("company_code", sql.NVarChar, company_code)
      .input("item_code", sql.NVarChar, item_code)
      .query(
        `EXEC sp_dashboard_stock @mode,@company_code,@item_code `
      );
    if (result.recordset && Array.isArray(result.recordset) && result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    }
    else {
      // Send a 404 Not Found status if no data is found
      res.status(404).json('No data found');
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getCurrentStockItemCode = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "CSI")
      .input("company_code", sql.NVarChar, company_code)
      .query(
        `EXEC sp_dashboard_stock @mode,@company_code,'' `
      );
    if (result.recordset && Array.isArray(result.recordset) && result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    }
    else {
      // Send a 404 Not Found status if no data is found
      res.status(404).json('No data found');
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const addOpeningBalanceItemHdr = async (req, res) => {
  const { company_code, transaction_no, transaction_date, created_by, modified_by } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I")
      .input("company_code", sql.NVarChar, company_code)
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("transaction_date", sql.Date, transaction_date)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .query(`EXEC sp_opening_item_hdr @mode,@company_code,@transaction_no,@transaction_date,@created_by,@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
}


const getTotalStockValueDetails = async (req, res) => {
  const { company_code, item_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "TSVD")
      .input("company_code", sql.NVarChar, company_code)
      .input("item_code", sql.NVarChar, item_code)
      .query(
        `EXEC sp_dashboard_stock @mode,@company_code,@item_code`
      );
    if (result.recordset && Array.isArray(result.recordset) && result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    }
    else {
      // Send a 404 Not Found status if no data is found
      res.status(404).json('No data found');
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const openingitemhdr = async (req, res) => {
  const { company_code, transaction_no, transaction_date, created_by,
    tempstr1, tempstr2, tempstr3, tempstr4, datetime1, datetime2, datetime3, datetime4,

  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("transaction_date", sql.Date, transaction_date)
      .input("created_by", sql.NVarChar, created_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(`EXEC [sp_opening_item_hdr] @mode,@company_code,@transaction_no,@transaction_date ,
        @created_by,'',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`)

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data Added Successfully");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const openingitemdelhdr = async (req, res) => {

  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    await pool.request()
      .input("company_code", company_code)
      .input("transaction_no", transaction_no)

      .query(`EXEC [sp_opening_item_hdr] 'd',@company_code,@transaction_no,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.status(200).json("Opening Balance Header deleted successfully");
  }
  catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getallOIHdr = async (req, res) => {

  const { company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", company_code)
      .query
      (`EXEC [sp_opening_item_hdr] 'A',@company_code,'','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data Not Found");
    }
  }
  catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//code added by pavun 13-12-2024
const addOpeningItemDetail = async (req, res) => {
  const { company_code, transaction_no, transaction_date, Item_code, Item_name, bill_qty, Item_SNo, created_by } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("transaction_date", sql.Date, transaction_date)
      .input("Item_code", sql.NVarChar, Item_code)
      .input("Item_name", sql.NVarChar, Item_name)
      .input("bill_qty", sql.Decimal(10, 2), bill_qty)
      .input("Item_SNo", sql.BigInt, Item_SNo)
      .input("created_by", sql.NVarChar, created_by)
      .query(`EXEC sp_opening_item_details @mode,@transaction_no,@company_code,@transaction_date,@Item_code,@Item_name,@bill_qty,@Item_SNo,@created_by,'',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`)

    res.status(200).json("Data Inserted Successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const deleteOpeningItemDetail = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    await pool.request()
      .input("mode", sql.NVarChar, "D")
      .input("company_code", sql.NVarChar, company_code)
      .input("transaction_no", sql.NVarChar, transaction_no)
      .query(`EXEC sp_opening_item_details @mode,@transaction_no,@company_code,'','','',0,0,'',''
          ,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.status(200).json("Data Deleted Successfully");
  }
  catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const allOpeningItemDetail = async (req, res) => {
  const { company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "A")
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_opening_item_details @mode,'',@company_code,'','','',0,0,'',''
          ,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data Not Found");
    }
  }
  catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getallOpeningItem = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "OI")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_getdata @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    if (result.recordset && Array.isArray(result.recordset) && result.recordset.length > 0) {
      const data = {
        Header: result.recordsets[0],
        Details: result.recordsets[1]
      };
      res.status(200).json(data);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const openingItemSearch = async (req, res) => {
  const { company_code, transaction_date, transaction_no, Item_code, Item_name } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("company_code", sql.NVarChar, company_code)
      .input("transaction_date", sql.NVarChar, transaction_date)
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("Item_code", sql.NVarChar, Item_code)
      .input("Item_name", sql.NVarChar, Item_name)
      .query(`EXEC sp_opening_item_details @mode,@transaction_no,@company_code,@transaction_date,@Item_code,@Item_name,0,0,'',''
          ,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data Not Found");
    }
  }
  catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getallOpeningItemDetail = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "OID")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_getdata @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    if (result.recordset && Array.isArray(result.recordset) && result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


// code Added By madhu 14/12/24
const addAnnounmentdetails = async (req, res) => {
  const { Announcement_id, SelectType, SelectDetails, AnnouncementValidFor, Messagetype, MessageTitle, status, RequestfordoNotShowAgainOption,
    Start_Date, Start_Time, End_Date, End_Time, company_code, created_by, modified_by, tempstr1, tempstr2, tempstr3, tempstr4, datetime1, datetime2, datetime3, datetime4, } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("Announcement_id", sql.VarChar, Announcement_id)
      .input("SelectType", sql.VarChar, SelectType)
      .input("SelectDetails", sql.NVarChar, SelectDetails)
      .input("AnnouncementValidFor", sql.NVarChar, AnnouncementValidFor)
      .input("Messagetype", sql.NVarChar, Messagetype)
      .input("MessageTitle", sql.NVarChar, MessageTitle)
      .input("status", sql.NVarChar, status)
      .input("RequestfordoNotShowAgainOption", sql.NVarChar, RequestfordoNotShowAgainOption)
      .input("Start_Date", sql.Date, Start_Date)
      .input("Start_Time", sql.NVarChar, Start_Time)
      .input("End_Date", sql.Date, End_Date)
      .input("End_Time", sql.NVarChar, End_Time)
      .input("company_code", sql.NVarChar, company_code)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(`EXEC sp_Announcement @mode,@Announcement_id,@SelectType,@SelectDetails,@AnnouncementValidFor,@Messagetype,@messageTitle,@status,@RequestfordoNotShowAgainOption,@Start_Date,@Start_Time,
@End_Date,@End_Time,@company_code,@created_by,@modified_by,@tempstr1,@tempstr2,@tempstr3,@tempstr4,@datetime1,@datetime2,@datetime3,@datetime4`);
    res.status(200).json("Announcement details data inserted successfully");
  } catch (err) {
    console.error("Error inserting data:", err);

    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};

const allAnnouncementDetails = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`EXEC sp_Announcement 'A','','','','','','','','','','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);


    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const deleteAnnouncement = async (req, res) => {
  const editedData = req.body.editedData;


  if (!editedData || !editedData.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }


  try {
    const pool = await connection.connectToDatabase();
    for (const updatedRow of editedData) {
      await pool
        .request()
        .input("Announcement_id", sql.NVarChar, updatedRow.Announcement_id)
        .input("company_code", sql.NVarChar, req.headers['company_code'])
        .query(`EXEC sp_Announcement 'D',@Announcement_id,'','','',
        '','','','','','','','',@company_code,'','',NULL,NULL,NULL,
        NULL,NULL,NULL,NULL,NULL`);

    } res.status(200).json("Employee Announcement data deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};



const updateAnnouncementDetails = async (req, res) => {
  const editedData = req.body.editedData;

  if (!editedData || !editedData.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase();
    for (const updatedRow of editedData) {
      await pool
        .request()
        .input("mode", sql.NVarChar, "U") // Insert mode
        .input("Announcement_id", sql.NVarChar, updatedRow.Announcement_id)
        .input("SelectType", sql.VarChar, updatedRow.SelectType)
        .input("SelectDetails", sql.NVarChar, updatedRow.SelectDetails)
        .input("Messagetype", sql.VarChar, updatedRow.Messagetype)
        .input("MessageTitle", sql.NVarChar, updatedRow.MessageTitle)
        .input("status", sql.NVarChar, updatedRow.status)
        .input("company_code", sql.NVarChar, updatedRow.company_code)
        .input("modified_by", sql.NVarChar, updatedRow.modified_by)
        .query(`EXEC sp_Announcement @mode,@Announcement_id,@SelectType,@SelectDetails,'',@Messagetype,@messageTitle,@status,'','','',
        '','',@company_code,'',@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`)

    } res.status(200).json("Announcement data updated successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getAnnouncement = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'Annoucement','','', '' , '','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


// code Ended By madhu 14/12/24


//Code Added By Harish 16/12/2024
const EmployeePersonalSC = async (req, res) => {
  const { EmployeeId, DOB, First_Name, Status, Last_Name, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("EmployeeId", sql.NVarChar, EmployeeId)
      .input("First_Name", sql.NVarChar, First_Name)
      .input("Last_Name", sql.NVarChar, Last_Name)
      .input("Status", sql.NVarChar, Status)
      .input("company_code", sql.NVarChar, company_code)

      .input("DOB", sql.NVarChar, DOB)
      .query(`EXEC sp_employee_personal  @mode,@EmployeeId,@First_Name,'',@Last_Name,'','',@DOB,'','','','','','','','','','','','','','','','','',@company_code,@Status,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

// code Ended By Harish 16/12/24

//code added by mathu 16-12-2024
const getAnnouncementDetails = async (req, res) => {
  const { Id, company_code } = req.body;

  if (!Id) {
    return res.status(400).json("Id is required");
  }

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "ANC")
      .input("Id", sql.NVarChar, Id)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_employee_getdata @mode,@Id,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    // Check if the result contains any records
    if (result.recordset && Array.isArray(result.recordset) && result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getcompanyshift = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'ESS_SHIFT','','', '' , '','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//cod added by pavun  
const DashboardLeaveStatus = async (req, res) => {
  const { manager, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("manager", sql.NVarChar, manager)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_ess_admin_dashboard 'LS',@company_code,@manager,'','','','','','','','','',''`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const DashboardUpcomingBirthday = async (req, res) => {
  const { company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_ess_admin_dashboard 'UB',@company_code,'','','','','','','','','','',''`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const DashboardNewJoinee = async (req, res) => {
  const { company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_ess_admin_dashboard 'NJ',@company_code,'','','','','','','','','','',''`);

    res.json(result.recordset);
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const DashboardOverallAttendance = async (req, res) => {
  const { manager, company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("manager", sql.NVarChar, manager)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_ess_admin_dashboard 'OA',@company_code,@manager,'','','','','','','','','',''`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const DashboardTeamList = async (req, res) => {
  const { company_code, manager } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("manager", sql.NVarChar, manager)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_ess_admin_dashboard 'TL',@company_code,@manager,'','','','','','','','','',''`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const DashboardTeamListChart = async (req, res) => {
  const { company_code, manager } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("manager", sql.NVarChar, manager)

      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_ess_admin_dashboard 'TLC',@company_code,@manager,'','','','','','','','','',''`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const getTeamManager = async (req, res) => {
  const { company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_ess_admin_dashboard 'MD',@company_code,'','','','','','','','','','',''`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
const DashboardLeaveAuthorization = async (req, res) => {
  const { EmployeeId, LeaveStatus, FromDate } = req.body; // Removed FromDate
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "LA")
      .input("EmployeeId", sql.NVarChar, EmployeeId)
      .input("LeaveStatus", sql.NVarChar, LeaveStatus)
      .input("FromDate", sql.Date, FromDate)
      .query(`EXEC sp_employee_Leave @mode, @EmployeeId, '', @FromDate, '', '', '', '', @LeaveStatus, '','', '','', '','', null, null, null, null, null, null, null, null`);
    res.status(200).json("leave status updated successfully");
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};


const getEmpcompanyDetails = async (req, res) => {
  const { Id, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "ECD")
      .input("Id", sql.NVarChar, Id)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_employee_getdata @mode,@Id,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordsets && result.recordsets.length > 0 && result.recordsets[0].length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


// Code Added by Harish on 20/12/24

const Quotation = async (req, res) => {
  const { company_code, Product_Code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "PCQ")
      .input("company_code", sql.NVarChar, company_code)
      .input("Product_Code", sql.NVarChar, Product_Code)
      .query(`EXEC sp_Product_details @mode,@company_code,@Product_Code,'','','',0,0,0,'','',0,'','','','','','','','','','',''`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
const getItemCodeSalesDataQuote = async (req, res) => {
  const { company_code, Item_code } = req.body;
  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();
    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "STIICQ")
      .input("company_code", sql.NVarChar, company_code)
      .input("Item_code", sql.NVarChar, Item_code)
      .query(`EXEC sp_item_brand_info 'STIICQ',@company_code,@Item_code,'','',0,'','','',0,0,0,
                    0,'','','','','','','','','','','','','',0,0,'','','',NULL,NULL,NULL,NULL,NULL,NULL
              ,NULL,NULL`);
    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


// Code Added By Harish 23/12/24

const getotherpurtax = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC [sp_tax_name_hdr] 'OPT',@company_code,'','',0,'','','','','','','','',null,null,null,null,null,null,null,null"
      );
    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const getothersalestax = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC [sp_tax_name_hdr] 'OST',@company_code,'','',0,'','','','','','','','',null,null,null,null,null,null,null,null"
      );
    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getOverallTAX = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'tax type','','', '' , '','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//code added by pavun 23-12-2024
const getAcademicDetailsSearchCretria = async (req, res) => {
  const { EmployeeId, academicName, major, institution, Name, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("EmployeeId", sql.NVarChar, EmployeeId)
      .input("academicName", sql.NVarChar, academicName)
      .input("major", sql.NVarChar, major)
      .input("institution", sql.NVarChar, institution)
      .input("company_code", sql.NVarChar, company_code)
      .input("Name", sql.NVarChar, Name)
      .query(`EXEC sp_employee_academic_datails @mode,@EmployeeId,@academicName,@major,@institution,'','','',@company_code,@Name,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//code added by pavun 23-12-2024
const getIdentityDocuments = async (req, res) => {
  const { Id, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "EID")
      .input("Id", sql.VarChar, Id)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_employee_getdata @mode,@Id,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`); if (result.recordset.length > 0) {
        res.status(200).json(result.recordset);
      } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


//code Added by Harish 24/12/2024

const POTermsandConditions = async (req, res) => {
  const {
    transaction_no,
    company_code,
    Terms_conditions,
    created_by,
    modified_by,
    tempstr1,
    tempstr2,
    tempstr3,
    tempstr4,
    datetime1,
    datetime2,
    datetime3,
    datetime4,
  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.VarChar, company_code)
      .input("Terms_conditions", sql.VarChar, Terms_conditions)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(
        `EXEC sp_Terms_conditions_Purchaseorder @mode,@transaction_no,@company_code,@Terms_conditions,@created_by,'',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    res.status(200).json("PO Terms & Conditions Data Inserted successfully");
  } catch (err) {
    console.error("Error inserting data:", err);

    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};


const POTermsandConditionsDelete = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    await pool
      .request()
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)

      .query(`EXEC sp_Terms_conditions_Purchaseorder 'D',@transaction_no,@company_code,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    res.status(200).json("data deleted successfully");
  } catch (err) {
    console.error("Error inserting data:", err);

    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};


const getallPOTermsandConditions = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`EXEC sp_Terms_conditions_Purchaseorder 'A','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    res.json(result.recordset);
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const DCTermsandConditions = async (req, res) => {
  const {
    transaction_no,
    company_code,
    Terms_conditions,
    created_by,
    modified_by,
    tempstr1,
    tempstr2,
    tempstr3,
    tempstr4,
    datetime1,
    datetime2,
    datetime3,
    datetime4,
  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.VarChar, company_code)
      .input("Terms_conditions", sql.VarChar, Terms_conditions)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(
        `EXEC sp_Terms_conditions_DeliveryChallan @mode,@transaction_no,@company_code,@Terms_conditions,@created_by,'',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.status(200).json("Data Inserted successfully");
  } catch (err) {
    console.error("Error inserting data:", err);

    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};


const DCTermsandConditionsDelete = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    await pool
      .request()
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)

      .query(`EXEC sp_Terms_conditions_DeliveryChallan 'D',@transaction_no,@company_code,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    res.status(200).json(" data deleted successfully");
  } catch (err) {
    console.error("Error inserting data:", err);

    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};


const getallDCTermsandConditions = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`EXEC sp_Terms_conditions_DeliveryChallan 'A','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    res.json(result.recordset);
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const quoTermsandConditions = async (req, res) => {
  const {
    transaction_no,
    company_code,
    Terms_conditions,
    created_by,
    modified_by,
    tempstr1,
    tempstr2,
    tempstr3,
    tempstr4,
    datetime1,
    datetime2,
    datetime3,
    datetime4,
  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.VarChar, company_code)
      .input("Terms_conditions", sql.VarChar, Terms_conditions)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(
        `EXEC sp_Terms_conditions_Quotation @mode,@transaction_no,@company_code,@Terms_conditions,@created_by,'',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.status(200).json(" Data Inserted successfully");
  } catch (err) {
    console.error("Error inserting data:", err);

    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};


const QuoTermsandConditionsDelete = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    await pool
      .request()
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)

      .query(`EXEC sp_Terms_conditions_Quotation 'D',@transaction_no,@company_code,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    res.status(200).json(" data deleted successfully");
  } catch (err) {
    console.error("Error inserting data:", err);

    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};


const getallQuoTermsandConditions = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`EXEC sp_Terms_conditions_Quotation 'A','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    res.json(result.recordset);
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const TITermsandConditions = async (req, res) => {
  const {
    bill_no,
    company_code,
    Terms_conditions,
    invoice_type,
    created_by,
    modified_by,
    tempstr1,
    tempstr2,
    tempstr3,
    tempstr4,
    datetime1,
    datetime2,
    datetime3,
    datetime4,
  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("bill_no", sql.NVarChar, bill_no)
      .input("company_code", sql.VarChar, company_code)
      .input("Terms_conditions", sql.VarChar, Terms_conditions)
      .input("invoice_type", sql.NVarChar, invoice_type)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(
        `EXEC sp_Terms_conditions_TaxInvoice @mode,@bill_no,@company_code,@Terms_conditions,@invoice_type,@created_by,'',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.status(200).json(" Data Inserted successfully");
  } catch (err) {
    console.error("Error inserting data:", err);

    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};


const TITermsandConditionsDelete = async (req, res) => {
  const { bill_no, company_code, invoice_type } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    await pool
      .request()
      .input("bill_no", sql.NVarChar, bill_no)
      .input("company_code", sql.NVarChar, company_code)
      .input("invoice_type", sql.NVarChar, invoice_type)

      .query(`EXEC sp_Terms_conditions_TaxInvoice 'D',@bill_no,@company_code,'',@invoice_type,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    res.status(200).json(" data deleted successfully");
  } catch (err) {
    console.error("Error inserting data:", err);

    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};


const getallTITermsandConditions = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`EXEC sp_Terms_conditions_TaxInvoice 'A','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    res.json(result.recordset);
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const EmployeeCompanyISC = async (req, res) => {
  const { EmployeeId, Department, Designation, Name, manager, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "ISC")
      .input("EmployeeId", sql.NVarChar, EmployeeId)
      .input("department_Id", sql.NVarChar, Department)
      .input("designation_Id", sql.NVarChar, Designation)
      .input("manager", sql.NVarChar, manager)
      .input("Name", sql.NVarChar, Name)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC [sp_employee_company] @mode,@EmployeeId,@department_Id,@designation_Id,'','',@manager,'','','',@Name,@company_code,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
                `);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getItemCodeOtherSalesData = async (req, res) => {
  const { company_code, Item_code } = req.body;
  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();
    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "STIICO")
      .input("company_code", sql.NVarChar, company_code)
      .input("Item_code", sql.NVarChar, Item_code)
      .query(`EXEC sp_item_brand_info @mode,@company_code,@Item_code,'','',0,'','','',0,0,0,
      0,'','','','','','','','','','','','','',0,0,'','','',NULL,NULL,NULL,NULL,NULL,NULL
,NULL,NULL`);
    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};



const ProductCodeDetailOther = async (req, res) => {
  const { company_code, Product_Code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "PCO")
      .input("company_code", sql.NVarChar, company_code)
      .input("Product_Code", sql.NVarChar, Product_Code)
      .query(`EXEC sp_Product_details @mode,@company_code,@Product_Code,'','','',0,0,0,'','',0,'','','','','','','','','','',''`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
const getInvocieType = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'Invoice Type','','', '' ,'','', NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


//Code Added by Harish 25/12/24
const gettermsdc = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "TDC")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)

      // .input("status", sql.NVarChar, status)
      .query(`EXEC sp_getdata @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
const getQuotationTCDetailView = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "QTC")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)

      .query(`EXEC sp_getdata @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
const getPOTCDetailView = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "POTC")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_getdata @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getTITerms = async (req, res) => {
  const { transaction_no, company_code, invoice_type } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "TITC")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .input("tempstr1", sql.NVarChar, invoice_type)
      .query(`EXEC sp_getdata @mode,@transaction_no,@company_code,@tempstr1,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//Code Ended by Harish 25/12/24

//code added by pavun 25-12-2024
const getVendorDetails = async (req, res) => {
  const { company_code, vendor_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "PV")
      .input("company_code", sql.NVarChar, company_code)
      .input("vendor_code", sql.NVarChar, vendor_code)
      .query(`EXEC sp_vendor_details_info_hdr @mode,@vendor_code,@company_code,'','','','','','','','','','' ,'','','','','','','',0,'','','','','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


//CODE ADDED BY PAVUN 26-12-2024
const getIdentityDocumentSearchCretria = async (req, res) => {
  const { EmployeeId, documentType, documentNo, Name, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("EmployeeId", sql.NVarChar, EmployeeId)
      .input("documentType", sql.NVarChar, documentType)
      .input("documentNo", sql.NVarChar, documentNo)
      .input("company_code", sql.NVarChar, company_code)
      .input("Name", sql.NVarChar, Name)
      .query(`EXEC sp_employee_identity_document @mode,@EmployeeId,@documentType,@documentNo,'','','',@company_code,@Name,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getItemCodeSalesDatatest = async (req, res) => {
  const { company_code, code, sales_type } = req.body;
  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();
    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "STIIC")
      .input("company_code", sql.NVarChar, company_code)
      .input("code", sql.NVarChar, code)
      .input("sales_type", sql.NVarChar, sales_type)
      .query(`EXEC sp_tax_type_item_data @mode,@company_code,@sales_type,@code,'','','','','',''`);
    // Send response
    if (result.recordset && Array.isArray(result.recordset) && result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getCodeSalesDatatest = async (req, res) => {
  const { company_code, code, sales_type, filter } = req.body;
  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();
    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "STIC")
      .input("company_code", sql.NVarChar, company_code)
      .input("code", sql.NVarChar, code)
      .input("sales_type", sql.NVarChar, sales_type)
      .input("filter", sql.NVarChar, filter)
      .query(`EXEC sp_tax_type_item_data @mode,@company_code,@sales_type,@code,'','','','','',@filter`);
    // Send response
    if (result.recordset && Array.isArray(result.recordset) && result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const getcodetest = async (req, res) => {
  const { company_code, code, filter } = req.body;
  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();
    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "FC")
      .input("company_code", sql.NVarChar, company_code)
      .input("code", sql.NVarChar, code)
      .input("filter", sql.NVarChar, filter)
      .query(`EXEC sp_tax_type_item_data @mode,@company_code,'',@code,'','','','','',@filter`);
    // Send response
    if (result.recordset && Array.isArray(result.recordset) && result.recordset.length > 0) {
      res.status(200).json(result.recordset);  // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};



const getitemsalsearchdatatest = async (req, res) => {
  const { company_code, sales_type, Item_code, Item_name, Item_variant, Item_short_name, Item_Our_Brand, status } = req.body;
  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();
    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "STI")
      .input("company_code", sql.NVarChar, company_code)
      .input("sales_type", sql.NVarChar, sales_type)
      .input("code", sql.NVarChar, Item_code)
      .input("name", sql.NVarChar, Item_name)
      .input("variant", sql.NVarChar, Item_variant)
      .input("short_name", sql.NVarChar, Item_short_name)
      .input("Our_Brand", sql.NVarChar, Item_Our_Brand)
      .input("status", sql.NVarChar, status)
      .query(`EXEC sp_tax_type_item_data @mode,@company_code,@sales_type,@code,@name,@variant,@short_name,@Our_Brand,@status,''`);
    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


// Code added by harish 27/12/2024
const TermsDC = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'TermsConditionDC','','', '' , '','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const TermsQO = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'TermsConditionQO','','', '' , '','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const TermsPO = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'TermsConditionsPO','','', '' , '','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const TermsTI = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'TermsConditionTI','','', '' , '','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};



//CODE ADDED BY PAVUN 27-12-2024
const getFinancialDetailsSearchCretria = async (req, res) => {
  const { EmployeeId, Name, salaryType, Payscale, salary_month, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("EmployeeId", sql.NVarChar, EmployeeId)
      .input("Name", sql.NVarChar, Name)
      .input("salaryType", sql.NVarChar, salaryType)
      .input("Payscale", sql.NVarChar, Payscale)
      .input("salary_month", sql.Decimal(14, 2), salary_month)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_salary_details @mode,@EmployeeId,@Name,@salaryType,@Payscale,'',@salary_month,'',@company_code,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getFamilyDetailsSearchCretria = async (req, res) => {
  const { EmployeeId, Relation, Name, EmployeeName, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("EmployeeId", sql.NVarChar, EmployeeId)
      .input("Relation", sql.NVarChar, Relation)
      .input("Name", sql.NVarChar, Name)
      .input("company_code", sql.NVarChar, company_code)
      .input("EmployeeName", sql.NVarChar, EmployeeName)
      .query(`EXEC sp_employee_family @mode,@EmployeeId,@Relation,@Name,@EmployeeName,'',0,'','',@company_code,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//code ended by pavun



const getEmpBankDetailsSC = async (req, res) => {
  const { EmployeeId, Account_NO, AccountHolderName, bankName, Name, company_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "ESC")
      .input("EmployeeId", sql.NVarChar, EmployeeId)
      .input("Account_NO", sql.NVarChar, Account_NO)
      .input("AccountHolderName", sql.NVarChar, AccountHolderName)
      .input("bankName", sql.NVarChar, bankName)
      .input("company_code", sql.NVarChar, company_code)
      .input("Name", sql.NVarChar, Name)
      .query(`EXEC sp_employee_bankdetails @mode,@Account_NO,@EmployeeId,'',@Name,@AccountHolderName,@bankName,'','','',@company_code,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).send("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error(err);
    res.status(500).send({ message: err.message || 'Internal Server Error' });
  }
};

//Code Added By Harish 30_12_24

const getESSmanager = async (req, res) => {
  const { company_code } = req.body;
  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();
    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "CEO")
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_employee_company @mode,'','','','','','','','','','',@company_code,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    // Send response
    if (result.recordset && Array.isArray(result.recordset) && result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
const getLeaveType = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'LeaveType','','', '' , '','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getSelectSlot = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'Select_Slot','','', '' , '','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getGstReportAnalysis = async (req, res) => {
  const { Mode, Party, StartDate, EndDate, company_code } = req.body;
  let pool;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("Mode", sql.NVarChar, Mode) // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("Party", sql.NVarChar, Party)
      .input("StartDate", sql.Date, StartDate)
      .input("EndDate", sql.Date, EndDate)
      .query(`EXEC sp_gst_report @Mode,@company_code,@Party,@StartDate,@EndDate,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    }
    else res.status(404).json({ message: "Data not found" })
  } catch (err) {
    console.error("Error", err.message);
    return res.status(500).json({ message: err.message || 'Internal Server Error' });

  }
};

const getDashBoardType = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'DB Type','','', '' , '','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getGST = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'GST','','', '','','', NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error during update:", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getPartyName = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'PartyName','','', '','','', NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error during update:", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getGSTReport = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'GF',@company_code,'GSTReport','','', '','','', NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error during update:", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const getDeletedDeliveryChallan = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "DD")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_getdata @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    if (result.recordsets && result.recordsets.length > 0 && result.recordsets[0].length > 0) {
      const data = {
        Header: result.recordsets[0],
        Detail: result.recordsets[1] || [],
        Terms: result.recordsets[2] || [],
      };
      res.status(200).json(data);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};


const getDeletedDcSearchData = async (req, res) => {
  const { company_code, transaction_no, transaction_date, customer_name, ShipTo_customer_name } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "DSC")
      .input("company_code", sql.NVarChar, company_code)
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("transaction_date", sql.NVarChar, transaction_date)
      .input("customer_name", sql.NVarChar, customer_name)
      .input("ShipTo_customer_name", sql.NVarChar, ShipTo_customer_name)
      .query(`EXEC sp_delivery_challan_hdr @mode,@company_code,@transaction_no,@transaction_date,0,'','',@customer_name,'','',
               '','','','','','','',@ShipTo_customer_name,'','','','','','','','','',0,0,0,0,0,0,0,'','','','',0,'','','','','','','','','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getDeletedDcDetailView = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "DDCD")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_getdata @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getDeletedDcTerms = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "DTDC")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_getdata @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getDeletedPurchaseOrder = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "DPO")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_getdata @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    if (result.recordsets && result.recordsets.length > 0 && result.recordsets[0].length > 0) {
      const data = {
        Header: result.recordsets[0],
        Detail: result.recordsets[1] || [],
        TaxDetail: result.recordsets[2] || [],
        Terms: result.recordsets[3] || []
      };
      res.status(200).json(data);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const getDeletedPoDetail = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "DPOD")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_getdata @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const getDeletedPoTaxDetail = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "DPOT")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_getdata @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const getDeletedPoTerms = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "DPOTC")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_getdata @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getDeletedPoSearchData = async (req, res) => {
  const { transaction_no, company_code, Entry_date, vendor_name, ShipTo_customer_name } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "DSC")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .input("Entry_date", sql.NVarChar, Entry_date)
      .input("vendor_name", sql.NVarChar, vendor_name)
      .input("ShipTo_customer_name", sql.NVarChar, ShipTo_customer_name)
      .query(`EXEC sp_purchase_order_details @mode,@company_code,@Entry_date,@transaction_no,'',@vendor_name,'','','','',@ShipTo_customer_name,'',
'', '','',0,'','',0,0,0,0,0,0,'','','','','','','','','','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getDeletedQuotation = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "DQ")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_getdata @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    if (result.recordsets && result.recordsets.length > 0 && result.recordsets[0].length > 0) {
      const data = {
        Header: result.recordsets[0],
        Detail: result.recordsets[1] || [],
        TaxDetail: result.recordsets[2] || [],
        Terms: result.recordsets[3] || []

      };
      res.status(200).json(data);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const getDeletedQuotationTaxDetailView = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "DQT")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_getdata @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getDeletedQuotationDetailView = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "DQD")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_getdata @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getDeletedQuotationTerms = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "DQTC")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_getdata @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getDeletedQuotationSearchData = async (req, res) => {
  const { company_code, transaction_no, Entry_date, customer_name, contact_person } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "DSC")
      .input("company_code", sql.NVarChar, company_code)
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("Entry_date", sql.NVarChar, Entry_date)
      .input("customer_name", sql.NVarChar, customer_name)
      .input("contact_person", sql.NVarChar, contact_person)
      .query(`EXEC sp_quotation_hdr @mode,@company_code,@customer_name,'','','','','','','',@contact_person,@Entry_date,@transaction_no,'',0,0,0,0,0,0,0,0,0,'','','','','', NULL, NULL, NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getDeletedTaxInvoiceSearchData = async (req, res) => {
  const { company_code, bill_no, bill_date, sales_type, billTo_customer_name, shipTo_customer_name, pay_type, invoice_type } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "DSC")
      .input("bill_no", sql.NVarChar, bill_no)
      .input("bill_date", sql.NVarChar, bill_date)
      .input("sales_type", sql.NVarChar, sales_type)
      .input("pay_type", sql.NVarChar, pay_type)
      .input("billTo_customer_name", sql.NVarChar, billTo_customer_name)
      .input("shipTo_customer_name", sql.NVarChar, shipTo_customer_name)
      .input("company_code", sql.NVarChar, company_code)
      .input("invoice_type", sql.NVarChar, invoice_type)
      .query(`EXEC sp_taxInvoice_Header @mode,@company_code,@bill_date,@bill_no,'','',@sales_type,'',0,0,0,0,0,0,0,0,0,0,0,0,0,0,@pay_type,'','','','','','','','','','',0,@billTo_customer_name,'','','','','','','','',@shipTo_customer_name,'','','','','','','','','','','',0,'',0,@invoice_type,'','','','','','','','','','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getDeletedTaxInvoice = async (req, res) => {
  const { transaction_no, company_code, tempstr1 } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "DTI")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .query(`EXEC sp_getdata @mode,@transaction_no,@company_code,@tempstr1,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    if (result.recordsets && result.recordsets.length > 0 && result.recordsets[0].length > 0) {
      const data = {
        Header: result.recordsets[0],
        Detail: result.recordsets[1] || [],
        TaxDetail: result.recordsets[2] || [],
        Terms: result.recordsets[3] || []
      };
      res.status(200).json(data);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const getDeletedTaxInvoiceTax = async (req, res) => {
  const { transaction_no, invoice_type, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "DTIT")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("tempstr1", sql.NVarChar, invoice_type)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_getdata @mode,@transaction_no,@company_code,@tempstr1,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getDeletedTaxinvoiceDetail = async (req, res) => {
  const { transaction_no, invoice_type, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "DTTD")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("tempstr1", sql.NVarChar, invoice_type)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_getdata @mode,@transaction_no,@company_code,@tempstr1,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getDeletedTaxIvoiceTerms = async (req, res) => {
  const { transaction_no, company_code, invoice_type } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "DTITC")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .input("tempstr1", sql.NVarChar, invoice_type)
      .query(`EXEC sp_getdata @mode,@transaction_no,@company_code,@tempstr1,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getItemCode = async (req, res) => {
  const { company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "OI")
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC [sp_item_brand_info] @mode,@company_code,'','','',0,'','','',0,0,0,0,'','','','','','','','','','','','','',0,0,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getOpeningItemPeriod = async (req, res) => {
  const { company_code, Item_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "OIA")
      .input("company_code", sql.NVarChar, company_code)
      .input("Item_code", sql.NVarChar, Item_code)
      .query(`EXEC sp_opening_item_details @mode,'',@company_code,'',@Item_code,'',0,0,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data Not Found");
    }
  }
  catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getType = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'Type','','', '' , '','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getAccrual = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'AccrualType','','', '' , '','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};





const getExceedLeave = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'Exceed_Leave','','', '' , '','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const getLeaveReason = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'Leave_Reason','','', '' , '','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getDateWiseItemStock = async (req, res) => {
  const { item_code, month, company_code, item_variant } = req.body;
  let pool;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("item_code", sql.NVarChar, item_code) // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("month", sql.NVarChar, month)
      .input("item_variant", sql.NVarChar, item_variant)
      .query(`EXEC sp_datewise_item_stock @company_code,@month,@item_code,@item_variant`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    }
    else res.status(404).json({ message: "Data not found" })
  } catch (err) {
    console.error("Error", err.message);
    return res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

// Code Added by Harish on 10/01/25

const EmployeeDashboardNewJoinee = async (req, res) => {
  const { company_code } = req.body;
  let pool;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_ess_Employee_dashboard 'NJ','',@company_code`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};
const EmployeeDashboardUpcomingBirthday = async (req, res) => {
  const { company_code } = req.body;
  let pool;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_ess_Employee_dashboard 'UB','',@company_code`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const EmployeeDashboardTotalLeave = async (req, res) => {
  const { EmployeeId, company_code } = req.body;
  let pool;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("EmployeeId", sql.NVarChar, EmployeeId)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_ess_Employee_dashboard 'TL',@EmployeeId,@company_code`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};


const DailyattendanceandTime = async (req, res) => {
  const { EmployeeId, company_code, start_date, end_date } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "CL") // Insert mode
      .input("EmployeeId", sql.VarChar, EmployeeId)
      .input("start_date", sql.NVarChar, start_date)
      .input("end_date", sql.NVarChar, end_date)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_daily_attendance 'CL',@EmployeeId,'','','','','',@start_date,@end_date,@company_code,'','',null,null,null,null,null,null,null,null
`);
    if (result.recordsets && result.recordsets.length > 0 && result.recordsets[0].length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};



// Code Ended by Harish on 10/01/25

const addEmployeeHoliday = async (req, res) => {
  const { HolidayDate, Description, company_code, created_by, modified_by, tempstr1, tempstr2, tempstr3, tempstr4, datetime1, datetime2, datetime3, datetime4, } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("HolidayDate", sql.Date, HolidayDate)
      .input("Description", sql.NVarChar, Description)
      .input("company_code", sql.NVarChar, company_code)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(`EXEC sp_Holidays
@mode,@HolidayDate,@Description,'','',@company_code,@created_by,@modified_by,@tempstr1,@tempstr2,@tempstr3,@tempstr4,@datetime1,@datetime2,@datetime3,@datetime4`);
    res.status(200).json("Employee details data inserted successfully");
  } catch (err) {
    console.error("Error inserting data:", err);

    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};

const allEmployeeHoliday = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`EXEC sp_Holidays 'A','','','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);


    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const updateEmployeeHoliday = async (req, res) => {
  const editedData = req.body.editedData;
  if (!editedData || !editedData.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }
  try {
    const pool = await connection.connectToDatabase(dbConfig);
    for (const updatedRow of editedData) {
      await pool
        .request()
        .input("mode", sql.NVarChar, "U") // Insert mode
        .input("HolidayDate", sql.Date, updatedRow.HolidayDate)
        .input("Description", sql.NVarChar, updatedRow.Description)
        .input("company_code", sql.NVarChar, updatedRow.company_code)
        .input("modified_by", sql.NVarChar, updatedRow.modified_by)
        .query(`EXEC sp_Holidays @mode,@HolidayDate,@Description,'','',@company_code,'',@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    }

    res.status(200).json("Employeedata updated successfully");
  } catch (err) {
    console.error("Error inserting data:", err);

    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};

const getCustomerCodeDrop = async (req, res) => {
  const { company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "CD")
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_customer_info_hdr @mode,@company_code,'','','','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data Not Found");
    }
  }
  catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const getPendingCustomer = async (req, res) => {
  const { company_code, customer_code, bill_date, type } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "PC")
      .input("company_code", sql.NVarChar, company_code)
      .input("customer_code", sql.NVarChar, customer_code)
      .input("bill_date", sql.NVarChar, bill_date)
      .input("type", sql.NVarChar, type)
      .query(`EXEC sp_pending_customer @mode,@company_code,@customer_code,'','',@bill_date,0,0,0,'','','',@type,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data Not Found");
    }
  }
  catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

// Code Added by Harish 11/01/25

const getsearchLeavetypes = async (req, res) => {

  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "A")
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_LeaveTypes 'A',@company_code,'','','','','',0,0,'','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
`);

    res.json(result.recordset);
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const getLeaveTypeSearch = async (req, res) => {
  const { company_code, LeaveId, code, Type, Accrual, Exceed_Leave } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.VarChar, "SCL")
      .input("company_code", sql.VarChar, company_code)
      .input("LeaveId", sql.VarChar, LeaveId)
      .input("code", sql.VarChar, code)
      .input("Type", sql.VarChar, Type)
      .input("Accrual", sql.NVarChar, Accrual)
      .input("Exceed_Leave", sql.VarChar, Exceed_Leave)

      .query(`EXEC sp_LeaveTypes @mode,@company_code,@LeaveId,'',@code,@Type,@Accrual,0,0,@Exceed_Leave,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

// Code Ended by Harish 11/01/25


//code added by pavun 10/01/25
const getPendingStatus = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'PendingStatus','','', '' ,'','', NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//code ended by pavun

//code added by pavun 11/01/25
const updatePendingCustomer = async (req, res) => {
  const editedData = req.body.editedData;

  if (!editedData || !editedData.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase(dbConfig);
    for (const updatedRow of editedData) {
      await pool
        .request()
        .input("mode", sql.NVarChar, "U")
        .input("company_code", sql.NVarChar, req.headers['company_code'])
        .input("keyfield", sql.NVarChar, updatedRow.keyfield)
        .input("paid_amt", sql.Decimal(14, 2), updatedRow.receivedAmount)
        .query(`EXEC sp_pending_customer @mode,@company_code,'','','','',0,@paid_amt,
        0,'','',@keyfield,'','','','','','','','','','',''`);
    }
    res.status(200).json("data updated successfully");
  } catch (err) {
    console.error("Error inserting data:", err);
    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};
//code ended by pavun

//code added by mathu

const getsearchHoliday = async (req, res) => {
  const { startdate, enddate, Description, company_code } = req.body;
  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();
    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("startdate", sql.NVarChar, startdate)
      .input("enddate", sql.NVarChar, enddate)
      .input("Description", sql.NVarChar, Description)
      .input("company_code", sql.NVarChar, company_code)

      .query(`EXEC sp_Holidays @mode,'',@Description,@startdate,@enddate,@company_code,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//End by mathu
//Code added By AK on 2025-01-13 CODE START
const AddBonusDetails = async (req, res) => {
  const { company_code, GradeID, Annual_bonus, Referral_bonus, Retention_bonus, Holiday_bonus, Performance_bonus,
    Discretionary_bonus, Start_Year, End_Year, created_by } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I")
      .input("company_code", sql.NVarChar, company_code)
      .input("GradeID", sql.NVarChar, GradeID)
      .input("Annual_bonus", sql.Decimal(14, 2), Annual_bonus)
      .input("Referral_bonus", sql.Decimal(14, 2), Referral_bonus)
      .input("Retention_bonus", sql.Decimal(14, 2), Retention_bonus)
      .input("Holiday_bonus", sql.Decimal(14, 2), Holiday_bonus)
      .input("Performance_bonus", sql.Decimal(14, 2), Performance_bonus)
      .input("Discretionary_bonus", sql.Decimal(14, 2), Discretionary_bonus)
      .input("Start_Year", sql.Date, Start_Year)
      .input("End_Year", sql.Date, End_Year)
      .input("created_by", sql.NVarChar, created_by)
      .query(`EXEC sp_bonus @mode,@company_code,@GradeID,@Annual_bonus,@Referral_bonus,@Retention_bonus,@Holiday_bonus,@Performance_bonus,@Discretionary_bonus,@Start_Year,@End_Year,'',@created_by,'',NULL,NULL,  NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.rowsAffected && result.rowsAffected[0] > 0) {
      return res.status(200).json({ success: true, message: 'Data inserted successfully' });
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const DelBonusDetails = async (req, res) => {
  const editedData = req.body.editedData;

  if (!editedData || !editedData.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase();
    for (const updatedRow of editedData) {
      await pool
        .request()
        .input("mode", sql.NVarChar, "D")
        .input("company_code", sql.NVarChar, req.headers['company_code'])
        .input("keyfield", sql.NVarChar, updatedRow.keyfield)
        .query(`EXEC sp_bonus @mode,@company_code,'',0,0,0,0,0,0,'','',@keyfield,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    }
    res.status(200).json("Data Deleted Successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const UpdBonusDetails = async (req, res) => {
  const editedData = req.body.editedData;

  if (!editedData || !editedData.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase();
    for (const updatedRow of editedData) {
      await pool
        .request()
        .input("mode", sql.NVarChar, "U")
        .input("company_code", sql.NVarChar, req.headers['company_code'])
        .input("GradeID", sql.NVarChar, updatedRow.GradeID)
        .input("Annual_bonus", sql.Decimal(14, 2), updatedRow.Annual_bonus)
        .input("Referral_bonus", sql.Decimal(14, 2), updatedRow.Referral_bonus)
        .input("Retention_bonus", sql.Decimal(14, 2), updatedRow.Retention_bonus)
        .input("Holiday_bonus", sql.Decimal(14, 2), updatedRow.Holiday_bonus)
        .input("Performance_bonus", sql.Decimal(14, 2), updatedRow.Performance_bonus)
        .input("Discretionary_bonus", sql.Decimal(14, 2), updatedRow.Discretionary_bonus)
        .input("keyfield", sql.NVarChar, updatedRow.keyfield)
        .input("modified_by", sql.NVarChar, req.headers['modified-by'])
        .query(`EXEC sp_bonus @mode,@company_code,@GradeID,@Annual_bonus,@Referral_bonus,@Retention_bonus,@Holiday_bonus,@Performance_bonus,@Discretionary_bonus,'','',@keyfield,'',@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    }
    res.status(200).json("Data Updated Successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const GetBonusDetails = async (req, res) => {
  const { company_code } = req.body;
  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();
    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "A")
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_bonus @mode,@company_code,'',0,0,0,0,0,0,'','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data Not Found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//Code added By AK on 2025-01-13 CODE ENDS

// 13-01-2025 -mathu
const addTDS = async (req, res) => {
  const {
    company_code,
    Employee_Salary,
    Taxable_Amount,
    Start_Year,
    End_Year,
    created_by,
    modified_by,
    tempstr1,
    tempstr2,
    tempstr3,
    tempstr4,
    datetime1,
    datetime2,
    datetime3,
    datetime4
  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.VarChar, company_code)
      .input("Employee_Salary", sql.Decimal(10, 2), Employee_Salary)
      .input("Taxable_Amount", sql.Decimal(10, 2), Taxable_Amount)
      .input("Start_Year", sql.Date, Start_Year)
      .input("End_Year", sql.Date, End_Year)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(`EXEC sp_TDS @mode,@company_code,@Employee_Salary,@Taxable_Amount,@Start_Year,@End_Year,'',@created_by,'',null,null,null,null,null,null,null,null`);
    res.json({ message: "Data inserted successfully" });
  }
  catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const updateTDS = async (req, res) => {
  const editedData = req.body.editedData;

  if (!editedData || !editedData.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }
  try {

    let pool = await sql.connect(dbConfig);
    for (const updatedRow of editedData) {
      await pool
        .request()
        .input("mode", sql.NVarChar, "U")
        .input("company_code", sql.NVarChar, req.headers['company_code'])
        .input("Employee_Salary", sql.Decimal(10, 2), updatedRow.Employee_Salary)
        .input("Taxable_Amount", sql.Decimal(10, 2), updatedRow.Taxable_Amount)
        .input("Start_Year", sql.Date, updatedRow.Start_Year)
        .input("End_Year", sql.Date, updatedRow.End_Year)
        .input("keyfield", sql.NVarChar, updatedRow.keyfield)
        .input("modified_by", sql.NVarChar, req.headers['modified-by'])

        .query(`EXEC sp_TDS @mode,@company_code,@Employee_Salary,@Taxable_Amount,@Start_Year,@End_Year,@keyfield,'',@modified_by,null,null,null,null,null,null,null,null`);
    }
    res.status(200).json("Data Updated Successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
const deleteTDS = async (req, res) => {
  const deletedData = req.body.deletedData;

  if (!deletedData || !deletedData.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }
  try {
    const pool = await connection.connectToDatabase(dbConfig);
    for (const delrow of deletedData) {
      await pool
        .request()
        .input("mode", sql.NVarChar, "D")
        .input("company_code", sql.NVarChar, req.headers['company_code'])
        .input("keyfield", sql.NVarChar, delrow.keyfield)
        .query(`EXEC sp_TDS @mode,@company_code,0,0,'','',@keyfield,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    }
    res.status(200).json("Data deleted Successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const SearchTDS = async (req, res) => {
  const { company_code, Employee_Salarys, Taxable_Amounts, Start_Years, End_Years } = req.body;
  try {
    const pool = await connection.connectToDatabase(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("company_code", sql.VarChar, company_code)
      .input("Employee_Salary", sql.Decimal(10, 2), Employee_Salarys)
      .input("Taxable_Amount", sql.Decimal(10, 2), Taxable_Amounts)
      .input("Start_Year", sql.VarChar, Start_Years)
      .input("End_Year", sql.VarChar, End_Years)
      .query(`EXEC sp_TDS @mode,@company_code,@Employee_Salary,@Taxable_Amount,@Start_Year,@End_Year,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};

const allTDS = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`EXEC sp_TDS 'A','',0,0,'','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const addOtherAllowence = async (req, res) => {
  const {
    House_rent_Allowance,
    Medical_allowance,
    Overtime_allowance,
    Conveyance_allowance,
    Mobile_reimbursement,
    Meal_allowance,
    Education_Allowance,
    company_code,
    Start_Year,
    End_Year,
    created_by,
    modified_by,
    tempstr1,
    tempstr2,
    tempstr3,
    tempstr4,
    datetime1,
    datetime2,
    datetime3,
    datetime4
  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("House_rent_Allowance", sql.Decimal(10, 2), House_rent_Allowance)
      .input("Medical_allowance", sql.Decimal(10, 2), Medical_allowance)
      .input("Overtime_allowance", sql.Decimal(10, 2), Overtime_allowance)
      .input("Conveyance_allowance", sql.Decimal(10, 2), Conveyance_allowance)
      .input("Mobile_reimbursement", sql.Decimal(10, 2), Mobile_reimbursement)
      .input("Meal_allowance", sql.Decimal(10, 2), Meal_allowance)
      .input("Education_Allowance", sql.Decimal(10, 2), Education_Allowance)
      .input("company_code", sql.NVarChar, company_code)
      .input("Start_Year", sql.NVarChar, Start_Year)
      .input("End_Year", sql.NVarChar, End_Year)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(`EXEC sp_Other_Allowance @mode,@House_rent_Allowance,@Medical_allowance,@Overtime_allowance,@Conveyance_allowance,
        @Mobile_reimbursement,@Meal_allowance,@Education_Allowance,@company_code,@Start_Year,@End_Year,'',@created_by,'',null,null,null,null,null,null,null,null`);
    res.status(200).json("Employee pf details data inserted successfully");
  } catch (err) {
    console.error("Error inserting data:", err);
    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};

const updateOtherAllowence = async (req, res) => {
  const editedData = req.body.editedData;

  if (!editedData || !editedData.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }

  console.log(editedData)
  try {
    const pool = await connection.connectToDatabase();
    for (const updatedRow of editedData) {
      await pool
        .request()
        .input("mode", sql.NVarChar, "U")
        .input("House_rent_Allowance", sql.Decimal(10, 2), updatedRow.House_rent_Allowance)
        .input("Medical_allowance", sql.Decimal(10, 2), updatedRow.Medical_allowance)
        .input("Overtime_allowance", sql.Decimal(10, 2), updatedRow.Overtime_allowance)
        .input("Conveyance_allowance", sql.Decimal(10, 2), updatedRow.Conveyance_allowance)
        .input("Mobile_reimbursement", sql.Decimal(10, 2), updatedRow.Mobile_reimbursement)
        .input("Meal_allowance", sql.Decimal(10, 2), updatedRow.Meal_allowance)
        .input("Education_Allowance", sql.Decimal(10, 2), updatedRow.Education_Allowance)
        .input("company_code", sql.NVarChar, req.headers['company_code'])
        .input("Start_Year", sql.Date, updatedRow.Start_Year)
        .input("End_Year", sql.Date, updatedRow.End_Year)
        .input("keyfield", sql.NVarChar, updatedRow.keyfield)
        .input("modified_by", sql.NVarChar, req.headers['modified-by'])
        .query(`EXEC sp_Other_Allowance @mode,@House_rent_Allowance,@Medical_allowance,@Overtime_allowance,@Conveyance_allowance,
          @Mobile_reimbursement,@Meal_allowance,@Education_Allowance,@company_code,@Start_Year,@End_Year,@keyfield,'','',null,null,null,null,null,null,null,null`);
    }
    res.status(200).json("Data Updated Successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const deleteOtherAllowence = async (req, res) => {
  const editedData = req.body.deletedData;

  if (!editedData || !editedData.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase();
    for (const updatedRow of editedData) {
      await pool
        .request()
        .input("mode", sql.NVarChar, "D")
        .input("company_code", sql.NVarChar, req.headers['company_code'])
        .input("keyfield", sql.NVarChar, updatedRow.keyfield)
        .query(`EXEC sp_Other_Allowance @mode,0,0,0,0,0,0,0,@company_code,'','',@keyfield,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
      res.status(200).json("data deleted successfully");
    }
    res.status(200).json("Data Deleted Successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const allOtherAllowence = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`EXEC sp_Other_Allowance 'A',0,0,0,0,0,0,0,'','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//Professional Tax:
const allProfessionalTax = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`EXEC sp_Professional_Tax 'A','',0,0,0,'','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
const addProfessionalTax = async (req, res) => {
  const {
    company_code,
    Employee_Salary_From,
    Employee_Salary_To,
    Taxable_Amount,
    Start_Year,
    End_Year,
    created_by,
    modified_by,
    tempstr1,
    tempstr2,
    tempstr3,
    tempstr4,
    datetime1,
    datetime2,
    datetime3,
    datetime4
  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("Employee_Salary_From", sql.Decimal(10, 2), Employee_Salary_From)
      .input("Employee_Salary_To", sql.Decimal(10, 2), Employee_Salary_To)
      .input("Taxable_Amount", sql.Decimal(10, 2), Taxable_Amount)
      .input("Start_Year", sql.Date, Start_Year)
      .input("End_Year", sql.Date, End_Year)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(`EXEC sp_Professional_Tax @mode,@company_code,@Employee_Salary_From,@Employee_Salary_To,@Taxable_Amount,@Start_Year,@End_Year,'',@created_by,'',null,null,null,null,null,null,null,null`);
    res.status(200).json("Professional Tax inserted successfully");
  } catch (err) {
    console.error("Error inserting data:", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });

  }
};
const updateProfessionalTax = async (req, res) => {
  const editedData = req.body.editedData;
  if (!editedData || !editedData.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }
  try {
    const pool = await connection.connectToDatabase();
    for (const updatedRow of editedData) {
      await pool
        .request()
        .input("mode", sql.NVarChar, "U")
        .input("company_code", sql.VarChar, req.headers['company_code'])
        .input("Taxable_Amount", sql.Decimal(10, 2), updatedRow.Taxable_Amount)
        .input("Keyfield", sql.NVarChar, updatedRow.Keyfield)
        .input("modified_by", sql.NVarChar, req.headers['modified-by'])

        .query(`EXEC sp_Professional_Tax @mode,@company_code,0,0,@Taxable_Amount,'','',@Keyfield,'',@modified_by,null,null,null,null,null,null,null,null`);
    }
    res.status(200).json("Data Updated Successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
const deleteProfessionalTax = async (req, res) => {
  const editedData = req.body.editedData;
  if (!editedData || !editedData.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }
  try {
    const pool = await connection.connectToDatabase();
    for (const updatedRow of editedData) {
      await pool
        .request()
        .input("mode", sql.NVarChar, "D")
        .input("company_code", sql.NVarChar, req.headers['company_code'])
        .input("Keyfield", sql.NVarChar, updatedRow.Keyfield)
        .query(`EXEC sp_Professional_Tax @mode,@company_code,0,0,0,'','',@Keyfield,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    }
    res.status(200).json("Data Deleted Successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const addLoanType = async (req, res) => {
  const {
    company_code,
    Loan_ID,
    Loan_Eligible_Amount,
    Start_Year,
    End_Year,
    keyfield,
    Created_by,
    Modified_by,
    tempstr1,
    tempstr2,
    tempstr3,
    tempstr4,
    datetime1,
    datetime2,
    datetime3,
    datetime4
  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("Loan_ID", sql.VarChar, Loan_ID)
      .input("Loan_Eligible_Amount", sql.Decimal(10, 2), Loan_Eligible_Amount)
      .input("Start_Year", sql.Date, Start_Year)
      .input("End_Year", sql.Date, End_Year)
      .input("keyfield", sql.VarChar, keyfield)
      .input("Created_by", sql.NVarChar, Created_by)
      .input("Modified_by", sql.NVarChar, Modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(`EXEC sp_Loan_Type @mode,@company_code,@Loan_ID,@Loan_Eligible_Amount,@Start_Year,@End_Year,'',@Created_by,@Modified_by,
            @tempstr1,@tempstr2,@tempstr3,@tempstr4,@datetime1,@datetime2,@datetime3,@datetime4`);
    res.status(200).json("Employee Loan details data inserted successfully");
  } catch (err) {
    console.error("Error inserting data:", err);
    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};

const updateLoanType = async (req, res) => {
  const editedData = req.body.editedData;

  if (!editedData || !editedData.length) {
    return res.status(400).json("Invalid or empty editedData array.");
  }

  try {
    const pool = await connection.connectToDatabase();

    for (const updatedRow of editedData) {
      await pool
        .request()
        .input("mode", sql.NVarChar, "U")
        .input("company_code", sql.NVarChar, req.headers['company_code'])
        .input("Loan_ID", sql.VarChar, updatedRow.Loan_ID)
        .input("Loan_Eligible_Amount", sql.Decimal(10, 2), updatedRow.Loan_Eligible_Amount)
        .input("Start_Year", sql.Date, updatedRow.Start_Year)
        .input("End_Year", sql.Date, updatedRow.End_Year)
        .input("keyfield", sql.VarChar, updatedRow.keyfield)
        .input("Modified_by", sql.NVarChar, updatedRow.Modified_by)
        .input("tempstr1", sql.NVarChar, updatedRow.tempstr1)
        .input("tempstr2", sql.NVarChar, updatedRow.tempstr2)
        .input("tempstr3", sql.NVarChar, updatedRow.tempstr3)
        .input("tempstr4", sql.NVarChar, updatedRow.tempstr4)
        .input("datetime1", sql.NVarChar, updatedRow.datetime1)
        .input("datetime2", sql.NVarChar, updatedRow.datetime2)
        .input("datetime3", sql.NVarChar, updatedRow.datetime3)
        .input("datetime4", sql.NVarChar, updatedRow.datetime4)
        .query(`
                EXEC sp_Loan_Type 
                  @mode, @company_code, @Loan_ID, @Loan_Eligible_Amount, @Start_Year, @End_Year, 
                  @keyfield, '', @Modified_by, null, null, null, null, null, null, null, null
              `);
    }

    res.status(200).json("Data updated successfully");

  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const allLoanType = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`EXEC sp_Loan_Type 'A','',0,0,'','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const deleteLoanType = async (req, res) => {
  const editedData = req.body.editedData;

  if (!editedData || !editedData.length) {
    return res.status(400).json("Invalid or empty editedData array.");
  }

  try {
    const pool = await connection.connectToDatabase();

    for (const updatedRow of editedData) {
      await pool
        .request()
        .input("mode", sql.NVarChar, "D")
        .input("company_code", sql.NVarChar, req.headers['company_code'])
        .input("keyfield", sql.NVarChar, updatedRow.keyfield)
        .query(`EXEC sp_Loan_Type @mode, @company_code, '', 0, '', '', @keyfield, '', '', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL`);
    }

    res.status(200).json("Data deleted successfully");

  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};



const addPfDetails = async (req, res) => {
  const { company_code, Employee_Fund, Company_Fund, Start_Year, End_Year, created_by } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("Employee_Fund", sql.Decimal(10, 2), Employee_Fund)
      .input("Company_Fund", sql.Decimal(10, 2), Company_Fund)
      .input("Start_Year", sql.Date, Start_Year)
      .input("End_Year", sql.Date, End_Year)
      .input("created_by", sql.NVarChar, created_by)
      .query(`EXEC sp_PF_Both_share @mode,@company_code,@Employee_Fund,@Company_Fund,@Start_Year,@End_Year,'',@created_by,'',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.status(200).json("Employee pf details data inserted successfully");
  } catch (err) {
    console.error("Error inserting data:", err);
    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};

const updatePfDetail = async (req, res) => {
  const editedData = req.body.editedData;

  if (!editedData || !editedData.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }

  try {
    let pool = await sql.connect(dbConfig);
    for (const updatedRow of editedData) {
      await pool
        .request()
        .input("mode", sql.NVarChar, "U")
        .input("company_code", sql.NVarChar, req.headers['company_code'])
        .input("Employee_Fund", sql.Decimal(10, 2), updatedRow.Employee_Fund)
        .input("Company_Fund", sql.Decimal(10, 2), updatedRow.Company_Fund)
        .input("keyfield", sql.NVarChar, updatedRow.keyfield)
        .input("modified_by", sql.NVarChar, req.headers['modified-by'])
        .query(`EXEC sp_PF_Both_share @mode,@company_code,@Employee_Fund,@Company_Fund,'','',@keyfield,'',@modified_by,null,null,null,null,null,null,null,null`);
    }
    res.json({ message: "Data updated successfully" });
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const deletePfDetail = async (req, res) => {
  const editedData = req.body.editedData;

  if (!editedData || !editedData.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }
  try {
    const pool = await connection.connectToDatabase(dbConfig);
    for (const updatedRow of editedData) {
      await pool
        .request()
        .input("mode", sql.NVarChar, "D")
        .input("company_code", sql.NVarChar, req.headers['company_code'])
        .input("keyfield", sql.NVarChar, updatedRow.keyfield)
        .query(`EXEC sp_PF_Both_share @mode,@company_code,0,0,'','',@keyfield,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    }
    res.status(200).json("data deleted successfully");
  } catch (err) {
    console.error("Error inserting data:", err);
    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};

const allPfDetail = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "A")
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_PF_Both_share @mode,@company_code,0,0,'','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


// Code Added by harish on 16/01/2025

const ProfessionalTaxSC = async (req, res) => {
  const { company_code, Employee_Salary_From, Employee_Salary_To, Taxable_Amount } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("company_code", sql.VarChar, company_code)
      .input("Employee_Salary_From", sql.Decimal(10, 2), Employee_Salary_From)
      .input("Employee_Salary_To", sql.Decimal(10, 2), Employee_Salary_To)
      .input("Taxable_Amount", sql.Decimal(10, 2), Taxable_Amount)
      .query(`EXEC sp_Professional_Tax 'sc',@company_code,@Employee_Salary_From,@Employee_Salary_To,@Taxable_Amount,'','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


// Code Ended by harish on 16/01/2025

//CODE ADDED BY PAVUN 16-01-2025
const getBonusDetails = async (req, res) => {
  const { company_code, Annual_bonus, Referral_bonus, Start_Year, End_Year } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("company_code", sql.NVarChar, company_code)
      .input("Annual_bonus", sql.Decimal(14, 2), Annual_bonus)
      .input("Referral_bonus", sql.Decimal(14, 2), Referral_bonus)
      .input("Start_Year", sql.NVarChar, Start_Year)
      .input("End_Year", sql.NVarChar, End_Year)
      .query(`EXEC sp_bonus @mode,@company_code,'',@Annual_bonus,@Referral_bonus,0,0,0,0,@Start_Year,@End_Year,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data Not Found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//CODE ENDED BY PAVUN

//CODE ADDED BY PAVUN 17-01-2025
const getPFContribution = async (req, res) => {
  const { company_code, Employee_Fund, Company_Fund, Start_Year, End_Year } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("company_code", sql.NVarChar, company_code)
      .input("Employee_Fund", sql.Decimal(14, 2), Employee_Fund)
      .input("Company_Fund", sql.Decimal(14, 2), Company_Fund)
      .input("Start_Year", sql.NVarChar, Start_Year)
      .input("End_Year", sql.NVarChar, End_Year)
      .query(`EXEC sp_PF_Both_share @mode,@company_code,@Employee_Fund,@Company_Fund,@Start_Year,@End_Year,'','jk','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data Not Found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//CODE ENDED BY PAVUN
const getLoanType = async (req, res) => {
  const { company_code, Loan_ID, Loan_Eligible_Amount, Start_Year, End_Year } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("company_code", sql.NVarChar, company_code)
      .input("Loan_ID", sql.VarChar, Loan_ID)
      .input("Loan_Eligible_Amount", sql.Decimal(14, 2), Loan_Eligible_Amount)
      .input("Start_Year", sql.Date, Start_Year)
      .input("End_Year", sql.Date, End_Year)


      .query(`EXEC sp_Loan_Type 'sc',@company_code,@Loan_ID,@Loan_Eligible_Amount,@Start_Year,@End_Year,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


// Code Added by harish on 16/01/2025

const OtherAllowanceSC = async (req, res) => {
  const { House_rent_Allowance, Medical_allowance, Overtime_allowance, Conveyance_allowance, Mobile_reimbursement, Education_Allowance, Meal_allowance, company_code, Start_Year, End_Year } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("House_rent_Allowance", sql.Decimal(10, 2), House_rent_Allowance)
      .input("Medical_allowance", sql.Decimal(10, 2), Medical_allowance)
      .input("Overtime_allowance", sql.Decimal(10, 2), Overtime_allowance)
      .input("Conveyance_allowance", sql.Decimal(10, 2), Conveyance_allowance)
      .input("Mobile_reimbursement", sql.Decimal(10, 2), Mobile_reimbursement)
      .input("Education_Allowance", sql.Decimal(10, 2), Education_Allowance)
      .input("Meal_allowance", sql.Decimal(10, 2), Meal_allowance)
      .input("company_code", sql.VarChar, company_code)
      .input("Start_Year", sql.Date, Start_Year)
      .input("End_Year", sql.Date, End_Year)
      .query(`EXEC sp_Other_Allowance @mode,@House_rent_Allowance,@Medical_allowance,@Overtime_allowance,@Conveyance_allowance,@Mobile_reimbursement,@Education_Allowance,@Meal_allowance,@company_code,@Start_Year,@End_Year,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL

`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getdefCustomer = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'DefaultCust','','', '','','', NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

// Code Added by harish 21_01_2025

const AddSalesSettings = async (req, res) => {
  const {
    company_code,
    customer_code,
    customer_name,
    pay_type,
    sales_type,
    order_type,
    warehouse_code,
    created_by,
    modified_by,
    tempstr1,
    tempstr2,
    tempstr3,
    tempstr4,
    datetime1,
    datetime2,
    datetime3,
    datetime4
  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.VarChar, company_code)
      .input("customer_code", sql.VarChar, customer_code)
      .input("customer_name", sql.VarChar, customer_name)
      .input("pay_type", sql.VarChar, pay_type)
      .input("sales_type", sql.VarChar, sales_type)
      .input("order_type", sql.VarChar, order_type)
      .input("warehouse_code", sql.NVarChar, warehouse_code)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(`EXEC sp_Sales_settings 'I',@company_code,@customer_code,@customer_name,@pay_type,@sales_type,@order_type,@warehouse_code,@created_by,'',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
`);
    res.json({ message: "Data inserted successfully" });
  }
  catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const addPurchaseOrderReturnheader = async (req, res) => {
  const { company_code, return_no, return_date, return_reason, return_person, Entry_date, transaction_no, vendor_code,
    return_amount, add_fright, less_fright, return_tax_amount, rounded_off, loading_charges, cartage_paid, other_charges, total_return_amount, tax_acc_code, rounded_off_acc_code, loading_charges_acc_code, cartage_paid_acc_code, other_charges_acc_code, purchase_amount_acc_code, created_by

  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I")
      .input("company_code", sql.NVarChar, company_code)
      .input("return_no", sql.NVarChar, return_no)
      .input("return_date", sql.Date, return_date)
      .input("return_reason", sql.NVarChar, return_reason)
      .input("return_person", sql.NVarChar, return_person)
      .input("Entry_date", sql.Date, Entry_date)
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("vendor_code", sql.NVarChar, vendor_code)
      .input("return_amount", sql.Decimal(14, 2), return_amount)
      .input("add_fright", sql.Decimal(14, 2), add_fright)
      .input("less_fright", sql.Decimal(14, 2), less_fright)
      .input("return_tax_amount", sql.Decimal(14, 2), return_tax_amount)
      .input("rounded_off", sql.Decimal(14, 2), rounded_off)
      .input("loading_charges", sql.Decimal(14, 2), loading_charges)
      .input("cartage_paid", sql.Decimal(14, 2), cartage_paid)
      .input("other_charges", sql.Decimal(14, 2), other_charges)
      .input("total_return_amount", sql.Decimal(10, 2), total_return_amount)
      .input("tax_acc_code", sql.NVarChar, tax_acc_code)
      .input("rounded_off_acc_code", sql.NVarChar, rounded_off_acc_code)
      .input("loading_charges_acc_code", sql.NVarChar, loading_charges_acc_code)
      .input("cartage_paid_acc_code", sql.NVarChar, cartage_paid_acc_code)
      .input("other_charges_acc_code", sql.NVarChar, other_charges_acc_code)
      .input("purchase_amount_acc_code", sql.NVarChar, purchase_amount_acc_code)
      .input("created_by", sql.NVarChar, created_by)
      .query(`EXEC sp_purchase_order_return_hdr @mode,@company_code,@return_no,@return_date,@return_reason,@return_person, @Entry_date,@transaction_no,@vendor_code, @return_amount,@add_fright,@less_fright,@return_tax_amount,@rounded_off,@loading_charges,@cartage_paid,@other_charges,@total_return_amount,@tax_acc_code,@rounded_off_acc_code,
          @loading_charges_acc_code,  @cartage_paid_acc_code, @other_charges_acc_code,@purchase_amount_acc_code,
          @created_by,'', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json(err.message);
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getAllPORethdrData = async (req, res) => {
  const { company_code } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "A")
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_purchase_order_return_hdr @mode,@company_code,'','','','','','','',0,0,0,0,0,0,0,0,0,'','','','','','','', '', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const POdeleteRethdrData = async (req, res) => {
  // const purch_autonosToDelete = req.body.purch_autonos;
  const { company_code, return_no } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    try {
      await pool
        .request()
        .input("mode", sql.NVarChar, "D")
        .input("company_code", sql.NVarChar, company_code)
        .input("return_no", sql.NVarChar, return_no)
        .query(`EXEC sp_purchase_order_return_hdr @mode,@company_code,@return_no,'','','','','','',0,0,0,0,0,0,0,0,0,'','','','','','','','', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL`);
    } catch (error) {
      if (error.number === 547) {
        res.status(400).json("first delete the Purchase Order details  ");
        return;
      } else {
        throw error; // Rethrow other SQL errors
      }
    }

    res.status(200).json("Purchase order  deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const addPurchaseOrderRetdetail = async (req, res) => {
  const { company_code, return_no, return_date,
    return_item_name, Entry_date, transaction_no,
    vendor_code, vendor_name, vendor_addr_1,
    vendor_addr_2, vendor_addr_3, vendor_addr_4,
    ShipTo_customer_name, ShipTo_customer_addr_1, ShipTo_customer_addr_2, ShipTo_customer_addr_3, ShipTo_customer_addr_4, ItemSNo,
    item_code, item_name, bill_qty,
    return_qty, bill_rate, return_amt,
    item_amt, weight, return_weight, total_weight,
    return_details, tax_amount, hsn,
    contact_person, contact_number, ship_to_contact_number, ship_to_contact_person, state, country,
    ship_to_state, ship_to_country, ShipTo_customer_code,
    vendor_gst_no, ShipTo_vendor_gst_no, created_by
  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("return_no", sql.NVarChar, return_no)
      .input("return_date", sql.Date, return_date)
      .input("return_item_name", sql.NVarChar, return_item_name)
      .input("Entry_date", sql.Date, Entry_date)
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("vendor_code", sql.NVarChar, vendor_code)
      .input("vendor_name", sql.NVarChar, vendor_name)
      .input("vendor_addr_1", sql.NVarChar, vendor_addr_1)
      .input("vendor_addr_2", sql.NVarChar, vendor_addr_2)
      .input("vendor_addr_3", sql.NVarChar, vendor_addr_3)
      .input("vendor_addr_4", sql.NVarChar, vendor_addr_4)
      .input("ShipTo_customer_name", sql.NVarChar, ShipTo_customer_name)
      .input("ShipTo_customer_addr_1", sql.NVarChar, ShipTo_customer_addr_1)
      .input("ShipTo_customer_addr_2", sql.NVarChar, ShipTo_customer_addr_2)
      .input("ShipTo_customer_addr_3", sql.NVarChar, ShipTo_customer_addr_3)
      .input("ShipTo_customer_addr_4", sql.NVarChar, ShipTo_customer_addr_4)
      .input("ItemSNo", sql.BigInt, ItemSNo)
      .input("item_code", sql.NVarChar, item_code)
      .input("item_name", sql.NVarChar, item_name)
      .input("bill_qty", sql.Decimal(10, 2), bill_qty)
      .input("return_qty", sql.Decimal(10, 2), return_qty)
      .input("bill_rate", sql.Decimal(14, 2), bill_rate)
      .input("return_amt", sql.Decimal(10, 2), return_amt)
      .input("item_amt", sql.Decimal(14, 2), item_amt)
      .input("weight", sql.Decimal(14, 2), weight)
      .input("return_weight", sql.Decimal(8, 3), return_weight)
      .input("total_weight", sql.Decimal(14, 2), total_weight)
      .input("return_details", sql.NVarChar, return_details)
      .input("tax_amount", sql.Decimal(14, 2), tax_amount)
      .input("hsn", sql.NVarChar, hsn)
      .input("contact_person", sql.NVarChar, contact_person)
      .input("contact_number", sql.NVarChar, contact_number)
      .input("ship_to_contact_number", sql.NVarChar, ship_to_contact_number)
      .input("ship_to_contact_person", sql.NVarChar, ship_to_contact_person)
      .input("state", sql.NVarChar, state)
      .input("country", sql.NVarChar, country)
      .input("ship_to_state", sql.NVarChar, ship_to_state)
      .input("ship_to_country", sql.NVarChar, ship_to_country)
      .input("ShipTo_customer_code", sql.NVarChar, ShipTo_customer_code)
      .input("vendor_gst_no", sql.NVarChar, vendor_gst_no)
      .input("ShipTo_vendor_gst_no", sql.NVarChar, ShipTo_vendor_gst_no)
      .input("created_by", sql.NVarChar, created_by)
      .query(`EXEC sp_purchase_order_return_details @mode,@company_code,@return_no,@return_date,@return_item_name,@Entry_date,@transaction_no,@vendor_code, @vendor_name,@vendor_addr_1,@vendor_addr_2,@vendor_addr_3,@vendor_addr_4,@ShipTo_customer_name,@ShipTo_customer_addr_1,@ShipTo_customer_addr_2,@ShipTo_customer_addr_3,@ShipTo_customer_addr_4,@ItemSNo,
              @item_code,  @item_name, @bill_qty,@return_qty,@bill_rate,@return_amt,@item_amt,@weight,@return_weight,@total_weight,@return_details,@tax_amount,@hsn,@contact_person,@contact_number,@ship_to_contact_number,@ship_to_contact_person,@state,@country,@ship_to_state,@ship_to_country,@ShipTo_customer_code,@vendor_gst_no,@ShipTo_vendor_gst_no,
              @created_by, '', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL`);
    {
      res.status(200).json("data inserted successfully");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getAllPORetdetData = async (req, res) => {
  const { company_code } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "A") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_purchase_order_return_details 'A',@company_code,'','','','','','','','','','','','','','', '','',0,'','',0,0,0,0,0,0,0,0,'',0,'','','','','','','','','','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const POdeleteRetdetData = async (req, res) => {
  // const purch_autonosToDelete = req.body.purch_autonos;
  const { company_code, return_no } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    await pool
      .request()
      .input("mode", sql.NVarChar, "D")
      .input("company_code", sql.NVarChar, company_code)
      .input("return_no", sql.NVarChar, return_no)
      .query(`EXEC sp_purchase_order_return_details @mode,@company_code,@return_no,'','','','','','','','','','','','','', '','',0,'','',0,0,0,0,0,0,0,0,'',0,'','','','','','','','','','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);



    res.status(200).json("Purchase order Return Details deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }

};


const getPORetSearchData = async (req, res) => {
  const { return_no, return_date, transaction_no, company_code, Entry_date, vendor_name, ShipTo_customer_name } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("return_no", sql.NVarChar, return_no)
      .input("return_date", sql.NVarChar, return_date)
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .input("Entry_date", sql.NVarChar, Entry_date)
      .input("vendor_name", sql.NVarChar, vendor_name)
      .input("ShipTo_customer_name", sql.NVarChar, ShipTo_customer_name)
      .query(`EXEC sp_purchase_order_return_details @mode,@company_code,@return_no,@return_date,'',@Entry_date,@transaction_no,'',@vendor_name,'','','','',@ShipTo_customer_name,'','', '','',0,'','',0,0,0,0,0,0,0,0,'',0,'','','','','','','','','','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const getDeletedPoRetSearchData = async (req, res) => {
  const { return_no, return_date, transaction_no, company_code, Entry_date, vendor_name, ShipTo_customer_name } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "DSC")
      .input("return_no", sql.NVarChar, return_no)
      .input("return_date", sql.NVarChar, return_date)
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .input("Entry_date", sql.NVarChar, Entry_date)
      .input("vendor_name", sql.NVarChar, vendor_name)
      .input("ShipTo_customer_name", sql.NVarChar, ShipTo_customer_name)
      .query(`EXEC sp_purchase_order_return_details @mode,@company_code,@return_no,@return_date,'',@Entry_date,@transaction_no,'',@vendor_name,'','','','',@ShipTo_customer_name,'','', '','',0,'','',0,0,0,0,0,0,0,0,'',0,'','','','','','','','','','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const addPORettaxdetail = async (req, res) => {
  const {
    company_code, return_date, return_no, Entry_date, transaction_no, vendor_code, ItemSNo, TaxSNo, item_code, item_name, tax_type, tax_name_details, tax_amt, tax_per, tax_acode,
    created_by
  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("return_date", sql.Date, return_date)
      .input("return_no", sql.NVarChar, return_no)
      .input("Entry_date", sql.Date, Entry_date)
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("vendor_code", sql.NVarChar, vendor_code)
      .input("ItemSNo", sql.BigInt, ItemSNo)
      .input("TaxSNo", sql.BigInt, TaxSNo)
      .input("item_code", sql.NVarChar, item_code)
      .input("item_name", sql.NVarChar, item_name)
      .input("tax_type", sql.NVarChar, tax_type)
      .input("tax_name_details", sql.NVarChar, tax_name_details)
      .input("tax_amt", sql.Decimal(14, 2), tax_amt)
      .input("tax_per", sql.Decimal(14, 2), tax_per)
      .input("tax_acode", sql.NVarChar, tax_acode)
      .input("created_by", sql.NVarChar, created_by)
      .query(
        `EXEC sp_purchase_order_return_tax_details @mode,@company_code,@return_date,@return_no,@Entry_date,@transaction_no,@vendor_code,@ItemSNo,@TaxSNo,@item_code,@item_name,@tax_type,@tax_name_details,
        @tax_amt,@tax_per,@tax_acode,@created_by,'',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.json({ success: true, message: "Data inserted successfully" });
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getAllPORettaxData = async (req, res) => {
  const { company_code } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "A") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_purchase_order_return_tax_details @mode,@company_code,'','','','','',0,0,'','','','',0,0,'','',''
,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const PODeleteRetTaxData = async (req, res) => {
  const { company_code, return_no } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    await pool
      .request()
      .input("mode", sql.NVarChar, "D")
      .input("company_code", sql.NVarChar, company_code)
      .input("return_no", sql.NVarChar, return_no)
      .query(`EXEC sp_purchase_order_return_tax_details @mode,@company_code,'',@return_no,'','','',0,0,'','','','',0,0,'','',''
                 ,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);

    res.status(200).json("Purchase order Return tax deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

// Code Added By harish 22/01/2025

const getitemcodevariant = async (req, res) => {
  const { Item_code, Item_variant, company_code } = req.body;
  let pool;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "DIV")
      .input("Item_code", sql.NVarChar, Item_code)
      .input("Item_variant", sql.NVarChar, Item_variant)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_item_brand_info @mode,@company_code,@Item_code,@Item_variant,'',0,'','','',0,0,0,
                           0,'','','','','','','','','','','','','',0,0,'','','',NULL,NULL,NULL,NULL
						   ,NULL,NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    }
    else res.status(404).json({ message: "Data not found" })
  } catch (err) {
    console.error("Error", err.message);
    return res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getDefaultoptions = async (req, res) => {
  const { company_code, Screen_Type } = req.body;
  let pool;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "A")
      .input("company_code", sql.NVarChar, company_code)
      .input("Screen_Type", sql.NVarChar, Screen_Type)
      .query(`EXEC sp_transaction_settings_test_2 @mode,@company_code,'','','','','','',@Screen_Type,'','','','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL

`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    }
    else res.status(404).json({ message: "Data not found" })
  } catch (err) {
    console.error("Error", err.message);
    return res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


// Code Ended by Harish  22/01/2025


//CODE ADDED BY PAVUN 22-01-2025
const getSalesMode = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'SalesMode','','', '','','', NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error during update:", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getSalesReturnAmountCalculation = async (req, res) => {
  const { sale_amt, paid_amt } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "RAC")
      .input("sale_amt", sql.VarChar, sale_amt)
      .input("paid_amt", sql.Decimal(14, 2), paid_amt)
      .query(`EXEC sp_sale_ItemAmountCalculation @mode,'',0 ,'',0,0,'','','',0,'',0,@sale_amt,0,@paid_amt,'',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    }
  } catch (err) {
    console.error("Error", err.message);
    return res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};
//CODE ENDED BY PAVUN

//CODE ADDED BY PAVUN 27-01-2025
const getReceivedGoods = async (req, res) => {
  const { company_code, bill_no } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("company_code", sql.NVarChar, company_code)
      .input("bill_no", sql.NVarChar, bill_no)
      .query(`EXEC sp_received_goods @mode,@company_code,@bill_no,'',0,'','',0,0,'','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data Not Found");
    }
  }
  catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const updateReceivedGoods = async (req, res) => {
  const editedData = req.body.editedData;

  if (!editedData || !editedData.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase();
    for (const updatedRow of editedData) {
      await pool
        .request()
        .input("mode", sql.NVarChar, "U")
        .input("company_code", sql.NVarChar, req.headers['company_code'])
        .input("keyfield", sql.NVarChar, updatedRow.keyfield)
        .input("rec_qty", sql.Decimal(10, 2), updatedRow.receiveQty)
        .query(`EXEC sp_received_goods @mode,@company_code,'','',0,'','',0,@rec_qty,'',@keyfield,'','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    }
    res.status(200).json("data updated successfully");
  }
  catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//CODE ENDED BY PAVUN
// Code  Added by Harish 28-01-2025

const getReceivedGoodsReport = async (req, res) => {
  const { company_code, bill_no, item_code, item_name, pending, start_date, end_date } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "DF")
      .input("company_code", sql.NVarChar, company_code)
      .input("bill_no", sql.NVarChar, bill_no)
      .input("item_code", sql.NVarChar, item_code)
      .input("item_name", sql.NVarChar, item_name)
      .input("pending", sql.NVarChar, pending)
      .input("start_date", sql.NVarChar, start_date)
      .input("end_date", sql.NVarChar, end_date)
      .query(`EXEC sp_received_goods @mode,@company_code,@bill_no,'',0,@item_code,@item_name,0,0,@pending,'',@start_date,@end_date,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data Not Found");
    }
  }
  catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
// Code  Ended by Harish 28-01-2025

// Code Added by Harish 29-01-2025

const AddTransactionSettinngs = async (req, res) => {
  const {
    company_code,
    Party_code,
    Party_name,
    pay_type,
    Transaction_type,
    order_type,
    warehouse_code,
    Screen_Type,
    Negative_stock,
    Sales_mode,
    No_of_Reports,
    Print_options,
    Print_copies,
    Print_templates,
    created_by,
    modified_by,
    tempstr1,
    tempstr2,
    tempstr3,
    tempstr4,
    datetime1,
    datetime2,
    datetime3,
    datetime4
  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.VarChar, company_code)
      .input("Party_code", sql.VarChar, Party_code)
      .input("Party_name", sql.VarChar, Party_name)
      .input("pay_type", sql.VarChar, pay_type)
      .input("Transaction_type", sql.VarChar, Transaction_type)
      .input("order_type", sql.VarChar, order_type)
      .input("warehouse_code", sql.NVarChar, warehouse_code)
      .input("Screen_Type", sql.NVarChar, Screen_Type)
      .input("Negative_stock", sql.NVarChar, Negative_stock)
      .input("Sales_mode", sql.NVarChar, Sales_mode)
      .input("No_of_Reports", sql.VarChar, No_of_Reports)
      .input("Print_options", sql.VarChar, Print_options)
      .input("Print_copies", sql.Int, Print_copies)
      .input("Print_templates", sql.VarChar, Print_templates)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(`EXEC sp_transaction_settings_test_2 @mode,@company_code,@Party_code,@Party_name,@pay_type,@Transaction_type,@order_type,@warehouse_code,@Screen_Type,@Sales_mode,@No_of_Reports,@Negative_stock,@Print_options,@Print_copies,@Print_templates,@created_by,'',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.json({ message: "Data inserted successfully" });
  }
  catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


// Code Ended by harish 29-01-2025

//Code Added by pavun 30-01-2025
const getPurchaseAnalysis = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'Purchase','','', '' , '','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getReceivedGoodsHelp = async (req, res) => {
  const { company_code, bill_no, bill_date, item_name, item_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "RGH")
      .input("company_code", sql.NVarChar, company_code)
      .input("bill_no", sql.NVarChar, bill_no)
      .input("bill_date", sql.NVarChar, bill_date)
      .input("item_name", sql.NVarChar, item_name)
      .input("item_code", sql.NVarChar, item_code)
      .query(`EXEC sp_received_goods @mode,@company_code,@bill_no,@bill_date,0,@item_code,@item_name,0,0,'','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data Not Found");
    }
  }
  catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//Code Ended by Pavun

//code added by pavun 01-02-2025
const addProject = async (req, res) => {
  const { ProjectName, ProjectDescription, ProjectManager, StartDate, EndDate, PriorityLevel, TaskStatus, EstimatedHours, company_code, created_by } = req.body;
  let pool;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("ProjectName", sql.NVarChar, ProjectName)
      .input("ProjectDescription", sql.NVarChar, ProjectDescription)
      .input("ProjectManager", sql.NVarChar, ProjectManager)
      .input("StartDate", sql.Date, StartDate)
      .input("EndDate", sql.Date, EndDate)
      .input("PriorityLevel", sql.NVarChar, PriorityLevel)
      .input("TaskStatus", sql.NVarChar, TaskStatus)
      .input("EstimatedHours", sql.NVarChar, EstimatedHours)
      .input("company_code", sql.NVarChar, company_code)
      .input("created_by", sql.NVarChar, created_by)
      .query(`EXEC sp_ProjectMaster @mode,'',@ProjectName,@ProjectDescription,@ProjectManager,@StartDate,@EndDate,@PriorityLevel,@TaskStatus,@EstimatedHours,@company_code,@created_by,'',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

// const updateProject = async (req, res) => {
//   const { ProjectID, ProjectName, ProjectDescription, ProjectManager, StartDate, EndDate, PriorityLevel, TaskStatus, modified_by } = req.body;
//   let pool;
//   try {
//     const pool = await connection.connectToDatabase();
//     await pool
//       .request()
//       .input("mode",                sql.NVarChar, "U") 
//       .input("ProjectID",           sql.NVarChar, ProjectID)
//       .input("ProjectName",         sql.NVarChar, ProjectName)
//       .input("ProjectDescription",  sql.NVarChar, ProjectDescription)
//       .input("ProjectManager",      sql.NVarChar, ProjectManager)
//       .input("StartDate",           sql.Date, StartDate)
//       .input("EndDate",             sql.Date, EndDate)
//       .input("PriorityLevel",       sql.NVarChar, PriorityLevel)
//       .input("TaskStatus",          sql.NVarChar, TaskStatus)
//       .input("modified_by",         sql.NVarChar, modified_by)
//       .query(`EXEC sp_ProjectMaster @mode,@ProjectID,@ProjectName,@ProjectDescription,@ProjectManager,@StartDate,@EndDate,@PriorityLevel,@TaskStatus,@EstimatedHours,'',@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

//       res.json({ message: "Data updated successfully" });
//   } catch (err) {
//     console.error("Error", err);
//     res.status(500).json({ message: err.message || 'Internal Server Error' });
//   }
// };

const updateProject = async (req, res) => {
  const editedData = req.body.editedData;
  if (!editedData || !editedData.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }
  try {
    const pool = await connection.connectToDatabase(dbConfig);
    for (const updatedRow of editedData) {
      await pool
        .request()
        .input("mode", sql.NVarChar, "U")
        .input("ProjectID", sql.NVarChar, updatedRow.ProjectID)
        .input("ProjectName", sql.NVarChar, updatedRow.ProjectName)
        .input("ProjectDescription", sql.NVarChar, updatedRow.ProjectDescription)
        .input("ProjectManager", sql.NVarChar, updatedRow.ProjectManager)
        .input("StartDate", sql.NVarChar, updatedRow.StartDate)
        .input("EndDate", sql.NVarChar, updatedRow.EndDate)
        .input("PriorityLevel", sql.NVarChar, updatedRow.PriorityLevel)
        .input("TaskStatus", sql.NVarChar, updatedRow.TaskStatus)
        .input("EstimatedHours", sql.NVarChar, updatedRow.EstimatedHours)
        .input("modified_by", sql.NVarChar, req.headers['modified-by'])
        .input("company_code", sql.NVarChar, updatedRow.company_code)
        .query(`EXEC sp_ProjectMaster @mode,@ProjectID,@ProjectName,@ProjectDescription,@ProjectManager,@StartDate,@EndDate,@PriorityLevel,@TaskStatus,@EstimatedHours,@company_code,'',@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    }
    res.json({ message: "Data updated successfully" });
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const deleteProject = async (req, res) => {
  const ProjectIDToDelete = req.body.ProjectIDToDelete;
  console.log(ProjectIDToDelete)
  if (!ProjectIDToDelete || !ProjectIDToDelete.length) {
    res.status(400).json("Invalid or empty Taskmaster Code array.");
    return;
  }
  try {
    const pool = await connection.connectToDatabase();
    for (const updatedRow of ProjectIDToDelete) {
      await pool.request()
        .input("mode", sql.NVarChar, "D")
        .input("ProjectID", sql.NVarChar, updatedRow.ProjectID)
        .input("company_code", sql.NVarChar, updatedRow.company_code)
        .query(`EXEC sp_ProjectMaster @mode,@ProjectID,'','','','','','','','',@company_code,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    }
    res.json({ message: "Data deleted successfully" });
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getAllProject = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`EXEC sp_ProjectMaster 'A','','','','','','','','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const addTask = async (req, res) => {
  const {
    TaskTitle, Description, ProjectID, userID, StartDate, EndDate,
    EstimatedHours, BufferHours, TaskStatus, PriorityLevel,
    company_code, created_by
  } = req.body;

  let Documents = null;
  if (req.file) {
    Documents = req.file.buffer; // Buffer containing the uploaded IMG
  }

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I")
      .input("TaskTitle", sql.NVarChar, TaskTitle)
      .input("Description", sql.NVarChar, Description)
      .input("ProjectID", sql.NVarChar, ProjectID)
      .input("userID", sql.NVarChar, userID)
      .input("StartDate", sql.Date, StartDate)
      .input("EndDate", sql.Date, EndDate)
      .input("EstimatedHours", sql.NVarChar, EstimatedHours)
      .input("BufferHours", sql.NVarChar, BufferHours)
      .input("TaskStatus", sql.NVarChar, TaskStatus)
      .input("PriorityLevel", sql.NVarChar, PriorityLevel)
      .input("company_code", sql.NVarChar, company_code)
      .input("Documents", sql.VarBinary, Documents)
      .input("created_by", sql.NVarChar, created_by)
      .query(`EXEC sp_TaskMaster @mode,'',@TaskTitle,@Description,@ProjectID,@userID,@StartDate,@EndDate,@EstimatedHours,@BufferHours,@TaskStatus,@PriorityLevel,@Documents,@company_code,@created_by,'',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    const insertedTask = result.recordset[0];

    if (insertedTask?.Email_ID) {
      console.log(insertedTask.Email_ID)
      const mailOptions = {
        from: 'alert@yjktechnologies.com',
        to: insertedTask.Email_ID,
        subject: `New Task Assigned: ${insertedTask.TaskMasterID}`,
        html: `
          <h3>New Task Assigned</h3>
          <p><strong>Task ID:</strong> ${insertedTask.TaskMasterID}</p>
          <p><strong>Title:</strong> ${TaskTitle}</p>
          <p><strong>Description:</strong> ${Description}</p>
          <p><strong>Start Date:</strong> ${StartDate}</p>
          <p><strong>End Date:</strong> ${EndDate}</p>
          <p><strong>Estimated Hours:</strong> ${EstimatedHours}</p>
          <p><strong>Buffer Hours:</strong> ${BufferHours}</p>
          <p><strong>Status:</strong> ${TaskStatus}</p>
          <p><strong>Priority Level:</strong> ${PriorityLevel}</p>
          <p><strong>Assigned by:</strong> ${created_by}</p>
        `
      };

      try {
        await transporter.sendMail(mailOptions);
      } catch (err) {
        console.error("Error sending OTP:", err);
        throw new Error("Error sending OTP");
      }
    }

    res.status(200).json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

// const updateTask = async (req, res) => {
//   const { TaskMasterID, TaskTitle, Description, ProjectID, userID, StartDate, EndDate, EstimatedHours, BufferHours, TaskStatus, modified_by } = req.body;
//   let pool;
//   try {
//     const pool = await connection.connectToDatabase();
//     const result = await pool
//       .request()
//       .input("mode",                sql.NVarChar, "U") // Insert mode
//       .input("TaskMasterID",        sql.NVarChar, TaskMasterID)
//       .input("TaskTitle",           sql.NVarChar, TaskTitle)
//       .input("Description",         sql.NVarChar, Description)
//       .input("ProjectID",           sql.NVarChar, ProjectID)
//       .input("userID",              sql.NVarChar, userID)
//       .input("StartDate",           sql.Date, StartDate)
//       .input("EndDate",             sql.Date, EndDate)
//       .input("EstimatedHours",      sql.NVarChar, EstimatedHours)
//       .input("BufferHours",         sql.NVarChar, BufferHours)
//       .input("TaskStatus",          sql.NVarChar, TaskStatus)
//       .input("modified_by",         sql.NVarChar, modified_by)
//       .query(`EXEC sp_TaskMaster @mode,@TaskMasterID,@TaskTitle,@Description,@ProjectID,@userID,@StartDate,@EndDate,@EstimatedHours,@BufferHours,@TaskStatus,'',@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
//       res.json({ message: "Data updated successfully" });
//   } catch (err) {
//     console.error("Error", err);
//     res.status(500).json({ message: err.message || 'Internal Server Error' });
//   }
// };






const getAllTask = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`EXEC sp_TaskMaster 'A','','','','','','','','','','','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//code end by pavun

//code added by kathiravan 01-02-2025
const addDailyLogin = async (req, res) => {
  const { userID, DayofLogin, DeviceDetails, company_code, IP_Address, Location, created_by } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("userID", sql.VarChar, userID)
      .input("DayofLogin", sql.Date, DayofLogin)
      .input("DeviceDetails", sql.VarChar, DeviceDetails)
      .input("IP_Address", sql.VarChar, IP_Address)
      .input("Location", sql.VarChar, Location)
      .input("company_code", sql.VarChar, company_code)
      .input("created_by", sql.NVarChar, created_by)
      .query(`EXEC sp_DailyLogin @mode,@userID,@DayofLogin,'','','','',@DeviceDetails,@IP_Address,@Location,@company_code,@created_by,'',null,null,null,null,null,null,null,null`);
    res.status(200).json("Check IN data inserted successfully");
  } catch (err) {
    console.error("Error inserting data:", err);
    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};

const addDailyTask = async (req, res) => {
  const { TaskMasterID, DailyTaskID, DailyTaskTiltle, HourseTaken, TaskDescription, TaskStauts, userID, PriorityLevel, company_code, created_by } = req.body;
  let pool;

  let Files = null;
  if (req.file) {
    Files = req.file.buffer;
  }

  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I")
      .input("TaskMasterID", sql.VarChar, TaskMasterID)
      .input("DailyTaskID", sql.VarChar, DailyTaskID)
      .input("DailyTaskTiltle", sql.VarChar, DailyTaskTiltle)
      .input("HourseTaken", sql.Decimal(10, 2), HourseTaken)
      .input("TaskDescription", sql.VarChar, TaskDescription)
      .input("TaskStauts", sql.VarChar, TaskStauts)
      .input("userID", sql.VarChar, userID)
      .input("PriorityLevel", sql.VarChar, PriorityLevel)
      .input("Files", sql.VarBinary, Files)
      .input("company_code", sql.NVarChar, company_code)
      .input("created_by", sql.NVarChar, created_by)
      .query(`EXEC sp_DailyTask @mode,@TaskMasterID,@DailyTaskID,@DailyTaskTiltle,@HourseTaken,@TaskDescription,@TaskStauts,@userID,@PriorityLevel,@Files,@company_code,@created_by,'',null,null,null,null,null,null,null,null`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json(err.message);
    }
  } catch (err) {
    console.error("Error", err.message);
    return res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const delDailyTask = async (req, res) => {
  const { DailyTaskID } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "D") // Insert mode
      .input("DailyTaskID", sql.VarChar, DailyTaskID)
      .query(`EXEC sp_DailyTask @mode,'',@DailyTaskID,'','','','','','','','','',null,null,null,null,null,null,null,null`);
    res.status(200).json("Daily Task Deleted successfully");
  } catch (err) {
    console.error("Error inserting data:", err);
    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};



const getDCItemAmountCalculation = async (req, res) => {
  const { company_code, type, Item_SNO, Item_code, bill_qty, purchaser_amt, tax_type_header, tax_name_details, tax_percentage, UnitWeight, keyfield } = req.body;
  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();
    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "IAC")
      .input("company_code", sql.NVarChar, company_code)
      .input("type", sql.NVarChar, type)
      .input("Item_SNO", sql.BigInt, Item_SNO)
      .input("Item_code", sql.NVarChar, Item_code)
      .input("bill_qty", sql.Decimal(10, 2), bill_qty)
      .input("purchaser_amt", sql.Decimal(10, 2), purchaser_amt)
      .input("tax_type_header", sql.NVarChar, tax_type_header)
      .input("tax_name_details", sql.NVarChar, tax_name_details)
      .input("tax_percentage", sql.NVarChar, tax_percentage)
      .input("UnitWeight", sql.Decimal(8, 3), UnitWeight)
      .input("keyfield", sql.NVarChar, keyfield)
      .query(`EXEC sp_DC_ItemAmountCalculation @mode, @company_code,@type,@Item_SNO ,@Item_code, @bill_qty, @purchaser_amt, @keyfield,
                                NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const getDCTotalAmountCalculation = async (req, res) => {
  const { Tax_amount, Putchase_amount, company_code } = req.body;
  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();
    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "TOT")
      .input("Tax_amount", sql.NVarChar, Tax_amount)
      .input("Putchase_amount", sql.NVarChar, Putchase_amount)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_DC_ItemAmountCalculation 'TOT',@company_code,'',0,'',0,0,'', @Tax_amount, @Putchase_amount,
            NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err.message);
    return res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

//code ended by pavun
// Code Added by Harish 03-02-2025

const getTaskstatus = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'Taskstatus','','', '' , '','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
}

const getDailyTasks = async (req, res) => {
  try {
    let pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "A")
      .query(`EXEC sp_TaskMaster @mode,'','','','','','','','','','','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
`);
    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

// Code Ended by Harish 03-02-2025

//code added by mathubala 03-02-2025

// Code Added by harish on 04/02/2025

const DailytaskSC = async (req, res) => {
  const { TaskMasterID, StartDate, company_code, EndDate, ProjectID, TaskTitle, TaskStatus, userID } = req.body;
  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();
    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("TaskMasterID", sql.VarChar, TaskMasterID)
      .input("ProjectID", sql.VarChar, ProjectID)
      .input("TaskTitle", sql.VarChar, TaskTitle)
      .input("TaskStatus", sql.VarChar, TaskStatus)
      .input("userID", sql.VarChar, userID)
      .input("StartDate", sql.NVarChar, StartDate)
      .input("EndDate", sql.NVarChar, EndDate)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_TaskMaster @mode,@TaskMasterID,@TaskTitle,'',@ProjectID,@userID,@StartDate,@EndDate,'','',@TaskStatus,'','',@company_code,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
`);
    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const updateTask = async (req, res) => {
  const editedData = req.body.editedData;
  if (!editedData || !editedData.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }
  try {
    const pool = await connection.connectToDatabase(dbConfig);
    for (const updatedRow of editedData) {
      await pool
        .request()
        .input("mode", sql.NVarChar, "U") // update mode
        .input("TaskMasterID", sql.NVarChar, updatedRow.TaskMasterID)
        .input("TaskTitle", sql.NVarChar, updatedRow.TaskTitle)
        .input("Description", sql.NVarChar, updatedRow.Description)
        .input("ProjectID", sql.NVarChar, updatedRow.ProjectID)
        .input("userID", sql.NVarChar, updatedRow.userID)
        .input("StartDate", sql.NVarChar, updatedRow.StartDate)
        .input("EndDate", sql.NVarChar, updatedRow.EndDate)
        .input("EstimatedHours", sql.NVarChar, updatedRow.EstimatedHours)
        .input("BufferHours", sql.NVarChar, updatedRow.BufferHours)
        .input("TaskStatus", sql.NVarChar, updatedRow.TaskStatus)
        .input("PriorityLevel", sql.NVarChar, updatedRow.PriorityLevel)
        .input("modified_by", sql.NVarChar, req.headers['modified-by'])
        .input("company_code", sql.NVarChar, req.headers['company_code'])
        .input("tempstr1", sql.NVarChar, updatedRow.tempstr1)
        .input("tempstr2", sql.NVarChar, updatedRow.tempstr2)
        .input("tempstr3", sql.NVarChar, updatedRow.tempstr3)
        .input("tempstr4", sql.NVarChar, updatedRow.tempstr4)
        .input("datetime1", sql.NVarChar, updatedRow.datetime1)
        .input("datetime2", sql.NVarChar, updatedRow.datetime2)
        .input("datetime3", sql.NVarChar, updatedRow.datetime3)
        .input("datetime4", sql.NVarChar, updatedRow.datetime4)
        .query(`EXEC sp_TaskMaster @mode,@TaskMasterID,@TaskTitle,@Description,@ProjectID,@userID,@StartDate,@EndDate,@EstimatedHours,@BufferHours,@TaskStatus,@PriorityLevel,'',@company_code,'',@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`
        );
    }
    res.status(200).json("Edited data saved successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};



// Code Added by Harish on 04/02/2025

const DeleteTask = async (req, res) => {
  const TaskMasterIDToDelete = req.body.TaskMasterIDToDelete;
  console.log(TaskMasterIDToDelete)

  if (!TaskMasterIDToDelete || !TaskMasterIDToDelete.length) {
    res.status(400).json("Invalid or empty Taskmaster Code array.");
    return;
  }
  try {
    const pool = await connection.connectToDatabase();
    for (const updatedRow of TaskMasterIDToDelete) {
      await pool.request()
        .input("mode", sql.NVarChar, "D")
        .input("TaskMasterID", sql.NVarChar, updatedRow.TaskMasterID)
        .input("company_code", sql.NVarChar, req.headers['company_code'])
        .query(`EXEC sp_TaskMaster @mode,@TaskMasterID,'','','','','','','','','','','',@company_code,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    }
    res.status(200).json(" Data deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


// Code Ended by Harish on 04/02/2025


//Code added by pavun 05-02-2025

const PendingCustomer = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'PendingCustomer','','', '' ,'','', NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//Code ended by pavun

//code added by pavun 06-02-2025
const updateBankAccount = async (req, res) => {
  const {
    company_code,
    account_code,
    account_name,
    acc_addr_1,
    acc_addr_2,
    acc_addr_3,
    acc_addr_4,
    acc_area_code,
    acc_state_code,
    acc_country_code,
    base_accgroup_code,
    standard_accgroup_code,
    user_accgroup_code,
    account_number,
    IFSC_code,
    account_type,
    branch,
    default_bank,
    modified_by
  } = req.body;

  let bank_paymentQRCode = null;

  if (req.file) {
    bank_paymentQRCode = req.file.buffer;
  }

  try {
    const pool = await connection.connectToDatabase(dbConfig);
    await pool
      .request()
      .input("mode", sql.NVarChar, "U") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("account_code", sql.NVarChar, account_code)
      .input("account_name", sql.NVarChar, account_name)
      .input("acc_addr_1", sql.NVarChar, acc_addr_1)
      .input("acc_addr_2", sql.NVarChar, acc_addr_2)
      .input("acc_addr_3", sql.NVarChar, acc_addr_3)
      .input("acc_addr_4", sql.NVarChar, acc_addr_4)
      .input("acc_area_code", sql.NVarChar, acc_area_code)
      .input("acc_state_code", sql.NVarChar, acc_state_code)
      .input("acc_country_code", sql.NVarChar, acc_country_code)
      .input("base_accgroup_code", sql.NVarChar, base_accgroup_code)
      .input("standard_accgroup_code", sql.NVarChar, standard_accgroup_code)
      .input("user_accgroup_code", sql.NVarChar, user_accgroup_code)
      .input("account_number", sql.NVarChar, account_number)
      .input("IFSC_code", sql.NVarChar, IFSC_code)
      .input("account_type", sql.NVarChar, account_type)
      .input("branch", sql.NVarChar, branch)
      .input("bank_paymentQRCode", sql.VarBinary, bank_paymentQRCode)
      .input("default_bank", sql.VarChar, default_bank)
      .input("modified_by", sql.NVarChar, modified_by)
      .query(`EXEC sp_account_name @mode, @company_code,@account_code, @account_name, @acc_addr_1, @acc_addr_2, @acc_addr_3, @acc_addr_4, @acc_area_code, @acc_state_code, 
      @acc_country_code, '','','','','','',0,'','','','',@base_accgroup_code,@standard_accgroup_code,@user_accgroup_code,'','',@account_number,@IFSC_code,@account_type,@branch,'','','',
      @bank_paymentQRCode,@default_bank,'',@modified_by,NULL, NULL,NULL, NULL,NULL, NULL,NULL,NULL,''`);
    // Return success response
    res.json({ success: true, message: "Data updated successfully" });
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//code ended by pavun

//Code added by mathu 06-02-2025


const projectSC = async (req, res) => {
  const { ProjectID, ProjectName, ProjectManager, StartDate, EndDate, PriorityLevel, TaskStatus, company_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("ProjectID", sql.VarChar, ProjectID)
      .input("ProjectName", sql.NVarChar, ProjectName)
      .input("ProjectManager", sql.NVarChar, ProjectManager)
      .input("StartDate", sql.NVarChar, StartDate)
      .input("EndDate", sql.NVarChar, EndDate)
      .input("PriorityLevel", sql.NVarChar, PriorityLevel)
      .input("TaskStatus", sql.NVarChar, TaskStatus)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_ProjectMaster @mode,@ProjectID,@ProjectName,'',@ProjectManager,@StartDate,@EndDate,@PriorityLevel,@TaskStatus,'',@company_code,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//code ended by mathu

//code added by pavun 07-02-2025
const getProjectTask = async (req, res) => {
  const { ProjectID, company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "PT")
      .input("ProjectID", sql.VarChar, ProjectID)
      .input("company_code", sql.VarChar, company_code)
      .query(`EXEC sp_TaskMaster @mode,'','','',@ProjectID,'','','','','','','','',@company_code,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
const getDailyTask = async (req, res) => {
  const { userID, company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "LDT")
      .input("userID", sql.VarChar, userID)
      .input("company_code", sql.VarChar, company_code)
      .query(`EXEC sp_TaskMaster @mode,'','','','',@userID,'','','','','','','',@company_code,'
             ','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//code ended by pavun

// Code Added By harish 07-02-25
const getPriority = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'PriorityLevel','','', '','','', NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error during update:", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
// Code Ended By harish 07-02-25

const getProjectDetail = async (req, res) => {
  const { ProjectID, company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "PD")
      .input("ProjectID", sql.VarChar, ProjectID)
      .input("company_code", sql.VarChar, company_code)
      .query(`EXEC sp_ProjectMaster @mode,@ProjectID,'','','','','','','','',@company_code,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
const getTaskDetail = async (req, res) => {
  const { TaskMasterID, company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "TD")
      .input("TaskMasterID", sql.VarChar, TaskMasterID)
      .input("company_code", sql.VarChar, company_code)
      .query(`EXEC sp_TaskMaster @mode,@TaskMasterID,'','','','','','','','','','','',@company_code,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//code added by pavun 11-02-2025
const addProjectMapping = async (req, res) => {
  const { ProjectID, userID, company_code, created_by } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I")
      .input("ProjectID", sql.VarChar, ProjectID)
      .input("userID", sql.VarChar, userID)
      .input("company_code", sql.VarChar, company_code)
      .input("created_by", sql.VarChar, created_by)
      .query(`EXEC sp_ProjectMapping @mode,@ProjectID,'','',@userID,'',@company_code,@created_by,'',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    res.status(200).json("Data Inserted Successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const updateProjectMapping = async (req, res) => {
  const editedData = req.body.editedData;

  if (!editedData || !editedData.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase();
    for (const updatedRow of editedData) {
      await pool
        .request()
        .input("mode", sql.NVarChar, "U")
        .input("ProjectID", sql.NVarChar, updatedRow.ProjectID)
        .input("userID", sql.NVarChar, updatedRow.userID)
        .input("keyfield", sql.NVarChar, updatedRow.keyfield)
        .input("modified_by", sql.NVarChar, req.headers['modified-by'])
        .query(`EXEC sp_ProjectMapping @mode,@ProjectID,'','',@userID,@keyfield,'','',@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    }
    res.status(200).json("Data Updated Successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const deleteProjectMapping = async (req, res) => {
  const editedData = req.body.editedData;

  if (!editedData || !editedData.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase();
    for (const updatedRow of editedData) {
      await pool
        .request()
        .input("mode", sql.NVarChar, "D")
        .input("keyfield", sql.NVarChar, updatedRow.keyfield)
        .query(`EXEC sp_ProjectMapping @mode,'','','','',@keyfield,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    }
    res.status(200).json("Data Deleted Successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getProjectDrop = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "F")
      .input("company_code", sql.NVarChar, company_code)
      .query("EXEC sp_ProjectMaster 'F','','','','','','','','','',@company_code,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL");

    res.json(result.recordset);
  } catch (err) {
    console.error("Error during update:", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getProjectMapping = async (req, res) => {
  const { ProjectName, ProjectID, user_name, userID, company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("ProjectID", sql.NVarChar, ProjectID)
      .input("ProjectName", sql.NVarChar, ProjectName)
      .input("user_name", sql.NVarChar, user_name)
      .input("userID", sql.NVarChar, userID)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_ProjectMapping @mode,@ProjectID,@ProjectName,@user_name,@userID,'',@company_code,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data Not Found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//code ended by pavun 



//code added by pavun 14-02-2025
const getTaskDetailReport = async (req, res) => {
  const { TaskMasterID } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "TD")
      .input("TaskMasterID", sql.VarChar, TaskMasterID)
      .query(`EXEC sp_DailyTask @mode,@TaskMasterID,'','',0,'','','','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//code ended by pavun

// Code Added By Harish 15_02_25
const getTaskHourReport = async (req, res) => {
  const { start_date, end_date, userid, company_code, Status } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "THR")
      .input("start_date", sql.Date, start_date)
      .input("end_date", sql.Date, end_date)
      .input("userid", sql.VarChar, userid)
      .input("company_code", sql.VarChar, company_code)
      .input("Status", sql.VarChar, Status)
      .query(`EXEC sp_task_hour_report @mode,@start_date,@end_date,@userid,'',@company_code,0, @Status`);
    res.status(200).json({
      dailyReport: result.recordsets[0],     // First SELECT
      leaveSummary: result.recordsets[1],    // Second SELECT
    })
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getTaskHourReportDetail = async (req, res) => {
  const { start_date, company_code, userid, Status } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "THRD")
      .input("start_date", sql.Date, start_date)
      .input("userid", sql.VarChar, userid)
      .input("company_code", sql.VarChar, company_code)
      .input("Status", sql.VarChar, Status)
      .query(`EXEC sp_task_hour_report @mode,@start_date,'',@userid,'',@company_code,0, @Status`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

// Code Ended By Harish 15_02_25

//Code Added by Harish 17/02/25
const Getmanager = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(
      "EXEC sp_employee_company 'M','','','','','','','','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
    );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

// Code Added By Harish 18/02/25
const getProjectDetailReport = async (req, res) => {
  const { projectid } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "PDR")
      .input("projectid", sql.VarChar, projectid)
      .query(`EXEC sp_task_hour_report @mode,'','','',@projectid,'',0,''`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
const getProjectReport = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(
      `EXEC sp_task_hour_report 'PR','','','','','',0,''`
    );
    res.json(result.recordset);
  } catch (err) {
    console.error("Error during update:", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

// Code Added by Harish 19/02/25
const GradeSC = async (req, res) => {
  const { GradeID, GradeName, Basic, HRA, Conveyance, Medical, Special_Allowance, Company_Pf_Contribution, Bonus_Arrears, Other_Allowance, LeaveDeduction, otherDeductions, ctc_currency, minimum_take_salary, salary_range_from, salary_range_to, company_code } = req.body;
  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();
    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("GradeID", sql.VarChar, GradeID)
      .input("GradeName", sql.VarChar, GradeName)
      .input("Basic", sql.Decimal(14, 3), Basic)
      .input("HRA", sql.Decimal(14, 3), HRA)
      .input("Conveyance", sql.Decimal(14, 3), Conveyance)
      .input("Medical", sql.Decimal(14, 3), Medical)
      .input("Special_Allowance", sql.Decimal(14, 3), Special_Allowance)
      .input("Company_Pf_Contribution", sql.Decimal(14, 3), Company_Pf_Contribution)
      .input("Bonus_Arrears", sql.Decimal(14, 3), Bonus_Arrears)
      .input("Other_Allowance", sql.Decimal(14, 3), Other_Allowance)
      .input("LeaveDeduction", sql.Decimal(14, 3), LeaveDeduction)
      .input("otherDeductions", sql.Decimal(14, 3), otherDeductions)
      .input("ctc_currency", sql.VarChar, ctc_currency)
      .input("minimum_take_salary", sql.Decimal(14, 3), minimum_take_salary)
      .input("salary_range_from", sql.Decimal(10, 2), salary_range_from)
      .input("salary_range_to", sql.Decimal(10, 2), salary_range_to)
      .input("company_code", sql.VarChar, company_code)
      .query(`EXEC sp_Grade @mode,@GradeID,@GradeName,@Basic,@HRA,@Conveyance,@Medical,@Special_Allowance,@Company_Pf_Contribution,
        @Bonus_Arrears,@Other_Allowance,@LeaveDeduction,@otherDeductions,@ctc_currency,@minimum_take_salary,@salary_range_from,@salary_range_to,@company_code,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error during update:", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
// Code Ended by Harish 19/02/25

// Code Added by Harish 22/02/25
const LoanSC = async (req, res) => {
  const { EmployeeId, loanID, EndDate, ApprovedBy, LoanEligibleAmount, EffetiveDate, HowManyMonth, EMIAmount, company_code } = req.body;
  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();
    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("EmployeeId", sql.VarChar, EmployeeId)
      .input("loanID", sql.VarChar, loanID)
      .input("ApprovedBy", sql.VarChar, ApprovedBy)
      .input("LoanEligibleAmount", sql.Int, LoanEligibleAmount)
      .input("EffetiveDate", sql.VarChar, EffetiveDate)
      .input("EndDate", sql.NVarChar, EndDate)
      .input("HowManyMonth", sql.Int, HowManyMonth)
      .input("EMIAmount", sql.Int, EMIAmount)
      .input("company_code", sql.VarChar, company_code)


      .query(`EXEC sp_EmployeeLoan  @mode,@EmployeeId ,@loanID,@ApprovedBy,@LoanEligibleAmount,@EffetiveDate,@EndDate ,@HowManyMonth ,@EMIAmount,@company_code,'','',null,null,null,null,null,null,null,null
`);
    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const TaskMasterSC = async (req, res) => {
  const { TaskMasterID, TaskTitle, Description, PriorityLevel, ProjectID, company_code } = req.body;
  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();
    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "TC")
      .input("TaskMasterID", sql.NVarChar, TaskMasterID)
      .input("TaskTitle", sql.VarChar, TaskTitle)
      .input("Description", sql.VarChar, Description)
      .input("PriorityLevel", sql.NVarChar, PriorityLevel)
      .input("ProjectID", sql.NVarChar, ProjectID)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_TaskMaster @mode,@TaskMasterID,@TaskTitle,@Description,@ProjectID,'','','','','','',@PriorityLevel,'',@company_code,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const Userdropdown = async (req, res) => {
  const { user_code } = req.body;
  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();
    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "MG")
      .input("user_code", sql.NVarChar, user_code)
      .query(`EXEC [SP_user_info_hdr] @mode,'',@user_code,'','','','','','','','','','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
`);
    res.json(result.recordset);
  } catch (err) {
    console.error("Error during update:", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

// Code Ended by Harish 22/02/25
const updPurchaseOrderheader = async (req, res) => {
  const { company_code, Entry_date, transaction_no, vendor_code,
    purchase_amount, add_fright, less_fright, tax_amount, rounded_off, loading_charges, cartage_paid, other_charges, total_amount, tax_acc_code, rounded_off_acc_code, loading_charges_acc_code, cartage_paid_acc_code, other_charges_acc_code, purchase_amount_acc_code, delivery_date, credit, remarks, created_by, modified_by
  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "U")
      .input("company_code", sql.NVarChar, company_code)
      .input("Entry_date", sql.Date, Entry_date)
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("vendor_code", sql.NVarChar, vendor_code)
      .input("purchase_amount", sql.Decimal(14, 2), purchase_amount)
      .input("add_fright", sql.Decimal(14, 2), add_fright)
      .input("less_fright", sql.Decimal(14, 2), less_fright)
      .input("tax_amount", sql.Decimal(14, 2), tax_amount)
      .input("rounded_off", sql.Decimal(14, 2), rounded_off)
      .input("loading_charges", sql.Decimal(14, 2), loading_charges)
      .input("cartage_paid", sql.Decimal(14, 2), cartage_paid)
      .input("other_charges", sql.Decimal(14, 2), other_charges)
      .input("total_amount", sql.Decimal(10, 2), total_amount)
      .input("tax_acc_code", sql.NVarChar, tax_acc_code)
      .input("rounded_off_acc_code", sql.NVarChar, rounded_off_acc_code)
      .input("loading_charges_acc_code", sql.NVarChar, loading_charges_acc_code)
      .input("cartage_paid_acc_code", sql.NVarChar, cartage_paid_acc_code)
      .input("other_charges_acc_code", sql.NVarChar, other_charges_acc_code)
      .input("purchase_amount_acc_code", sql.NVarChar, purchase_amount_acc_code)
      .input("delivery_date", sql.Date, delivery_date)
      .input("credit", sql.NVarChar, credit)
      .input("remarks", sql.NVarChar, remarks)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .query(`EXEC sp_purchase_order_hdr @mode,@company_code, @Entry_date,@transaction_no,@vendor_code, @purchase_amount,@add_fright,@less_fright,@tax_amount,@rounded_off,@loading_charges,@cartage_paid,@other_charges,@total_amount,@tax_acc_code,@rounded_off_acc_code,
          @loading_charges_acc_code,  @cartage_paid_acc_code, @other_charges_acc_code,@purchase_amount_acc_code,@delivery_date,@credit,@remarks,
          @created_by, @modified_by, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL`);
    res.json({ success: true, message: "Data Updated successfully" });
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//code added by mathu 25-02-2025
const deleteLeave = async (req, res) => {

  const LeaveIdToDelete = req.body.LeaveIdToDelete;

  if (!LeaveIdToDelete || !LeaveIdToDelete.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }
  try {
    const pool = await connection.connectToDatabase();
    for (const updatedRow of LeaveIdToDelete) {
      await pool
        .request()
        .input("mode", sql.NVarChar, "D")
        .input("LeaveId", sql.NVarChar, updatedRow.LeaveId)
        .input("company_code", sql.NVarChar, updatedRow.company_code)
        .query(`EXEC sp_LeaveTypes @mode,@company_code,@LeaveId,'','','','','','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    }
    res.status(200).json("Data Deleted Successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};



const UpdateLeaveType = async (req, res) => {
  const editedData = req.body.editedData;

  if (!editedData || !editedData.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase();
    for (const updatedRow of editedData) {
      await pool
        .request()
        .input("mode", sql.VarChar, "U") // Insert mode
        .input("company_code", sql.VarChar, updatedRow.company_code)
        .input("LeaveId", sql.VarChar, updatedRow.LeaveId)
        .input("Description", sql.VarChar, updatedRow.Description)
        .input("code", sql.VarChar, updatedRow.code)
        .input("Type", sql.VarChar, updatedRow.Type)
        .input("Accrual", sql.VarChar, updatedRow.Accrual)
        .input("TotalDaystoBeCredit", sql.Int, updatedRow.TotalDaystoBeCredit)
        .input("carryForward", sql.Int, updatedRow.carryForward)
        .input("Exceed_Leave", sql.VarChar, updatedRow.Exceed_Leave)
        .input("LeaveReason", sql.VarChar, updatedRow.LeaveReason)
        .input("modified_by", sql.NVarChar, updatedRow.modified_by)

        .query(
          `EXEC sp_LeaveTypes @mode,@company_code,@LeaveId,@Description,@code,@Type,@Accrual,@TotalDaystoBeCredit,@carryForward,@Exceed_Leave,@LeaveReason,'',@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    } res.json({ success: true, message: "Data inserted successfully" });
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//code ended by mathu 25-02-2025
const AnnouncementSearchCretria = async (req, res) => {
  const { Announcement_id, SelectType, SelectDetails, AnnouncementValidFor, Messagetype, MessageTitle,
    status, RequestfordoNotShowAgainOption, Start_Date, End_Date, company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("Announcement_id", sql.NVarChar, Announcement_id)
      .input("SelectType", sql.NVarChar, SelectType)
      .input("SelectDetails", sql.NVarChar, SelectDetails)
      .input("AnnouncementValidFor", sql.NVarChar, AnnouncementValidFor)
      .input("Messagetype", sql.NVarChar, Messagetype)
      .input("MessageTitle", sql.NVarChar, MessageTitle)
      .input("status", sql.NVarChar, status)
      .input("RequestfordoNotShowAgainOption", sql.NVarChar, RequestfordoNotShowAgainOption)
      .input("Start_Date", sql.NVarChar, Start_Date)
      .input("End_Date", sql.NVarChar, End_Date)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_Announcement @mode,@Announcement_id,@SelectType,@SelectDetails,@AnnouncementValidFor,@Messagetype,@MessageTitle,@status,@RequestfordoNotShowAgainOption,@Start_Date,'',@End_Date,'',@company_code,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const updDeliveryChallanheader = async (req, res) => {
  const {
    company_code, transaction_no, transaction_date, transport_charges, pay_type, sales_type, customer_name, bill_to_customer_code, customer_addr_1,
    customer_addr_2, customer_addr_3, customer_addr_4, customer_state, customer_country, customer_mobile_no, contact_person, ShipTo_customer_name,
    Ship_to_customer_code, ShipTo_customer_addr_1, ShipTo_customer_addr_2, ShipTo_customer_addr_3, ShipTo_customer_addr_4, ShipTo_customer_state,
    ShipTo_customer_country, ShipTo_customer_mobile_no, ShipTocontact_person, purchase_amount, add_fright, less_fright, rounded_off, loading_charges,
    cartage_paid, other_charges, lorry_no, broker_code, transport_code, status, total_amount, rounded_off_acc_code, loading_charges_acc_code,
    cartage_paid_acc_code, other_charges_acc_code, purchase_amount_acc_code, customer_gst_no, ShipTocustomer_gst_no, delivery_note, dispatched_through,
    destination, note_not_for_sale, modified_by, } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "U") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("transaction_date", sql.Date, transaction_date)
      .input("transport_charges", sql.Decimal(10, 2), transport_charges)
      .input("pay_type", sql.NVarChar, pay_type)
      .input("sales_type", sql.NVarChar, sales_type)
      .input("customer_name", sql.NVarChar, customer_name)
      .input("bill_to_customer_code", sql.NVarChar, bill_to_customer_code)
      .input("customer_addr_1", sql.NVarChar, customer_addr_1)
      .input("customer_addr_2", sql.NVarChar, customer_addr_2)
      .input("customer_addr_3", sql.NVarChar, customer_addr_3)
      .input("customer_addr_4", sql.NVarChar, customer_addr_4)
      .input("customer_state", sql.NVarChar, customer_state)
      .input("customer_country", sql.NVarChar, customer_country)
      .input("customer_mobile_no", sql.NVarChar, customer_mobile_no)
      .input("contact_person", sql.NVarChar, contact_person)
      .input("ShipTo_customer_name", sql.NVarChar, ShipTo_customer_name)
      .input("Ship_to_customer_code", sql.NVarChar, Ship_to_customer_code)
      .input("ShipTo_customer_addr_1", sql.NVarChar, ShipTo_customer_addr_1)
      .input("ShipTo_customer_addr_2", sql.NVarChar, ShipTo_customer_addr_2)
      .input("ShipTo_customer_addr_3", sql.NVarChar, ShipTo_customer_addr_3)
      .input("ShipTo_customer_addr_4", sql.NVarChar, ShipTo_customer_addr_4)
      .input("ShipTo_customer_state", sql.NVarChar, ShipTo_customer_state)
      .input("ShipTo_customer_country", sql.NVarChar, ShipTo_customer_country)
      .input("ShipTo_customer_mobile_no", sql.NVarChar, ShipTo_customer_mobile_no)
      .input("ShipTocontact_person", sql.NVarChar, ShipTocontact_person)
      .input("purchase_amount", sql.Decimal(14, 2), purchase_amount)
      .input("add_fright", sql.Decimal(14, 2), add_fright)
      .input("less_fright", sql.Decimal(14, 2), less_fright)
      .input("rounded_off", sql.Decimal(14, 2), rounded_off)
      .input("loading_charges", sql.Decimal(14, 2), loading_charges)
      .input("cartage_paid", sql.Decimal(14, 2), cartage_paid)
      .input("other_charges", sql.Decimal(14, 2), other_charges)
      .input("lorry_no", sql.NVarChar, lorry_no)
      .input("broker_code", sql.NVarChar, broker_code)
      .input("transport_code", sql.NVarChar, transport_code)
      .input("status", sql.NVarChar, status)
      .input("total_amount", sql.Decimal(10, 2), total_amount)
      .input("rounded_off_acc_code", sql.NVarChar, rounded_off_acc_code)
      .input("loading_charges_acc_code", sql.NVarChar, loading_charges_acc_code)
      .input("cartage_paid_acc_code", sql.NVarChar, cartage_paid_acc_code)
      .input("other_charges_acc_code", sql.NVarChar, other_charges_acc_code)
      .input("purchase_amount_acc_code", sql.NVarChar, purchase_amount_acc_code)
      .input("customer_gst_no", sql.NVarChar, customer_gst_no)
      .input("ShipTocustomer_gst_no", sql.NVarChar, ShipTocustomer_gst_no)
      .input("delivery_note", sql.NVarChar, delivery_note)
      .input("dispatched_through", sql.NVarChar, dispatched_through)
      .input("destination", sql.NVarChar, destination)
      .input("note_not_for_sale", sql.NVarChar, note_not_for_sale)
      .input("modified_by", sql.NVarChar, modified_by)
      .query(`EXEC sp_delivery_challan_hdr @mode,@company_code,@transaction_no,@transaction_date,@transport_charges,@pay_type,@sales_type,@customer_name,@bill_to_customer_code,@customer_addr_1,
                         @customer_addr_2,@customer_addr_3,@customer_addr_4,@customer_state,@customer_country,@customer_mobile_no,@contact_person,@ShipTo_customer_name,
                        @Ship_to_customer_code,@ShipTo_customer_addr_1,@ShipTo_customer_addr_2,@ShipTo_customer_addr_3,@ShipTo_customer_addr_4,@ShipTo_customer_state,
                        @ShipTo_customer_country,@ShipTo_customer_mobile_no,@ShipTocontact_person,@purchase_amount,@add_fright,@less_fright,@rounded_off,@loading_charges,
                        @cartage_paid,@other_charges,@lorry_no,@broker_code,@transport_code,@status,@total_amount,@rounded_off_acc_code,@loading_charges_acc_code,
                        @cartage_paid_acc_code,@other_charges_acc_code,@purchase_amount_acc_code,@customer_gst_no,@ShipTocustomer_gst_no,@delivery_note, @dispatched_through,@destination,@note_not_for_sale,'',@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`)
    res.json({ success: true, message: "Data Updated successfully" });

  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const TaxInvoiceUpdate = async (req, res) => {
  const { company_code, bill_date, bill_no, dely_chlno, warehouse_code, sales_type, customer_code, sale_amt, less_frit, less_disc, less_amt, net_amt, excs_amt,
    cess_amt, dely_amt, roff_amt, othr_amt, bill_amt, tax_amount, total_item, total_qty, pay_type, broker_code, tpot_code, sman_code, vehl_no, mark_name, payment_mode,
    customer_name, entry_no, roff_acccode, order_type, deli_charge, billTo_customer_name, billTo_customer_addr_1, billTo_customer_addr_2, billTo_customer_addr_3,
    billTo_customer_addr_4, billTo_customer_state, billTo_customer_country, billTo_customer_mobile_no, billTo_contact_person, shipTo_customer_name, shipTo_customer_addr_1, shipTo_customer_addr_2, shipTo_customer_addr_3,
    shipTo_customer_addr_4, shipTo_customer_state, shipTo_customer_country, shipTo_customer_mobile_no, shipTo_contact_person, tax_acc_code, sale_amt_acc_code, othr_amt_acc_code, advance_amount, shipTo_customer_code,
    bal_amt, invoice_type, pending, billTo_customer_gst_no, ShipTo_customer_gst_no, delivery_note, dispatched_through, destination, po_no, po_date, document_type, Performa_bill_no, Eway_bill_no, supplier_ref, created_by, modified_by } = req.body;
  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "U")
      .input("company_code", sql.NVarChar, company_code)
      .input("bill_date", sql.NVarChar, bill_date)
      .input("bill_no", sql.NVarChar, bill_no)
      .input("dely_chlno", sql.NVarChar, dely_chlno)
      .input("warehouse_code", sql.NVarChar, warehouse_code)
      .input("sales_type", sql.NVarChar, sales_type)
      .input("customer_code", sql.NVarChar, customer_code)
      .input("sale_amt", sql.Decimal(14, 2), sale_amt)
      .input("less_frit", sql.Decimal(14, 2), less_frit)
      .input("less_disc", sql.Decimal(14, 2), less_disc)
      .input("less_amt", sql.Decimal(14, 2), less_amt)
      .input("net_amt", sql.Decimal(14, 2), net_amt)
      .input("excs_amt", sql.Decimal(14, 2), excs_amt)
      .input("cess_amt", sql.Decimal(14, 2), cess_amt)
      .input("dely_amt", sql.Decimal(14, 2), dely_amt)
      .input("roff_amt", sql.Decimal(14, 2), roff_amt)
      .input("othr_amt", sql.Decimal(14, 2), othr_amt)
      .input("bill_amt", sql.Decimal(14, 2), bill_amt)
      .input("tax_amount", sql.Decimal(14, 2), tax_amount)
      .input("total_item", sql.Int, total_item)
      .input("total_qty", sql.Int, total_qty)
      .input("pay_type", sql.NVarChar, pay_type)
      .input("broker_code", sql.NVarChar, broker_code)
      .input("tpot_code", sql.NVarChar, tpot_code)
      .input("sman_code", sql.NVarChar, sman_code)
      .input("vehl_no", sql.NVarChar, vehl_no)
      .input("mark_name", sql.NVarChar, mark_name)
      .input("payment_mode", sql.NVarChar, payment_mode)
      .input("customer_name", sql.NVarChar, customer_name)
      .input("entry_no", sql.NVarChar, entry_no)
      .input("roff_acccode", sql.NVarChar, roff_acccode)
      .input("order_type", sql.NVarChar, order_type)
      .input("deli_charge", sql.Decimal(18, 0), deli_charge)
      .input("billTo_customer_name", sql.NVarChar, billTo_customer_name)
      .input("billTo_customer_addr_1", sql.NVarChar, billTo_customer_addr_1)
      .input("billTo_customer_addr_2", sql.NVarChar, billTo_customer_addr_2)
      .input("billTo_customer_addr_3", sql.NVarChar, billTo_customer_addr_3)
      .input("billTo_customer_addr_4", sql.NVarChar, billTo_customer_addr_4)
      .input("billTo_customer_state", sql.NVarChar, billTo_customer_state)
      .input("billTo_customer_country", sql.NVarChar, billTo_customer_country)
      .input("billTo_customer_mobile_no", sql.NVarChar, billTo_customer_mobile_no)
      .input("billTo_contact_person", sql.NVarChar, billTo_contact_person)
      .input("shipTo_customer_name", sql.NVarChar, shipTo_customer_name)
      .input("shipTo_customer_addr_1", sql.NVarChar, shipTo_customer_addr_1)
      .input("shipTo_customer_addr_2", sql.NVarChar, shipTo_customer_addr_2)
      .input("shipTo_customer_addr_3", sql.NVarChar, shipTo_customer_addr_3)
      .input("shipTo_customer_addr_4", sql.NVarChar, shipTo_customer_addr_4)
      .input("shipTo_customer_state", sql.NVarChar, shipTo_customer_state)
      .input("shipTo_customer_country", sql.NVarChar, shipTo_customer_country)
      .input("shipTo_customer_mobile_no", sql.NVarChar, shipTo_customer_mobile_no)
      .input("shipTo_contact_person", sql.NVarChar, shipTo_contact_person)
      .input("tax_acc_code", sql.NVarChar, tax_acc_code)
      .input("sale_amt_acc_code", sql.NVarChar, sale_amt_acc_code)
      .input("othr_amt_acc_code", sql.NVarChar, othr_amt_acc_code)
      .input("advance_amount", sql.Decimal(14, 2), advance_amount)
      .input("shipTo_customer_code", sql.NVarChar, shipTo_customer_code)
      .input("bal_amt", sql.Decimal(14, 2), bal_amt)
      .input("invoice_type", sql.NVarChar, invoice_type)
      .input("pending", sql.NVarChar, pending)
      .input("billTo_customer_gst_no", sql.NVarChar, billTo_customer_gst_no)
      .input("ShipTo_customer_gst_no", sql.NVarChar, ShipTo_customer_gst_no)
      .input("delivery_note", sql.NVarChar, delivery_note)
      .input("dispatched_through", sql.NVarChar, dispatched_through)
      .input("destination", sql.NVarChar, destination)
      .input("po_no", sql.NVarChar, po_no)
      .input("po_date", sql.Date, po_date)
      .input("document_type", sql.NVarChar, document_type)
      .input("Performa_bill_no", sql.NVarChar, Performa_bill_no)
      .input("Eway_bill_no", sql.NVarChar, Eway_bill_no)
      .input("supplier_ref", sql.NVarChar, supplier_ref)
      .input("created_by", sql.NVarChar, created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .query(`EXEC sp_taxInvoice_Header @mode, @company_code, @bill_date, @bill_no, @dely_chlno, @warehouse_code, @sales_type,
              @customer_code, @sale_amt, @less_frit, @less_disc, @less_amt, @net_amt,       @excs_amt, @cess_amt, @dely_amt, @roff_amt, @othr_amt,
              @bill_amt, @tax_amount, @total_item, @total_qty, @pay_type, @broker_code,       @tpot_code, @sman_code, @vehl_no, @mark_name,
              @payment_mode, @customer_name, @entry_no, @roff_acccode, @order_type,       @deli_charge, @billTo_customer_name ,
              @billTo_customer_addr_1, @billTo_customer_addr_2, @billTo_customer_addr_3,      @billTo_customer_addr_4, @billTo_customer_state,
              @billTo_customer_country, @billTo_customer_mobile_no, @billTo_contact_person,       @shipTo_customer_name,  @shipTo_customer_addr_1,
              @shipTo_customer_addr_2, @shipTo_customer_addr_3, @shipTo_customer_addr_4,      @shipTo_customer_state, @shipTo_customer_country,
              @shipTo_customer_mobile_no, @shipTo_contact_person,@tax_acc_code,       @sale_amt_acc_code, @othr_amt_acc_code, @advance_amount, @shipTo_customer_code,
              @bal_amt,@invoice_type,@pending,@billTo_customer_gst_no,@ShipTo_customer_gst_no,      @delivery_note,@dispatched_through,@destination,@po_no,@po_date,@document_type,@Performa_bill_no,@Eway_bill_no,@supplier_ref,@created_by,@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.json({ success: true, message: "Data inserted successfully" });
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const productImageUpdate = async (req, res) => {
  const { company_code, Product_Code } = req.body;
  let Product_img = null;

  if (req.file) {
    Product_img = req.file.buffer;
  }

  try {
    const pool = await connection.connectToDatabase();
    await pool
      .request()
      .input("mode", sql.NVarChar, "PI")
      .input("company_code", sql.NVarChar, company_code)
      .input("Product_Code", sql.NVarChar, Product_Code)
      .input("Product_img", sql.VarBinary, Product_img)
      .query(`EXEC sp_Product_Header @mode,@company_code,@Product_Code,'','','','',0,'',@Product_img,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    res.status(200).json("product deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//code ended by pavun

// Code Added by Harish 05/03/2025
const Getticketandproject = async (req, res) => {
  const { TaskMasterID, company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "TDP")
      .input("TaskMasterID", sql.VarChar, TaskMasterID)
      .input("company_code", sql.VarChar, company_code)
      .query(`EXEC sp_TaskMaster @mode,@TaskMasterID,'','','','','','','','','','','',@company_code,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result && result.recordset && result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json({ message: "Data Not Found" });
    }
  } catch (err) {
    console.error("SQL Error:", err);
    res.status(500).json({ message: "Internal Server Error", error: err.message });
  }
};

// Code Ended by Harish 05/03/2025

// Code Added by Harish 06/03/2025

const GetProject = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "PP")
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_ProjectMaster @mode,'','','','','','','','','',@company_code,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );
    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
// Code Ended by Harish 06/03/2025
//Code Added By Harish 07/03/2025
const DailyLogin = async (req, res) => {
  const { userID, DayofLogin, DeviceDetails, company_code, IP_Address, Location, created_by } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "IN") // Insert mode
      .input("userID", sql.VarChar, userID)
      .input("DayofLogin", sql.Date, DayofLogin)
      .input("DeviceDetails", sql.VarChar, DeviceDetails)
      .input("IP_Address", sql.VarChar, IP_Address)
      .input("Location", sql.VarChar, Location)
      .input("company_code", sql.VarChar, company_code)
      .input("created_by", sql.NVarChar, created_by)
      .query(`EXEC sp_DailyLogin @mode,@userID,@DayofLogin,'','','','',@DeviceDetails,@IP_Address,@Location,@company_code,@created_by,'',null,null,null,null,null,null,null,null`);
    res.status(200).json("Check IN data inserted successfully");
  } catch (err) {
    console.error("Error inserting data:", err);
    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};
const DailyLogOUT = async (req, res) => {
  const { userID, DayofLogin, DeviceDetails, IP_Address, company_code, Location, created_by } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "OUT") // Insert mode
      .input("userID", sql.VarChar, userID)
      .input("DayofLogin", sql.Date, DayofLogin)
      .input("DeviceDetails", sql.VarChar, DeviceDetails)
      .input("IP_Address", sql.VarChar, IP_Address)
      .input("Location", sql.VarChar, Location)
      .input("company_code", sql.VarChar, company_code)
      .input("created_by", sql.NVarChar, created_by)
      .query(`EXEC sp_DailyLogin @mode,@userID,@DayofLogin,'','','','',@DeviceDetails,@IP_Address,@Location,@company_code,@created_by,'',null,null,null,null,null,null,null,null`);
    res.status(200).json("Check out data inserted successfully");
  } catch (err) {
    console.error("Error inserting data:", err);
    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};
//Code Ended By Harish 07/03/2025
// Code Added By Harish 12/03/2025
const Projectusercode = async (req, res) => {
  const { ProjectID, company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "MK")
      .input("ProjectID", sql.VarChar, ProjectID)
      .input("company_code", sql.VarChar, company_code)
      .query(`EXEC sp_ProjectMapping @mode,@ProjectID,'','','','',@company_code,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
`);
    if (result && result.recordset && result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json({ message: "Data Not Found" });
    }
  } catch (err) {
    console.error("SQL Error:", err);
    res.status(500).json({ message: "Internal Server Error", error: err.message });
  }
};

const deleteEmployeeHoliday = async (req, res) => {
  const editedData = req.body.editedData;

  if (!editedData || !editedData.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase();
    for (const updatedRow of editedData) {
      await pool
        .request()
        .input("mode", sql.NVarChar, "D")
        .input("company_code", sql.NVarChar, req.headers['company_code'])
        .input("HolidayDate", sql.Date, updatedRow.HolidayDate)

        .query(`EXEC sp_Holidays @mode,@HolidayDate,'','','',@company_code,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    }
    res.status(200).json("Data Deleted Successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//code added by harish 13-03-2025
const GetCC = async (req, res) => {
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "CC")
      .query(`EXEC sp_Stock_Validation_Status @mode,'','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const InsertStockVal = async (req, res) => {
  const { company_code, Validation_status, Screens, created_by } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    await pool
      .request()
      .input("mode", sql.NVarChar, "I")
      .input("company_code", sql.VarChar, company_code)
      .input("Validation_status", sql.VarChar, Validation_status)
      .input("Screens", sql.VarChar, Screens)
      .input("created_by", sql.VarChar, created_by)
      .query(`EXEC sp_Stock_Validation_Status @mode,@company_code,@Validation_status,@Screens,@created_by,'',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.status(200).json("Data inserted successfully");
  } catch (err) {
    console.error("Error inserting data:", err);
    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};

const updateStockVal = async (req, res) => {
  const editedData = req.body.editedData;

  if (!editedData || !editedData.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }
  try {
    const pool = await connection.connectToDatabase();
    for (const updatedRow of editedData) {
      await pool
        .request()
        .input("mode", sql.NVarChar, "U")
        .input("company_code", sql.NVarChar, updatedRow.company_code)
        .input("Validation_status", sql.NVarChar, updatedRow.Validation_status)
        .input("Screens", sql.NVarChar, updatedRow.Screens)
        .input("modified_by", sql.NVarChar, req.headers['modified-by'])
        .query(`EXEC sp_Stock_Validation_Status @mode,@company_code,@Validation_status,@Screens,'',@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    }
    res.status(200).json("data updated successfully");
  }
  catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const updateStockValStatus = async (req, res) => {
  const { company_code, Validation_status, Screens, modified_by } = req.body;
  try {
    const pool = await connection.connectToDatabase(dbConfig);
    await pool
      .request()
      .input("mode", sql.NVarChar, "U") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("Validation_status", sql.NVarChar, Validation_status)
      .input("Screens", sql.NVarChar, Screens)
      .input("modified_by", sql.NVarChar, modified_by)
      .query(`EXEC sp_Stock_Validation_Status @mode,@company_code,@Validation_status,@Screens,'',@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.status(200).json("Data updated successfully");
  } catch (err) {
    console.error("Error Updating data:", err);
    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};

const deleteStockValue = async (req, res) => {
  const StockValueToDelete = req.body.StockValueToDelete;
  if (!StockValueToDelete || !StockValueToDelete.length) {
    res.status(400).json("Invalid or empty Taskmaster Code array.");
    return;
  }
  try {
    const pool = await connection.connectToDatabase();
    for (const updatedRow of StockValueToDelete) {
      await pool.request()
        .input("mode", sql.NVarChar, "D")
        .input("company_code", sql.NVarChar, updatedRow.company_code)
        .query(`EXEC sp_Stock_Validation_Status @mode,@company_code,'','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    }
    res.json({ message: "Data deleted successfully" });
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const StockSC = async (req, res) => {
  const { company_code, Validation_status, Screens } = req.body;
  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();
    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("company_code", sql.VarChar, company_code)
      .input("Validation_status", sql.VarChar, Validation_status)
      .input("Screens", sql.VarChar, Screens)
      .query(`EXEC sp_Stock_Validation_Status @mode,@company_code,@Validation_status,@Screens,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
// Code Ended by Harish on 13/03/25
// Code Added by Harish on 14/03/25
const EmpSearch = async (req, res) => {
  const { company_code, Employeeid, First_Name, AAdhar_no, marital_status, department_ID, designation_ID,
    manager, Account_NO, shift, PFNo } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("company_code", sql.NVarChar, company_code)
      .input("manager", sql.NVarChar, manager)
      .input("Employeeid", sql.NVarChar, Employeeid)
      .input("First_Name", sql.NVarChar, First_Name)
      .input("department_ID", sql.NVarChar, department_ID)
      .input("designation_ID", sql.NVarChar, designation_ID)
      .input("AAdhar_no", sql.NVarChar, AAdhar_no)
      .input("marital_status", sql.NVarChar, marital_status)
      .input("PFNo", sql.NVarChar, PFNo)
      .input("Account_NO", sql.NVarChar, Account_NO)
      .input("shift", sql.NVarChar, shift)
      .query(`EXEC sp_ess_admin_dashboard @mode,@company_code,@manager,@Employeeid,@First_Name,@department_ID,@designation_ID,@AAdhar_no,@marital_status,@PFNo,@Account_NO,@shift,''
`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
// Code Ended by Harish on 14/03/25
const getAnnouncementDuration = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'AnnounceDuration','','', '' , '','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );
    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

// Code Added by Harish on 18/03/25
const AddFileAttachment = async (req, res) => {
  const { TaskMasterID, DailyTaskID, created_by } = req.body;
  let pool;
  let transaction;

  try {
    pool = await sql.connect(dbConfig);
    transaction = new sql.Transaction(pool);
    await transaction.begin();

    if (!req.files || req.files.length === 0) {
      return res.status(400).json({ message: "No files uploaded" });
    }

    for (const file of req.files) {
      await new sql.Request(transaction)
        .input("TaskMasterID", sql.VarChar, TaskMasterID)
        .input("Files", sql.VarBinary, file.buffer)
        .input("DailyTaskID", sql.NVarChar, DailyTaskID)
        .input("created_by", sql.NVarChar, created_by)
        .input("created_date", sql.DateTime, new Date())
        .query(`
          INSERT INTO tbl_PMS_Task_File_Attachment 
          (TaskMasterID, Files, DailyTaskID, Created_by, created_date)
          VALUES (@TaskMasterID, @Files, @DailyTaskID, @created_by, @created_date)
        `);
    }

    await transaction.commit();
    res.status(200).json({ message: `${req.files.length} files inserted successfully` });

  } catch (err) {
    console.error("Error inserting data:", err);
    if (transaction) {
      try {
        await transaction.rollback();
      } catch (rollbackErr) {
        console.error("Rollback failed:", rollbackErr);
      }
    }
    res.status(500).json({ message: err.message || "Internal Server Error" });

  } finally {
    if (pool) {
      pool.close();
    }
  }
};


// Code Ended by Harish on 18/03/25

const ESSManager = async (req, res) => {
  const { company_code } = req.body;
  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();
    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "M")
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_employee_company @mode,'','','','','','','','','','',@company_code,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL

  `);
    res.json(result.recordset);
  } catch (err) {
    console.error("Error during update:", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//code added by mathu on 20-03-25
const GetClr = async (req, res) => {
  const { company_code } = req.body;
  let pool;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "DD")
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_ess_Employee_dashboard @mode,'',@company_code`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//code ended by mathu

// Code Added by Harish 24/03/25

const getfiles = async (req, res) => {
  const { TaskMasterID } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "GF")
      .input("TaskMasterID", sql.NVarChar, TaskMasterID)
      .query(`EXEC sp_PMS_TaskFile_Attachment @mode,@TaskMasterID,'','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
`);

    if (result.recordsets && result.recordsets.length > 0 && result.recordsets[0].length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
// Code added by Harish 28/03/25

const getprojectSC = async (req, res) => {
  const { ProjectID, ProjectName, ProjectManager, StartDate, EndDate, PriorityLevel, company_code, TaskStatus } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "RR")
      .input("ProjectID", sql.VarChar, ProjectID)
      .input("ProjectName", sql.NVarChar, ProjectName)
      .input("ProjectManager", sql.NVarChar, ProjectManager)
      .input("StartDate", sql.NVarChar, StartDate)
      .input("EndDate", sql.NVarChar, EndDate)
      .input("PriorityLevel", sql.NVarChar, PriorityLevel)
      .input("TaskStatus", sql.NVarChar, TaskStatus)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_ProjectMaster @mode,@ProjectID,@ProjectName,'',@ProjectManager,@StartDate,@EndDate,@PriorityLevel,@TaskStatus,'',@company_code,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

// CODE Ended by Harish 28/03/25

// Code added by Harish 29/03/25

const PMSDashboard = async (req, res) => {
  const { ProjectID } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "PMS")
      .input("ProjectID", sql.VarChar, ProjectID)
      .query(`EXEC SP_PMS_Dashboard @mode,@ProjectID,''`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

// CODE Ended by Harish 29/03/25

//code added by pavun 31-03-25 
//Only holiday date for calender 
const getHolidayDate = async (req, res) => {
  const { EmployeeId, company_code } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "HD")
      .input("EmployeeId", sql.VarChar, EmployeeId)
      .input("company_code", sql.VarChar, company_code)
      .query(`EXEC sp_ess_Employee_dashboard @mode,@EmployeeId,@company_code`);
    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//code ended by pavun

// Code added by Harish 02/04/25
const PMSEmployeechart = async (req, res) => {
  const { ProjectID, userid } = req.body;
  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();
    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "ED")
      .input("ProjectID", sql.VarChar, ProjectID)
      .input("userid", sql.VarChar, userid)
      .query(`EXEC SP_PMS_Dashboard @mode,@ProjectID,@userid`);
    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
// CODE Ended by Harish 02/04/25

//code added by arjun 02/04/25
const AddSalaryCriteria = async (req, res) => {
  const { Start_Year, End_Year, Salary_Days, company_code, status, created_by } = req.body;
  try {
    const pool = await connection.connectToDatabase(dbConfig);
    await pool
      .request()
      .input("mode", sql.NVarChar, "I")
      .input("Start_Year", sql.Date, Start_Year)
      .input("End_Year", sql.Date, End_Year)
      .input("Salary_Days", sql.Int, Salary_Days)
      .input("company_code", sql.NVarChar, company_code)
      .input("status", sql.NVarChar, status)
      .input("created_by", sql.NVarChar, created_by)
      .query(`EXEC sp_ESS_Salary_days  @mode ,@Start_Year,@End_Year,@Salary_Days,@company_code,@status,@created_by,'',null,null,null,null,null,null,null,null
`)
    res.status(200).json("Data Inserted successfully");
  } catch (err) {
    console.error("Error Updating data:", err);
    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};
// const AddSearchCriteria = async (req, res) => {
//   const { Start_Year, End_Year, Salary_Days } = req.body;
//   try {
//     const pool = await connection.connectToDatabase(dbConfig);
//     const result = await pool
//       .request()
//       .input("mode", sql.NVarChar, "SC")
//       .input("Start_Year", sql.NVarChar, Start_Year)
//       .input("End_Year", sql.NVarChar, End_Year)
//       .input("Salary_Days", sql.Int, Salary_Days)
//       .query(`EXEC sp_ESS_Salary_days @mode,@Start_Year,@End_Year,@Salary_Days,'','','','',null,null,null,null,null,null,null,null`)
//     // Send response
//     if (result.recordset.length > 0) {
//       res.status(200).json(result.recordset); // 200 OK if data is found
//     } else {
//       res.status(404).json("Data not found"); // 404 Not Found if no data is found
//     }
//   } catch (err) {
//     console.error("Error", err);
//     res.status(500).json({ message: err.message || 'Internal Server Error' });
//   }
// };
const DeleteSalaryCriteria = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase(dbConfig);
    await pool
      .request()
      .input("mode", sql.NVarChar, "D")
      .input("company_code", sql.NVarChar, company_code)

      .query(`EXEC sp_ESS_Salary_days  @mode,'','','',@company_code,'','','',null,null,null,null,null,null,null,null`)
    res.status(200).json("Data Deleted successfully");
  } catch (err) {
    console.error("Error Updating data:", err);
    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};

//code ended by arjun 02/04/25
//code added by arjun 03-04-25
const UpdateSalaryCriteria = async (req, res) => {
  const { Start_Year, End_Year, Salary_Days, company_code, status } = req.body;

  try {
    const pool = await connection.connectToDatabase(dbConfig);
    await pool
      .request()
      .input("mode", sql.NVarChar, "U") // 'U' for update
      .input("Start_Year", sql.Date, Start_Year)
      .input("End_Year", sql.Date, End_Year)
      .input("Salary_Days", sql.Int, Salary_Days)
      .input("company_code", sql.NVarChar, company_code)
      .input("status", sql.NVarChar, status)
      .query(`
        EXEC sp_ESS_Salary_days
          @mode, @Start_Year, @End_Year, @Salary_Days, @company_code,@status,'', '',null,null,null,null,null,null,null,null
      `);

    res.status(200).json("Data updated successfully");
  } catch (err) {
    console.error("Error updating data:", err);
    res.status(500).json({
      message: err.message || "Internal Server Error",
    });
  }
};
//code ended by arjun

//code Added by Harish on 07-04-25

const GeneratePaySlip = async (req, res) => {
  const { month, company_code, employee_id } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "GPS")
      .input("month", sql.NVarChar, month)
      .input("company_code", sql.NVarChar, company_code)
      .input("employee_id", sql.NVarChar, employee_id)
      .query(`EXEC sp_payslip @mode,@month,@company_code,@employee_id,''`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const GetPaysllipSC = async (req, res) => {
  const { Employeeid, company_code, SalaryDate } = req.body;

  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();

    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("Employeeid", sql.VarChar, Employeeid)
      .input("company_code", sql.NVarChar, company_code)
      .input("SalaryDate", sql.NVarChar, SalaryDate)
      .query(`EXEC sp_ESS_MonthlyPayslip  @mode,@Employeeid,@SalaryDate,'','',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,@company_code,'','','',null,null,null,null,null,null,null,null`);

    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({
      message: err.message || "Internal Server Error",
    });
  }
};

//code Ended by Harish on 07-04-25

//code added by kathir on 09-04-25

const mailgenerating = async (req, res) => {
  const { company_code } = req.body;
  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();
    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "MG")
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_payslip_mail @mode,@company_code,'',''`);
    if (result.rowsAffected && result.rowsAffected[0] > 0) {
      return res.status(200).json({ success: true, message: 'Mail Sended Successfully' });
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//code ended by kathir on 09-04-25
const savePDFToPath = async (req, res) => {
  try {
    const file = req.file;
    const { SalaryMonth } = req.body;

    if (!file || !SalaryMonth) {
      return res.status(400).json({ message: "Missing PDF or SalaryMonth" });
    }

    // Base folder
    const baseFolder = path.resolve("D:/Payslip");

    // Create base Payslip folder if not exists
    if (!fs.existsSync(baseFolder)) {
      fs.mkdirSync(baseFolder, { recursive: true });
    }

    const monthFolder = path.join(baseFolder, SalaryMonth);

    // Create the month folder if not exists
    if (!fs.existsSync(monthFolder)) {
      fs.mkdirSync(monthFolder, { recursive: true });
    }

    const filePath = path.join(monthFolder, file.originalname);

    // Save PDF to disk
    fs.writeFileSync(filePath, file.buffer);

    return res.status(200).json({
      success: true,
      message: "PDF saved successfully",
      path: filePath,
    });
  } catch (err) {
    console.error("Error saving PDF:", err);
    return res.status(500).json({ message: err.message });
  }
};

//code added by kathir on 09-04-2025

const GetPaysllipTemplate = async (req, res) => {
  const { company_code } = req.body;
  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();
    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "PST")
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_ESS_MonthlyPayslip  @mode,'','','','',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,@company_code,'','','',null,null,null,null,null,null,null,null`);
    // Send response
    res.json(result.recordset);
  } catch (err) {
    console.error(err);
    res.status(500).json({
      message: err.message || "Internal Server Error",
    });
  }
};

//code ended by kathir on 09-04-25

//code added by pavun on 11-04-25

const sendPayslipEmails = async (req, res) => {
  const { SalaryMonth, payslips } = req.body;

  try {
    const baseFolder = path.resolve(`D:/Payslip/${SalaryMonth}`);

    // Store file list for ZIP creation
    const filesToZip = [];

    /* ============================
       SEND INDIVIDUAL EMPLOYEE MAILS
       ============================ */
    for (const slip of payslips) {

      const empIdLower = slip.EmployeeId.toLowerCase();
      const fileName = `${empIdLower}_${slip.company_code}_Payslip_${SalaryMonth}.pdf`;
      const filePath = path.join(baseFolder, fileName);

      console.log("Searching:", filePath);

      if (!fs.existsSync(filePath)) {
        console.warn(`âš  FILE MISSING: ${filePath}`);
        continue;
      }

      // Store for ZIP creation
      filesToZip.push({ path: filePath, name: fileName });

      // Send email to employee
      const mailOptions = {
        from: "alert@yjktechnologies.com",
        to: slip.mail_id,
        cc: ["saraswathi.pv@yjktechnologies.com", "jk@yjktechnologies.com"],
        subject: `Payslip - ${SalaryMonth}`,
        text: `Dear ${slip.employeename},\n\nPlease find attached your payslip for ${SalaryMonth}.`,
        attachments: [
          {
            filename: fileName,
            path: filePath
          }
        ]
      };

      await transporter.sendMail(mailOptions);
      console.log(`âœ” Sent to Employee: ${slip.mail_id}`);
    }

    /* ================================
       CREATE ZIP USING ARCHIVER
       ================================ */
    const zipPath = path.join(baseFolder, `Payslips_${SalaryMonth}.zip`);

    await new Promise((resolve, reject) => {
      const output = fs.createWriteStream(zipPath);
      const archive = archiver("zip", { zlib: { level: 9 } });

      output.on("close", () => {
        console.log(`âœ” ZIP Created: ${zipPath} (${archive.pointer()} bytes)`);
        resolve();
      });

      archive.on("error", (err) => reject(err));

      archive.pipe(output);

      filesToZip.forEach((file) => {
        archive.file(file.path, { name: file.name });
      });

      archive.finalize();
    });

    /* =================================
       SEND ZIP MAIL TO TEAM
       ================================= */
    const consolidatedMail = {
      from: "alert@yjktechnologies.com",
      to: "saraswathi.pv@yjktechnologies.com",
      cc: ["jk@yjktechnologies.com"],
      subject: `All Employee Payslips - ${SalaryMonth}`,
      text: `Dear Team,\n\nAttached is the ZIP file containing all employee payslips for ${SalaryMonth}.`,
      attachments: [
        {
          filename: `Payslips_${SalaryMonth}.zip`,
          path: zipPath
        }
      ]
    };

    await transporter.sendMail(consolidatedMail);
    console.log("âœ” ZIP Mail Sent to Saraswathi & JK");

    return res.status(200).json({
      message: "Individual and ZIP Payslip mails sent successfully"
    });

  } catch (err) {
    console.error("Error:", err);
    return res.status(500).json({ message: err.message });
  }
};

//code ended by pavun on 11-04-25

//code added by mathu -12-04-2025
const salarySearchoption = async (req, res) => {
  const { Start_Year, End_Year, Salary_Days, company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("Start_Year", sql.NVarChar, Start_Year)
      .input("End_Year", sql.NVarChar, End_Year)
      .input("Salary_Days", sql.NVarChar, Salary_Days)
      .input("company_code", sql.NVarChar, company_code)

      .query(`EXEC sp_ESS_Salary_days  @mode ,@Start_Year,@End_Year,@Salary_Days,@company_code,'','','',null,null,null,null,null,null,null,null`)
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data Not Found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const UpdateSalary = async (req, res) => {
  const editedData = req.body.editedData;

  if (!editedData || !editedData.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase();
    for (const updatedRow of editedData) {
      await pool
        .request()
        .input("mode", sql.NVarChar, "U")
        .input("Start_Year", sql.Date, updatedRow.Start_Year)
        .input("End_Year", sql.Date, updatedRow.End_Year)
        .input("Salary_Days", sql.Int, updatedRow.Salary_Days)
        .input("company_code", sql.NVarChar, updatedRow.company_code)
        .input("modified_by", sql.NVarChar, updatedRow.modified_by)
        .query(`EXEC sp_ESS_Salary_days @mode ,@Start_Year,@End_Year,@Salary_Days,@company_code,'','',@modified_by,null,null,null,null,null,null,null,null`)
    }
    res.status(200).json("Data Updated Successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const salaryDelete = async (req, res) => {
  const editedData = req.body.editedData;

  if (!editedData || !editedData.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase();
    for (const updatedRow of editedData) {
      await pool
        .request()
        .input("mode", sql.NVarChar, "D")
        // .input("company_code",         sql.NVarChar,req.headers['company_code'])
        .input("company_code", sql.NVarChar, updatedRow.company_code)
        .query(`EXEC sp_ESS_Salary_days  @mode ,'','','',@company_code,'','','',null,null,null,null,null,null,null,null`)
    }
    res.status(200).json("Data Deleted Successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//code ended by mathu
// Code Added by Harish on 15-04-25

const AddEmpDoc = async (req, res) => {
  const employeeData = req.body.employeeData;
  if (!employeeData || !employeeData.length) {
    res.status(400).json("Invalid or empty employeeData array.");
    return;
  }
  try {
    const pool = await connection.connectToDatabase(dbConfig);
    for (const insertRow of employeeData) {
      let document_files = insertRow.document_files || null;
      if (document_files) {
        const buffer = Buffer.from(document_files, 'base64');
        document_files = buffer;
      }
      await pool
        .request()
        .input("mode", sql.NVarChar, "I")
        .input("EmployeeId", insertRow.EmployeeId)
        .input("document_name", insertRow.document_name)
        .input("document_files", document_files)
        .input("keyfield", insertRow.keyfield)
        .input("company_code", insertRow.company_code)
        .input("created_by", insertRow.created_by)
        .input("modified_by", insertRow.modified_by)
        .input("tempstr1", insertRow.tempstr1)
        .input("tempstr2", insertRow.tempstr2)
        .input("tempstr3", insertRow.tempstr3)
        .input("tempstr4", insertRow.tempstr4)
        .input("datetime1", insertRow.datetime1)
        .input("datetime2", insertRow.datetime2)
        .input("datetime3", insertRow.datetime3)
        .input("datetime4", insertRow.datetime4)
        .query(`EXEC sp_ess_employee_documents @mode,@EmployeeId,@document_name,@document_files,@keyfield,@company_code,'',@created_by,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    }
    res.status(200).json("Employee document data inserted successfully");
  } catch (err) {
    console.error("Error inserting data:", err);
    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};


const delempdoc = async (req, res) => {
  const keyfieldsToDelete = req.body.keyfieldsToDelete;
  if (!keyfieldsToDelete || !keyfieldsToDelete.length) {
    res.status(400).json("Invalid or empty keyfields array.");
    return;
  }
  try {
    const pool = await connection.connectToDatabase();
    for (const record of keyfieldsToDelete) {
      const { keyfield, company_code } = record;
      await pool
        .request()
        .input("keyfield", sql.NVarChar, keyfield)
        .input("company_code", sql.NVarChar, company_code)
        .query(`EXEC sp_ess_employee_documents 'D','','','',@keyfield,@company_code,'','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    }
    res.status(200).json("Employee document data deleted successfully");
  } catch (err) {
    console.error("Error inserting data:", err);
    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};

const getAllempdoc = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(
      `EXEC sp_ess_employee_documents 'A','','','','','','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`
    );
    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getempdoc = async (req, res) => {
  const { Id, company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "EDG")
      .input("Id", sql.NVarChar, Id)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_employee_getdata @mode,@Id,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//code ended by harish on 15-04-25

//code added by pavun on 15-04-25

const getDocument = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query("EXEC sp_attribute_Info 'F',@company_code,'DocumentType','','', '','','', NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL");

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//code ended by pavun on 15-04-25


//code added by mathu-15-04-2025
const getapplyLeavetype = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "F")
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_LeaveTypes @mode,@company_code,'','','','','',0,0,'','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//code ended by mathu on 15-04-25


// const updateempDoc = async (req, res) => {
//   const editedData = req.body.editedData;
//   if (!editedData || !editedData.length) {
//     res.status(400).json("Invalid or empty editedData array.");
//     return;
//   }
//   try {
//     const pool = await connection.connectToDatabase(dbConfig);
//     for (const updatedRow of editedData) {

//   let document_files = updatedRow.document_files || null;
//   if (document_files) {
//     const buffer = Buffer.from(document_files, 'base64');
//     document_files = buffer;
//   }
//       await pool
//         .request()
//         .input("mode", sql.NVarChar, "U")
//         .input("EmployeeId", updatedRow.EmployeeId)
//         .input("document_name", updatedRow.document_name)
//         .input("document_files", updatedRow.document_files)
//         .input("keyfield", updatedRow.keyfield)
//         .input("modified_by", updatedRow.modified_by)
//         .input("company_code", updatedRow.company_code)
//         .query(`EXEC sp_ess_employee_documents @mode,@EmployeeId,@document_name,@document_files,@keyfield,@company_code,'','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
//     }
//     res.status(200).json("Employee family data updated successfully");
//   } catch (err) {
//     console.error("Error inserting data:", err);
//     res.status(500).json({
//       message: err.message || "Internal Server Error"
//     });
//   }
// };

//code added by pavun on 21-04-25
const sendAutoMail = async (req, res) => {
  const { email } = req.body;

  try {
    const mailOptions = {
      from: 'alert@yjktechnologies.com',
      to: email,
      subject: 'Working Hours Exceeded',
      text: 'You have worked more than 8 hours today. Please take a break!'
    };

    await transporter.sendMail(mailOptions);
    res.status(200).json({ message: 'Mail sent successfully' });
  } catch (error) {
    res.status(500).json({ message: 'Failed to send mail', error });
  }
};
// code ended by pavun on 21-04-25

//code added by pavun on 07-05-25

const addAssertAllocationReturnHdr = async (req, res) => {
  const { company_code, allocation_no, allocation_date, return_date, return_person, return_reason, created_by } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I")
      .input("company_code", sql.NVarChar, company_code)
      .input("allocation_no", sql.NVarChar, allocation_no)
      .input("allocation_date", sql.Date, allocation_date)
      .input("return_date", sql.Date, return_date)
      .input("return_person", sql.NVarChar, return_person)
      .input("return_reason", sql.NVarChar, return_reason)
      .input("created_by", sql.NVarChar, created_by)
      .query(`EXEC sp_Assets_Allocation_return_hdr @mode,@company_code,@allocation_no,@allocation_date,'',@return_date,@return_person,@return_reason,@created_by,'',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`)
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getAssertAllocationReturnHdr = async (req, res) => {
  const { company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "A")
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_Assets_Allocation_return_hdr @mode,@company_code,'','','','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`)
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const addAssetsAllocationReturnDetails = async (req, res) => {
  const { company_code, allocation_no, allocation_date, return_no, return_date, item_SNO, item_code, item_name, Emp_no, Serial_no,
    Quantity, return_qty, return_person, return_reason, created_by } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    await pool
      .request()
      .input("mode", sql.NVarChar, "I")
      .input("company_code", sql.VarChar, company_code)
      .input("allocation_no", sql.NVarChar, allocation_no)
      .input("allocation_date", sql.Date, allocation_date)
      .input("return_no", sql.NVarChar, return_no)
      .input("return_date", sql.Date, return_date)
      .input("item_SNO", sql.BigInt, item_SNO)
      .input("item_code", sql.VarChar, item_code)
      .input("item_name", sql.VarChar, item_name)
      .input("Emp_no", sql.VarChar, Emp_no)
      .input("Serial_no", sql.NVarChar, Serial_no)
      .input("Quantity", sql.Int, Quantity)
      .input("return_qty", sql.Int, return_qty)
      .input("return_person", sql.NVarChar, return_person)
      .input("return_reason", sql.NVarChar, return_reason)
      .input("created_by", sql.VarChar, created_by)
      .query(`EXEC sp_Assets_Allocation_Return_Details @mode,@company_code,@allocation_no,@allocation_date,@return_no,@return_date,@item_SNO,@item_code,@item_name,
        @Emp_no,@Serial_no,@Quantity,@return_qty,@return_person,@return_reason,@created_by,'',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.json({ success: true, message: "Data Inserted Successfully" });
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getAssetsAllocationReturnDetails = async (req, res) => {
  const { company_code } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "A")
      .input("company_code", sql.VarChar, company_code)
      .query(`EXEC sp_Assets_Allocation_Return_Details @mode,@company_code,'','','','',0,'','','','',0,0,'','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getallAssetsAllocationReturn = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "AR")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_getdata @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    if (result.recordsets && result.recordsets.length > 0 && result.recordsets[0].length > 0) {
      const data = {
        Header: result.recordsets[0],
        Details: result.recordsets[1] || []
      };
      res.status(200).json(data);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const searchCriteriaAssertReturn = async (req, res) => {
  const { company_code, allocation_no, allocation_date, return_no, return_date, return_person, return_reason, Serial_no, Quantity } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("company_code", sql.NVarChar, company_code)
      .input("allocation_no", sql.NVarChar, allocation_no)
      .input("allocation_date", sql.NVarChar, allocation_date)
      .input("return_no", sql.NVarChar, return_no)
      .input("return_date", sql.NVarChar, return_date)
      .input("return_person", sql.NVarChar, return_person)
      .input("return_reason", sql.NVarChar, return_reason)
      .query(`EXEC sp_Assets_Allocation_return_hdr @mode,@company_code,@allocation_no,@allocation_date,@return_no,@return_date,@return_person,@return_reason,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`)
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getAssertReturnDetail = async (req, res) => {
  const { company_code, transaction_no } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "ARD")
      .input("company_code", sql.NVarChar, company_code)
      .input("transaction_no", sql.NVarChar, transaction_no)
      .query(`EXEC sp_getdata @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//code ended by pavun on 07-05-25

//code added by pavun on 08-05-25

const assetsEmployeeId = async (req, res) => {
  const { EmployeeId, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "EI")
      .input("EmployeeId", sql.NVarChar, EmployeeId)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_employee_personal  @mode,@EmployeeId,'','','','','','','','','','','','','','','','','','','','','','','',@company_code,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//code ended by pavun on 08-05-25

//code added by pavun on 09-05-25

const updateRoleRights = async (req, res) => {
  const { company_code, role_id, screen_type, permission_type, keyfield, modified_by } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    await pool
      .request()
      .input("mode", sql.NVarChar, "U")
      .input("company_code", sql.VarChar, company_code)
      .input("role_id", sql.VarChar, role_id)
      .input("screen_type", sql.NVarChar, screen_type)
      .input("permission_type", sql.VarChar, permission_type)
      .input("keyfield", sql.VarChar, keyfield)
      .input("modified_by", sql.NVarChar, modified_by)
      .query(`EXEC sp_rolescreen_mapping @mode,@company_code, @role_id, @screen_type, @permission_type, @keyfield,'', @modified_by,  
               NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL`)
    res.status(200).json("Edited data saved successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const salesTermsandCondition = async (req, res) => {
  const { bill_no, company_code, Terms_conditions, created_by } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.VarChar, company_code)
      .input("bill_no", sql.NVarChar, bill_no)
      .input("Terms_conditions", sql.VarChar, Terms_conditions)
      .input("created_by", sql.NVarChar, created_by)
      .query(`EXEC sp_Terms_conditions_Sales @mode,@company_code,@bill_no,@Terms_conditions,@created_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.status(200).json("Data Inserted successfully");
  } catch (err) {
    console.error("Error inserting data:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const deleteSalesTermsandCondition = async (req, res) => {
  const { bill_no, company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    await pool
      .request()
      .input("mode", sql.NVarChar, "D")
      .input("company_code", sql.NVarChar, company_code)
      .input("bill_no", sql.NVarChar, bill_no)
      .query(`EXEC sp_Terms_conditions_Sales @mode,@company_code,@bill_no,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.status(200).json("data deleted successfully");
  } catch (err) {
    console.error("Error inserting data:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const getAllSalesTermsandCondition = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql.query(`EXEC sp_Terms_conditions_Sales 'A','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.json(result.recordset);
  } catch (err) {
    console.error("Error inserting data:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

//code ended by pavun on 09-05-25

//code added by pavun on 10-05-25

const termsandCondition = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_attribute_Info 'F',@company_code,'Terms&Conditions','','', '' , '','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getTermsandConditionSales = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "STC")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_getdata @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getDeletedTermsSales = async (req, res) => {
  const { transaction_no, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "DSTC")
      .input("transaction_no", sql.NVarChar, transaction_no)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_getdata @mode,@transaction_no,@company_code,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL `);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const customerCodeDropdown = async (req, res) => {
  const { company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "CC")
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_customer_details_info @mode,'',@company_code,'','','','','','','','','','','','','','','','','',0,'','','','','','','','','','',NULL,NULL,NULL,null,null,null,null,null`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//code ended by pavun on 10-05-25

//code added by kathir on 12-05-25

const AddFinacnialyearlockscreen = async (req, res) => {
  const { start_year, end_year, transaction_type, locked, company_code, created_by } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    await pool
      .request()
      .input("mode", sql.NVarChar, "I")
      .input("start_year", sql.Date, start_year)
      .input("end_year", sql.Date, end_year)
      .input("transaction_type", sql.VarChar, transaction_type)
      .input("locked", sql.VarChar, locked)
      .input("company_code", sql.VarChar, company_code)
      .input("created_by", sql.VarChar, created_by)
      .query(`EXEC sp_financial_year_accessing @mode,@start_year,@end_year,@transaction_type,@locked,@company_code,'',@created_by,'',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.status(200).json("Data Inserted successfully");
  } catch (err) {
    console.error("Error inserting data:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const deleteFinacnialyearlockscreen = async (req, res) => {
  const keyfieldToDelete = req.body.keyfield;


  const pool = await connection.connectToDatabase();
  for (const keyfield of keyfieldToDelete) {
    try {
      await pool.request()


        .input("mode", sql.NVarChar, "D")
        .input("keyfield", sql.NVarChar, keyfield)
        .query(`EXEC sp_financial_year_accessing @mode,'','','','','',@keyfield,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
      res.status(200).json("data deleted successfully");
    } catch (err) {
      if (err.number === 50000) {
        // Foreign key constraint violation
        res.status(400).json("The user rights cannot be deleted due to a link with another record");
        return;
      } else {
        throw err; // Rethrow other SQL errors
      }
    }
  }
}



const SelectFinacnialyearlockscreen = async (req, res) => {
  const { company_code } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "A")
      .input("company_code", sql.VarChar, company_code)
      .query(`EXEC sp_financial_year_accessing @mode,'','','','',@company_code,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const UpdateFinacnialyearlockscreen = async (req, res) => {
  const editedData = req.body.editedData;
  if (!editedData || !editedData.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }
  try {
    const pool = await connection.connectToDatabase(dbConfig);
    for (const updatedRow of editedData) {
      await pool
        .request()
        .input("mode", sql.NVarChar, "U") // update mode
        .input("company_code", sql.NVarChar, req.headers['company_code'])
        .input("start_year", sql.NVarChar, updatedRow.start_year)
        .input("end_year", sql.NVarChar, updatedRow.end_year)
        .input("transaction_type", sql.NVarChar, updatedRow.transaction_type)
        .input("locked", sql.NVarChar, updatedRow.locked)
        .input("keyfield", sql.NVarChar, updatedRow.keyfield)
        .input("modified_by", sql.NVarChar, req.headers['modified-by'])
        .query(`EXEC sp_financial_year_accessing @mode,@start_year,@end_year,@transaction_type,@locked,@company_code,@keyfield,'',@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    }
    res.status(200).json("Edited data saved successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const deleteFinacnialyearlockscreenGrid = async (req, res) => {
  const FinacnialyearToDelete = req.body.FinacnialyearToDelete;
  if (!FinacnialyearToDelete || !FinacnialyearToDelete.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }
  try {
    const pool = await connection.connectToDatabase();
    for (const updatedRow of FinacnialyearToDelete) {
      await pool
        .request()
        .input("mode", sql.NVarChar, "D")
        .input("keyfield", sql.NVarChar, updatedRow.keyfield)
        .input("company_code", sql.NVarChar, req.headers['company_code'])
        .query(`EXEC sp_financial_year_accessing @mode,'','','','','',@keyfield,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    }
    res.status(200).json("Data Deleted Successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getFinacnialyearlockscreenSearchCriteria = async (req, res) => {
  const { start_year, end_year, transaction_type, locked, company_code } = req.body;
  try {
    // Connect to the database
    const pool = await connection.connectToDatabase();
    // Execute the query
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("company_code", sql.NVarChar, company_code)
      .input("start_year", sql.NVarChar, start_year)
      .input("end_year", sql.NVarChar, end_year)
      .input("transaction_type", sql.NVarChar, transaction_type)
      .input("locked", sql.NVarChar, locked)
      .query(`EXEC sp_financial_year_accessing @mode,@start_year,@end_year,@transaction_type,@locked,@company_code,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//code ended by kathir on 12-05-25
//code added by mathu on 12-05-25

const getLockType = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'Lock_Type','','', '' ,'','', NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//code ended by mathu on 12-05-25

//code added by pavun on 13-05-25

const vendorCodeDropdown = async (req, res) => {
  const { company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "VC")
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_vendor_details_info_hdr @mode,'',@company_code,'','','','','','','','','','' ,'','','','','','','',0,'','','','','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    if (result.recordset && result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//code ended by pavun on 13-05-25

//code added by Mathu-13-05-2025

const UpdateFinacnialyearlock = async (req, res) => {
  const { company_code, start_year, end_year, transaction_type, locked, keyfield, modified_by } = req.body;
  let pool;
  try {
    const pool = await connection.connectToDatabase(dbConfig);

    await pool
      .request()
      .input("mode", sql.NVarChar, "U") // update mode
      .input("company_code", sql.NVarChar, company_code)
      .input("start_year", sql.NVarChar, start_year)
      .input("end_year", sql.NVarChar, end_year)
      .input("transaction_type", sql.NVarChar, transaction_type)
      .input("locked", sql.NVarChar, locked)
      .input("keyfield", sql.NVarChar, keyfield)
      .input("modified_by", sql.NVarChar, modified_by)
      .query(`EXEC sp_financial_year_accessing @mode,@start_year,@end_year,@transaction_type,@locked,@company_code,@keyfield,'',@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    res.status(200).json("Edited data saved successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//Code Ended by Mathu-13-05-2025

//Code added by pavun on 14-05-25

const TotalActiveEmployees = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "EP")
      .input("company_code", sql.VarChar, company_code)
      .query(`EXEC sp_ESS_payslip_dashboard @mode,@company_code,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordset && result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error inserting data:", err);
    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};

const TotalNetEarnings = async (req, res) => {
  const { company_code } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SA")
      .input("company_code", sql.VarChar, company_code)
      .query(`EXEC sp_ESS_payslip_dashboard @mode,@company_code,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordset && result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const TotalPayslips = async (req, res) => {
  const { company_code } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "MP")
      .input("company_code", sql.VarChar, company_code)
      .query(`EXEC sp_ESS_payslip_dashboard @mode,@company_code,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordset && result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//Code ended by pavun on 14-05-25
// Code Added by Harish on 15-05-25

const EmployeeDocSC = async (req, res) => {
  const { company_code, Employee_Id, document_name, Name } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("Employee_ID", sql.NVarChar, Employee_Id)
      .input("document_name", sql.NVarChar, document_name)
      .input("company_code", sql.NVarChar, company_code)
      .input("Name", sql.NVarChar, Name)
      .query(`EXEC sp_ess_employee_documents @mode,@Employee_ID,@document_name	,'','',@company_code,@Name,'','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
`)
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

// Code Added by Harish on 19-05-2025
const PrintTemplates = async (req, res) => {
  const { Screen_Type } = req.body;
  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "PT")
      .input("Screen_Type", sql.NVarChar, Screen_Type)
      .query(`EXEC sp_transaction_settings_test_2 @mode,'','','','','','','',@Screen_Type,'','','','',0,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const AddPrintTemplate = async (req, res) => {

  const employeeData = req.body.employeeData;

  if (!employeeData || !employeeData.length) {
    res.status(400).json("Invalid or empty employeeId array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase(dbConfig);
    for (const insertRow of employeeData) {
      let Templates = insertRow.Templates || null;
      if (Templates) {
        const buffer = Buffer.from(Templates, 'base64');
        insertRow.Templates = buffer;
      }

      await pool
        .request()
        .input("mode", sql.NVarChar, "I")
        .input("Templates", insertRow.Templates)
        .input("Screens", insertRow.Screens)
        .input("Template_name", insertRow.Template_name)
        .input("created_by", insertRow.created_by)
        .input("modified_by", insertRow.modified_by)
        .query(
          `EXEC sp_Print_templates @mode, @Templates, 0, @Screens, @Template_name, '', @created_by, '', null, null, null, null, null, null, null, null`
        );
    }
    return res.status(200).json({ success: true, message: 'Data inserted successfully' });
  } catch (err) {
    console.error("Error ", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const Templatesearch = async (req, res) => {
  const { Screens, Template_name } = req.body;
  try {
    const pool = await connection.connectToDatabase(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("Screens", sql.NVarChar, Screens)
      .input("Template_name", sql.NVarChar, Template_name)
      .query(`EXEC sp_Print_templates @mode,'',0,@Screens,@Template_name,'','','',null,null,null,null,null,null,null,null`)
    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const getPrint = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'Print_options','','', '','','', NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getcopies = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'Print_copies','','', '','','', NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
// Code Added by Harish on 19-05-2025

//code added by pavun on 16-05-25

const getSalesItemCode = async (req, res) => {
  const { company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SI")
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC [sp_item_brand_info] @mode,@company_code,'','','',0,'','','',0,0,0,0,'','','','','','','','','','','','','',0,0,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//code ended by pavun on 16-05-25

// Code  Added by Harish on 24-05-25

const AddClientBugs = async (req, res) => {
  const { Project, Task, Date, Screens, company_code, Description, Client_user, created_by } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    await pool
      .request()
      .input("mode", sql.NVarChar, "I")
      .input("Date", sql.Date, Date)
      .input("Task	", sql.Date, Task)
      .input("Project	", sql.VarChar, Project)
      .input("Screens	", sql.VarChar, Screens)
      .input("Description", sql.VarChar, Description)
      .input("Client_user", sql.VarChar, Client_user)
      .input("@company_code", sql.VarChar, company_code)
      .input("created_by", sql.VarChar, created_by)
      .query(`EXEC sp_Client_bugs @mode,'',@Date,@Task,@Project,@Screens,@Description,@Client_user,'','','',@company_code,@created_by,'',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
`);
    res.status(200).json("Data Inserted successfully");
  } catch (err) {
    console.error("Error inserting data:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const DeleteClientBugs = async (req, res) => {
  const { sno, company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    await pool
      .request()
      .input("mode", sql.NVarChar, "D")
      .input("company_code", sql.NVarChar, company_code)
      .input("sno", sql.NVarChar, sno)
      .query(`EXEC sp_Client_bugs @mode,@sno,'','','','','','','','','',@company_code,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
`);
    res.status(200).json("data deleted successfully");
  } catch (err) {
    console.error("Error inserting data:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const UpdateClientBugs = async (req, res) => {
  const { company_code, Date, sno, Task, Project, Screens, Description, Client_user, modified_by } = req.body;
  let pool;
  try {
    const pool = await connection.connectToDatabase(dbConfig);

    await pool
      .request()
      .input("mode", sql.NVarChar, "U") // update mode
      .input("company_code", sql.NVarChar, company_code)
      .input("sno", sql.BigInt, sno)
      .input("Date", sql.NVarChar, Date)
      .input("Task", sql.NVarChar, Task)
      .input("Project", sql.NVarChar, Project)
      .input("Screens", sql.NVarChar, Screens)
      .input("Description", sql.NVarChar, Description)
      .input("Client_user", sql.NVarChar, Client_user)
      .input("modified_by", sql.NVarChar, modified_by)
      .query(`EXEC sp_Client_bugs @mode,@sno,@Date,@Task,@Project,@Screens,@Description,@Client_user,'','','',@company_code,'',@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.status(200).json("Edited data saved successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const getClientbugs = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_Client_bugs @mode,'','','','','','','','','','',@company_code,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

// Code Added by Harish on 14/06/25
const WeekOff = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'Week_Off','','', '','','', NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );
    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//Code added by pavun on 17-06-25
const addCRMClient = async (req, res) => {
  const { company_code, contact_no, company_name, Contact_name, client_name, client_email, Expected_revenue, Monthly_revenue, created_by } = req.body;
  try {
    const pool = await connection.connectToDatabase(dbConfig);

    await pool
      .request()
      .input("mode", sql.NVarChar, "I") // update mode
      .input("company_code", sql.NVarChar, company_code)
      .input("company_name", sql.VarChar, company_name)
      .input("contact_no", sql.NVarChar, contact_no)
      .input("Contact_name", sql.NVarChar, Contact_name)
      .input("client_name", sql.NVarChar, client_name)
      .input("client_email", sql.NVarChar, client_email)
      .input("Expected_revenue", sql.Decimal(10, 2), Expected_revenue)
      .input("Monthly_revenue", sql.Decimal(10, 2), Monthly_revenue)
      .input("created_by", sql.NVarChar, created_by)
      .query(`EXEC sp_CRM_Clients @mode,@company_code,@company_name,@contact_no,@Contact_name,@client_name,@client_email,@Expected_revenue,@Monthly_revenue,'',@created_by,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.status(200).json("data saved successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const updateCRMClient = async (req, res) => {
  const { company_code, contact_no, company_name, Contact_name, client_name, client_email, Expected_revenue, Monthly_revenue, modified_by } = req.body;
  try {
    const pool = await connection.connectToDatabase(dbConfig);

    await pool
      .request()
      .input("mode", sql.NVarChar, "U") // update mode
      .input("company_code", sql.NVarChar, company_code)
      .input("company_name", sql.VarChar, company_name)
      .input("contact_no", sql.NVarChar, contact_no)
      .input("Contact_name", sql.VarChar, Contact_name)
      .input("client_name", sql.VarChar, client_name)
      .input("client_email", sql.NVarChar, client_email)
      .input("Expected_revenue", sql.Decimal(10, 2), Expected_revenue)
      .input("Monthly_revenue", sql.Decimal(10, 2), Monthly_revenue)
      .input("modified_by", sql.NVarChar, modified_by)
      .query(`EXEC sp_CRM_Clients @mode,@company_code,@company_name,@contact_no,@Contact_name,@client_name,@client_email,@Expected_revenue,@Monthly_revenue,'','','','',@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.status(200).json("data updated successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const deleteCRMClient = async (req, res) => {
  const { contact_no } = req.body;
  try {
    const pool = await connection.connectToDatabase(dbConfig);

    await pool
      .request()
      .input("mode", sql.NVarChar, "D")
      .input("contact_no", sql.NVarChar, contact_no)
      .query(`EXEC sp_CRM_Clients @mode,'','',@contact_no,'','','',0,0,'','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.status(200).json("data deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getCRMClient = async (req, res) => {
  const { contact_no } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("contact_no", sql.NVarChar, contact_no)
      .query(`EXEC sp_CRM_Clients 'A','','',@contact_no,'','','',0,0,'','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const CRMClientSearch = async (req, res) => {
  const { company_code, contact_no, company_name, Contact_name, client_name, client_email, Expected_revenue, Monthly_revenue } = req.body;
  try {
    const pool = await connection.connectToDatabase(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("company_code", sql.NVarChar, company_code)
      .input("company_name", sql.VarChar, company_name)
      .input("contact_no", sql.NVarChar, contact_no)
      .input("Contact_name", sql.VarChar, Contact_name)
      .input("client_name", sql.VarChar, client_name)
      .input("client_email", sql.NVarChar, client_email)
      .input("Expected_revenue", sql.Decimal(10, 2), Expected_revenue)
      .input("Monthly_revenue", sql.Decimal(10, 2), Monthly_revenue)
      .query(`EXEC sp_CRM_Clients @mode,@company_code,@company_name,@contact_no,@Contact_name,@client_name,@client_email,@Expected_revenue,@Monthly_revenue,'','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`)
    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const addCRMContacts = async (req, res) => {
  const { Name, contact_no, email, Address, Country, company_code, Screen_mode, Contact_info_id, Notes, company_name, contact_name, type_of_contact, Aadhar, Pan, Contact_ID, status, created_by } = req.body;
  let Image = null;

  if (req.file) {
    Image = req.file.buffer; // Buffer containing the uploaded image
  }
  try {
    const pool = await connection.connectToDatabase(dbConfig);

    await pool
      .request()
      .input("mode", sql.NVarChar, "I") // update mode
      .input("Name", sql.VarChar, Name)
      .input("contact_no", sql.NVarChar, contact_no)
      .input("email", sql.VarChar, email)
      .input("Address", sql.VarChar, Address)
      .input("Country", sql.VarChar, Country)
      .input("Aadhar", sql.VarChar, Aadhar)
      .input("Pan", sql.VarChar, Pan)
      .input("company_code", sql.VarChar, company_code)
      .input("Image", sql.VarBinary, Image)
      .input("Screen_mode", sql.VarChar, Screen_mode)
      .input("Notes", sql.VarChar, Notes)
      .input("Contact_info_id", sql.Int, Contact_info_id)
      .input("company_name", sql.VarChar, company_name)
      .input("contact_name", sql.VarChar, contact_name)
      .input("type_of_contact", sql.VarChar, type_of_contact)
      .input("Contact_ID", sql.Int, Contact_ID)
      .input("status", sql.NVarChar, status)
      .input("created_by", sql.NVarChar, created_by)
      .query(`EXEC sp_CRM_Contacts @mode,@Name,@contact_no,@email,@Address,@Country,@Aadhar,@Pan,'',@company_code,@Image,@Screen_mode,@Notes,@Contact_info_id,@company_name,@contact_name,@type_of_contact,@Contact_ID,@status,@created_by,'',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.status(200).json("data saved successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const updateCRMContacts = async (req, res) => {
  const { Name, contact_no, email, Address, company_code, Country, Aadhar, Pan, company_name, contact_name, type_of_contact, keyfield, status, modified_by } = req.body;
  try {
    const pool = await connection.connectToDatabase(dbConfig);

    await pool
      .request()
      .input("mode", sql.NVarChar, "U") // update mode
      .input("Name", sql.VarChar, Name)
      .input("contact_no", sql.NVarChar, contact_no)
      .input("email", sql.VarChar, email)
      .input("Address", sql.VarChar, Address)
      .input("Country", sql.VarChar, Country)
      .input("Aadhar", sql.VarChar, Aadhar)
      .input("Pan", sql.VarChar, Pan)
      .input("company_name", sql.VarChar, company_name)
      .input("contact_name", sql.VarChar, contact_name)
      .input("type_of_contact", sql.VarChar, type_of_contact)
      .input("keyfield", sql.VarChar, keyfield)
      .input("company_code", sql.NVarChar, company_code)
      .input("status", sql.NVarChar, status)
      .input("modified_by", sql.NVarChar, modified_by)
      .query(`EXEC sp_CRM_Contacts @mode,@Name,@contact_no,@email,@Address,@Country,@Aadhar,@Pan,@keyfield,@company_code,NULL,'','',0,@company_name,@contact_name,@type_of_contact,0,@status,'',@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.status(200).json("data updated successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const deleteCRMContacts = async (req, res) => {
  const { company_code, Contact_ID, Contact_info_id } = req.body;
  try {
    const pool = await connection.connectToDatabase(dbConfig);
    await pool
      .request()
      .input("mode", sql.NVarChar, "D")
      .input("company_code", sql.NVarChar, company_code)
      .input("ContactID", sql.Int, Contact_ID)
      .input("Contact_info_id", sql.Int, Contact_info_id)
      .query(`EXEC sp_CRM_Contacts @mode,'','','','','','','','',@company_code,'','','',@Contact_info_id,'','','',@ContactID,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.status(200).json("data deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getCRMContacts = async (req, res) => {
  const { keyfield } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("keyfield", sql.NVarChar, keyfield)
      .query(`EXEC sp_CRM_Contacts 'A','','','','','','','',@keyfield,'','','','',0,'','','',0,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getCRMContactName = async (req, res) => {
  try {
    await connection.connectToDatabase();
    const result = await sql
      .query(`EXEC sp_CRM_Contacts 'F','','','','','','','','','','','','',0,'','','',0,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//Code ended by pavun on 17-06-25

// Code Added by harish on 17-06-25
const GenerateEmployee = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'GenerateEmpId','','', '','','', NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );
    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//Code added by pavun on 18-06-25

const openingTicketSearch = async (req, res) => {
  const { ProjectID, userID, TaskTitle, StartDate, EndDate, TaskStatus, PriorityLevel, company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "OTB")
      .input("ProjectID", sql.VarChar, ProjectID)
      .input("userID", sql.VarChar, userID)
      .input("TaskTitle", sql.VarChar, TaskTitle)
      .input("StartDate", sql.VarChar, StartDate)
      .input("EndDate", sql.VarChar, EndDate)
      .input("TaskStatus", sql.VarChar, TaskStatus)
      .input("PriorityLevel", sql.NVarChar, PriorityLevel)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_TaskMaster @mode,'',@TaskTitle,'',@ProjectID,@userID,@StartDate,@EndDate,'','',@TaskStatus,@PriorityLevel,'',@company_code,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getUserCode = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "EI")
      .input("company_code", sql.VarChar, company_code)
      .query(`EXEC sp_TaskMaster 'EI','','','','','','','','','','','','',@company_code,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result && result.recordset && result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json({ message: "Data Not Found" });
    }
  } catch (err) {
    console.error("SQL Error:", err);
    res.status(500).json({ message: "Internal Server Error", error: err.message });
  }
};

//Code ended by pavun on 18-06-25
//Code added by Murugavel on 18-06-2025

const AddWeekOff = async (req, res) => {
  const WeekOffData = req.body.WeekOffData;
  if (!WeekOffData || !WeekOffData.length) {
    res.status(400).json("Invalid or empty WeekOffData array.");
    return;
  }
  try {
    const pool = await connection.connectToDatabase(dbConfig);
    for (const insertRows of WeekOffData) {
      await pool
        .request()
        .input("mode", sql.NVarChar, "I") // Insert mode
        .input("week_off_days", insertRows.week_off_days)
        .input("company_code", insertRows.company_code)
        .input("Status", insertRows.Status)
        .input("Permission_Starts", sql.Decimal(12, 2), insertRows.Permission_Starts)
        .input("Permission_Ends", sql.Decimal(12, 2), insertRows.Permission_Ends)
        .input("Halfday_Starts", sql.Decimal(12, 2), insertRows.Halfday_Starts)
        .input("Halfday_Ends", sql.Decimal(12, 2), insertRows.Halfday_Ends)
        .input("created_by", insertRows.created_by)
        .input("tempstr1", insertRows.tempstr1)
        .input("tempstr2", insertRows.tempstr2)
        .input("tempstr3", insertRows.tempstr3)
        .input("tempstr4", insertRows.tempstr4)
        .input("datetime1", insertRows.datetime1)
        .input("datetime2", insertRows.datetime2)
        .input("datetime3", insertRows.datetime3)
        .input("datetime4", insertRows.datetime4)
        .query(
          `EXEC sp_setting_screen_weekoff @mode,@week_off_days,@company_code,@Status,'',@Permission_Starts,@Permission_Ends,@Halfday_Starts,@Halfday_Ends,@created_by,'',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    }
    res.status(200).json("WeekOff data inserted successfully");
  }
  catch (err) {
    console.error("Error inserting data:", err); res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
}
// const AddWeekOff = async (req, res) => {
//   const { 
//     week_off_days,
//     company_code,
//     Status,
//     created_by,
//     tempstr1,
//     tempstr2,
//     tempstr3,
//     tempstr4,
//     datetime1,
//     datetime2,
//     datetime3,
//     datetime4,
//   } = req.body;
//   let pool;
//   try {
//     pool = await sql.connect(dbConfig);
//     const result = await pool
//       .request()
//       .input("mode", sql.NVarChar, "I") // Insert mode
//       .input("week_off_days",sql.VarChar, week_off_days)
//       .input("company_code", insertRow. company_code)
//       .input("Status", insertRow. Status)
//       .input("created_by", insertRow. created_by)
//       .input("tempstr1",insertRow. tempstr1)
//       .input("tempstr2", insertRow. tempstr2)
//       .input("tempstr3", sql.NVarChar, tempstr3)
//       .input("tempstr4", sql.NVarChar, tempstr4)
//       .input("datetime1", sql.NVarChar, datetime1)
//       .input("datetime2", sql.NVarChar, datetime2)
//       .input("datetime3", sql.NVarChar, datetime3)
//       .input("datetime4", sql.NVarChar, datetime4)
//       .query(
//         `EXEC sp_setting_screen_weekoff @mode,@week_off_days,@company_code,@Status,'',@created_by,'',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

//     // Return success response
//     if (result.rowsAffected && result.rowsAffected[0] > 0) {
//       return res.status(200).json({ success: true, message: 'Data inserted successfully' });
//     }
//   } catch (err) {
//     console.error("Error", err);
//     res.status(500).json({ message: err.message || 'Internal Server Error' });
//   }
// };

// const AddWeekOff = async (req, res) => {
//   const {
//     week_off_days,
//     company_code,
//     created_by,
//     Status,
//     tempstr1,
//     tempstr2,
//     tempstr3,
//     tempstr4,
//     datetime1,
//     datetime2,
//     datetime3,
//     datetime4,
//   } = req.body;
//   let pool;
//   try {
//     pool = await sql.connect(dbConfig);
//     const result = await pool
//       .request()
//       .input("mode", sql.NVarChar, "I") // Insert mode
//       .input("week_off_days", sql.VarChar, week_off_days)
//       .input("company_code", sql.NVarChar, company_code)
//       .input("Status", sql.NVarChar, Status)
//       .input("created_by", sql.NVarChar, created_by)
//       .input("tempstr1", sql.NVarChar, tempstr1)
//       .input("tempstr2", sql.NVarChar, tempstr2)
//       .input("tempstr3", sql.NVarChar, tempstr3)
//       .input("tempstr4", sql.NVarChar, tempstr4)
//       .input("datetime1", sql.NVarChar, datetime1)
//       .input("datetime2", sql.NVarChar, datetime2)
//       .input("datetime3", sql.NVarChar, datetime3)
//       .input("datetime4", sql.NVarChar, datetime4)
//       .query(
//         `EXEC sp_setting_screen_weekoff @mode,@week_off_days,@company_code,'',@Status,'',@created_by,'',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
//     // Return success response
//     if (result.rowsAffected && result.rowsAffected[0] > 0) {
//       return res.status(200).json({ success: true, message: 'Data inserted successfully' });
//     }
//   } catch (err) {
//     if (err.class === 16 && err.number === 50000) {
//       // Custom error from the stored procedure
//       res.status(400).json({ message: 'Opening balance already exists' });
//     } else {
//       // Handle unexpected errors
//       res.status(500).json({ message: err.message || 'Internal Server Error' });
//     }
//   }
// };

const deleteWeekOff = async (req, res) => {
  const keyfieldsToDelete = req.body.keyfieldsToDelete;

  if (!keyfieldsToDelete || !keyfieldsToDelete.length) {
    res.status(400).json("Invalid or empty keyfields array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase(dbConfig);
    for (const record of keyfieldsToDelete) {
      const { keyfield } = record;
      await pool
        .request()
        .input("mode", sql.NVarChar, "D")
        .input("keyfield", sql.NVarChar, keyfield)
        .query(`EXEC sp_setting_screen_weekoff @mode,'','','',@keyfield,0,0,0,0,'' ,'',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    }
    res.status(200).json("data deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const updateWeekOff = async (req, res) => {
  const editedData = req.body.editedData;
  if (!editedData || !editedData.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase(dbConfig);
    for (const updatedRow of editedData) {
      await pool
        .request()
        .input("mode", sql.NVarChar, "U") // update mode
        .input("week_off_days", updatedRow.week_off_days)
        .input("company_code", updatedRow.company_code)
        .input("Status", updatedRow.Status)
        .input("keyfield", updatedRow.keyfield)
        .input("Permission_Starts", updatedRow.Permission_Starts)
        .input("Permission_Ends", updatedRow.Permission_Ends)
        .input("Halfday_Starts", updatedRow.Halfday_Starts)
        .input("Halfday_Ends", updatedRow.Halfday_Ends)
        .input("modified_by", updatedRow.modified_by)
        .query(`EXEC sp_setting_screen_weekoff @mode,@week_off_days,@company_code,@Status,'',@Permission_Starts,@Permission_Ends,@Halfday_Starts,@Halfday_Ends,@created_by,'',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    }
    res.status(200).json("data updated successfully");
  } catch (err) {
    console.error("Error inserting data:", err);

    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};

const getWeekOff = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_setting_screen_weekoff 'A','',@company_code,'','',0,0,0,0,'' ,'',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const AddGenerateEmployee = async (req, res) => {
  const {
    employee_id,
    company_code,
    Status,
    created_by,
    tempstr1,
    tempstr2,
    tempstr3,
    tempstr4,
    datetime1,
    datetime2,
    datetime3,
    datetime4,
  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("employee_id", sql.VarChar, employee_id)
      .input("company_code", sql.NVarChar, company_code)
      .input("Status", sql.NVarChar, Status)
      .input("created_by", sql.NVarChar, created_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(`EXEC sp_setting_generate_employeeid @mode,@employee_id, @company_code,'',@created_by,'',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    // Return success response
    if (result.rowsAffected && result.rowsAffected[0] > 0) {
      return res.status(200).json({ success: true, message: 'Data inserted successfully' });
    }
  } catch (err) {
    console.error("Error inserting data:", err); res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};


const deleteGenerateEmployee = async (req, res) => {
  const { employee_id } = req.body;
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase(dbConfig);
    await pool
      .request()
      .input("mode", sql.NVarChar, "D")
      .input("employee_id", sql.NVarChar, employee_id)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_setting_generate_employeeid @mode, @employee_id, @company_code,'','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.status(200).json("data deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};



const getGenerateEmployee = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_setting_generate_employeeid 'A', '', @company_code,'','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//Code ended by Murugavel on 18-06-2025

//Code added by Murugavel on 19-06-2025

const FetchWeekOff = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_setting_screen_weekoff 'AA','',@company_code,'','',0,0,0,0,'' ,'',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const FetchGenerateEmployee = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_setting_generate_employeeid 'FE', '', @company_code,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//Code ended by Murugavel on 19-06-2025

//code added by harish on 20-06-2025
const GetUserCheckIN = async (req, res) => {
  const { userid } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "FC")
      .input("userid", sql.NVarChar, userid)
      .query(` EXEC sp_DailyLogin @mode,@userid,'','','','','','','','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
`);
    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//code ended by harish on 20-06-25

//code added by pavun on 23-06-25

const getLeaveStatus = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "F")
      .input("company_code", sql.NVarChar, company_code)
      .query("EXEC sp_attribute_Info 'F',@company_code,'LeaveStatus','','', '' ,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL");

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//code ended by pavun on 23-06-25


// Code Adde By Harish on 24-06-25
const AddPMSSetting = async (req, res) => {
  const {
    Per_Day_Working_hours,
    company_code,
    Status,
    created_by,
    tempstr1,
    tempstr2,
    tempstr3,
    tempstr4,
    datetime1,
    datetime2,
    datetime3,
    datetime4,
  } = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("Per_Day_Working_hours", sql.Int, Per_Day_Working_hours)
      .input("company_code", sql.NVarChar, company_code)
      .input("Status", sql.NVarChar, Status)
      .input("created_by", sql.NVarChar, created_by)
      .input("tempstr1", sql.NVarChar, tempstr1)
      .input("tempstr2", sql.NVarChar, tempstr2)
      .input("tempstr3", sql.NVarChar, tempstr3)
      .input("tempstr4", sql.NVarChar, tempstr4)
      .input("datetime1", sql.NVarChar, datetime1)
      .input("datetime2", sql.NVarChar, datetime2)
      .input("datetime3", sql.NVarChar, datetime3)
      .input("datetime4", sql.NVarChar, datetime4)
      .query(`EXEC sp_setting_screen_PMS @mode,'',@Per_Day_Working_hours,@company_code,@Status,@created_by,'',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    // Return success response
    if (result.rowsAffected && result.rowsAffected[0] > 0) {
      return res.status(200).json({ success: true, message: 'Data inserted successfully' });
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const deletePMSsettings = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase(dbConfig);
    await pool
      .request()
      .input("mode", sql.NVarChar, "D")
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_setting_screen_PMS @mode,'','',@company_code,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.status(200).json("data deleted successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const GetPMSsettings = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "A")
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_setting_screen_PMS @mode,'','',@company_code,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const PMSsettingsUpdate = async (req, res) => {
  const { Per_Day_Working_hours, company_code, Status, modified_by
  } = req.body;
  try {
    const pool = await connection.connectToDatabase();

    await pool
      .request()
      .input("mode", sql.NVarChar, "U")
      .input("Per_Day_Working_hours", sql.Int, Per_Day_Working_hours)
      .input("company_code", sql.NVarChar, company_code)
      .input("Status", sql.NVarChar, Status)
      .input("modified_by", sql.NVarChar, modified_by)
      .query(`EXEC sp_setting_screen_PMS @mode,'',@Per_Day_Working_hours,@company_code,@Status,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    res.status(200).json("Edited data saved successfully");
  } catch (error) {
    if (error.class === 16 && error.number === 50000) {
      // Custom error from the stored procedure
      res.status(400).json({ message: error.message });
    } else {
      // Handle unexpected errors
      res.status(500).json({ message: 'Internal Server Error', error: error.message });
    }
  }
};

const SettingEmployeeUpdate = async (req, res) => {
  const { employee_id, company_code, modified_by } = req.body;
  try {
    const pool = await connection.connectToDatabase();

    await pool
      .request()
      .input("mode", sql.NVarChar, "U")
      .input("employee_id", sql.NVarChar, employee_id)
      .input("company_code", sql.NVarChar, company_code)
      .input("modified_by", sql.NVarChar, modified_by)
      .query(`EXEC sp_setting_generate_employeeid @mode,@employee_id,@company_code,'','',@modified_by,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
`);

    res.status(200).json("Edited data saved successfully");
  } catch (error) {
    if (error.class === 16 && error.number === 50000) {
      // Custom error from the stored procedure
      res.status(400).json({ message: error.message });
    } else {
      // Handle unexpected errors
      res.status(500).json({ message: 'Internal Server Error', error: error.message });
    }
  }
};


const ESSEmployeeDashboard = async (req, res) => {
  const { start_date, end_date, userid, company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "ED")
      .input("start_date", sql.Date, start_date)
      .input("end_date", sql.Date, end_date)
      .input("userid", sql.VarChar, userid)
      .input("company_code", sql.VarChar, company_code)
      .query(`EXEC sp_task_hour_report @mode,@start_date,@end_date,@userid,'',@company_code,0,''`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//code added by pavun on 24-06-25

const getAnnouncementText = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "ANC")
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_Announcement @mode,'','','','','','','','','','','','',@company_code,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getManager = async (req, res) => {
  const { company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_ess_admin_dashboard 'GM',@company_code,'','','','','','','','','','',''`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//code ended by pavun on 24-06-25

//code added by pavun on 25-06-25
const getCheckInStatus = async (req, res) => {
  const { userID, company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, 'CICO')
      .input("userID", sql.NVarChar, userID)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_DailyLogin @mode,@userID,'','','','','','','','',@company_code,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//code ended by pavun on 25-06-25

//CODE ADDED BY Harish 28/06/25
const Getpayslip = async (req, res) => {
  const { company_code, Employeeid, salary_month } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, 'FPY')
      .input("Employeeid", sql.NVarChar, Employeeid)
      .input("company_code", sql.NVarChar, company_code)
      .input("salary_month", sql.NVarChar, salary_month)
      .query(`EXEC sp_ESS_MonthlyPayslip  'FPY',@Employeeid	,'','','',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,@company_code,@salary_month,'','',null,null,null,null,null,null,null,null
`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//code added by pavun on 30-06-25

const getEmployeeId = async (req, res) => {
  const { company_code } = req.body
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_employee_personal 'FE','','','','','','','','','','','','','','','','','','','','','','','','',@company_code,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//code ended by pavun on 30-06-25

//Code added by pavun on 07-07-25

const DashboardOverallAttendanceData = async (req, res) => {
  const { manager, company_code, LeaveStatus } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, 'OAD')
      .input("manager", sql.NVarChar, manager)
      .input("company_code", sql.NVarChar, company_code)
      .input("LeaveStatus", sql.NVarChar, LeaveStatus)
      .query(`EXEC sp_ess_admin_dashboard @mode,@company_code,@manager,'','','','','','','','','',@LeaveStatus`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const getEmployeeCheckInCheckOut = async (req, res) => {
  const { start_date, userid, company_code, Status } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "EC")
      .input("start_date", sql.Date, start_date)
      .input("userid", sql.VarChar, userid)
      .input("company_code", sql.VarChar, company_code)
      .input("Status", sql.VarChar, Status)
      .query(`EXEC sp_task_hour_report @mode,@start_date,'',@userid,'',@company_code,0, @Status`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

//Code Ended by pavun on 07-07-25

//code added by Mathu -17-07-2025
const getTaskUserID = async (req, res) => {
  const { company_code } = req.body;
  if (!company_code) {
    return res.status(400).json({ message: "company_code is required" });
  }
  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, 'FE')
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_task_hour_report_Mathu 'FE','','','','','@company_code',0,''
`);
    res.json(result.recordset);
  } catch (err) {
    console.error("Error:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};
//code Ended by Mathu-17-07-2025
//Code Added by HARISH ON 30-08-25

const PMS_Client_infoInsert = async (req, res) => {
  const { Client_code, Company_or_Personal, CompanyName, Product_URL, Phone, GSTIn, Website, Tag, Stage, Address1, Address2, Address3, City, Zip, State, Country, Notes, created_by, ExpectedRevenue, Payment, Product, Email, Payment_Mode, Payment_Type, Client_Company_code, Client_Database, Last_Payment, Live_Date, Company_code } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    await pool.request()
      .input("mode", sql.NVarChar, "I")
      .input("Client_code", sql.NVarChar, Client_code)
      .input("Company_or_Personal", sql.NVarChar, Company_or_Personal)
      .input("CompanyName", sql.NVarChar, CompanyName)
      .input("Phone", sql.NVarChar, Phone)
      .input("GSTIn", sql.NVarChar, GSTIn)
      .input("Website", sql.NVarChar, Website)
      .input("Tag", sql.NVarChar, Tag)
      .input("Stage", sql.NVarChar, Stage)
      .input("Address1", sql.NVarChar, Address1)
      .input("Address2", sql.NVarChar, Address2)
      .input("Address3", sql.NVarChar, Address3)
      .input("City", sql.NVarChar, City)
      .input("Zip", sql.NVarChar, Zip)
      .input("State", sql.NVarChar, State)
      .input("Country", sql.NVarChar, Country)
      .input("Notes", sql.NVarChar, Notes)
      .input("ExpectedRevenue", sql.Decimal(12, 2), ExpectedRevenue)
      .input("Payment", sql.Decimal(12, 2), Payment)
      .input("Product", sql.NVarChar, Product)
      .input("Email", sql.NVarChar, Email)
      .input("Payment_Mode", sql.NVarChar, Payment_Mode)
      .input("Payment_Type", sql.NVarChar, Payment_Type)
      .input("Last_Payment", sql.Date, Last_Payment)
      .input("Live_Date", sql.Date, Live_Date)
      .input("Product_URL", sql.NVarChar, Product_URL)
      .input("Client_Company_code", sql.NVarChar, Client_Company_code)
      .input("Client_Database", sql.NVarChar, Client_Database)
      .input("Company_code", sql.NVarChar, Company_code)
      .input("created_by", sql.NVarChar, created_by)
      .query(`EXEC sp_PMS_Client_info @mode,0, @Client_code	, @Company_or_Personal, @CompanyName, @Phone, @GSTIn, @Website, @Tag, @Stage, @Address1, @Address2, @Address3, @City, @Zip, @State, @Country, @Notes, @ExpectedRevenue, @Payment, @Product, @Email, @Payment_Mode, @Payment_Type, @Last_Payment, @Live_Date,@Product_URL,@Client_Company_code,@Client_Database, @Company_code,'',@created_by,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    res.status(200).json({ success: true, message: "PMS_Client_info insertd successfully" });
  } catch (err) {
    console.error("Error during PMS_Client_info insert:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const PMS_Client_infoUpdate = async (req, res) => {
  const { ContactID, Client_code, Company_or_Personal, CompanyName, Phone, GSTIn, Website, Tag, Stage, Address1, Address2, Address3, City, modified_by, Zip, State, Country, Notes, ExpectedRevenue, Payment, Product, Product_URL, Email, Payment_Mode, Payment_Type, Last_Payment, Live_Date, Client_Company_code, Client_Database, Company_code } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    await pool.request()
      .input("mode", sql.NVarChar, "U")
      .input("ContactID", sql.Int, ContactID)
      .input("Client_code", sql.NVarChar, Client_code)
      .input("Company_or_Personal", sql.NVarChar, Company_or_Personal)
      .input("CompanyName", sql.NVarChar, CompanyName)
      .input("Phone", sql.NVarChar, Phone)
      .input("GSTIn", sql.NVarChar, GSTIn)
      .input("Website", sql.NVarChar, Website)
      .input("Tag", sql.NVarChar, Tag)
      .input("Stage", sql.NVarChar, Stage)
      .input("Address1", sql.NVarChar, Address1)
      .input("Address2", sql.NVarChar, Address2)
      .input("Address3", sql.NVarChar, Address3)
      .input("City", sql.NVarChar, City)
      .input("Zip", sql.NVarChar, Zip)
      .input("State", sql.NVarChar, State)
      .input("Country", sql.NVarChar, Country)
      .input("Notes", sql.NVarChar, Notes)
      .input("ExpectedRevenue", sql.Decimal(12, 2), ExpectedRevenue)
      .input("Payment", sql.Decimal(12, 2), Payment)
      .input("Product", sql.NVarChar, Product)
      .input("Email", sql.NVarChar, Email)
      .input("Payment_Mode", sql.NVarChar, Payment_Mode)
      .input("Payment_Type", sql.NVarChar, Payment_Type)
      .input("Last_Payment", sql.Date, Last_Payment)
      .input("Live_Date", sql.Date, Live_Date)
      .input("Product_URL", sql.NVarChar, Product_URL)
      .input("Client_Company_code", sql.NVarChar, Client_Company_code)
      .input("Client_Database", sql.NVarChar, Client_Database)
      .input("Company_code", sql.NVarChar, Company_code)
      .input("modified_by", sql.NVarChar, modified_by)
      .query(`EXEC sp_PMS_Client_info @mode, @ContactID	, @Client_code	, @Company_or_Personal, @CompanyName, @Phone, @GSTIn, @Website, @Tag, @Stage, @Address1, @Address2, @Address3, @City, @Zip, @State, @Country, @Notes, @ExpectedRevenue, @Payment, @Product, @Email, @Payment_Mode, @Payment_Type, @Last_Payment, @Live_Date,@Product_URL,@Client_Company_code,@Client_Database, @Company_code,'','','',@modified_by,'',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    res.status(200).json({ success: true, message: "PMS_Client_info updated successfully" });
  } catch (err) {
    console.error("Error during PMS_Client_info update:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};


const PMS_Client_infoDelete = async (req, res) => {
  const { Client_code, Company_code } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    await pool.request()
      .input("mode", sql.NVarChar, "D")
      .input("Client_code", sql.NVarChar, Client_code)
      .input("Company_code", sql.NVarChar, Company_code)
      .query(`EXEC sp_PMS_Client_info @mode, ''	, @Client_code	, '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', 0, 0, '', '', '', '', '', '','','','', @Company_code,'','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    res.status(200).json({ success: true, message: "PMS_Client_info deleted successfully" });
  } catch (err) {
    console.error("Error during PMS_Client_info delete:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};


const GetPaymentMode = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'PaymentMode','','', '','','', NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );
    res.json(result.recordset);
  } catch (err) {
    console.error("Error during update:", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
const GetPaymentType = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'PaymentType','','', '','','', NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );
    res.json(result.recordset);
  } catch (err) {
    console.error("Error during update:", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


const GetClientInfoSearch = async (req, res) => {
  const { Client_code, Company_or_Personal, Product, address1, company_code, Payment_Mode, Last_Payment, Payment, CompanyName, Payment_Type, Phone, Email } = req.body;
  try {

    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("Client_code", sql.NVarChar, Client_code)
      .input("CompanyName", sql.NVarChar, CompanyName)
      .input("Company_or_Personal", sql.NVarChar, Company_or_Personal)
      .input("Phone", sql.NVarChar, Phone)
      .input("Product", sql.NVarChar, Product)
      .input("Email", sql.NVarChar, Email)
      .input("Payment_Type", sql.NVarChar, Payment_Type)
      .input("Payment", sql.Decimal(12, 2), Payment)
      .input("Payment_Mode", sql.NVarChar, Payment_Mode)
      .input("address1", sql.NVarChar, address1)
      .input("Company_code", sql.NVarChar, company_code)
      .input("Last_Payment", sql.NVarChar, Last_Payment)
      .query(`EXEC sp_PMS_Client_INFO @mode,0,@Client_code,@Company_or_Personal,@CompanyName,@Phone,'','','','',@Address1,'','','','','','','',0,@Payment,@Product,@Email,@Payment_Mode,@Payment_Type,@Last_Payment,'','','','',@Company_code,'','','','','',NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL  
`);
    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const PMS_Client_infoLoopUpdate = async (req, res) => {
  const PMS_Client_infoData = req.body.PMS_Client_infoData;
  if (!PMS_Client_infoData || !PMS_Client_infoData.length) {
    return res.status(400).json("Invalid or empty PMS_Client_infoData array.");
  }
  try {
    const pool = await sql.connect(dbConfig);
    for (const item of PMS_Client_infoData) {
      await pool.request()
        .input("mode", sql.NVarChar, "U")
        .input("Client_code", sql.NVarChar, item.Client_code)
        .input("Company_or_Personal", sql.NVarChar, item.Company_or_Personal)
        .input("CompanyName", sql.NVarChar, item.CompanyName)
        .input("Phone", sql.NVarChar, item.Phone)
        .input("GSTIn", sql.NVarChar, item.GSTIn)
        .input("Website", sql.NVarChar, item.Website)
        .input("Tag", sql.NVarChar, item.Tag)
        .input("Stage", sql.NVarChar, item.Stage)
        .input("Address1", sql.NVarChar, item.Address1)
        .input("Address2", sql.NVarChar, item.Address2)
        .input("Address3", sql.NVarChar, item.Address3)
        .input("City", sql.NVarChar, item.City)
        .input("Zip", sql.NVarChar, item.Zip)
        .input("State", sql.NVarChar, item.State)
        .input("Country", sql.NVarChar, item.Country)
        .input("Notes", sql.NVarChar, item.Notes)
        .input("ExpectedRevenue", sql.Decimal(12, 2), item.ExpectedRevenue)
        .input("Payment", sql.Decimal(12, 2), item.Payment)
        .input("Product", sql.NVarChar, item.Product)
        .input("Email", sql.NVarChar, item.Email)
        .input("Payment_Mode", sql.NVarChar, item.Payment_Mode)
        .input("Payment_Type", sql.NVarChar, item.Payment_Type)
        .input("Last_Payment", sql.Date, item.Last_Payment)
        .input("Live_Date", sql.Date, item.Live_Date)
        .input("Product_URL", sql.NVarChar, item.Product_URL)
        .input("Company_code", sql.NVarChar, item.Company_code)
        .input("keyfield", sql.NVarChar, item.keyfield)
        .input("modified_by", sql.NVarChar, item.modified_by)
        .input("modified_date", sql.NVarChar, item.modified_date)
        .query(`EXEC sp_PMS_Client_info @mode, 0, @Client_code	, @Company_or_Personal, @CompanyName, @Phone, @GSTIn, @Website, @Tag, @Stage, @Address1, @Address2, @Address3, @City, @Zip, @State, @Country, @Notes, @ExpectedRevenue, @Payment, @Product, @Email, @Payment_Mode, @Payment_Type, @Last_Payment, @Live_Date,@Product_URL,'','', @Company_code, @keyfield,'','', @modified_by,'',null,null,null,null,null,null,null,null`);
    }
    res.status(200).json("PMS_Client_info data updated successfully");
  } catch (err) {
    console.error("Error in PMS_Client_infoLoopUpdate:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

// Code Added by Harish 02/09/2025
const PMS_Client_infoLoopDelete = async (req, res) => {
  const PMS_Client_infoDelete = req.body.PMS_Client_infoDelete;
  if (!PMS_Client_infoDelete || !PMS_Client_infoDelete.length) {
    return res.status(400).json("Invalid or empty deleted Doctor Id array.");
  }
  try {
    const pool = await sql.connect(dbConfig);
    for (const deletedRow of PMS_Client_infoDelete) {
      await pool.request()
        .input("mode", sql.NVarChar, "D")
        .input("Client_code", sql.VarChar, deletedRow.Client_code)
        .input("company_code", sql.NVarChar, req.headers['company_code'])
        .query(`EXEC sp_PMS_Client_INFO @mode,0,@Client_code,'','','','','','','','','','','','','','','',0,0,'','','','','','','','','',@Company_code,'','','','','',NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL`);
    }
    res.status(200).json({ success: true, message: "Data deleted successfully" });
  } catch (err) {
    console.error("Error during delete:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const Client_PaymentInsert = async (req, res) => {
  const { Client_code, Payment_Date, Payment_type, Notes, Payment, Product_ID, Keyfield, Company_code, created_by, created_date } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    await pool.request()
      .input("mode", sql.NVarChar, "I")
      .input("Client_code", sql.NVarChar, Client_code)
      .input("Payment_Date", sql.Date, Payment_Date)
      .input("Payment_type", sql.NVarChar, Payment_type)
      .input("Payment", sql.Decimal(12, 2), Payment)
      .input("Notes", sql.NVarChar, Notes)
      .input("Product_ID", sql.NVarChar, Product_ID)
      .input("Company_code", sql.NVarChar, Company_code)
      .input("created_by", sql.NVarChar, created_by)
      .input("created_date", sql.NVarChar, created_date)
      .query(`EXEC sp_Client_Payment @mode,'', @Client_code, @Payment_Date, @Payment_type, @Payment, @Notes,@Product_ID,'',@Company_code, @created_by, @created_date,'', '',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    res.status(200).json({ success: true, message: "Client_Payment insertd successfully" });
  } catch (err) {
    console.error("Error during Client_Payment insert:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const Client_PaymentUpdate = async (req, res) => {
  const editedData = req.body.editedData;

  if (!editedData || !editedData.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }

  try {
    const pool = await sql.connect(dbConfig);
    for (const updatedRow of editedData) {
      await pool
        .request()
        .input("mode", sql.NVarChar, "U")
        .input("Client_code", updatedRow.Client_code)
        .input("Payment_Date", updatedRow.Payment_Date)
        .input("Payment_type", updatedRow.Payment_Type)
        .input("Payment", updatedRow.Payment)
        .input("Notes", updatedRow.Notes)
        .input("Keyfield", updatedRow.Keyfield)
        .input("Company_code", sql.NVarChar, req.headers['company_code'])
        .input("modified_by", sql.NVarChar, req.headers['modified_by'])
        .query(`EXEC sp_Client_Payment @mode,0, @Client_code, @Payment_Date, @Payment_type, @Payment, @Notes,'',@Keyfield,@Company_code,'', '', @modified_by, '',NUll,NUll,NUll,NUll,NUll,NUll,NUll,NUll`);
    }
    res.status(200).json({ success: true, message: "Client_Payment updated successfully" });
  } catch (err) {
    console.error("Error during Client_Payment update:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const Client_PaymentDelete = async (req, res) => {
  const keyfieldToDelete = req.body.keyfieldToDelete;

  if (!keyfieldToDelete || !keyfieldToDelete.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }

  try {
    const pool = await sql.connect(dbConfig);
    for (const deletedRow of keyfieldToDelete) {
      await pool
        .request()
        .input("mode", sql.NVarChar, "D")
        .input("Keyfield", deletedRow.Keyfield)
        .input("Company_code", sql.NVarChar, req.headers['company_code'])
        .query(`EXEC sp_Client_Payment @mode,0,'','','',0,'','',@Keyfield,@Company_code,'','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    }
    res.status(200).json({ success: true, message: "Client_Payment deleted successfully" });
  } catch (err) {
    console.error("Error during Client_Payment delete:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const Client_PaymentLoopUpdate = async (req, res) => {
  const Client_PaymentData = req.body.Client_PaymentData;
  if (!Client_PaymentData || !Client_PaymentData.length) {
    return res.status(400).json("Invalid or empty Client_PaymentData array.");
  }

  try {
    const pool = await sql.connect(dbConfig);
    for (const item of Client_PaymentData) {
      await pool.request()
        .input("mode", sql.NVarChar, "U")
        .input("Client_code", sql.NVarChar, item.Client_code)
        .input("Payment_Date", sql.Date, item.Payment_Date)
        .input("Payment_type", sql.NVarChar, item.Payment_type)
        .input("Payment", sql.Decimal(12, 2), item.Payment)
        .input("Notes", sql.NVarChar, item.Notes)
        .input("Product_ID", sql.NVarChar, item.Product_ID)
        .input("Keyfield", sql.NVarChar, item.Keyfield)
        .input("Company_code", sql.NVarChar, item.Company_code)
        .input("modified_by", sql.NVarChar, item.modified_by)
        .query(`EXEC sp_Client_Payment @mode,'', @Client_code, @Payment_Date, @Payment_type, @Payment,@Product_ID,@Keyfield,@Company_code, '','', @modified_by,'',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    }
    res.status(200).json("Client_Payment data updated successfully");
  } catch (err) {
    console.error("Error in Client_PaymentLoopUpdate:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const Client_PaymentLoopDelete = async (req, res) => {
  const Client_PaymentData = req.body.Client_PaymentData;
  if (!Client_PaymentData || !Client_PaymentData.length) {
    return res.status(400).json("Invalid or empty Client_PaymentData array.");
  }

  try {
    const pool = await sql.connect(dbConfig);
    for (const item of Client_PaymentData) {
      await pool.request()
        .input("mode", sql.NVarChar, "D")
        .input("Keyfield", sql.NVarChar, item.Keyfield)

        .query(`EXEC sp_Client_Payment @mode,'','', '','',0,'','',@Keyfield,'','','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    }
    res.status(200).json("Client_Payment data deleted successfully");
  } catch (err) {
    console.error("Error in Client_PaymentLoopDelete:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

//Code Added by Harish 03/09/25
// const GetClient_PaymentData = async (req,res) => {
//   const {Client_code,Company_code} = req.body;
//   try {
//     const pool = await connection.connectToDatabase();

//     const result = await pool
//       .request()
//       .input("mode", sql.NVarChar, 'FC')
//       .input("Client_code", sql.NVarChar, Client_code)
//       .input("Company_code", sql.NVarChar, Company_code)
//         .query(`EXEC sp_Client_Payment @mode, @Client_code,'','', 0,'',@Company_code, '','', '','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

//     res.json(result.recordset);
//   } catch (err) {
//     console.error("Error:", err);
//     res.status(500).json({ message: err.message || "Internal Server Error" });
//   }
// };

const GetClient_PaymentData = async (req, res) => {
  const { Client_code, Company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, 'FC')
      .input("Client_code", sql.NVarChar, Client_code)
      .input("Company_code", sql.NVarChar, Company_code)
      .query(`EXEC sp_Client_Payment @mode,'', @Client_code,'','', 0,'','','',@Company_code, '','', '','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
const GetClient_PaymentDataSearch = async (req, res) => {
  const { Client_code, Payment_Type, Payment_Date, Payment, Company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, 'SCC')
      .input("Client_code", sql.NVarChar, Client_code)
      .input("Payment_Type", sql.NVarChar, Payment_Type)
      .input("Company_code", sql.NVarChar, Company_code)
      .input("Payment_Date", sql.NVarChar, Payment_Date)
      .input("Payment", sql.Decimal(12, 2), Payment)
      .query(`EXEC sp_Client_Payment @mode, '',@Client_code,@Payment_Date,@Payment_Type,@Payment,'','','',@Company_code, '','', '','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const CRM_NewCompanyInsert = async (req, res) => {
  const {
    CompanyID, OpportunityName, Followups_jobposition, Followup_Pincode, Followup_State,
    Followup_Country, Followup_CompanyName, Followup_CompanyAddress1, Followup_City, Followup_CompanyAddress2,
    SalesTeam_Code, Sales_man_code, Medium_ID, Referred_BY, Source_ID, campaignID, Contact_Followups, ContactName,
    Priority, Email_ID, ContactPhone, ExpectedRevenue, Payment, PaymentType, ExpectedClosing, Stage, Website, company_code,
    Status, Contact_ID, keyfield, sourceType, Created_by
  } = req.body;
  try {
    const pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I")
      .input("CompanyID", sql.Int, CompanyID)
      .input("OpportunityName", sql.NVarChar, OpportunityName)
      .input("ContactName", sql.NVarChar, ContactName)
      .input("ContactPhone", sql.NVarChar, ContactPhone)
      .input("ExpectedRevenue", sql.Decimal(12, 2), ExpectedRevenue)
      .input("Payment", sql.Decimal(12, 2), Payment)
      .input("PaymentType", sql.NVarChar, PaymentType)
      .input("ExpectedClosing", sql.Date, ExpectedClosing)
      .input("Email_ID", sql.NVarChar, Email_ID)
      .input("Priority", sql.NVarChar, Priority)
      .input("Contact_Followups", sql.NVarChar, Contact_Followups)
      .input("Followups_jobposition", sql.NVarChar, Followups_jobposition)
      .input("Sales_man_code", sql.NVarChar, Sales_man_code)
      .input("campaignID", sql.NVarChar, campaignID)
      .input("Medium_ID", sql.NVarChar, Medium_ID)
      .input("Source_ID", sql.NVarChar, Source_ID)
      .input("Referred_BY", sql.NVarChar, Referred_BY)
      .input("SalesTeam_Code", sql.NVarChar, SalesTeam_Code)
      .input("Followup_CompanyName", sql.NVarChar, Followup_CompanyName)
      .input("Followup_CompanyAddress1", sql.NVarChar, Followup_CompanyAddress1)
      .input("Followup_CompanyAddress2", sql.NVarChar, Followup_CompanyAddress2)
      .input("Followup_City", sql.NVarChar, Followup_City)
      .input("Followup_State", sql.NVarChar, Followup_State)
      .input("Followup_Country", sql.NVarChar, Followup_Country)
      .input("Followup_Pincode", sql.NVarChar, Followup_Pincode)
      .input("Stage", sql.NVarChar, Stage)
      .input("Contact_ID", sql.Int, Contact_ID)
      .input("Website", sql.NVarChar, Website)
      .input("company_code", sql.NVarChar, company_code)
      .input("Status", sql.NVarChar, Status)
      .input("keyfield", sql.NVarChar, keyfield)
      .input("sourceType", sql.NVarChar, sourceType)
      .input("Created_by", sql.NVarChar, Created_by)
      .query(`EXEC sp_CRM_NewCompany @mode, @CompanyID, '', '', 0, @OpportunityName, @ContactName, @ContactPhone, @ExpectedRevenue, @Payment, @PaymentType, @ExpectedClosing, @Email_ID, @Priority, @Contact_Followups,
        @Followups_jobposition, @Sales_man_code, @campaignID, @Medium_ID, @Source_ID, @Referred_BY, @SalesTeam_Code, @Followup_CompanyName, @Followup_CompanyAddress1, @Followup_CompanyAddress2, @Followup_City, @Followup_State,
        @Followup_Country, @Followup_Pincode, @Stage,@Contact_ID,@Website, @company_code, @Status, @keyfield,@sourceType,'',0,'','',@Created_by, '', '', ''`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json(err.message);
    }
  } catch (err) {
    console.error("Error during CRM_NewCompany insert:", err);
    return res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const CRM_NewCompanyUpdate = async (req, res) => {
  const {
    Opportunity_ID, CompanyID, OpportunityName, Followups_jobposition, Followup_Pincode, Followup_State,
    Followup_Country, Followup_CompanyName, Followup_CompanyAddress1, Followup_City, Followup_CompanyAddress2,
    SalesTeam_Code, Sales_man_code, Medium_ID, Referred_BY, Source_ID, campaignID, Contact_Followups, ContactName,
    Priority, Email_ID, ContactPhone, ExpectedRevenue, Payment, PaymentType, ExpectedClosing, Stage, Website, company_code,
    Status, keyfield, modified_by, modified_date, Contact_ID, sourceType, Notes, probability, Tags
  } = req.body;
  try {
    const pool = await sql.connect(dbConfig);
    await pool.request()
      .input("mode", sql.NVarChar, "U")
      .input("CompanyID", sql.Int, CompanyID)
      .input("Opportunity_ID", sql.Int, Opportunity_ID)
      .input("OpportunityName", sql.NVarChar, OpportunityName)
      .input("ContactName", sql.NVarChar, ContactName)
      .input("ContactPhone", sql.NVarChar, ContactPhone)
      .input("ExpectedRevenue", sql.Decimal(12, 2), ExpectedRevenue)
      .input("Payment", sql.Decimal(12, 2), Payment)
      .input("PaymentType", sql.NVarChar, PaymentType)
      .input("ExpectedClosing", sql.Date, ExpectedClosing && ExpectedClosing.trim() !== "" ? new Date(ExpectedClosing) : null)
      .input("Email_ID", sql.NVarChar, Email_ID)
      .input("Priority", sql.NVarChar, Priority)
      .input("Contact_Followups", sql.NVarChar, Contact_Followups)
      .input("Followups_jobposition", sql.NVarChar, Followups_jobposition)
      .input("Sales_man_code", sql.NVarChar, Sales_man_code)
      .input("campaignID", sql.NVarChar, campaignID)
      .input("Medium_ID", sql.NVarChar, Medium_ID)
      .input("Source_ID", sql.NVarChar, Source_ID)
      .input("Contact_ID", sql.Int, Contact_ID)
      .input("Referred_BY", sql.NVarChar, Referred_BY)
      .input("SalesTeam_Code", sql.NVarChar, SalesTeam_Code)
      .input("Followup_CompanyName", sql.NVarChar, Followup_CompanyName)
      .input("Followup_CompanyAddress1", sql.NVarChar, Followup_CompanyAddress1)
      .input("Followup_CompanyAddress2", sql.NVarChar, Followup_CompanyAddress2)
      .input("Followup_City", sql.NVarChar, Followup_City)
      .input("Followup_State", sql.NVarChar, Followup_State)
      .input("Followup_Country", sql.NVarChar, Followup_Country)
      .input("Followup_Pincode", sql.NVarChar, Followup_Pincode)
      .input("Stage", sql.NVarChar, Stage)
      .input("Website", sql.NVarChar, Website)
      .input("company_code", sql.NVarChar, company_code)
      .input("Status", sql.NVarChar, Status)
      .input("keyfield", sql.NVarChar, keyfield)
      .input("sourceType", sql.NVarChar, sourceType)
      .input("Notes", sql.NVarChar, Notes)
      .input("probability", sql.Decimal(18, 2), probability)
      .input("Tags", sql.VarChar, Tags)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("modified_date", sql.NVarChar, modified_date)
      .query(`EXEC sp_CRM_NewCompany @mode, @CompanyID, '', '', @Opportunity_ID, @OpportunityName, @ContactName, @ContactPhone, @ExpectedRevenue, @Payment, @PaymentType, @ExpectedClosing, @Email_ID, @Priority, @Contact_Followups,
        @Followups_jobposition, @Sales_man_code, @campaignID, @Medium_ID, @Source_ID, @Referred_BY, @SalesTeam_Code, @Followup_CompanyName, @Followup_CompanyAddress1, @Followup_CompanyAddress2, @Followup_City, @Followup_State,
        @Followup_Country, @Followup_Pincode, @Stage,@Contact_ID,@Website, @company_code, @Status, @keyfield,@sourceType,@Notes,@probability,@Tags,'', '', '', @modified_by, @modified_date`);
    res.status(200).json({ success: true, message: "CRM_NewCompany updated successfully" });
  } catch (err) {
    console.error("Error during CRM_NewCompany update:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const CRM_NewCompanyDelete = async (req, res) => {
  const { Opportunity_ID, company_code } = req.body;
  try {
    const pool = await sql.connect(dbConfig);
    await pool.request()
      .input("mode", sql.NVarChar, "D")
      .input("Opportunity_ID", sql.Int, Opportunity_ID)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_CRM_NewCompany @mode,0, '', '', @Opportunity_ID, '', '','', 0,0,'', '', '', '', '', '', '', '', '',  '', '', '', '', '', '', '', '', '','','', '','',@company_code, '', '', '','',0,'','', '', '', '', ''`);
    res.status(200).json({ success: true, message: "CRM_NewCompany deleted successfully" });
  } catch (err) {
    console.error("Error during CRM_NewCompany delete:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const CRM_ContactInfoInsert = async (req, res) => {
  const { ContactID, Company_or_Persona, Email, CompanyName, Phone, GSTIn, Website, Tag, Stage, Address1, Address2,
    Address3, City, Zip, State, Country, Notes, company_code, status, keyfield,
    BussinessDomain, RefferedBy, Created_by, Person_name } = req.body;

  let Image = null;

  if (req.file) {
    Image = req.file.buffer;
  }

  try {
    const pool = await sql.connect(dbConfig);
    const result = await pool.request()
      .input("mode", sql.NVarChar, "I")
      .input("ContactID", sql.Int, ContactID)
      .input("Company_or_Persona", sql.VarChar, Company_or_Persona)
      .input("Email", sql.VarChar, Email)
      .input("CompanyName", sql.VarChar, CompanyName)
      .input("Phone", sql.VarChar, Phone)
      .input("GSTIn", sql.VarChar, GSTIn)
      .input("Website", sql.VarChar, Website)
      .input("Tag", sql.VarChar, Tag)
      .input("Stage", sql.VarChar, Stage)
      .input("Address1", sql.VarChar, Address1)
      .input("Address2", sql.VarChar, Address2)
      .input("Address3", sql.VarChar, Address3)
      .input("City", sql.VarChar, City)
      .input("Zip", sql.VarChar, Zip)
      .input("State", sql.VarChar, State)
      .input("Country", sql.VarChar, Country)
      .input("Notes", sql.Text, Notes)
      .input("company_code", sql.VarChar, company_code)
      .input("status", sql.VarChar, status)
      .input("keyfield", sql.VarChar, keyfield)
      .input("Image", sql.VarBinary, Image)
      .input("Person_name", sql.VarChar, Person_name)
      .input("BussinessDomain", sql.NVarChar, BussinessDomain)
      .input("RefferedBy", sql.NVarChar, RefferedBy)
      .input("Created_by", sql.VarChar, Created_by)
      .query(`EXEC sp_CRM_ContactInfo @mode, @ContactID, @Company_or_Persona, @Email, @CompanyName, @Phone, @GSTIn, @Website, @Tag, @Stage, @Address1, @Address2, 
        @Address3, @City, @Zip, @State, @Country, @Notes, @company_code, @status, @keyfield, @Image, @Person_name,'','','', '', @BussinessDomain, @RefferedBy, @Created_by, '', '', ''`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    }
  } catch (err) {
    console.error("Error during CRM_ContactInfo insert:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const CRM_ContactInfoUpdate = async (req, res) => {
  const { ContactID, Company_or_Persona, Email, CompanyName, Phone, GSTIn, Website, Tag, Stage, Address1, Address2, Address3, City, Zip, State, Country, Notes,
    company_code, status, keyfield, modified_by, Person_name, BussinessDomain, RefferedBy } = req.body;

  let Image = null;

  if (req.file) {
    Image = req.file.buffer;
  }

  try {
    const pool = await sql.connect(dbConfig);
    await pool.request()
      .input("mode", sql.VarChar, "U")
      .input("ContactID", sql.Int, ContactID)
      .input("Company_or_Persona", sql.VarChar, Company_or_Persona)
      .input("Email", sql.VarChar, Email)
      .input("CompanyName", sql.VarChar, CompanyName)
      .input("Phone", sql.VarChar, Phone)
      .input("GSTIn", sql.VarChar, GSTIn)
      .input("Website", sql.VarChar, Website)
      .input("Tag", sql.VarChar, Tag)
      .input("Stage", sql.VarChar, Stage)
      .input("Address1", sql.VarChar, Address1)
      .input("Address2", sql.VarChar, Address2)
      .input("Address3", sql.VarChar, Address3)
      .input("City", sql.VarChar, City)
      .input("Zip", sql.VarChar, Zip)
      .input("State", sql.VarChar, State)
      .input("Country", sql.VarChar, Country)
      .input("Notes", sql.Text, Notes)
      .input("company_code", sql.VarChar, company_code)
      .input("status", sql.VarChar, status)
      .input("keyfield", sql.VarChar, keyfield)
      .input("Image", sql.VarBinary, Image)
      .input("Person_name", sql.NVarChar, Person_name)
      .input("BussinessDomain", sql.NVarChar, BussinessDomain)
      .input("RefferedBy", sql.NVarChar, RefferedBy)
      .input("modified_by", sql.VarChar, modified_by)
      .query(`EXEC sp_CRM_ContactInfo @mode, @ContactID, @Company_or_Persona, @Email, @CompanyName, @Phone, @GSTIn, @Website, @Tag, @Stage, @Address1, @Address2, 
        @Address3, @City, @Zip, @State, @Country, @Notes, @company_code, @status, @keyfield, @Image, @Person_name,'','','','', @BussinessDomain, @RefferedBy, '','', @modified_by, ''`);

    res.status(200).json({ success: true, message: "CRM_ContactInfo updated successfully" });
  } catch (err) {
    console.error("Error during CRM_ContactInfo update:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const CRM_ContactInfoDelete = async (req, res) => {
  const { ContactID, company_code } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    await pool.request()
      .input("mode", sql.NVarChar, "D")
      .input("ContactID", sql.Int, ContactID)
      .input("company_code", sql.VarChar, company_code)
      .query(`EXEC sp_CRM_ContactInfo @mode, @ContactID, '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', @company_code,'', '','','', '', '', '', '', '','','', '', '', ''`);

    res.status(200).json({ success: true, message: "CRM_ContactInfo deleted successfully" });
  } catch (err) {
    console.error("Error during CRM_ContactInfo delete:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};


// Auto-generated Node.js CRUD for sp_CRM_AddContact
const CRM_AddContactInsert = async (req, res) => {
  const { AddContactID, ContactID, ContactName, Email, Phone, JobTitle, company_code, status, keyfield, Created_Date, modified_date, Created_by, modified_by, Notes } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    await pool.request()
      .input("mode", sql.NVarChar, "I")
      .input("AddContactID", sql.Int, AddContactID)
      .input("ContactID", sql.NVarChar, ContactID)
      .input("ContactName", sql.NVarChar, ContactName)
      .input("Email", sql.NVarChar, Email)
      .input("Phone", sql.NVarChar, Phone)
      .input("JobTitle", sql.NVarChar, JobTitle)
      .input("company_code", sql.NVarChar, company_code)
      .input("status", sql.NVarChar, status)
      .input("keyfield", sql.NVarChar, keyfield)
      .input("Created_Date", sql.NVarChar, Created_Date)
      .input("modified_date", sql.NVarChar, modified_date)
      .input("Created_by", sql.NVarChar, Created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("Notes", sql.NVarChar, Notes)
      .query(`EXEC sp_CRM_AddContact @mode, @AddContactID, @ContactID, @ContactName, @Email, @Phone, @JobTitle, @company_code, @status, @keyfield, @Created_Date, @modified_date, @Created_by, @modified_by, @Notes`);

    res.status(200).json({ success: true, message: "CRM_AddContact insertd successfully" });
  } catch (err) {
    console.error("Error during CRM_AddContact insert:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const CRM_AddContactUpdate = async (req, res) => {
  const { AddContactID, ContactID, ContactName, Email, Phone, JobTitle, company_code, status, keyfield, Created_Date, modified_date, Created_by, modified_by, Notes } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    await pool.request()
      .input("mode", sql.NVarChar, "U")
      .input("AddContactID", sql.Int, AddContactID)
      .input("ContactID", sql.NVarChar, ContactID)
      .input("ContactName", sql.NVarChar, ContactName)
      .input("Email", sql.NVarChar, Email)
      .input("Phone", sql.NVarChar, Phone)
      .input("JobTitle", sql.NVarChar, JobTitle)
      .input("company_code", sql.NVarChar, company_code)
      .input("status", sql.NVarChar, status)
      .input("keyfield", sql.NVarChar, keyfield)
      .input("Created_Date", sql.NVarChar, Created_Date)
      .input("modified_date", sql.NVarChar, modified_date)
      .input("Created_by", sql.NVarChar, Created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("Notes", sql.NVarChar, Notes)
      .query(`EXEC sp_CRM_AddContact @mode, @AddContactID, @ContactID, @ContactName, @Email, @Phone, @JobTitle, @company_code, @status, @keyfield, @Created_Date, @modified_date, @Created_by, @modified_by, @Notes`);

    res.status(200).json({ success: true, message: "CRM_AddContact updated successfully" });
  } catch (err) {
    console.error("Error during CRM_AddContact update:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const CRM_AddContactDelete = async (req, res) => {
  const { AddContactID, company_code } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    await pool.request()
      .input("mode", sql.NVarChar, "D")
      .input("AddContactID", sql.Int, AddContactID)
      .input("company_code", sql.NVarChar, company_code)

      .query(`EXEC sp_CRM_AddContact @mode, @AddContactID, '', '', '', '', '', @company_code, '', '', '', '', '', '', ''`);

    res.status(200).json({ success: true, message: "CRM_AddContact deleted successfully" });
  } catch (err) {
    console.error("Error during CRM_AddContact delete:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const CRM_SalesPersonMasterInsert = async (req, res) => {
  const { SalesCode, SalesPersonName, EmailID, Language, Role, status, company_code, keyfield, SalesTeam,
    BussinessDomain, RefferedBy, Created_by, } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    await pool.request()
      .input("mode", sql.NVarChar, "I")
      .input("SalesCode", sql.NVarChar, SalesCode)
      .input("SalesPersonName", sql.NVarChar, SalesPersonName)
      .input("EmailID", sql.NVarChar, EmailID)
      .input("Language", sql.NVarChar, Language)
      .input("Role", sql.NVarChar, Role)
      .input("status", sql.NVarChar, status)
      .input("SalesTeam", sql.NVarChar, SalesTeam)
      .input("company_code", sql.NVarChar, company_code)
      .input("keyfield", sql.NVarChar, keyfield)
      .input("BussinessDomain", sql.NVarChar, BussinessDomain)
      .input("RefferedBy", sql.NVarChar, RefferedBy)
      .input("Created_by", sql.NVarChar, Created_by)
      .query(`EXEC sp_CRM_SalesPersonMaster @mode, @SalesCode, @SalesPersonName, @EmailID, @Language, @Role, @status,@SalesTeam, @company_code, @keyfield, @BussinessDomain, @RefferedBy, '', '', @Created_by,''`);

    res.status(200).json({ success: true, message: "CRM_SalesPersonMaster insertd successfully" });
  } catch (err) {
    console.error("Error during CRM_SalesPersonMaster insert:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const CRM_SalesPersonMasterUpdate = async (req, res) => {
  const { SalesCode, SalesPersonName, EmailID, Language, Role, status, SalesTeam, company_code, keyfield,
    BussinessDomain, RefferedBy, modified_date, modified_by } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    await pool.request()
      .input("mode", sql.NVarChar, "U")
      .input("SalesCode", sql.NVarChar, SalesCode)
      .input("SalesPersonName", sql.NVarChar, SalesPersonName)
      .input("EmailID", sql.NVarChar, EmailID)
      .input("Language", sql.Int, Language)
      .input("Role", sql.NVarChar, Role)
      .input("status", sql.NVarChar, status)
      .input("SalesTeam", sql.NVarChar, SalesTeam)
      .input("company_code", sql.NVarChar, company_code)
      .input("keyfield", sql.NVarChar, keyfield)
      .input("BussinessDomain", sql.NVarChar, BussinessDomain)
      .input("RefferedBy", sql.NVarChar, RefferedBy)
      .input("modified_date", sql.NVarChar, modified_date)
      .input("modified_by", sql.NVarChar, modified_by)
      .query(`EXEC sp_CRM_SalesPersonMaster @mode, @SalesCode, @SalesPersonName, @EmailID, @Language, @Role, @status, @SalesTeam, @company_code, @keyfield, @BussinessDomain, @RefferedBy, '', @modified_date, '', @modified_by`);

    res.status(200).json({ success: true, message: "CRM_SalesPersonMaster updated successfully" });
  } catch (err) {
    console.error("Error during CRM_SalesPersonMaster update:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const CRM_SalesPersonMasterDelete = async (req, res) => {
  const { SalesCode, company_code } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    await pool.request()
      .input("mode", sql.NVarChar, "D")
      .input("SalesCode", sql.NVarChar, SalesCode)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_CRM_SalesPersonMaster @mode, @SalesCode, '', '', '', '', '', '', @company_code,'','','','','','',''`);

    res.status(200).json({ success: true, message: "CRM_SalesPersonMaster deleted successfully" });
  } catch (err) {
    console.error("Error during CRM_SalesPersonMaster delete:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

// Node.js CRUD for sp_CRM_LogNote
const CRM_LogNoteInsert = async (req, res) => {
  const { Opportunity_ID, type, stage, AssignedTo, LogNote, company_code, keyfield, Created_Date, Created_by } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    await pool.request()
      .input("mode", sql.NVarChar, "I")
      .input("Opportunity_ID", sql.Int, Opportunity_ID)
      .input("type", sql.NVarChar, type)
      .input("AssignedTo", sql.NVarChar, AssignedTo)
      .input("LogNote", sql.NVarChar, LogNote)
      .input("stage", sql.NVarChar, stage)
      .input("company_code", sql.NVarChar, company_code)
      .input("keyfield", sql.NVarChar, keyfield)
      .input("Created_Date", sql.NVarChar, Created_Date)
      .input("Created_by", sql.NVarChar, Created_by)
      .query(`EXEC sp_CRM_LogNote @mode, @Opportunity_ID, @type, @AssignedTo, @LogNote, @stage, @company_code, @Created_Date, '', @Created_by, ''`);

    res.status(200).json({ success: true, message: "CRM_LogNote insertd successfully" });
  } catch (err) {
    console.error("Error during CRM_LogNote insert:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const CRM_LogNoteUpdate = async (req, res) => {
  const { Opportunity_ID, type, stage, AssignedTo, LogNote, company_code, keyfield, modified_date, modified_by } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    await pool.request()
      .input("mode", sql.NVarChar, "U")
      .input("Opportunity_ID", sql.Int, Opportunity_ID)
      .input("type", sql.NVarChar, type)
      .input("AssignedTo", sql.NVarChar, AssignedTo)
      .input("LogNote", sql.NVarChar, LogNote)
      .input("stage", sql.NVarChar, stage)
      .input("company_code", sql.NVarChar, company_code)
      .input("keyfield", sql.NVarChar, keyfield)
      .input("modified_date", sql.NVarChar, modified_date)
      .input("modified_by", sql.NVarChar, modified_by)
      .query(`EXEC sp_CRM_LogNote @mode, @Opportunity_ID, @ContactID,  @AssignedTo, @LogNote, @stage, @company_code, '', @modified_date,'',@modified_by`);

    res.status(200).json({ success: true, message: "CRM_LogNote updated successfully" });
  } catch (err) {
    console.error("Error during CRM_LogNote update:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const CRM_LogNoteDelete = async (req, res) => {
  const { Opportunity_ID, company_code } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    await pool.request()
      .input("mode", sql.NVarChar, "D")
      .input("Opportunity_ID", sql.Int, Opportunity_ID)
      .input("company_code", sql.NVarChar, company_code)

      .query(`EXEC sp_CRM_LogNote @mode, @Opportunity_ID,'', '','','', @company_code, '', '','',''`);

    res.status(200).json({ success: true, message: "CRM_LogNote deleted successfully" });
  } catch (err) {
    console.error("Error during CRM_LogNote delete:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};
const CRM_LogNoteGet = async (req, res) => {
  const { Opportunity_ID, company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();

    const request = pool.request();
    const result = await request
      .input("mode", sql.NVarChar, "A")
      .input("Opportunity_ID", sql.Int, Opportunity_ID)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_CRM_LogNote @mode, @Opportunity_ID,'', '','','',@company_code, '', '','',''`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};


//  Node.js CRUD for sp_CRM_MeetingSubject
const CRM_MeetingSubjectInsert = async (req, res) => {
  const { MeetingID, MeetingSubject, Start, End, Duration, Timezone, Location, VideoCallURL, Tags, Privacy, Organizer, Description, Reminder, Recurrent, Repeat, RepeatOn, Unit, status, company_code, keyfield, Created_Date, Created_by } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    await pool.request()
      .input("mode", sql.NVarChar, "I")
      .input("MeetingID", sql.Int, MeetingID)
      .input("MeetingSubject", sql.NVarChar, MeetingSubject)
      .input("Start", sql.DateTime, Start)
      .input("End", sql.DateTime, End)
      .input("Duration", sql.NVarChar, Duration)
      .input("Timezone", sql.NVarChar, Timezone)
      .input("Location", sql.NVarChar, Location)
      .input("VideoCallURL", sql.NVarChar, VideoCallURL)
      .input("Tags", sql.NVarChar, Tags)
      .input("Privacy", sql.NVarChar, Privacy)
      .input("Organizer", sql.NVarChar, Organizer)
      .input("Description", sql.NVarChar, Description)
      .input("Reminder", sql.NVarChar, Reminder)
      .input("Recurrent", sql.NVarChar, Recurrent)
      .input("Repeat", sql.NVarChar, Repeat)
      .input("RepeatOn", sql.NVarChar, RepeatOn)
      .input("Unit", sql.NVarChar, Unit)
      .input("status", sql.NVarChar, status)
      .input("company_code", sql.NVarChar, company_code)
      .input("keyfield", sql.NVarChar, keyfield)
      .input("Created_Date", sql.NVarChar, Created_Date)
      .input("Created_by", sql.NVarChar, Created_by)
      .query(`EXEC sp_CRM_MeetingSubject @mode, @MeetingID, @MeetingSubject, @Start, @End, @Duration, @Timezone, @Location, @VideoCallURL, @Tags, @Privacy, @Organizer, @Description, @Reminder, @Recurrent, @Repeat, @RepeatOn, @Unit, @status, @company_code, @keyfield, @Created_Date, '', @Created_by,''`);

    res.status(200).json({ success: true, message: "CRM_MeetingSubject insertd successfully" });
  } catch (err) {
    console.error("Error during CRM_MeetingSubject insert:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const CRM_MeetingSubjectUpdate = async (req, res) => {
  const { MeetingID, MeetingSubject, Start, End, Duration, Timezone, Location, VideoCallURL, Tags, Privacy, Organizer, Description, Reminder, Recurrent, Repeat, RepeatOn, Unit, status, company_code, keyfield, modified_date, modified_by } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    await pool.request()
      .input("mode", sql.NVarChar, "U")
      .input("MeetingID", sql.Int, MeetingID)
      .input("MeetingSubject", sql.NVarChar, MeetingSubject)
      .input("Start", sql.DateTime, Start)
      .input("End", sql.DateTime, End)
      .input("Duration", sql.NVarChar, Duration)
      .input("Timezone", sql.NVarChar, Timezone)
      .input("Location", sql.NVarChar, Location)
      .input("VideoCallURL", sql.NVarChar, VideoCallURL)
      .input("Tags", sql.NVarChar, Tags)
      .input("Privacy", sql.NVarChar, Privacy)
      .input("Organizer", sql.NVarChar, Organizer)
      .input("Description", sql.NVarChar, Description)
      .input("Reminder", sql.NVarChar, Reminder)
      .input("Recurrent", sql.NVarChar, Recurrent)
      .input("Repeat", sql.NVarChar, Repeat)
      .input("RepeatOn", sql.NVarChar, RepeatOn)
      .input("Unit", sql.NVarChar, Unit)
      .input("status", sql.NVarChar, status)
      .input("company_code", sql.NVarChar, company_code)
      .input("keyfield", sql.NVarChar, keyfield)
      .input("modified_date", sql.NVarChar, modified_date)
      .input("modified_by", sql.NVarChar, modified_by)
      .query(`EXEC sp_CRM_MeetingSubject @mode, @MeetingID, @MeetingSubject, @Start, @End, @Duration, @Timezone, @Location, @VideoCallURL, @Tags, @Privacy, @Organizer, @Description, @Reminder, @Recurrent, @Repeat, @RepeatOn, @Unit, @status, @company_code, @keyfield, '', @modified_date, '', @modified_by`);

    res.status(200).json({ success: true, message: "CRM_MeetingSubject updated successfully" });
  } catch (err) {
    console.error("Error during CRM_MeetingSubject update:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const CRM_MeetingSubjectDelete = async (req, res) => {
  const { MeetingID, company_code } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    await pool.request()
      .input("mode", sql.NVarChar, "D")
      .input("MeetingID", sql.Int, MeetingID)
      .input("company_code", sql.NVarChar, company_code)

      .query(`EXEC sp_CRM_MeetingSubject @mode, @MeetingID, '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', @company_code, '', '', '', '', ''`);

    res.status(200).json({ success: true, message: "CRM_MeetingSubject deleted successfully" });
  } catch (err) {
    console.error("Error during CRM_MeetingSubject delete:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

//  Node.js CRUD for sp_CRM_Campaign
const CRM_CampaignInsert = async (req, res) => {
  const { CampaignID, CampaignName, Responsible, TagName, status, company_code, keyfield, Created_by } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    await pool.request()
      .input("mode", sql.NVarChar, "I")
      .input("CampaignID", sql.NVarChar, CampaignID)
      .input("CampaignName", sql.NVarChar, CampaignName)
      .input("Responsible", sql.NVarChar, Responsible)
      .input("TagName", sql.NVarChar, TagName)
      .input("status", sql.NVarChar, status)
      .input("company_code", sql.NVarChar, company_code)
      .input("keyfield", sql.NVarChar, keyfield)
      .input("Created_by", sql.NVarChar, Created_by)
      .query(`EXEC sp_CRM_Campaign @mode,@CampaignID, @CampaignName, @Responsible, @TagName, @status, @company_code, @keyfield, '', '', @Created_by, ''`);

    res.status(200).json({ success: true, message: "CRM_Campaign insertd successfully" });
  } catch (err) {
    console.error("Error during CRM_Campaign insert:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const CRM_CampaignUpdate = async (req, res) => {
  const { CampaignID, CampaignName, Responsible, TagName, status, company_code, keyfield, modified_date, modified_by } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    await pool.request()
      .input("mode", sql.NVarChar, "U")
      .input("CampaignID ", sql.NVarChar, CampaignID)
      .input("CampaignName", sql.NVarChar, CampaignName)
      .input("Responsible", sql.NVarChar, Responsible)
      .input("TagName", sql.NVarChar, TagName)
      .input("status", sql.NVarChar, status)
      .input("company_code", sql.NVarChar, company_code)
      .input("keyfield", sql.NVarChar, keyfield)
      .input("modified_date", sql.NVarChar, modified_date)
      .input("modified_by", sql.NVarChar, modified_by)
      .query(`EXEC sp_CRM_Campaign @mode,'', @CampaignName, @Responsible, @TagName, @status, @company_code, @keyfield, '', @modified_date, '', @modified_by`);

    res.status(200).json({ success: true, message: "CRM_Campaign updated successfully" });
  } catch (err) {
    console.error("Error during CRM_Campaign update:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const CRM_CampaignDelete = async (req, res) => {
  const { CampaignID, company_code } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    await pool.request()
      .input("mode", sql.NVarChar, "D")
      .input("CampaignID ", sql.NVarChar, CampaignID)
      .input("company_code", sql.NVarChar, company_code)

      .query(`EXEC sp_CRM_Campaign @mode, @CampaignID,'', '', '', '', @company_code, '', '', '', '', ''`);

    res.status(200).json({ success: true, message: "CRM_Campaign deleted successfully" });
  } catch (err) {
    console.error("Error during CRM_Campaign delete:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

// Node.js CRUD for sp_CRM_Medium
const CRM_MediumInsert = async (req, res) => {
  const { Medium_ID, MediumName, Status, Created_by, Created_Date, company_code } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    await pool.request()
      .input("mode", sql.NVarChar, "I")
      .input("Medium_ID", sql.NVarChar, Medium_ID)
      .input("MediumName", sql.NVarChar, MediumName)
      .input("Status", sql.NVarChar, Status)
      .input("Created_by", sql.NVarChar, Created_by)
      .input("Created_Date", sql.NVarChar, Created_Date)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_CRM_Medium @mode,@Medium_ID, @MediumName, @Status, @Created_by, '', @Created_Date, '', @company_code`);

    res.status(200).json({ success: true, message: "CRM_Medium insertd successfully" });
  } catch (err) {
    console.error("Error during CRM_Medium insert:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const CRM_MediumUpdate = async (req, res) => {
  const { Medium_ID, MediumName, Status, modified_by, modified_date, company_code } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    await pool.request()
      .input("mode", sql.NVarChar, "U")
      .input("Medium_ID", sql.NVarChar, Medium_ID)
      .input("MediumName", sql.NVarChar, MediumName)
      .input("Status", sql.NVarChar, Status)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("modified_date", sql.NVarChar, modified_date)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_CRM_Medium @mode,@Medium_ID, @MediumName, @Status, '', @modified_by, '', @modified_date, @company_code`);

    res.status(200).json({ success: true, message: "CRM_Medium updated successfully" });
  } catch (err) {
    console.error("Error during CRM_Medium update:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const CRM_MediumDelete = async (req, res) => {
  const { Medium_ID, company_code } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    await pool.request()
      .input("mode", sql.NVarChar, "D")
      .input("Medium_ID", sql.NVarChar, Medium_ID)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_CRM_Medium @mode, @Medium_ID,'', '', '', '', '', '', @company_code`);

    res.status(200).json({ success: true, message: "CRM_Medium deleted successfully" });
  } catch (err) {
    console.error("Error during CRM_Medium delete:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

//  Node.js CRUD for sp_CRM_Source
const CRM_SourceInsert = async (req, res) => {
  const { Source_ID, SourceName, Created_by, Created_Date, company_code } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    await pool.request()
      .input("mode", sql.NVarChar, "I")
      .input("Source_ID", sql.NVarChar, Source_ID)
      .input("SourceName", sql.NVarChar, SourceName)
      .input("Created_by", sql.NVarChar, Created_by)
      .input("Created_Date", sql.NVarChar, Created_Date)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_CRM_Source @mode,@Source_ID, @SourceName, @Created_by, '', @Created_Date, '', @company_code`);

    res.status(200).json({ success: true, message: "CRM_Source insertd successfully" });
  } catch (err) {
    console.error("Error during CRM_Source insert:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const CRM_SourceUpdate = async (req, res) => {
  const { Source_ID, SourceName, modified_by, modified_date, company_code } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    await pool.request()
      .input("mode", sql.NVarChar, "U")
      .input("Source_ID", sql.NVarChar, Source_ID)
      .input("SourceName", sql.NVarChar, SourceName)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("modified_date", sql.NVarChar, modified_date)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_CRM_Source @mode,@Source_ID  , @SourceName, '', @modified_by, '', @modified_date, @company_code`);

    res.status(200).json({ success: true, message: "CRM_Source updated successfully" });
  } catch (err) {
    console.error("Error during CRM_Source update:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const CRM_SourceDelete = async (req, res) => {
  const { Source_ID, company_code } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    await pool.request()
      .input("mode", sql.NVarChar, "D")
      .input("Source_ID", sql.NVarChar, Source_ID)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_CRM_Source @mode, @Source_ID,'','','','','', @company_code`);

    res.status(200).json({ success: true, message: "CRM_Source deleted successfully" });
  } catch (err) {
    console.error("Error during CRM_Source delete:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

// Node.js CRUD for sp_CRM_SalesPurchase
const CRM_SalesPurchaseInsert = async (req, res) => {
  const { SalesPurchaseID, ContactID, Type, SalesPerson, Mist, CompanyID, Reference, Industry, status, Created_by, Created_Date, company_code } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    await pool.request()
      .input("mode", sql.NVarChar, "I")
      .input("SalesPurchaseID", sql.NVarChar, SalesPurchaseID)
      .input("ContactID", sql.NVarChar, ContactID)
      .input("Type", sql.NVarChar, Type)
      .input("SalesPerson", sql.NVarChar, SalesPerson)
      .input("Mist", sql.NVarChar, Mist)
      .input("CompanyID", sql.NVarChar, CompanyID)
      .input("Reference", sql.NVarChar, Reference)
      .input("Industry", sql.NVarChar, Industry)
      .input("status", sql.NVarChar, status)
      .input("Created_by", sql.NVarChar, Created_by)
      .input("Created_Date", sql.NVarChar, Created_Date)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_CRM_SalesPurchase @mode, @SalesPurchaseID, @ContactID, @Type, @SalesPerson, @Mist, @CompanyID, @Reference, @Industry, @status, @Created_by, @modified_by, @Created_Date, @modified_date, @company_code`);

    res.status(200).json({ success: true, message: "CRM_SalesPurchase insertd successfully" });
  } catch (err) {
    console.error("Error during CRM_SalesPurchase insert:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const CRM_SalesPurchaseUpdate = async (req, res) => {
  const { SalesPurchaseID, ContactID, Type, SalesPerson, Mist, CompanyID, Reference, Industry, status, modified_by, modified_date, company_code } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    await pool.request()
      .input("mode", sql.NVarChar, "U")
      .input("SalesPurchaseID", sql.NVarChar, SalesPurchaseID)
      .input("ContactID", sql.NVarChar, ContactID)
      .input("Type", sql.NVarChar, Type)
      .input("SalesPerson", sql.NVarChar, SalesPerson)
      .input("Mist", sql.NVarChar, Mist)
      .input("CompanyID", sql.NVarChar, CompanyID)
      .input("Reference", sql.NVarChar, Reference)
      .input("Industry", sql.NVarChar, Industry)
      .input("status", sql.NVarChar, status)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("modified_date", sql.NVarChar, modified_date)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_CRM_SalesPurchase @mode, @SalesPurchaseID, @ContactID, @Type, @SalesPerson, @Mist, @CompanyID, @Reference, @Industry, @status, '', @modified_by, '', @modified_date, @company_code`);

    res.status(200).json({ success: true, message: "CRM_SalesPurchase updated successfully" });
  } catch (err) {
    console.error("Error during CRM_SalesPurchase update:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const CRM_SalesPurchaseDelete = async (req, res) => {
  const { SalesPurchaseID, company_code } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    await pool.request()
      .input("mode", sql.NVarChar, "D")
      .input("SalesPurchaseID", sql.NVarChar, SalesPurchaseID)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_CRM_SalesPurchase @mode, @SalesPurchaseID, '', '', '', '', '', '', '','', @company_code '', '', '', ''`);

    res.status(200).json({ success: true, message: "CRM_SalesPurchase deleted successfully" });
  } catch (err) {
    console.error("Error during CRM_SalesPurchase delete:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

//Code added by pavun on 11-09-25
const getClientPaymentExcel = async (req, res) => {
  const { Client_code, Company_code, Product_ID } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, 'CPE')
      .input("Client_code", sql.NVarChar, Client_code)
      .input("Company_code", sql.NVarChar, Company_code)
      .input("Product_ID", sql.NVarChar, Product_ID)
      .query(`EXEC sp_Client_Payment @mode,0,@Client_code,'','',0,'',@Product_ID,'',@Company_code,'','','','',NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//Code ended by pavun on 11-09-25
// Code Added by Harish 15/09/25

const CompanySearch = async (req, res) => {
  const { Company_or_Persona, Email, CompanyName, Phone, GSTIn, Tag, Stage, Address1,
    Address2, Address3, City, Zip, State, Country, Notes, company_code, status, Person_name } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("Email", sql.NVarChar, Email)
      .input("CompanyName", sql.NVarChar, CompanyName)
      .input("Phone", sql.NVarChar, Phone)
      .input("GSTIn", sql.NVarChar, GSTIn)
      .input("Tag", sql.NVarChar, Tag)
      .input("Stage", sql.NVarChar, Stage)
      .input("Address1", sql.NVarChar, Address1)
      .input("Address2", sql.NVarChar, Address2)
      .input("Address3", sql.NVarChar, Address3)
      .input("City", sql.NVarChar, City)
      .input("Zip", sql.NVarChar, Zip)
      .input("State", sql.NVarChar, State)
      .input("Country", sql.NVarChar, Country)
      .input("Notes", sql.NVarChar, Notes)
      .input("company_code", sql.NVarChar, company_code)
      .input("status", sql.NVarChar, status)
      .input("Person_name", sql.NVarChar, Person_name)
      .query(`EXEC sp_CRM_ContactInfo @mode,'','',@Email,@CompanyName,@Phone,@GSTIn,'',@Tag,@Stage,@Address1,@Address2,@Address3,@City,@Zip,@State,@Country,
        @Notes,@company_code,@status,'','',@Person_name,'','','','','','','','','',''`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error in CompanySearch:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};


//Code added by pavun on 15-09-25
const CRM_ContactInfoCompanyName = async (req, res) => {
  const { company_code } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    const result = await pool.request()
      .input("mode", sql.NVarChar, "GC")
      .input("company_code", sql.VarChar, company_code)
      .query(`EXEC sp_CRM_ContactInfo @mode, 0, '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', @company_code,'','','', '', '', '', '', '', '','','', '', '',''`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    }
    else {
      res.status(404).json('Data not found')
    }
  } catch (err) {
    console.error("Error during CRM_ContactInfo delete:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};
//Code ended by pavub on 15-09-25

//Code added by pavun on 18-09-25
const defaultCompanyNames = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "GDCN")
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_CRM_NewCompany @mode,0, '', '', '', '', '','', 0,0,'', '', '', '', '', '', '', '', '',  '', '', '', '', '', '', '', '', '','', '','','',@company_code, '', '', '', '', 0, '', '','', '', '', ''`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error during CRM_NewCompany delete:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const defaultContactsName = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "GDCT")
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_CRM_NewCompany @mode,0, '', '', '', '', '','', 0,0,'', '', '', '', '', '', '', '', '',  '', '', '', '', '', '', '', '', '','', '','','',@company_code, '', '', '', '', 0, '','', '', '', '', ''`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error during CRM_NewCompany delete:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const companyToContact = async (req, res) => {
  const { CompanyID, company_code } = req.body;
  try {
    const pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "CCT")
      .input("CompanyID", sql.Int, CompanyID)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_CRM_NewCompany @mode,@CompanyID, '', '', '', '', '','', 0,0,'', '', '', '', '', '', '', '', '',  '', '', '', '', '', '', '', '', '','','', '','',@company_code, '', '', '', '', 0, '', '','', '', '', ''`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error during CRM_NewCompany delete:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const contactToCompany = async (req, res) => {
  const { Contact_ID, company_code, sourceType } = req.body;
  try {
    const pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "CCN")
      .input("Contact_ID", sql.Int, Contact_ID)
      .input("company_code", sql.NVarChar, company_code)
      .input("sourceType", sql.NVarChar, sourceType)
      .query(`EXEC sp_CRM_NewCompany @mode,0, '','', '', '', '','', 0,0,'', '', '', '', '', '', '', '', '',  '', '', '', '', '', '', '', '', '','', '',@Contact_ID,'',@company_code, '', '', @sourceType, '', 0, '','', '', '', '', ''`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error during CRM_NewCompany delete:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};
//Code ended by pavun on 19-09-25

//Code added by pavun on 22-09-25
const getDateRangeCRM = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query("EXEC sp_attribute_Info 'F',@company_code,'DateRange','','', '','','' , NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL");

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getNewCompany = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query("EXEC sp_CRM_NewCompany 'GC',0, '', '', '', '', '','', 0,0,'', '', '', '', '', '', '', '', '',  '', '', '', '', '', '', '', '', '','','', '','',@company_code, '', '', '', '', 0, '','', '', '', '', '' ");
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const updateNewCompanyStage = async (req, res) => {
  const { Opportunity_ID, Stage, company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    await pool
      .request()
      .input("Opportunity_ID", sql.Int, Opportunity_ID)
      .input("Stage", sql.NVarChar, Stage)
      .input("company_code", sql.NVarChar, company_code)
      .query("EXEC sp_CRM_NewCompany 'UC',0,'','', @Opportunity_ID, '', '','', 0,0,'', '', '', '', '', '', '', '', '',  '', '', '', '', '', '', '', '', '','', @Stage,'','',@company_code, '', '', '', '', 0, '','', '', '', '', '' ");
    res.status(200).json({ success: true, message: "Opportunity ID stage updated successfully" });
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//Code ended by pavun on 22-09-25

//Code added by pavun on 23-09-25
const getOpportunityDetails = async (req, res) => {
  const { Opportunity_ID, company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("Opportunity_ID", sql.Int, Opportunity_ID)
      .input("company_code", sql.NVarChar, company_code)
      .query("EXEC sp_CRM_NewCompany 'OD',0,'','', @Opportunity_ID, '', '','', 0,0,'', '', '', '', '', '', '', '', '',  '', '', '', '', '', '', '', '', '','', '','','',@company_code, '', '', '', '', 0, '','', '', '', '', '' ");
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//Code ended by pavun on 23-09-25

// Auto-generated Node.js CRUD for sp_CRM_SalesTeam_HDR

const CRM_SalesTeam_HDRInsert = async (req, res) => {
  const { Sales_ID, Sales_Team, Team_Leader, Email_alias, Sales_person, Emails_From, Company_code, Created_by } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    await pool.request()
      .input("mode", sql.NVarChar, "I")
      .input("Sales_ID", sql.NVarChar, Sales_ID)
      .input("Sales_Team", sql.NVarChar, Sales_Team)
      .input("Team_Leader", sql.NVarChar, Team_Leader)
      .input("Email_alias", sql.NVarChar, Email_alias)
      .input("Emails_From", sql.NVarChar, Emails_From)
      .input("Sales_person", sql.VarChar, Sales_person)
      .input("Company_code", sql.NVarChar, Company_code)
      .input("Created_by", sql.NVarChar, Created_by)
      .query(`EXEC sp_CRM_SalesTeam_HDR @mode,@Sales_ID, @Sales_Team, @Team_Leader, @Email_alias, @Emails_From,@Sales_person, @Company_code, @Created_by,'','',''`);

    res.status(200).json({ success: true, message: "Sales Team insertd successfully" });
  } catch (err) {
    console.error("Error during CRM_SalesTeam_HDR insert:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const CRM_SalesTeam_HDRUpdate = async (req, res) => {
  const { Sales_ID, Sales_Team, Team_Leader, Email_alias, Emails_From, Company_code, modified_by } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    await pool.request()
      .input("mode", sql.NVarChar, "U")
      .input("Sales_ID", sql.NVarChar, Sales_ID)
      .input("Sales_Team", sql.NVarChar, Sales_Team)
      .input("Team_Leader", sql.NVarChar, Team_Leader)
      .input("Email_alias", sql.NVarChar, Email_alias)
      .input("Emails_From", sql.NVarChar, Emails_From)
      .input("Company_code", sql.NVarChar, Company_code)
      .input("modified_by", sql.NVarChar, modified_by)
      .query(`EXEC sp_CRM_SalesTeam_HDR @mode, @Sales_ID, @Sales_Team, @Team_Leader, @Email_alias, @Emails_From,'', @Company_code,'', @modified_by,'',''`);

    res.status(200).json({ success: true, message: "CRM_SalesTeam_HDR updated successfully" });
  } catch (err) {
    console.error("Error during CRM_SalesTeam_HDR update:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const CRM_SalesTeam_HDRDelete = async (req, res) => {
  const { Sales_ID, Company_code } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    await pool.request()
      .input("mode", sql.NVarChar, "D")
      .input("Sales_ID", sql.Int, Sales_ID)
      .input("Company_code", sql.NVarChar, Company_code)

      .query(`EXEC sp_CRM_SalesTeam_HDR @mode, @Sales_ID,'','','', '', '',@Company_code, '', '', '', ''`);

    res.status(200).json({ success: true, message: "CRM_SalesTeam_HDR deleted successfully" });
  } catch (err) {
    console.error("Error during CRM_SalesTeam_HDR delete:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};


// Code Added by Harish on 23_09_25

const CRM_SalesTeam_DetailsInsert = async (req, res) => {
  const { Sales_ID, Sales_Person, Company_code, Created_by } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    await pool.request()
      .input("mode", sql.NVarChar, "I")
      .input("Sales_ID", sql.Int, Sales_ID)
      .input("Sales_Person", sql.NVarChar, Sales_Person)
      .input("Company_code", sql.NVarChar, Company_code)
      .input("Created_by", sql.NVarChar, Created_by)
      .query(`EXEC sp_CRM_SalesTeam_Details @mode, @Sales_ID, @Sales_Person, @Company_code, @Created_by,'', '', ''`);

    res.status(200).json({ success: true, message: "CRM_SalesTeam_Details insertd successfully" });
  } catch (err) {
    console.error("Error during CRM_SalesTeam_Details insert:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const CRM_SalesTeam_DetailsUpdate = async (req, res) => {
  const { Sales_ID, Sales_Person, Company_code, modified_by, modified_date } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    await pool.request()
      .input("mode", sql.NVarChar, "U")
      .input("Sales_ID", sql.Int, Sales_ID)
      .input("Sales_Person", sql.NVarChar, Sales_Person)
      .input("Company_code", sql.NVarChar, Company_code)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("modified_date", sql.Date, modified_date)
      .query(`EXEC sp_CRM_SalesTeam_Details @mode, @Sales_ID, @Sales_Person, @Company_code, '', @modified_by,'',''`);

    res.status(200).json({ success: true, message: "CRM_SalesTeam_Details updated successfully" });
  } catch (err) {
    console.error("Error during CRM_SalesTeam_Details update:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const CRM_SalesTeam_DetailsDelete = async (req, res) => {
  const { Sales_ID, Company_code } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    await pool.request()
      .input("mode", sql.NVarChar, "D")
      .input("Sales_ID", sql.Int, Sales_ID)
      .input("Company_code", sql.NVarChar, Company_code)
      .query(`EXEC sp_CRM_SalesTeam_Details @mode, @Sales_ID,'', @Company_code,'','','',''`);

    res.status(200).json({ success: true, message: "CRM_SalesTeam_Details deleted successfully" });
  } catch (err) {
    console.error("Error during CRM_SalesTeam_Details delete:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

// Auto-generated Node.js CRUD for sp_CRM_Activity

const CRM_ActivityInsert = async (req, res) => {
  const { Activity_ID, Opportunity_ID, Markdone_Status, Feedback, Summary, Type_of_Activity, Due_date, Assigned_To, Notes, Company_code, Created_by } = req.body;

  let Attachments = null;
  if (req.file) Attachments = req.file.buffer;

  try {
    const pool = await sql.connect(dbConfig);
    await pool.request()
      .input("mode", sql.NVarChar, "I")
      .input("Activity_ID", sql.Int, Activity_ID)
      .input("Opportunity_ID", sql.NVarChar, Opportunity_ID)
      .input("Summary", sql.NVarChar, Summary)
      .input("Type_of_Activity", sql.NVarChar, Type_of_Activity)
      .input("Due_date", sql.Date, Due_date)
      .input("Assigned_To", sql.NVarChar, Assigned_To)
      .input("Attachments", sql.VarBinary, Attachments)
      .input("Notes", sql.NVarChar, Notes)
      .input("Markdone_Status", sql.NVarChar, Markdone_Status)
      .input("Feedback", sql.NVarChar, Feedback)
      .input("Company_code", sql.NVarChar, Company_code)
      .input("Created_by", sql.NVarChar, Created_by)
      .query(`EXEC sp_CRM_Activity @mode,@Activity_ID,@Opportunity_ID,@Summary, @Type_of_Activity, @Due_date, @Assigned_To, @Attachments, @Notes, @Company_code, '','','','',0,0,@Markdone_Status,@Feedback,@Created_by,'','',''`);

    res.status(200).json({ success: true, message: "CRM_Activity insertd successfully" });
  } catch (err) {
    console.error("Error during CRM_Activity insert:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const CRM_ActivityUpdate = async (req, res) => {
  const { Activity_ID, Type_of_Activity, Due_date, Assigned_To, Notes, Company_code, modified_by } = req.body;
  let Attachments = null;
  if (req.file) Attachments = req.file.buffer;

  try {
    const pool = await sql.connect(dbConfig);
    await pool.request()
      .input("mode", sql.NVarChar, "U")
      .input("Activity_ID", sql.NVarChar, Activity_ID)
      .input("Type_of_Activity", sql.NVarChar, Type_of_Activity)
      .input("Due_date", sql.Date, Due_date)
      .input("Assigned_To", sql.NVarChar, Assigned_To)
      .input("Attachments", sql.VarBinary, Attachments)
      .input("Notes", sql.NVarChar, Notes)
      .input("Company_code", sql.NVarChar, Company_code)
      .input("modified_by", sql.NVarChar, modified_by)
      .query(`EXEC sp_CRM_Activity @mode,@Activity_ID,0,'', @Type_of_Activity, @Due_date, @Assigned_To, @Attachments, @Notes, @Company_code,'','','','',0,0,'','','', @modified_by,'',''`);

    res.status(200).json({ success: true, message: "CRM_Activity updated successfully" });
  } catch (err) {
    console.error("Error during CRM_Activity update:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const CRM_ActivityDelete = async (req, res) => {
  const { Activity_ID, Company_code, } = req.body;
  let Attachments = null;
  if (req.file) Attachments = req.file.buffer;

  try {
    const pool = await sql.connect(dbConfig);
    await pool.request()
      .input("mode", sql.NVarChar, "D")
      .input("Activity_ID", sql.NVarChar, Activity_ID)
      .input("Company_code", sql.NVarChar, Company_code)
      .query(`EXEC sp_CRM_Activity @mode, @Activity_ID,0,'','','', '', '', '', @Company_code,'','','','',0,0,'','', '', '', '', ''`);

    res.status(200).json({ success: true, message: "CRM_Activity deleted successfully" });
  } catch (err) {
    console.error("Error during CRM_Activity delete:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};
// Code Ended by Harish on 23_09_25

//Code added by pavun on 24-09-25
const getCustomerDropdown = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query("EXEC sp_CRM_NewCompany 'PC',0, '', '', 0, '', '','', 0,0,'', '', '', '', '', '', 0, '', '',  '', '', '', '', '', '', '', '', '','', '',0,'',@company_code, '', '', '', '', 0, '','', '', '', '', '' ");

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const updateNewCompanyPeriority = async (req, res) => {
  const { Opportunity_ID, Priority, company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    await pool
      .request()
      .input("mode", sql.NVarChar, 'UP')
      .input("Opportunity_ID", sql.Int, Opportunity_ID)
      .input("Priority", sql.NVarChar, Priority)
      .input("company_code", sql.NVarChar, company_code)
      .query("EXEC sp_CRM_NewCompany @mode,0,'','',@Opportunity_ID,'','','',0,0,'','','',@Priority,'','','','','','','','','','','','','','','','','','',@company_code,'','','','',0,'','','','','','' ");

    res.status(200).json({ success: true, message: "Opportunity ID stage updated successfully" });
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//Code ended by pavun on 24-09-25
const CRM_NewEventInsert = async (req, res) => {
  const { Event_Name, Oppurtinity_ID, Start_date, End_date, All_Days, Attendees, Videocall_URL, Description, Activity_ID, Company_code, Created_by } = req.body;
  try {
    const pool = await sql.connect(dbConfig);
    await pool.request()
      .input("mode", sql.NVarChar, "I")
      .input("Event_Name", sql.NVarChar, Event_Name)
      .input("Oppurtinity_ID", sql.Int, Oppurtinity_ID)
      .input("Start_date", sql.NVarChar, Start_date)
      .input("End_date", sql.NVarChar, End_date)
      .input("All_Days", sql.NVarChar, All_Days)
      .input("Attendees", sql.NVarChar, Attendees)
      .input("Videocall_URL", sql.NVarChar, Videocall_URL)
      .input("Description", sql.NVarChar, Description)
      // .input("Activity_ID", sql.Int, Activity_ID)
      .input("Company_code", sql.NVarChar, Company_code)
      .input("Created_by", sql.NVarChar, Created_by)
      .query(`EXEC sp_CRM_NewEvent @mode,@Event_Name,@Oppurtinity_ID,@Start_date, @End_date,@All_Days, @Attendees,@Videocall_URL,@Description,0,@Company_code, @Created_by, '', '', ''
`);
    res.status(200).json({ success: true, message: "CRM_NewEvent insertd successfully" });
  } catch (err) {
    console.error("Error during CRM_NewEvent insert:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};
const CRM_NewEventUpdate = async (req, res) => {
  const { Event_Name, Start_date, End_date, All_Days, Attendees, Videocall_URL, Description, Activity_ID, Company_code, modified_by } = req.body;
  try {
    const pool = await sql.connect(dbConfig);
    await pool.request()
      .input("mode", sql.NVarChar, "U")
      .input("Event_Name", sql.NVarChar, Event_Name)
      .input("Start_date", sql.DateTime, Start_date)
      .input("End_date", sql.DateTime, End_date)
      .input("All_Days", sql.NVarChar, All_Days)
      .input("Attendees", sql.NVarChar, Attendees)
      .input("Videocall_URL", sql.NVarChar, Videocall_URL)
      .input("Description", sql.NVarChar, Description)
      .input("Activity_ID", sql.NVarChar, Activity_ID)
      .input("Company_code", sql.NVarChar, Company_code)
      .input("modified_by", sql.NVarChar, modified_by)
      .query(`EXEC sp_CRM_NewEvent @mode,0, @Event_Name, @Start_date, @End_date, @All_Days, @Attendees, @Videocall_URL, @Description, @Activity_ID, @Company_code, '', @modified_by, '', ''`);
    res.status(200).json({ success: true, message: "CRM_NewEvent updated successfully" });
  } catch (err) {
    console.error("Error during CRM_NewEvent update:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};
const CRM_NewEventDelete = async (req, res) => {
  const { Event_Name, Company_code } = req.body;
  try {
    const pool = await sql.connect(dbConfig);
    await pool.request()
      .input("mode", sql.NVarChar, "D")
      .input("Event_Name", sql.NVarChar, Event_Name)
      .input("Company_code", sql.NVarChar, Company_code)
      .query(`EXEC sp_CRM_NewEvent @mode,0, @Event_Name, '', '', '', '', '', '', '', @Company_code, '', '', '', ''`);
    res.status(200).json({ success: true, message: "CRM_NewEvent deleted successfully" });
  } catch (err) {
    console.error("Error during CRM_NewEvent delete:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

// Auto-generated Node.js CRUD for sp_CRM_Message

const CRM_MessageInsert = async (req, res) => {
  const { Send_To, Notes, Company_code, created_by, created_date } = req.body;
  let Files = null;
  if (req.file) Files = req.file.buffer;

  try {
    const pool = await sql.connect(dbConfig);
    await pool.request()
      .input("mode", sql.NVarChar, "I")
      .input("Send_To", sql.NVarChar, Send_To)
      .input("Notes", sql.NVarChar, Notes)
      .input("Files", sql.VarBinary, Files)
      .input("Company_code", sql.NVarChar, Company_code)
      .input("created_by", sql.NVarChar, created_by)
      .input("created_date", sql.NVarChar, created_date)
      .query(`EXEC sp_CRM_Message @mode, @Send_To, @Notes, @Files, @Company_code, @created_by, @created_date, '', ''`);

    res.status(200).json({ success: true, message: "CRM_Message insertd successfully" });
  } catch (err) {
    console.error("Error during CRM_Message insert:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const CRM_MessageUpdate = async (req, res) => {
  const { Send_To, Notes, Company_code, modified_by, modified_date } = req.body;
  let Files = null;
  if (req.file) Files = req.file.buffer;

  try {
    const pool = await sql.connect(dbConfig);
    await pool.request()
      .input("mode", sql.NVarChar, "U")
      .input("Send_To", sql.NVarChar, Send_To)
      .input("Notes", sql.NVarChar, Notes)
      .input("Files", sql.VarBinary, Files)
      .input("Company_code", sql.NVarChar, Company_code)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("modified_date", sql.NVarChar, modified_date)
      .query(`EXEC sp_CRM_Message @mode, @Send_To, @Notes, @Files, @Company_code, '', '', @modified_by, @modified_date`);

    res.status(200).json({ success: true, message: "CRM_Message updated successfully" });
  } catch (err) {
    console.error("Error during CRM_Message update:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const CRM_MessageDelete = async (req, res) => {
  const { Send_To, Company_code } = req.body;
  let Files = null;
  if (req.file) Files = req.file.buffer;

  try {
    const pool = await sql.connect(dbConfig);
    await pool.request()
      .input("mode", sql.NVarChar, "D")
      .input("Send_To", sql.NVarChar, Send_To)
      .input("Company_code", sql.NVarChar, Company_code)

      .query(`EXEC sp_CRM_Message @mode, @Send_To, '', '', @Company_code, '', '', '', ''`);

    res.status(200).json({ success: true, message: "CRM_Message deleted successfully" });
  } catch (err) {
    console.error("Error during CRM_Message delete:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const GetSalesperson = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "AD")
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_CRM_SalesPersonMaster @mode, '', '', '', '', '', '','', @company_code, '', '', '', '', '', '',''`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
const GetSalespersonALL = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "A")
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_CRM_SalesPersonMaster @mode, '', '', '', '', '', '','', @company_code, '', '', '', '', '', '',''`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
// Code Ended by Harish on 23_09_25

//Code added by pavun on 25-09-25
const salesPersonDropdown = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "GSP")
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_CRM_SalesPersonMaster @mode, '', '', '', '', '', '','', @company_code, '', '', '', '', '', '',''`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//Code ended by pavun on 25-09-25

// Code Added By Harish on 25_09_25

const GetDataContactInfo = async (req, res) => {
  const { ContactID, Contact_Info_ID } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "FC")
      .input("ContactID", sql.Int, ContactID)
      .input("Contact_Info_ID", sql.Int, Contact_Info_ID)
      .query(`EXEC sp_CRM_Contacts @mode,'','','','','','','','','','','','',@Contact_Info_ID,'','','', @ContactID ,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const GetDataContact = async (req, res) => {
  const { ContactID } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "FCI")
      .input("ContactID", sql.Int, ContactID)
      .query(`EXEC sp_CRM_Contacts @mode,'','','','','','','','','','','','',@Contact_Info_ID,'','','', @ContactID ,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//Code added by pavun on 26-09-25
const getContactEmail = async (req, res) => {
  const { Contact_ID, company_code, sourceType } = req.body;
  try {
    const pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "GCE")
      .input("Contact_ID", sql.Int, Contact_ID)
      .input("company_code", sql.NVarChar, company_code)
      .input("sourceType", sql.NVarChar, sourceType)
      .query(`EXEC sp_CRM_NewCompany @mode,0, '','', '', '', '','', 0,0,'', '', '', '', '', '', '', '', '',  '', '', '', '', '', '', '', '', '','', '',@Contact_ID,'',@company_code, '', '', @sourceType, '', 0, '','', '', '', '', '' `);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error during CRM_NewCompany delete:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const getContacts = async (req, res) => {
  const { Contact_ID, company_code, sourceType } = req.body;
  try {
    const pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "GCT")
      .input("Contact_ID", sql.Int, Contact_ID)
      .input("company_code", sql.NVarChar, company_code)
      .input("sourceType", sql.NVarChar, sourceType)
      .query(`EXEC sp_CRM_NewCompany @mode,0, '','', '', '', '','', 0,0,'', '', '', '', '', '', '', '', '',  '', '', '', '', '', '', '', '', '','', '',@Contact_ID,'',@company_code, '', '', @sourceType, '', 0, '','', '', '', '', ''`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error during CRM_NewCompany delete:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const getContactsDetails = async (req, res) => {
  const { Contact_ID, company_code, sourceType } = req.body;
  try {
    const pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "CT")
      .input("Contact_ID", sql.Int, Contact_ID)
      .input("company_code", sql.NVarChar, company_code)
      .input("sourceType", sql.NVarChar, sourceType)
      .query(`EXEC sp_CRM_NewCompany @mode,0, '','', '', '', '','', 0,0,'', '', '', '', '', '', '', '', '',  '', '', '', '', '', '', '', '', '','', '',@Contact_ID,'',@company_code, '', '', @sourceType, '', 0, '', '', '', '', '', ''`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error during CRM_NewCompany delete:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};
//Code ended by pavun on 26-09-25

//Code added by pavun on 27-09-25
const getSource = async (req, res) => {
  const { company_code } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    const result = await pool.request()
      .input("mode", sql.NVarChar, "GS")
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_CRM_Source @mode,''  , '', '', '', '', '', @company_code`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error during CRM_Source update:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};
//Code ended by pavun on 27-09-25
//Code added by Harish on 27-09-25
const getMedium = async (req, res) => {
  const { company_code } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    const result = await pool.request()
      .input("mode", sql.NVarChar, "MF")
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_CRM_Medium @mode,'','','','','','','',@company_code`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error during CRM_Source update:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};
//Code ended by Harish on 27-09-25


//Code added by pavun on 29-09-25
const searchSource = async (req, res) => {
  const { Source_ID, SourceName, company_code } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    const result = await pool.request()
      .input("mode", sql.NVarChar, "SC")
      .input("Source_ID", sql.NVarChar, Source_ID)
      .input("SourceName", sql.NVarChar, SourceName)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_CRM_Source @mode,@Source_ID, @SourceName, '', '', '', '', @company_code`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error during CRM_Source update:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};
//Code ended by pavun on 29-09-25

//Code added by pavun on 30-09-25
const mediumSearch = async (req, res) => {
  const { Medium_ID, MediumName, Status, company_code } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    const result = await pool.request()
      .input("mode", sql.NVarChar, "SC")
      .input("Medium_ID", sql.NVarChar, Medium_ID)
      .input("MediumName", sql.NVarChar, MediumName)
      .input("Status", sql.NVarChar, Status)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_CRM_Medium @mode,@Medium_ID,@MediumName,@Status,'','','','',@company_code`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error during CRM_Source update:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const CampaignSearch = async (req, res) => {
  const { CampaignID, CampaignName, Responsible, TagName, company_code } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("CampaignID", sql.NVarChar, CampaignID)
      .input("CampaignName", sql.NVarChar, CampaignName)
      .input("Responsible", sql.NVarChar, Responsible)
      .input("TagName", sql.NVarChar, TagName)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_CRM_Campaign @mode,@CampaignID, @CampaignName, @Responsible, @TagName, '', @company_code, '', '', '', '', ''`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error during CRM_Campaign insert:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const SearchSalesperson = async (req, res) => {
  const { SalesCode, SalesPersonName, EmailID, Language, Role, status, SalesTeam, company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("SalesCode", sql.NVarChar, SalesCode)
      .input("SalesPersonName", sql.NVarChar, SalesPersonName)
      .input("EmailID", sql.NVarChar, EmailID)
      .input("Language", sql.NVarChar, Language)
      .input("Role", sql.NVarChar, Role)
      .input("status", sql.NVarChar, status)
      .input("SalesTeam", sql.NVarChar, SalesTeam)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_CRM_SalesPersonMaster @mode, @SalesCode,@SalesPersonName,@EmailID,@Language,@Role,@status,@SalesTeam,@company_code, '', '', '', '', '', '',''`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getCampaign = async (req, res) => {
  const { company_code } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "GC")
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_CRM_Campaign @mode,'', '', '', '', '', @company_code, '', '', '', '', ''`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error during CRM_Campaign insert:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};
//Code ended by pavun on 30-09-25
//CODE Added by Harish on 03-10-25

// Auto-generated Node.js CRUD for sp_CRM_Tag_Master

const CRM_Tag_MasterInsert = async (req, res) => {
  const { Tag_Name, Tag_colour, Company_code, status, created_by } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    await pool.request()
      .input("mode", sql.NVarChar, "I")
      .input("Tag_Name", sql.NVarChar, Tag_Name)
      .input("Tag_colour", sql.NVarChar, Tag_colour)
      .input("Company_code", sql.NVarChar, Company_code)
      .input("status", sql.NVarChar, status)
      .input("created_by", sql.NVarChar, created_by)
      .query(`EXEC sp_CRM_Tag_Master @mode, @Tag_Name, @Tag_colour, @Company_code,@status, @created_by, '', '',''`);

    res.status(200).json({ success: true, message: "CRM_Tag_Master insertd successfully" });
  } catch (err) {
    console.error("Error during CRM_Tag_Master insert:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const CRM_Tag_MasterUpdate = async (req, res) => {
  const { Tag_Name, Tag_colour, Company_code, modified_by } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    await pool.request()
      .input("mode", sql.NVarChar, "U")
      .input("Tag_Name", sql.NVarChar, Tag_Name)
      .input("Tag_colour", sql.NVarChar, Tag_colour)
      .input("Company_code", sql.NVarChar, Company_code)
      .input("modified_by", sql.NVarChar, modified_by)
      .query(`EXEC sp_CRM_Tag_Master @mode, @Tag_Name, @Tag_colour, @Company_code,'', @modified_by, '', ''`);

    res.status(200).json({ success: true, message: "CRM_Tag_Master updated successfully" });
  } catch (err) {
    console.error("Error during CRM_Tag_Master update:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const CRM_Tag_MasterDelete = async (req, res) => {
  const { Tag_Name, Company_code } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    await pool.request()
      .input("mode", sql.NVarChar, "D")
      .input("Tag_Name", sql.NVarChar, Tag_Name)
      .input("Company_code", sql.NVarChar, Company_code)

      .query(`EXEC sp_CRM_Tag_Master @mode, @Tag_Name, '', @Company_code, '', '', '', ''`);

    res.status(200).json({ success: true, message: "CRM_Tag_Master deleted successfully" });
  } catch (err) {
    console.error("Error during CRM_Tag_Master delete:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};
// Code Added by Harish on 06/10/25

const GetTeam = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "FD")
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_CRM_SalesTeam_HDR @mode, '', '', '', '', '','',@company_code, '', '', '', ''
`);
    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
// Code Ended by Harish on 06/10/25
// Code Added by Harish on 07-10-25

const GetSalesTeam = async (req, res) => {
  const { SalesTeam_Code, company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "FO")
      .input("SalesTeam_Code", sql.NVarChar, SalesTeam_Code)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_CRM_NewCompany @mode,0, '', '', 0, '', '','', 0,0,'', '', '', '', '', '', '', '', '',  '', '', @SalesTeam_Code,'', '', '', '', '', '', '','',0,'',@company_code, '', '', '', '', 0, '','', '', '', '', ''`);
    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const GetTeamName = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "FDD")
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_CRM_SalesTeam_HDR @mode, '', '', '', '', '','',@company_code, '', '', '', ''`);
    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
const GetActivity = async (req, res) => {
  const { Opportunity_ID, company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "FA")
      .input("Opportunity_ID", sql.Int, Opportunity_ID)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_CRM_Activity @mode, 0,@Opportunity_ID,'','', '', '', '', '', @Company_code,'','','','',0,0, '','','', '', '', ''`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

// Code Ended by Harish on 07-10-25
// Code Added by Harish on 08-10-25

const GetContactClient = async (req, res) => {
  const { CompanyName, Person_name, Phone, Email, company_code } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    const result = await pool.request()
      .input("mode", sql.NVarChar, "FCI")
      .input("CompanyName", sql.VarChar, CompanyName)
      .input("Person_name", sql.VarChar, Person_name)
      .input("Phone", sql.VarChar, Phone)
      .input("Email", sql.VarChar, Email)
      .input("company_code", sql.VarChar, company_code)
      .query(`EXEC sp_CRM_ContactInfo 'FCI', '', '',@Email, @CompanyName,@Phone, '', '', '', '','','','','','','','','',@company_code,'','','',@Person_name,'','','','','','','','','',''`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    }
    else {
      res.status(404).json('Data not found')
    }
  } catch (err) {
    console.error("Error during CRM_ContactInfo delete:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const GetContactInfo = async (req, res) => {
  const { ContactID, company_code } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    const result = await pool.request()
      .input("mode", sql.NVarChar, "FC")
      .input("ContactID", sql.Int, ContactID)
      .input("company_code", sql.VarChar, company_code)
      .query(`EXEC sp_CRM_ContactInfo @mode,@ContactID, '', '', '','', '', '', '', '','','','','','','','','',@company_code,'','','','','','','','','','','','','',''`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    }
    else {
      res.status(404).json('Data not found')
    }
  } catch (err) {
    console.error("Error during CRM_ContactInfo delete:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};
// Code Ended by Harish on 08-10-25

//Code added by pavun on 08-10-25
const activitySearch = async (req, res) => {
  const { stage, Company, OpportunityName, ContactName, company_code, ExpectedRevenue, Payment } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("company_code", sql.NVarChar, company_code)
      .input("stage", sql.NVarChar, stage)
      .input("Company", sql.NVarChar, Company)
      .input("OpportunityName", sql.NVarChar, OpportunityName)
      .input("ContactName", sql.NVarChar, ContactName)
      .input("ExpectedRevenue", sql.Decimal(12, 2), ExpectedRevenue)
      .input("Payment", sql.Decimal(12, 2), Payment)
      .query(`EXEC sp_CRM_Activity @mode,0,0, '', '', '', '', '','',@Company_code,@stage,@Company,@OpportunityName,@ContactName,@ExpectedRevenue,@Payment,'','', '', '', '', ''`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//Code ended by pavun on 08-10-25

// code added by mathu-08-10-2025
const TagSearch = async (req, res) => {
  const { Tag_Name, Tag_colour, status, Company_code } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("Tag_Name", sql.NVarChar, Tag_Name)
      .input("Tag_colour", sql.NVarChar, Tag_colour)
      .input("status", sql.NVarChar, status)
      .input("Company_code", sql.NVarChar, Company_code)
      .query(`EXEC sp_CRM_Tag_Master @mode,@Tag_Name,@Tag_colour,@Company_code,'', '', '', '', ''`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error during CRM_Tag insert:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const getTagName = async (req, res) => {
  const { Company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "TN")
      .input("Company_code", sql.NVarChar, Company_code)
      .query(`EXEC sp_CRM_Tag_Master @mode, '', '', @Company_code, '', '', '','',''`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//Code added by Harish on 09-10-25
const GetActivityAll = async (req, res) => {
  const { Opportunity_ID, company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "A")
      .input("Opportunity_ID", sql.Int, Opportunity_ID)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_CRM_Activity @mode, 0,@Opportunity_ID,'','', '', '', '', '', @Company_code,'','','','',0,0,'','', '', '', '', ''`);
    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//Code ended by harish on 09-10-25

//Code added by sakthi on 09-10-25
const GetContactInfoData = async (req, res) => {
  const { ContactID, company_code } = req.body;
  try {
    const pool = await sql.connect(dbConfig);
    const result = await pool.request()
      .input("mode", sql.NVarChar, "FC")
      .input("ContactID", sql.Int, ContactID)
      .input("company_code", sql.VarChar, company_code)
      .query(`EXEC sp_CRM_ContactInfo @mode,@ContactID, '', '', '','', '', '', '', '','','','','','','',@company_code,'','','','','','','','','','','','','',''`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    }
    else {
      res.status(404).json('Data not found')
    }
  } catch (err) {
    console.error("Error during CRM_ContactInfo delete:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const GetContactInfoDetails = async (req, res) => {
  const { ContactID, company_code, sourceType } = req.body;
  try {
    const pool = await sql.connect(dbConfig);
    const result = await pool.request()
      .input("mode", sql.NVarChar, "GCD")
      .input("ContactID", sql.Int, ContactID)
      .input("company_code", sql.NVarChar, company_code)
      .input("sourceType", sql.NVarChar, sourceType)
      .query(`EXEC sp_CRM_ContactInfo @mode,@ContactID, '', '', '','', '', '', '', '','','','','','','','','',@company_code,'','','','','','','',@sourceType,'','','','','',''`);
    if (result.recordset.length > 0) {
      const data = {
        ContactInfo: result.recordsets[0],
        Contact: result.recordsets[1] || [],
      };
      res.status(200).json(data);
    }
    else {
      res.status(404).json('Data not found')
    }
  } catch (err) {
    console.error("Error during CRM_ContactInfo delete:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const GetCompanyMonth = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "MS")
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_CRM_NewCompany @mode,0, '', '', 0, '', '','', 0,0,'', '', '', '', '', '', 0, '', '',  '', '', '', '', '', '', '', '', '','', '',0,'',@company_code, '', '', '', '', 0, '','', '', '', '', ''`);

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//Code added by pavun on 11-10-25
const SalesTeamSearch = async (req, res) => {
  const { Sales_Team, Team_Leader, Email_alias, Emails_From, Company_code } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    const result = await pool.request()
      .input("mode", sql.NVarChar, "SC")
      .input("Sales_Team", sql.NVarChar, Sales_Team)
      .input("Team_Leader", sql.NVarChar, Team_Leader)
      .input("Email_alias", sql.NVarChar, Email_alias)
      .input("Emails_From", sql.NVarChar, Emails_From)
      .input("Company_code", sql.NVarChar, Company_code)
      .query(`EXEC sp_CRM_SalesTeam_HDR @mode,'',@Sales_Team,@Team_Leader,@Email_alias,@Emails_From,'',@Company_code,'','','',''`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    }
    else {
      res.status(404).json('Data not found')
    }
  } catch (err) {
    console.error("Error during CRM_SalesTeam_HDR insert:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};
//Code ended by pavun on 11-10-25

// Code Added by Harish on 11-10-25

const Forecastsearch = async (req, res) => {
  const { company_code, Company, Contact, SalesPersonName, OpportunityName, ExpectedRevenue, ContactPhone, Payment, Email_id, ExpectedClosing } = req.body;
  try {
    const pool = await connection.connectToDatabase(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("Company", sql.NVarChar, Company)
      .input("Contact", sql.VarChar, Contact)
      .input("OpportunityName", sql.NVarChar, OpportunityName)
      .input("ContactPhone", sql.VarChar, ContactPhone)
      .input("ExpectedRevenue", sql.Decimal(12, 2), ExpectedRevenue)
      .input("Payment", sql.Decimal(12, 2), Payment)
      .input("Email_id", sql.VarChar, Email_id)
      .input("ExpectedClosing", sql.VarChar, ExpectedClosing)
      .input("SalesPersonName", sql.VarChar, SalesPersonName)
      .input("company_code", sql.VarChar, company_code)
      .query(`EXEC sp_CRM_NewCompany @mode, 0, @Company, @Contact, 0, @OpportunityName,'', @ContactPhone,@ExpectedRevenue, @Payment, '', @ExpectedClosing, @Email_ID, '', '',
        '', '', '', '', '', '', '','', '', '', '', '','', '', '','','', @company_code, '', '','','',0,'',@SalesPersonName,'', '', '', ''`)
    // Send response
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset); // 200 OK if data is found
    } else {
      res.status(404).json("Data not found"); // 404 Not Found if no data is found
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//Code Added by Harish 13-10-25

const CRM_CompanyDateUpdate = async (req, res) => {
  const {
    Opportunity_ID, ExpectedClosing, company_code, modified_by
  } = req.body;
  try {
    const pool = await sql.connect(dbConfig);
    await pool.request()
      .input("mode", sql.NVarChar, "UDT")
      .input("Opportunity_ID", sql.Int, Opportunity_ID)
      .input("ExpectedClosing", sql.Date, ExpectedClosing)
      .input("company_code", sql.NVarChar, company_code)
      .input("modified_by", sql.NVarChar, modified_by)
      .query(`EXEC sp_CRM_NewCompany @mode, 0, '', '', @Opportunity_ID, '','', '',0, 0, '', @ExpectedClosing, '', '', '','', 0, '', '', '', '', '','', '', '', '', '','', '', '',0,'', @company_code, '', '','','',0,'','','','',@modified_by,''`);
    res.status(200).json({ success: true, message: "CRM_NewCompany updated successfully" });
  } catch (err) {
    console.error("Error during CRM_NewCompany update:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

// Code Added by Sakthi on 14-10-25

const CRM_CompanySearch = async (req, res) => {
  const {
    Company_or_Persona,
    Email,
    CompanyName,
    Phone,
    Name,
    Address1,
    Address2,
    Address3,
    contact_no,
    State,
    Country,
    Address,
    company_code,
    status,
    Person_name,
  } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SCC")
      .input("Company_or_Persona", sql.NVarChar, Company_or_Persona)
      .input("Email", sql.NVarChar, Email)
      .input("CompanyName", sql.NVarChar, CompanyName)
      .input("Phone", sql.NVarChar, Phone)
      .input("Address1", sql.NVarChar, Address1)
      .input("Address2", sql.NVarChar, Address2)
      .input("Address3", sql.NVarChar, Address3)
      .input("State", sql.NVarChar, State)
      .input("Country", sql.NVarChar, Country)
      .input("contact_no", sql.NVarChar, contact_no)
      .input("Address", sql.NVarChar, Address)
      .input("Name", sql.NVarChar, Name)
      .input("company_code", sql.NVarChar, company_code)
      .input("status", sql.NVarChar, status)
      .input("Person_name", sql.NVarChar, Person_name)
      .query(`EXEC sp_CRM_ContactInfo @mode,'',@Company_or_Persona,@Email,@CompanyName,@Phone,'','','','',@Address1,@Address2,@Address3,'','',@State,@Country,'',@company_code,@status,'','',@Person_name,@Name,@contact_no,@Address,'','','','','','',''`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error in CRMCompanySearch:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

// Code Added by Harish on 24/10/25
const CRM_MarkUP = async (req, res) => {
  const { Activity_ID, Company_code, modified_by } = req.body;
  try {
    const pool = await sql.connect(dbConfig);
    await pool.request()
      .input("mode", sql.NVarChar, "MK")
      .input("Activity_ID", sql.Int, Activity_ID)
      .input("Company_code", sql.NVarChar, Company_code)
      .input("modified_by", sql.NVarChar, modified_by)
      .query(`EXEC sp_CRM_Activity @mode,@Activity_ID,0,'', '', '', '', '', '', @Company_code,'','','','',0,0,0,'','',@modified_by,'',''`);
    res.status(200).json({ success: true, message: "CRM_Activity updated successfully" });
  } catch (err) {
    console.error("Error during CRM_Activity update:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

//Code added by pavun on 24-10-25
const SalesTeamChart = async (req, res) => {
  const { mode, company_code, start_date, end_date } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    const result = await pool.request()
      .input("mode", sql.NVarChar, mode)
      .input("company_code", sql.NVarChar, company_code)
      .input("start_date", sql.Date, start_date)
      .input("end_date", sql.Date, end_date)
      .query(`EXEC sp_CRM_SalesTeam_Chart @mode,@company_code,@start_date,@end_date,''`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    }
    else {
      res.status(404).json('Data not found')
    }
  } catch (err) {
    console.error("Error during CRM_SalesTeam_HDR insert:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};
//Code ended by pavun on 24-10-25

//Code added by Harish on 29-10-25
const Pipelinechart = async (req, res) => {
  const { mode, company_code, DynamicYear, start_date, end_date } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    const result = await pool.request()
      .input("mode", sql.NVarChar, mode)
      .input("company_code", sql.NVarChar, company_code)
      .input("start_date", sql.Date, start_date)
      .input("end_date", sql.Date, end_date)
      .input("DynamicYear", sql.Int, DynamicYear)
      .query(`EXEC sp_CRM_PipeLine_Chart @mode,@company_code,@start_date,@end_date,@DynamicYear,''`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    }
    else {
      res.status(404).json('Data not found')
    }
  } catch (err) {
    console.error("Error during CRM_SalesTeam_HDR insert:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};
//Code ended by pavun on 29-10-25

// Code Added by Harish on 30-09-25
const PipelineDetailChart = async (req, res) => {
  const { mode, company_code, start_date, end_date, sales_team_name } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    const result = await pool.request()
      .input("mode", sql.NVarChar, mode)
      .input("company_code", sql.NVarChar, company_code)
      .input("start_date", sql.Date, start_date)
      .input("end_date", sql.Date, end_date)
      .input("sales_team_name", sql.NVarChar, sales_team_name)
      .query(`EXEC sp_CRM_PipeLine_Chart @mode, @company_code, @start_date, @end_date, 0, @sales_team_name`);

    if (result && result.recordset && result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json('Data not found');
    }
  } catch (err) {
    console.error("Error during PipelineDetailChart:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

// Code Added by Dinesh Gokul on 31-09-25
const ActivityChart = async (req, res) => {
  const { mode, From_Date, To_Date, company_code } = req.body;
  try {
    const pool = await sql.connect(dbConfig);
    const result = await pool.request()
      .input("mode", sql.NVarChar, mode)
      .input("From_Date", sql.Date, From_Date)
      .input("To_Date", sql.Date, To_Date)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_CRM_Activity_Chart @mode,@From_Date,@To_Date,@company_code,''`);
    const records = result?.recordset || [];

    if (records.length > 0) {
      res.status(200).json(records);
    } else {
      res.status(404).json({ message: "Data not found" });
    }
  } catch (err) {
    console.error("Error during ActivityChart insert:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

//Code added by pavun on 31-10-25
const getDomain = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query("EXEC sp_attribute_Info 'F',@company_code,'Domain','','', '','','' , NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL");

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//Code ended by pavun on 31-10-25

//Code added by Dinesh Gokul on 30-10-25
const CRM_Lose_Insert = async (req, res) => {
  const { OpportunityID, Reason_for_Lose, Description, company_code, SalesTeam, Sales_man_code, Created_by } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    await pool.request()
      .input("mode", sql.NVarChar, "i")
      .input("OpportunityID", sql.Int, OpportunityID)
      .input("Reason_for_Lose", sql.VarChar, Reason_for_Lose)
      .input("Description", sql.VarChar, Description)
      .input("company_code", sql.NVarChar, company_code)
      .input("SalesTeam", sql.NVarChar, SalesTeam)
      .input("Sales_man_code", sql.NVarChar, Sales_man_code)
      .input("Created_by", sql.VarChar, Created_by)
      .query(`EXEC sp_CRM_Lose @mode, @OpportunityID,@Reason_for_Lose,@Description,@company_code,@SalesTeam,@Sales_man_code, '', '',@Created_by, ''`);

    res.status(200).json({ success: true, message: "CRM_Lose_Insert inserted successfully" });
  } catch (err) {
    console.error("Error during CRM_Lose_Insert insert:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

// //Code added by Dinesh Gokul on 30-10-25
// const CRM_Lose_Update = async (req, res) => {
//   const { OpportunityID,Reason_for_Lose,Description,company_code,SalesTeam,Sales_man_code,modified_by} = req.body;

//   try {
//     const pool = await sql.connect(dbConfig);
//     await pool.request()
//       .input("mode", sql.NVarChar, "u")
//       .input("OpportunityID", sql.Int, OpportunityID)
//       .input("Reason_for_Lose", sql.VarChar, Reason_for_Lose)
//       .input("Description", sql.VarChar, Description)
//       .input("company_code", sql.NVarChar, company_code)
//       .input("SalesTeam", sql.NVarChar, SalesTeam)
//       .input("Sales_man_code", sql.NVarChar, Sales_man_code)
//       .input("modified_by", sql.VarChar, modified_by)
//       .query(`EXEC sp_CRM_Lose @mode, @OpportunityID,@Reason_for_Lose,@Description,@company_code,@SalesTeam,@Sales_man_code, '', '','', '@modified_by'`);

//     res.status(200).json({ success: true, message: "CRM_Lose_Update inserted successfully" });
//   } catch (err) {
//     console.error("Error during CRM_Lose_Update insert:", err);
//     res.status(500).json({ message: err.message || "Internal Server Error" });
//   }
// };

//Code added by Dinesh Gokul on 30-10-25
const CRM_Lose_Delete = async (req, res) => {
  const { Sales_man_code } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    await pool.request()
      .input("mode", sql.NVarChar, "d")
      .input("Sales_man_code", sql.NVarChar, Sales_man_code)
      .query(`EXEC sp_CRM_Lose @mode, '','','','','',@Sales_man_code, '', '','', ''`);

    res.status(200).json({ success: true, message: "CRM_Lose_Delete deleted successfully" });
  } catch (err) {
    console.error("Error during CRM_Lose_Delete delete:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

//Code added by Dinesh Gokul on 30-10-25
const CRM_Lose_Select = async (req, res) => {
  const { company_code } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    const result = await pool.request()
      .input("mode", sql.NVarChar, "a")
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_CRM_Lose @mode, '','','',@company_code,'','', '', '','', ''`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error during CRM_Lose_Select update:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

// Code Added by Harish on 01-11-25
const GetAllMeeting = async (req, res) => {
  const { OppurtInity_ID, company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "A")
      .input("OppurtInity_ID", sql.Int, OppurtInity_ID)
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_CRM_NewEvent @mode,'',@OppurtInity_ID, '', '', '', '', '', '','', @Company_code, '', '', '','' `)
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
// Code Ended by Harish on 01-11-25

//Code added by pavun on 01-11-25
const SalesTeamDetailChart = async (req, res) => {
  const { mode, company_code, start_date, end_date, detail_name } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    const result = await pool.request()
      .input("mode", sql.NVarChar, mode)
      .input("company_code", sql.NVarChar, company_code)
      .input("start_date", sql.Date, start_date)
      .input("end_date", sql.Date, end_date)
      .input("detail_name", sql.NVarChar, detail_name)
      .query(`EXEC sp_CRM_SalesTeam_Chart @mode,@company_code,@start_date,@end_date,@detail_name`);

    const records = result?.recordset || [];

    if (records.length > 0) {
      res.status(200).json(records);
    } else {
      res.status(404).json({ message: "Data not found" });
    }
  } catch (err) {
    console.error("Error during CRM_SalesTeam_HDR insert:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};
//Code ended by pavun on 01-11-25

//code added by madhu on 01-11-25
const GetActive = async (req, res) => {
  const { OpportunityName, ContactName, Company_code } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "FS")
      .input("OpportunityName", sql.NVarChar, OpportunityName)
      .input("ContactName", sql.NVarChar, ContactName)
      .input("Company_code", sql.NVarChar, Company_code)
      .query(`EXEC sp_CRM_Activity @mode,0,'','','','','','', @Company_code,'','',
          @OpportunityName, @ContactName,0,0,Null,Null,Null,Null,Null,Null,Null`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error during CRM_Lose_Select update:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

//code added by madhu on 05-11-25
const GetRevenue = async (req, res) => {
  const { Company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "RE")
      .input("Company_code", sql.NVarChar, Company_code)
      .query(`EXEC sp_CRM_Activity @mode, 0, 0, '', '', '', '', '', '', @Company_code, '', '', '', '', 0, 0, '', '', '', '', '', ''`);

    res.json({ success: true, data: result.recordset });
  } catch (err) {
    console.error("Error fetching contacts", err);
    res.status(500).json({ success: false, message: err.message });
  }
};

//Code added by pavun on 06-11-2025
const GetAllEvent = async (req, res) => {
  const { Company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "S")
      .input("Company_code", sql.NVarChar, Company_code)
      .query(`EXEC sp_CRM_NewEvent @mode,'',0, '', '', '', '', '', '','', @Company_code, '', '', '','' `)
    const records = result?.recordset || [];
    if (records.length > 0) {
      res.status(200).json(records);
    } else {
      res.status(404).json({ message: "Data not found" });
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//Code ended by pavun on 06-11-2025

//code added by mathu- 06-11-2025
const CRMSalesTeamUpdateGrid = async (req, res) => {
  const editedData = req.body.editedData;

  if (!editedData || !editedData.length) {
    res.status(400).json("Invalid or empty editedData array.");
    return;
  }

  try {
    const pool = await connection.connectToDatabase(dbConfig);

    for (const updatedRow of editedData) {
      await pool
        .request()
        .input("mode", sql.NVarChar, "U") // update mode
        .input("Sales_ID", sql.NVarChar, updatedRow.Sales_ID)
        .input("Sales_Team", sql.NVarChar, updatedRow.Sales_Team)
        .input("Team_Leader", sql.NVarChar, updatedRow.Team_Leader)
        .input("Email_alias", sql.NVarChar, updatedRow.Email_alias)
        .input("Emails_From", sql.NVarChar, updatedRow.Emails_From)
        .input("Company_code", sql.NVarChar, updatedRow.Company_code)
        .input("modified_by", sql.NVarChar, updatedRow.modified_by)
        .query(`EXEC sp_CRM_SalesTeam_HDR @mode, @Sales_ID, @Sales_Team, @Team_Leader, @Email_alias, @Emails_From,'', @Company_code,'', @modified_by,'',''`);

    }

    res.status(200).json("Edited data saved successfully");
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//Code Added by Harish 06-11-25

const CRM_LoseSC = async (req, res) => {
  const { } = req.body;
  try {
    const pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "Lost")
      .query(`EXEC sp_CRM_Lose @mode,0, '', '', '', '', 0, '', '', '', ''`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error in CRM Lose Search:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

//Code Ended by Harish 06-11-25

//Code added by pavun on 07-11-25
const ActivityDetailChart = async (req, res) => {
  const { mode, company_code, detail_name } = req.body;
  try {
    const pool = await sql.connect(dbConfig);
    const result = await pool.request()
      .input("mode", sql.NVarChar, mode)
      .input("company_code", sql.NVarChar, company_code)
      .input("detail_name", sql.NVarChar, detail_name)
      .query(`EXEC sp_CRM_Activity_Chart @mode,'','',@company_code,@detail_name`);
    const records = result?.recordset || [];

    if (records.length > 0) {
      res.status(200).json(records);
    } else {
      res.status(404).json({ message: "Data not found" });
    }
  } catch (err) {
    console.error("Error during ActivityChart insert:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};
//Code ended by pavun on 07-11-25

//Code Added by Harish 07-11-25

const CRM_PV = async (req, res) => {
  const { } = req.body;
  try {
    const pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "PT")
      .query(`EXEC sp_CRM_PivotTable @mode, 0, '', '', '', '',  0, '', '', '', '' `);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error in CRM Lose Search:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

//Code Ended by Harish 07-11-25

//Code added by pavun on 10-11-25
const GetCalendarEvent = async (req, res) => {
  const { Company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "EC")
      .input("Company_code", sql.NVarChar, Company_code)
      .query(`EXEC sp_CRM_NewEvent @mode,'',0, '', '', '', '', '', '','', @Company_code, '', '', '','' `)
    const records = result?.recordset || [];
    if (records.length > 0) {
      res.status(200).json(records);
    } else {
      res.status(404).json({ message: "Data not found" });
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//Code ended by pavun on 10-11-25

//code added by mathu-17-11-2025
const ContactSearch = async (req, res) => {
  const {
    email,
    company_name,
    contact_name,
    contact_no,
    Country,
    status,
    Address,
    type_of_contact,
    company_code
  } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SC")
      .input("email", sql.NVarChar, email)
      .input("company_name", sql.VarChar, company_name)
      .input("contact_name", sql.NVarChar, contact_name)
      .input("contact_no", sql.NVarChar, contact_no)
      .input("Country", sql.NVarChar, Country)
      .input("status", sql.NVarChar, status)
      .input("Address", sql.NVarChar, Address)
      .input("type_of_contact", sql.VarChar, type_of_contact)
      .input("company_code", sql.VarChar, company_code)
      .query(`EXEC sp_CRM_Contacts @mode,'',@contact_no,@email,@Address,@Country,'','','',@company_code,'','','','',@company_name,@contact_name,@type_of_contact,'',@status,'','','','','','','','','',''`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error in CompanySearch:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};
//code ended by mathu-17-11-2025
//Code added By Harish 21-11-2025
const getCount = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'weight','','', '','','', NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//Code Ended By Harish 21-11-2025
// Code Added by Harish on 22/11/25
const getSecondaryuom = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'SecondaryUOM','','', '','','', NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );

    res.json(result.recordset);
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
// Code Ended by harish on 22/11/25

// Code Added by Harish on 22/11/25
const EmpStatus = async (req, res) => {
  const { company_code } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("company_code", sql.NVarChar, company_code)
      .query(
        "EXEC sp_attribute_Info 'F',@company_code,'EmpStatus','','', '','','', NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL"
      );
    res.json(result.recordset);
  } catch (err) {
    console.error("Error during update:", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
// Code Ended by harish on 22/11/25
// Code Added By Harish 25_11_25
const getTaskHourReportLeave = async (req, res) => {
  const { start_date, end_date, userid, company_code, Status } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "LF")
      .input("start_date", sql.Date, start_date)
      .input("end_date", sql.Date, end_date)
      .input("userid", sql.VarChar, userid)
      .input("company_code", sql.VarChar, company_code)
      .input("Status", sql.VarChar, Status)
      .query(`EXEC sp_task_hour_report @mode,@start_date,@end_date,@userid,'',@company_code,0, @Status`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
// Code Ended by harish on 25_11_25

// Code Added By Dinesh Gokul 02_12_25
const UOMConverterInsert = async (req, res) => {
  const { Item_code, Uom, UomQty, Suom, SuomQty, company_code, created_by } = req.body;
  try {
    const pool = await connection.connectToDatabase();
    await pool
      .request()
      .input("mode", sql.VarChar, "I")
      .input("Item_code", sql.VarChar, Item_code)
      .input("Uom", sql.NVarChar, Uom)
      .input("UomQty", sql.NVarChar, UomQty)
      .input("Suom", sql.NVarChar, Suom)
      .input("SuomQty", sql.NVarChar, SuomQty)
      .input("company_code", sql.VarChar, company_code)
      .input("created_by", sql.VarChar, created_by)
      .query(`EXEC sp_Item_Uom_Convertor @mode, @Item_code, @Uom, @UomQty, @Suom, @SuomQty, @company_code, @created_by, NULL, NULL, NULL`);
    res.status(200).json("Data inserted successfully");
  } catch (err) {
    console.error("Error inserting data:", err);
    res.status(500).json({
      message: err.message || "Internal Server Error"
    });
  }
};
// Code Ended By Dinesh Gokul 02_12_25
// Code Added by Harish  on 12-12-25
const getItemVariant = async (req, res) => {
  const { company_code, Item_variant } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "IVV")
      .input("company_code", sql.NVarChar, company_code)
      .input("Item_variant", sql.NVarChar, Item_variant)
      .query(`EXEC sp_item_brand_info @mode,@company_code,'',@Item_variant,'',0,'','','',0,0,0, 0,'','','','','','','','','','','',0,0,'','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

// Code Ended by Harish  on 12-12-25
// Code Added by Harish  on 12-12-25
const getPay = async (req, res) => {
  const { company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "FA")
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_attribute_Info 'FA',@company_code,'Payment','','', '','','', NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

// Code Ended by Harish  on 12-12-25
// Code Added by Harish on 19-12-25

const addSalesOrderHdr = async (req, res) => {
  const {company_code, bill_date, bill_no, warehouse_code, sales_type, customer_code, sale_amt, net_amt, roff_amt, othr_amt, bill_amt, tax_amount, total_item, pay_type,  sman_code,
    payment_mode, customer_name, order_type, 
    sales_mode, paid_amount, return_amount, created_by} = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("bill_date", sql.Date, bill_date)
      .input("bill_no", sql.NVarChar, bill_no)
      .input("warehouse_code", sql.NVarChar, warehouse_code)
      .input("sales_type", sql.NVarChar, sales_type)
      .input("customer_code", sql.NVarChar, customer_code)
      .input("sale_amt", sql.Decimal(14, 2), sale_amt)
      .input("net_amt", sql.Decimal(14, 2), net_amt)
      .input("roff_amt", sql.Decimal(14, 2), roff_amt)
      .input("othr_amt", sql.Decimal(14, 2), othr_amt)
      .input("bill_amt", sql.Decimal(14, 2), bill_amt)
      .input("tax_amount", sql.Decimal(14, 2), tax_amount)
      .input("total_item", sql.Int, total_item)
      .input("pay_type", sql.NVarChar, pay_type)
      .input("sman_code", sql.NVarChar, sman_code)
      .input("payment_mode", sql.NVarChar, payment_mode)
      .input("customer_name", sql.NVarChar, customer_name)
      .input("order_type", sql.NVarChar, order_type)
      .input("sales_mode", sql.VarChar, sales_mode)
      .input("paid_amount", sql.Decimal(14, 2), paid_amount)
      .input("return_amount", sql.Decimal(14, 2), return_amount)
      .input("created_by", sql.NVarChar, created_by)
      .query(`EXEC sp_sales_order_hdr @mode,@company_code,@bill_date,@bill_no,@warehouse_code,@sales_type,@customer_code,@sale_amt,@net_amt,@roff_amt,@othr_amt,@bill_amt,@tax_amount,@total_item,@pay_type,@sman_code,@payment_mode,@customer_name,
        @order_type,'','',@sales_mode,@paid_amount,@return_amount,@created_by,'',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json({ message: "Data not found" });
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const addSalesOrderDetail = async (req, res) => {
  const {company_code,bill_date,bill_no,warehouse_code,customer_code,item_code,ItemSNo,item_name,
    bill_qty,bill_rate,item_amt,weight,total_weight,pay_type,sales_type,sman_code,customer_name,
    order_type,hsn,tax_amt,discount,discount_amount,created_by,} = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") 
      .input("company_code", sql.NVarChar, company_code)
      .input("bill_date", sql.Date, bill_date)
      .input("bill_no", sql.NVarChar, bill_no)
      .input("warehouse_code", sql.NVarChar, warehouse_code)
      .input("customer_code", sql.NVarChar, customer_code)
      .input("item_code", sql.NVarChar, item_code)
      .input("ItemSNo", sql.BigInt, ItemSNo)
      .input("item_name", sql.NVarChar, item_name)
      .input("bill_qty", sql.Decimal(10, 2), bill_qty)
      .input("bill_rate", sql.Decimal(10, 2), bill_rate)
      .input("item_amt", sql.Decimal(10, 2), item_amt)
      .input("weight", sql.Decimal(8, 3), weight)
      .input("total_weight", sql.Decimal(10, 2), total_weight)
      .input("pay_type", sql.NVarChar, pay_type)
      .input("sales_type", sql.NVarChar, sales_type)
      .input("sman_code", sql.NVarChar, sman_code)
      .input("customer_name", sql.NVarChar, customer_name)
      .input("order_type", sql.NVarChar, order_type)
      .input("hsn", sql.NVarChar, hsn)
      .input("tax_amt", sql.Decimal(14, 2), tax_amt)
      .input("discount", sql.Decimal(5, 2), discount)
      .input("discount_amount", sql.Decimal(14, 2), discount_amount)
      .input("created_by", sql.NVarChar, created_by)
      .query(`EXEC sp_sales_order_details @mode, @company_code,@bill_date,@bill_no,@warehouse_code,@customer_code,@item_code,@ItemSNo,@item_name,@bill_qty,
        @bill_rate,@item_amt,@weight,@total_weight,@pay_type,@sales_type,@sman_code,@customer_name,@order_type,@hsn,@tax_amt,'','',@discount,@discount_amount,@created_by,'',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);
    res.json({ success: true, message: "Data inserted successfully" });
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

//Code added by pavun on 22-12-25
// Code Added by Harish on 24-12-25
const getCategoriesMaster = async (req, res) => {
  const { company_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode",         sql.NVarChar, "ICF")
      .input("company_code", sql.NVarChar, company_code)
      .query(`EXEC sp_Item_Category_Master @mode,'','','','   ','','','',0,0,0,0,'','','','','',@company_code,'','','',''`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};
//Code ended by pavun on 22-12-25
//Code Added by Harish on 23-12-25
const addSelectionSalesOrderHdr = async (req, res) => {
  const {company_code, bill_date, warehouse_code, sales_type, customer_code, sale_amt, net_amt, roff_amt, othr_amt, bill_amt, tax_amount, total_item, pay_type,  sman_code,
    payment_mode, customer_name, order_type, 
    sales_mode, paid_amount, return_amount, created_by} = req.body;
  let pool;
  try {
    pool = await sql.connect(dbConfig);
    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "I") // Insert mode
      .input("company_code", sql.NVarChar, company_code)
      .input("bill_date", sql.Date, bill_date)
      .input("warehouse_code", sql.NVarChar, warehouse_code)
      .input("sales_type", sql.NVarChar, sales_type)
      .input("customer_code", sql.NVarChar, customer_code)
      .input("sale_amt", sql.Decimal(14, 2), sale_amt)
      .input("net_amt", sql.Decimal(14, 2), net_amt)
      .input("roff_amt", sql.Decimal(14, 2), roff_amt)
      .input("othr_amt", sql.Decimal(14, 2), othr_amt)
      .input("bill_amt", sql.Decimal(14, 2), bill_amt)
      .input("tax_amount", sql.Decimal(14, 2), tax_amount)
      .input("total_item", sql.Int, total_item)
      .input("pay_type", sql.NVarChar, pay_type)
      .input("sman_code", sql.NVarChar, sman_code)
      .input("payment_mode", sql.NVarChar, payment_mode)
      .input("customer_name", sql.NVarChar, customer_name)
      .input("order_type", sql.NVarChar, order_type)
      .input("sales_mode", sql.VarChar, sales_mode)
      .input("paid_amount", sql.Decimal(14, 2), paid_amount)
      .input("return_amount", sql.Decimal(14, 2), return_amount)
      .input("created_by", sql.NVarChar, created_by)
      .query(`EXEC sp_Ecommerce_selection_hdr @mode,@company_code,@bill_date,@warehouse_code,@sales_type,@customer_code,@sale_amt,@net_amt,@roff_amt,@othr_amt,@bill_amt,@tax_amount,@total_item,@pay_type,@sman_code,@payment_mode,@customer_name,
        @order_type,'','',@sales_mode,@paid_amount,@return_amount,@created_by,'',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json({ message: "Data not found" });
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const addSelectionSalesOrderDetail = async (req, res) => {
  const {
    company_code,
    bill_date,
    transaction_no,   // âœ… from header
    warehouse_code,
    customer_code,
    item_code,
    item_name,
    bill_qty,
    bill_rate,
    item_amt,
    weight,
    total_weight,
    pay_type,
    sales_type,
    sman_code,
    customer_name,
    order_type,
    hsn,
    tax_amt,
    discount,
    discount_amount,
    created_by,
  } = req.body;

  try {
    const pool = await sql.connect(dbConfig);

    await pool
      .request()
      .input("mode", sql.NVarChar, "I")
      .input("company_code", sql.NVarChar, company_code)
      .input("bill_date", sql.Date, bill_date)
      .input("transaction_no", sql.Int, transaction_no) // âœ… important
      .input("warehouse_code", sql.NVarChar, warehouse_code)
      .input("customer_code", sql.NVarChar, customer_code)
      .input("item_code", sql.NVarChar, item_code)
      .input("item_name", sql.NVarChar, item_name)
      .input("bill_qty", sql.Decimal(10, 2), bill_qty)
      .input("bill_rate", sql.Decimal(10, 2), bill_rate)
      .input("item_amt", sql.Decimal(10, 2), item_amt)
      .input("weight", sql.Decimal(8, 3), weight)
      .input("total_weight", sql.Decimal(10, 2), total_weight)
      .input("pay_type", sql.NVarChar, pay_type)
      .input("sales_type", sql.NVarChar, sales_type)
      .input("sman_code", sql.NVarChar, sman_code)
      .input("customer_name", sql.NVarChar, customer_name)
      .input("order_type", sql.NVarChar, order_type)
      .input("hsn", sql.NVarChar, hsn)
      .input("tax_amt", sql.Decimal(14, 2), tax_amt)
      .input("discount", sql.Decimal(5, 2), discount)
      .input("discount_amount", sql.Decimal(14, 2), discount_amount)
      .input("created_by", sql.NVarChar, created_by)
      .query(`
        EXEC sp_Ecommerce_selection_details
          @mode,
          @company_code,
          @bill_date,
          @transaction_no,
          @warehouse_code,
          @customer_code,
          @item_code,
          NULL,                
          @item_name,
          @bill_qty,
          @bill_rate,
          @item_amt,
          @weight,
          @total_weight,
          @pay_type,
          @sales_type,
          @sman_code,
          @customer_name,
          @order_type,
          @hsn,
          @tax_amt,
          '1',                  
          NULL,                 
          @discount,
          @discount_amount,
          @created_by,
          '',
          NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
      `);

    res.json({
      success: true,
      message: "Detail item added successfully",
    });
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message });
  }
};


const Recenty_ViewedInsert = async (req, res) => {
  const { Date, Customer_code, Item_code, company_code, Created_by, } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    await pool.request()
      .input("mode", sql.NVarChar, "I")
      .input("Date", sql.DateTime, Date)
      .input("Customer_code", sql.NVarChar, Customer_code)
      .input("Item_code", sql.NVarChar, Item_code)
      .input("company_code", sql.NVarChar, company_code)
      .input("Created_by", sql.NVarChar, Created_by)
      .query(`EXEC sp_Recenty_Viewed @mode, @Date, @Customer_code, @Item_code, @company_code,'', @Created_by, '', '', ''`);

    res.status(200).json({ success: true, message: "Recenty_Viewed insertd successfully" });
  } catch (err) {
    console.error("Error during Recenty_Viewed insert:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const Recenty_ViewedUpdate = async (req, res) => {
  const { Date, Customer_code, Item_code, company_code, Keyfield, Created_by, modified_by, created_date, modifie_date } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    await pool.request()
      .input("mode", sql.NVarChar, "U")
      .input("Date", sql.DateTime, Date)
      .input("Customer_code", sql.NVarChar, Customer_code)
      .input("Item_code", sql.NVarChar, Item_code)
      .input("company_code", sql.NVarChar, company_code)
      .input("Keyfield", sql.NVarChar, Keyfield)
      .input("Created_by", sql.NVarChar, Created_by)
      .input("modified_by", sql.NVarChar, modified_by)
      .input("created_date", sql.DateTime, created_date)
      .input("modifie_date", sql.DateTime, modifie_date)
      .query(`EXEC sp_Recenty_Viewed @mode, @Date, @Customer_code, @Item_code, @company_code, @Keyfield, @Created_by, @modified_by, @created_date, @modifie_date`);

    res.status(200).json({ success: true, message: "Recenty_Viewed updated successfully" });
  } catch (err) {
    console.error("Error during Recenty_Viewed update:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};

const Recenty_ViewedDelete = async (req, res) => {
  const {Customer_code,Item_code,company_code } = req.body;

  try {
    const pool = await sql.connect(dbConfig);
    await pool.request()
      .input("mode", sql.NVarChar, "D")
      .input("Customer_code", sql.NVarChar, Customer_code)
      .input("Item_code", sql.NVarChar, Item_code)
      .input("company_code", sql.NVarChar, company_code)

      .query(`EXEC sp_Recenty_Viewed @mode,'', @Customer_code, @Item_code, @company_code, '', '', '', '', ''`);

    res.status(200).json({ success: true, message: "Recenty_Viewed deleted successfully" });
  } catch (err) {
    console.error("Error during Recenty_Viewed delete:", err);
    res.status(500).json({ message: err.message || "Internal Server Error" });
  }
};


const getCategories = async (req, res) => {
  const { Customer_code} = req.body;

  try {
    const pool = await connection.connectToDatabase();
    const result = await pool
      .request()
      .input("mode",          sql.NVarChar, "FA")
      .input("Customer_code", sql.NVarChar, Customer_code)
      .query(`EXEC sp_Recenty_Viewed @mode, '', @Customer_code, '', '','', '', '', '', ''`);
    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message || 'Internal Server Error' });
  }
};

const getSalesOrder = async (req, res) => {
  const { company_code, customer_code } = req.body;

  try {
    const pool = await connection.connectToDatabase();

    const result = await pool
      .request()
      .input("mode", sql.NVarChar, "SO")
      .input("company_code", sql.NVarChar, company_code)
      .input("customer_code", sql.NVarChar, customer_code)
      .query(`EXEC sp_sales_order_hdr @mode,@company_code,'','','','',@customer_code,0,0,0,0,0,0,0,0,'','','','','','','',0,0,'','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL`);

    if (result.recordset.length > 0) {
      res.status(200).json(result.recordset);
    } else {
      res.status(404).json("Data not found");
    }
  } catch (err) {
    console.error("Error", err);
    res.status(500).json({ message: err.message });
  }
};



module.exports = {
  login,
  VerifyCustomer,
  signUp,
  verifyOtp,
  getvariant,
  getuom,
  getCity,
  getCountry,
  getState,
  getStatus,
  getTransaction,
  getGender,
  getLoginorout,
  getAllData,
  addData,
  userAddData,
  getAlluserData,
  AddWareHouseData,
  getAllWareHouseData,
  getwarehouseSearchdata,
  getAllRoleInfoData,
  AddRoleInfoData,
  RolesaveEditedData,
  saveEditedData,
  deleteData,
  UserdeleteData,
  UsersaveEditedData,
  WareHousesaveEditedData,
  getAllattributehdrData,
  addattrihdrData,
  getAllattributedetData,
  addattridetData,
  updattridetData,
  deleteAttriDetailData,
  gethdrcode,
  gettaxtype,
  getAllIntermediaryheaderData,
  addIntermediaryHdrData,
  getAllIntermediaryDetailData,
  addIntermediaryDetailData,
  getAllUOMData,
  addUOMData,
  deleteIntermediaryHeaderData,
  getDeletepermission,
  getregisterbrand,
  getourbrand,
  getInthdrcode,
  deleteIntermediaryDetailData,
  updintermediarydetData,
  addTaxDetailsData,
  getAllTaxDetailsData,
  updtaxdetaildata,
  addTaxHdrData,
  getAllTaxHdrData,
  getitemsearchdata,
  getAllItemBrandData,
  addItemBrandData,
  deleteItemData,
  getsearchdata,
  getUsercode,
  getUsertype,
  getCompanyno,
  getLocationno,
  getvendorcode,
  getAllVendorHdrData,
  addVendorHdrData,
  getAllVendorDetData,
  addVendorDetData,
  updvendordetData,
  VendordeleteData,
  getAllCompanyMappingData,
  addCompanyMappingData,
  WareHousedeleteData,
  getPaytype,
  getPurchasetype,
  getSalestype,
  getordertype,
  getsalesmancode,
  gettransportcode,
  getbrokercode,
  getVendorcodename,
  getroleid,
  getAllUserRoleMappingData,
  addUserRoleMappingData,
  gettypeperdata,
  getlocationsearchdata,
  addlocationinfo,
  locationsaveEditedData,
  locationdeleteData,
  getitempursearchdata,
  getUserrolesearchdata,
  getUsersearchdata,
  getRolesearchdata,
  roledeleteData,
  getvendorSearchdata,
  addpurchaseheader,
  getAllpurhdrData,
  addpurchasedetail,
  getAllpurtaxData,
  addpurtaxdetail,
  getAllpurhdetData,
  getTotalAmountCalculation,
  getPartyCode,
  getcompanymappingsearchdata,
  getattributeSearchdata,
  getintermediarySearchdata,
  addpurchasereturnheader,
  getAllpurchaseheaderreturnData,
  getpurchasereport,
  gettaxSearchdata,
  getitemcodepurdata,
  getAllsaleshdrData,
  addsaleshdr,
  addsalesdetdetail,
  gettranstype,
  getAllsalestaxdetData,
  addinventorytaxdetail,
  getpursearchdata,
  getPurchaseData,
  getsalessearchdata,
  getAllSalesRetHdrData,
  addSalesRetHdr,
  getpurchasereturnit,
  getpurchasereturntax,
  getAllNumberseries,
  addNumberseries,
  getnumberseriessearchdata,
  saveEditedNumberseriesData,
  refNumberToHeaderPrintData,
  refNumberToDetailPrintData,
  refNumberToSumTax,
  addpurchasereturntaxdetails,
  addpurchasereturndetails,
  getpurchasereturndetails,
  getpurchasereturntaxdetails,
  getAllDashboardData,
  getSalesItemAmountCalculation,
  SalesTotalAmountCalculation,
  getItemPrice,
  getProduct,
  getPurchaseReturnItemAmountCalculation,
  getscreentype,
  getDashboardItemData,
  getDashboardStockData,
  getDashboardSaleYear,
  getDashboardSaleMonth,
  getsalesreport,
  getsalemonthreport,
  getallsalesreport,
  getallsalereportdailywise,
  getallsalereportmonthlywise,
  getallsalereportyearlywise,
  Passwords,
  refNumberTosalesHeaderPrintData,
  refNumberTosalesDetailPrintData,
  refNumberTosalesSumTax,
  getitemstockvalue,
  getAllItemVarient,
  getitemvairentname,
  getAllUOM,
  getAlluomdetail,
  numberseriesdeleteData,
  getonlywarehsearchdata,
  getusercompany,
  updateitemData,
  updcompanymapping,
  commappingdeleteData,
  getSalesReturnItemAmountCalculation,
  getSalesData,
  getSalesDetail,
  getSalesTaxDetail,
  getWarehouseCodeData,
  SalesreturnTotalAmountCalculation,
  getAlluserscreenmap,
  adduserscreenmap,
  saveEditeduserscreenmap,
  userscreenmapdeleteData,
  getuserscreensearchdata,
  getScreens,
  getPermissions,
  addSalesRetDetail,
  getAllSalesRetDetailData,
  getAllSalesRetTaxDetailData,
  addSalesRetTaxDetail,
  getAllcustomerhdr,
  addcustomerhdr,
  getAllCustomerDetData,
  addCustomerDetData,
  updcustomerdetData,
  customerSearchdata,
  getcustomercode,
  customerdeleteData,
  getAllopenbalance,
  addopenbalance,
  openbalsaveEditedData,
  openingbalancedeleteData,
  getopeningbalanceSearchdata,
  addadjustment,
  getadjustmentSearchdata,
  updadjustmentData,
  deleteadjustmentData,
  getitemcode,
  refNumberToPurchaseReturnHeaderPrintData,
  refNumberToPurchaseReturnDetailPrintData,
  refNumberToPurachseReturnSumTax,
  refNumberToSalesReturnHeaderPrintData,
  refNumberToSalesReturnDetailPrintData,
  refNumberToSalesReturnSumTax,
  getItemCodeSalesData,
  getCustomerCode,
  getCustomerSearchdata,
  addstocktransferdetail,
  getstocktransferSearch,
  updstocktransfer,
  deletestocktransfer,
  addjournal,
  getjournalSearch,
  purdeletehdrData,
  purDeleteDetailData,
  purDeleteTaxData,
  getUserPermission,
  saveEditjournal,
  deletejournal,
  getwarehousecode,
  getPurchaseAnalysisChart,
  getPurchaseDeleteDetails,
  getpurDeleteDetails,
  facereg,
  purdeletedunit,
  purdeletedtax,
  getSalesAnalysisChart,
  getRefSalesDelete,
  getsalesdelsearchdata,
  saledelsearchitem,
  salesdelsearchtax,
  saledeletehdrData,
  saleDeleteDetailData,
  saleDeleteTaxData,
  addstocktransferhdr,
  gettaxitempur,
  gettaxitemsales,
  getDashboardPurchase,
  getDashboardSales,
  getDashboardItemSales,
  getStockKey,
  StockTransferDetail,
  StockTransferItemAmountCalculation,
  deletestocktransferhdr,
  refNumberToStockDetailPrintData,
  addUserAccGrp,
  getsearchUserAccGrp,
  updUserAccGrp,
  deleteUserAccGrp,
  getStdAccGrp,
  getBaseAccGrp,
  addBaseaccountData,
  getAllBaseAccountData,
  getsearchdataBase,
  updateBase,
  deleteBaseData,
  addstandardaccountData,
  getAllStandardAccountData,
  getbasaccode,
  getCurrentStock,
  getNegativeStock,
  getstandardsearchdata,
  deleteStdAccGrp,
  updStdAccGrp,
  warehouseDashboard,
  deleteTaxData,
  updTaxdetData,
  getpurchasereturnView,
  UomChart,
  Transdetail,
  partytransdetail,
  alltransdetail,
  datetransdetail,
  getSalesreturnView,
  getpurreturnsearchViewdata,
  getwarehousedrop,
  varientChart,
  addAccountName,
  getAccNameSearch,
  updateAccName,
  AccNameDelete,
  getAllAccNameData,
  getsalesreturnsearchViewdata,
  SalesReturnTaxView,
  SalesReturnDetailView,
  getitemsalsearchdata,
  gettransdetailchart,
  getpurchasereturntaxView,
  getpurchasereturnitView,
  getDateRange,
  getUsercodename,
  getAccountCode,
  addbankAccount,
  getacctype,
  updatebankAcc,
  getbankaccSearch,
  addDeliveryChallanheader,
  getAllDChdrData,
  DCdeletehdrData,
  getAllDCdetData,
  addDeliveryChallandetail,
  DCdeletedetData,
  getofftype,
  addQuotationheader,
  getAllquotehdrData,
  quotedeletehdrData,
  getAllquotedetData,
  addquotationdetail,
  quotedeletedetData,
  refNumberToQuotationHeaderPrintData,
  refNumberToQuotationDetailPrintData,
  getAllquotetaxData,
  addquotetaxdetail,
  quoteDeleteTaxData,
  refNumberToQuoteSumTax,
  deliverychallanhdrprint,
  deliverychallandetprint,
  addProductHeader,
  getAllproducthdrData,
  productdeletehdrData,
  addPurchaseOrderheader,
  getAllPOhdrData,
  POdeletehdrData,
  getItemCodeQuotation,
  addPurchaseOrderdetail,
  getAllPOdetData,
  POdeletedetData,
  getAllPOtaxData,
  addPOtaxdetail,
  PODeleteTaxData,
  purchaseOrderdetprint,
  purchaseOrderhdrprint,
  refNumberToPOSumTax,
  getItem,
  getProducthdrcode,
  addProductdet,
  // ProductDelete,
  ProudctUpdate,
  getItemCodeDcData,
  getDcSearchData,
  getDcDetailView,
  getQuotationSearchData,
  getQuotationDetailView,
  getQuotationTaxDetailView,
  getPOSearchData,
  getPODetailView,
  getPOTaxDetailView,
  getproductsearch,
  getQuotation,
  getDeliveryChallan,
  getPurchaseOrder,
  getQuotationPeriod,
  getPOperiod,
  // ProductDetailDelete,
  purreturndeletehdrData,
  purreturndeletedetData,
  purreturndeletetaxdetData,
  salereturndeletehdrData,
  salereturndeletedetData,
  salereturndeletetaxdetData,
  ProductCodeDetail,
  getAllsalesdetData,
  getAllsalestaxdetData,
  addtestreport,
  gettestreports,
  getAlltestreports,
  Updtestreport,
  getDCperiod,
  RollMappingDelete,
  purchaseEditHeader,
  updateRoleMapping,
  getUserRole,
  getAllInventoryReceiptsDetails,
  addInventoryReceiptsDetails,
  deleteInventoryReceiptsDetails,
  addInventoryReceiptsheader,
  inventoryReceiptsDelete,
  inventoryReceiptsAll,
  addInventoryReturnheader,
  inventoryReturnHeaderDelete,
  inventoryReturnHeaderAll,
  addInventoryReturndetails,
  InventoryReturnDeleteDetailData,
  getAllInventoryReturndetailData,
  UpdateUserImage,
  AddEmployeeInfo,
  EmployeeInfodelete,
  EmployeinfoAll,
  AddDepartment,
  ViewEmployee,
  EmployeeUpdate,
  getInventoryTransaction,
  inventoryIssuanceAll,
  inventoryIssuanceDelete,
  addInventoryIssuancehdr,
  getAllInventoryIssuancedetailData,
  InventoryIssuanceDeleteDetailData,
  addInventoryIssuancedetails,
  getInventoryReturn,
  getInventoryReturnDetails,
  getInventoryReceipt,
  getInventoryReceiptDetail,
  getInventoryIssued,
  getInventoryIssuedDetail,
  InventoryReturnHeaderPrint,
  InventoryReturnDetailPrint,
  InventoryReceiptHeaderPrint,
  InventoryReceiptDetailPrint,
  InventoryIssuedHeaderPrint,
  InventoryIssuedDetailPrint,
  addAssetsAllocationheader,
  AssetsAllocationdelete,
  GetAllAssetsAllocationHdr,
  addAssetsAllocationDeatils,
  deleteAssetsAllocationDetails,
  GetAllAssetsAllocationDetails,
  InventoryReturnSearchData,
  InventoryReceiptSearchData,
  InventoryIssuedSearchData,
  AssetsAllocationdeletehdr,
  AssetsAllocationdeleteDetails,
  getallAssetsAllocation,
  getEmptype,
  getDept,
  getDesgination,
  getallEmployee,
  EmployeeDelete,
  EmployeeEditData,
  getallEmployeePopUp,
  getallAssetsAllocationsaved,
  productDeleteDetails,
  getProductData,
  getProductDetail,
  ProductSearchData,
  getallassetsdetails,
  getCondition,
  PurchaseAuthHdr,
  PurchaseAuthDetail,
  PurchaseAuthTaxDetail,
  SalesAuthHdr,
  SalesAuthDetail,
  SalesAuthTaxDetail,
  AddDesgination,
  GetAllDesgination,
  desginationDelete,
  DesgintionEditData,
  desgsearch,
  DeptSearch,
  DepartmetEditData,
  departmentDelete,
  PurchReturnAuthHdr,
  PurchReturnAuthDetail,
  PurchReturnAuthTaxDetail,
  SalesReturnAuthHdr,
  SalesReturnAuthDetail,
  SalesReturnAuthTaxDetail,
  // updateitemDataTest,
  UpdateItemImage,
  LocationUpdate,
  CompanyUpdate,
  UpdateCompanyImage,
  RoleUpdate,
  UserUpdate,
  CompanyMappingUpdate,
  RoleMappingUpdate,
  AttributeUpdate,
  NumberSeriesUpdate,
  ItemUpdate,
  TaxUpdate,
  WarehouseUpdate,
  VendorUpdate,
  addadjustmenthdr,
  Adjustmnetdelhdr,
  adjustmentupdatehdr,
  getalladjustmnethdr,
  addadjustmnetdetails,
  adjustmnetdeletedetails,
  getalladjustmnetdetails,
  addOpeningbalHdr,
  OpeningBalDelhdr,
  OpeningBalanceupHdr,
  GetallopeningBalHdr,
  AddOpeningBalanceDetails,
  OpeningBaldeletedet,
  getallopeningBalDet,
  AddJournalHdr,
  JournaDeleteHdr,
  JournalUpdateHdr,
  GetAllJournalHdr,
  AddJournalDetails,
  JournalDeletedet,
  GetAllJournalDet,
  AdjustmnethdrPrint,
  AdjustmnetdetPrint,
  getadjustmentdata,
  CustomerUpdate,
  IntermediaryUpdate,
  BankAccountUpdate,
  DepartmentUpdate,
  DesgintionUpdate,
  EmployeeUpdate,
  BaseAccountUpdate,
  COAUpdate,//charts of Accounts
  StandardAccUpdate,
  UserAccGrpUpdate,
  getOpeningBalance,
  getOpeningBalanceDetails,
  OpeningBalanceSearchData,
  ObHeaderPrint,
  ObDetailPrint,
  AdjustmentSearch,
  JournalHdrPrint,
  JournalDetPrint,
  Journalsearch,
  getAdjustmentDetails,
  getJournaldata,
  getJournalDetails,
  getEvent,
  purauthstatus,
  salauthstatus,
  salretauthstatus,
  purretauthstatus,
  //updpurchasedetail,
  getPurItemAmountCalculation,
  gettaxinvoiceitemamt,
  gettaxinvoicetotamt,
  addtaxInvoicehdr,
  TaxInvoicehdrDelteData,
  getAlltaxinvoicehdrData,
  // addTaxInvoicedetail,
  TaxInvoiceDeldetData,
  getAllTaxInvoiceDetData,
  addTaxInvoiceTaxdetail,
  TaxInvoicetaxDelteData,
  getAllTaxInvoiceTaxData,
  gettaxsearchdata,
  getTaxInvoiceTax,
  gettaxinvoiceDetail,
  addLoan,
  getLoan,
  updateLoan,
  deleteLoan,
  addEmployeeLoan,
  getEmployeeLoan,
  deleteEmployeeLoan,
  updateEmployeeLoan,
  addGrade,
  allGradeData,
  deleteGrade,
  updateGrade,
  addEmployeeCompany,
  allEmployeeCompanyData,
  deleteEmployeeCompany,
  updateEmployeeCompany,
  addEmployeeFamily,
  allEmployeeFamilyData,
  deleteEmployeeFamily,
  updateEmployeeFamily,
  addSalaryDetails,
  allSalaryDetailsData,
  deleteSalaryDetails,
  updateSalaryDetails,
  addEmployeeLeave,
  allEmployeeLeaveData,
  deleteEmployeeLeave,
  updateEmployeeLeave,
  addEmployeedoc,
  delemployeedoc,
  getAllemployeedoc,
  UpdateEmployeeImage,
  Employeedataupdate,
  deleteemployeeper,
  getAllemployeedata,
  getEmployeeDocument,
  addEmployeePersonalData,
  getID,
  getsiblings,
  getkids,
  getMartial,
  addLeaveType,
  getemployeemanager,
  addDailyattendance,
  getEmployeeFamily,
  getSalaryType,
  getPayscale,
  Add_employee_bankdetails,
  getallEmployeebankdet,
  Employeebankdetdelete,
  updateEmployeebankdet,
  getEmployeeSalary,
  getEmployeeBankDeatils,
  getGrade,
  getEmployeePersonaldet,
  getLoanID,
  getTaxInvoiceNo,
  getShift,
  addEmployeeAcademicDetails,
  allEmployeeAcademicDetails,
  updateEmployeeAcademicDetails,
  deleteEmployeeAcademicDetails,
  addEmployeeIdentityDocument,
  allEmployeeIdentityDocument,
  updateEmployeeIdentityDocument,
  deleteEmployeeIdentityDocument,
  getTaxInvoicePeriod,
  getDocumentType,
  getAcademicDetails,
  getallProduct,
  getCustomerDetails,
  addTaxInvoicedetail_list,
  ProductPrintHDR,
  ProductPrintDet,
  getrelation,
  taxInvoiceBalanceAmountCalculation,
  getannoncementtype,
  getAnnouncementDetail,
  TaxInvocieHdrPrint,
  TaxInvocieDetPrint,
  taxinvoicetaxprint,
  UpdateProducthdr,
  UpdateProductdetails,
  getAnnouncement_Msg,
  getCurrentStockDetails,
  getCurrentStockItemCode,
  addOpeningBalanceItemHdr,
  getTotalStockValueDetails,
  openingitemhdr,
  openingitemdelhdr,
  getallOIHdr,
  addOpeningItemDetail,
  deleteOpeningItemDetail,
  allOpeningItemDetail,
  getallOpeningItem,
  openingItemSearch,
  getallOpeningItemDetail,
  addAnnounmentdetails,
  allAnnouncementDetails,
  deleteAnnouncement,
  updateAnnouncementDetails,
  getAnnouncement,
  EmployeePersonalSC,
  getAnnouncementDetails,
  getcompanyshift,
  DashboardLeaveStatus,
  DashboardUpcomingBirthday,
  DashboardNewJoinee,
  DashboardOverallAttendance,
  DashboardTeamList,
  DashboardTeamListChart,
  DashboardLeaveAuthorization,
  getEmpcompanyDetails,
  Quotation,
  getItemCodeSalesDataQuote,
  getApprovedBy,
  getotherpurtax,
  getothersalestax,
  getOverallTAX,
  getAcademicDetailsSearchCretria,
  getIdentityDocuments,
  getTeamManager,
  getsearchEmpLoan,
  POTermsandConditions,
  POTermsandConditionsDelete,
  getallPOTermsandConditions,
  DCTermsandConditions,
  DCTermsandConditionsDelete,
  getallDCTermsandConditions,
  quoTermsandConditions,
  QuoTermsandConditionsDelete,
  getallQuoTermsandConditions,
  TITermsandConditions,
  TITermsandConditionsDelete,
  getallTITermsandConditions,
  EmployeeCompanyISC,
  ProductCodeDetailOther,
  getItemCodeOtherSalesData,
  getInvocieType,
  gettermsdc,
  getQuotationTCDetailView,
  getPOTCDetailView,
  getTITerms,
  getUsercodenameBank,
  getVendorDetails,
  getIdentityDocumentSearchCretria,
  getItemCodeSalesDatatest,
  getcodetest,
  getitemsalsearchdatatest,
  getCodeSalesDatatest,
  getFinancialDetailsSearchCretria,
  getFamilyDetailsSearchCretria,
  TermsDC,
  TermsQO,
  TermsPO,
  TermsTI,
  getEmpBankDetailsSC,
  getESSmanager,
  getLeaveType,
  getSelectSlot,
  getGstReportAnalysis,
  getDashBoardType,
  getGST,
  getPartyName,
  getGSTReport,
  getDeletedDeliveryChallan,
  getDeletedDcSearchData,
  getDeletedDcDetailView,
  getDeletedDcTerms,
  getDeletedPurchaseOrder,
  getDeletedPoDetail,
  getDeletedPoTaxDetail,
  getDeletedPoTerms,
  getDeletedPoSearchData,
  getDeletedQuotation,
  getDeletedQuotationTaxDetailView,
  getDeletedQuotationDetailView,
  getDeletedQuotationTerms,
  getDeletedQuotationSearchData,
  getDeletedTaxInvoiceSearchData,
  getDeletedTaxInvoice,
  getDeletedTaxInvoiceTax,
  getDeletedTaxinvoiceDetail,
  getDeletedTaxIvoiceTerms,
  getItemCode,
  getOpeningItemPeriod,
  getType,
  getAccrual,
  getExceedLeave,
  getLeaveReason,
  getDateWiseItemStock,
  EmployeeDashboardNewJoinee,
  EmployeeDashboardUpcomingBirthday,
  EmployeeDashboardTotalLeave,
  DailyattendanceandTime,
  addEmployeeHoliday,
  allEmployeeHoliday,
  updateEmployeeHoliday,
  getCustomerCodeDrop,
  getPendingCustomer,
  getsearchLeavetypes,
  getLeaveTypeSearch,
  getPendingStatus,
  updatePendingCustomer,
  getsearchHoliday,
  AddBonusDetails,
  UpdBonusDetails,
  DelBonusDetails,
  GetBonusDetails,
  addTDS,
  updateTDS,
  allTDS,
  deleteTDS,
  SearchTDS,
  addOtherAllowence,
  updateOtherAllowence,
  deleteOtherAllowence,
  allOtherAllowence,
  allProfessionalTax,
  addProfessionalTax,
  updateProfessionalTax,
  deleteProfessionalTax,
  addLoanType,
  updateLoanType,
  allLoanType,
  deleteLoanType,
  allPfDetail,
  deletePfDetail,
  updatePfDetail,
  addPfDetails,
  ProfessionalTaxSC,
  getBonusDetails,
  getPFContribution,
  getLoanType,
  OtherAllowanceSC,
  getdefCustomer,
  AddSalesSettings,
  POdeleteRethdrData,
  addPurchaseOrderReturnheader,
  getAllPORethdrData,
  addPurchaseOrderRetdetail,
  getAllPORetdetData,
  POdeleteRetdetData,
  getPORetSearchData,
  getDeletedPoRetSearchData,
  addPORettaxdetail,
  getAllPORettaxData,
  PODeleteRetTaxData,
  getitemcodevariant,
  getDefaultoptions,
  getSalesMode,
  getSalesReturnAmountCalculation,
  getReceivedGoods,
  updateReceivedGoods,
  getReceivedGoodsReport,
  AddTransactionSettinngs,
  getPurchaseAnalysis,
  getReceivedGoodsHelp,
  addProject,
  updateProject,
  deleteProject,
  getAllProject,
  addTask,
  updateTask,
  getAllTask,
  addDailyLogin,
  addDailyTask,
  delDailyTask,
  getDCItemAmountCalculation,
  getTaskstatus,
  getDailyTasks,
  getPriority,
  DailytaskSC,
  getDCTotalAmountCalculation,
  DeleteTask,
  PendingCustomer,
  updateBankAccount,
  projectSC,
  getProjectTask,
  getDailyTask,
  getPriority,
  getTaskDetail,
  getProjectDetail,
  addProjectMapping,
  updateProjectMapping,
  deleteProjectMapping,
  getProjectDrop,
  getProjectMapping,
  getTaskDetailReport,
  getTaskHourReportDetail,
  getTaskHourReport,
  Getmanager,
  getProjectDetailReport,
  getProjectReport,
  GradeSC,
  LoanSC,
  TaskMasterSC,
  Userdropdown,
  UpdateLeaveType,
  deleteLeave,
  AnnouncementSearchCretria,
  updQuotationheader,
  updPurchaseOrderheader,
  updDeliveryChallanheader,
  TaxInvoiceUpdate,
  productImageUpdate,
  Getticketandproject,
  GetProject,
  DailyLogin,
  DailyLogOUT,
  Projectusercode,
  deleteEmployeeHoliday,
  GetCC,
  InsertStockVal,
  updateStockVal,
  updateStockValStatus,
  deleteStockValue,
  StockSC,
  EmpSearch,
  getAnnouncementDuration,
  AddFileAttachment,
  ESSManager,
  GetClr,
  getfiles,
  getprojectSC,
  PMSDashboard,
  getHolidayDate,
  PMSEmployeechart,
  AddSalaryCriteria,
  DeleteSalaryCriteria,
  UpdateSalaryCriteria,
  GeneratePaySlip,
  GetPaysllipSC,
  //AddSearchCriteria,
  getboolean,
  mailgenerating,
  savePDFToPath,
  GetPaysllipTemplate,
  updateUOMData,
  deleteUOMData,
  sendPayslipEmails,
  salarySearchoption,
  UpdateSalary,
  salaryDelete,
  AddEmpDoc,
  delempdoc,
  getAllempdoc,
  getempdoc,
  getDocument,
  getapplyLeavetype,
  updateempDoc,
  getEmployeeLeavesearch,
  getEmployeeTotalLeaveBalance,
  sendAutoMail,
  addAssertAllocationReturnHdr,
  getAssertAllocationReturnHdr,
  addAssetsAllocationReturnDetails,
  getAssetsAllocationReturnDetails,
  getallAssetsAllocationReturn,
  searchCriteriaAssertReturn,
  getAssertReturnDetail,
  assetsEmployeeId,
  updateRoleRights,
  salesTermsandCondition,
  deleteSalesTermsandCondition,
  getAllSalesTermsandCondition,
  termsandCondition,
  getTermsandConditionSales,
  getDeletedTermsSales,
  customerCodeDropdown,
  AddFinacnialyearlockscreen,
  deleteFinacnialyearlockscreen,
  SelectFinacnialyearlockscreen,
  UpdateFinacnialyearlockscreen,
  deleteFinacnialyearlockscreenGrid,
  getFinacnialyearlockscreenSearchCriteria,
  getLockType,
  vendorCodeDropdown,
  UpdateFinacnialyearlock,
  TotalActiveEmployees,
  TotalNetEarnings,
  TotalPayslips,
  EmployeeDocSC,
  PrintTemplates,
  AddPrintTemplate,
  Templatesearch,
  getPrint,
  getcopies,
  getSalesItemCode,
  AddClientBugs,
  DeleteClientBugs,
  UpdateClientBugs,
  getClientbugs,
  WeekOff,
  addCRMClient,
  updateCRMClient,
  deleteCRMClient,
  getCRMClient,
  addCRMContacts,
  updateCRMContacts,
  deleteCRMContacts,
  getCRMContacts,
  getCRMContactName,
  GenerateEmployee,
  openingTicketSearch,
  getUserCode,
  AddWeekOff,
  getWeekOff,
  updateWeekOff,
  deleteWeekOff,
  FetchWeekOff,
  AddGenerateEmployee,
  deleteGenerateEmployee,
  getGenerateEmployee,
  FetchGenerateEmployee,
  GetUserCheckIN,
  getLeaveStatus,
  AddPMSSetting,
  deletePMSsettings,
  GetPMSsettings,
  PMSsettingsUpdate,
  SettingEmployeeUpdate,
  ESSEmployeeDashboard,
  getAnnouncementText,
  getManager,
  getCheckInStatus,
  Getpayslip,
  getEmployeeId,
  DashboardOverallAttendanceData,
  getEmployeeCheckInCheckOut,
  getTaskUserID,
  PMS_Client_infoInsert,
  PMS_Client_infoUpdate,
  PMS_Client_infoDelete,
  GetPaymentMode,
  GetPaymentType,
  GetClientInfoSearch,
  uploadImages,
  PMS_Client_infoLoopUpdate,
  PMS_Client_infoLoopDelete,
  Client_PaymentInsert,
  Client_PaymentUpdate,
  Client_PaymentDelete,
  Client_PaymentLoopUpdate,
  Client_PaymentLoopDelete,
  GetClient_PaymentData,
  GetClient_PaymentDataSearch,
  CRM_ContactInfoInsert,
  CRM_ContactInfoUpdate,
  CRM_ContactInfoDelete,
  CRM_AddContactInsert,
  CRM_AddContactUpdate,
  CRM_AddContactDelete,
  CRM_SalesPersonMasterInsert,
  CRM_SalesPersonMasterUpdate,
  CRM_SalesPersonMasterDelete,
  CRM_LogNoteInsert,
  CRM_LogNoteUpdate,
  CRM_LogNoteDelete,
  CRM_MeetingSubjectInsert,
  CRM_MeetingSubjectUpdate,
  CRM_MeetingSubjectDelete,
  CRM_CampaignInsert,
  CRM_CampaignUpdate,
  CRM_CampaignDelete,
  CRM_MediumInsert,
  CRM_MediumUpdate,
  CRM_MediumDelete,
  CRM_SourceInsert,
  CRM_SourceUpdate,
  CRM_SourceDelete,
  CRM_SalesPurchaseInsert,
  CRM_SalesPurchaseUpdate,
  CRM_SalesPurchaseDelete,
  CRM_NewCompanyInsert,
  CRM_NewCompanyUpdate,
  CRM_NewCompanyDelete,
  getClientPaymentExcel,
  CompanySearch,
  CRM_ContactInfoCompanyName,
  defaultCompanyNames,
  defaultContactsName,
  companyToContact,
  contactToCompany,
  getDateRangeCRM,
  getNewCompany,
  updateNewCompanyStage,
  getOpportunityDetails,
  CRM_SalesTeam_HDRInsert,
  CRM_SalesTeam_HDRUpdate,
  CRM_SalesTeam_HDRDelete,
  CRM_SalesTeam_DetailsInsert,
  CRM_SalesTeam_DetailsUpdate,
  CRM_SalesTeam_DetailsDelete,
  CRM_ActivityInsert,
  CRM_ActivityUpdate,
  CRM_ActivityDelete,
  getCustomerDropdown,
  updateNewCompanyPeriority,
  CRM_ActivityDelete,
  CRM_NewEventInsert,
  CRM_NewEventUpdate,
  CRM_NewEventDelete,
  CRM_MessageInsert,
  CRM_MessageUpdate,
  CRM_MessageDelete,
  GetSalesperson,
  GetSalespersonALL,
  salesPersonDropdown,
  GetDataContactInfo,
  GetDataContact,
  getContactEmail,
  getContacts,
  getContactsDetails,
  getSource,
  getMedium,
  CRM_LogNoteGet,
  searchSource,
  mediumSearch,
  CampaignSearch,
  SearchSalesperson,
  getCampaign,
  CRM_Tag_MasterInsert,
  CRM_Tag_MasterUpdate,
  CRM_Tag_MasterDelete,
  CRMClientSearch,
  GetTeam,
  GetSalesTeam,
  GetTeamName,
  GetActivity,
  GetContactClient,
  GetContactInfo,
  activitySearch,
  TagSearch,
  getTagName,
  GetContactInfoData,
  GetContactInfoDetails,
  GetCompanyMonth,
  GetActivityAll,
  SalesTeamSearch,
  Forecastsearch,
  CRM_CompanyDateUpdate,
  CRM_CompanySearch,
  SalesTeamChart,
  CRM_MarkUP,
  SalesTeamChart,
  Pipelinechart,
  CRM_Lose_Insert,
  // CRM_Lose_Update,
  //CRM_Lose_Delete,
  CRM_Lose_Select,
  PipelineDetailChart,
  ActivityChart,
  getDomain,
  GetAllMeeting,
  SalesTeamDetailChart,
  GetActive,
  GetRevenue,
  GetAllEvent,
  CRMSalesTeamUpdateGrid,
  CRM_LoseSC,
  ActivityDetailChart,
  CRM_PV,
  GetCalendarEvent,
  ContactSearch,
  getCount,
  getSecondaryuom,
  EmpStatus,
  getTaskHourReportLeave,
  UOMConverterInsert,
  getItemVariant,
  getPay,
  addSalesOrderHdr,
  addSalesOrderDetail,
  getCategoriesMaster,
  addSelectionSalesOrderHdr,
  addSelectionSalesOrderDetail,
  Recenty_ViewedInsert,
  Recenty_ViewedUpdate,
  Recenty_ViewedDelete,
  getCategories,
  getSalesOrder


};

